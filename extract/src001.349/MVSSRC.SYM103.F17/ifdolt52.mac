         TITLE 'IFDOLT52 DATA PROTECTION GENERAL'
         LCLA  &T,&SPN                                            0001
.@001    ANOP                                                     0001
IFDOLT52 CSECT ,                                                  0001
         BC    15,24(0,@F)
         DC    C'IFDOLT52 17 NOV 76'                             0001
         STM   @E,@C,12(@D)                                       0001
         BALR  @B,0                                               0001
@PSTART  DS    0H                                                 0001
         USING @PSTART+00000,@B                                   0001
         ST    @D,@SAV001+4                                       0001
         LA    @F,@SAV001                                         0001
         ST    @F,8(0,@D)                                         0001
         LR    @D,@F                                              0001
         TITLE 'IFDOLT52 - DATA PROCTECTION GENERAL'
         ENTRY ECB1                                            X02008
         ENTRY REPBFR1                                         X02008
         DS    0H
*  GEN(USING CHASCT,2);                  /* COMMON AREA BASE REGISTER *
         USING CHASCT,2
         DS    0H
*  GENERATE DATA;                        /* OLTEP COMMON AREA         *
*  DCL R0 REG(0) PTR;                    /* REGISTER 0                *
*  DCL R1 REG(1) PTR;                    /* REGISTER 1                *
*  DCL R2 REG(2) PTR;                    /* REGISTER 2                *
*  DCL R3 REG(3) PTR;                    /* REGISTER 3                *
*  DCL R4 REG(4) PTR;                    /* REGISTER 4                *
*  DCL R5 REG(5) PTR;                    /* REGISTER 5                *
*  DCL R6 REG(6) PTR;                    /* REGISTER 6                *
*  DCL R7 REG(7) PTR;                    /* REGISTER 7                *
*  DCL R8 REG(8) PTR;                    /* REGISTER 8                *
*  DCL R9 REG(9) PTR;                    /* REGISTER 9                *
*  DCL R10 REG(10) PTR;                  /* REGISTER 10               *
*  DCL R11 REG(11) PTR;                  /* REGISTER 11               *
*  DCL R12 REG(12) PTR;                  /* REGISTER 12               *
*  DCL R13 REG(13) PTR;                  /* REGISTER 13               *
*  DCL R14 REG(14) PTR;                  /* REGISTER 14               *
*  DCL R15 REG(15) PTR;                  /* REGISTER 15               *
*  RESTRICT(R2,R3,R4,R5,R6,R7,R8,R9);    /* RESTRICT REGISTERS        *
*  DCL IFD34CL LABEL GENERATED;          /* GENERATED LABEL           *
*  DCL MSGMOD PTR GENERATED;             /* MESSAGE MODULE            *
*  DCL CHASCT CHAR(88) GENERATED;        /* SECTION CONTROL TABLE     *
*  DCL WKSVC GENERATED;                  /* SVC WORK AREA             *
*  DCL MCT GENERATED;                    /* MODULE CONTROL TABLE      *
*  DCL ROPT GENERATED;                   /* SVC AREA                  *
*  DCL VID CHAR(2) BASED(ADDR(WKSVC)+2); /* MODULE ID FOR SVC USE     *
*  DCL MID1 CHAR(2) BASED(ADDR(MCT)+10); /* OLTEP MODULE ID           *
*  DCL CESWT CHAR(5) GENERATED;          /* OLTEP SWITCHES            *
*  /*******************************************************************
*  /*     OLTEP SWITCHES                                              *
*  /*******************************************************************
*  DCL 1 * BASED(ADDR(CESWT)),
*         2 * BIT(8),                    /* N/A                       *
*          3 * BIT(1),                   /* N/A                       *
*          3 PROTECT BIT(1),             /* DATA PROT CALLING         *
*          3 OORN BIT(2),                /* OLD OR NEW UTS            *
*         2 * BIT(8),                    /* SWITCH 2                  *
*          3 * BIT(4),                   /* N/A                       *
*          3 FILMSK BIT(1),              /* FILE MASK BIT             *
*         2 * BIT(8),                    /* SWITCH 3                  *
*          3 * BIT(3),                   /* N/A                       *
*          3 CHANTEST BIT(1),            /* CHANNEL TEST ACTIVE       *
*          3 * BIT(2),                   /* N/A                       *
*          3 TAPEHDR BIT(1),             /* RESTORE TPAE LABEL FLAG   *
*         2 * BIT(8),                    /* SWITCH 4                  *
*          3 * BIT(1),                   /* N/A                       *
*          3 BYPDEV BIT(2),              /* BYPASS 1 OR ALL DEVICES   *
*            4 NURUN BIT(1),             /* BYPASS ALL DEVICE TESTS   *
*            4 NUDEV BIT(1),             /* BYPASS THIS DEVICE        *
*          3 * BIT(1),                   /* N/A                  M4506*
*          3 SUSDEL BIT(1),              /* SUSPEND DELETION     M4506*
*          3 * BIT(2),                   /* N/A                       *
*          3 NODP BIT(1),                /* NO DATA PROT ON DEV S20203*
*         2 * BIT(8),                    /* SWITCH 5                  *
*         2 * BIT(8),                    /* SWITCH 6                  *
*         2 * BIT(8),                    /* SWITCH 7                  *
*          3 UTSCAL BIT(1),              /* UTS CALLED FLAG           *
*            4 * BIT(1);                 /* LAST OLTEP FLAG           *
*         DCL CESWTR CHAR(1) GENERATED;  /* RETAIN 370 SWITCHES S20203*
*  /*******************************************************************
*  /*     OLTEP  RETAIN/370 SWITCHES                            S20203*
*  /*******************************************************************
*  DCL 1 * CHAR(1) BASED(ADDR(CESWTR)),
*           3 RETAINAC BIT(1),           /* REI ACTIVE FLAG     S20203*
*           3 * BIT(1),                  /*                     S20203*
*           3 REMNOMSG BIT(1),           /* REMOTE NO MSG       S20203*
*           3 * BIT(5);                  /*                     S20203*
*         DCL CESWTR2 CHAR(1) GENERATED;     /* REI SWTCHS      X02008*
*         DCL 1 * CHAR(1) BASED(ADDR(CESWTR2)),   /*            X02008*
*              3 * BIT(7),         /* N/A                       X02008*
*              3 DPMSG BIT(1);     /* DATA PROT MSG             X02008*
*  GEN(EJECT);
         EJECT
         DS    0H
*  /*******************************************************************
*  /*     SCT SWITCH STRUCTURE -OFFSET 10                             *
*  /*******************************************************************
*  DCL 1 * CHAR(1)
*        BASED(ADDR(CHASCT)+10),         /* OFFSET 10                 *
*        3 * BIT(1),                     /* N/A                       *
*        3 FPM BIT(1);                   /* FILE PROTECT MODE BIT     *
*  /*******************************************************************
*  /*     SCT SWITCH STRUCTURE - OFFSET 11                            *
*  /*******************************************************************
*  DCL 1 * CHAR(1)
*        BASED(ADDR(CHASCT)+11),         /* OFFSET 11                 *
*        3 CDSFPM BIT(1),                /* FILE PROTECT MODE    M1006*
*        3 * BIT(1),                     /* NA                   M1006*
*        3 CDSCEVOL BIT(1),              /* CE VOLUME            M1006*
*        3 * BIT(5);                     /* NA                   M1006*
*
*  /*******************************************************************
*  /*     DEVICE TABLE STRUCTURE                                      *
*  /*******************************************************************
*  DCL 1 * BASED(R7),
*               3 DEVADEB CHAR(8),       /* DEV ADDR IN EBCDIC  S21052*
*               3 DUCBA PTR(31),         /* UCB ADDR            S21052*
*               3 DEVFL1 CHAR(1),        /* FLAG BYTE 1         S21052*
*                5 ONLNE BIT(1),         /* ON/OFF LINE STATUS  S21052*
*                5 PRIME BIT(1),         /* PRIMARY DEV FLAG    S21052*
*                5 DPDONE BIT(1),        /* DATA PROTECTION DON S21052*
*                5 ACTVE BIT(1),         /* ACTIVE DEVICE       S21052*
*                5 ALLCT BIT(1),         /* ALLOCATED DEVICE    S21052*
*                5 GRBED BIT(1),         /* SECONDARY DEVICE    S21052*
*                5 FLPRT BIT(1),         /* FILE PROTECT MODE   S21052*
*                5 ACTSC BIT(1),         /* LAST SECONDARY DEV  S21052*
*               3 DEVFL2 CHAR(1),        /* SEOND FLAG BYTE     S21052*
*                5 DSNAME BIT(1),        /* DSNAME FLIP-FLOP    S21052*
*                5 SHARED BIT(1),        /* SHARED VOLUME       S21052*
*                5 CEVOL BIT(1),         /* C.E. VOLUME         S21052*
*                5 STDLBL BIT(1),        /* STANDARD LABEL TAPE S21052*
*                5 CHANFUNC BIT(1),      /* CHANNEL FUNCTION    S21052*
*                5 BYPS BIT(1),          /* BYPASS FUNC INVOKED S21052*
*                5 CEDE BIT(1),          /* CE-DE FUNC INVOKED  S21052*
*                5 ATTN BIT(1),          /* ATTNIN FUNC INVOKED S21052*
*               3 DEVFL3 CHAR(1),        /* 3RD FLAG BYTE       S21052*
*                5 * BIT(3),             /* N/A                       *
*                5 TAPEBIT BIT(1),       /* NOT/READY RESTORE   Y01906*
*             5 * BIT(2),               /* N.A. BITS           SA63144*
*             5 CESHRMSG BIT(1),        /* CEVOL MSG OUTPUT FLGSA63144*
*               3 DEVFL4 CHAR(1),        /* 4TH FLAG BYTE       S21052*
*               3 DVEXT1 CHAR(6),        /* LOW DASD EXTENT     S21052*
*               3 DVEXT2 CHAR(6),        /* HIGH DASD EXTENT    S21052*
*               3 * CHAR(2),             /* N/A                 S21052*
*               3 MODESET CHAR(1),       /* MODE SET SAVE AREA  S21052*
*               3 EXPOSURE CHAR(1),      /* EXPOSURE # FOR ZEUS S21052*
*               3 DEHAD CHAR(4),         /* DEV ADDR IN HEX     S21052*
*               3 CDSINFOR CHAR(16),     /* CDS INFORMATION     S21052*
*                5 MODEL CHAR(1),        /* MODEL #             S21052*
*                5 FEATURES CHAR(1),     /* FEATURES THIS MODEL S21052*
*                5 CLASSD CHAR(1),       /* CLASS               S21052*
*                5 TYPED CHAR(1),        /* TYPE                S21052*
*                5 CDSCNT CHAR(1),       /* CDS BYTE COUNT      S21052*
*                5 CDSFLAGS CHAR(1),     /* CDS FLAGS           S21052*
*                 7 DVCDSFPM BIT(1),     /* FILE PROTECT FLAG   S21052*
*                 7 * BIT(1),            /* N/A                 S21052*
*                 7 DVCDSCEV BIT(1),     /* CE VOLUME           S21052*
*                 7 * BIT(4),            /* N/A                 S21052*
*                 7 REMLINE BIT(1),      /* REMOTE LINE         S21052*
*                5 EXTSGMSK CHAR(2),     /* EXTERNAL SIGNAL MSK S21052*
*                5 SYMNAME CHAR(8),      /* SYMBOLIC NAME       S21052*
*               3 * CHAR(4);             /* EXPANSION           S21052*
*  /*******************************************************************
*  /*           SYSTEM 7 CONSTANTS                              X02008*
*  /*******************************************************************
*  /*******************************************************************
*  /*     DEVICE DESCRIPTORS                                          *
*  /*******************************************************************
*  DCL 1 * CHAR(2) BASED(R8),
*           3 CLASS BIT(8),              /* CLASS               S21050*
*               5 TAPE BIT(1),           /* CLASS=TAPE          S21050*
*               5 TP BIT(1),             /* CLASS=TP            S21050*
*               5 DASD BIT(1),           /* CLASS=DASD          S21050*
*               5 GRAPH BIT(1),          /* CLASS=GRAPHICS      S21050*
*               5 UNIT BIT(1),           /* CLASS=UNIT RECORD   S21050*
*               5 * BIT(3),              /* N/A                 S21050*
*           3 TYPE BIT(8);               /* TYPE                S21050*
*  /*******************************************************************
*  /*     MAP OF UCB                                            S21052*
*  /*******************************************************************
*  DCL 1 DEVUCB BASED(DUCBA),
*           3 * FIXED,                   /* N/A                 S21050*
*           3 * FIXED,                   /* N/A                 S21050*
*             5 * CHAR(2),               /* N/A                 S21050*
*             5 * CHAR(1),               /* N/A                 S21050*
*           3 *(2) FIXED,                /* N/A                 S21050*
*           3 * CHAR(1),                 /* N/A                 S21050*
*           3 * CHAR(1),                 /* FLAGS               S21050*
*             5 * BIT(2),                /* N/A                 S21052*
*             5 DEVSHRD BIT(1),          /* SHARED FLAG         S21052*
*             5 * BIT(5),                /* N/A                 S21052*
*           3 UCBDEVDS CHAR(2);          /* UCB DEVICE DESC     S21050*
*  DCL SECDVPTR PTR(31) GENERATED;       /* SECONDARY DEV PTR   S21052*
*  /*******************************************************************
*  /*     PARAMETER LIST FOR SVC59                                    *
*  /*******************************************************************
*  DCL 1 * BASED(ADDR(ROPT)),
*         3 UCBADDR CHAR(4),             /* UCB ADDR FOR DEV          *
*         3 FLAG1 CHAR(4),               /* FLAGS INDICATION          *
*           5 * BIT(8),                  /* FIRST FLAG BYTE           *
*             7 NOTRDY BIT(1),           /* NOT READY BIT STATUS      *
*             7 * BIT(7),                /* N/A                       *
*           5 * CHAR(3);                 /* N/A                       *
*  DCL HCODE CHAR(1) BASED(84);          /* CODE FOR SVC CALL         *
*  /*******************************************************************
*  /*    SVC LIST                                                     *
*  /*******************************************************************
*  DCL 1 SVCLIST BASED(ADDR(ROPT)),
*         3 * FIXED,                     /* N/A                       *
*         3 SVCFLG CHAR(1);              /* FLAG                      *
*  /*******************************************************************
*  /*     POINTER TO MESSAGE IFD103I                                  *
*  /*******************************************************************
*  DCL 1 * BASED(MSGMOD),
*         2 *(2) PTR,                    /* N/A                       *
*         2 IFD103 PTR,                  /* PTR TO MSG IFD103I  X02008*
*         2 *(28)  PTR,                  /* FILLER              X02008*
*         2 IFD113 PTR;                  /* PTR TO MSG IFD113I  X02008*
*  DCL MSGDVAD CHAR(8) BASED(R1+34);     /* DEVICE ADDR IN MSG  Y01906*
*  DCL MSGDVAD1 CHAR(4) BASED(R1+50);    /* DEV ADDR POS IN MSG X02008*
*  DCL REPLYLGN CHAR(1) BASED(R1);       /* REPLY IN COUNT POS  X02008*
*  DCL ECB1 FIXED;                       /* ECB FOR MSG IFD113I X02008*
*  DCL REPBFR1 CHAR(1);                  /* REPLY BUFFER        X02008*
*  GEN(EJECT);
         EJECT
         DS    0H
*
*  /*******************************************************************
*  /*                                                                 *
*  /*     DETERMINATION OF TAPE HDR,SEC.OR PRIMARY DEVICE             *
*  /*                                                                 *
*  /*******************************************************************
*
*  UTSCAL= '0'B;                         /* MODULES CAN BE DELETED    *
         NI    A00000+6,B'01111111'                               0053
*  NODP='0'B;                            /* TURN OFF NO DP BIT        *
         NI    A00000+3,B'11111110'                               0054
*         DPMSG='1'B;              /* TURN ON DP MSG FLG        X02008*
         OI    A00019,B'00000001'                                 0055
*  /* CHECK IF CALLED TO REWRITE TAPE LABELS                          *
*  IF TAPEHDR = '1'B THEN                /* ARE TAPE LABELS TO BE     *
         TM    A00000+2,B'00000010'                               0056
         BC    12,@9FF                                            0056
*    DO;                                 /* WRITTEN?                  *
*      GEN;                              /* YES. GOTO IFDOLT53        *
CLM53    IFDMOD CALL='53'               CALL IFDOLT53             M4506
         DS    0H
*      GEN(IFDMOD DELETE='53');          /* DELETE MODULE       YM4982*
         IFDMOD DELETE='53'
         DS    0H
*      TAPEHDR= '0'B;                    /* RESET TAPEHDR BIT         *
         NI    A00000+2,B'11111101'                               0060
*      GOTO TORET;                       /* NORMAL RETURN             *
         BC    15,TORET                                           0061
*     END;                               /* END OF DO GROUP           *
*  /* CHECK IF PRIMARY OR SECONDARY DEVICE                            *
*  IF PROTECT= '1'B THEN                 /*                           *
@9FF     TM    A00000,B'01000000'                                 0063
         BC    12,@9FE                                            0063
*    DO;                                 /* SECONDARY DEVICE          *
*      R7= SECDVPTR;                     /* DEVTAB PTR FOR SEC DEV    *
         L     @7,SECDVPTR                                        0065
*      GOTO DPSSVC59;                    /* ISSUE SVC59 FOR STATUS    *
         BC    15,DPSSVC59                                        0066
*    END;                                /* END OF DO GROUP           *
*    ELSE                                /*                           *
*      R7= R8;                           /* DEVTAB FOR PRIMARY DEV    *
@9FE     LR    @7,@8                                              0068
*
*
*
* /********************************************************************
* /*                                                                  *
* /*                         ISSUE SVC59 ROUTINE                      *
* /*                                                                  *
* /********************************************************************
*
* DPSSVC59:                              /* SVC59 BRANCH              *
*  /* CHECK IF DATA PROTECTION HAS BEEN DONE                          *
*  IF DPDONE = '0'B THEN                 /* HAS DP BEEN DONE?         *
@9FD     EQU   *                                                  0069
DPSSVC59 TM    12(@7),B'00100000'                                 0069
         BC    05,@9FC                                            0069
*    DO;                                 /* NO. RESET FLAGS           *
*      FPM= '0'B;                        /* SET FILE PROTECT MODE     *
         NI    A00021,B'10111111'                                 0071
*      FILMSK = '0'B;                    /* ZERO FILE MASK BIT        *
         NI    A00000+1,B'11110111'                               0072
*      FLPRT = '0'B;                     /* ZERO FILE PROTECT FLAG    *
         NI    12(@7),B'11111101'                                 0073
*      CDSFPM= '0'B;                     /* ZERO CDS FILE PROTECT SCT *
         NI    A00023,B'01111111'                                 0074
*      DVCDSFPM= '0'B;                   /* ZERO DEVTAB CDS FLAG      *
         NI    41(@7),B'01111111'                                 0075
*    END;                                /* END OF DO GROUP           *
*          R8=ADDR(CLASSD);         /*USE CDS DEVICE DESCRIPTION*/
@9FC     LA    @8,38(0,@7)                                        0077
*          IF DASD='1'B THEN       /* IF ITS AN               @Y03LPMY*
         TM    0(@8),B'00100000'                                  0078
         BC    12,@9FB                                            0078
*           DO;                                             /*@Y03LPMY*
*           IF FEATURES='10'X &     /* SS1 3330-1 OR          @Y03LPMY*
*              TYPE='09'X ×         /* AN SS1                 @Y03LPMY*
*              TYPE='0D'X &         /* 3330-11                @Y03LPMY*
*              FEATURES='10'X THEN  /*                        @Y03LPMY*
         CLI   37(@7),X'10'                                       0080
         BC    07,@9FA                                            0080
         CLI   1(@8),X'09'                                        0080
         BC    08,@9F9                                            0080
@9FA     CLI   1(@8),X'0D'                                        0080
         BC    07,@9F8                                            0080
         CLI   37(@7),X'10'                                       0080
         BC    07,@9F7                                            0080
*            DO;                    /* CALL SS1               @Y03LPMY*
@9F9     EQU   *                                                  0081
*              GEN(IFDMOD CALL='67'); /* DATAPROTECTION       @Y03LPMY*
         IFDMOD CALL='67'
         DS    0H
*              IF R15=4 THEN        /*IF IT CANT BE TESTED    @Y03LPMY*
         CH    @F,@D1                                             0083
         BC    07,@9F6                                            0083
*                DO;                                        /*@Y03LPMY*
*                NUDEV='1'B;        /*SET FLAG TO BYPASS      @Y03LPMY*
         OI    A00000+3,B'00100000'                               0085
*                GOTO TORET;        /*     AND RETURN         @Y03LPMY*
         BC    15,TORET                                           0086
*                END;                                       /*@Y03LPMY*
*            END;                                           /*@Y03LPMY*
@9F6     EQU   *                                                  0088
*           END;                                            /*@Y03LPMY*
@9F7     EQU   *                                                  0089
@9F8     EQU   *                                                  0089
*  ROPT= DUCBA;                          /* UCB ADDRESS               *
@9FB     MVC   ROPT(4),8(@7)                                      0090
*  IF TAPE = '1'B THEN                   /* IF CLASS IS TAPE,         *
         TM    0(@8),B'10000000'                                  0091
         BC    12,@9F5                                            0091
*    SVCFLG = '80'X;                     /* SET FLAG IN SVC LISTY01906*
         MVI   SVCLIST+4,X'80'                                    0092
         BC    15,@9F4                                            0093
*    ELSE SVCFLG  = '00'X;               /* NOT A TAPE DEV      Y01906*
@9F5     MVI   SVCLIST+4,X'00'                                    0093
*  VID=MID1;                             /* RESIDENT MODULE ID        *
@9F4     MVC   VID(2),MID1                                        0094
*  R0= ADDR(ROPT);                       /* PARMLIST ADDRESS          *
         LA    @0,ROPT                                            0095
*  R1=ADDR(HCODE);                       /* CALLING CODE              *
         LA    @1,HCODE                                           0096
*  GEN(SVC  59);                         /* ISSUE SVC 59              *
         SVC  59
         DS    0H
*  IF R15 ^= 'FF'X THEN                  /* IF DEV IS READY     Y01906*
         LA    @0,X'FF'                                           0098
         CR    @0,@F                                              0098
*    GOTO DEVCHK;                        /* CONTINUE CHECKING   Y01906*
         BC    07,DEVCHK                                          0099
*  IF TAPE ^= '1'B THEN                  /* IF NOTRDY & NOT TAPEY01906*
         TM    0(@8),B'10000000'                                  0100
*    GOTO DPMSG1;                        /* GO ISSUE MESSAGE          *
         BC    12,DPMSG1                                          0101
*  TAPEBIT = '1'B;                       /* UCB NOTRDY BIT OFF  Y01906*
         OI    14(@7),B'00010000'                                 0102
*
*
*
*  /*******************************************************************
*  /*                                                                 *
*  /*           DETERMINE CLASS AND TYPE OF DEVICE                    *
*  /*                                                                 *
*  /*******************************************************************
*
*         DEVCHK:                       /*                      Y02906*
*         IF TP = '1'B ×                /* IF DEVICE IS EITHER  Y02906*
*            GRAPH = '1'B THEN          /* OR GRAPHICS NO READ  Y02906*
DEVCHK   TM    0(@8),B'01000000'                                  0103
         BC    01,@9F3                                            0103
         TM    0(@8),B'00010000'                                  0103
         BC    12,@9F2                                            0103
*            DO;                        /* ARE NEEDED THERE-    Y02906*
*             DPDONE = '1'B;            /* FORE SET DP COMPLETE Y02906*
@9F3     OI    12(@7),B'00100000'                                 0105
*             GO TO TORET;              /* BIT IN DEVTAB AND    Y02906*
         BC    15,TORET                                           0106
*            END;                       /* GO EXIT MODULE       Y02906*
*                                       /*                      Y02906*
*         IF TAPE = '1'B ×              /* IF DEVICE IS ETHER   Y02906*
*            UNIT = '1'B THEN           /* TAPE OR UNIT RECORD  Y02906*
@9F2     TM    0(@8),B'10000000'                                  0108
         BC    01,@9F1                                            0108
         TM    0(@8),B'00001000'                                  0108
         BC    12,@9F0                                            0108
*            DO;                        /* GO TO TAPE PROTECT   Y02906*
*             UTSCAL = '0'B;            /* MODULES MAY BE DELETEY02906*
@9F1     NI    A00000+6,B'01111111'                               0110
*         CLM03: GEN( IFDMOD CALL='03');/* CALL IFDOLTO3        Y02906*
CLM03     IFDMOD CALL='03'
         DS    0H
*            R6 = R15;                  /* SAVE RTN CODE IN R6  Y02906*
         LR    @6,@F                                              0112
*            GEN(IFDMOD DELETE='03');   /* DELETE MODULE        YM4982*
         IFDMOD DELETE='03'
         DS    0H
*         RTNCHK:                       /* CHECK THE RETURN     Y02906*
*            IF R6 = 4 ×                /* CODE FOR NOT ENOUGH  Y02906*
*               R6 = 8 THEN             /* CORE OR MODULE NOT   Y02906*
RTNCHK   CH    @6,@D1                                             0114
         BC    08,@9EF                                            0114
         CH    @6,@D2                                             0114
         BC    07,@9EE                                            0114
*               NURUN = '1'B;           /* FOUND. IF NON ZERO   Y02906*
@9EF     OI    A00000+3,B'01000000'                               0115
*            GO TO TORET;               /* SET NURUN  BIT AND   Y02906*
         BC    15,TORET                                           0116
*            END;                       /* EXIT MODULE          Y02906*
*         IF DASD = '1'B THEN DO;       /* IS THIS A DASD AND   YM4764*
@9F0     TM    0(@8),B'00100000'                                  0118
         BC    12,@9ED                                            0118
*          DVEXT2='FFFFFFFFFFFF'X;                            /*YM4764*
         MVC   22(6,@7),@X9                                       0120
*           IF  TYPE = '06'X ×          /* A 2305 MOD I OR      YM4764*
*            TYPE = '07'X ×             /* A 2305 MOD II OR   @ZA15466*
*            TYPE = '0B'X THEN          /* A 3350?            @ZA15466*
         CLI   1(@8),X'06'                                        0121
         BC    08,@9EC                                            0121
         CLI   1(@8),X'07'                                        0121
         BC    08,@9EB                                            0121
         CLI   1(@8),X'0B'                                        0121
         BC    07,@9EA                                            0121
*             DO;                       /* IF YES               Y02906*
@9EB     EQU   *                                                  0122
@9EC     EQU   *                                                  0122
*         CALL04: UTSCAL = '0'B;        /* TURN OFF UNIT TST CULY02906*
CALL04   NI    A00000+6,B'01111111'                               0123
*         CLM04:  GEN(IFDMOD CALL='04');/* AND GO TO IFDOLTO4   Y02906*
CLM04    IFDMOD CALL='04'
         DS    0H
*                 R6 = R15;             /* SAVE  04 RTN CODE    Y02906*
         LR    @6,@F                                              0125
*                 GEN(IFDMOD DELETE='04'); /* DELETE MODULE     YM4982*
         IFDMOD DELETE='04'
         DS    0H
*                 GOTO RTNCHK;          /* GO CK RTN FROM 04    Y02906*
         BC    15,RTNCHK                                          0127
*             END;                      /* CONT                 Y02906*
*        IF  TYPE = '08'X ×             /* A 2314  OR           YM4764*
*             TYPE = '09'X ×            /* A 3330A OR         @Y30LPAW*
*             TYPE = '0A'X ×            /* A 3340 OR          @ZA04251*
*             TYPE = '0D'X THEN          /* A 3330-11         @Y30LPAW*
@9EA     CLI   1(@8),X'08'                                        0129
         BC    08,@9E9                                            0129
         CLI   1(@8),X'09'                                        0129
         BC    08,@9E8                                            0129
         CLI   1(@8),X'0A'                                        0129
         BC    08,@9E7                                            0129
         CLI   1(@8),X'0D'                                        0129
         BC    07,@9E6                                            0129
*             DO;                       /* IF YES               Y02906*
@9E7     EQU   *                                                  0130
@9E8     EQU   *                                                  0130
@9E9     EQU   *                                                  0130
*         CALL07:                  /* SET UP TO CALL IFDOLT07         *
*                 UTSCAL = '0'B;        /* TURN OFF UNIT TST CALY02906*
CALL07   NI    A00000+6,B'01111111'                               0131
*         CLM07:  GEN(IFDMOD CALL='07');/* AND GO TO IFDOLT07   Y02906*
CLM07    IFDMOD CALL='07'
         DS    0H
*                 R6 = R15;             /* SAVE RTN CODE FROM 07Y02906*
         LR    @6,@F                                              0133
*                 GEN(IFDMOD DELETE='07'); /* DELETE MODULE     YM4982*
         IFDMOD DELETE='07'
         DS    0H
*                 IF CEVOL ='1'B &      /* IF DEV IS CEVOL AND  Y02906*
*                    DEVSHRD = '1'B THEN/* IS SHARED            Y02906*
         TM    13(@7),B'00100000'                                 0135
         BC    12,@9E5                                            0135
         L     @C,8(0,@7)          
         TM    17(@C),B'00100000'                                 0135
*                    GO TO CALL04;      /* GO CALL IFDOLT07     Y02906*
         BC    03,CALL04                                          0136
*                 GO TO RTNCHK;         /* ELSE CHK 07 RTN COD  Y02906*
         BC    15,RTNCHK                                          0137
*             END;                      /* CONT                 Y02906*
*      END;                                                   /*YM4764*
@9E6     EQU   *                                                  0139
*         IF CLASSD = '02'X &           /* IS THIS DEVICE       X02008*
*             TYPED   = '01'X THEN      /* IS THIS DEVICE       X02008*
@9ED     CLI   38(@7),X'02'                                       0140
         BC    07,@9E3                                            0140
         CLI   39(@7),X'01'                                       0140
*             GO TO SYS7DP;             /* IF YES GO TO MSG RTN X02008*
         BC    08,SYS7DP                                          0141
*         NODP =  '1'B;                 /* CANNOT DATA PROTECT  Y02906*
@9E2     EQU   *                                                  0142
@9E3     OI    A00000+3,B'00000001'                               0142
*         GO TO CALL04;                 /* CALL 04 FOR MSG      Y02906*
         BC    15,CALL04                                          0143
* /********************************************************************
* /*                                                                  *
* /*                           EXITS                                  *
* /*                                                                  *
* /********************************************************************
*
*  SYS7DP:                               /* GIVE SYSTEM 7 MSG   X02008*
*   R1 = IFD113;                         /* POINT TO MSG        X02008*
SYS7DP   L     @C,MSGMOD                                          0144
         L     @1,124(0,@C)                                       0144
*   MSGDVAD1 = DEVADEB(5:8);             /* MOVE DEV ADDR TO MSGX02008*
         MVC   50(4,@1),4(@7)                                     0145
*  REPLYLGN = '01'X;                     /* SET REPLY LENGTH =1 X02008*
         MVI   0(@1),X'01'                                        0146
*   ECB1 = ECB1&&ECB1;                   /* CLEAR THE ECB       X02008*
         XC    ECB1(4),ECB1                                       0147
*   REPBFR1 = ' ';                       /* BLANK INPUT BFR     X02008*
         MVI   REPBFR1,C' '                                       0148
*   GEN(PWTOR REG=(1));                  /* GO GIVE THE MSG     X02008*
         PWTOR REG=(1)
         DS    0H
*  /* IF 'Y' FOR YES-SET DPDONE AND RETURN; IF 'N' FOR NO-SET   X02008*
*  /* BYPASS DEVICE AND RETURN; IF NEITHER GIVE MSG AGAIN.      X02008*
*  IF REPBFR1 = 'Y'                      /* IS REPLY = Y        X02008*
*     THEN DO;                           /* YES                 X02008*
         CLI   REPBFR1,C'Y'                                       0150
         BC    07,@9E1                                            0150
*      DPDONE = '1'B;                    /* SET DPDONE CE SWITCHX02008*
         OI    12(@7),B'00100000'                                 0152
*      GOTO TORET;                       /* RETURN              X02008*
         BC    15,TORET                                           0153
*     END;                               /*                     X02008*
*  IF REPBFR1 = 'N'                      /* IS REPLY = N        X02008*
*     THEN DO;                           /* YES                 X02008*
@9E1     CLI   REPBFR1,C'N'                                       0155
         BC    07,@9E0                                            0155
*      NUDEV = '1'B;                     /* SET BYPASS DEVICE SWX02008*
         OI    A00000+3,B'00100000'                               0157
*      GOTO TORET;                       /* RETURN              X02008*
         BC    15,TORET                                           0158
*     END;                               /*                     X02008*
*     GOTO SYS7DP;                       /* NOT Y OR N REISSUE  X02008*
* DPMSG1:                                /* MSG BRANCH                *
*  R1=IFD103;                            /* POINTER TO MSG            *
DPMSG1   L     @C,MSGMOD                                          0161
         L     @1,8(0,@C)                                         0161
*  MSGDVAD = DEVADEB;                    /* DEVICE ADDR TO MSG        *
         MVC   34(8,@1),0(@7)                                     0162
*  GEN(PWTO  REG=(1));                   /* PRINT MESSAGE             *
         PWTO  REG=(1)
         DS    0H
*  GOTO TSTPRIM;                         /* TEST FOR PRIMARY DEVICE   *
*
*
*
*
* TSTPRIM:                               /* TEST FOR PRIMARY DEVICE   *
*          IF PRIME = '1'B THEN          /* PRIMARY DEVICE?           *
TSTPRIM  TM    12(@7),B'01000000'                                 0165
         BC    12,@9DF                                            0165
*            NUDEV = '1'B;               /* SET BYPASS BIT            *
         OI    A00000+3,B'00100000'                               0166
* TORET:                                 /* RETURN BRANCH             *
*  UTSCAL= '0'B;                         /* MODULES CAN BE DELETED    *
@9DF     EQU   *                                                  0167
TORET    NI    A00000+6,B'01111111'                               0167
*         DPMSG='0'B;              /*TURN OFF DP MSG FLAG       X02008*
         NI    A00019,B'11111110'                                 0168
*  RETURN;                               /* RETURN TO CALLER          *
*  END;
@EL01    L     @D,4(0,@D)                                         0170
         LM    @E,@C,12(@D)                                       0170
         BCR   15,@E                                              0170
@DATA1   EQU   *
@0       EQU   00                  EQUATES FOR REGISTERS 0-15
@1       EQU   01
@2       EQU   02
@3       EQU   03
@4       EQU   04
@5       EQU   05
@6       EQU   06
@7       EQU   07
@8       EQU   08
@9       EQU   09
@A       EQU   10
@B       EQU   11
@C       EQU   12
@D       EQU   13
@E       EQU   14
@F       EQU   15
@D1      DC    H'4'
@D2      DC    H'8'
         DS    0F
@X9      DC    X'FFFFFFFFFFFF'
         DS    0D
@DATA    EQU   *
@SAV001  EQU   @DATA+00000000      72 BYTE(S) ON WORD
Y        EQU   00000000            FULLWORD INTEGER
R0       EQU   00000000            FULLWORD POINTER REGISTER
R1       EQU   00000001            FULLWORD POINTER REGISTER
R2       EQU   00000002            FULLWORD POINTER REGISTER
R3       EQU   00000003            FULLWORD POINTER REGISTER
R4       EQU   00000004            FULLWORD POINTER REGISTER
R5       EQU   00000005            FULLWORD POINTER REGISTER
R6       EQU   00000006            FULLWORD POINTER REGISTER
R7       EQU   00000007            FULLWORD POINTER REGISTER
R8       EQU   00000008            FULLWORD POINTER REGISTER
R9       EQU   00000009            FULLWORD POINTER REGISTER
R10      EQU   00000010            FULLWORD POINTER REGISTER
R11      EQU   00000011            FULLWORD POINTER REGISTER
R12      EQU   00000012            FULLWORD POINTER REGISTER
R13      EQU   00000013            FULLWORD POINTER REGISTER
R14      EQU   00000014            FULLWORD POINTER REGISTER
R15      EQU   00000015            FULLWORD POINTER REGISTER
A00026   EQU   00000000            56 BYTE(S) ON WORD
DEVADEB  EQU   A00026+00000000     8 BYTE(S)
DUCBA    EQU   A00026+00000008     FULLWORD POINTER
DEVFL1   EQU   A00026+00000012     1 BYTE(S)
ONLNE    EQU   A00026+00000012     1 BIT(S)
PRIME    EQU   A00026+00000012     1 BIT(S)
DPDONE   EQU   A00026+00000012     1 BIT(S)
ACTVE    EQU   A00026+00000012     1 BIT(S)
ALLCT    EQU   A00026+00000012     1 BIT(S)
GRBED    EQU   A00026+00000012     1 BIT(S)
FLPRT    EQU   A00026+00000012     1 BIT(S)
ACTSC    EQU   A00026+00000012     1 BIT(S)
DEVFL2   EQU   A00026+00000013     1 BYTE(S)
DSNAME   EQU   A00026+00000013     1 BIT(S)
SHARED   EQU   A00026+00000013     1 BIT(S)
CEVOL    EQU   A00026+00000013     1 BIT(S)
STDLBL   EQU   A00026+00000013     1 BIT(S)
CHANFUNC EQU   A00026+00000013     1 BIT(S)
BYPS     EQU   A00026+00000013     1 BIT(S)
CEDE     EQU   A00026+00000013     1 BIT(S)
ATTN     EQU   A00026+00000013     1 BIT(S)
DEVFL3   EQU   A00026+00000014     1 BYTE(S)
A00027   EQU   A00026+00000014     3 BIT(S)
TAPEBIT  EQU   A00026+00000014     1 BIT(S)
A00028   EQU   A00026+00000014     2 BIT(S)
CESHRMSG EQU   A00026+00000014     1 BIT(S)
DEVFL4   EQU   A00026+00000015     1 BYTE(S)
DVEXT1   EQU   A00026+00000016     6 BYTE(S)
DVEXT2   EQU   A00026+00000022     6 BYTE(S)
A00029   EQU   A00026+00000028     2 BYTE(S)
MODESET  EQU   A00026+00000030     1 BYTE(S)
EXPOSURE EQU   A00026+00000031     1 BYTE(S)
DEHAD    EQU   A00026+00000032     4 BYTE(S)
CDSINFOR EQU   A00026+00000036     16 BYTE(S)
MODEL    EQU   A00026+00000036     1 BYTE(S)
FEATURES EQU   A00026+00000037     1 BYTE(S)
CLASSD   EQU   A00026+00000038     1 BYTE(S)
TYPED    EQU   A00026+00000039     1 BYTE(S)
CDSCNT   EQU   A00026+00000040     1 BYTE(S)
CDSFLAGS EQU   A00026+00000041     1 BYTE(S)
DVCDSFPM EQU   A00026+00000041     1 BIT(S)
A00030   EQU   A00026+00000041     1 BIT(S)
DVCDSCEV EQU   A00026+00000041     1 BIT(S)
A00031   EQU   A00026+00000041     4 BIT(S)
REMLINE  EQU   A00026+00000041     1 BIT(S)
EXTSGMSK EQU   A00026+00000042     2 BYTE(S)
SYMNAME  EQU   A00026+00000044     8 BYTE(S)
A00032   EQU   A00026+00000052     4 BYTE(S)
A00033   EQU   00000000            2 BYTE(S)
CLASS    EQU   A00033+00000000     8 BIT(S)
TAPE     EQU   A00033+00000000     1 BIT(S)
TP       EQU   A00033+00000000     1 BIT(S)
DASD     EQU   A00033+00000000     1 BIT(S)
GRAPH    EQU   A00033+00000000     1 BIT(S)
UNIT     EQU   A00033+00000000     1 BIT(S)
A00034   EQU   A00033+00000000     3 BIT(S)
TYPE     EQU   A00033+00000001     8 BIT(S)
DEVUCB   EQU   00000000            20 BYTE(S) ON WORD
A00035   EQU   DEVUCB+00000000     FULLWORD INTEGER
A00036   EQU   DEVUCB+00000004     FULLWORD INTEGER
A00037   EQU   DEVUCB+00000004     2 BYTE(S)
A00038   EQU   DEVUCB+00000006     1 BYTE(S)
A00039   EQU   DEVUCB+00000008     2*FULLWORD INTEGER
A00040   EQU   DEVUCB+00000016     1 BYTE(S)
A00041   EQU   DEVUCB+00000017     1 BYTE(S)
A00042   EQU   DEVUCB+00000017     2 BIT(S)
DEVSHRD  EQU   DEVUCB+00000017     1 BIT(S)
A00043   EQU   DEVUCB+00000017     5 BIT(S)
UCBDEVDS EQU   DEVUCB+00000018     2 BYTE(S)
HCODE    EQU   00000084            1 BYTE(S)
A00049   EQU   00000000            128 BYTE(S) ON WORD
A00050   EQU   A00049+00000000     2*FULLWORD POINTER
IFD103   EQU   A00049+00000008     FULLWORD POINTER
A00051   EQU   A00049+00000012     28*FULLWORD POINTER
IFD113   EQU   A00049+00000124     FULLWORD POINTER
MSGDVAD  EQU   00000034            8 BYTE(S)
MSGDVAD1 EQU   00000050            4 BYTE(S)
REPLYLGN EQU   00000000            1 BYTE(S)
ECB1     EQU   @DATA+00000072      FULLWORD INTEGER
REPBFR1  EQU   @DATA+00000076      1 BYTE(S)
         DS    00000077C
@TEMPS   DS    0F
DSECT48  IFDCOM
VID      EQU   WKSVC+00000002      2 BYTE(S)
MID1     EQU   MCT+00000010        2 BYTE(S)
A00000   EQU   CESWT+00000000      7 BYTE(S) ON WORD
A00001   EQU   A00000+00000000     8 BIT(S)
A00002   EQU   A00000+00000000     1 BIT(S)
PROTECT  EQU   A00000+00000000     1 BIT(S)
OORN     EQU   A00000+00000000     2 BIT(S)
A00003   EQU   A00000+00000001     8 BIT(S)
A00004   EQU   A00000+00000001     4 BIT(S)
FILMSK   EQU   A00000+00000001     1 BIT(S)
A00005   EQU   A00000+00000002     8 BIT(S)
A00006   EQU   A00000+00000002     3 BIT(S)
CHANTEST EQU   A00000+00000002     1 BIT(S)
A00007   EQU   A00000+00000002     2 BIT(S)
TAPEHDR  EQU   A00000+00000002     1 BIT(S)
A00008   EQU   A00000+00000003     8 BIT(S)
A00009   EQU   A00000+00000003     1 BIT(S)
BYPDEV   EQU   A00000+00000003     2 BIT(S)
NURUN    EQU   A00000+00000003     1 BIT(S)
NUDEV    EQU   A00000+00000003     1 BIT(S)
A00010   EQU   A00000+00000003     1 BIT(S)
SUSDEL   EQU   A00000+00000003     1 BIT(S)
A00011   EQU   A00000+00000003     2 BIT(S)
NODP     EQU   A00000+00000003     1 BIT(S)
A00012   EQU   A00000+00000004     8 BIT(S)
A00013   EQU   A00000+00000005     8 BIT(S)
A00014   EQU   A00000+00000006     8 BIT(S)
UTSCAL   EQU   A00000+00000006     1 BIT(S)
A00015   EQU   A00000+00000006     1 BIT(S)
A00016   EQU   CESWTR+00000000     1 BYTE(S)
RETAINAC EQU   A00016+00000000     1 BIT(S)
A00017   EQU   A00016+00000000     1 BIT(S)
REMNOMSG EQU   A00016+00000000     1 BIT(S)
A00018   EQU   A00016+00000000     5 BIT(S)
A00019   EQU   CESWTR2+00000000    1 BYTE(S)
A00020   EQU   A00019+00000000     7 BIT(S)
DPMSG    EQU   A00019+00000000     1 BIT(S)
A00021   EQU   CHASCT+00000010     1 BYTE(S)
A00022   EQU   A00021+00000000     1 BIT(S)
FPM      EQU   A00021+00000000     1 BIT(S)
A00023   EQU   CHASCT+00000011     1 BYTE(S)
CDSFPM   EQU   A00023+00000000     1 BIT(S)
A00024   EQU   A00023+00000000     1 BIT(S)
CDSCEVOL EQU   A00023+00000000     1 BIT(S)
A00025   EQU   A00023+00000000     5 BIT(S)
A00044   EQU   ROPT+00000000       8 BYTE(S) ON WORD
UCBADDR  EQU   A00044+00000000     4 BYTE(S)
FLAG1    EQU   A00044+00000004     4 BYTE(S)
A00045   EQU   A00044+00000004     8 BIT(S)
NOTRDY   EQU   A00044+00000004     1 BIT(S)
A00046   EQU   A00044+00000004     7 BIT(S)
A00047   EQU   A00044+00000005     3 BYTE(S)
SVCLIST  EQU   ROPT+00000000       5 BYTE(S) ON WORD
A00048   EQU   SVCLIST+00000000    FULLWORD INTEGER
SVCFLG   EQU   SVCLIST+00000004    1 BYTE(S)
@DATEND  EQU   *
@9EE     EQU   TORET
@9E5     EQU   RTNCHK
@9E4     EQU   RTNCHK
@9E0     EQU   SYS7DP
         END    ,(C'PL/S',1400,76322)

         TITLE 'AMDPRLOD - WORK FILE LOAD ROUTINE                      *
                        '
AMDPRLOD CSECT ,                                                   0001
@PROLOG  STM   @14,@12,12(@13)                                     0001
         BALR  @11,0                                               0001
@PSTART  DS    0H                                                  0001
         USING @PSTART,@11                                         0001
         ST    @13,@SA00001+4                                      0001
         LA    @14,@SA00001                                        0001
         ST    @14,8(,@13)                                         0001
         LR    @13,@14                                             0001
    DCBD  DSORG=BS,DEVD=(DA,TA)
AMDPRLOD  CSECT
    USING  IHADCB,R3
*                                      Y02006                        */
*   SWITCHES=BYTEOFF;               /* RESET ALL SWITCHES X01980     */
         MVI   SWITCHES,X'00'                                      0081
*   STOPSAVE=STOPEXIT;              /* SAVE CALLER'S STOP ROUTINE  0082
*                                      ADDR                          */
         MVC   STOPSAVE(4),STOPEXIT(COMPTR)                        0082
*   STOPEXIT=ADDR(STPRTN);          /* ESTABLISH LOD STOP EXIT       */
         LA    @10,STPRTN                                          0083
         ST    @10,STOPEXIT(,COMPTR)                               0083
*   QUT1LOD=SWITCHON;               /* INDICATE LOD BUILDING MAPS FOR
*                                      SYSUT1 Y02006                 */
         OI    QUT1LOD(COMPTR),B'00000010'                         0084
*   IF QSYSUT2=SWITCHON THEN        /* IS THIS CALL IN ORDER TO    0085
*                                      TRANSFER DUMP TO SYSUT2 Y02006*/
         TM    QSYSUT2(COMPTR),B'00000100'                         0085
         BNO   @RF00085                                            0085
*     DO;                                                          0086
*       SYSUT(6)='2';               /* YES--MAKE DDNAME 'SYSUT2'   0087
*                                      Y02006                        */
         MVI   SYSUT+5,C'2'                                        0087
*       LOADMODE=SWITCHON;          /* INDICATE THAT THIS IS LOAD  0088
*                                      MODE Y02006                   */
         OI    LOADMODE,B'10000000'                                0088
*       RESPECIFY                                                  0089
*        (REG0,                                                    0089
*         REG1) RESTRICTED;         /* RESTRICT REGISTERS Y02006     */
*       REG0=BUFFSIZE+LENGTH(BUFFMAP);/* SET GETMAIN SIZE      Y02006*/
         LH    REG0,@CH00643                                       0090
*       GEN(GETMAIN R,LV=(0));      /* ISSUE GETMAIN FOR ONE BUFFER
*                                      AND ONE BUFFER M AP ENTRY   0091
*                                      Y02006                        */
         GETMAIN R,LV=(0)
*       PARMPTR=REG1;               /* SET POINTER TO BUFFER MAP   0092
*                                      ENTRY Y02006                  */
         LR    PARMPTR,REG1                                        0092
*       RESPECIFY                                                  0093
*        (REG0,                                                    0093
*         REG1) UNRESTRICTED;       /* UNRESTRICT REGISTERS Y02006   */
*       BUFFLINK=0;                 /* INITIALIZE BUFFER MAP ENTRY,
*                                      INDICATE NO MORE ENTRIES    0094
*                                      Y02006                        */
         SLR   @10,@10                                             0094
         ST    @10,BUFFLINK(,PARMPTR)                              0094
*       BUFFPTR=PARMPTR+LENGTH(BUFFMAP);/* SET POINTER TO BUFFER   0095
*                                      Y02006                        */
         LA    @10,20                                              0095
         ALR   @10,PARMPTR                                         0095
         STCM  @10,7,BUFFPTR(PARMPTR)                              0095
*       GO TO OPENUP;               /* NOW GO PROCESS DUMP Y02006    */
         B     OPENUP                                              0096
*     END;                                                         0097
*   PARMPTR=BUFERMAP;               /* SET POINTER TO FIRST BUFFER 0098
*                                      Y02006                        */
@RF00085 L     PARMPTR,BUFERMAP(,COMPTR)                           0098
*   SYSUT(6)='1';                   /* MAKE DDNAME 'SYSUT1' Y02006   */
         MVI   SYSUT+5,C'1'                                        0099
*   REG3=ADDR(SYSUDCB);             /* SET ADDRESS OF OUTPUT DCB   0100
*                                      Y02006                        */
         LA    REG3,SYSUDCB                                        0100
*   DCBEXLST(2:4)=ADDR(EXITLST2);   /* ENABLE DCB ABEND EXIT Y02006  */
         LA    @10,EXITLST2                                        0101
         STCM  @10,7,DCBEXLST+1                                    0101
*   IF ENDSW=SWITCHON THEN          /* IS AN END CARD BEING PROCESSED
*                                      Y02006                        */
         TM    ENDSW(COMPTR),B'00001000'                           0102
         BO    @RT00102                                            0102
*     GO TO LODEXIT;                /* YES--THEN EXIT SINCE PRDMP  0103
*                                      WILL TERMINATE Y02006         */
*/********************************************************************/
*/*                                                                  */
*/*  OPEN WORK FILE DCB.  BEFORE OPENNING INPUT DCB, THE JFCB IS     */
*/*  READ.  THIS IS DONE TO PROCESS ANY FILE SEQUENCE NUMBER         */
*/*  SPECIFIED VIA NEWDUMP.  IF FILE SEQUENCE IS ALREADY SPECIFIED IN*/
*/*  THE JFCB, THIS VALUE IS NOT CHANGED.                            */
*/*                                                                  */
*/********************************************************************/
*                                                                  0104
*OPENUP:                                                           0104
*   REG3=ADDR(SYSUDCB);             /* POINT TO WORK FILE DCB        */
OPENUP   LA    REG3,SYSUDCB                                        0104
*   ASYSUDCB=REG3;                  /* RECORD ADDR IN COMMON CSECT   */
         STCM  REG3,7,ASYSUDCB(COMPTR)                             0105
*   DCBDDNAM=SYSUT;                 /* SET UP DDNAME                 */
         MVC   DCBDDNAM(8),SYSUT                                   0106
*   GEN(OPEN ((R3),OUTPUT));        /* OPEN WORK FILE                */
         OPEN ((R3),OUTPUT)
*   REG3=ADDR(INDCB);               /* POINT TO INPUT DCB            */
         LA    REG3,INDCB                                          0108
*   DCBDDNAM=INDD;                  /* GET SPECIFIED DDNAME          */
         MVC   DCBDDNAM(8),INDD(COMPTR)                            0109
*   GEN;                                                           0110
*                                                                  0110
         RDJFCB  MF=(E,DCBLST)     READ JFCB TO SPECIFY
*                                  PARTICULAR FILE
*   /*****************************************************************/
*   /*                                                               */
*   /* CHANGE DD-SPECIFIED FILE SEQUENCE NUMBER USING FILE SEQUENCE  */
*   /* NUMBER IN COMMON OBTAINED FROM A NEWDUMP CONTROL STATEMENT    */
*   /*                                                               */
*   /*****************************************************************/
*                                                                  0111
*   IF FILESEQ^=0 THEN                                             0111
         LH    @10,FILESEQ(,COMPTR)                                0111
         LTR   @10,@10                                             0111
         BZ    @RF00111                                            0111
*     DO;                           /* X01980                        */
*       JFCBFLSQ=FILESEQ;           /* GET DESIRED FILE SEQUENCE   0113
*                                      NUMBER FROM COMMON CSECT      */
         LA    @07,JFCBBUF                                         0113
         STH   @10,JFCBFLSQ+68(,@07)                               0113
*       JFCBMASK(33)='0'B;          /* SUPRESS WRITING JFCB BACK TO
*                                      JOB QUEUE                     */
         NI    JFCBMASK+76(@07),B'01111111'                        0114
*       JFCBTSDM='08'X;                                            0115
         MVI   JFCBTSDM+52(@07),X'08'                              0115
*     END;                                                         0116
*                                                                  0116
*/********************************************************************/
*/*   TEST FOR INPUT FROM SYS1.DUMP ON D/A.  IF SO, OPEN FOR  A49127 */
*/*   INOUT SO THAT SYS1.DUMP DATA SET CAN BE RESET TO ALLOW  A49127 */
*/*   MORE DUMPS.  IF SYS1.DUMP IS DATE PROTECTED, 'U' MUST   A49127 */
*/*   BE REPLIED TO SYSTEM MESSAGE IEC107D.                   A49127 */
*/********************************************************************/
*                                                                  0117
*   IF LOADMODE=SWITCHON&TREADIN=SWTCHOFF&JFCBDSNM(1:10)=SYSDUMP&  0117
*       JFCBDSNM(11)>='0'&JFCBDSNM(11)<='9'&JFCBDSNM(12:19)=BLANKS THEN
@RF00111 TM    LOADMODE,B'10000000'                                0117
         BNO   @RF00117                                            0117
         TM    TREADIN(COMPTR),B'00010000'                         0117
         BNZ   @RF00117                                            0117
         LA    @10,JFCBBUF                                         0117
         CLC   JFCBDSNM(10,@10),SYSDUMP                            0117
         BNE   @RF00117                                            0117
         CLI   JFCBDSNM+10(@10),C'0'                               0117
         BL    @RF00117                                            0117
         CLI   JFCBDSNM+10(@10),C'9'                               0117
         BH    @RF00117                                            0117
         CLC   JFCBDSNM+11(8,@10),BLANKS(COMPTR)                   0117
         BNE   @RF00117                                            0117
*                                   /* IS SYS1.DUMP0X ON DA AND BEING
*                                      COPIED TO SYSUT2 Y02006       */
*     DO;                                                          0118
*       SYS1SW=SWITCHON;            /* YES--SET A SWITCH AND Y02006  */
         OI    SYS1SW,B'00000100'                                  0119
*       GEN(OPEN (,(INOUT)),MF=(E,DCBLST),TYPE=J);/* A49127          */
         OPEN (,(INOUT)),MF=(E,DCBLST),TYPE=J
*     END;                                                         0121
*                                                                  0121
*/*   NOT SYS1.DUMP, OPEN INPUT DCB INDICATING JFCB IS INCORE A49127 */
*                                                                  0122
*   ELSE                                                           0122
*     GEN(OPEN (,(INPUT)),MF=(E,DCBLST),TYPE=J);/* Y02006            */
         B     @RC00117                                            0122
@RF00117 DS    0H                                                  0122
         OPEN (,(INPUT)),MF=(E,DCBLST),TYPE=J
*   POSTIPL=0;                      /* INITIALIZE COUNT OF RECORDS 0123
*                                      BEFORE HEADER Y02006          */
@RC00117 SLR   @08,@08                                             0123
         STH   @08,POSTIPL                                         0123
*   AINDCB=REG3;                    /* SAVE INPUT DCB ADDR IN COMMON
*                                      Y02006                        */
         ST    REG3,AINDCB(,COMPTR)                                0124
*   SCANSW=SWITCHON;                /* INDICATE GOING INTO SCAN    0125
*                                      Y02006                        */
         OI    SCANSW,B'01000000'                                  0125
*   CURVOL=0;                       /* INIT VOLU SEQ FOR MAP ENTRY 0126
*                                      Y01980                        */
         MVI   CURVOL,X'00'                                        0126
*   CURASID=INITASID;               /* INITIALIZE CURRENT ASID Y02006*/
         MVC   CURASID(2),@CB00054                                 0127
*   CURADDR=INITADDR;               /* INITIALIZE CURRENT ADDRESS  0128
*                                      Y02006                        */
         MVC   CURADDR(4),@CB00056                                 0128
*   SVCTTR=0;                       /* INDICATE NO SVC BUFFER Y02006 */
         ST    @08,SVCTTR                                          0129
*   RESPECIFY                                                      0130
*    (REG0,                                                        0130
*     REG1) RESTRICTED;             /* RESTRICT REGISTERS Y02006     */
*   REG0=BUFFSIZE;                  /* SET SIZE OF RECORD Y02006     */
         LH    REG0,@CH00039                                       0131
*   GEN(GETMAIN R,LV=(0));          /* GET STORAGE FOR SVC BUFFER  0132
*                                      Y02006                        */
         GETMAIN R,LV=(0)
*   SVCBUFAD=REG1;                  /* SAVE ADDRESS OF BUFFER Y02006 */
         LR    SVCBUFAD,REG1                                       0133
*   RESPECIFY                                                      0134
*    (REG0,                                                        0134
*     REG1) UNRESTRICTED;           /* RELEASE REGISTERS Y02006      */
*   TREADIN=SWTCHOFF;               /* INDICATE MAPS BEING BUILT FOR
*                                      A DA DATA SET Y02006          */
         NI    TREADIN(COMPTR),B'11101111'                         0135
*   MAPPTR=0;                       /* INITIALIZE FOR PLS          0136
*                                      OPTIMIZATION Y02006           */
         SLR   MAPPTR,MAPPTR                                       0136
*   LASTMAP=0;                      /* AS ABOVE Y02006               */
         SLR   @08,@08                                             0137
         ST    @08,LASTMAP                                         0137
*   CURMAP=0;                       /* AS ABOVE Y02006               */
         SLR   CURMAP,CURMAP                                       0138
*   LASTIVOL=0;                     /* AS ABOVE Y02006               */
         STH   @08,LASTIVOL                                        0139
*/********************************************************************/
*/*                                                                  */
*/*           PURGE ANY EXISTING DUMP MAPS, AND                      */
*/*           THE ASID INDEX, IF IT EXISTS.                          */
*/*                                                                  */
*/********************************************************************/
*                                                                  0140
*DUMPMAP:                                                          0140
*   IF REALMAP^=0 THEN              /* IS THERE A REAL MAP Y02006    */
DUMPMAP  L     @08,REALMAP(,COMPTR)                                0140
         LTR   @08,@08                                             0140
         BZ    @RF00140                                            0140
*     DO;                           /* YES                           */
*       MAPPTR=REALMAP;             /* POINT TO REAL MAP             */
         LR    MAPPTR,@08                                          0142
*       CALL MAPPRG;                /* PURGE REAL MAP ENTRIES        */
         BAL   @14,MAPPRG                                          0143
*       REALMAP=0;                  /* SET REALMAP PTR IN COMMON TO 0*/
         SLR   @08,@08                                             0144
         ST    @08,REALMAP(,COMPTR)                                0144
*     END;                                                         0145
*   IF CPUMAP^=0 THEN               /* IS THERE A CPU MAP Y02006     */
@RF00140 L     @08,CPUMAP(,COMPTR)                                 0146
         LTR   @08,@08                                             0146
         BZ    @RF00146                                            0146
*     DO;                           /* YES                           */
*       MAPPTR=CPUMAP;              /* POINT TO CPU MAP Y02006       */
         LR    MAPPTR,@08                                          0148
*       CALL MAPPRG;                /* PURGE CPU MAP ENTRIES         */
         BAL   @14,MAPPRG                                          0149
*       CPUMAP=0;                   /* SET CPUMAP PTR IN COMMON TO 0
*                                      Y02006                        */
         SLR   @08,@08                                             0150
         ST    @08,CPUMAP(,COMPTR)                                 0150
*     END;                                                         0151
*   INDXADDR=ASIDNDX;               /* SET PTR TO FIRST ASID INDEX 0152
*                                      Y02006                        */
@RF00146 MVC   INDXADDR(4),ASIDNDX(COMPTR)                         0152
*   ASIDNDX=0;                      /* SET ASID INDEX PTR IN COMMON
*                                      TO ZERO Y02006                */
         SLR   @08,@08                                             0153
         ST    @08,ASIDNDX(,COMPTR)                                0153
*CHKASID:                                                          0154
*   IF INDXADDR=0 THEN              /* ASID INDEX EXIST Y02006       */
CHKASID  ICM   @08,15,INDXADDR                                     0154
         BZ    @RT00154                                            0154
*     GO TO SCAN;                   /* NO - BEGIN MAP BUILD PROCESS
*                                      Y02006                        */
*   DO I=1 TO ASIDCNT;                                             0156
         LA    I,1                                                 0156
@DL00156 DS    0H                                                  0157
*     MAPPTR=ASDXMAP(I);            /* POINT TO FIRST DUMPMAP ENTRY
*                                      Y02006                        */
         LR    @08,I                                               0157
         SLA   @08,2                                               0157
         L     @05,INDXADDR                                        0157
         L     MAPPTR,ASDXMAP-4(@08,@05)                           0157
*     IF MAPPTR^=0 THEN             /* ANY MAP TO PURGE Y02006       */
         LTR   MAPPTR,MAPPTR                                       0158
         BZ    @RF00158                                            0158
*       CALL MAPPRG;                /* PURGE VIRTUAL DUMP MAP ENTRIES*/
         BAL   @14,MAPPRG                                          0159
*   END;                                                           0160
@RF00158 AH    I,@CH00043                                          0160
         CH    I,@CH00064                                          0160
         BNH   @DL00156                                            0160
*   RESPECIFY                                                      0161
*    (REG0,                                                        0161
*     REG1) RESTRICTED;             /* RESTRICT REGISTERS Y02006     */
*   REG0=LENGTH(ASIDLIST);          /* SIZE OF ASID INDEX Y02006     */
         LA    REG0,112                                            0162
*   REG1=INDXADDR;                  /* ADDRESS OF ASID INDEX Y02006  */
         L     @08,INDXADDR                                        0163
         LR    REG1,@08                                            0163
*   INDXADDR=ASDXLNK;               /* SAVE PTR TO NEXT ASID INDEX 0164
*                                      Y02006                        */
         L     @08,ASDXLNK(,@08)                                   0164
         ST    @08,INDXADDR                                        0164
*   GENERATE(FREEMAIN R,LV=(0),A=(1));/* FREE ASID INDEX Y02006      */
         FREEMAIN R,LV=(0),A=(1)
*   RESPECIFY                                                      0166
*    (REG0,                                                        0166
*     REG1) UNRESTRICTED;           /* UNRESTRICT REGISTERS Y02006   */
*   GO TO CHKASID;                  /* LOOP TO FREE ALL ASID INDESES
*                                      Y02006                        */
         B     CHKASID                                             0167
*                                                                  0168
*/********************************************************************/
*/*                                                                  */
*/*           MAP PURGE ROUTINE -                                    */
*/*                                                                  */
*/*                   PURGE MAP BEGINNING WITH CURRENT               */
*/*                   ENTRY, FOLLOWING LINK FIELD TILL               */
*/*                   END OF MAP. MAPPTR IS INPUT,                   */
*/*                   POINTING TO THE FIRST MAP ENTRY TO             */
*/*                   BE PURGED.                                     */
*/*                                                                  */
*/********************************************************************/
*                                                                  0168
*MAPPRG:                                                           0168
*   PROC OPTIONS(NOSAVEAREA,NOSAVE);                               0168
MAPPRG   DS    0H                                                  0169
*   N1=1;                           /* SET LOOP CONTROL TO NON-ZERO  */
         LA    N1,1                                                0169
*   DO WHILE(N1^=0);                /* LOOP TO FREE EACH ENTRY Y02006*/
         B     @DE00170                                            0170
@DL00170 DS    0H                                                  0171
*     N1=DUMPLINK;                  /* NO - SAVE LINK FIELD          */
         SLR   N1,N1                                               0171
         ICM   N1,7,DUMPLINK(MAPPTR)                               0171
*     RESPECIFY                                                    0172
*      (REG0,                                                      0172
*       REG1) RESTRICTED;           /* RESTRICT REGISTERS Y02006     */
*     REG1=MAPPTR;                                                 0173
         LR    REG1,MAPPTR                                         0173
*     REG0=DUMPFRMS;                /* FREE CURRENT DUMP MAP ENTRY   */
         LA    REG0,16                                             0174
*     GENERATE(FREEMAIN R,LV=(0),A=(1));                           0175
         FREEMAIN R,LV=(0),A=(1)
*     RESPECIFY                                                    0176
*      (REG0,                                                      0176
*       REG1) UNRESTRICTED;         /* UNRESTRICT REGISTERS Y02006   */
*     MAPPTR=N1;                    /* MAKE NEXT ENTRY CURRENT       */
         LR    MAPPTR,N1                                           0177
*   END;                                                           0178
@DE00170 LTR   N1,N1                                               0178
         BNZ   @DL00170                                            0178
*   END MAPPRG;                     /* RETURN TO CALLER              */
@EL00002 DS    0H                                                  0179
@EF00002 DS    0H                                                  0179
@ER00002 BR    @14                                                 0179
*                                                                  0180
*/********************************************************************/
*/*  READ THE INPUT DUMP UNTIL THE HEADER RECORD IS FOUND. THEN      */
*/*  SAVE ITS CONTENTS IN COMMON.  IF THE HEADER IS NOT THE FIRST    */
*/*  RECORD, SAVE THE RECORD PRECEEDING IT AS THE SVC BUFFER.        */
*/********************************************************************/
*                                                                  0180
*SCAN:                                                             0180
*   CALL READ;                      /* READ FOR HEADER RECORD Y02006 */
SCAN     BAL   @14,READ                                            0180
*   IF HDRSW=SWTCHOFF THEN          /* HAS A HEADER BEEN FOUND Y02006*/
         TM    HDRSW,B'00001000'                                   0181
         BNZ   @RF00181                                            0181
*     DO;                                                          0182
*       DO I=1 TO BUFFSIZE-255 BY 256;/* MOVE 256 BYTES AT A TIME  0183
*                                      (PLS REST RICTION)      Y02006*/
         LA    I,1                                                 0183
@DL00183 DS    0H                                                  0184
*         SVCBUF(I:I+255)=PRDINPUT(I:I+255);/* SAVE RECORD IN CASE 0184
*                                      ITS AN SVC BUFFER Y02006      */
         LR    @05,SVCBUFAD                                        0184
         ALR   @05,I                                               0184
         BCTR  @05,0                                               0184
         ICM   @02,7,PRDINPTR(PARMPTR)                             0184
         ALR   @02,I                                               0184
         BCTR  @02,0                                               0184
         MVC   SVCBUF(256,@05),PRDINPUT(@02)                       0184
*       END;                                                       0185
         AH    I,@CH00392                                          0185
         CH    I,@CH00644                                          0185
         BNH   @DL00183                                            0185
*       IF BUFFSIZE//256^=0 THEN    /* MOVE REMAINDER IF NOT MULTIPLE
*                                      OF 256 Y0 2006                */
*         SVCBUF(BUFFSIZE+1-BUFFSIZE//256:BUFFSIZE)=PRDINPUT(BUFFSIZE+1
*             -BUFFSIZE//256:BUFFSIZE);/* MOVE DATA Y02006           */
         LR    @02,SVCBUFAD                                        0187
         AL    @02,@CF00041                                        0187
         ICM   @01,7,PRDINPTR(PARMPTR)                             0187
         AL    @01,@CF00041                                        0187
         MVC   SVCBUF(8,@02),PRDINPUT(@01)                         0187
*       SVCTTR=INTTR;               /* ALSO SAVE THE TTR FOR THE SVC
*                                      BUFFER Y02006                 */
         ST    INTTR,SVCTTR                                        0188
*       GO TO SCAN;                 /* NOW CONTINUE SCAN FOR HEADER
*                                      Y02006                        */
         B     SCAN                                                0189
*     END;                                                         0190
*                                                                  0190
*/********************************************************************/
*/*                                                                  */
*/*  PROCESS HEADER RECORD.                                          */
*/*                                                                  */
*/********************************************************************/
*                                                                  0191
*   POSITSW=SWTCHOFF;               /* INDICATE POSIT WENT OK Y02006 */
@RF00181 NI    POSITSW(COMPTR),B'11011111'                         0191
*   SCANSW=SWTCHOFF;                /* SCAN COMPLETE Y02006          */
         NI    SCANSW,B'10111111'                                  0192
*   QASID=PRDASID;                  /* MOVE COMMON HEADER DATA TO  0193
*                                      COMMON Y02006                 */
         ICM   @02,7,PRDINPTR(PARMPTR)                             0193
         MVC   QASID(2,COMPTR),PRDASID(@02)                        0193
*   IF QASID=ALLFOX2 THEN           /* IS ASID FFFF IN HEADER Y02006 */
         CLC   QASID(2,COMPTR),@CB00058                            0194
         BNE   @RF00194                                            0194
*     QASID=0;                      /* YES-THEN CHANGE IT TO ZERO FOR
*                                      USE BY AMDPRRDC Y02006        */
         SLR   @02,@02                                             0195
         STH   @02,QASID(,COMPTR)                                  0195
*   TITLEMOD(8:15)=PRDMODNM;        /* MODULE NAME Y02006            */
@RF00194 SLR   @02,@02                                             0196
         ICM   @02,7,PRDINPTR(PARMPTR)                             0196
         MVC   TITLEMOD+7(8,COMPTR),PRDMODNM(@02)                  0196
*   TITLETME(6:13)=PRDTODVL;        /* TIME OF DAY Y02006            */
         MVC   TITLETME+5(8,COMPTR),PRDTODVL(@02)                  0197
*   HDRTITLE=PRDTITLE;              /* USER TITLE SUPPLIED AT DUMP 0198
*                                      TIME Y02006                   */
         MVC   HDRTITLE(100,COMPTR),PRDTITLE(@02)                  0198
*   IF PRDMODNM=SADMP THEN          /* IS THIS AMDSADMP INPUT Y02006 */
         CLC   PRDMODNM(8,@02),@CC00062                            0199
         BNE   @RF00199                                            0199
*     DO;                           /* YES                           */
*       SACSWCAW(1:8)=PRDCSW;       /* SAVE CSW FROM HEADER Y02006   */
         MVC   SACSWCAW(8,COMPTR),PRDCSW(@02)                      0201
*       SACSWCAW(9:12)=PRDCAW;      /* SAVE CAW FROM HEADER Y02006   */
         MVC   SACSWCAW+8(4,COMPTR),PRDCAW(@02)                    0202
*       QSADMP=SWITCHON;            /* SET SWITCH TO INDICATE      0203
*                                      AMDSADMP Y02006               */
         OI    QSADMP(COMPTR),B'00100000'                          0203
*       GO TO WRITEHDR;             /* GO READ NEXT RECORD Y02006    */
         B     WRITEHDR                                            0204
*     END;                                                         0205
*   ELSE                            /* UZ81700                       */
*     DO;                           /* LOOK FOR SVC DUMP UZ81700     */
@RF00199 DS    0H                                                  0207
*       Z9ERRID(1:10)=PRDERRID;     /* SAVE ERR ID UZ81700           */
         ICM   @02,7,PRDINPTR(PARMPTR)                             0207
         MVC   Z9ERRID(10,COMPTR),PRDERRID(@02)                    0207
*       IF Z9ERRID(1:10)='00000000000000000000'X THEN/* NO ERRID   0208
*                                      UZ81700                       */
         CLC   Z9ERRID(10,COMPTR),@CB00568                         0208
         BNE   @RF00208                                            0208
*         Z9ERRID(1:1)='FE'X;       /* INDICATE SO UZ81700           */
         MVI   Z9ERRID(COMPTR),X'FE'                               0209
*     END;                          /* UZ81700                       */
@RF00208 DS    0H                                                  0211
*   HDRREGS=PRDREGS;                /* MOVE ALL REGS (FL PT, GEN,  0211
*                                      CTL) AND CURRENT PSW Y02006   */
         SLR   @02,@02                                             0211
         ICM   @02,7,PRDINPTR(PARMPTR)                             0211
         MVC   HDRREGS(168,COMPTR),PRDREGS(@02)                    0211
*   IF SETCVTSW=SWTCHOFF THEN       /* HAS A CVT= CARD BEEN READ   0212
*                                      Y02006                        */
         TM    SETCVTSW(COMPTR),B'00000010'                        0212
         BNZ   @RF00212                                            0212
*     CVTADDR=PRDCVT;               /* NO--THEN SET CVT ADDR FROM  0213
*                                      HEADER Y02006                 */
         MVC   CVTADDR(4,COMPTR),PRDCVT(@02)                       0213
*/********************************************************************/
*/*                                                                  */
*/*  WRITE HEADER RECORD TO WORK FILE AS WELL AS SVC BUFFER          */
*/*  IF PRESENT.                                                     */
*/*                                                                  */
*/********************************************************************/
*                                                                  0214
*WRITEHDR:                                                         0214
*   CALL WRITE;                     /* WRITE HEADER TO WORK FILE   0214
*                                      Y02006                        */
@RF00212 DS    0H                                                  0214
WRITEHDR BAL   @14,WRITE                                           0214
*   IF SVCTTR^=0 THEN               /* IS THERE AN SVC BUFFER Y02006 */
         ICM   @08,15,SVCTTR                                       0215
         BZ    @RF00215                                            0215
*     DO;                                                          0216
*       DO I=1 TO BUFFSIZE-255 BY 256;/* MOVE 256 BYTES AT A TIME  0217
*                                      (PLS REST RICTION)      Y02006*/
         LA    I,1                                                 0217
@DL00217 DS    0H                                                  0218
*         PRDINPUT(I:I+255)=SVCBUF(I:I+255);/* MOVE DATA INTO BUFFER
*                                      CONTAINING HEADER Y02006      */
         ICM   @08,7,PRDINPTR(PARMPTR)                             0218
         ALR   @08,I                                               0218
         BCTR  @08,0                                               0218
         LR    @05,SVCBUFAD                                        0218
         ALR   @05,I                                               0218
         BCTR  @05,0                                               0218
         MVC   PRDINPUT(256,@08),SVCBUF(@05)                       0218
*       END;                                                       0219
         AH    I,@CH00392                                          0219
         CH    I,@CH00644                                          0219
         BNH   @DL00217                                            0219
*       IF BUFFSIZE//256^=0 THEN    /* MOVE REMAINDER IF NOT MULTIPLE
*                                      OF 256 Y02006                 */
*         PRDINPUT(BUFFSIZE+1-BUFFSIZE//256:BUFFSIZE)=SVCBUF(BUFFSIZE+1
*             -BUFFSIZE//256:BUFFSIZE);/* MOVE DATA Y02006           */
         ICM   @08,7,PRDINPTR(PARMPTR)                             0221
         AL    @08,@CF00041                                        0221
         LR    @02,SVCBUFAD                                        0221
         AL    @02,@CF00041                                        0221
         MVC   PRDINPUT(8,@08),SVCBUF(@02)                         0221
*       INTTR=SVCTTR;               /* ALSO RESET THE TTR TO THE SVC
*                                      BUFFER TTR Y02006             */
         L     INTTR,SVCTTR                                        0222
*       CALL WRITE;                 /* WRITE SVC BUFFER AND MAP IT IF
*                                      REQUIRED Y02006               */
         BAL   @14,WRITE                                           0223
*     END;                                                         0224
*   ELSE                                                           0225
*     BADREC=SWITCHON;              /* INDICATE HEADER STILL IN    0225
*                                      BUFFER, NEXT RECORD SHOULD  0225
*                                      OVERLAY IT Y02006             */
         B     @RC00215                                            0225
@RF00215 OI    BADREC,B'00000001'                                  0225
*                                                                  0226
*/********************************************************************/
*/*                                                                  */
*/*  PROCESS DUMP DATA RECORDS.                                      */
*/*  ALL REMAINING RECORDS ARE READ THEN WRITTEN UNTIL EOF IS        */
*/*  REACHED.  AS THE RECORDS ARE WRITTEN THE DUMP MAP IS BUILT.     */
*/*                                                                  */
*/********************************************************************/
*                                                                  0226
*READNXT:                                                          0226
*   CALL READ;                      /* READ A DATA RECORD Y02006     */
@RC00215 DS    0H                                                  0226
READNXT  BAL   @14,READ                                            0226
*   CALL WRITE;                     /* WRITE GOOD WORK FILE BLOCK  0227
*                                      Y02006                        */
         BAL   @14,WRITE                                           0227
*   GO TO READNXT;                  /* READ UNTIL EOF X01980         */
         B     READNXT                                             0228
*                                                                  0229
*/********************************************************************/
*/*                                                                  */
*/*  THE FOLLOWING IS THE AMDPRLOD EXIT HANDLER.  PROCESSING BY THIS */
*/*  ROUTINE INCLUDES FREEING OF BUFFER AREA, RESET SYS1.DUMP DATA   */
*/*  SET BY WRITING END-OF-FILE AS FIRST RECORD, CLOSING INPUT AND   */
*/*  WORK FILE DCB-S, AND RESTORING CALLER-S ERROR HANDLER.          */
*/*                                                                  */
*/********************************************************************/
*                                                                  0229
*EOF:                                                              0229
*   RESPECIFY                                                      0229
*    (REG0,                                                        0229
*     REG1) RESTRICTED;             /* RESTRICT REGISTERS Y02006     */
EOF      DS    0H                                                  0230
*   REG1=SVCBUFAD;                  /* SET PTR TO STORAGE TO FREE  0230
*                                      Y02006                        */
         LR    REG1,SVCBUFAD                                       0230
*   REG0=BUFFSIZE;                  /* SET SIZE TO FREE Y02006       */
         LH    REG0,@CH00039                                       0231
*   GEN(FREEMAIN R,LV=(0),A=(1));   /* FREE SVC BUFFER Y02006        */
         FREEMAIN R,LV=(0),A=(1)
*   RESPECIFY                                                      0233
*    (REG0,                                                        0233
*     REG1) UNRESTRICTED;           /* RELEASE REGISTERS Y02006      */
*   IF LOADMODE=SWITCHON THEN       /* WAS THIS LOAD MODE Y02006     */
         TM    LOADMODE,B'10000000'                                0234
         BNO   @RF00234                                            0234
*     DO;                                                          0235
*       RESPECIFY                                                  0236
*        (REG0,                                                    0236
*         REG1) RESTRICTED;         /* RESTRICT REGISTERS Y02006     */
*       REG0=BUFFSIZE+LENGTH(BUFFMAP);/* SET SIZE TO FREE      Y02006*/
         LH    REG0,@CH00643                                       0237
*       REG1=PARMPTR;               /* SET POINTER TO BUFFER ENTRY 0238
*                                      Y02006                        */
         LR    REG1,PARMPTR                                        0238
*       GEN(FREEMAIN R,A=(1),LV=(0));/* FREE INPUT BUFFER AREA Y02006*/
         FREEMAIN R,A=(1),LV=(0)
*       RESPECIFY                                                  0240
*        (REG0,                                                    0240
*         REG1) UNRESTRICTED;       /* RELEASE REGISTERS Y02006      */
*                                                                  0240
*       /*************************************************************/
*       /*                                                           */
*       /* IF INPUT WAS FROM SYS1.DUMP, RESET TO ALLOW MORE DUMPS IF */
*       /* SYS1.DUMP WAS DATE PROTECTED, RESET OCCURS ONLY IF REPLY  */
*       /* TO IEC107D IS 'U' A49127                                  */
*       /*                                                           */
*       /*************************************************************/
*                                                                  0241
*       IF SYS1SW=SWITCHON THEN     /* IS SYS1.DUMP0X INPUT ON DA  0241
*                                      Y02006                        */
         TM    SYS1SW,B'00000100'                                  0241
         BNO   @RF00241                                            0241
*         DO;                       /* M2010                         */
*           GEN( CLOSE ((R3),REREAD),TYPE=T);/* REPOSITION TO      0243
*                                      BEGINNING Y02006              */
          CLOSE ((R3),REREAD),TYPE=T
*           OFLWRDCB=SWITCHON;      /* INDICATE LAST OPERATION WAS A
*                                      WRITE Y02006                  */
         OI    OFLWRDCB,B'10000000'                                0244
*         END;                                                     0245
*     END;                                                         0246
@RF00241 DS    0H                                                  0247
*   IF X37SW=SWITCHON&DMPIC=SWTCHOFF THEN/* IS THE DUMP ON BOTH TAPE
*                                      AND DA Y02006                 */
@RF00234 TM    X37SW,B'00000010'                                   0247
         BNO   @RF00247                                            0247
         TM    DMPIC(COMPTR),B'00010000'                           0247
         BNZ   @RF00247                                            0247
*     GEN( CLOSE ((R3),REREAD));    /* CLOSE DATA SET AND REPOSITION
*                                      TO BEGINNING Y02006           */
          CLOSE ((R3),REREAD)
*   ELSE                                                           0249
*     GEN(CLOSE ((R3),DISP));       /* CLOSE DATA SET - NEVER TO USE
*                                      AGAIN Y02006                  */
         B     @RC00247                                            0249
@RF00247 DS    0H                                                  0249
         CLOSE ((R3),DISP)
*   REG3=ASYSUDCB;                                                 0250
@RC00247 SLR   REG3,REG3                                           0250
         ICM   REG3,7,ASYSUDCB(COMPTR)                             0250
*   GEN(CLOSE ((R3),REREAD));       /* CLOSE DOWN WORKFILE Y02006    */
         CLOSE ((R3),REREAD)
*   AINDCB=0;                       /* CLEAR INDCB ADDRESS AS SIGNAL
*                                      TO AMDPRCTL THAT THERE IS NO
*                                      DCB TO BE CLOSED              */
         SLR   @10,@10                                             0252
         ST    @10,AINDCB(,COMPTR)                                 0252
*   ASYSUDCB=0;                                                    0253
         STCM  @10,7,ASYSUDCB(COMPTR)                              0253
*   STOPEXIT=STOPSAVE;              /* RESTORE CALLER'S STOP ROUTINE */
         MVC   STOPEXIT(4,COMPTR),STOPSAVE                         0254
*   IF SCANSW=SWITCHON THEN         /* EOF DURING SCAN IS ERROR    0255
*                                      CONDITION OR A PREFORMATTED 0255
*                                      DUMP WAS PROCESSED Y02006     */
         TM    SCANSW,B'01000000'                                  0255
         BNO   @RF00255                                            0255
*     RETURN CODE(4);               /* RETURN TO RDC TO SEE WHAT CAN
*                                      BE DONE                       */
         LA    @15,4                                               0256
         L     @13,4(,@13)                                         0256
         L     @14,12(,@13)                                        0256
         LM    @00,@12,20(@13)                                     0256
         BR    @14                                                 0256
*   IF LOADMODE=SWITCHON THEN       /* IS THIS LOADMODE Y02006       */
@RF00255 TM    LOADMODE,B'10000000'                                0257
         BNO   @RF00257                                            0257
*     AMD174I(14)='2';              /* X01980                        */
         MVI   AMD174I+13,C'2'                                     0258
*   ELSE                                                           0259
*     AMD174I(14)='1';              /* X01980                        */
         B     @RC00257                                            0259
@RF00257 MVI   AMD174I+13,C'1'                                     0259
*   GEN REFS(APRTMSG)(BRPRTMSG AMD174I,22);/* PRINT LOADED MSG Y02006*/
@RC00257 DS    0H                                                  0260
         BRPRTMSG AMD174I,22
*   IF LOADMODE=SWITCHON THEN       /* IS THIS LOAD MODE Y02006      */
         TM    LOADMODE,B'10000000'                                0261
         BNO   @RF00261                                            0261
*     RETURN CODE(8);               /* YES--RETURN Y02006            */
         LA    @15,8                                               0262
         L     @13,4(,@13)                                         0262
         L     @14,12(,@13)                                        0262
         LM    @00,@12,20(@13)                                     0262
         BR    @14                                                 0262
*   BUILDMAP=SWTCHOFF;              /* RESET BUILDMAP FOR RDC Y02006 */
@RF00261 NI    BUILDMAP(COMPTR),B'11110111'                        0263
*LODEXIT:                                                          0264
*   RETURN CODE(0);                 /* CLEAN RETURN Y02006           */
LODEXIT  SLR   @15,@15                                             0264
         L     @13,4(,@13)                                         0264
         L     @14,12(,@13)                                        0264
         LM    @00,@12,20(@13)                                     0264
         BR    @14                                                 0264
*/********************************************************************/
*/*                                                                  */
*/*  STOP EXIT ROUTINE. BRANCH HERE IF STOP REQUESTED BY OPERATOR    */
*/*                                                                  */
*/********************************************************************/
*                                                                  0265
*STPRTN:                                                           0265
*   GEN;                                                           0265
STPRTN   DS    0H                                                  0265
         USING *,R15               TEMPORARILY USE REG 15 AS BASE
         LA    R13,@SA00001        POINT TO LOD'S SAVE AREA      Y02006
         LM    R14,R12,12(R13)     RELOAD REGS
         DROP  R15
*   GO TO EOF;                      /* GO TO CLOSE OUT               */
         B     EOF                                                 0266
*                                                                  0267
*/********************************************************************/
*/*                                                                  */
*/*  READ SUBROUTINE.  IN ADDITION TO READING RECORDS FROM THE DUMP  */
*/*  DATA SET, THE FOLLOWING EXCEPTIONAL CONDITIONS ARE HANDLED-     */
*/*                                                                  */
*/*       1.  RECORD LENGTH LESS THAN 4104 BUT GREATER THAN          */
*/*           133 ARE SKIPPED.  IF 5 RECORDS ARE SKIPPED BEFORE      */
*/*           THE HEADER IS FOUND THE DUMP ISREJECTED.               */
*/*                                                                  */
*/*       2.  RECORD LENGTH LESS THAN 134 BYTES.  THESE RECORDS ARE  */
*/*           ASSUMED TO BE A PREFORMATED DUMP AND THEY ARE PRINTED  */
*/*           DIRECTLY.                                              */
*/*                                                                  */
*/*                                                                  */
*/********************************************************************/
*                                                                  0267
*READ:                                                             0267
*   PROC;                                                          0267
READ     STM   @14,@05,@SA00003                                    0267
         ST    @07,@SA00003+32                                     0267
         STM   @09,@12,@SA00003+36                                 0267
*   SYNADISW=SWTCHOFF;              /* RESET SYNAD INDICATOR Y02006  */
         NI    SYNADISW,B'11101111'                                0268
*   IOERRCNT=0;                     /* INITIALIZE IO ERROR COUNT TO
*                                      ZERO X01980                   */
         SLR   IOERRCNT,IOERRCNT                                   0269
*IGNORE:                                                           0270
*   IF BADREC=SWITCHON THEN         /* SHOULD THE LAST RECORD BE   0270
*                                      OVERLAYED Y02006              */
IGNORE   TM    BADREC,B'00000001'                                  0270
         BO    @RT00270                                            0270
*     GO TO RESET;                  /* YES--THEN REUSE BUFFER Y02006 */
*   IF HDRSW=SWITCHON&BUFFLINK^=0 THEN/* USE NEXT BUFFER ONLY IF A 0272
*                                      HEADER HAS BEEN READ AND THERE
*                                      IS ANOTHER BUFFER       Y02006*/
         TM    HDRSW,B'00001000'                                   0272
         BNO   @RF00272                                            0272
         L     @10,BUFFLINK(,PARMPTR)                              0272
         LTR   @10,@10                                             0272
         BZ    @RF00272                                            0272
*     DO;                                                          0273
*       PARMPTR=BUFFLINK;           /* SET POINTER TO NEXT BUFFER MAP
*                                      ENTRY Y02006                  */
         LR    PARMPTR,@10                                         0274
*       IOERR=SWTCHOFF;             /* RESET I/O ERROR SWITCH ONLY ON
*                                      USE OF A NEW BUFFER (NEEDED 0275
*                                      FOR CPU RECS) Y02006          */
         NI    IOERR(COMPTR),B'01111111'                           0275
*     END;                                                         0276
*   ELSE                                                           0277
*     DO;                                                          0277
         B     @RC00272                                            0277
@RF00272 DS    0H                                                  0278
*       DMPIC=SWTCHOFF;             /* INDICATE DUMP DOES NOT FIT  0278
*                                      INTO ALL THE BUFFERS          */
         NI    DMPIC(COMPTR),B'11101111'                           0278
*RESET:                                                            0279
*       BUFFREAL=ALLFOX;            /* RESET REAL ADDRESS Y02006     */
RESET    SLR   @10,@10                                             0279
         BCTR  @10,0                                               0279
         ST    @10,BUFFREAL(,PARMPTR)                              0279
*       BUFFVIRT=ALLFOX;            /* RESET VIRTUAL ADDRESS Y02006  */
         ST    @10,BUFFVIRT(,PARMPTR)                              0280
*       BUFFASID=ALLFOX2;           /* RESET ASID Y02006             */
         MVC   BUFFASID(2,PARMPTR),@CB00058                        0281
*       BUFFCPU=ALLFOX2;            /* RESET CPU ADDRESS Y02006      */
         MVC   BUFFCPU(2,PARMPTR),@CH00058                         0282
*       BUFFFLAG=BYTEOFF;           /* RESET FLAGS Y02006            */
         MVI   BUFFFLAG(PARMPTR),X'00'                             0283
*     END;                          /* NOW REUSE THE SAME BUFFER   0284
*                                      Y02006                        */
*IGNORE1:                                                          0285
*   RESPECIFY                                                      0285
*    (REG1,                                                        0285
*     REG2) RESTRICTED;             /* RESTRICT REGISTERS Y02006     */
@RC00272 DS    0H                                                  0285
IGNORE1  DS    0H                                                  0286
*   REG2=BUFFPTR;                   /* SET REG FOR INPUT AREA Y02006 */
         SLR   REG2,REG2                                           0286
         ICM   REG2,7,BUFFPTR(PARMPTR)                             0286
*   GEN FLOWS(TAPEER);                                             0287
*                                   /* Y02006                        */
    READ RDDECB,SF,(R3),(R2),'S'    /* Y02006                        */
    CHECK RDDECB
    NOTE (R3)                       /* Y02006                        */
*TERRET:                                                           0288
*   INTTR=REG1;                     /* SAVE NOTED POSITION Y02006    */
TERRET   LR    INTTR,REG1                                          0288
*   RESPECIFY                                                      0289
*    (REG1,                                                        0289
*     REG2) UNRESTRICTED;           /* UNRESTRICT REGISTERS Y02006   */
*   LASTIVOL=CURIVOL;               /* SAVE LAST VOLUME NUMBER Y02006*/
         LH    @10,CURIVOL                                         0290
         STH   @10,LASTIVOL                                        0290
*   IF INTTR=FIRSTTR THEN           /* HAS A VOLUME SWITCH OCURRED 0291
*                                      Y02006                        */
         C     INTTR,FIRSTTR                                       0291
         BNE   @RF00291                                            0291
*     CURIVOL=CURIVOL+1;            /* YES--INCREMENT VOLUME COUNT 0292
*                                      Y02006                        */
         LA    @10,1(,@10)                                         0292
         STH   @10,CURIVOL                                         0292
*   IF SYNADISW=SWITCHON THEN       /* DID AN I/O ERROR OCCUR Y02006 */
@RF00291 TM    SYNADISW,B'00010000'                                0293
         BNO   @RF00293                                            0293
*     DO;                                                          0294
*       SYNADISW=SWTCHOFF;          /* TURN OFF SYNAD ERROR INDICATOR
*                                      Y02006                        */
         NI    SYNADISW,B'11101111'                                0295
*       CURADDR=INITADDR;           /* REINITIALIZE CURRENT ADDRESS
*                                      Y02006                        */
         MVC   CURADDR(4),@CB00056                                 0296
*       IOERRCNT=IOERRCNT+1;        /* INCREMENT IO ERROR COUNT    0297
*                                      X01980                        */
         AH    IOERRCNT,@CH00043                                   0297
*       IF IOERRCNT>2 THEN                                         0298
         CH    IOERRCNT,@CH00143                                   0298
         BH    @RT00298                                            0298
*         GO TO RDEOF;              /* PERFORM CLEANUP               */
*       ELSE                                                       0300
*         GO TO IGNORE1;            /* CONTINUE READING              */
         B     IGNORE1                                             0300
*     END;                                                         0301
*   IOERRCNT=0;                     /* SUCCESSFUL READ OCCURRED    0302
*                                      X01980                        */
@RF00293 SLR   IOERRCNT,IOERRCNT                                   0302
*   IF(BUFFSIZE-IOBCSWCT)<=133 THEN /* IS THIS A PREFORMATTED RECORD
*                                      Y02006                        */
         LH    @10,@CH00039                                        0303
         L     @07,DCBIOBA                                         0303
         SH    @10,IOBCSWCT+22(,@07)                               0303
         CH    @10,@CH00157                                        0303
         BH    @RF00303                                            0303
*PREFMT:                                                           0304
*     DO;                           /* X01980 SHORT RECORD WHEN NOT
*                                      DOING POSITIONING MEANS END OF
*                                      DUMP AND NO EOF MARK          */
PREFMT   DS    0H                                                  0305
*       IF SCANSW=SWTCHOFF THEN                                    0305
         TM    SCANSW,B'01000000'                                  0305
         BZ    @RT00305                                            0305
*         GO TO RDEOF;                                             0306
*       IF PREFM=SWITCHON THEN      /* IS THE TITLE INITIALIZED    0307
*                                      Y02006                        */
         TM    PREFM(COMPTR),B'00000010'                           0307
         BO    @RT00307                                            0307
*         GO TO PRINT;              /* YES--GO PRINT RECORD Y02006   */
*       PREFM=SWITCHON;             /* NO--TURN ON AND INITIALIZE  0309
*                                      Y02006                        */
         OI    PREFM(COMPTR),B'00000010'                           0309
*       TITLEMOD(8:15)='PREFORM ';                                 0310
         MVC   TITLEMOD+7(8,COMPTR),@CC00596                       0310
*       TITLEDTE(6:13)=BLANKS;                                     0311
         MVC   TITLEDTE+5(8,COMPTR),BLANKS(COMPTR)                 0311
*       TITLETME(6:13)=BLANKS;                                     0312
         MVC   TITLETME+5(8,COMPTR),BLANKS(COMPTR)                 0312
*       GEN FLOWS(STPRTN) REFS(AWRITE)(BRWRITE SKIP);/* START ON   0313
*                                      CLEAN PAGE MOVE SHORT RECORD
*                                      TO OUTPUT AREA Y02006         */
         BRWRITE SKIP
*PRINT:                                                            0314
*       OUTBUF=PRDINPUT(1:BUFFSIZE-IOBCSWCT);/* MOVE RECORD TO OUTPUT
*                                      AREA Y02006                   */
PRINT    L     @10,CURBUF(,COMPTR)                                 0314
         MVI   OUTBUF+1(@10),C' '                                  0314
         MVC   OUTBUF+2(131,@10),OUTBUF+1(@10)                     0314
         LH    @08,@CH00039                                        0314
         L     @07,DCBIOBA                                         0314
         SH    @08,IOBCSWCT+22(,@07)                               0314
         BCTR  @08,0                                               0314
         ICM   @07,7,PRDINPTR(PARMPTR)                             0314
         EX    @08,@SM00659                                        0314
*       GEN FLOWS(STPRTN) REFS(AWRITE)(BRWRITE 1);/* WRITE RECORD  0315
*                                      Y02006                        */
         BRWRITE 1
*       GO TO IGNORE1;              /* LOOP TO GET NEXT SHORT RECORD */
         B     IGNORE1                                             0316
*     END PREFMT;                                                  0317
*   IF PREFM=SWITCHON THEN          /* HAVE PREFORMATTED RECORDS BEEN
*                                      FOUND Y02006                  */
@RF00303 TM    PREFM(COMPTR),B'00000010'                           0318
         BO    @RT00318                                            0318
*     GO TO RDEOF;                  /* YES--THEN END DUMP Y02006     */
*   IF IOBCSWCT^=0 THEN             /* RESIDUAL COUNT FOR X01980     */
         SLR   @10,@10                                             0320
         L     @07,DCBIOBA                                         0320
         CH    @10,IOBCSWCT+22(,@07)                               0320
         BE    @RF00320                                            0320
*     DO;                           /* READ OPERATION X01980         */
*       POSTIPL=POSTIPL+1;          /* ADD ONE TO COUNT OF PREHEADER
*                                      RECORDS Y02006                */
         LH    @08,POSTIPL                                         0322
         LA    @08,1(,@08)                                         0322
         STH   @08,POSTIPL                                         0322
*       SVCTTR=0;                   /* INDICATE NO SVC BUFFER Y02006 */
         ST    @10,SVCTTR                                          0323
*       CURADDR=INITADDR;           /* REINITIALIZE CURRENT ADDRESSS
*                                      Y02006                        */
         MVC   CURADDR(4),@CB00056                                 0324
*       GO TO IGNORE1;              /* CONTINUE REUSING SAME BUFFER
*                                      Y02006                        */
         B     IGNORE1                                             0325
*     END;                                                         0326
*   IF PRDHDRID=PRDHDR&PRDRECID=PRDHDREC THEN/* IS THIS A HEADER   0327
*                                      RECORD Y02006                 */
@RF00320 SLR   @10,@10                                             0327
         ICM   @10,7,PRDINPTR(PARMPTR)                             0327
         CLI   PRDHDRID(@10),X'FF'                                 0327
         BNE   @RF00327                                            0327
         CLI   PRDRECID(@10),X'FF'                                 0327
         BNE   @RF00327                                            0327
*     DO;                                                          0328
*       IF HDRSW=SWITCHON THEN      /* HAS A HEADER ALREADY BEEN   0329
*                                      FOUND Y02006                  */
         TM    HDRSW,B'00001000'                                   0329
         BO    @RT00329                                            0329
*         GO TO RDEOF;              /* YES--STOP DUMP HERE Y02006    */
*       HDRSW=SWITCHON;             /* YES--TURN ON SWITCH Y02006    */
         OI    HDRSW,B'00001000'                                   0331
*       DMPIC=SWITCHON;             /* INDICATE COMPLETE DUMP CAN BE
*                                      READ INTO CORE (SO FAR) Y02006*/
         OI    DMPIC(COMPTR),B'00010000'                           0332
*       RETURN;                     /* RETURN RECORD Y02006          */
@EL00003 DS    0H                                                  0333
@EF00003 DS    0H                                                  0333
@ER00003 LM    @14,@05,@SA00003                                    0333
         L     @07,@SA00003+32                                     0333
         LM    @09,@12,@SA00003+36                                 0333
         BR    @14                                                 0333
*     END;                                                         0334
*   IF HDRSW=SWITCHON THEN          /* HAS A HEADER ALREADY BEEN   0335
*                                      FOUND Y02006                  */
@RF00327 TM    HDRSW,B'00001000'                                   0335
         BO    @RT00335                                            0335
*     RETURN;                       /* YES--RETURN TO PROCESS THIS 0336
*                                      RECORD Y02006                 */
*   IF POSTIPL=5 THEN               /* HAVE 5 RECORDS BEEN READ    0337
*                                      WITHOUT A HEADER Y02006       */
         LH    @10,POSTIPL                                         0337
         CH    @10,@CH00210                                        0337
         BE    @RT00337                                            0337
*     GO TO RDEOF;                  /* YES--STOP DUMP Y02006         */
*   POSTIPL=POSTIPL+1;              /* ADD 1 TO PREHEADER COUNT    0339
*                                      Y02006                        */
         LA    @10,1(,@10)                                         0339
         STH   @10,POSTIPL                                         0339
*   RETURN;                         /* RETURN Y02006                 */
         B     @EL00003                                            0340
*RDEOF:                                                            0341
*   RETURN TO EOF;                  /* SIGNAL EOF TO CALLER          */
RDEOF    LA    @14,EOF                                             0341
         LM    @15,@05,@SA00003+4                                  0341
         L     @07,@SA00003+32                                     0341
         LM    @09,@12,@SA00003+36                                 0341
         BR    @14                                                 0341
*TAPEER:                                                           0342
*   SYNADISW=SWITCHON;              /* INDICATE SYNAD ENTERED Y02006 */
TAPEER   OI    SYNADISW,B'00010000'                                0342
*   IOERR=SWITCHON;                 /* INDICATE AN I/O ERROR OCCURRED
*                                      Y02006                        */
         OI    IOERR(COMPTR),B'10000000'                           0343
*   GEN FLOWS(TERRET) NOSEQFLOW(BR R14);/* RETURN TO CHECK ROUTINE   */
         BR R14
*   GEN DATA;                                                      0345
*   END READ;                                                      0346
         B     @EL00003                                            0346
*                                                                  0347
*/********************************************************************/
*/*                                                                  */
*/*                    WRITE TO WORK FILE SUBROUTINE                 */
*/*  THIS SUBROUTINE WRITES RECORDS TO THE WORK FILE AND BUILDS      */
*/*  THE DUMP MAPS.  IF A B37, D37, OR E37 ABEND OCCURS WRITING      */
*/*  TO SYSUT1, PROCESSING CONTINUES BY BUILDING THE DUMP MAP        */
*/*  FROM THE INPUT RECORDS.                                         */
*/*                                                                  */
*/********************************************************************/
*                                                                  0347
*WRITE:                                                            0347
*   PROC;                                                          0347
WRITE    STM   @14,@06,@SA00004                                    0347
         STM   @08,@09,@SA00004+36                                 0347
         STM   @11,@12,@SA00004+44                                 0347
*   IF X37SW=SWTCHOFF THEN          /* HAS AN ABEND OCCURRED Y02006  */
         TM    X37SW,B'00000010'                                   0348
         BZ    @RT00348                                            0348
*     GO TO UTWRITE;                /* NO--GO WRITE OUTPUT Y02006    */
*USETAPE:                                                          0350
*   CURVOL=CURIVOL;                 /* MAKE TAPE VOLUME CURRENT    0350
*                                      Y02006                        */
USETAPE  MVC   CURVOL(1),CURIVOL+1                                 0350
*   LASTVOL=LASTIVOL;               /* ALSO MAKE LAST INPUT VOLUME 0351
*                                      THE LASTVOL Y02006            */
         LH    LASTVOL,LASTIVOL                                    0351
*   TTRNO=INTTR;                    /* SET TTR NUMBER Y02006         */
         LR    TTRNO,INTTR                                         0352
*   CALL MAPBUILD;                  /* GO PLACE THIS RECORD IN THE 0353
*                                      MAP Y02006                    */
         BAL   @14,MAPBUILD                                        0353
*   GO TO GOBACK;                   /* AND RETURN Y02006             */
         B     GOBACK                                              0354
*UTWRITE:                                                          0355
*   SYNADOSW=SWTCHOFF;              /* RESET SYNAD INDICATOR Y02006  */
UTWRITE  NI    SYNADOSW,B'11011111'                                0355
*   RESPECIFY                                                      0356
*    (REG1,                                                        0356
*     REG2) RESTRICTED;             /* RESTRICT REGISTERS Y02006     */
*   REG2=ADDR(PRDINPUT);            /* POINT TO OUTPUT AREA Y02006   */
         SLR   REG2,REG2                                           0357
         ICM   REG2,7,PRDINPTR(PARMPTR)                            0357
*   REG3=ASYSUDCB;                  /* POINT TO WORK FILE DCB        */
         SLR   REG3,REG3                                           0358
         ICM   REG3,7,ASYSUDCB(COMPTR)                             0358
*WRITEREC:                                                         0359
*   GEN FLOWS(SYSUER,DCBABEND)      /* Y02006                        */
*       ;                                                          0359
WRITEREC DS    0H                                                  0359
    WRITE WTDECB,SF,(R3),(R2)
    CHECK WTDECB
*   IF X37SW=SWITCHON THEN          /* DID AN ABEND OCCUR Y02006     */
         TM    X37SW,B'00000010'                                   0360
         BO    @RT00360                                            0360
*     GO TO USETAPE;                /* YES--THEN GO MAP THE INPUT  0361
*                                      RECORD Y02006                 */
*   GEN(NOTE (R3));                 /* NO--NOTE RECORD Y02006        */
         NOTE (R3)
*   TTRNO=REG1;                     /* SAVE NOTED LOCATION X01980    */
         LR    TTRNO,REG1                                          0363
*   RESPECIFY                                                      0364
*    (REG1,                                                        0364
*     REG2) UNRESTRICTED;           /* UNRESTRICT REGISTERS Y02006   */
*   LASTVOL=CURVOL;                 /* SAVE LAST VOLUME NUMBER Y02006*/
         SLR   @02,@02                                             0365
         IC    @02,CURVOL                                          0365
         LR    LASTVOL,@02                                         0365
*   IF TTRNO=HEADTTR THEN           /* TTR START OF NEW VOL? Y01980  */
         C     TTRNO,HEADTTR                                       0366
         BNE   @RF00366                                            0366
*     CURVOL=CURVOL+1;              /* YES - INCR VOLU SEQ Y01980    */
         LA    @02,1(,@02)                                         0367
         STC   @02,CURVOL                                          0367
*   IF SYNADOSW=SWITCHON THEN       /* DID AN I/O ERROR OCCUR Y02006 */
@RF00366 TM    SYNADOSW,B'00100000'                                0368
         BNO   @RF00368                                            0368
*     DO;                           /* SYNAD HAS BEEN ENTERED        */
*       IF LOADMODE=SWITCHON THEN   /* IS THIS LOAD MODE Y02006      */
         TM    LOADMODE,B'10000000'                                0370
         BNO   @RF00370                                            0370
*         DO;                                                      0371
*           RESPECIFY                                              0372
*            (REG0,                                                0372
*             REG1) RESTRICTED;     /* RESTRICT REGISTERS Y02006     */
*           REG0=16;                /* YES--SYSUT2 DDNAME Y02006     */
         LA    REG0,16                                             0373
*           REG1=12;                /* CODE FOR MESSAGE AMD153I      */
         LA    REG1,12                                             0374
*           GEN REFS(AEREXIT) EXIT NOSEQFLOW;                      0375
            L     R15,AEREXIT(COMBASE) POINT TO ERROR EXIT ROUTINE
            BALR  R14,R15              R14 SET FOR DEBUGGING ONLY
*           RESPECIFY                                              0376
*            (REG0,                                                0376
*             REG1) UNRESTRICTED;   /* RELEASE REGISTERS Y02006      */
*         END;                                                     0377
*       X37SW=SWITCHON;             /* I/O ERROR TO SYSUT1--TREAD  0378
*                                      LIKE RECOVERY FROM X37 ABEND
*                                      Y02006                        */
@RF00370 OI    X37SW,B'00000010'                                   0378
*       TREADIN=SWITCHON;           /* INDICATE MAPS NOW FOR TAPE  0379
*                                      Y02006                        */
         OI    TREADIN(COMPTR),B'00010000'                         0379
*       LASTIVOL=0;                 /* RESET LAST INPUT VOL NUMBER TO
*                                      CAUSE NEW DUMP MAP ENTRY TO BE
*                                      CREATED Y02006                */
         SLR   @09,@09                                             0380
         STH   @09,LASTIVOL                                        0380
*       GEN REFS(APRTMSG)           /* PRINT MESSAGE Y02006          */
*           ;                                                      0381
        BRPRTMSG AMD291I,L'AMD291I   ' <- END QUOTE FOR PLS     YM00652
*       GO TO USETAPE;              /* GO MAP RECORD FROM INPUT FILE
*                                      Y02006                        */
         B     USETAPE                                             0382
*     END;                                                         0383
*   IF LOADMODE=SWTCHOFF&(PRDHDRID^=PRDHDRPRDRECID^=PRDHDREC) THEN/*
*                                      RECORD WAS WRITTEN OKAY, NOW
*                                      SHOULD IT BE MAPPED Y02006    */
@RF00368 TM    LOADMODE,B'10000000'                                0384
         BNZ   @RF00384                                            0384
         SLR   @08,@08                                             0384
         ICM   @08,7,PRDINPTR(PARMPTR)                             0384
         CLI   PRDHDRID(@08),X'FF'                                 0384
         BNE   @RT00384                                            0384
         CLI   PRDRECID(@08),X'FF'                                 0384
         BE    @RF00384                                            0384
@RT00384 DS    0H                                                  0385
*     CALL MAPBUILD;                /* YES--GO MAP ENTRY Y02006      */
         BAL   @14,MAPBUILD                                        0385
*GOBACK:                                                           0386
*   REG3=ADDR(INDCB);               /* RESTORE REG 3 TO ADDRESS INPUT
*                                      DCB X01980                    */
@RF00384 DS    0H                                                  0386
GOBACK   LA    REG3,INDCB                                          0386
*   RETURN;                                                        0387
@EL00004 DS    0H                                                  0387
@EF00004 DS    0H                                                  0387
@ER00004 LM    @14,@06,@SA00004                                    0387
         LM    @08,@09,@SA00004+36                                 0387
         LM    @11,@12,@SA00004+44                                 0387
         BR    @14                                                 0387
*                                                                  0388
*/********************************************************************/
*/*                                                                  */
*/*  MAP BUILD ROUTINE.  THIS ROUTINE PLACES THE ADDRESS AND TTR OF  */
*/* EACH RECORD INTO THE DUMP MAP.  THERE ARE UP TO 3 SETS OF        */
*/* DUMP MAPS.  'REALMAP' POINTS TO DUMP MAP ENTRIES FOR REAL        */
*/* DUMP INPUT, 'CPUMAP' POINTS TO DUMP MAP ENTRIES FOR CPU          */
*/* STATUS RECORDS.  FOR VIRTUAL DUMPS 'ASIDNDX' POINTS TO A         */
*/* TABLE OF ASID'S AND MAP POINTERS.  FOR EACH ASID DUMPED THERE    */
*/* EXISTS A SET OF DUMP MAP ENTRIES.                                */
*/* THIS ROUTINE BUILDS BOTH THE DUMP MAP ENTRIES AND THE ASID       */
*/* TABLES.  WHEN RECORD ADDRESSES ARE IN SEQUENCE THEN THE LAST     */
*/* MAP ENTRY IS JUST UPDATED.                                       */
*/*                                                                  */
*/********************************************************************/
*                                                                  0388
*MAPBUILD:                                                         0388
*   PROC OPTIONS(NOSAVEAREA,NOSAVE);                               0388
MAPBUILD DS    0H                                                  0389
*   RESPECIFY                                                      0389
*     REG14 RESTRICTED;             /* RESTRICT RETURN REG Y02006    */
*   TEMPSAVE=REG14;                 /* SAVE RETURN REG IN CASE     0390
*                                      ASIDSRCH IS CALLED Y02006     */
         LR    TEMPSAVE,REG14                                      0390
*   RESPECIFY                                                      0391
*     REG14 UNRESTRICTED;           /* UNRESTRICT RETURN REG Y02006  */
*   BADREC=SWTCHOFF;                /* RESET BAD RECORD SWITCH Y02006*/
         NI    BADREC,B'11111110'                                  0392
*   IF PRDHDRID=PRDHDR&PRDRECID=PRDCPUID THEN/* IS THS A CPU STATUS
*                                      RECORD Y02006                 */
         SLR   @05,@05                                             0393
         ICM   @05,7,PRDINPTR(PARMPTR)                             0393
         CLI   PRDHDRID(@05),X'FF'                                 0393
         BNE   @RF00393                                            0393
         CLI   PRDRECID(@05),X'0F'                                 0393
         BE    @RT00393                                            0393
*     GO TO CPUREC;                 /* YES--GO TO CPU ROUTINE Y02006 */
*   IF PRDADDR//DUMPBLK^=0 THEN     /* IS THE DATA ADDRESS A MULTIPLE
*                                      OF 4K Y0 2006                 */
@RF00393 ICM   @05,7,PRDINPTR(PARMPTR)                             0395
         L     @05,PRDADDR(,@05)                                   0395
         N     @05,@CF00664                                        0395
         LTR   @05,@05                                             0395
         BZ    @RF00395                                            0395
*     DO;                                                          0396
*       CURADDR=INITADDR;           /* NO--IGNORE THIS RECORD,     0397
*                                      REINITIALIZE LAST ADDRESS   0397
*                                      Y02006                        */
         MVC   CURADDR(4),@CB00056                                 0397
*       BADREC=SWITCHON;            /* INDICATE RECORD NOT PLACED IN
*                                      MAP Y02006                    */
         OI    BADREC,B'00000001'                                  0398
*       GO TO MAPRET;               /* RETURN TO CALLER              */
         B     MAPRET                                              0399
*     END;                                                         0400
*   IF PRDASID=CURASID&PRDADDR=CURADDR+DUMPBLK&(DUMPLINK=0DUMPLINK->
*       DUMPFADD^=PRDADDR) THEN     /* IS THIS BLOCK IN THE SAME   0401
*                                      MEMORY, THE NEXT PAGE AFTER 0401
*                                      THE LAST BLOCK & NOT DUPLICATE
*                                                             YM00653*/
@RF00395 SLR   @05,@05                                             0401
         ICM   @05,7,PRDINPTR(PARMPTR)                             0401
         CLC   PRDASID(2,@05),CURASID                              0401
         BNE   @RF00401                                            0401
         L     @05,PRDADDR(,@05)                                   0401
         LH    @02,@CH00041                                        0401
         AL    @02,CURADDR                                         0401
         CLR   @05,@02                                             0401
         BNE   @RF00401                                            0401
         SLR   @02,@02                                             0401
         ICM   @02,7,DUMPLINK(MAPPTR)                              0401
         LTR   @02,@02                                             0401
         BZ    @RT00401                                            0401
         CL    @05,DUMPFADD(,@02)                                  0401
         BNE   @RT00401                                            0401
*     GO TO CHKVOLS;                /* YES--THEN GO CHECK IF THE   0402
*                                      VOLUME HAS CHANGED Y02006     */
*   IF PRDASID=CURASID THEN         /* WHILE THE ADDRESS IS NOT NEXT,
*                                      IS THE ASID STILL THE SAME  0403
*                                      Y02006                        */
@RF00401 SLR   @07,@07                                             0403
         ICM   @07,7,PRDINPTR(PARMPTR)                             0403
         CLC   PRDASID(2,@07),CURASID                              0403
         BE    @RT00403                                            0403
*     GO TO SCANMAP;                /* YES--THEN USE THE CURRENT MAP
*                                      AND GO SCAN IT Y02006         */
*   IF PRDASID=0 THEN               /* IS THIS A REAL DUMP RECORD  0405
*                                      Y02006                        */
         ICM   @10,3,PRDASID(@07)                                  0405
         BNZ   @RF00405                                            0405
*     DO;                                                          0406
*       CURMAP=REALMAP;             /* YES--THEN POINT TO THE REAL 0407
*                                      MAP Y02006                    */
         L     CURMAP,REALMAP(,COMPTR)                             0407
*       LASTMAP=ADDR(REALMAP);      /* ALSO SET UP THE LINK POINTER
*                                      (THIS IS USED IF THE NEW MAP
*                                      ENTRY GOES FIRST Y02006       */
         LA    @07,REALMAP(,COMPTR)                                0408
         ST    @07,LASTMAP                                         0408
*       GO TO SCANMAP;              /* NOW GO SCAN THE REAL MAP    0409
*                                      Y02006                        */
         B     SCANMAP                                             0409
*     END;                                                         0410
*   IF ASIDNDX=0 THEN               /* IS THERE AN ASID INDEX YET  0411
*                                      Y02006                        */
@RF00405 ICM   @10,15,ASIDNDX(COMPTR)                              0411
         BNZ   @RF00411                                            0411
*     DO;                                                          0412
*       RESPECIFY                                                  0413
*        (REG0,                                                    0413
*         REG4) RESTRICTED;         /* RESTRICT REGISTERS Y02006     */
*       REG4=ADDR(INDXADDR);        /* NO--SO SET UP TO GET FIRST ONE
*                                      Y02006                        */
         LA    REG4,INDXADDR                                       0414
*       REG0=LENGTH(ASIDLIST);      /* SET LENGTH FOR GETMAIN Y02006 */
         LA    REG0,112                                            0415
*       GEN(GETMAIN EU,LV=(0),A=(R4));/* ISSUE GETMAIN FOR FIRST ASID
*                                      INDEX Y02006                  */
         GETMAIN EU,LV=(0),A=(R4)
*       RESPECIFY                                                  0417
*        (REG0,                                                    0417
*         REG4) UNRESTRICTED;       /* UNRESTRICT REGISTERS Y02006   */
*       ASIDNDX=INDXADDR;           /* SET POINTER IN COMMON TO ASID
*                                      INDEX Y02006                  */
         L     @10,INDXADDR                                        0418
         ST    @10,ASIDNDX(,COMPTR)                                0418
*       ASIDLIST=ASIDLIST&&ASIDLIST;/* SET NEW INDEX TO ZERO Y02006  */
         XC    ASIDLIST(112,@10),ASIDLIST(@10)                     0419
*       INDEX=1;                    /* SET INDEX TO ONE FOR FIRST NEW
*                                      ENTRY Y02006                  */
         LA    INDEX,1                                             0420
*       GO TO INSERT;               /* GO INSERT THE NEW ASID INTO 0421
*                                      THE INDEX Y02006              */
         B     INSERT                                              0421
*     END;                                                         0422
*   CALL ASIDSRCH;                  /* SEARCH ASIDLIST FOR NEW ASID
*                                      Y02006                        */
@RF00411 BAL   @14,ASIDSRCH                                        0423
*   IF INDEX=0 THEN                 /* ARE ALL TABLES FULL AND NEW 0424
*                                      ASID NOT FOUND Y02006         */
         LTR   INDEX,INDEX                                         0424
         BNZ   @RF00424                                            0424
*     DO;                                                          0425
*       RESPECIFY                                                  0426
*        (REG0,                                                    0426
*         REG4) RESTRICTED;         /* RESTRICT REGISTERS Y02006     */
*       REG4=ADDR(ASDXLNK);         /* YES--NEED TO GET STORAGE FOR
*                                      NEW TABLE Y02006              */
         L     REG4,INDXADDR                                       0427
*       REG0=LENGTH(ASIDLIST);      /* GET LENGTH FOR TABLE Y02006   */
         LA    REG0,112                                            0428
*       GENERATE(GETMAIN EU,LV=(0),A=(R4));/* GET STORAGE FOR TABLE
*                                      Y02006                        */
         GETMAIN EU,LV=(0),A=(R4)
*       RESPECIFY                                                  0430
*        (REG0,                                                    0430
*         REG4) UNRESTRICTED;       /* UNRESTRICT REGISTERS Y02006   */
*       INDXADDR=ASDXLNK;           /* SET PTR TO NEW TABLE Y02006   */
         L     @10,INDXADDR                                        0431
         L     @10,ASDXLNK(,@10)                                   0431
         ST    @10,INDXADDR                                        0431
*       ASIDLIST=ASIDLIST&&ASIDLIST;/* ZERO OUT NEW TABLE      Y02006*/
         XC    ASIDLIST(112,@10),ASIDLIST(@10)                     0432
*       INDEX=1;                    /* SET INDEX TO FIRST ENTRY    0433
*                                      Y02006                        */
         LA    INDEX,1                                             0433
*       GO TO INSERT;               /* GO INSERT NEW ASID INTO TABLE
*                                      Y02006                        */
         B     INSERT                                              0434
*     END;                                                         0435
*   IF ASDXASID(INDEX)=PRDASID THEN /* CHECK TO VERIFY ASID WAS FOUND
*                                      IN TABLE Y02006               */
@RF00424 L     @10,INDXADDR                                        0436
         LR    @07,INDEX                                           0436
         ALR   @07,@07                                             0436
         ICM   @01,7,PRDINPTR(PARMPTR)                             0436
         ALR   @07,@10                                             0436
         CLC   ASDXASID-2(2,@07),PRDASID(@01)                      0436
         BNE   @RF00436                                            0436
*     DO;                                                          0437
*       CURMAP=ASDXMAP(INDEX);      /* YES--SET PTR TO MAPS FOR    0438
*                                      EXISTING ASID Y02006          */
         L     @07,INDXADDR                                        0438
         LR    @15,INDEX                                           0438
         SLA   @15,2                                               0438
         L     CURMAP,ASDXMAP-4(@15,@07)                           0438
*       LASTMAP=ADDR(ASDXMAP(INDEX));/* ALSO SET PTR TO LOCATION   0439
*                                      POINTING TO MAP Y02006        */
         LA    @07,ASDXMAP-4(@15,@07)                              0439
         ST    @07,LASTMAP                                         0439
*       GO TO SCANMAP;              /* NOW GO SCAN MAP Y02006        */
         B     SCANMAP                                             0440
*     END;                                                         0441
*INSERT:                                                           0442
*   ASDXASID(INDEX)=PRDASID;        /* INSERT NEW ASID INTO TABLE  0442
*                                      Y02006                        */
@RF00436 DS    0H                                                  0442
INSERT   L     @07,INDXADDR                                        0442
         LR    @15,INDEX                                           0442
         ALR   @15,@15                                             0442
         ALR   @15,@07                                             0442
         ICM   @01,7,PRDINPTR(PARMPTR)                             0442
         MVC   ASDXASID-2(2,@15),PRDASID(@01)                      0442
*   CURMAP=ASDXMAP(INDEX);          /* SET CURRENT MAP POINTER TO NEW
*                                      MAP Y02006                    */
         LR    @15,INDEX                                           0443
         SLA   @15,2                                               0443
         L     CURMAP,ASDXMAP-4(@15,@07)                           0443
*   LASTMAP=ADDR(ASDXMAP(INDEX));   /* ALSO SET POINTER TO ADDRESS OF
*                                      MAP Y02006                    */
         LA    @07,ASDXMAP-4(@15,@07)                              0444
         ST    @07,LASTMAP                                         0444
*/********************************************************************/
*/*                                                                  */
*/* THIS SECTION SCANS THE MAP POINTED TO BY 'CURMAP' FOR THE        */
*/* LOCATION TO PLACE THE NEW MAP ENTRY.                             */
*/*                                                                  */
*/********************************************************************/
*                                                                  0445
*SCANMAP:                                                          0445
*   MAPPTR=CURMAP;                  /* SET POINTER TO CURRENT MAP  0445
*                                      ENTRY Y02006                  */
SCANMAP  LR    MAPPTR,CURMAP                                       0445
*   LASTENTY=LASTMAP;               /* SAVE PTR TO LAST ENTRY IN CASE
*                                      THE NEW ENTRY GOES FIRST    0446
*                                      Y02006                        */
         L     LASTENTY,LASTMAP                                    0446
*   DO WHILE MAPPTR^=0;             /* LOOP UNTIL PROPER ENTRY IS  0447
*                                      FOUND OR LAST ENTRY IS CHECKED
*                                      Y02006                        */
         B     @DE00447                                            0447
@DL00447 DS    0H                                                  0448
*     IF DUMPLADD<PRDADDR THEN      /* IS ADDRESS IN THIS MAP ENTRY
*                                      Y02006                        */
         ICM   @01,7,PRDINPTR(PARMPTR)                             0448
         CLC   DUMPLADD(4,MAPPTR),PRDADDR(@01)                     0448
         BNL   @RF00448                                            0448
*       DO;                                                        0449
*         LASTENTY=MAPPTR;          /* NO--SAVE PTR TO THIS ENTRY  0450
*                                      Y02006                        */
         LR    LASTENTY,MAPPTR                                     0450
*         MAPPTR=DUMPLINK;          /* AND SET PTR TO NEXT MAP ENTRY
*                                      Y02006                        */
         SLR   @15,@15                                             0451
         ICM   @15,7,DUMPLINK(MAPPTR)                              0451
         LR    MAPPTR,@15                                          0451
*       END;                                                       0452
*     ELSE                                                         0453
*       IF DUMPFADD>PRDADDR THEN    /* ITS BEFORE THIS ENTRY, BE SURE
*                                      ITS NOT IN THIS ENTRY Y02006  */
         B     @RC00448                                            0453
@RF00448 ICM   @01,7,PRDINPTR(PARMPTR)                             0453
         CLC   DUMPFADD(4,MAPPTR),PRDADDR(@01)                     0453
         BH    @RT00453                                            0453
*         GO TO SETDATA;            /* GO PUT DATA IN NEW MAP ENTRY
*                                      Y02006                        */
*       ELSE                                                       0455
*         DO;                       /* THIS RECORD IS A            0455
*                                      DUPLICATE--IGNORE IT Y02006   */
*           CURADDR=INITADDR;       /* REINITIALIZE ADDRESS Y02006   */
         MVC   CURADDR(4),@CB00056                                 0456
*           GO TO MAPRET;           /* RETURN IGNORING DUPLICATE   0457
*                                      Y02006                        */
         B     MAPRET                                              0457
*         END;                                                     0458
*   END;                                                           0459
@RC00448 DS    0H                                                  0459
@DE00447 LTR   MAPPTR,MAPPTR                                       0459
         BNZ   @DL00447                                            0459
*   GO TO SETDATA;                  /* NOW GO SET DATA INTO NEW ENTRY
*                                      Y02006                        */
         B     SETDATA                                             0460
*/********************************************************************/
*/*                                                                  */
*/* THE DATA RECORD OR CPU STATUS RECORD IS IN PROPER SEQUENCE.      */
*/* THIS SECTION CHECKS TO VERIFY THAT A VOLUME SWITCH HAS NOT       */
*/* OCCURED.  IF IT HAS, A NEW ENTRY IS INSERTED AT THE POINT OF THE */
*/* CURRENT MAP.                                                     */
*/*                                                                  */
*/********************************************************************/
*                                                                  0461
*CHKVOLS:                                                          0461
*   IF CURVOL=LASTVOL THEN          /* HAS A VOLUME SWITCH OCCURRED
*                                      Y02006                        */
CHKVOLS  SLR   @05,@05                                             0461
         IC    @05,CURVOL                                          0461
         CR    LASTVOL,@05                                         0461
         BE    @RT00461                                            0461
*     GO TO SAVELAST;               /* NO--THEN GO UPDATE LAST     0462
*                                      ADDRESS IN CURRENT ENTRY Y020
*                                      06                            */
*   RESPECIFY                                                      0463
*    (REG0,                                                        0463
*     REG4) RESTRICTED;             /* RESTRICT REGISTERS Y02006     */
*   REG4=ADDR(NEWENTRY);            /* VOLUME SWITCHED SO NEED NEW 0464
*                                      MAP ENTRY Y02006              */
         LA    REG4,NEWENTRY                                       0464
*   REG0=DUMPFRMS;                  /* SET SIZE OF ENTRY Y02006      */
         LA    REG0,16                                             0465
*   GENERATE(GETMAIN EU,LV=(0),A=(R4));/* GET STORAGE FOR NEW ENTRY
*                                      Y02006                        */
         GETMAIN EU,LV=(0),A=(R4)
*   RESPECIFY                                                      0467
*    (REG0,                                                        0467
*     REG4) UNRESTRICTED;           /* UNRESTRICT REGISTERS Y02006   */
*   NEWENTRY->DUMPLINK=DUMPLINK;    /* SET LINK FIELD OF NEW ENTRY TO
*                                      LINK OF LAST ENTRY Y02006     */
         L     @02,NEWENTRY                                        0468
         MVC   DUMPLINK(3,@02),DUMPLINK(MAPPTR)                    0468
*   DUMPLINK=NEWENTRY;              /* SET LINK FIELD OF LAST ENTRY
*                                      TO NEW ENTRY Y02006           */
         STCM  @02,7,DUMPLINK(MAPPTR)                              0469
*   GO TO SETDATA1;                 /* PUT DATA IN NEW ENTRY  YM00656*/
         B     SETDATA1                                            0470
*/********************************************************************/
*/*                                                                  */
*/* THIS SECTION INSERTS DATA INTO THE NEW DUMP MAP ENTRIES.         */
*/*                                                                  */
*/********************************************************************/
*                                                                  0471
*SETDATA:                                                          0471
*   RESPECIFY                                                      0471
*    (REG0,                                                        0471
*     REG4) RESTRICTED;             /* RESTRICT REGISTERS     YM00656*/
SETDATA  DS    0H                                                  0472
*   REG4=ADDR(NEWENTRY);            /* SET RETURN FOR ADDRESS OF NEW
*                                      DUMP MAP BLOCK         YM00656*/
         LA    REG4,NEWENTRY                                       0472
*   REG0=DUMPFRMS;                  /* SET SIZE FOR A NEW BLOCK    0473
*                                                             YM00656*/
         LA    REG0,16                                             0473
*   GEN(GETMAIN EU,LV=(0),A=(R4));  /* ISSUE GETMAIN FOR A NEW DUMP
*                                      MAP BLOCK              YM00656*/
         GETMAIN EU,LV=(0),A=(R4)
*   RESPECIFY                                                      0475
*    (REG0,                                                        0475
*     REG4) UNRESTRICTED;           /* UNRESTRICT REGISTERS   YM00656*/
*   LASTENTY->DUMPLINK=NEWENTRY;    /* INSERT NEW MAP ENTRY AT END OF
*                                      CHAIN                  YM00656*/
         L     @15,NEWENTRY                                        0476
         STCM  @15,7,DUMPLINK(LASTENTY)                            0476
*   NEWENTRY->DUMPLINK=MAPPTR;      /* SET LINK FIELD TO NULL YM00656*/
         STCM  MAPPTR,7,DUMPLINK(@15)                              0477
*   IF LASTENTY=LASTMAP THEN        /* IS THIS ALSO THE FIRST (ONLY)
*                                      ENTRY ON CHAIN         YM00656*/
         C     LASTENTY,LASTMAP                                    0478
         BNE   @RF00478                                            0478
*     CURMAP=NEWENTRY;              /* YES--THEN ALSO UPDATE CURRENT
*                                      PTR ENTRY              YM00656*/
         LR    CURMAP,@15                                          0479
*SETDATA1:                                                         0480
*   MAPPTR=NEWENTRY;                /* SET POINTER TO NEW ENTRY    0480
*                                      Y02006                        */
@RF00478 DS    0H                                                  0480
SETDATA1 L     MAPPTR,NEWENTRY                                     0480
*   DUMPVOLN=CURVOL;                /* SET VOLUME NUMBER INTO ENTRY
*                                      Y02006                        */
         MVC   DUMPVOLN(1,MAPPTR),CURVOL                           0481
*   IF TREADIN=SWITCHON THEN        /* SET DUMPDEV TO TREADIN Y02006 */
         TM    TREADIN(COMPTR),B'00010000'                         0482
         BNO   @RF00482                                            0482
*     DUMPDEV=SWITCHON;                                            0483
         OI    DUMPDEV(MAPPTR),B'10000000'                         0483
*   ELSE                                                           0484
*     DUMPDEV=SWTCHOFF;                                            0484
         B     @RC00482                                            0484
@RF00482 NI    DUMPDEV(MAPPTR),B'01111111'                         0484
*   DUMPFADD=PRDADDR;               /* SET BEGINNING ADDRESS INTO  0485
*                                      ENTRY Y02006                  */
@RC00482 ICM   @02,7,PRDINPTR(PARMPTR)                             0485
         MVC   DUMPFADD(4,MAPPTR),PRDADDR(@02)                     0485
*   DUMPTTR=TTRNO;                  /* AND SET TTR (OR BLOCK NUMBER)
*                                      INTO ENTRY Y02006             */
         ST    TTRNO,DUMPTTR(,MAPPTR)                              0486
*SAVELAST:                                                         0487
*   CURADDR=PRDADDR;                /* SAVE CURRENT ADDRESS Y02006   */
SAVELAST SLR   @09,@09                                             0487
         ICM   @09,7,PRDINPTR(PARMPTR)                             0487
         MVC   CURADDR(4),PRDADDR(@09)                             0487
*   IF PRDHDRID^=PRDHDR THEN        /* IS THIS A CPU STATUS RECORD 0488
*                                      Y02006                        */
         CLI   PRDHDRID(@09),X'FF'                                 0488
         BE    @RF00488                                            0488
*     CURASID=PRDASID;              /* NO--THEN SAVE ASID Y02006     */
         MVC   CURASID(2),PRDASID(@09)                             0489
*   DUMPLADD=CURADDR;               /* SET ENDING ADDRESS INTO ENTRY
*                                      Y02006                        */
@RF00488 L     @09,CURADDR                                         0490
         ST    @09,DUMPLADD(,MAPPTR)                               0490
*   IF PRDHDRID^=PRDHDR THEN        /* AGAIN IS THIS A CPU STATUS  0491
*                                      RECORD Y02006                 */
         ICM   @02,7,PRDINPTR(PARMPTR)                             0491
         CLI   PRDHDRID(@02),X'FF'                                 0491
         BE    @RF00491                                            0491
*     IF CURASID=0 THEN             /* NO--IS IT A REAL DUMP RECORD
*                                      Y02006                        */
         ICM   @02,3,CURASID                                       0492
         BNZ   @RF00492                                            0492
*       BUFFREAL=CURADDR;           /* YES-- UPDATE REAL ADDRESS IN
*                                      BUFFER AMP ENTRY Y020006      */
         ST    @09,BUFFREAL(,PARMPTR)                              0493
*     ELSE                                                         0494
*       DO;                                                        0494
         B     @RC00492                                            0494
@RF00492 DS    0H                                                  0495
*         BUFFVIRT=CURADDR;         /* NO--UPDATE VIRTUAL ADDRESS IN
*                                      BUFFER MAP ENTRY Y02006       */
         MVC   BUFFVIRT(4,PARMPTR),CURADDR                         0495
*         IF CURASID=ALLFOX2 THEN   /* IS ASID FOR COMMON DATA Y02006*/
         CLC   CURASID(2),@CB00058                                 0496
         BNE   @RF00496                                            0496
*           DO;                                                    0497
*             BUFFASID=0;           /* YES--SET ASID TO ZERO FOR   0498
*                                      AMDPRRDC Y02006               */
         SLR   @09,@09                                             0498
         STH   @09,BUFFASID(,PARMPTR)                              0498
*             BUFFCOM=SWITCHON;     /* SET FLAG TO INDICATE DATA FROM
*                                      COMMON Y02006                 */
         OI    BUFFCOM(PARMPTR),B'01000000'                        0499
*           END;                                                   0500
*         ELSE                                                     0501
*           BUFFASID=CURASID;       /* NO--PUT ASID INTO BUFFER AS IS
*                                      Y02006                        */
         B     @RC00496                                            0501
@RF00496 MVC   BUFFASID(2,PARMPTR),CURASID                         0501
*       END;                                                       0502
*   ELSE                                                           0503
*     BUFFCPU=PRDCPUAD;             /* ITS A CPU STATUS RECORD SO  0503
*                                      UPDATE CPU ADDRES S IN BUFFER
*                                      MAP ENTRY Y02006              */
         B     @RC00491                                            0503
@RF00491 ICM   @09,7,PRDINPTR(PARMPTR)                             0503
         MVC   BUFFCPU(2,PARMPTR),PRDCPUAD(@09)                    0503
*MAPRET:                                                           0504
*   RESPECIFY                                                      0504
*     REG14 RESTRICTED;             /* RESTRICT RETURN REG Y02006    */
@RC00491 DS    0H                                                  0504
MAPRET   DS    0H                                                  0505
*   REG14=TEMPSAVE;                 /* RESTORE RETURN REG Y02006     */
         LR    REG14,TEMPSAVE                                      0505
*   RESPECIFY                                                      0506
*     REG14 UNRESTRICTED;           /* UNRESTRICT RETURN REG Y02006  */
*   RETURN;                         /* RETURN WITH MAP BUILT Y02006  */
@EL00005 DS    0H                                                  0507
@EF00005 DS    0H                                                  0507
@ER00005 BR    @14                                                 0507
*/********************************************************************/
*/*                                                                  */
*/* THIS SECTION OBTAINS NEW MAP ENTRIES FOR CPU STATUS RECORDS      */
*/* IF THE RECORDS ARE NOT IN CPU ADDRESS SEQUENCE.                  */
*/*                                                                  */
*/********************************************************************/
*                                                                  0508
*CPUREC:                                                           0508
*   IF PRDADDR>MAXCPUAD THEN        /* IS CPU ADDR VALID Y02006      */
CPUREC   ICM   @05,7,PRDINPTR(PARMPTR)                             0508
         CLC   PRDADDR(4,@05),@CB00060                             0508
         BNH   @RF00508                                            0508
*     DO;                                                          0509
*       CURADDR=INITADDR;           /* REINITIALIZE CURRENT ADDRESS
*                                      Y02006                        */
         MVC   CURADDR(4),@CB00056                                 0510
*       BADREC=SWITCHON;            /* INDICATE RECORD NOT PLACED  0511
*                                      INTO MAP Y02006               */
         OI    BADREC,B'00000001'                                  0511
*       GO TO MAPRET;               /* RETURN TO CALLER Y02006       */
         B     MAPRET                                              0512
*     END;                                                         0513
*   IF PRDADDR=CURADDR+1 THEN       /* IS CPU ADDRESS IN SEQUENCE  0514
*                                      Y02006                        */
@RF00508 ICM   @05,7,PRDINPTR(PARMPTR)                             0514
         LA    @02,1                                               0514
         AL    @02,CURADDR                                         0514
         CL    @02,PRDADDR(,@05)                                   0514
         BE    @RT00514                                            0514
*     GO TO CHKVOLS;                /* YES--GO CHECK FOR VOLUME    0515
*                                      SWITCH Y02006                 */
*   RESPECIFY                                                      0516
*    (REG0,                                                        0516
*     REG4) RESTRICTED;             /* RESTRICT REGISTERS Y02006     */
*   REG4=ADDR(NEWENTRY);            /* NOT IN SEQUENCE, GET STORAGE
*                                      FOR NEW ENTRY Y02 0006        */
         LA    REG4,NEWENTRY                                       0517
*   REG0=DUMPFRMS;                  /* SET SIZE OF NEW ENTRY Y02006  */
         LA    REG0,16                                             0518
*   GENERATE(GETMAIN EU,LV=(0),A=(R4));/* GET STORAGE FOR NEW ENTRY
*                                      Y02006                        */
         GETMAIN EU,LV=(0),A=(R4)
*   RESPECIFY                                                      0520
*    (REG0,                                                        0520
*     REG4) UNRESTRICTED;           /* UNRESTRICT REGISTERS Y02006   */
*   IF CPUMAP=0 THEN                /* IS THIS FIRST CPU STATUS    0521
*                                      RECORD Y02006                 */
         ICM   @10,15,CPUMAP(COMPTR)                               0521
         BNZ   @RF00521                                            0521
*     DO;                                                          0522
*       IF IOERR=SWITCHON THEN      /* WAS LAST RECORD IN ERROR    0523
*                                      Y02006                        */
         TM    IOERR(COMPTR),B'10000000'                           0523
         BNO   @RF00523                                            0523
*         IPLCPU=256;               /* INDICATE IPLED CPU STATUS   0524
*                                      UNAVAINLABLE Y02006           */
         MVC   IPLCPU(2,COMPTR),@CH00392                           0524
*       ELSE                                                       0525
*         IPLCPU=PRDCPUAD;          /* SAVE IPLED CPU ADDRESS Y02006 */
         B     @RC00523                                            0525
@RF00523 ICM   @10,7,PRDINPTR(PARMPTR)                             0525
         MVC   IPLCPU(2,COMPTR),PRDCPUAD(@10)                      0525
*     END;                                                         0526
@RC00523 DS    0H                                                  0527
*   CURMAP=CPUMAP;                  /* SET PTR TO CPU STATUS MAPS  0527
*                                      Y02006                        */
@RF00521 L     CURMAP,CPUMAP(,COMPTR)                              0527
*   LASTMAP=ADDR(CPUMAP);           /* ALSO SET PTR TO ADDR OF     0528
*                                      CURRENT MAP Y02006            */
         LA    @07,CPUMAP(,COMPTR)                                 0528
         ST    @07,LASTMAP                                         0528
*   GO TO SCANMAP;                  /* NOW GO SCAN MAP Y02006        */
         B     SCANMAP                                             0529
*   END MAPBUILD;                                                  0530
*                                                                  0530
*/********************************************************************/
*/*                                                                  */
*/* THE FOLLOWING ROUTINE SEARCHES THE ASID LISTS FOR THE ASID       */
*/* IN REQASID OR AN ASID OF ZERO.  ZERO INDICATES NO MORE ENTRIES   */
*/* OR TABLES ARE USED.  WHEN FOUND 'INDEX' IS SET TO THAT ASID.     */
*/* AN INDEX RETURNED OF ZERO INDICATES ALL ASID LISTS ARE FULL      */
*/* AND THE REQUESTED ASID COULD NOT BE FOUND.                       */
*/*                                                                  */
*/********************************************************************/
*                                                                  0531
*ASIDSRCH:                                                         0531
*   PROC OPTIONS(NOSAVEAREA,NOSAVE);                               0531
ASIDSRCH DS    0H                                                  0532
*LOOP:                                                             0532
*   DO INDEX=1 TO ASIDCNT;          /* LOOP TO SEARCH ALL ASIDLISTS
*                                      Y02006                        */
LOOP     LA    INDEX,1                                             0532
@DL00532 DS    0H                                                  0533
*     IF ASDXASID(INDEX)=PRDASIDASDXASID(INDEX)=0 THEN/* IS THIS THE
*                                      REQUESTED ASID OR 0 Y02006    */
         L     @10,INDXADDR                                        0533
         LR    @07,INDEX                                           0533
         ALR   @07,@07                                             0533
         ICM   @01,7,PRDINPTR(PARMPTR)                             0533
         ST    @07,@TF00001                                        0533
         ALR   @07,@10                                             0533
         CLC   ASDXASID-2(2,@07),PRDASID(@01)                      0533
         BE    @RT00533                                            0533
         AL    @10,@TF00001                                        0533
         SLR   @07,@07                                             0533
         ICM   @07,3,ASDXASID-2(@10)                               0533
         LTR   @07,@07                                             0533
         BZ    @RT00533                                            0533
*       RETURN;                     /* YES--THEN RETURN Y02006       */
*   END;                            /* NO--KEEP LOOPING Y02006       */
         AH    INDEX,@CH00043                                      0535
         CH    INDEX,@CH00064                                      0535
         BNH   @DL00532                                            0535
*   IF ASDXLNK^=0 THEN              /* IS THERE ANOTHER TABLE Y02006 */
         L     @10,INDXADDR                                        0536
         L     @10,ASDXLNK(,@10)                                   0536
         LTR   @10,@10                                             0536
         BZ    @RF00536                                            0536
*     DO;                                                          0537
*       INDXADDR=ASDXLNK;           /* YES--SET PTR TO IT Y02006     */
         ST    @10,INDXADDR                                        0538
*       GO TO LOOP;                 /* LOOP THROUGH THIS TABLE Y02006*/
         B     LOOP                                                0539
*     END;                                                         0540
*   INDEX=0;                        /* INDICATE ASID NOT FOUND AND 0541
*                                      ALL TABLES FULL Y02006        */
@RF00536 SLR   INDEX,INDEX                                         0541
*   END ASIDSRCH;                   /* RETURN TO CALLER Y02006       */
@EL00006 DS    0H                                                  0542
@EF00006 DS    0H                                                  0542
@ER00006 BR    @14                                                 0542
*SYSUER:                                                           0543
*   SYNADOSW=SWITCHON;              /* SIGNAL SYSUTX ERROR Y02006    */
SYSUER   OI    SYNADOSW,B'00100000'                                0543
*   GEN(BR R14);                                                   0544
         BR R14
*                                                                  0545
*/********************************************************************/
*/*                                                                  */
*/* DCB ABEND ROUTINE TO TRAP AND IGNORE B37, D37, AND E37           */
*/* ABENDS WHEN WRITTING TO THE SYSUT1 WORKFILE.                     */
*/*                                                                  */
*/********************************************************************/
*                                                                  0545
*DCBABEND:                                                         0545
*   GENERATE;                                                      0545
DCBABEND DS    0H                                                  0545
*                                                         /* OZ09675
         STM   R14,R13,ERRSAV1      STORE REGS FIRST         OZ09675
         LA    R13,ERRSAV2          PROVIDE SA FOR PRT ROUT  OZ09675 */
*   RESPECIFY                                                      0546
*     REG1 RESTRICTED;              /* RESTRICT PTR TO ABEND PARM  0546
*                                      LIST Y02006                   */
*   OPTION=BYTEOFF;                 /* RESET PARM LIST OPTION BITS 0547
*                                      Y02006                        */
         MVI   OPTION(REG1),X'00'                                  0547
*   IF ABEND='B370'X               /* OZ09675                       */
*       ABEND='D370'X              /* OZ09675                       */
*       ABEND='E370'X THEN          /* OZ09675 IS THIS AN ABEND WE 0548
*                                      SHOULD RECOVER FROM Y02006    */
         CLC   ABEND(2,REG1),@CB00640                              0548
         BE    @RT00548                                            0548
         CLC   ABEND(2,REG1),@CB00641                              0548
         BE    @RT00548                                            0548
         CLC   ABEND(2,REG1),@CB00642                              0548
         BNE   @RF00548                                            0548
@RT00548 DS    0H                                                  0549
*     DO;                           /* YES - RECOVER OZ09675 Y02006  */
*       X37SW=SWITCHON;             /* YES--INDICATE IN RECOVERY   0550
*                                      Y02006                        */
         OI    X37SW,B'00000010'                                   0550
*       LASTIVOL=0;                 /* CLEAR LAST INPUT VOLUME NUMBER
*                                      SO A NEW MAP ENTRY WILL BE  0551
*                                      CREATED Y02006                */
         SLR   @02,@02                                             0551
         STH   @02,LASTIVOL                                        0551
*       TREADIN=SWITCHON;           /* INDICATE INPUT IS NOW FROM  0552
*                                      TAPE Y02006                   */
         OI    TREADIN(COMPTR),B'00010000'                         0552
*       OKIGNORE=SWITCHON;          /* SET IGNORE BIT IN PARM LIST 0553
*                                      Y02006                        */
         OI    OKIGNORE(REG1),B'00000100'                          0553
*       GEN REFS(APRTMSG);                                         0554
*                                   /* WRITE MESSAGE Y02006          */
    BRPRTMSG AMD280I,L'AMD280I   ' <- END QUOTE FOR PLS Y02006
*     END;                          /* YES - RECOVER OZ09675         */
*   GENERATE;                                                      0556
@RF00548 DS    0H                                                  0556
*                                                         /* OZ09675
         LM    R14,R13,ERRSAV1      RESTORE REGS             OZ09675
         BR    R14                  RETURN TO CHECK          OZ09675
ERRSAV1  DS    16F                  SAVE AREA FOR SYNAD      OZ09675
ERRSAV2  DS    20F                  SAVE AREA FOR PRT ROUT   OZ09675
*   RESPECIFY                                                      0557
*     REG1 UNRESTRICTED;            /* RELEASE PTR TO ABEND PARM LIST
*                                      Y02006                        */
*/********************************************************************/
*/*                                                                  */
*/*                           WORK FILE DCB                          */
*/*                                                                  */
*/********************************************************************/
*                                                                  0558
*   GEN;                                                           0558
SYSUDCB  DCB   DSORG=PS,                                               *
               MACRF=WP,                                               *
               RECFM=F,                                                *
               BLKSIZE=4104,                                     Y02006*
               LRECL=4104,                                       Y02006*
               SYNAD=SYSUER
*   END WRITE;                                                     0559
         B     @EL00004                                            0559
*   END AMDPRLOD                                                   0560
*                                                                  0560
*/* THE FOLLOWING INCLUDE STATEMENTS WERE FOUND IN THIS PROGRAM.     */
*/*%INCLUDE SYSLIB  (AMDDATA )                                       */
*/*%INCLUDE SYSLIB  (COMMON  )                                       */
*                                                                  0560
*       ;                                                          0560
@DATA    DS    0H
@CH00043 DC    H'1'
@CH00143 DC    H'2'
@CH00210 DC    H'5'
@CH00064 DC    H'18'
@CH00157 DC    H'133'
@CH00392 DC    H'256'
@CH00644 DC    H'3849'
@CH00039 DC    H'4104'
@CH00643 DC    H'4124'
@CH00058 DC    XL2'FFFF'
@SM00659 MVC   OUTBUF(0,@10),PRDINPUT(@07)
         DS    0F
@SA00001 DS    18F
@SA00003 DS    13F
@SA00004 DS    13F
@TF00001 DS    F
         DS    0F
@CF00664 DC    F'4095'
@CF00041 DC    F'4096'
@CH00041 EQU   @CF00041+2
         DS    0D
INDXADDR DS    A
HEADTTR  DC    XL4'00000100'
FIRSTTR  DC    XL4'00000001'
STOPSAVE DS    A
LASTMAP  DS    A
NEWENTRY DS    A
LASTIVOL DS    H
CURIVOL  DC    H'0'
POSTIPL  DS    H
CURVOL   DS    AL1
@CC00062 DC    C'AMDSADMP'
@CC00596 DC    C'PREFORM '
@CB00568 DC    X'00000000000000000000'
@CB00056 DC    X'0000FFFF'
@CB00060 DC    X'0000003F'
@CB00054 DC    X'8000'
@CB00058 DC    X'FFFF'
@CB00640 DC    X'B370'
@CB00641 DC    X'D370'
@CB00642 DC    X'E370'
SWITCHES DS    BL1
         ORG   SWITCHES
LOADMODE DS    BL1
SCANSW   EQU   SWITCHES+0
SYNADOSW EQU   SWITCHES+0
SYNADISW EQU   SWITCHES+0
HDRSW    EQU   SWITCHES+0
SYS1SW   EQU   SWITCHES+0
X37SW    EQU   SWITCHES+0
BADREC   EQU   SWITCHES+0
         ORG   SWITCHES+1
SYSDUMP  DC    CL10'SYS1.DUMP0'
SYSUT    DC    CL8'SYSUT'
JFCBBUF  DS    CL176
         DS    CL2
EXITLIST DS    CL4
         ORG   EXITLIST
@NM00001 DC    X'87'
@NM00002 DC    AL3(JFCBBUF)
         ORG   EXITLIST+4
EXITLST2 DS    CL4
         ORG   EXITLST2
@NM00003 DC    X'91'
@NM00004 DC    AL3(DCBABEND)
         ORG   EXITLST2+4
AMD174I  DC    CL22'AMD174I SYSUT1 LOADED'
         DS    CL2
CURADDR  DS    CL4
CURASID  DS    CL2
         DS    CL2
SVCTTR   DS    CL4
AMD280I  DC    CL57'AMD280I INSUFFICIENT SYSUT1 SPACE -- PROCESSING CONC
               TINUES'
AMD291I  DC    CL37'AMD291I PERMaNENT I/O ERROR ON SYSUT1'
         DS    CL2
PATCH    DC    40F'0'
AMDPRLOD CSECT
*
DTAE     EQU   32                  DATA EBCDIC BIT
DTAC     EQU   16                  DATA IN CORE BIT
DTAP     EQU   8                   DATA PTR BIT
DTA      EQU   4                   DATA INCLUDED BIT
LBLP     EQU   2                   LABEL PTR BIT
LBL      EQU   1                   LABEL INCLUDED BIT
AMDPRLOD CSECT
********************************************************************/
*                                                                  */
*                          INPUT DCB                               */
*                                                                  */
********************************************************************/
DCBLST   RDJFCB  (INDCB),MF=L
INDCB    DCB   MACRF=(RP,W),                                           *
               DSORG=PS,                                               *
               BLKSIZE=4104,                                    Y02006 *
               LRECL=4104,                                      Y02006 *
               RECFM=U,                                                *
               EXLST=EXITLIST,                                  Y02006 *
               SYNAD=TAPEER,                                           *
               EODAD=RDEOF
AMDPRLOD CSECT
@00      EQU   00                      EQUATES FOR REGISTERS 0-15
@01      EQU   01
@02      EQU   02
@03      EQU   03
@04      EQU   04
@05      EQU   05
@06      EQU   06
@07      EQU   07
@08      EQU   08
@09      EQU   09
@10      EQU   10
@11      EQU   11
@12      EQU   12
@13      EQU   13
@14      EQU   14
@15      EQU   15
PARMPTR  EQU   @06
MAPPTR   EQU   @07
SVCBUFAD EQU   @09
INDEX    EQU   @02
LASTENTY EQU   @02
CURMAP   EQU   @10
LASTVOL  EQU   @04
N1       EQU   @08
I        EQU   @04
TEMPSAVE EQU   @08
IOERRCNT EQU   @04
INTTR    EQU   @08
TTRNO    EQU   @09
REG0     EQU   @00
REG1     EQU   @01
REG2     EQU   @02
REG3     EQU   @03
REG4     EQU   @04
REG14    EQU   @14
COMPTR   EQU   @12
BASE1    EQU   @11
BASE2    EQU   @10
BASE3    EQU   @09
BUFREG   EQU   @06
CNTREG   EQU   @03
COMBASE  EQU   @12
LINEREG  EQU   @08
PREG     EQU   @01
R0       EQU   @00
R1       EQU   @01
R10      EQU   @10
R11      EQU   @11
R12      EQU   @12
R13      EQU   @13
R14      EQU   @14
R15      EQU   @15
R2       EQU   @02
R3       EQU   @03
R4       EQU   @04
R5       EQU   @05
R6       EQU   @06
R7       EQU   @07
R8       EQU   @08
R9       EQU   @09
STOPBASE EQU   @05
JFCBDSNM EQU   0
JFCBTSDM EQU   0
JFCBFLSQ EQU   0
JFCBMASK EQU   0
IOBCSWCT EQU   0
SVCBUF   EQU   0
OUTBUF   EQU   0
DUMPFORM EQU   0
@NM00005 EQU   DUMPFORM
DUMPVOLN EQU   @NM00005
DUMPDEV  EQU   DUMPVOLN
DUMPLINK EQU   @NM00005+1
DUMPFADD EQU   DUMPFORM+4
DUMPLADD EQU   DUMPFORM+8
DUMPTTR  EQU   DUMPFORM+12
ASIDLIST EQU   0
ASDXLNK  EQU   ASIDLIST
ASDXASID EQU   ASIDLIST+4
ASDXMAP  EQU   ASIDLIST+40
BUFFMAP  EQU   0
BUFFLINK EQU   BUFFMAP
@NM00007 EQU   BUFFMAP+4
BUFFFLAG EQU   @NM00007
BUFFCOM  EQU   BUFFFLAG
BUFFPTR  EQU   @NM00007+1
BUFFREAL EQU   BUFFMAP+8
BUFFVIRT EQU   BUFFMAP+12
BUFFASID EQU   BUFFMAP+16
BUFFCPU  EQU   BUFFMAP+18
ABENDLST EQU   0
ABEND    EQU   ABENDLST
OPTION   EQU   ABENDLST+3
OKIGNORE EQU   OPTION
PRDINPUT EQU   0
PRDHDRID EQU   PRDINPUT
PRDRECID EQU   PRDINPUT+1
PRDASID  EQU   PRDINPUT+2
PRDMODNM EQU   PRDINPUT+4
PRDTODVL EQU   PRDINPUT+12
PRDTITLE EQU   PRDINPUT+20
PRDREGS  EQU   PRDINPUT+120
PRDFPR   EQU   PRDREGS
PRDCVT   EQU   PRDINPUT+288
PRDERRID EQU   PRDINPUT+324
COMMON   EQU   0
CURBUF   EQU   COMMON+48
CVTADDR  EQU   COMMON+56
INDD     EQU   COMMON+68
FILESEQ  EQU   COMMON+76
SWA      EQU   COMMON+122
SETCVTSW EQU   SWA
SWB      EQU   COMMON+123
IOERR    EQU   SWB
ENDSW    EQU   SWB
QSYSUT2  EQU   SWB
SWC      EQU   COMMON+124
POSITSW  EQU   SWC
TREADIN  EQU   SWC
SWD      EQU   COMMON+125
SWE      EQU   COMMON+126
BUILDMAP EQU   SWE
SWF      EQU   COMMON+127
QSADMP   EQU   SWF
DMPIC    EQU   SWF
QUT1LOD  EQU   SWF
BUFSW    EQU   COMMON+128
PREFM    EQU   BUFSW
PRSW     EQU   COMMON+129
BLANKS   EQU   COMMON+214
TITLEMOD EQU   COMMON+347
TITLEDTE EQU   COMMON+364
TITLETME EQU   COMMON+379
TABLE    EQU   COMMON+659
HEXTABL  EQU   TABLE+63
AWRITE   EQU   COMMON+1500
APRTMSG  EQU   COMMON+1504
STOPEXIT EQU   COMMON+1528
AEREXIT  EQU   COMMON+1536
DCBADDRS EQU   COMMON+1608
AINDCB   EQU   DCBADDRS+12
@NM00064 EQU   DCBADDRS+16
@NM00065 EQU   @NM00064
ASYSUDCB EQU   @NM00064+1
REALMAP  EQU   COMMON+1644
QASID    EQU   COMMON+1664
IPLCPU   EQU   COMMON+1666
SACSWCAW EQU   COMMON+1684
HDRREGS  EQU   COMMON+1696
HDRTITLE EQU   COMMON+1864
ASIDNDX  EQU   COMMON+1968
CPUMAP   EQU   COMMON+1972
BUFERMAP EQU   COMMON+1980
I3800SW  EQU   COMMON+2076
TITLEKEY EQU   COMMON+2077
Z9ERRID  EQU   COMMON+2116
PRDINPTR EQU   BUFFPTR
OFLWRDCB EQU   DCBOFLGS
PRDFLC   EQU   PRDFPR
PRDCSW   EQU   PRDFLC
PRDCAW   EQU   PRDFLC+8
@NM00015 EQU   PRDHDRID
PRDADDR  EQU   @NM00015+4
@NM00017 EQU   PRDHDRID
PRDFLAGS EQU   @NM00017+2
PRDCPUAD EQU   @NM00017+6
         AGO   .@UNREFD                START UNREFERENCED COMPONENTS
@NM00023 EQU   @NM00017+8
@NM00022 EQU   @NM00017+4
@NM00021 EQU   @NM00017+3
@NM00020 EQU   PRDFLAGS
PRDGPRVL EQU   PRDFLAGS
PRDSSINV EQU   PRDFLAGS
PRDUNIPR EQU   PRDFLAGS
@NM00019 EQU   @NM00017+1
@NM00018 EQU   @NM00017
PRDDATA  EQU   @NM00015+8
@NM00016 EQU   @NM00015+2
PRDKEY2  EQU   @NM00015+1
PRDKEY1  EQU   @NM00015
@NM00014 EQU   PRDFLC+12
Z9SUFLG  EQU   COMMON+2115
Z9SUBITS EQU   COMMON+2100
Z9SVCBUF EQU   COMMON+2096
TITLESTK EQU   TITLEKEY+12
@NM00075 EQU   TITLEKEY
I3800204 EQU   I3800SW
I380080  EQU   I3800SW
I3800ULN EQU   I3800SW
I3800KEY EQU   I3800SW
@NM00074 EQU   I3800SW
@NM00073 EQU   I3800SW
@NM00072 EQU   I3800SW
@NM00071 EQU   I3800SW
CSADDR   EQU   COMMON+2072
@NM00070 EQU   COMMON+2070
TOPICHDR EQU   COMMON+2060
DFLTCSA  EQU   COMMON+2056
LPAMAX   EQU   COMMON+2052
DNUCTOP  EQU   COMMON+2048
XLMAX    EQU   COMMON+2044
DQEMAX   EQU   COMMON+2042
ASCBMAX  EQU   COMMON+2040
TCBMAX   EQU   COMMON+2038
SRBMAX   EQU   COMMON+2036
DDMAX    EQU   COMMON+2034
DEBMAX   EQU   COMMON+2032
JPQMAX   EQU   COMMON+2030
LLEMAX   EQU   COMMON+2028
PQEMAX   EQU   COMMON+2026
RBMAX    EQU   COMMON+2024
@NM00069 EQU   COMMON+2023
EXITFLAG EQU   COMMON+2022
AUSRASID EQU   COMMON+2020
AUSRTCBA EQU   COMMON+2016
AUSRDEL  EQU   COMMON+2012
AUSREXIT EQU   COMMON+2008
AUSRINIT EQU   COMMON+2004
ASRBFMT  EQU   COMMON+2000
AASCBFMT EQU   COMMON+1996
BRRDADJ  EQU   COMMON+1992
BRRDINIT EQU   COMMON+1988
BRRDDATA EQU   COMMON+1984
ASCBMAP  EQU   COMMON+1976
@NM00068 EQU   COMMON+1964
ASVTADDR EQU   COMMON+1680
PREFXRGV EQU   COMMON+1676
PREFXRGR EQU   COMMON+1672
CURASCB  EQU   COMMON+1668
QAPFT    EQU   COMMON+1660
@NM00067 EQU   COMMON+1656
REALMAX  EQU   COMMON+1652
SEGTABOR EQU   COMMON+1648
@NM00066 EQU   COMMON+1641
EDITER   EQU   COMMON+1640
AROOT    EQU   COMMON+1636
AEDITCB  EQU   COMMON+1632
TRCCOUNT EQU   COMMON+1628
ENDLIST  EQU   @NM00065
ARDRDCB  EQU   DCBADDRS+8
APTRDCB  EQU   DCBADDRS+4
AOUTDCB  EQU   DCBADDRS
ATCBSMRY EQU   COMMON+1604
ATCBSMFR EQU   COMMON+1600
ONGOPTR  EQU   COMMON+1596
AEND     EQU   COMMON+1592
AERRMSGA EQU   COMMON+1584
BUFREINT EQU   COMMON+1580
BUFSUM   EQU   COMMON+1576
APRTSTG  EQU   COMMON+1572
AFORMAT  EQU   COMMON+1568
ASTPROUT EQU   COMMON+1564
APCBENQ  EQU   COMMON+1560
ATCBRTRV EQU   COMMON+1556
ATCBREMV EQU   COMMON+1552
ATCBSAVE EQU   COMMON+1548
QATMERTN EQU   COMMON+1544
ALOADER  EQU   COMMON+1540
SYNMSGA  EQU   COMMON+1532
ARGNBND  EQU   COMMON+1524
AWRDCNVT EQU   COMMON+1520
AADRCNVT EQU   COMMON+1516
AFMTLINE EQU   COMMON+1512
ASYNTAX  EQU   COMMON+1508
NONBLNK  EQU   COMMON+1244
BLNK     EQU   COMMON+988
@NM00063 EQU   COMMON+972
@NM00062 EQU   COMMON+915
EBCTABL  EQU   HEXTABL+10
@NM00061 EQU   HEXTABL
@NM00060 EQU   TABLE
CAPTABL  EQU   COMMON+403
TITLEPGE EQU   COMMON+394
@NM00059 EQU   COMMON+392
@NM00058 EQU   COMMON+377
@NM00057 EQU   COMMON+362
TITLEMSG EQU   COMMON+283
MSG2     EQU   COMMON+257
MSG1     EQU   COMMON+231
STOP     EQU   COMMON+227
TITLE    EQU   COMMON+222
WTORMSG  EQU   COMMON+133
@NM00056 EQU   COMMON+130
@NM00055 EQU   PRSW
@NM00054 EQU   PRSW
PRNTREAL EQU   PRSW
PRNTRL   EQU   PRSW
TTLSW    EQU   PRSW
@NM00053 EQU   PRSW
QSEGTBSW EQU   PRSW
@NM00052 EQU   PRSW
@NM00051 EQU   BUFSW
@NM00050 EQU   BUFSW
@NM00049 EQU   BUFSW
@NM00048 EQU   BUFSW
@NM00047 EQU   BUFSW
@NM00046 EQU   BUFSW
@NM00045 EQU   BUFSW
@NM00044 EQU   SWF
@NM00043 EQU   SWF
PAGEOK   EQU   SWF
NUCTFRMC EQU   SWF
QPRDINIT EQU   SWF
@NM00042 EQU   SWE
@NM00041 EQU   SWE
@NM00040 EQU   SWE
TITLESW  EQU   SWE
RESPC    EQU   SWE
@NM00039 EQU   SWE
STOPSW   EQU   SWE
@NM00038 EQU   SWD
GPRSFND  EQU   SWD
CONTSW   EQU   SWD
NOLOADSW EQU   SWD
NOSTDMG  EQU   SWD
@NM00037 EQU   SWD
@NM00036 EQU   SWD
FLSHMODE EQU   SWD
@NM00035 EQU   SWC
@NM00034 EQU   SWC
SEGRD    EQU   SWC
EDITSW   EQU   SWC
SETFLSH  EQU   SWC
MSTRSW   EQU   SWC
@NM00033 EQU   SWB
@NM00032 EQU   SWB
@NM00031 EQU   SWB
@NM00030 EQU   SWB
FMTERR   EQU   SWB
RDRSW    EQU   SWA
@NM00029 EQU   SWA
GOSW     EQU   SWA
@NM00028 EQU   SWA
@NM00027 EQU   SWA
@NM00026 EQU   SWA
@NM00025 EQU   SWA
LINENUM  EQU   COMMON+120
LINENUMB EQU   COMMON+118
SIXTEEN  EQU   COMMON+116
TWELVE   EQU   COMMON+114
ELEVEN   EQU   COMMON+112
HTEN     EQU   COMMON+110
EIGHT    EQU   COMMON+108
SEVEN    EQU   COMMON+106
FIVE     EQU   COMMON+104
FOUR     EQU   COMMON+102
THREE    EQU   COMMON+100
TWO      EQU   COMMON+98
ONEA     EQU   COMMON+96
READTM   EQU   COMMON+92
RDERCNT  EQU   COMMON+88
READNO   EQU   COMMON+84
RDENTRY  EQU   COMMON+80
@NM00024 EQU   COMMON+79
RETCODE  EQU   COMMON+78
STORSIZE EQU   COMMON+64
PCBPTR   EQU   COMMON+60
TCBLIST  EQU   COMMON+52
PAGENUMB EQU   COMMON+44
LINECNT  EQU   COMMON+40
SIX      EQU   COMMON+36
NUCTOP   EQU   COMMON+32
WORK1    EQU   COMMON+24
DELIMCD  EQU   COMMON+20
KYWDEND  EQU   COMMON+16
KYWDBGN  EQU   COMMON+12
VERBEND  EQU   COMMON+8
VERBGN   EQU   COMMON+4
ERRADDR  EQU   COMMON
@NM00013 EQU   PRDINPUT+334
@NM00012 EQU   PRDINPUT+292
PRDPSW   EQU   PRDREGS+160
PRDCR    EQU   PRDREGS+96
PRDGPR   EQU   PRDREGS+32
@NM00011 EQU   ABENDLST+4
@NM00010 EQU   OPTION
@NM00009 EQU   OPTION
RC       EQU   ABENDLST+2
@NM00008 EQU   BUFFFLAG
BUFFINVL EQU   BUFFFLAG
DUMPZ    EQU   DUMPTTR+3
DUMPR    EQU   DUMPTTR+2
DUMPTT   EQU   DUMPTTR
DUMPVOL  EQU   DUMPVOLN
@NM00006 EQU   DUMPVOLN
.@UNREFD ANOP                          END UNREFERENCED COMPONENTS
@RT00102 EQU   LODEXIT
@RT00154 EQU   SCAN
@RT00270 EQU   RESET
@RT00298 EQU   RDEOF
@RF00298 EQU   IGNORE1
@RT00305 EQU   RDEOF
@RT00307 EQU   PRINT
@RT00318 EQU   RDEOF
@RT00329 EQU   RDEOF
@RT00335 EQU   @EL00003
@RT00337 EQU   RDEOF
@RT00348 EQU   UTWRITE
@RT00360 EQU   USETAPE
@RT00393 EQU   CPUREC
@RT00401 EQU   CHKVOLS
@RT00403 EQU   SCANMAP
@RT00453 EQU   SETDATA
@RT00461 EQU   SAVELAST
@RC00492 EQU   @RC00491
@RC00496 EQU   @RC00491
@RT00514 EQU   CHKVOLS
@RT00533 EQU   @EL00006
@ENDDATA EQU   *
         END   AMDPRLOD,(C'PLS1320',0701,77069)

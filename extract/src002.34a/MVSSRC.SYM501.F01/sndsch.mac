         MACRO
&NAME    SNDSCH  &GEN=MAXI
.*A-000000-999999                                              @X31X8I0
.*
.******************* MICROFICHE FLAGS *********************** SUPT CODE
.*C341000                                                        X02004
.*A573700                                                        Y01948
.*C556000,567423                                                 Y01948
.*D557000,558000,567432,567441                                   Y01948
.*A388000,573000                                                 S99228
.*A186000,217000,462600,488000                                   S22029
.*C001000-002000                                                 S22029
.*A355600,355700                                                 A42390
.*A400000,420000,426000,439000,446000,457000                     S21101
.*A507000,524000,528000,544000,566000                            S21101
.*C128000,442000,447000,458000,534000-537000                     S21101
.*D549000,606000-608000,614000                                   S21101
.*A114000,124000,403000,427050,427560,508400,535000,550000,      S22025
.*A558000,567126,567459                                          S22025
.*C128000,267000-268000,292000-293000,296000,534000,567000       S22025
.*D221000-225000,417000,427055,427085,427100-427300,427400-427700S22025
.*D439060-439240,439360-439840,505000,514000-515000,566180-566900S22025
.*D567000,567639,567657                                          S22025
.*A340450                                                         M2173
.*A220000                                                       SA56891
.*D177000-178000                                                SA56891
.*A565000,565200                                                SA52971
.*C567297-567324                                                SA52971
.*D545000,565400,567225,567477,567630-567648,569000             SA52971
.*A427020-427040,534000-534840                                  SA56606
.*D427420-427480,427560,427580-427800,534000-534500             SA56606
.*A561000                                                       SA60792
.*C567072,573200-573400                                         SA60792
.*C407500,409080,412000,443500,446000-446320                    SA61773
.*A409800,599800                                                SA58984
.*C015100-016000                                                SA58984
.*A461000,447200,524800                                         SA59034
.*C456000                                                       SA59034
.*D524100-524200                                                SA59034
.*C498000                                                       SA62953
.*A357000,357500                                                SA65412
.*A311050-311950                                                 Y05331
.*A427000,427400                                                OX02199
.*C389100,441600                                                SA65379
.*A389800                                                       SA65379
.*C357800-357900                                                SA68703
*A357500                                                       @ZA02054
*A183000                                                       @SA70324
*A248000,279000,573000                                         @SA71683
*A544600                                                       @SA72478
*D547300                                                       @SA72478
*C339200                                                       @YA08088
*A341660                                                       @YA08088
*C455000-461700                                                @ZA03063
.*A561400                                                       SA69635
.*A015000,017000,020000,024000,026000,065000,066000,101000       X03039
.*A146000,147000,189000,358600,362000,388000,392000,403000       X03039
.*A405600,409020,409080,409800,409930,416000,427020,427040,      X03039
.*A427540,428000,428070,434000,435000,437000,439000,442200,      X03039
.*A446500,469000,480000,483000,488500,492000,493000,507500,      X03039
.*A524800,526000,527000,528000,535500,536000,561000,561800,      X03039
.*A566000,567540,575000,599900,602000,605000,610000,613000       X03039
.*C004000,016500,088000,089000,090000,091000,431000,564000       X03039
.*D565000                                                        X03039
.*A427060,427090,427430,427520,                                  X03039
.*A000002                                                      @Z30X8IG
.*C002841,016500                                               @Z30X8IG
.*A080000,098000,101400,358715,474000,476000,599918            @Z30X8IR
.*A427170                                                      @Z30X8IM
.*A-365100,368300,384000                                       @X50X9IH
.*C-368300                                                     @X50X9IH
.*A358630,358680,358835,439095,439200                          @ZA03122
.*A413000                                                      @XA09773
.*A435100,435300                                               @X50X9II
.*D311280-311440,D312000                                       @YA11169
*D419000                                                       @OS76313
*C467000                                                       @OX11964
*C553000-555000                                                @OZ07113
*C553000-555000                                                @OY12395
*C405400                                                       @XA08073
*A156000,157000,160000,162200,C161600                          @OZ09912
*A256000                                                       @OY12421
*C467000,A469000                                               @OY12969
*A465000,C469200,A613000,A409930                               @OX13500
*A453000                                                       @OX12563
*D339400-339600,D353100-353200,A243000,A341400,C354200         @OS77835
*C341000,A610500                                               @OS77835
*C441600                                                       @OY14503
*D469100-469200                                                @OS77867
*C400000                                                       @OY14092
*C439720,439900                                                @OX17153
*A123000,567540                                                @OZ24185
*C567297                                                       @OZ24185
         SPACE 3
*A124000                                                       @OY19438
*A567288,567297                                                @OY19438
* DUMMY APAR                                                   @OZ27328
.**********************************************************************
         AIF   ('&GEN' EQ 'MAXI' OR '&GEN' EQ 'MINI' OR '&GEN' EQ 'NTSO-
               ' OR '&GEN' EQ 'VTAM').OK                         X03039
         MNOTE 12,'XXX IHB     -INVALID OPERAND.'
         MEXIT
.OK      ANOP
         TITLE '&NAME     SEND SCHEDULER'
&NAME    CSECT
.L1      ANOP
*                                                                     *
***********************************************************************
*                                                                     *
*TITLE --  SEND SCHEDULER MODULE                                      *
*                                                                     *
         AIF   ('&GEN' NE 'VTAM').TAG0                           X03039
*  MODULE NAME = IEDIAQ (VTAM)                                   X03039
         AGO   .TAG3                                             X03039
.TAG0    ANOP                                                    X03039
         AIF   ('&GEN' NE 'MINI').TAG1
*  MODULE NAME = IGG019Q6 (MINI)                                      *
         AGO   .TAG3
.TAG1    AIF   ('&GEN' NE 'NTSO').TAG2
*  MODULE NAME = IGG019Q7 (NTSO)                                      *
         AGO   .TAG3
.TAG2    ANOP
*  MODULE NAME = IGG019R4 (MAXI)                                      *
.TAG3    ANOP
*                                                                     *
*  DESCRIPTIVE NAME = SEND SCHEDULER                                  *
*                                                                     *
*  COPYRIGHT = 'NONE'                                                 *
*                                                                     *
*STATUS -- CHANGE LEVEL 8                                      @Z30X8IG
*                                                                     *
         AIF   ('&GEN' EQ 'VTAM').VFUNC                          X03039
*FUNCTION -- TO SCHEDULE A SENDING OPERATION AND TO FIND THE ADDRESS  *
*   OF THE DESTINATION LCB WHEN A MESSAGE IS POSTED TO A DESTINATION  *
*   QUEUE OR WHEN A DIAL QCB COMES OUT OF A TIME DELAY.               *
         AGO   .ENTPNT                                           X03039
.VFUNC   ANOP                                                    X03039
*FUNCTION -- TO SCHEDULE A SENDING OPERATION AND TO REQUEST A    X03039
*   LOGON IF NEEDED TO PERFORM THE SEND OPERATION.               X03039
.ENTPNT  ANOP                                                    X03039
*                                                                     *
*ENTRY POINTS --                                                      *
*   FIRST EXECUTABLE INSTRUCTION                                      *
*                                                                     *
         AIF   ('&GEN' EQ 'VTAM').VENTPT2                        X03039
*   'LCBSCAN'  WHEN CALLED BY DESTINATION ASSIGNMENT OR BY THE SEND   *
*   SCHEDULER (INITIATE MODE AND FOR A DIAL QCB).                     *
         AGO   .INPUT                                            X03039
.VENTPT2 ANOP                                                    X03039
*   'LCBSCAN' WHEN CALLED BY DESTINATION ASSIGNMENT, THE TIME    X03039
*   DELAY SUBTASK, OR THE SEND SCHEDULER ITSELF.                 X03039
.INPUT   ANOP                                                    X03039
*                                                                     *
*INPUT --                                                             *
*   WHEN ACTIVATED BY THE DISPATCHER -                                *
*   R1 POINTS TO BUFFER, LCB OR QCB                                   *
*   R11  DISPATCHER BASE                                              *
*   R13  ADDRESS OF AVTSAVE2                                          *
*   R15  ENTRY POINT ADDRESS                                          *
*   'LCBSCAN' -                                                       *
*   R7  ADDRESS OF QCB                                                *
*   R13  ADDRESS OF AVTSAVE2                                          *
*   R14  RETURN ADDRESS                                               *
*   R15  ADDRESS OF LCBSCAN                                           *
*                                                                     *
*OUTPUT --                                                            *
*   WHEN ACTIVATED BY THE DISPATCHER                                  *
*   R11  ADDRESS OF DISPATCHER                                        *
*   R13  ADDRESS OF AVTSAVE2                                          *
*                                                                     *
*   'LCBSCAN' -                                                       *
*   R13  ADDRESS OF AVTSAVE2                                          *
*   R14  RETURN ADDRESS                                               *
*                                                                     *
*EXITS-NORMAL --                                                      *
*   WHEN CALLED BY DISPATCHER                                         *
*   R13  ADDRESS OF AVTSAVE2                                          *
*   R11  DISPATCHER BASE                                              *
*   RETURN IS MADE ON R11 WITH AN OFFSET TO HAVE THE DISPATCHER       *
*   PERFORM THE DESIRED FUNCTION.                                     *
*                                                                     *
*   'LCBSCAN'                                                         *
*   R11  DISPATCHER BASE                                              *
*   R13  ADDRESS OF AVTSAVE2                                          *
*   R14  RETURN ADDRESS                                               *
*   BR  R14                                                           *
*                                                                     *
*EXTERNAL ROUTINES --                                                 *
*   'IEDQTNT' - TO CONVERT A TWO BYTE TNT OFFSET TO TERMINAL ENTRY    *
*   ADDRESS                                                           *
*                                                                     *
         AIF   ('&GEN' EQ 'VTAM').VEXTRTN                        X03039
*   'IOHALT' MACRO - TO HALT AN ENABLE OR PREPARE COMMAND IN          *
         AGO   .EXITS                                            X03039
.VEXTRTN ANOP                                                    X03039
*   'IEDQHG01' - TO PUT THE QCB ON THE TIME DELAY QUEUE WHEN     X03039
*   MSGLIMIT IS REACHED ON OUTPUT.                               X03039
*                                                                X03039
*   'IEDIAF2' - TO ISSUE A RESET CONDITIONAL.                    X03039
.EXITS   ANOP                                                    X03039
*                                                                     *
*EXITS-ERROR -- NONE                                                  *
*                                                                     *
*TABLES/WORK AREAS --VARIOUS CONTROL BLOCKS EXPANDED BY MACROS        *
*   TAVTD                                                             *
*   TCCWD                                                             *
*   DCBD                                                              *
*   TDEBD                                                             *
*   TLCBD                                                             *
*   TPRFD                                                             *
*   TQCBD                                                             *
*   TSCBD                                                             *
*   TSTCBD                                                            *
*   TTRMD                                                             *
*   TTSID                                                      @Z30X8IR
*                                                                     *
*ATTRIBUTES -- RE-USABLE, REFRESHABLE, ENABLED, PROBLEM PROGRAM MODE  *
*                                                                     *
*NOTES -- THE OPERATION OF THIS MODULE DOES NOT DEPEND UPON A         *
*   PARTICUALR INTERNAL REPRESENTATION OF THE EXTERNAL CHARACTER      *
*   SET.                                                              *
*                                                                     *
*   ROUTINES CALLING THE LCBSCAN ROUTINE EXPECT THE OFFSET TO    X03039
*   LCBSCAN ALWAYS TO BE THE FIRST TWO BYTES OF THE SEND         X03039
*   SCHEDULER.                                                   X03039
*                                                                     *
***********************************************************************
         EJECT
         DC    AL2(LCBSCAN-&NAME) .     USED BY OPEN TO
*                                         SET ADDRESS IN AVT
*                                 REGISTER EQUATES
         SPACE 1
         AIF   ('&GEN' NE 'VTAM').REG0                         @Z30X8IR
RSELECT  EQU   0                  IEDAYG ENTRY PNT INDEX REG   @Z30X8IR
.REG0    ANOP                                                  @Z30X8IR
R0       EQU   0                  FLAG REG
RTEMP    EQU   1                        WORK REGISTER
RWORK    EQU   2                        WORK REGISTER
         AIF   ('&GEN' NE 'VTAM').EQRSTCB                        X03039
RQCBP    EQU   2                        QCB PREFIX REGISTER      X03039
RSCB     EQU   3                        SCB REGISTER FOR LCBSCAN X03039
RRTN     EQU   3                  RETURN REG FOR IEDAYG        @Z30X8IR
.EQRSTCB ANOP                                                    X03039
RSTCB    EQU   3                  STCB BASE
RLCB     EQU   4                  LCB BASE
R5       EQU   5                        WORK REGISTER
R6       EQU   6                                                    TSO
RQCB     EQU   7                  QCB ADDR
RHOLD    EQU   8                  FIRST LCB SCANNED FOR AVAILABLE
RLAST    EQU   9                  COUNT OF LCB'S TO SCAN
RDCB     EQU   10                 DCB BASE
RSUPBASE EQU   11                 DISPATCHER BASE REG
RBASE    EQU   12                 SUBTASK BASE REG
R13      EQU   13                 SAVE AREA ADDR (AVTSAVE2)
R14      EQU   14                 RETURN ADDR REG
R15      EQU   15                 ENTRY BASE REG
CLEAR0F  EQU   X'0F'                                             S22025
         SPACE 1
         SPACE 2
         USING IEDQSTCB,RSTCB
         USING IEDQLCB,RLCB
         USING IEDQQCB,RQCB
         USING IHADCB,RDCB
         USING IEDQDISP,RSUPBASE
         USING AVTSAVE2,R13
         USING *,R15                    TEMPORARY USING          Y05330
         BAL   RBASE,ID                 BYPASS ID / SET BASE     Y05330
TAG      EQU   *                                               @OY19438
         USING *,RBASE                  SET NEW USING            Y05330
         DROP  R15                                               Y05330
         SPACE 1                                                 Y05330
&NAME    IEDHJN
ID       DS    0H                                                Y05330
         LA    RSTCB,IEDQSTCB     ZERO HI-ORDER BYTE
         LA    RQCB,QCBSTVTO-IEDQQCB GET QCB'S STCB OFFSET
         LCR   RQCB,RQCB          SET NEGATIVE
         AR    RQCB,RSTCB         BACK UP TO QCB BASE
         SPACE 2
*** ANALYZE THE PASSED ELEMENT.  IT MIGHT BE:
*        1. BUFFER (+8 IS A 'TIC' COMMAND CODE)
*             IF END OF MESSAGE, SEARCH FOR AN AVAILABLE LINE ON SHICH
*             TO SEND.
*        2. LCB (+8 IS THE RECEIVE SCHEDULER'S STCBVTO)
*             LOOK FOR THE MESSAGE TO SEND, AND TELL DISK ROUTINES TO
*             START READING MESSAGE.
         AIF   ('&GEN' EQ 'MINI').L5
*        3. QCB (+8 IS THE SEND SCHEDULER'S STCBVTO)
*             SEND TIME DELAY HAS JUST EXPIRED.  LOOK FOR AN AVAILABLE
*             LINE ON WHICH TO CONTACT THE DIAL TERMINAL.
         SPACE 1
         AIF   ('&GEN' EQ 'VTAM').VTAMVTO                        X03039
         CLI   PRFTIC-IEDQPRF(RTEMP),DSPSNDSC IS THIS A QCB?        TSO
         AGO   .QCBBR                                            X03039
.VTAMVTO ANOP                                                    X03039
         CLI   PRFTIC-IEDQPRF(RTEMP),DSPVSSCH IS THIS A QCB      X03039
.QCBBR   ANOP                                                    X03039
         BE    QCBTSO                   BRANCH IF IT IS A QCB       TSO
.L5      ANOP
         CLI   LCBPRI-IEDQLCB(RTEMP),PRILNFRE  LCB
         BE    SENDSCH                  YES
         L     RLCB,PRFLCB-1-IEDQPRF(,RTEMP) LCB ADDRESS
         TM    LCBSTAT1,LCBINITN        INITIATE MODE
         BZ    EXIT                     NO
         LA    R15,LCBSCAN              ADDRESSABILITY
         ST    RQCB,AVTDOUBL            SAVE QCB ADDRES
         AIF   ('&GEN' EQ 'VTAM').STCBTSO
         L     R6,QCBSLINK-1                                   @OZ09912
         LR    R5,RTEMP                 SAVE VALUE             @OZ09912
         AGO   .STCB2                                          @OZ09912
.STCBTSO ANOP                                                  @OZ09912
         ST    RTEMP,AVTDOUBL+4         SAVE BUFFER ADDRESS    @AS09778
.STCB2   ANOP                                                  @OZ09912
         BALR  R14,R15                  LINK TO FIND LCB
         L     RQCB,AVTDOUBL            SET  QCB ADDRES
         AIF   ('&GEN' EQ 'VTAM').STCB3                        @OZ09912
         LR    RTEMP,R5                 RESTORE VALUE          @OZ09912
         LR    RSTCB,R6                 RESTORE VALUE          @OZ09912
         AGO   .STCB4                                          @OZ09912
.STCB3   ANOP                                                  @OZ09912
         L     RTEMP,AVTDOUBL+4         RESTORE BUFFER ADDR    @AS09778
         L     RSTCB,QCBSTCHN-1         1ST STCB ON DEST QCB   @AS09778
         CLI   0(RSTCB),DSPMCPL6        IS IT IEDQHM'S STCB    @AS09778
         BNH   FOUNDHM                  BRANCH IF YES          @OZ09912
         L     RSTCB,QCBSLINK-1         NO, GET HM'S STCB      @AS09778
*                                       FROM STCB LINK FIELD   @AS09778
FOUNDHM  EQU   *                                               @AS09778
.STCB4   ANOP                                                  @OZ09912
         B     DSPBYPAS                 DISPATCH NEXT SSTCB
         AIF   ('&GEN' EQ 'MINI').L7
QCBTSO   LA    R15,LCBSCAN              ESTABLISH ADDRESSABILITY    TSO
         LA    R14,DSPDISP              SET EXIT FROM SUBROUTINE
        AIF   ('&GEN' EQ 'NTSO').L6
         TM    QCBFLAG,QCBTSSES         IS THIS FOR TIME SHARING?   TSO
         BZ    SETEXIT                  BRANCH IF NO
         NI    QCBTSOF2,X'FF'-QCBPOSTO  TURN OFF QCB POSTED BIT     TSO
         B     TSO1                                                 TSO
.L6      ANOP
         SPACE 1
*** A QCB QPOST'ED TO ITSELF IS ASSUMED
         SPACE 1
SETEXIT  EQU   *
         EJECT
.L7      ANOP
         USING *,R15
LCBSCAN  EQU   *
         LA    RQCB,0(,RQCB)            LCRER HI ORDER BYTE FOR COM
         TM    QCBDSFLG,QCBHELD         REUS USING QCB ?       @SA70324
         BOR   R14                      YES, EXIT              @SA70324
         AIF   ('&GEN' EQ 'MINI' OR '&GEN' EQ 'NTSO').L8
         TM    QCBDSFLG,QCBDISK+QCBCORE TIME-SHARING QUEUES?        TSO
         BCR   8,R14                    YES. RETURN TO CPB INIT     TSO
         TM    QCBFLAG,QCBTSSES .      QCB IN TSO SESSION        S22029
         BCR   7,R14 .                 YES RETURN TO CPB INIT    S22029
         SPACE
TSO1     EQU   *                                                    TSO
.L8      ANOP
         AIF   ('&GEN' EQ 'VTAM').VSCAN                          X03039
         L     RDCB,QCBDCBAD-1    GET DCB ADDR
         TM    DCBOFLGS,OPEN      IS DCB OPEN
         BCR   8,R14                    NO EXIT
RETRY    EQU   *
         L     RTEMP,DCBDEBAD     GET DEB ADDR
         USING DEBNMSUB,RTEMP
         TM    DEBOPATB,OUTPUT          OPENED FOR OUTPUT
         BCR   8,R14                    NO, RETURN
         DROP  RTEMP
         SR    RLAST,RLAST        ZERO COUNT REG
         IC    RLAST,X'10'(,RTEMP)      DEB NUMBER OF EXTENTS
         SR    RTEMP,RTEMP        ZERO ODD REG
         IC    RTEMP,QCBRELLN     GET QCB'S STARTING RLN
         LR    RLCB,RTEMP               COPY RLN FOR NEXT TEST
         BCTR  RLCB,R0                  RLN MINUS 1
         SR    RLAST,RLCB               GET COUNT OF LCB'S TO SCAN
         BCR   13,R14                   NO, EXIT
         SR    RWORK,RWORK        ZERO SIZE REG
         IC    RWORK,DCBEIOBX     GET LCB SIZE
         MR    RTEMP-1,RWORK      GET STARTING LCB OFFSET
         AL    RTEMP,DCBIOBAD           POINT TO IOB OF LCB
         SH    RTEMP,LCBSIZE            ADJUST TO START OF LCB
         LR    RLCB,RTEMP               LCB BASE
         AIF   ('&GEN' EQ 'MINI').LNODL
         SR    RHOLD,RHOLD              CLEAR WORK REGISTER
        AIF   ('&GEN' EQ 'NTSO').L9
         TM    QCBDSFLG,QCBDISK+QCBCORE TIME-SHARING QUEUES?        TSO
         BZ    NONDIAL                  YES. TREAT AS IF LEASED     TSO
         TM    QCBFLAG,QCBTSSES .      QCB IN TSO SESSION        S22029
         BO    NONDIAL .               YES TREAT AS LEASED       S22029
.L9      ANOP
         TM    LCBSTAT2,LCBDIAL   ARE THESE DIAL LINES
         BZ    NONDIAL            NO, THIS IS THE LINE
         CLI   QCBSTPRI,CALLOPT         CLOCK OR INTERVAL       SA56891
         BL    DIALLOOP                 BRANCH IF NOT           SA56891
         OI    QCBSTAT,QCBSCHDL         FORCE RECEIVE OPERATION SA56891
*                                         PRIOR TO SENDING      SA56891
DIALLOOP EQU   *
         TM    LCBTSTSW,CONNECT         LCB CONNECTED
         BZ    NOTCONNT                  NOT CONNECTED
         SPACE
         LH    RTEMP,LCBTTCIN           CURRENTLY CONNECTED
         LTR   RTEMP,RTEMP              ORIGIN SPECIFIED
         BZ    TRYNEXT                  NO
         STM   14,15,AVTSAVE3           SAVE REGISTERS
         SPACE
         L     R15,AVTRNMPT             CONVERT ROUTINE
         BALR  R14,R15                  GET TERMINAL CADDRESS
         LM    14,15,AVTSAVE3            SET REGISTERS
         L     RTEMP,TRMDESTQ-1-IEDQTRM(,RTEMP) QCB ADDRESS
         LA    RTEMP,0(,RTEMP)          CLEAR HI ORDER BYTE FOR CR
         CR    RTEMP,RQCB               ARE WE CONNECTED TO THIS
         BNE   TRYNEXT                  NO CONNECTION
         SPACE
         NI    QCBSTAT,AVTEFF-QCBSCHDL  TNT WOURCE SET
         AIF   ('&GEN' EQ 'NTSO').L9A                          @OS77835
         TM    QCBFLAG,QCBNOBRK         CAN TERMINAL BE BROKEN @OS77835
         BO    LEAVE                    NO,EXIT                @OS77835
         TM    LCBTSOB,LCB2741N         2741?                  @OS77835
         BO    NONDIAL                  YES,TREAT AS LEASED    @OS77835
.L9A     ANOP                                                  @OS77835
         B     LEAVE                    EXIT
         SPACE
NOTCONNT EQU   *
         CLI   QCBSTPRI,CALLPRI         CALL=NONE SPECIFIED
         BE    TRYNEXT                  BRANCH YES
         TM    LCBSTCBA+TWO,CLOSEDWN    LINE STOPPED BY        @SA71683
*                                        CLOSEDOWN ?           @SA71683
         BO    TRYNEXT                  BR IF YES              @SA71683
         LTR   RHOLD,RHOLD              PREVIOUS LCB SELECTED
         BNZ   TRYNEXT                  YES,ALREADY HAVE AVAILABEL
         LR    RHOLD,RLCB               SAVE FOUND LCB
TRYNEXT  EQU   *
         AR    RLCB,RWORK               ADDRESS OF NEXT LCB
         BCT   RLAST,DIALLOOP           LOOK AT NEXT LCB
         LTR   RLCB,RHOLD               WAS AVAILABLE LINE FOUND
         BZ    CALLQ                    BRANCH NO
         LA    RTEMP,DSPDISP            GET DISPATCHER EXIT    @OY12421
         CR    RTEMP,R14                WAS THIS A QCB ENTRY   @OY12421
         BE    NOHOLD                   BRANCH-YES DO DIAL UP  @OY12421
         TM    QCBSTAT,QCBTRMHO         IS TERMINAL HELD       @OY12421
         BO    CALLQ                    BRANCH YES             @OY12421
NOHOLD   EQU   *                                               @OY12421
         TS    LCBTSTSW                 LINE STILL AVAILABLE
         BNZ   RETRY                    LOOP AGAIN ON LINE GROUP
         OI    LCBSTAT2,LCBNEGRP        SET NEGATIVE RESPONSE IN
*                                         CASE TERMINAL IS HELD
*                                         IF NOT SET, AN ERRONEOUS
*                                         'CONNECTION' APPEARS TO
*                                         RCV SCHED AND ACTIVATE
         NI    LCBTPCD+11,AVTEFF-DISDLEOT DONT SEND DLE EOTSINCE WE
*                                         ARE NOT DISCONNECTING
*                                         A CALL
         TM    LCBSTAT1,LCBFREEN .      LCB FREE
         BZ    HALTLINE .               BRANCH IF NO TO HIO      S22025
         B     POSTLCB                  GET LCB
         SPACE
CALLQ    EQU   *
         L     RSTCB,DCBIOBAD           1ST IOB
         AR    RSTCB,RWORK              POINT TO 1ST IOB
         SH    RSTCB,DOCQAD             BACK UP TO CALL Q
         B     DSPUNAVR                 USE UNAVAIL AND RETURN
*                                         TO CALLER
         SPACE
NONDIAL  EQU   *
.LNODL   ANOP
         TM    LCBSTCBA+TWO,CLOSEDWN    LINE STOPPED BY        @SA71683
*                                        CLOSEDOWN?            @SA71683
         BOR   R14                      BR IF YES              @SA71683
         CLI   LCBRSPRI,SENDPRI         LINE HAVE SEND PRIORITY
         BH    OBTAIN             NO, GO GET THE LINE
         OI    LCBSTAT2,LCBSNDPR  SET SEND SCHEDULER WANTS LINE
OBTAIN   EQU   *
         AIF   ('&GEN' EQ 'NTSO' OR '&GEN' EQ 'MINI').L10
         TM    QCBFLAG,QCBTSSES         IS THIS TIME SHARING?       TSO
         BZ    TSO2                     BRANCH ON NO                TSO
         L     R6,AVTTSOPT              ADDRESS OF TSINPUT QCB      TSO
         L     R6,TSISCHED-IEDQTSI(,R6) ADDRESS OF TS SCHEDULER     TSO
         BAL   RSTCB,8(,R6)             BRANCH TO ROUTINE           TSO
TSO2     EQU   *                                                    TSO
.L10     ANOP
         TM    LCBSTAT1,LCBFREEN .      IS LINE FREE             S22025
         BZ    TESTPOLL .               NO, GO LOOK FOR NON-REGULS22025
*                                       AR INTERUPTING TERMINALS S22025
*                                      INTERRUPTING TERMINALS
POSTLCB  EQU   *
         XI    LCBSTAT1,LCBSENDN+LCBFREEN . CHANGE LCB STATE TO  S22025
*                                         A MULTIPE POST OF LCB
         MVI   LCBPRI,PRILNFRE          POST PRIORITY
         ST    14,AVTSAVE3+4            SAVE REGISTER
         ST    RQCB,AVTSAVE3            SAVE REGISTER
         ST    RLCB,LCBQCBA-1           LCB IS QCB
         LR    1,RLCB                   PARAMETER FOR POST
         BAL   R14,DSPPOSTR             PUT LCB ON READY Q
         L     RQCB,AVTSAVE3            SET  REGISTER
         L     14,AVTSAVE3+4            SET  REGISTER
         B     LEAVE                    EXIT
         SPACE
TESTPOLL EQU   *
         CLI   LCBCPA+24,POLL           LINE IN AUTOPOLL
         BNE   BASIC                    BRANCH NO
         SPACE
         ST    RLCB,AVTSAVE2            LCB POINTER              Y05331
         L     RWORK,AVTSAVTP           POINTER TO SECONDARY AVT Y05331
         USING IEDNSVTD,RWORK                                    Y05331
         TM    SAVTDIAF,SAVTVIRT        IN VM ENVIRONMENT?       Y05331
         BNO   NOVIRT                   NO, BRANCH               Y05331
         STM   R14,R15,AVTSAVE2+24      SAVE REGISTERS 14 AND 15 Y05331
         LA    R0,LCBCPA+56             TIC ADDRESS              Y05331
         L     R15,SAVTDIAG             VIRTUAL DIAGNOSE ROUTINE Y05331
         DROP  RWORK                                             Y05331
         MVI   LCBCPA+56,CCWNOP         NOP 2ND VIRTUAL TIC      Y05331
         BAL   R14,4(,R15)              NOP CORRESPONDING REAL   Y05331
*                                         TIC                    Y05331
         LM    R14,R15,AVTSAVE2+24      RESTORE REGISTERS 14,15  Y05331
         B     LEAVE                    EXIT                     Y05331
         SPACE
NOVIRT   EQU   *                                                 Y05331
         MVI   LCBCPA+56,CCWNOP         NOP 2ND TIC
         B     LEAVE                    EXIT
         SPACE
BASIC    EQU   *
         TM    LCBSTAT2,LCBSYNC         BSC LINE
         BZ    NOTBSC                   BRANCH NO
         SPACE
         CLI   LCBCPA+16,CCWPREP        RECEIVE STATE
         BNE   LEAVE                    NO
         TS    LCBTSTSW                 LINE FREE
         BNZ   LEAVE                    BRANCH BUSY
         B     HALTLINE                 ISSUE HALT IO
NOTBSC   EQU   *
         CLI   LCBCPA+24,CCWSENSE       SENSE COMMAND
         BE    CHKSENSE                 YES, SEE IF NIO REQUIRED
         CLI   LCBCPA+32,CCWSENSE       START STOP CONTENTION
*                                         MAY BE REQUIRED)
         AIF   ('&GEN' EQ 'MAXI').L11A
         BNE   LEAVE .                  BRANCH IF NOT A BASIC
*
         AGO   .L11B
.L11A    ANOP
         BNE   CKTSO .                  BRANCH IF NOT A BASIC
.L11B    ANOP
CHKSENSE EQU   *
         TM    LCBCSWSV,AVTEFF          SENSE BEEN EXECUTED
         AIF   ('&GEN' NE 'MAXI').L11
         BNO   CKTSO                    BRANCH IF SENSE DONE   @YA08088
         TM    QCBFLAG,QCBTSSES         TSO OPERATION          @YA08088
         BO    HALTLINE                 IF SO, ISSUE HIO       @YA08088
         TM    LCBTSOB,LCB2741N         IS THIS A 2741         @YA08088
         BNO   HALTLINE                 IF NOT,ISSUE HIO       @YA08088
CKTSO    EQU   *
         TM    LCBSTAT1,LCBRECVN .      IS LINE RECEIVING           TSO
         BZ    LEAVE .                  BRANCH IF NO                TSO
         TM    LCBSTAT2,LCBMSGNN .      MSGEN IN PROGRESS           TSO
         BO    LEAVE .                  BRANCH IF YES
         SPACE
         TM    QCBFLAG,QCBNOBRK         CAN TERMINAL BE BROKEN?    2741
         BO    LEAVE                    BRANCH ON NO               2741
         L     RWORK,LCBLSPCI-1         GET ADDRESS OF FIRST BUFFER2741
         LA    RWORK,0(,RWORK) .        TEST ADDRESS ONLY         M2173
         LTR   RWORK,RWORK .            TEST FOR ADDRESS          M2173
         BZ    LEAVE .                  IF NO BFR, CAN NOT BREAK  M2173
         TM    PRFSTAT1-IEDQPRF(RWORK),PRFNHDRN IS IT FIRST BUFFER?2741
         BO    LEAVE                    BRANCH ON NO               2741
         L     RTEMP,PRFIOADR-1-IEDQPRF(,RWORK) GET DATA ADDR  @OS77835
         N     RTEMP,CLRHI              GET OFFSET IN PAGE     @OS77835
         N     RWORK,CLRLOW             GET ADDR OF PAGE       @OS77835
         AR    RWORK,RTEMP              GET DATA ADDRESS       @OS77835
         CLI   1(RWORK),0               HAS USER ENTERED ANY DATA? 2741
         BNE   LEAVE
         TM    QCBFLAG,QCBTSSES         TSO IN CONTROL?        @OS77835
         BO    HALTLINE                 YES,CONTINUE           @OS77835
         TM    LCBTSOB,LCB2741N         2741?                  @OS77835
         BZ    LEAVE                    NO,EXIT                @OS77835
         AGO   .L11C
.L11     ANOP
         BNO   LEAVE
         TM    LCBTSOB,LCB2741N         IS THIS A 2741         @YA08088
         BO    LEAVE                    IF SO, DO NOT HIO      @YA08088
.L11C    ANOP
HALTLINE EQU   *
         SR    RWORK,RWORK              CLEAR FOR INDEXING
         IC    RWORK,LCBUCBX            RLN MINUS 1
         SLL   RWORK,2                   MULTIPLY BY 4 FOR INDEX
         L     RTEMP,DCBDEBAD           DEB ADDRESS
         L     RTEMP,X'20'(RTEMP,RWORK) UCB ADDRESS
         LA    RTEMP,0(,RTEMP)          CLEAR HI ORDER BYTE
*                                         ENSURE POSTIVE POINTER
         AIF   ('&GEN' EQ 'MINI' OR '&GEN' EQ 'NTSO').L13
         TM    19(RTEMP),AVTEFF-AIBM1   CAN DEVICE BE A 1050 OR 2741TSO
         BNZ   ISSUESVC                 BRANCH ON NO                TSO
         CLI   16(RTEMP),T1050          IS IT A 1050                TSO
         BNE   TEST2741                 NO,BRANCH              @OS77835
         TM    QCBFLAG,QCBTSSES         TSO IN CONTROL?        @OS77835
         BO    SETBRK                   YES,BRANCH             @OS77835
TEST2741 EQU   *                                               @OS77835
         CLI   16(RTEMP),T2741C .       IS IT A 2741 CORRES         TSO
         BE    SETBRK .                 BRANCH IF YES               TSO
         CLI   16(RTEMP),T2741B .       IS IT A 2741 BCD            TSO
         BNE   ISSUESVC .               BRANCH IF NO                TSO
SETBRK   EQU   *                                                    TSO
         TM    QCBFLAG,QCBNOBRK .       CAN WRITE BREAK BE USED  A42390
         BO    ISSUESVC .               BRANCH NO                A42390
         OI    LCBTSOB,LCBWRBRK         SET SWITCH FOR LINE END 2741
.L13     ANOP
ISSUESVC EQU   *                                                   2741
         DROP  R15                                              SA65412
         LR    RSTCB,R15                COPY BASE ADDRESS       SA65412
         USING LCBSCAN,RSTCB                                    SA65412
*                                         PREVENT LOSS OF LINE IF
*                                         ERROR OCCURRED AND LCB IS
*                                         ON WAY TO ERP OR UNDER ERP
*                                         CONTROL
         MVI   LCBECBCC,HIOCC           SET HALT I/O COMPLETION  Y02027
         IOHALT (1)
         LTR   R15,R15                  RETURN CODE ZERO       @ZA02054
         BZ    HIODONE                  BR YES, HIO COMPLETE   @ZA02054
         SR    R15,R15                  CLEAR FOR COMPARE      @ZA02054
         CLM   R15,15,LCBCSW+THREE      CHANNEL PROGRAM STILL  @ZA02054
*                                       OUTSTANDING            @ZA02054
         LR    R15,RSTCB                COPY BASE REGISTER     @ZA02054
         BZ    HALTLINE                 BR YES, REISSUE IOHALT @ZA02054
HIODONE  EQU   *                                               @ZA02054
         LR    R15,RSTCB                BASE REGISTER           SA65412
         DROP  RSTCB                                            SA65412
         USING LCBSCAN,R15                                      SA65412
         USING IEDQSTCB,RSTCB                                   SA65412
         AGO   .NOTVTAM                                          X03039
.VSCAN   ANOP                                                    X03039
         L     RTEMP,AVTSAVTP           SECONDARY AVT ADDRESS    X03039
*                                                                X03039
         USING IEDNSVTD,RTEMP           ADDRESSABILITY FOR SAVT  X03039
         L     RDCB,SAVTACB             ACB ADDRESS              X03039
         DROP  RTEMP                                           @ZA03122
*                                       ACB OPEN                 X03039
         TM    ACBOFLGS-IFGACB(RDCB),ACBOPEN                     X03039
         BNOR  R14                      BR NO                    X03039
*                                                                X03039
         LA    RQCBP,QCBPRFSZ           QCB PREFIX SIZE          X03039
         LNR   RQCBP,RQCBP              MAKE NEGATIVE FOR BACKUP X03039
         AR    RQCBP,RQCB               BACK UP TO QCB PREFIX    X03039
*                                                                X03039
         USING IEDNQCB,RQCBP            ESTABLISH ADDRESSABILITY X03039
         TM    QCBSTAT1,QCBNIDLE        LINE STOPPED             X03039
         BZR   R14                      BR YES                   X03039
*                                                                X03039
         TM    QCBSTAT,QCBTRMHO         TERMINAL HELD            X03039
         BOR   R14                      BR YES                   X03039
*                                                                X03039
         TM    QCBSTAT1,QCBPLCBN        IS DEST LOGGED ON        X03039
         BZ    REQLOGON                 BRANCH NO                X03039
*                                                                X03039
         L     RLCB,QCBPLCBA-1          PLCB ADDRESS             X03039
         LR    RHOLD,R14                SAVE RETURN REGISTER   @ZA03122
         LH    RTEMP,LCBTTCIN           GET TNT OFFSET         @ZA03122
         N     RTEMP,AVTCLRHI           CLEAR HI ORDER BYTES   @ZA03122
         LR    R6,R15                   SAVE BASE REGISTER     @ZA03122
         L     R15,AVTRNMPT             ADDR OF TNT            @ZA03122
         BALR  R14,R15                  GET TERM ENTRY ADDR    @ZA03122
         LR    R14,RHOLD                RESTORE RETURN REGISTER@ZA03122
         LR    R15,R6                   RESTORE BASE REG       @ZA03122
         USING IEDNTRM,RTEMP            TERMINAL DSECT BASE    @ZA03122
         SH    RTEMP,AVTHA4             BACK UP TO TRM PREFIX  @ZA03122
         TM    TRMSTAT1,TRMSESSN        IS TERMINAL IN SESSION @ZA03122
         BZ    TMDELAY                  NO, PUT QCB ON TIME    @ZA03122
*                                         DELAY QUEUE          @ZA03122
         DROP  RTEMP                                           @ZA03122
         L     RTEMP,AVTSAVTP           SECONDARY AVT ADDR     @ZA03122
         USING IEDNSVTD,RTEMP           ADDRESSABILITY         @ZA03122
         EJECT
         TM    QCBFLAG,QCBTSSES         IS TSO IN SESSION      @Z30X8IR
         BZ    INPUT                    BRANCH ON NO           @Z30X8IR
         L     R6,AVTTSOPT              GET TSINPUT QCB ADDR   @Z30X8IR
         L     R6,TSIRNSCH-IEDQTSI(,R6) VTAM TSO SCHED ADDR    @Z30X8IR
         LA    RSELECT,THREE            INDEX TO IEDA1C ENTRY  @Z30X8IR
*                                         PT OF VTAM TSO SCHED @Z30X8IR
         BALR  RRTN,R6                  BRANCH TO VTAM TSO     @Z30X8IR
*                                         SCHED,IEDAYG         @Z30X8IR
INPUT    EQU   *                                               @Z30X8IR
         TM    LCBSTAT1,LCBFREEN        LINE FREE                X03039
         BO    PRIME                    BR YES                   X03039
*                                                                X03039
         L     RSCB,LCBSCBA-1           SCB ADDRESS              X03039
*                                       IN MIDDLE OF MESSAGE     X03039
         TM    SCBQTYPE-IEDQSCB(RSCB),SCBBFMM                    X03039
         BO    LEAVE                    BR YES                   X03039
*                                                                X03039
         TM    LCBSTAT4,LCBINPTP        INPUT PENDING?           X03039
         BO    PRIME                    BR YES                   X03039
*                                                                X03039
         TM    LCBSTAT3,LCBRDOUT        READ OUTSTANDING         X03039
         BZ    LEAVE                    BR NO                    X03039
*                                                                X03039
         TS    LCBTSTSW                 READ BACK INTO TPIO/FDBK X03039
         BNZ   LEAVE                    BR YES                   X03039
*                                                                X03039
         STM   R0,R15,AVTSAVE3          SAVE REGISTERS           X03039
*                                       ADDR LCCW GEN'R STCB VTO X03039
         L     R15,SAVTLCWQ+(QCBSTVTO-IEDQQCB)                   X03039
         L     R15,AVTEZERO(,R15)       RESET ENTRY POINT ADDR   X03039
         LA    R0,LXC                   PASS RESET CONDITIONAL   X03039
         SR    RTEMP,RTEMP              INDICATE NO DATA TO IAF2 X03039
         SR    R5,R5                    INDICATE - USE RESET LCPBX03039
         BALR  R14,R15                  GO ISSUE RESET COND'L    X03039
*                                                                X03039
         LTR   R15,R15                  RESET REQUEST ACCEPTED   X03039
         LM    R0,R15,AVTSAVE3          RESTORE REGISTERS        X03039
         BZ    LEAVE                    BR RESET REQUEST ACCEPTEDX03039
*                                                                X03039
         SPACE 1                                               @ZA03122
TMDELAY  EQU   *                                               @ZA03122
         TM    QCBTSOF1,QCBDELAY        IS QCB ALREADY ON T-D Q@ZA03122
         BOR   R14                      YES-BRANCH             @ZA03122
         MVC   QCBSTCHN,QCBSLINK        REMOVE SS FROM QCB       X03039
         LA    RTEMP,ONESECD            FORCE 1 SECOND DELAY     X03039
         STH   RTEMP,QCBEOLDT           SET DELAY TIME IN QCB    X03039
         MVI   QCBLKRLN,AVTEZERO        SET QCB INDICATOR        X03039
         LA    RTEMP,AVTDELYB           ADDR OF TIME DELAY QCB   X03039
         STCM  RTEMP,AD,QCBELCHN        SET TIME DELAY QCB ADDR  X03039
         MVI   QCBPRI,PRITIME           SET TIME DELAY PRIORITY  X03039
         LR    RTEMP,RQCB               PASS QCB AS ELEMENT      X03039
         B     DSPPOSTR                 POST QCB TO TIME DELAY   X03039
*                                       AND RETURN               X03039
PRIME    EQU   *                                                 X03039
         NI    LCBSTAT4,AVTEFF-LCBINPTP   RESET INPUT PENDING    X03039
*                                       MARK LINE SENDING        X03039
         XI    LCBSTAT1,LCBSENDN+LCBFREEN                        X03039
         ST    RQCB,AVTSAVE3            SAVE QCB REG             X03039
         ST    R14,AVTSAVE3+WORD2       SAVE RETURN REG          X03039
         STCM  RLCB,AD,LCBQCBA          POST LCB TO ITSELF       X03039
         MVI   LCBPRI,PRILNFRE          SET INITIAL POST PRIORITYX03039
         LR    RTEMP,RLCB               SET LCB AS POST ELEMENT  X03039
         BAL   R14,DSPPOSTR             POST LCB                 X03039
*                                                                X03039
         L     RQCB,AVTSAVE3            RESTORE QCB ADDRESS      X03039
         L     R14,AVTSAVE3+WORD2       RESTORE RETURN ADDRESS   X03039
*                                                                X03039
.NOTVTAM ANOP                                                    X03039
LEAVE    EQU   *
         LR    RSTCB,RLCB
         B     DSPUNAVR                 LINK STCB INTO CHAIN
*                                         AND RETURN TO CALLER
         AIF   ('&GEN' NE 'VTAM').EXIT                           X03039
*                                                                X03039
REQLOGON EQU   *                                                 X03039
         OI    QCBSTAT,QCBSEND          INDICATE THAT SEND     @XM10739
*                                       SCHED SHOULD BE PUT IN @XM10739
*                                       CHAIN WHEN PLCB IS     @XM10739
*                                       ASSIGNED               @XM10739
         NI    QCBSTAT,AVTEFF-QCBSCHDL  INIT SCHDL SWITCH      @XM10739
         BAL   R5,GETTERM               GET TERMINAL ENTRY     @XM10739
         TM    TRMSTAT0-IEDNTRM(RTEMP),TRMLUNIT LOGICAL UNIT   @XM10739
         BZ    CKCALL                   NO-BRANCH              @XM10739
         CLI   QCBSTPRI,LUINIT          TCMSESN=LUINIT         @XM10739
         BER   R14                      YES-BRANCH             @XM10739
         B     TSPOSTED                 NO-BRANCH              @XM10739
CKCALL   EQU   *                                               @XM10739
         CLI   QCBSTPRI,NOCALL          CALL=NONE              @XM10739
         BE    SETSCHDL                 YES-BRANCH             @XM10739
         CLI   QCBSTPRI,CALLOPT         CLOCK OR CINTVL        @XM10739
         BL    TSPOSTED                 NO-BRANCH              @XM10739
         OI    QCBSTAT,QCBSCHDL         SCHED RECEIVE FIRST    @XM10739
         B     TSPOSTED                                        @XM10739
SETSCHDL EQU   *                                               @XM10739
         OI    QCBSTAT,QCBSCHDL         SCHED RECEIVE FIRST    @XM10739
         BR    R14                      RETURN                 @XM10739
TSPOSTED EQU   *                                                 X03039
         TS    QCBTSTSW                 QCB POSTED BY LOGON EXIT X03039
         BNZR  R14                      BR YES                   X03039
*                                                                X03039
*   POST QCB TO PLCB RETURN TO GET A PLCB AND REQUEST A LOGON    X03039
*                                                                X03039
         L     RTEMP,AVTSAVTP     SEC'ND AVT ADDR              @XM10729
         LA    RTEMP,SAVTPRTQ           PLCB RETURN QCB ADDRESS  X03039
         STCM  RTEMP,AD,QCBELCHN        POST QCB TO PLCB RETURN  X03039
         MVI   QCBPRI,PRILCBRQ          PLCB REQUEST PRIORITY    X03039
         LR    RTEMP,RQCB               SET QCB AS ELEMENT       X03039
         B     DSPPOSTR                 POST QCB TO PLCB RETURN  X03039
*                                       AND RETURN TO CALLER     X03039
.EXIT    ANOP                                                    X03039
EXIT     EQU   *
         L     RSTCB,QCBSLINK-1         NEXT STCB (DEST SCHED)
         B     DSPBYPAS           GO ACTIVATE DESTINATION SCHEDULER
         AIF   ('&GEN' NE 'VTAM').XGTERM                       @X50X9IH
         SPACE 1                                               @X50X9IH
GETTERM  EQU   *                                               @X50X9IH
         LH    RTEMP,QCBTTCIN     GET TERMNAME TABLE OFFSET    @X50X9IH
         N     RTEMP,AVTCLRHI     CLEAR HALF                   @X50X9IH
         LR    R6,R15             SAVE REG15                   @X50X9IH
         ST    R14,AVTSAVE3       SAVE REG 14                  @XM10729
         L     R15,AVTRNMPT       GET ADDR OF TNT CODE         @X50X9IH
         BALR  R14,R15            LINK TO LOCATE TERM ENTRY    @X50X9IH
         LR    R15,R6             RESTORE REG 15               @X50X9IH
         L     R14,AVTSAVE3       RESTORE REG 14               @XM10729
         SPACE 2                                               @X50X9IH
         SH    RTEMP,AVTHA4  SET BASE TO TERMINAL PREFIX       @X50X9IH
         BR    R5                 RETURN                       @X50X9IH
.XGTERM  ANOP                                                  @X50X9IH
         DROP  15
         EJECT
SENDSCH  EQU   *
         LA    RLCB,AVTEZERO(,RTEMP)    PASSED LCB ADDRESS
         AIF   ('&GEN' EQ 'VTAM').VSNDSCH                        X03039
         SR    RHOLD,RHOLD              CLEAR WORK REGISTER      S99228
         L     RDCB,LCBDCBPT            LOAD DCB ADDRESS         S99228
         IC    RHOLD,DCBEIOBX           INSERT LCB LENGTH        S99228
         SH    RHOLD,AVTHA4             REDUCE LCB LENGTH BY     S99228
         SH    RHOLD,AVTHA4             8 BYTES FOR ADDR LCB EXT S99228
         LA    RHOLD,ZERO(RHOLD,RLCB)   LOAD LCB EXTENSION ADDR  S99228
         USING IEDQLCBX,RHOLD                                    S99228
         TM    LCBXFLAG,LCBGPCTV        GENERAL POLL IN PROGRESS?S99228
         BO    CKDLY1                   BRANCH YES TO RCV SCH   SA65379
         TM    LCBXFLAG,LCBERPND        SOH%R MESSAGE PENDING?   S99228
         DROP  RHOLD                                             S99228
         BZ    NOERP                    NO, SPEC ERP NOT PENDING S99228
CKDLY1   EQU   *                                                SA65379
         TM    LCBINSRC+TWO,DELAY       LCB ON TIME DELAY Q?     S99228
         BZ    NODELAY                  NO, NOT IN POLL DELAY    S99228
         LR    RTEMP,RLCB               LOAD LCB ADDR            S99228
         L     R15,AVTHG02              LOAD ADDR TIME DELAY RTN S99228
         BALR  R14,R15                  BRANCH TO TIME DELAY     S99228
         LA    RQCB,LCBRSKEY            INSERT RCV SCHED IN CHAI S99228
         LR    RTEMP,RQCB               LOAD QCB ADDR            S99228
         BAL   R14,DSPPRIOR             BRANCH TO DISPATCHER     S99228
NODELAY  EQU   *                                                 S99228
         B     RCVSCHED                 BYPASS TO RCV SCHED      S99228
NOERP    EQU   *                                                 S99228
.VSNDSCH ANOP                                                    X03039
         MVC   AVTDOUBL(1),LCBSTAT1     SAE CURRENT STATE
         NI    LCBSTAT1,LCBOCNI+LCBOCWTN SAVE STOP LINE BIT    @OY14092
         OI    LCBSTAT1,LCBSENDN .      SET LCB STATE            S21101
         AIF   ('&GEN' EQ 'VTAM').VSCB                           X03039
FNDSCB   EQU   * .                                               S22025
         TM    LCBSTAT2,LCBDIAL .       IS THIS A DIAL LINE      S22025
         BO    TSTSCB .                 YES-BRANCH               S22025
         SR    R0,R0 .                  CLEAR REG FOR MULTIPLY   S22025
         SR    RTEMP,RTEMP .            CLEAR REG FOR MULTIPLY   S22025
         IC    R0,AVTSCBSZ .            PICK UP SCB SIZE         S22025
         IC    RTEMP,QCBSCBOF .         PICK UP SCB OFFSET       S22025
         MR    R0,R0 .  .               OFFSET X SIZE = PROPER   S22025
*                                       SCB OFFSET IN RTEMP      S22025
         L     R5,LCBSCBDA-1 .          SCB DIRECTORY START ADDR S22025
         LA    R5,0(RTEMP,R5) .         GET SCB FOR THIS QCB     S22025
         STCM  R5,AD,LCBSCBA            SET SCB ADDR IN LCB    @XA08073
TSTSCB   EQU   * .                                               S22025
.VSCB    ANOP                                                    X03039
         USING IEDQSCB,RLAST
         L     RLAST,LCBSCBA-1          GET SCB ADDRESS
         L     RSTCB,STCBLINK-1         NEXT STCB ADDRESS       SA61773
         TM    SCBSTATE,SCBLCK1N+SCBMSGLN EXTENDD LOCK
         BZ    NOLOCK                   NO
         SPACE 2                                                 S22025
         TM    SCBQTYPE,SCBBFMM  .      MIDDLE MSG               S22025
         AIF   ('&GEN' NE 'VTAM').L13A                           X03039
         BO    CHKDLY                   BR YES                   X03039
         AGO   .L13B                                             X03039
.L13A    ANOP                                                    X03039
         BZ    TYPELOCK                 NO-BR                    S22025
         SPACE 2                                                 S22025
         TM    QCBSTAT,QCBSEND          MIDDLE OF SENDING LOCK MSG22025
         BO    NOLOCK                   YES-BR                   S22025
         SPACE 2                                                 S22025
         B     CHKDLY                   BRANCH IF NO            SA61773
.L13B    ANOP                                                    X03039
         SPACE 2                                                 S22025
TYPELOCK EQU   *                                                 S22025
         TM    SCBSTATE,SCBLCK1N+SCBMSGLN EXTENDED LOCK          S22025
         BM    EXTEND                   BRANCH IF EXTENDED LOCK
         SPACE
         MVI   QCBLKRLN,AVTEZERO        CLEAR TO PREVENT POSSIBLE
*                                       DOUBLE POST OF LCB
         AIF   ('&GEN' EQ 'VTAM').L13C                           X03039
         CLI   LCBRSPRI,RECVPRI         RECEIVE PRIORITY        SA58984
         BNE   LOCKTEST                 BR NO, HANDLE NORMALLY  SA58984
         LR    RDCB,RQCB                SAVE QCB ADDRESS        SA58984
         LR    RSTCB,RLCB               QCB TO BE UPDATED       SA58984
         LR    RQCB,RLCB                QCB WITH SEND SCHED STCBSA58984
*                                         AT TOP OF CHAIN       SA58984
         BAL   R14,DSPUNAVR             FOR MESSAGE LOCK AND    SA58984
*                                         RECV PRIORITY, SEND   SA58984
*                                         SCHED IS ON TOP OF    SA58984
*                                         LCB STCB CHAIN OUT OF SA58984
*                                         PRIORITY ORDER. MUST  SA58984
*                                         BE REINSERTED BY PRI  SA58984
         LR    RQCB,RDCB                RESTORE QCB ADDRESS     SA58984
         L     RDCB,LCBDCBPT            RESTORE DCB REG        @OX13500
.L13C    ANOP                                                    X03039
         B     LOCKTEST            USE COMMON CODE
         SPACE
EXTEND   EQU   *
         TM    AVTDOUBL,LCBRECVN        LAST OPERATION A RECEIVE
         BZ    CHKDLY                   BRANCH IF NO            SA61773
LOCKTEST EQU   *
         TM    AVTDOUBL,LCBSENDN        WAS LAST OP A SEND     @XA09773
         BO    SENDEOT                  BRANCH-YES             @XA09773
         NI    SCBBSCFM,AVTEFF-SCBNOEOT ACTIVATE WILL NOT EOT  @XA09773
SENDEOT  EQU   *                                               @XA09773
         OC    QCBLKRRN,QCBLKRRN        IS THERE LOCK MSG
         BZ    NOLOCK                   NO
         SPACE
         AIF   ('&GEN' NE 'VTAM').LOCKMSG                        X03039
         TM    LCBSTAT3,LCBERLCK        ERROR LOCK SET           X03039
         BO    LCBTOIAF                 BR YES                   X03039
*                                                                X03039
.LOCKMSG ANOP                                                    X03039
         MVC   SCBSCHDR,QCBLKRRN        SET HEADER
         B     SENDINIT .               SEND LOCK MESSAGE       SA52971
         SPACE 2                                                 S21101
         SPACE 3                                                 S21101
NOLOCK   EQU   *
         TM    LCBSTAT2,LCBDIAL         IS THIS A DIAL LINE     OX02199
         BO    CKMIDMSG                 YES,SKIP STOPLINE TEST  OX02199
         TM    LCBSTAT1,LCBOCNI         STOPLINE IN PROGRESS    SA56606
         AIF   ('&GEN' EQ 'VTAM').BHELD                          X03039
         BO    NEXTSTCB                 YES-BRANCH              SA56606
         AGO   .MMTEST                                           X03039
.BHELD   ANOP                                                    X03039
         BO    REMOVESS                 BR YES                   X03039
.MMTEST  ANOP                                                    X03039
CKMIDMSG EQU   *                                                OX02199
         TM    SCBQTYPE,SCBBFMM .       MIDDLE OF MSG            S22025
         AIF   ('&GEN' NE 'VTAM').BDELAY                         X03039
         BO    NEXTSTCB                 BR YES                   X03039
         AGO   .TSTLGOF                                          X03039
.BDELAY  ANOP                                                    X03039
         BZ    TSTDELAY .               NO-BRANCH                S22025
         TM    QCBSTAT,QCBSEND .        QCB IN SEND MODE         S22025
         BO    SETSCERB .               YES GO SET ERB AND SCB UPS22025
*                                       FOR RECALL               S22025
         B     NEXTSTCB .               GET NEXT STCB            S22025
         AGO   .TSTDELY                                          X03039
.TSTLGOF ANOP                                                    X03039
         TM    QCBFLAG,QCBTSSES         IN TSO SESSION         @Z30X8IM
         BO    TSTDELAY                 BRANCH YES             @Z30X8IM
         TM    LCBSTAT4,LCBLGOFF        LOGOFF REQUESTED         X03039
         BO    DELAYSND                 BR YES                   X03039
.TSTDELY ANOP                                                    X03039
         SPACE 2
TSTDELAY EQU   * .                                               S22025
         TM    LCBSTAT1,LCBOCNI .       STOPLINE IN PROGRESS    OX02199
         AIF   ('&GEN' NE 'VTAM').BNSTCB                         X03039
         BO    REMOVESS                 BR YES                   X03039
*                                                                X03039
         AGO   .TSTCLOS                                          X03039
.BNSTCB  ANOP                                                    X03039
         BO    NEXTSTCB                 YES,BRANCH              OX02199
         TM    AVTBIT1,AVTDLAYN .       SYSTEM DELAY             S22025
         BO    NEXTSTCB .               BRANCH-YES               S22025
.TSTCLOS ANOP                                                    X03039
         TM    AVTBIT1,AVTCLOSN+AVTQUCKN QUICK CLOSE             S22025
         AIF   ('&GEN' NE 'VTAM').L14                            X03039
         BO    REMOVESS                 BR YES                   X03039
         AGO   .L15                                              X03039
.L14     ANOP                                                    X03039
         BO    NEXTSTCB .               QUICK CLOSE              S22025
         AIF   ('&GEN' EQ 'MINI').L16
         AIF   ('&GEN' NE 'VTAM').TSTSCHD                        X03039
.L15     ANOP                                                    X03039
*                                                                X03039
         L     RTEMP,AVTSAVTP           SECONDARY AVT ADDRESS    X03039
*                                                                X03039
         USING IEDNSVTD,RTEMP           ESTABLISH ADDRESSABILITY X03039
*                                       VTAM QUICK CLOSEDOWN     X03039
         TM    SAVTSTAT,SAVTVCLS+SAVTVQCK                        X03039
         BO    REMOVESS                 BR YES                   X03039
*                                                                X03039
         TM    LCBSTAT3,LCBERLCK        ERROR LOCK SET           X03039
         BO    LCBTOIAF                 BR YES                   X03039
*                                                                X03039
.TSTSCHD ANOP                                                    X03039
         TM    QCBSTAT,QCBSCHDL         HAS SOURCE BEEN SET FOR
*                                         CLOCK OR INTVL
         BZ    NOTDIALQ                 BR NO                    X03039
*                                                                X03039
         AIF   ('&GEN' NE 'VTAM').ACTDIAL                        X03039
         NI    QCBSTAT,AVTEFF-QCBSCHDL  RESET RCV BEFORE SEND    X03039
         B     RCVSCHED                 GO ACTIVATE RCV SCHEDULERX03039
*                                                                X03039
         AGO   .NOTDIAL                                          X03039
.ACTDIAL ANOP                                                    X03039
         LR    RTEMP,RQCB     SET FOR DIAL SCHEDULER
         LA    RSTCB,LCBRSKEY           NEXT STCB
         B     DSPBYPAS                 ACTIVATE DIAL RCV SCHED
.NOTDIAL ANOP                                                    X03039
NOTDIALQ EQU   *
         AIF   ('&GEN' NE 'VTAM').L16                            X03039
         TM    LCBBSMST,LCBRTRRO        RESP OWED TO RTR       @X50X9II
         BO    CKSSOUT                  YES-BRANCH             @X50X9II
         TM    LCBSTAT3,LCBUNSIP        UNSOLICITED INPUT RCV'D  X03039
         BO    RCVSCHED                 BR YES                   X03039
CKSSOUT  EQU   *                                               @X50X9II
         TM    LCBSTAT3,LCBSSOUT        REMOVE SS FOR SPECOUT    X03039
         BZ    GOSEND                   BR NO                    X03039
*                                                                X03039
         AGO   .VNMSGLT                                          X03039
.L16     ANOP
         TM    SCBBSCFM,SCBMLMTN        MESSAGE LIMIT REACHED
         BZ    NOLMT                    NO
         NI    SCBBSCFM,SCBMLMTF        RESET BIT
         AGO   .NEVTAM                                           X03039
.VNMSGLT ANOP                                                    X03039
DELAYSND EQU   *                                                 X03039
         LR    R5,RSTCB                 SAVE NEXT STCB ADDRESS   X03039
         LR    R6,RQCB                  SAVE QCB ADDR            X03039
         LR    RSTCB,RQCB               UNAVAIL PARAMETER        X03039
         LR    RQCB,RLCB                UNAVAIL PARAMETER        X03039
         BAL   R14,DSPUNAVR             PUT SS BACK INTO QCB     X03039
*                                                                X03039
         LR    RSTCB,R5                 RESTORE NEXT STCB ADDR   X03039
         LR    RQCB,R6                  RESTORE QCB ADDR         X03039
         MVC   QCBSTCHN,QCBSLINK        REMOVE SEND SCH FROM QCB X03039
*                                                                X03039
*   PREPARE TO PUT QCB ON THE TIME DELAY QUEUE                   X03039
*                                                                X03039
         TM    LCBSTAT3,LCBSSOUT        REMOVE SS FOR SPECOUT  @ZA03122
         BO    DELAY1                   YES, FORCE 1 SEC DELAY @ZA03122
         LH    R5,QCBINTVL              ASSUME CLOCK OR CINTVL   X03039
         N     R5,AVTCLRHI              CLEAR HI HALF            X03039
         CLI   QCBSTPRI,CLOCK           CLOCK SPECIFIED          X03039
         BNE   INTVL                    BR NO                    X03039
*                                                                X03039
         AR    R5,R5                    DOUBLE VALUE             X03039
         TIME  BIN                      GET TIME OF DAY          X03039
         SRDL  R0,HALF                  SHIFT TO REG1            X03039
         D     R0,HUND                  TIME IN SECONDS          X03039
         CLR   RTEMP,R5                 IS TIME TODAY            X03039
         BL    TODAY                    BR YES                   X03039
*                                                                X03039
         A     R5,TWNTY4HR              ADD 24 HOURS             X03039
TODAY    EQU   *                                                 X03039
         SR    R5,RTEMP                 AMOUNT OF DELAY          X03039
         B     CHKTIME                  CONTINUE CLOCK PROCESSINGX03039
*                                                                X03039
INTVL    EQU   *                                                 X03039
         CLI   QCBSTPRI,CINTVL          CINTVL SPECIFIED         X03039
         BE    CHKTIME                  BR YES                   X03039
*                                                                X03039
DELAY1   EQU   *                                               @ZA03122
         LA    R5,ONESECD               SET DELAY TO 1 SECOND    X03039
CHKTIME  EQU   *                                                 X03039
         C     R5,TWELVHR               MORE THAN 12 HOURS       X03039
         BNH   LESS12                   BR NO                    X03039
*                                                                X03039
         S     R5,TWELVHR               MAKE LESS THAN 12 HOURS  X03039
         OI    QCBSTAT,QCBTIME          INDICATE MORE THAN 12 HRSX03039
LESS12   EQU   *                                                 X03039
         STH   R5,QCBEOLDT              SET DELAY TIME           X03039
         MVI   QCBLKRLN,AVTEZERO        SET QCB INDICATOR        X03039
         LR    RTEMP,RQCB               QCB ADDR FOR TIME DELAY  X03039
         LA    R14,NEXTSTCB             SET RETURN ADDRESS       X03039
         L     R15,AVTHG01              ADDRESS OF TIME DELAY    X03039
         BR    R15                      GO PUT QCB ON TIME DELAY X03039
         AGO   .VSCHL                                            X03039
.NEVTAM  ANOP                                                    X03039
         LR    RSTCB,RLCB .             UNAVAIL PARAMETER        S21101
         LR    RQCB,RLCB .              RESTORE QCB ADDR         S22025
         B     POSTIT .                 POST LCB TO ITSELF       S21101
         SPACE 2                                                 S21101
NOLMT    EQU   *                                                 S21101
         TM    QCBELCHN+2,QCBCNTEN      CONTENTION,RVI,OR OTHER@OX17153
*                                         BUFFER BUSY CONDITION  S21101
         BZ    NOTBUSY .                BRANCH IF NO             S21101
         NI    QCBELCHN+2,AVTEFF-QCBCNTEN RESET CONTENTION BIT @OX17153
         L     RSTCB,QCBSLINK-1         GET NEXT STCB
         CLI   STCBPRI-IEDQSTCB(RSTCB),0   QEVENT NEXT
         BE    CHKDLY                   BRANCH-YES GO RCV      @OY14503
         B     NEXTSTCB                 TRY TO SEND TO NEXTTERM@OY14503
*                                         RECEIVE SCHEDULER      S21101
.VSCHL   ANOP                                                    X03039
         SPACE
CHKDLY   EQU   *                                                SA61773
         TM    LCBINSRC+2,DELAY         IN DELAY Q
         BNZ   NEXTSTCB                 YES DISPATCH
RCVSCHED EQU   *                                                SA61773
         LA    RSTCB,LCBRSKEY           RCV SCHED STCB          SA61773
NEXTSTCB EQU   *                                                SA61773
         AIF   ('&GEN' NE 'VTAM').NORMVSS                        X03039
         NI    LCBSTAT3,AVTEFF-LCBSSOUT RESET REMOVE SS BIT      X03039
.NORMVSS ANOP                                                    X03039
         LR    RTEMP,RLCB               SET ELEMENT REG         SA61773
         LR    RQCB,RLCB                SET QCB REG             SA61773
         B     DSPBYPAS                 BYPASS                  SA61773
         SPACE 3                                                 S21101
         AIF   ('&GEN' NE 'VTAM').NOTBUSY                        X03039
*                                                                X03039
LCBTOIAF EQU   *                                                 X03039
         MVC   LCBSTAT1,AVTDOUBL        RESTORE PREVIOUS STATUS  X03039
         L     RTEMP,AVTSAVTP           SECONDARY AVT ADDRESS    X03039
         LA    RTEMP,SAVTLCWQ           LCCW GEN'R QCB ADDRESS   X03039
         STCM  RTEMP,AD,LCBQCBA         PUT QCB ADDR IN LCB      X03039
         LR    RTEMP,RLCB               SET LCB AS ELEMENT       X03039
         B     DSPPOST                  POST LCB TO LCCW GEN'R   X03039
*                                                                X03039
         AGO   .VSEND                                            X03039
.NOTBUSY ANOP                                                    X03039
NOTBUSY  EQU   *                                                 S21101
         MVC   AVTDOUBL+1(1),SCBBSCFM   SAVE FLAGS              SA59034
         AIF   ('&GEN' EQ 'MINI').L17
         TM    LCBSTAT2,LCBDIAL+LCBSYNC DIAL BSC
         BNO   NOBSD                    BRANCH IF NOT BSC DIAL
         SPACE
         CLI   LCBTSTSW,AVTEFF          WAS THERE HARD ERROR INA
*                                         PREVIOUS SELSECTION
         MVC   LCBSENS0(2),AVTDOUBL                            @OX12563
         BE BSDIAL                      BRANCH IF YES
************************************************************** @ZA03063
*                                                            * @ZA03063
*        SCBNOEOT IS USED TO CONTROL QUEUE FLUSH FOR BSC     * @ZA03063
*        DIAL WITH SEND PRIORITY. SCBNOEOT IS ALSO USED TO   * @ZA03063
*        FORCE A RECEIVE OPERATION AFTER TCAM HAS SENT AN    * @ZA03063
*        EOT. THIS IS REQUIRED FOR ALL BSC DIAL OPERATIONS.  * @ZA03063
*        IT IS SET ON EVERY RECEIVE OPERATION AND RESET ON   * @ZA03063
*        THE FIRST SEND AFTER A RECEIVE. LINE END APPENDAGE  * @ZA03063
*        WILL TURN ON SCBNOEOT AND NOT SEND AN EOT FOR BSC   * @ZA03063
*        DIAL WITH SEND PRIORITY. LINE END APPENDAGE RESETS  * @ZA03063
*        SCBNOEOT WHENEVER IT SENDS AN EOT, FOR EXAMPLE ON A * @ZA03063
*        MSGGEN.                                             * @ZA03063
*                                                            * @ZA03063
************************************************************** @ZA03063
         TM    SCBBSCFM,SCBNOEOT        TCAM SEND AN EOT       @ZA03063
         BZ    GORCV                    BRANCH IF YES          @ZA03063
         NI    SCBBSCFM,AVTEFF-SCBNOEOT INDICATE EOT SENT      @ZA03063
         TM    AVTDOUBL,LCBSENDN        LAST OPERATION A SEND  @ZA03063
         BZ    GOSEND                   BRANCH IF NO           @ZA03063
         OI    SCBBSCFM,SCBNOEOT        INDICATE EOT NOT SENT  @ZA03063
         CLI   LCBRSPRI,SENDPRI         SEND PRIORITY          @ZA03063
         BE    GOSEND                   BRANCH IF YES          @ZA03063
GORCV    EQU   *                                               @ZA03063
         OI    SCBBSCFM,SCBNOEOT        INDICATE EOT NOT SENT  @ZA03063
         NI    LCBSTAT2,AVTEFF-LCBNEGRP FORCE THE ADDITIONAL   @ZA03063
*                                       RECEIVE OPERATION      @ZA03063
*                                       REQUIRED BY BSC DIAL   @ZA03063
*                                       ARCHITECTURE           @ZA03063
         B     RCVSCHED                 GO RECEIVE             @ZA03063
NOBSD    EQU   *
         AIF   ('&GEN' EQ 'NTSO').L17A
         TM    QCBDSFLG,QCBDISK+QCBCORE NON-TSO QUEUES              TSO
         BZ    GOSEND                   BRANCH ON NO                TSO
         TM    QCBFLAG,QCBTSSES         TIME-SHARING SESSION?    S22029
         BO    GOSEND                   YES, START SEND OPRATION S22029
.L17A    ANOP
         CLI   LCBTSTSW,AVTEFF          REQUEST FOR NEW CONNECTION
         BNE   GOSEND                   BRANCH IF NO
BSDIAL   EQU   *
         L     RTEMP,DCBDEBAD           DEB ADDRESS            @OX13500
         USING DEBNMSUB,RTEMP           ADDRESSABILITY         @OX13500
         TM    DEBOPATB,OUTONLY         OUTPUT ONLY DEVICE?    @OX13500
         BO    GOSEND                   YES WE WANT TO SEND    @OX13500
         DROP  RTEMP                                           @OX13500
         CLI   QCBSTPRI,CALLPRI         CALL=NONE
         BE    TRMHELD                  BRANCH IF YES - THIS IS@OY12969
*                                         POSSIBLE IF HARD ERROR ON
*                                         PREVIOUS ATTEMPT TO SEND
.VSEND   ANOP                                                    X03039
GOSEND   EQU   *
         AIF   ('&GEN' EQ 'NTSO').L17
         TM    AVTBIT1,AVTTSON          IS IT TIME SHARING?         TSO
         BZ    TSO3                     BRANCH ON NO                TSO
         L     R6,AVTTSOPT              GET ADDRESS OF TSINPUT QCB  TSO
         AIF   ('&GEN' EQ 'VTAM').VTSO                         @Z30X8IR
         L     R6,TSISCHED-IEDQTSI(R6)  ADDRESS OF TS SCHEDULER     TSO
         BAL   RWORK,12(,R6)            BRANCH TO ROUTINE           TSO
         AGO   .SEND                                           @Z30X8IR
.VTSO    ANOP                                                  @Z30X8IR
         L     R6,TSIRNSCH-IEDQTSI(,R6) VTAM TSO SCHED ADDR    @Z30X8IR
         LA    RSELECT,FOUR             INDEX TO IEDA20 ENTRY  @Z30X8IR
*                                         PT OF VTAM TSO SCHED @Z30X8IR
         BALR  RRTN,R6                  BRANCH TO VTAM TSO     @Z30X8IR
*                                         SCHED,IEDAYG         @Z30X8IR
.SEND    ANOP                                                  @Z30X8IR
         B     TSO4                     PUT SEND SCHED IN QCB       TSO
         B     SENDPREP                 GO TO START SENDING.        TSO
TSO3     EQU   *                                                    TSO
.L17     ANOP
         AIF   ('&GEN' EQ 'VTAM').VHELD                          X03039
         TM    QCBFLAG,QCBTERMQ         QUEUED BY TERMINAL?
         BZ    NOTRMQ                   BRANCH IF NOT
         SPACE 2
.VHELD   ANOP                                                    X03039
         TM    QCBSTAT,QCBTRMHO         HAS TERMINAL BEEN INTERCEPTED
         BO    TRMHELD                  BRANCH IF  TERMINAL WAS HELD
*                                         TO AVOID GETTING MSG OFF QUE
         SPACE 2
NOTRMQ   EQU   *
         AIF   ('&GEN' EQ 'NTSO' OR '&GEN' EQ 'MINI').MIX0010    S22029
         TM    QCBDSFLG,QCBTSQ          TIME-SHARING QUEUEING    S22029
         BO    NOINIT                   YES. SKIP SENDING INIT   S22029
*                                       MODE MSGS.               S22029
.MIX0010 ANOP                                                    S22029
         AIF   ('&GEN' NE 'VTAM').NOSAVE                         X03039
         LR    R5,RSTCB                 SAVE NEXT STCB ADDR      X03039
.NOSAVE  ANOP                                                    X03039
         L     RSTCB,QCBINSRC-1   GET INITIATE SOURCE LCB CHAIN
         N     RSTCB,CLEAR              CLEAR LOW ORDER BYTE
         LA    RQCB,0(,RQCB)            CLEAR HI ORDER BYTE
         CLR   RSTCB,RQCB               INITIATE MODE
         AIF   ('&GEN' EQ 'VTAM').VINIT                          X03039
         BE    NOINIT                   NO
         AGO   .NVINIT                                           X03039
.VINIT   ANOP                                                    X03039
         BE    RSTRSTCB                 BR NO                    X03039
.NVINIT  ANOP                                                    X03039
         MVC   QCBINSRC(3),LCBINSRC-IEDQLCB(RSTCB) REMOVE LCB FROM
*                                      INITIATE CHAIN
         NI    LCBINSRC+2-IEDQLCB(RSTCB),X'FF'-LCBNSRCD TURN OFF
*                                      INITIATE FLAG
         STCM  RLCB,AD,LCBINSRC-IEDQLCB(RSTCB) DEST LCB INTO SRCSA62953
         L     RSTCB,LCBSCBA-1-IEDQLCB(RSTCB) SOURCE SCB
         MVC   SCBSCHDR,SCBDCHDR-IEDQSCB(RSTCB)  LOAD SOURCE SCB
         TM    QCBDSFLG,QCBREUS+QCBNREUS  DISK
         BNZ   MOVER                    YES
         MVC   SCBSCHDR,SCBCCHDR-IEDQSCB(RSTCB)   PARAMETER
MOVER    EQU   *
         MVI   SCBPRI,AVTEZERO          RESET PRIORITY           A
         OI    LCBSTAT1,LCBSENDN+LCBINITN SET LCB STATE
         B     SENDINIT                 SEND MSG
         SPACE 3                                                 S21101
         AIF   ('&GEN' NE 'VTAM').NRESTR                         X03039
RSTRSTCB EQU   *                                                 X03039
         LR    RSTCB,R5                 RESTORE NEXT STCB ADDR   X03039
.NRESTR  ANOP                                                    X03039
NOINIT   EQU   *
         TM    QCBDSFLG,QCBHELD         IS FEFO CHAIN BEING CHANGED
*                                         BY REUS IN DISABED CODE
         BO    TRMHELD                  BRANCH YES, TO REMOVE STCB.
*                                         WILL BE RE-INSERTED LATER
         SPACE
         SR    R0,R0                    CLEAR COUNT REGISTER
         LA    RTEMP,IEDQQCB+QCBMSIZE-QCBPSIZE INITIALIZE SCAN FOR
*                                      LOOP
SCANLOOP EQU   *
         LA    RTEMP,QCBPSIZE(0,RTEMP) BUMP TO NEXT PRIORITY QCB
         MVC   SCBSCHDR-IEDQSCB(3,RLAST),QCBFFEFO-IEDQPQCB(RTEMP)
*                                      NEXT FEFO MESSAGE
         OC    QCBFFEFO-IEDQPQCB(3,RTEMP),QCBFFEFO-IEDQPQCB(RTEMP) IS
*                                      THERE AN UNSENT FEFO MESSAGE
         BNZ   PREPARE            YES, GO PREPARE SCB
         BCTR  R0,R0                    BUMP COUNT
         CLI   QCBPRIPQ-IEDQPQCB(RTEMP),0 LAST PRIORITY QCB
         BNE   SCANLOOP           NO, LOOK AT NEXT ONE
         AIF   ('&GEN' EQ 'MINI').L19
         MVI   QCBPRLVL,AVTEZERO .      RESET HIGHEST PRIORITY LES21101
*                                         MESSAGE INDICATOR FOR DS21101
*                                         LINES.  HM WILL INDICATS21101
*                                         HIGHEST LEVEL IN USE   S21101
.L19     ANOP                                                    S22025
TRMHELD  EQU   * .                                               S22025
         AIF   ('&GEN' EQ 'VTAM').VRMOVSS                        X03039
         MVC   SCBBSCFM,AVTDOUBL+1      RESTORE FLAGS           SA59034
         AIF   ('&GEN' EQ 'MINI').L19A                           S22025
         LA    RSTCB,LCBRSKEY           RCV SCHED STCB
         LR    RTEMP,RQCB               SET ELEMENT FOR DIAL RCV SN
         CLI   QCBSTPRI,CALLOPT         THIS CLOCK OR INTVL
         BNL   DSPBYPAS                 YES TO RESET DELAY
         AGO   .NRMOVSS                                          X03039
.VRMOVSS ANOP                                                    X03039
REMOVESS EQU   *                                                 X03039
         NI    LCBSTAT3,AVTEFF-LCBSSOUT RESET REMOVE SS BIT      X03039
.NRMOVSS ANOP                                                    X03039
         SPACE 3                                                 S21101
.L19A    ANOP                                                    S22025
         AIF   ('&GEN' EQ 'MINI' OR '&GEN' EQ 'NTSO').L18
TSO4     EQU   *                                                    TSO
.L18     ANOP
         LA    RSTCB,LCBSTCBA-(STCBLINK-IEDQSTCB)               SA56606
*                                       SET REG                 SA56606
STCBLP   EQU   *                                                SA56606
         LR    RTEMP,RSTCB              SAVE PREVIOUS STCB      SA56606
         L     RSTCB,STCBLINK-IEDQSTCB-1(RSTCB)                 SA56606
*                                       LOAD NEXT STCB          SA56606
         LA    R0,QCBSTVTO-IEDQQCB      STCB OFFSET             SA56606
         LR    RWORK,RSTCB              SET REG                 SA56606
         LA    RWORK,ZERO(,RWORK)       CLEAR HO BYTE           SA56606
         SR    RWORK,R0                 QCB ADDR                SA56606
         CLR   RWORK,RQCB               CORRECT QCB             SA56606
         BNE   STCBLP                   BRANCH IF NO            SA56606
         SH    RTEMP,AVTHA4             SET REG                 SA56606
         LR    RSTCB,RQCB               UNAVAIL REG             SA56606
         LR    RQCB,RTEMP               UNAVAIL REG             SA56606
POSTIT   EQU   *                                                 S21101
         BAL   R14,DSPUNAVR .           REMOVE STCB              S22025
         AIF   ('&GEN' EQ 'VTAM').VNMGLMT                        X03039
         MVI   SCBSNDCT,AVTEZERO .      RESET SEND LIMIT COUNT   S21101
.VNMGLMT ANOP                                                    X03039
         LR    RTEMP,RLCB               SET LCB TO BE QPOST'ED
         ST    RTEMP,LCBQCBA-1          GO QPOST
         B     DSPPOST            GO QPOST
         SPACE 1
PREPARE  EQU   *
         LPR   R0,R0                    MAK COUNT POSITIVE
         STC   R0,SCBPRI-IEDQSCB(,RLAST)  SET PRIORITY LEVEL INDEX
         AIF   ('&GEN' EQ 'MINI').L21                            S21101
         STC   R0,QCBPRLVL .            SET HIGHEST LEVEL MSG IN S21101
.L21     ANOP                                                    S21101
SENDINIT EQU   *                                               @SA72478
         XC    SCBFEFO,SCBFEFO          CLEAR FOR PRIORITY LEVEL
*                                         MESSAGES
         OI    QCBFLAG,QCBSDFFO         SET AS SENDING A MESG   SA52971
SENDPREP EQU   *
         NI    LCBERBST,AVTEFF-LCBDLNKN . RESET DLINK SWITCH     S22025
         NI    LCBSTAT2,AVTEFF-LCBSNDPR RESET SEND PRIORITY    @OY12395
         STCM  RQCB,AD,SCBDESTQ-IEDQSCB(RLAST) SET QCB ADDRESS   Y01948
         MVC   SCBSCSEG(3),SCBSCHDR .   SET SCB SEG              S22025
         MVI   SCBUNTCT,AVTEZERO .      SET UNIT COUNT TO BUILD  S22025
*                                       FROM BEGINNING OF BUFFER S22025
COMMON1  EQU   *                                                 S22025
         XC    LCBRECAD,LCBRECAD .      CLEAR Q RECORD ADDRESS   S22025
         XC    LCBRECOF,LCBRECOF .      ALSO OFFSETR FOR LINEEND S22025
         AIF   ('&GEN' EQ 'VTAM').VSPOUT                         X03039
         TM    LCBSTAT2,LCBDIAL                                 SA60792
         BO    NORESET                                          SA60792
         NC    LCBTTCIN,LCBTTCIN        CONNECTED TERMINAL ?    SA69635
         BNZ   NORESET                  YES, BR-LEAVE AS IS     SA69635
         MVI   LCBTTCIN+ONE,ONE                                 SA60792
NORESET  EQU   *
.VSPOUT  ANOP                                                    X03039
         AIF   ('&GEN' NE 'VTAM').SETERB                         X03039
         TM    LCBSTAT3,LCBSPOUT        SPECOUT PROCESSING       X03039
         BZ    BUILDERB                 BR NO                    X03039
*                                                                X03039
         OI    LCBSTAT3,LCBNLOUT        REQUEST NULL WRITE       X03039
BUILDERB EQU   *                                                 X03039
.SETERB  ANOP                                                    X03039
         MVI   LCBERBPY,PRIINTRQ        INITIAL REQUEST PRIORITY
         L     RDCB,LCBDCBPT            DCB BASE
         MVC   LCBRBCT1,DCBBUFOU        REQUEST BUFOUT           X03039
         NI    LCBRBCT1,X0F             CLEAR 1ST 4 BITS         X03039
         MVI   LCBRBCT2,AVTEZERO        ZERO DISABLED COUNT      X03039
COMMON   EQU   *                                                 S22025
         LA    RTEMP,AVTDSIOB .         GET DISK I/O QCB ADDRESS S22025
COMMON2  EQU   *                                                 S22025
         ST    RTEMP,LCBERB .           SET TO POST ERB TO IT    S22025
         LA    RTEMP,LCBERB             ADDR OF ERB              S22025
         B     DSPPOST            GO QPOST ERB TO DISK READ ROUTINE
         AIF   ('&GEN' EQ 'VTAM').EQUATES                        X03039
         SPACE 7                                                 S21101
         EJECT                                                   S22025
SETSCERB EQU   * .                                               S22025
         TM    SCBQTYPE,SCBCOREQ .      CORE QUEUEING            S22025
         BO    GOCORE .                 YES-BR                   S22025
         TM    SCBSTAT1,PRFNLSTN  .     EOM BUFFER               S22025
         BO    NOTALL .                 BRANCH IF NO             S22025
         CLC   SCBDEOB+1(3),SCBCRCD .   SENDING LAST SEGMENT     S22025
         BNL   GOCORE                                           SA60792
         NC    SCBXTRA(THREE),SCBXTRA                           SA60792
         BZ    RSET                                             SA60792
         CLC   SCBDEOB+ONE(THREE),SCBXTRA                       SA60792
         BNL   GOCORE                                           SA60792
RSET     EQU   *                                                SA60792
         OI    SCBSTAT1,PRFNLSTN .      FLAG NOT LAST            S22025
NOTALL   EQU   * .                                               S22025
         XC    SCBXTRA(3),SCBXTRA .     CLEAR FOR RECALL         S22025
         XC    SCBNTXT(3),SCBNTXT .     CLEAR FOR RECALL         S22025
GOCORE   EQU   *                                                 S22025
         MVZ   SCBHBFNO,SCBQTYPE        SET QTYPE FLGS FOR FA   SA52971
         MVC   LCBCPA(4),SCBDEOB .      SAVE ACROSS RECALL       S22025
         MVC   LCBCPA+4(3),SCBTRANS .   SAVE SCB TRANS ACROSS RCLS22025
         MVI   LCBERBPY,PRIDKEOB .      RECALL PRIORITY          S22025
         MVI   LCBERBCT,1 .             RECALL BUFFER COUNT      S22025
         MVI   LCBERBCT+1,AVTEZERO .    CLEAR DISABLED COUNT     S22025
         OI    LCBSTAT1,LCBRCLLN .      SET RECALL BIT IN LCB    S22025
         LA    R0,ERBRETRN .            RETURN ADDR FOR ERB      S22025
         ST    R0,LCBRCQCB .            IN LCB                   S22025
         B     COMMON                   GO POST ERB              S22025
         SPACE 3                                                 S22025
         DS    0F .                     WORD BOUNDARY            S22025
ERBRETRN EQU   *-8 .                    QCB                      S22025
         DC    AL1(DSPMCPL4),AL3(*-1) . STCB THAT GETS CONTROL   S22025
*                                       WHEN ERB FOR RECALL IS   S22025
*                                       POSTED BACK TO R4 WHEN   S22025
*                                       READ IS DONE             S22025
         USING *,R15                                           @OY19438
         L     RBASE,BASE               LOAD BASE REGISTER     @OZ24185
         DROP  R15                                             @OY19438
         USING TAG,RBASE                                       @OY19438
         LA    RWORK,LCBERB-IEDQLCB .   ERB OFFSET INTO LCB      S22025
         SR    RTEMP,RWORK .            COMPUTE LCB ADDRESS      S22025
         LR    RLCB,RTEMP .             LCB ADDR                 S22025
         L     RLAST,LCBSCBA-1 .        SCB ADDRESS              S22025
         L     RTEMP,LCBERBCH-1 .       RECALLED BUFFER ADDRESS  S22025
         OI    PRFSTAT1-IEDQPRF(RTEMP),PRFCNCLN . SET CNCL FLG   S22025
         MVC   LCBISZE(1),PRFSCAN+1-IEDQPRF(RTEMP) . SET IDLES CTS22025
         MVC   LCBTTBIN,SCBDCHDR .      SETUP TNTOFFSET          S22025
         LA    RTEMP,AVTINOUT .         INMSG/OUTMSG DELIMITER   S22025
         STCM  RTEMP,AD,SCBMACR         RESET MACRO ADDRESS      Y01948
         MVC   SCBUNTCT(1),SCBDEOB .    SET UNIT COUT            S22025
         MVC   SCBDEOB(4),LCBCPA .      RESTORE DEOB OFTER RECALLS22025
         MVC   SCBTRANS(3),LCBCPA+4 .   RESTORE SCB TRANS        S22025
         NI    SCBHBFNO,CLEAR0F         RESET HBFNO              S22025
         LA    RTEMP,AVTACTIB .         ACTIVATE ROUTINE QCB ADDRS22025
         L     RQCB,SCBDESTQ-1 .        PICK UP QCB ADDR         S22025
         NI    SCBQTYPE,AVTEFF-SCBBFMM .RESET MIDDLE OF MSG BIT  S22025
         NI    QCBSTAT,AVTEFF-QCBSEND .RESET QCB SEND BIT        S22025
         NI    LCBSTAT1,AVTEFF-LCBRCLLN RESET RECALL BIT         S22025
         TM    LCBERBST,LCBEOMSG .      EOM IN RECALLED BUFFER   S22025
         BO    COMMON2                  GO POST ERB              S22025
         B     COMMON1                  GO POST ERB              S22025
BASE     DC    A(TAG)                   BASE ADDRESS CONSTANT  @OZ24185
.EQUATES ANOP                                                    X03039
         EJECT
*                                 OTHER EQUATES
         SPACE 1
AUTOPOLL EQU   X'01'              INVITATION LIST IS CURRENTLY BEING
*                                      AUTOPOLLED
CLOSEDWN EQU   X'01'                    LINE STOPPED BY        @SA71683
*                                        CLOSEDOWN             @SA71683
ZERO     EQU   0                                                 S99228
ONE      EQU   1                        CONSTANT OF ONE         SA60792
THREE    EQU   3                        CONSTANT OF THREE       SA60792
TWO      EQU   2                                                 S99228
AD       EQU   7                        MASK FOR STCM OF ADDRESS Y01948
CALLOPT  EQU   X'70'                    MASK STCB PRI DIAL UP
*                                         CLOCK OR INTVL
XB0      EQU   X'B0'                    MASK FOR 1ST TIME SWITCH X03039
SENDPRI  EQU   X'20'                    MASK FOR SEND PRIORITY
CONNECT  EQU   X'80'                    MASK FOR DIAL CONNECTION
CALLPRI  EQU   X'50'                    PRIORITY OF DIAL SEND WITH
*                                         CALL=NONE
DELAY    EQU   X'02'                    MASK FOR LCB IN DELAY Q
STATUS   EQU   X'03'              OFFSET OF STATUS INFORMATION IN
*                                      INVITATION LIST
*                                      FOR OUTPUT
NOP      EQU   X'03'              NO-OP CHANNEL COMMAND CODE
TIC      EQU   X'08'              TIC CHANNEL COMMAND CODE
OPEN     EQU   X'10'              DCB FLAG INDICATING LINE GROUP OPEN
SENSE    EQU   X'FF'              VALUE SET IN SENSE BYTE OF COMMAND
*                                      FOLLOWING PREPARE ON CONTENTION
*                                      TERMINALS
F0       EQU   X'F0'                    DIAL CONNECTION AND NO DIAL
X0F      EQU   X'0F'                    MASK USED FOR INITIAL BUFF
X12      EQU   X'12'                                               2741
POLL     EQU   X'09'                    POLL COMMAND
LCBNSRCD EQU   X'01'                    FLAG FOR INITIATE MODE
ERPCTL   EQU   X'24'                    BITS IN LCBFLAG1-ERP IS IN
*                                         CONTROL
LINEADD  EQU   4                        OFFSET IN UNCB-LINE ADDRESS
SENSMASK EQU   X'FF'                    VALUE OF SENSE FIELD IN
*                                         LCB BEFORE SENSE
AIBM1    EQU   X'1F'                                                TSO
T1050    EQU   X'51'                                                TSO
T2741B   EQU   X'56' .                                              TSO
T2741C   EQU   X'55' .                                              TSO
RECVPRI  EQU   X'80'                    LCB RECV PRI VALUE      SA58984
         AIF   ('&GEN' NE 'VTAM').NVTAM                          X03039
ONESECD  EQU   1                        ONE SECOND DELAY         X03039
FOUR     EQU   4                        IEDAYG ENTRY PNT INDEX @Z30X8IR
WORD2    EQU   4                        OFF TO 2ND WORD OF SAVE  X03039
HALF     EQU   32                                                X03039
LUINIT   EQU   X'50'                    TCMSESN=LUINIT (FOR LU)@XM10739
NOCALL   EQU   X'50'                    CALL=NONE SS PRIORITY    X03039
CINTVL   EQU   X'70'                    CHECK CINTVL SPECIFIED   X03039
CLOCK    EQU   X'80'                    CHECK CLOCK SPECIFIED    X03039
LXC      EQU   X'1B'                    VTAM LCCW RESET COND'L   X03039
*                                       OP CODE                  X03039
.NVTAM   ANOP                                                    X03039
HIOCC    EQU   X'48'                    IOHALT COMPLETION CODE   Y02027
         SPACE 1
         AIF   ('&GEN' EQ 'MINI').L20
         AIF   ('&GEN' NE 'VTAM').DOCQAD                         X03039
HUND     DC    F'100'                   ONE HUNDRED              X03039
TWELVHR  DC    F'43200'                 NUMBER SECONDS IN 12 HRS X03039
TWNTY4HR DC    F'86400'                 NUMBER SECONDS IN 24 HRS X03039
         AGO   .VCLEAR                                           X03039
.DOCQAD  ANOP                                                    X03039
DOCQAD   DC    AL2(LCBFLAG1-IEDQLCB+12) CONSTANT TO OBTAIN CALL Q
.L20     ANOP
LCBSIZE  DC    AL2(LCBFLAG1-IEDQLCB)    SIZE OF LCB FROM RCB TO IOB
.VCLEAR  ANOP                                                    X03039
CLEAR    DS    0F
         DC    X'00FFFFFC'
         AIF   ('&GEN' EQ 'VTAM').VDSECTS                        X03039
CLRLOW   DS    0F                                              @OS77835
         DC    X'00FFF000'              CLEAR FOR ADDRESS TRANS@OS77835
CLRHI    DC    X'00000FFF'              CLEAR FOR ADDR TRANS   @OS77835
DISDLEOT EQU   X'01'                    FLAG TO WRITE DLE EOT
OUTPUT   EQU   X'01'                    DEB MASK OPEN OUTPUT
OUTONLY  EQU   X'03'                    OUTPUT ONLY DEVICE FLAG@OX13500
         AGO   .DSECTS                                           X03039
.VDSECTS ANOP                                                    X03039
         EJECT
         IFGACB                                                  X03039
         EJECT
         TLGBD                                                   X03039
         EJECT
.DSECTS  ANOP                                                    X03039
         TPRIOR
         TAVTD
         TPRFD
         DCBD  DSORG=TX
         TDISPD
         TLCBD
         TQCBD
         TSCBD
         TSTCBD
         TTRMD
         TTSID                                                      TSO
         TCCWD
         TDEBD
         MEND

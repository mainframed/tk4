VTVAL    TITLE 'S U B V T V A L  ***  GET FMT4 VALUES FOR UCB'
         COPY  OPTIONGB
         SPACE 1
         SYSPARM LIST=YES
         SPACE 1
         PRINT &PRTSOR
SUBVTVAL PGMHEAD ZERO15,BASE=R12,AM=ANY,RM=ANY,PARM=R3
         USING UCBOB,R3                                         GP13007
         TM    UCBID,X'CC'   REAL OR COPIED UCB ?
         BNO   PGMEXIT       NEITHER; FAIL
         LA    R6,DVCTYPMK   GET TYPE MASK
         N     R6,UCBTBYT1   RETAIN ONLY TBYT4
         BAL   R9,DVTBLOC    GET DEVICE TABLE ENTRY
         CH    R15,=H'8'     VALID ?
         BNL   PGMEXIT       NO, RETURN ALL ZEROES
         USING DVCT,R6       DECLARE DEVICE CHARACTERISTICS
         SPACE 1
         XC    STARLING,STARLING  CLEAR LIST, JUST IN CASE
         TRKCALC FUNCTN=TRKCAP,DEVTAB=(R6),REGSAVE=YES,R=1,K=44,DD=96, *
               MF=(E,STARLING)
         BXH   R15,R15,PGMEXIT
         STC   R0,RSNCODE+2
         TRKCALC FUNCTN=TRKCAP,DEVTAB=(R6),REGSAVE=YES,R=1,K=8,DD=256, *
               MF=(E,STARLING)
         BXH   R15,R15,PGMEXIT
         STC   R0,RSNCODE+3
         SPACE 1
         MVC   RETCODE+2(2),DVCTRKLN   RAW TRACK SIZE
         ICM   R0,3,DVCTRK             TRACKS PER CYLINDER
         ICM   R14,12,UCBVTOC          GET VTOC F4 ADDRESS
         SRDL  R14,16+32               PREPARE FOR DIVIDE
         DR    R14,R0                  TRACKS / CYLINDER
         STCM  R15,12,RR1CODE          SET CYLINDER ADDRESS
         STH   R14,RR1CODE+2             AND TRACK
PGMEXIT  PGMEXIT COPYRET=(RETCODE,12)  RETURN R15, R0, R1
         SPACE 2
*---------------------------------------------------------------------*
*   SUBROUTINE TO LOCATE DEVICE TABLE ENTRY                           *
*---------------------------------------------------------------------*
         SPACE 1
DVTBLOC  SR    R4,R4         CLEAR FOR TEST OFFSET
DVTBLOCN LTR   R5,R6         COPY AND TEST DEVICE INDEX
         BNP   DVTBLOCM      MAJOR ERROR
         CH    R5,=Y(DVCTYPMK)  IN RANGE OF VALID DEVICES ?
         BH    DVTBLOCM      NO; FAIL IT
*        THIS CRUTTY CODE IS REQUIRED TO TEST IF THE SUB-TYPE IS
*        PRESENT IN THE SYSTEM (ALTERNATIVE IS A LOOP THROUGH THE
*        UCBS AND A DEVICE COMPARE)
*
         L     R6,CVTPTR     GET THE CVT
         L     R6,CVTZDTAB-CVTMAP(,R6)  GET THE DASD DEVICE TABLE
         USING DVCTI,R6      DECLARE THE DVCT INDEX MAPPING
         LA    R14,DVCTIOFF  POINT TO FIRST OFFSET FIELD
         LR    R15,R5        NUMBER OF DESIRED ENTRY
         B     DVTBLOTU      SKIP FIRST BYTE (GARBAGE ?)
DVTBLOTL CLI   0(R14),0      FILLER BYTE ?
         BE    DVTBLOTU      YES; SKIP IT
         CLM   R5,1,DVCTIOFF-DVCTI(R14)  OFFSET LOWER THAN TYPE ?
         BNL   DVTBLOTN      YES; DEVICE NOT IN SYSTEM
DVTBLOTU LA    R14,1(,R14)
         BCT   R15,DVTBLOTL  TRY NEXT ENTRY
         IC    R4,DVCTIOFF(R5)  GET CORRESPONDING OFFSET FOR THIS
         LTR   R4,R4         FILLER ENTRY ?
         BNZ   DVTBLOTS      NO; USE IT
DVTBLOTN LA    R6,LOCZDTAB   POINT TO LOCAL TABLE
         SLL   R5,1          DOUBLE (LOCAL IS AL2)
         LA    R5,DVCTIOFF(R5)
         ICM   R4,3,0(R5)    LOAD OFFSET
         BNP   DVTBLOCM      NO; ERROR
         LA    R15,4         RETURN UNSUPPORTED, BUT VALID DEVICE
DVTBLOTS AR    R6,R4         POINT TO DEVICE ENTRY
         BR    R9            RETURN TO CALLER
DVTBLOCM LA    R15,12        SET MAJOR ERROR
         BR    R9            RETURN TO CALLER
         SPACE 1
         LTORG ,
         SPACE 1
         IHADVCT ,           DEVICE TABLE
DVZNOCYL EQU   X'80'         DVCFLAGS: CYL # INVALID (3340)
         AIF   (&MVSSP).HAVMODU
DVCMODU  EQU   X'10'         DVCFLAGS - MODULO DEVICE
DVCMOD1  EQU   DVCBPSEC+2,2,C'A'  MODULUS
DVCOVH1  EQU   DVCBPSEC+4,2,C'A'  OVERHEAD VALUE 1
DVCOVH2  EQU   DVCBPSEC+6,2,C'A'  OVERHEAD VALUE 2
.HAVMODU SPACE 1
SAVE     DSECT ,
         SERVDEFS ,
         SPACE 1
STARLING SERVCALC MF=L       MAP THE TRKCALC PARM LIST
SAVEEND  EQU   *
SUBVTVAL CSECT ,             RESTORE MAIN CONTROL SECTION
         PRINT NOGEN
         SPACE 2
*   COPY OF DEVICE CHARACTERISTICS IN CASE THEY AREN'T IN THE
*   RUNNING SYSTEM.
*
LOCZDTAB DC    AL2(0,0,0,0)       UNSUPPORTED TYPES 0-3
         AIF   (&MVS).NEWDEV                                    GP09116
         DC    AL2(0)                  2302                04
         AGO   .COMDEV
.NEWDEV  DC    AL2(DVZ9345-LOCZDTAB)   9345                04
.COMDEV  DC    AL2(0)             UNSUPPORTED TYPES 5
         DC    AL2(DVZ2305A-LOCZDTAB)  2305-1              06
         DC    AL2(DVZ2305B-LOCZDTAB)  2305-2              07
         DC    AL2(DVZ2314-LOCZDTAB)   2314                08
         DC    AL2(DVZ3330-LOCZDTAB)   3330 SINGLE         09
         DC    AL2(DVZ3340-LOCZDTAB)   3340                0A
         DC    AL2(DVZ3350-LOCZDTAB)   3350                0B
         DC    AL2(DVZ3375-LOCZDTAB)   3375                0C
         DC    AL2(DVZ333D-LOCZDTAB)   3330 DOUBLE         0D
         DC    AL2(DVZ3380-LOCZDTAB)   3380                0E
         DC    AL2(DVZ3390-LOCZDTAB)   3390                0F
*        DC    (DVCTYPMK-*-LOCZDTAB+1)AL2(0)      ---SPARES---   10-1F
         DC    (31-15+1)AL2(0)
         SPACE 1
*                 CYL TRK LEN OHDNKFG TOL ALT  R0TSDS B/S MOD
*        DC    CL6'2311'
*VZ2311  DC    X'00CB000A0E29511414010219001E'
*        DC    CL6'2301'
*VZ2301  DC    X'000100C85003BA35350002000000'
*        DC    CL6'2303'
*VZ2303  DC    X'0050000A131C9226260002000000'
*        DC    CL6'2302'
*VZ2302  DC    X'00FA002E137851141401021900C8'
*        DC    CL6'2321'
*VZ2321  DC    X'140A051407D06410100302190190'
         DC    CL6'9345'
DVZ9345  DC    X'05A0000FBC98000000100230000F04A0D50000EE0023'
         DC    CL6'2305A'
DVZ2305A DC    X'0030000838E8027ACA080200000100EA5A5700A8'
         DC    CL6'2305B'
DVZ2305B DC    X'006000083A0A01215B08020000010076B4B10054'
         DC    CL6'2314'
DVZ2314  DC    X'00CB00141C7E922D2D010216003C00000000'  0-RPS
         DC    CL6'3330'
DVZ3330  DC    X'019B0013336DBFBF38000200008500ED807C0069'
*        DC    CL6'3340'
*VZ3340  DC    X'015D000C2157F2F24B800200000C0125403D008C'
         DC    CL6'3340'
DVZ3340  DC    X'02BA000C2157F2F24B80020000180125403D008C'
         DC    CL6'3350'
DVZ3350  DC    X'0230001E4B36010B5208020000960185807B009C'
         DC    CL6'3375'
DVZ3375  DC    X'03C0000C8CA000E0001000BF000C0340C4BB00C00020'
         DC    CL6'3330-1'
DVZ333D  DC    X'032F0013336DBFBF38000200008500ED807C0069'
         DC    CL6'3380'
DVZ3380  DC    X'0376000FBB6001000010010B000F04E0DDD600E00020'
         DC    CL6'3390'
DVZ3390  DC    X'0459000FE5A2000000100220000F0594E00001100022'
*                 0 1 2 3 4 5 6 7 8 9 A B C D E F 0 1 2 3 4 5
         SPACE 2
         PRINT NOGEN
         IEFUCBOB ,
         CVT ,
         END

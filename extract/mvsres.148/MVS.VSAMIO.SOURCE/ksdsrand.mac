000100 IDENTIFICATION DIVISION.
000200 PROGRAM-ID. KSDSRAND.
000300 AUTHOR. JAY MOSELEY.
000400 DATE-WRITTEN. NOVEMBER, 2001.
000500 DATE-COMPILED.
000600
000700* ************************************************************* *
000800* THIS PROGRAM TESTS THE VSAMIO ROUTINE BY ACCESSING A KSDS     *
000900* CLUSTER RANDOMLY AND ADDING/UPDATING/DELETING RECORDS.        *
001000* ************************************************************* *
001100
001200 ENVIRONMENT DIVISION.
001300 CONFIGURATION SECTION.
001400 SOURCE-COMPUTER. IBM-370.
001500 OBJECT-COMPUTER. IBM-370.
001600
001700 INPUT-OUTPUT SECTION.
001800 FILE-CONTROL.
001900
002000     SELECT RECORD-IMAGES
002100         ASSIGN TO UR-2540R-S-SYSIN.
002200
002300 DATA DIVISION.
002400 FILE SECTION.
002500
002600 FD  RECORD-IMAGES
002700     LABEL RECORDS ARE OMITTED
002800     BLOCK CONTAINS 0 RECORDS
002900     DATA RECORD IS RECORD-IMAGE.
003000
003100 01  RECORD-IMAGE.
003200     02  RI-ACTION               PIC X(01).
003300         88  ACTION-IS-ADD                   VALUE 'A'.
003400         88  ACTION-IS-CHANGE                VALUE 'C'.
003500         88  ACTION-IS-DELETE                VALUE 'D'.
003600         88  ACTION-IS-VALID                 VALUE 'A', 'C', 'D'.
003700     02  FILLER                  PIC X(01).
003800     02  RI-IMAGE                PIC X(78).
003900
004000 WORKING-STORAGE SECTION.
004100 77  END-OF-FILE-SWITCH          PIC X(1)    VALUE 'N'.
004200     88  END-OF-FILE                         VALUE 'Y'.
004300
004400 77  RECORD-COUNTER              PIC S9(8)   VALUE +0.
004500 77  COUNTER-EDIT                PIC ZZ,ZZZ,ZZ9.
004600
004700 01  VSIO-PARAMETER-VALUES       COPY VSAMIO.
004800 01  KSDSF01                     COPY VSAMIOFB.
004900 01  KSDS-RECORD.
005000     02  KR-KEY                  PIC X(10).
005100     02  FILLER                  PIC X(70).
005200
005300 PROCEDURE DIVISION.
005400
005500 000-INITIATE.
005600
005700     DISPLAY 'KSDSRAND: READ/REWRITE KSDS DIRECT'.
005800     DISPLAY '----------------------------------'.
005900     DISPLAY ' '.
006000
006100     OPEN INPUT RECORD-IMAGES.
006200
006300     MOVE 'KSDSF01' TO VSIO-DDNAME.
006400     MOVE VSIO-KSDS TO VSIO-ORGANIZATION.
006500     MOVE VSIO-DIRECT TO VSIO-ACCESS.
006600     MOVE VSIO-INPUT-OUTPUT TO VSIO-MODE.
006700     MOVE +80 TO VSIO-RECORD-LENGTH.
006800     MOVE +0 TO VSIO-KEY-POSITION.
006900     MOVE +10 TO VSIO-KEY-LENGTH.
007000     MOVE VSIO-OPEN TO VSIO-COMMAND.
007100     CALL 'VSAMIO' USING VSIO-PARAMETER-BLOCK, KSDSF01,
007200                         KSDS-RECORD.
007300*    END-CALL.
007400     IF NOT VSIO-SUCCESS
007500         DISPLAY 'VSAMIO ERROR OCCURRED DURING '
007600                 VSIO-COMMAND
007700         EXHIBIT NAMED VSIO-RETURN-CODE,
007800         EXHIBIT NAMED VSIO-VSAM-RETURN-CODE,
007900                       VSIO-VSAM-FUNCTION-CODE,
008000                       VSIO-VSAM-FEEDBACK-CODE
008100         STOP RUN.
008200*    END-IF.
008300
008400 010-PROCESS.
008500
008600     PERFORM 110-PROCESS-UPDATES
008700        THRU 119-EXIT
008800       UNTIL END-OF-FILE.
008900*    END-PERFORM.
009000
009100 020-TERMINATE.
009200
009300     MOVE VSIO-CLOSE TO VSIO-COMMAND.
009400     CALL 'VSAMIO' USING VSIO-PARAMETER-BLOCK, KSDSF01,
009500                         KSDS-RECORD.
009600*    END-CALL.
009700     IF NOT VSIO-SUCCESS
009800         DISPLAY 'VSAMIO ERROR OCCURRED DURING '
009900                 VSIO-COMMAND
010000         EXHIBIT NAMED VSIO-RETURN-CODE,
010100         EXHIBIT NAMED VSIO-VSAM-RETURN-CODE,
010200                       VSIO-VSAM-FUNCTION-CODE,
010300                       VSIO-VSAM-FEEDBACK-CODE.
010400*    END-IF.
010500
010600     STOP RUN.
010700
010800 110-PROCESS-UPDATES.
010900
011000     READ RECORD-IMAGES
011100         AT END
011200             MOVE 'Y' TO END-OF-FILE-SWITCH.
011300*    END-READ.
011400
011500     IF END-OF-FILE
011600         GO TO 119-EXIT.
011700*    END-IF.
011800
011900     ADD +1 TO RECORD-COUNTER.
012000
012100     IF NOT ACTION-IS-VALID
012200         MOVE RECORD-COUNTER TO COUNTER-EDIT
012300         DISPLAY COUNTER-EDIT ': ' RECORD-IMAGE
012400         DISPLAY '            *** ACTION INVALID: IGNORED'
012500         DISPLAY ' '
012600         GO TO 119-EXIT.
012700*    END-IF.
012800
012900     IF ACTION-IS-ADD
013000         PERFORM 120-ADD-PROCESS THRU 129-EXIT.
013100*    END-IF.
013200
013300     IF ACTION-IS-CHANGE
013400         PERFORM 130-CHANGE-PROCESS THRU 139-EXIT.
013500*    END-IF.
013600
013700     IF ACTION-IS-DELETE
013800         PERFORM 140-DELETE-PROCESS THRU 149-EXIT.
013900*    END-IF.
014000
014100 119-EXIT.
014200     EXIT.
014300
014400 120-ADD-PROCESS.
014500
014600     MOVE RI-IMAGE TO KSDS-RECORD.
014700     MOVE VSIO-WRITE TO VSIO-COMMAND.
014800     DISPLAY  'ADDING: ' KSDS-RECORD.
014900     CALL 'VSAMIO' USING VSIO-PARAMETER-BLOCK, KSDSF01,
015000                         KSDS-RECORD.
015100*    END-CALL.
015200
015300     IF VSIO-SUCCESS
015400         DISPLAY '               RECORD ADDED'
015500     ELSE
015600         IF VSIO-LOGIC-ERROR
015700        AND VSIO-DUPLICATE-RECORD
015800             MOVE VSIO-RELATIVE-RECORD TO COUNTER-EDIT
015900             DISPLAY '            *** DUPLICATE RECORD ON FILE'
016000         ELSE
016100             DISPLAY 'VSAMIO ERROR OCCURRED DURING '
016200                     VSIO-COMMAND
016300             EXHIBIT NAMED VSIO-RETURN-CODE,
016400             EXHIBIT NAMED VSIO-VSAM-RETURN-CODE,
016500                           VSIO-VSAM-FUNCTION-CODE,
016600                           VSIO-VSAM-FEEDBACK-CODE.
016700*        END-IF
016800*    END-IF.
016900
017000     DISPLAY ' '.
017100
017200 129-EXIT.
017300     EXIT.
017400
017500 130-CHANGE-PROCESS.
017600
017700     PERFORM 150-READ-RECORD THRU 159-EXIT.
017800
017900     IF VSIO-LOGIC-ERROR
018000     AND VSIO-RECORD-NOT-FOUND
018100         DISPLAY '          *** RECORD NOT FOUND'
018200         DISPLAY ' '
018300         GO TO 139-EXIT.
018400*    END-IF.
018500
018600     DISPLAY KSDS-RECORD.
018700     DISPLAY '               RECORD BEFORE CHANGE'.
018800
018900     MOVE RI-IMAGE TO KSDS-RECORD.
019000     MOVE VSIO-REWRITE TO VSIO-COMMAND.
019100     CALL 'VSAMIO' USING VSIO-PARAMETER-BLOCK, KSDSF01,
019200                         KSDS-RECORD.
019300*    END-CALL.
019400
019500     IF VSIO-SUCCESS
019600         DISPLAY KSDS-RECORD
019700         DISPLAY '               RECORD AFTER CHANGE'
019800     ELSE
019900         DISPLAY 'VSAMIO ERROR OCCURRED DURING '
020000                 VSIO-COMMAND
020100         EXHIBIT NAMED VSIO-RETURN-CODE,
020200         EXHIBIT NAMED VSIO-VSAM-RETURN-CODE,
020300                       VSIO-VSAM-FUNCTION-CODE,
020400                       VSIO-VSAM-FEEDBACK-CODE
020500*    END-IF
020600
020700     DISPLAY ' '.
020800
020900 139-EXIT.
021000     EXIT.
021100
021200 140-DELETE-PROCESS.
021300
021400     PERFORM 150-READ-RECORD THRU 159-EXIT.
021500
021600     IF VSIO-LOGIC-ERROR
021700     AND VSIO-RECORD-NOT-FOUND
021800         DISPLAY '          *** RECORD NOT FOUND'
021900         DISPLAY ' '
022000         GO TO 149-EXIT.
022100*    END-IF.
022200
022300     DISPLAY KSDS-RECORD.
022400     DISPLAY '               RECORD BEFORE DELETE'.
022500
022600     MOVE VSIO-DELETE TO VSIO-COMMAND.
022700     CALL 'VSAMIO' USING VSIO-PARAMETER-BLOCK, KSDSF01,
022800                         KSDS-RECORD.
022900*    END-CALL.
023000
023100     IF VSIO-SUCCESS
023200         DISPLAY '             DELETED '
023300     ELSE
023400         DISPLAY 'VSAMIO ERROR OCCURRED DURING '
023500                 VSIO-COMMAND
023600         EXHIBIT NAMED VSIO-RETURN-CODE,
023700         EXHIBIT NAMED VSIO-VSAM-RETURN-CODE,
023800                       VSIO-VSAM-FUNCTION-CODE,
023900                       VSIO-VSAM-FEEDBACK-CODE.
024000*    END-IF.
024100
024200     DISPLAY ' '.
024300
024400 149-EXIT.
024500     EXIT.
024600
024700 150-READ-RECORD.
024800
024900     MOVE RI-IMAGE TO KSDS-RECORD.
025000     DISPLAY 'ATTEMPTING TO READ: ' KR-KEY.
025100     MOVE VSIO-READ TO VSIO-COMMAND.
025200     CALL 'VSAMIO' USING VSIO-PARAMETER-BLOCK, KSDSF01,
025300                         KSDS-RECORD.
025400*    END-CALL.
025500
025600     IF NOT VSIO-SUCCESS
025700         IF VSIO-LOGIC-ERROR
025800        AND VSIO-RECORD-NOT-FOUND
025900            NEXT SENTENCE
026000         ELSE
026100             DISPLAY 'VSAMIO ERROR OCCURRED DURING '
026200                     VSIO-COMMAND
026300             EXHIBIT NAMED VSIO-RETURN-CODE,
026400             EXHIBIT NAMED VSIO-VSAM-RETURN-CODE,
026500                           VSIO-VSAM-FUNCTION-CODE,
026600                           VSIO-VSAM-FEEDBACK-CODE.
026700*        END-IF
026800*    END-IF.
026900
027000 159-EXIT.
027100     EXIT.
027200

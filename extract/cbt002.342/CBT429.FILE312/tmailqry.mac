Œ\INMR01


 





LINK 
 TMAILTST

ILQRY TITLE 'TSO MAIL QUERY COMMAND'
-------------------------------------------------------------------*
ODULE NAME: TMAILQRY                                               *
---------------------------------------------------------------------*
 FUNCTION   : THIS IS A TSO COMMAND THAT WILL BE USED                *
              TO TEST FOR MAIL TO BE RECEIVED FOR THE USER           *
             ÿ
 *        THIS IS ACCOMPLISHED BY USING THE SUBSYSTEM REQUEST          *
 *        TO GET INFORMATION ON THE FIRST SYSOUT DATA SET IN THE       *
 *        PUNCH SYSOUT CLASSÿ
   *        THE CURRENT TSO SESSION (JOB NAME FROM TIOT).
   *
   *        RETURN CODES:  0  - MAIL WAITINÿ
     *                       >0 - NO MAIL TO RECEIVE
     *------------------------------------------------------------------
     * SYNTAX:  TMAILQRY                                  ÿ
       *       OR
       *          TMAILQRY USERID
       *----------------------------------------------------------------
         *  LKED ATTRIBUTES:  AUTHORIZED,  RENT, REUS
         *
         *  UPDATE SYS1.PARMLIB MEMBER IKJTSO?? TO ADD THIS AS AN AUTHOR
        ÿ
 *         *
 *         *  IF USING ACF2 COMMAND LIMITING THEN ALSO ADD THIS COMMAND
 *         *     TABLE.ÿ
   *         *----------------------------------------------------------
---*         *         AUTHOR:    LIONEL B. DYCK
   *         *                    KAISÿ
     *         *                    25 N. VIA MONTE AVE.
     *         *                    WALNUT CREEK, CA 94598
     *         *                    (925) 926-5332   ÿ
       *         *                    INTERNET: LIONEL.B.DYCK@KP.ORG
       *         *------------------------------------------------------
-------*                  EJECT                                     ÿ
                   *----------------------------------------------------
---------*         *        LOCAL MACROS
         *         *----------------------------------------------------
---+
 ÿ
                       &LABEL   $PROLOG &LV=0,&GM=Y
                       .************************************************
**************  ÿ
                         .*       THIS MACRO WILL PROVIDE ENTRY LINKAGE
ONALLY                   .*       MULTIPLE BASE REGISTERS.  ALSO, VIA TH
KEYWORD                  .*    ÿ
 THE                       .*       SAVE AREA) ADDRESSABLE FROM REG 13.
PERANDS                    .*       ARE CODED, REG 12 IS ASSUMED THE BAS
LE:                        .*              SECÿ
D REG 12 BASE                .*              SECTNAME $PROLOG 5        =
D, REG 5 BASE                .*              SECTNAME $PROLOG 10,LV=20 =
BYTES TO SAVE AREA           .*                              ÿ
G 10 IS BASE                   .*              SECTNAME $PROLOG R10,R11
10 AND 11 ARE BASES            .*
                               .****************************************
************************                  LCLA  &AA,&AB,&AC
                                          GBLB  &PRORG
                                          GBLC  &PROGM
           ÿ
                                   &LABEL   CSECT
                                            B     32(R15)             BR
UND                       ÿ
                                              DC    CL8'&LABEL'
ME                                            DC    C'-'
                                         ÿ
E DATE                                          DC    C'-'
                                                DC    CL8'&SYSTIME'
E TIME                                          CNOP  0,ÿ
NMENT                                             STM   R14,R12,12(R13)
 REGISTERS                                        LR    R12,R15
 BASE REG                                         USING &LABEL,R12     ÿ
FORM ASSEMBLER                                      AIF   (&LV GT 4023).
                                                    AIF   ('&GM' EQ 'N')
                                           &PROGM   SETC  'GETMAIN'
      ÿ
LOAD REG 0 WITH LENGTH VARIABLE                       GETMAIN R,LV=(0)
GET CORE FOR SAVEAREA AND USER                        AIF   (&LV+72 LE 2
                     +
1                  ÿ
    MOVE X'00' TO FIRST BYTE                              LR    R2,R1
    SAVE POINTER IN EVEN REG                              LA    R4,1(R1)
    SET RECEIVING POINTER         ÿ
      SET RECEIVING LENGTH                                  BCTR  R5,R0
      DECREMENT LENGTH                                      LA    R5,0(R
      CLEAR HIGH ORDER BYTE                      ÿ
        SET SENDING LENGTH                                    MVCL  R4,R
        INSTRUCTION PADS WITH X'00'                           AGO   .STO
                                                     .XC1     ANÿ
                                                                XC    25
4,R1),256(R1)  CLEAR SAVE AREA                                  XC    0(
0(R1)          CLEAR SAVE AREA                                  AGO   .S

                                                                  XC
,R1),0(R1)       CLEAR SAVE AREA                                  AGO
              ÿ
                                                                    CNOP
                                                                    LA
E&SYSNDX                     ÿ
                                                             SAVE&SYSNDX
0'                                                           .STORE   AN
                                            ÿ
3,4(R1)           SAVE BACK CHAIN
,8(R13)           SET FORWARD CHAIN
1,R1              SAVE NEW SAVEAREA ADDRESS                ÿ
R15,16(R13)         RESTORE REG 15
R0,16(R13)          SAVE SAVEAREA LENGTH
R0,R1,20(R13)       RESTORE REGS USED IN GETMAIN
  R13,R11             SET SAVEAREA POINTER
  (N'&SYSLIST EQ 0).MEND
  ('&SYSLIST(1)' EQ 'R12').SKIPIT
  ('&SYSLÿ
    &SYSLIST(1),&LABEL  LOAD REQUESTED BASE REG
OP  R12                 DROP ASSUMED BASE REG
ING &LABEL,&SYSLIST(1)  ÿ
ANOP                                                                   &
SETA  2                                                                .
ANOP                                   +
  AIF   (&AA GT N'&SYSLIST).MEXIT    ÿ
    SETA  &AA-1
    LA    &SYSLIST(&AA),2048(&SYSLIST(&AB))  LOAD NEXT BASE REG
    LA    &SYSLIST(&AA),2048(&SYSLIST(&AA))  LOAD NEÿ
      USING &LABEL+&AC,&SYSLIST(&AA) INFORM ASSEMBLER
      SETA  &AC+4096
      SETA  &AA+1                                                  ÿ
        AGO   .LOOP
MEXIT   ANOP
        AIF   (&PRORG).MEX2
  ÿ
          $REGS
          SPACE
 .MEX2    ANOP   ÿ
   &AA      SETA  &LV+72
            MNOTE *,'TOTAL STORAGE AREA RECEIVED = &AA'
            MEXIT               ÿ
     .MEND    ANOP
              MNOTE *,'NO REGISTER SPECIFIED - R12 ASSUMED'
              AGO   .MEXIT                     ÿ
       .MERR    ANOP
                MNOTE 12,'LV > 4023 - REQUEST IGNORED'
                AGO   .MEXIT                                  ÿ
                  MEND
                  MACRO
         &LABEL   $EPILOG &RC
                    GBLC  &PROGM
           &LABEL   LR    R1,R13              GET SAVEAREA ADDRESS
                    L     R13,4(R13)          GET BACK CHAIN POINTER
            ÿ
                      L     R0,16(R13)          GET SAVEAREA LENGTH
                      ST    R15,16(R13)         SAVE REGISTER 15 (RETCOD
                      FREEMÿ
                        AGO   .LM
               .NOFREE  ANOP
                        ST    R15,16(R13) ÿ
                 .LM      ANOP
                          LM    R14,R12,12(R13)     RESTORE CALLERS REGS
                          AIF   (T'&RC EQ 'O').SPEC      +
                            LA    R15,&RC             Sÿ
                     .SPEC    ANOP
                              BR    R14                 RETURN TO CALLER
                              MEND                                    ÿ
                                MACRO
                                $REGS
                                GBLB  &PRORG
     ÿ
                         &PRORG   SETB  1
                          SPACE
                    ÿ
                           R1       EQU   1
                           R2       EQU   2
                           R3      ÿ
                             R4       EQU   4
                             R5       EQU   5
                             R6       EQU   6     ÿ
                               R7       EQU   7
                               R8       EQU   8
                               R9       EQU   9                  ÿ
                                 R10      EQU   10
                                 R11      EQU   11
                                 R12      EQU   12
ÿ
                                   R14      EQU   14
                                   R15      EQU   15
               ÿ
                                     REG0     EQU   0
                                     REG1     EQU   1
                              ÿ
                                       REG3     EQU   3
                                       REG4     EQU   4
                                       REG5  ÿ
                                         REG6     EQU   6
                                         REG7     EQU   7
                                         REG8     EQU   8   ÿ
                                           REG9     EQU   9
                                           REG10    EQU   10
                                           REG11    EQU   11
                                             REG12    EQU   12
                                               REG13    EQU   13
                                               REG14    EQU   14
                                               REG15    EQU   15
        ÿ
                                                 .MEX2    ANOP
                                                          MEND
                       ÿ
                                                            EJECT
                                                   TMAILQRY $PROLOG 12,L
                                      ÿ
                                                              EJECT
                                                     *------------------
-------------------------------------------*         ÿ
ST FROM PARM OR TIOT                         *         *----------------
---------------------------------------------*                  L     R1
                                                                LH  ÿ
          LOAD OFFSET                                             LH
          LOAD LEN                                                SR
                                                                  SH
'  ÿ
            ANY LENGTH ?              *LBD 04/93*                   BZ
            ZERO SO GET FROM TIOT     *LBD 04/93*                   CH
07'         ELSE Cÿ
OT            TOO LONG - IGNORE                                       AR
2             -> PARM                                                 LA
(R1)          SKIP CMD HEADER    ÿ
R1),C' '        CHECK FOR VALID PARM
TIOT            NO PARM REALLY
,=H'01'         LESS 1 FOR MVC                  ÿ
R3,MVCMD
CMDPARM,=CL8' '   INSURE UPPER CASE
R5,CMDPARM        -> SET POINTER FOR USERID                    ÿ
  SETSSOB                                                          MVCMD
  CMDPARM(0),0(R1)                                                 DOTIO
  0H
    R5,16             -> CVT
    R5,0(,R5)         -> TCB WORDS
    R5,0(,R5)         -> MY TCB
    R5,12(,R5+
LA    R5,0(ÿ
  SPACE 2
---------------------------------------------------------------*
  SET UP SSOB FOR SPOOL ACÿ
-----------------------------------------------------------------*
    SPACE
OB  DS    0H                             ÿ
      LA    R4,XSSOB           GET SSOB EXTENSION ADDR
      ST    R4,SSOBPARM           SAVE IT IN SSOB
      OI    SSOBPARM,X'80'          AND SET FLAG        ÿ
        XC    XSSOB,XSSOB           AND ZERO WORK AREA
        LA    R4,XSSOB
        USING SSOB,R4                                                  ÿ
          MVC   SSOBID,=C'SSOB'     INITIALIZE SSOB
          MVC   SSOBLEN,=AL2(SSOBHSIZ)
          MVC   SSOBFUNC,=AL2(SSOBSOUT)
      ÿ
            OI    SSSOFLG1,SSSOSPGM   SET WTR NAME SELECTION FLAG
            MVC   SSSOPGMN,0(R5)      SET JOBNAME INTO SSOB
            LA    R1,ÿ
              ST    R1,SSOBINDV
              MVC   SSSOCLSL,CLASS      SET CLASS FOR MAIL
              EJECT                 ÿ
       *----------------------------------------------------------------
       *        ISSUE SUB SYSTEM REQUEST FOR FIRST SPOOL DATA-SET
       *-------------------------------------------ÿ
                  MODESET MODE=SUP,KEY=ZERO
                  XC    SSSOFLG2,SSSOFLG2
                  XC    SSSODSN,SSSODSN                           ÿ
                    XC    SSSOUFLG,SSSOUFLG
                    LA    R1,SSOBPARM
                    IEFSSREQ
 ÿ
                      MODESET MODE=PROB,KEY=NZERO
                      LTR   R2,R2
                ÿ
               CKRTN    CLC   SSOBRETN,=AL4(SSSORTOK)
                        BE    EXIT0
                        CLC   S+
                          BE ÿ
                            CLC   SSOBRETN,=AL4(SSSOUNAV)
                            BE    EXIT16
                            CLC   SSOBRETN,=ÿ
                              BE    EXIT0               GET JOB ID FROM
                              B     EXIT12
                     EXIT0    EQU   *                      ÿ
                                LA    R2,0
                                B     EXIT
                       EXIT4    EQU   *
                                  LA    R2,4
                                  B     EXIT
                         EXIT8    EQU   *
         ÿ
                                    B     EXIT
                           EXIT12   EQU   *
                        ÿ
                                      B     EXIT
                             EXIT16   EQU   *
                                      Lq A    R2,16
                               EXIT     DS    0H
                               ÿç
                                                      MODESET MODE=SUP,K
                                                      LA    R1,SSOBPARM
                                              ÿ
                                                        MODESET MODE=PRO
ERO                                                     LR    R15,R2
SET RETURN CODE                                         $EPILÿ
                                                          EJECT
                                                 *----------------------
---------------------------------------*         *        DATA AREAS
                                         *         *--------------------
-----------------------------------------*                  LTORG
                                                            SPACE 2
           ÿ
        PUNCH SYSOUT CLASS FOR MAIL                           SPACE 2
                                                              EJECT
                          ÿ
---------------------------------------------*         *        MAPPING
                                             *         *----------------
-----------------------------------------ÿ
                                                                  DS
                                                         SSOBPARM DS
                                                        ÿ
                                                           XSSOB    DS
                                                           CMDPARM  DS
                                                                    TITÿ
B'                                                                    IE
O                                                                     TI
B'                                                                    IE
      ÿ
ES CT'

VT'                  Q
DSECT=YES,LIST=YES
                                                                 

                   arg userid

            ÿ

                     if length(userid) = 0 then cmd
                           0                 else cmd userid
                       if rc = 0 then say "Mail waiting to be received"
                                 else say "No Mail to be received at thi
               
ASS=L,NOTIFY=&SYSUID,                    //        MSGLEVEL=(1,1),MSGCLA
                                         //HOLD     OUTPUT JESDS=ALL,DEF
UTDISP=(HOLD,HOLD)                       /ÿ
                                           //***************************
********************************           //* JCL AND SOURCE TO ASSEMBL
NK CONCAT VERSION 5.1                      //* CHANGES MAÿ
WA TO MOVE ABOVE THE LINE.                   //*************************
**********************************           //C      EXEC  PGM=ASMA90,P
ECT',REGION=2000K                            //SYSLIB   DD  DSN=SYS1.MAC
SP=SHR                                         //         DD  DSN=SYS1.A
ISP=SHR                                        //SYSUT1   DD  UNIT=SYSDA
CYL,(10,5))                                    //SYSPUNCH DD  DUMMY
       ÿ
KSIZE=3509)                                      //SYSLIN   DD  DISP=(,P
T=SYSDA,SPACE=(CYL,(5,5,0)),            *        //             DCB=(BLK
),DSN=&LOADSET        ÿ
ILQRY.PDS(TMAILQRY),DISP=SHR                       //*
                                                   //L    EXEC  PGM=IEWL
AP,LET,LIST,AC(1)',                  ÿ
=(5,LT,C)                                            //SYSLIN   DD  DSN=
,DISP=(OLD,DELETE)                                   //SYSLMOD  DD  DSN=
KLIB(TMAILQRY),DISP=SHR                             ÿ  //SYSUT1   DD  UN
,SPACE=(CYL,(3,2)),DSN=                                //SYSLIB   DD DSN
NKLIB,DISP=SHR                                         //SYSPRINT DD  SY
CB=(RECFM=FB,BLKSIZE=3509)                             
ðTMAILQRY is a TSO command that will pass a return code indicating if th
 current TSO User or the specified Userid has any Mail files waiting to
 be RECEIVE'd.
  ÿ
   The syntax is:
      TMAILQRY
   or TMAILQRY usÿ

     To install edit and run the ASMLINK member of this dataset. Then up
     SYS1.PARMLIB member IKJTSO0ÿ
       Command section of the member (AUTHCMD section).

       A sample rexx exec using this command isÿ

         TMAILQRY using the Process Sysout Interface (external writer) t
         there is any output with a dest of the specified userÿ
 it        sets a return code to indicate there is mail to receive.  If
 a         return code indicates no mail.

             Return codes:   0        = mail to be received
                             non-zero = no mail to be received
             

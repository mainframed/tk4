         MACRO
&NAME    LOSE  &A,&SWITCH=,&ALSO=
         GBLB  &JLOSE
         GBLA  &JLSW,&JLADD
         GBLC  &SWSTOR(10),&ALSTOR(30),&P,&TH(10)
         LCLB  &LOCAL
         LCLA  &NUM,&INDX,&LIMIT
&TH(1)   SETC  'ST'
&TH(2)   SETC  'ND'
&TH(3)   SETC  'RD'
&TH(4)   SETC  'TH'
&TH(5)   SETC  'TH'
&TH(6)   SETC  'TH'
&TH(7)   SETC  'TH'
&TH(8)   SETC  'TH'
&TH(9)   SETC  'TH'
&TH(10)  SETC  'TH'
         AIF   (&JLOSE).NORM
&JLOSE   SETB  (1)
&INDX  SETA  1
         AIF   (T'&SWITCH EQ 'O').TRYAL
&LOCAL   SETB  (1)
&P       SETC   'SWITCH'
&LIMIT   SETA  N'&SWITCH
         AIF   (&LIMIT GT 10).TOOBIG
&INDX    SETA  (&LIMIT/2)*2
         AIF   (&INDX NE &LIMIT).NOTX2
&JLSW    SETA  &INDX
&INDX    SETA  1
.L1    AIF  (K'&SWITCH(&INDX) GT 4).TOOLONG
&SWSTOR(&INDX) SETC '&SWITCH(&INDX)'
&INDX    SETA  &INDX+1
         AIF   (&INDX LE &LIMIT).L1
&INDX    SETA  1
.TRYAL   AIF   (T'&ALSO EQ 'O').NORMX
&LOCAL   SETB  (1)
&P       SETC  'ALSO'
&LIMIT   SETA  N'&ALSO
         AIF   (&LIMIT GT 30).TOOBIG
&INDX    SETA  (&LIMIT/2)*2
         AIF   (&INDX NE &LIMIT).NOTX2
&JLADD   SETA  &INDX
&INDX    SETA  1
.L2            AIF (K'&ALSO(&INDX) GT 4).TOOLONG
&ALSTOR(&INDX) SETC '&ALSO(&INDX)'
&INDX    SETA  &INDX+1
         AIF   (&INDX LE &LIMIT).L2
&INDX  SETA  1
.NORMX AIF (&JLSW LT &INDX).NORM
&P       SETC  '&SWSTOR(&INDX)'
&LIMIT   SETA  2
.TEST0   AIF   ('&P' EQ '&SWSTOR(&LIMIT)').WARN
.L4    ANOP
&LIMIT   SETA  &LIMIT+2
         AIF   (&JLSW GT &LIMIT).TEST0
&INDX  SETA  &INDX+2
         AGO   .NORMX
.WARN    MNOTE 4,'&INDX &TH(&INDX) OPERAND - &P - REPEATED AS SUBJECT IN
               N &LIMIT &TH(&LIMIT) OPERAND IN SWITCH KEYWORD'
&SWSTOR(&LIMIT-1) SETC ''
       AGO  .L4
.NORM    AIF   (T'&A EQ 'O').ERRORT
         AIF   (T'&NAME EQ 'O').NLAB
&NAME    DC    0H'0'
.NLAB ANOP
&LOCAL   SETB  0
&NUM     SETA  &SYSNDX
$$LS&NUM LA    &A.REG,&A
         LTR   1,&A.REG .              END CHAIN
         BZ    $$LE&NUM
         AIF   (&JLADD EQ 0).OUT1
&INDX    SETA  1
.TEST1   AIF   ('&ALSTOR(&INDX)' NE '&A').UP2
&P       SETC  '&ALSTOR(&INDX+1)'
         L     &P.REG,&A.&P
         LOSE  &P
.UP2     ANOP
&INDX    SETA  &INDX+2
         AIF   (&JLSW GT &INDX).L3
&INDX    SETA  &INDX+2
         AIF   (&INDX LT &JLADD).TEST1
            LR 1,&A.REG
.OUT1    AIF   (&JLSW EQ 0).OUT2
&INDX    SETA  1
.TEST2   AIF   ('&SWSTOR(&INDX)' EQ '&A').OUT3
&INDX    SETA  &INDX+2
         AIF   (&INDX LT &JLSW).TEST2
.OUT2    L     &A.REG,&A.LINK .        LOAD FOR NEXT BUFFER
         AGO   .FREE
.OUT3    ANOP
&P       SETC  '&SWSTOR(&INDX+1)'
&LOCAL   SETB  (1)
         L     &P.REG,&A.LINK .        SWITCH TO NEXT BUFFER CHAIN
.FREE    LA    0,&A.REQ
         FREEMAIN R,A=(1),LV=(0)
         AIF   (&LOCAL).OUT4
         B     $$LS&NUM
$$LE&NUM EQU   *
         MEXIT
.OUT4    LOSE  &P
$$LE&NUM EQU   *
         MEXIT
.TOOLONG MNOTE 4,'&INDX &TH(&INDX)&P OPERAND TOO MANY CHARACTERS'
         MEXIT
.TOOBIG  MNOTE 4,'&P HAS TOO MANY OPERANDS'
         MEXIT
.ERRORT  AIF   (&LOCAL).OUT
         MNOTE 4,'TYPE TO FREE MUST NOT BE OMMITTED'
.OUT     MEXIT
.NOTX2   MNOTE 4,'&P HAS NOT GOT A EVEN NO. OF OPS.'
         MEND
         LOSE  SWITCH=($SET,$MEM),ALSO=($MEM,$ADD,$INC,$ADD)
  LOSE $SET
 END

         MACRO
&NAME    @FINDUCB &UCB,&WA,&MASK,&PENDOFF=NOSKIP,&PENDMNT=NOSKIP,      X
               &VOLZERO=NOSKIP,&VIRTVOL=NOSKIP
.*
.*       RESTRICTIONS: YOU MUST 'DROP' ANY USING FOR BOTH 'UCBOB' AND
.*            'CVTMAP' BEFORE ENTERING THIS MACRO.
.*
.*       REGISTER USAGE:
.*            R1 - BASE REGISTER OF THE UCBOB DSECT, MODIF BY TRT
.*            R2 - MODIFIED BY TRT INSTRUCTION
.*            R14- BAL AND WORK REGISTER
.*            R15- BASE FOR CVT, BAL AND RC FOR UCB SCAN SERVICE
.*
.*       REQUIREMENTS: YOU MUST INCLUDE THE 'IEFUCBOB' MACRO AND THE
.*            'CVT DSECT=YES' MACRO IN YOUR CODE.
.*
.*       REQUIRED POSITIONAL PARAMETERS:
.*           &UCB - FULLWORD IN WHICH THE UCB ADDRESS WILL BE RETURNED
.*           &WA  - 100 BYTE WORKAREA, MUST BE ZERO AT FIRST CALL
.*                  DO NOT ZERO ON SUBSEQUENT CALLS UNLESS YOU WISH
.*                  TO START WITH THE FIRST UCB AGAIN.
.*           &MASK- 40 BYTE MASK THAT IS COMPARED TO THE UCBS AND ONLY
.*                  THOSE UCBS MATCHING THE BITS IN THE MASK WILL BE
.*                  RETURNED.
.*
.*       OPTIONAL KEYWORD PARAMETERS:
.*           &PENDOFF=NOSKIP/SKIP: RETURN UCB EVEN IF IT IS PENDING
.*                    OFFLINE, THIS (NOSKIP) IS THE DEFAULT.
.*           &PENDMNT=NOSKIP/SKIP: RETURN UCB EVEN IF A MOUNT IS
.*                    PENDING, THIS (NOSKIP) IS THE DEFAULT.
.*           &VOLZERO=NOSKIP/SKIP: RETURN UCB EVEN IF THE VOLSER IS
.*                    ZERO, THIS (NOSKIP) IS THE DEFAULT.
.*           &VIRTVOL=NOSKIP/SKIP: RETURN UCB EVEN IF IT IS A VIRTUAL
.*                    VOL, THIS (NOSKIP) IS THE DEFAULT.
.*
.*EXAMPL
.*       USING UCBOB,R2     ESTABLISH ADDRESSABILITY TO
.*       LA    R2,MASK            UCB MASK AND DSECT
.*       XC    UCBWA,UCBWA    CLEAR 100 BYTE WORK AREA
.*       XC    MASK,MASK      CLEAR MASK
.*       OI    UCBBYT3,UCB3DACC     DIRECT ACCESS DEVICE
.*       OI    UCBSTAT,UCBONLI      MUST BE ONLINE
.*       OI    UCBSTAB,UCBBSTR      MUST BE MOUNTED STORAGE
.*       DROP  R2                 DROP ADDRESSABILITY
.* LOOP  EQU   *
.*       FINDUCB UCBPTR,UCBWA,MASK,PENDOFF=SKIP,PENDMNT=SKIP,
.*            VOLZERO=SKIP,VIRTVOL=SKIP
.*       USING UCBOB,R2           RE-ESTABLISH ADDRESSABILITY
.*       LTR   R15,R15            FIND ONE?
.*       BNZ   EXIT               NO - END OF UCBS
.*       ICM   R2,15,UCBPTR    YES- PICK UP RETURNED UCB ADDRESS
.*       .                               PROCESS
.*       .
.*       .
.*       B     LOOP               GET NEXT UCB
.* EXIT  EQU   *
.*
.*       THE MASK IN THE ABOVE EXAMPLE WOULD LIMIT THE UCBS RETURNED
.*       TO THOSE THAT ARE: DASD AND ONLINE AND MOUNTED AS STORAGE
.*       AND A MOUNT IS NOT PENDING AND IS NOT PENDING OFFLINE AND THE
.*       VOLSER IS NOT X'00'S AND IT IS NOT A VIRTUAL DEVICE (MSS).
.*
.*       ANY BITS MAY BE SET IN THE MASK. IF YOU WANT A SPECIFIC DEVICE
.*       ADDRESS, SET EITHER THE BINARY OR CHARACTER DEVICE ADDRESS IN
.*       THE MASK TO THE SPECIFIC DEVICE REQUIRED.
.*
.*       IF YOU ALL UCBS, SET THE MASK TO ZERO AND OMIT THE OPTIONAL
.*       KEYWORD PARAMETRS.
.*------ --------------------------------------------------------------
         LCLA  &X
&X       SETA  &SYSNDX
         USING UCBOB,R1     UCB DSECT
         USING CVTMAP,R15   CVT DSECT
&NAME    DS    0H
         LA    R1,&WA       GET ADDRESS OF 100 BYTE WORKAREA
         ST    R1,PWA&X         STORE ADDRESS INTO PARMLIST
         LA    R1,&MASK+18  PICK UP DEVICE CLASS
         ST    R1,PDVT&X        STORE ADDRESS INTO PARMLIST
         LA    R1,&UCB      GET ADDRESS OF WORD TO STORE UCB ADDR
         ST    R1,PUCB&X        STORE ADDRESS INTO PARMLIST
         OI    PUCB&X,X'80' INDICATE END OF PARMLIST
MLPA&X   EQU   *
         LA    R1,PARM&X    PUT PARMLIST ADDRESS INTO R1
         L     R15,CVTPTR    GET CVT ADDRESS
         L     R15,CVTUCBSC  GET UCB SCAN SERVICE ADDRESS
         BALR  R14,R15       BRANCH TO SCAN SERVICE
         LTR   R15,R15       DID SCAN SERVICE RETURN A UCB?
         BNZ   MZZZ&X          NO- MUST BE END OF UCB TABLE
         L     R1,&UCB      YES-GET UCB ADDR THAT SCAN SERVICE RETURND
         MVC   WUCB&X,0(R1)   COPY UCB
         CLI   &MASK+28,X'00'   DID USER SUPPLY A VOLSER?
         BE    MBBB&X           NO - OK
         XC    WTRT&X,WTRT&X    YES - CLEAR TRT TABLE
         MVI   WTRT&X+C'*',C'*'    SET FOR A GENERIC VOLSER TEST
         TRT   &MASK+28(6),WTRT&X  DID USER SUPPLY A GENERIC VOLSER?
         BZ    MAAA&X              NO - OK
         LA    R14,&MASK+28      START OF GENERIC
         SR    R1,R14              LENGTH OF GENERIC
         STC   R2,WUCB&X+28(R1) PLACE * IN CORRESPONDNG UCB VOLS WKAREA
*        SO THAT WHEN ITS 'ANDED' WITH MASK WILL GIVE AN EQ COMPARISON
         BCTR  R1,0                LENGTH-1
         LR    R2,R1      USE R2 AS LENGTH IN EX INSTRUCTION
         L     R1,&UCB    RESET R1 AS BASE REG FOR UCB
         EX    R2,MCLC&X      GENERIC COMPARE
         BNE   MLPA&X              NOT EQUAL
         B     MBBB&X              EQUAL
MAAA&X   EQU   *
         CLC   UCBVOLI,&MASK+28    SAME VOLSER?
         BNE   MLPA&X              NO - SKIP IT
MBBB&X   EQU   *
         NC    WUCB&X,&MASK   'AND' MASK OVER COPY OF UCB
         CLC   WUCB&X,&MASK   COMPARE 'ANDED' UCB TO MASK
         BNE   MLPA&X           NOT EQUAL - SKIP IT
         AIF   ('&PENDOFF' EQ 'NOSKIP').AAA
         TM    UCBSTAT,UCBCHGS     PENDING OFFLINE/UNLOAD
         BO    MLPA&X              YES - IGNORE IT
.AAA     ANOP
         AIF   ('&PENDMNT' EQ 'NOSKIP').BBB
         TM    UCBDMCT,UCBMOUNT    MOUNT PENDING
         BO    MLPA&X              YES - IGNORE IT
.BBB     ANOP
         AIF   ('&VOLZERO' EQ 'NOSKIP').CCC
         CLI   UCBVOLI,X'00'       ANY VOLUME INFORMATION
         BE    MLPA&X              NO - SKIP IT
.CCC     ANOP
         AIF   ('&VIRTVOL' EQ 'NOSKIP').DDD
         TM    UCBTBYT2,UCBRVDEV   IS THIS A VIRTUAL VOLUME
         BO    MLPA&X              YES - SKIP IT
.DDD     ANOP
         B     MZZZ&X
PARM&X   DS    0F
PWA&X    DS    F           ADDRESS OF 100-BYTE WORK AREA
PDVT&X   DS    F           ADDRESS OF DEVICE CLASS BYTE
PUCB&X   DS    F           ADDRESS OF WORD TO STORE UCB ADDR
*
WUCB&X   DC    XL40'00'    COPY OF UCB FOR 'AND'
WTRT&X   DC    XL256'00'            TRT TABLE
MCLC&X   CLC   UCBVOLI(0),&MASK+28   SAME VOLSER?
MZZZ&X   DS    0H
         MEND

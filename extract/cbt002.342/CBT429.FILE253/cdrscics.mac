/* REXX CDRS FCT MERGE EXEC */
PARSE UPPER ARG ONLJOB;
ONLJOB = STRIP(ONLJOB);
ONLVOL = SUBSTR(ONLJOB,4);
"EXECIO * DISKR FCTIN (FINIS STEM FCTIN.";
DO K = 1 TO FCTIN.0;
     TEMP = SUBSTR(FCTIN.K,1,72);
     CONT=SUBSTR(TEMP,72,1);
     IF WORDPOS("DFHFCT",TEMP)^=0 THEN DO;
          CURRFCT=TEMP;
          DO WHILE (CONT^=" ");
              K=K+1; /* INDEX */
              TEMP = SUBSTR(FCTIN.K,1,72);
              CONT=SUBSTR(TEMP,72,1);
              CURRFCT=CURRFCT TEMP;
          END;
     CURRFCT=TRANSLATE(CURRFCT,"   ",",()");
     PARSE VAR CURRFCT . "DATASET=" MEMBER . ;
     PARSE VAR CURRFCT . "DSNAME=" DSN . ;
     IF DSN=" " × DSN="" × SUBSTR(MEMBER,1,3)="DFH" THEN ITERATE K;
     FCT.MEMBER=DSN;
END;
END;
DROP FCTIN.;
"EXECIO * DISKR ZEKE (FINIS STEM ZEKE.";
FCTNLIST="";
DO K = 1 TO ZEKE.0;
    PARSE VAR ZEKE.K "SET" "SCOM" . "SET" "DA" FCTN "CLO" . ;
    IF FCTN=" " × FCTN="" THEN ITERATE K;
    FCTN = TRANSLATE(FCTN,"   ","(),");
    FCTNLIST = FCTNLIST FCTN;
END;
DROP ZEKE.;
JCLX.0 = 52; /* COUNT OF INCR JOB STATEMENTS */
JCLX.1 = "//"ONLJOB "JOB 530401053000,'SYSTEM.BACKUP',";
JCLX.2 = "// NOTIFY=TECH251,";
JCLX.3 = "// CLASS=H,MSGCLASS=G";
JCLX.4 = "//LOAD1 EXEC PGM=IKJEFT01,DYNAMNBR=32,PARM='%DB2TIACK'";
JCLX.5 = "//SYSTSPRT DD SYSOUT=*";
JCLX.6 = "//SYSPRINT DD SYSOUT=*";
JCLX.7 = "//SYSTSIN DD DUMMY";
JCLX.8 = "//SYSPROC DD DSN=SYSS.TECH.COMMON.EXECLIB,DISP=SHR";
JCLX.9 = "//SYSIN DD *";
JCLX.10 = " DELETE FROM BUILD.TABRVOLS WHERE VOLSER='"ONLVOL"' AND ";
JCLX.11 = " DUMP_STATUS='PENDING' AND DUMP_TYPE='INCRVOL';";
JCLX.12 = " COMMIT;";
JCLX.13 = " INSERT INTO BUILD.TABRVOLS (VOLSER,DUMP_TYPE,DUMP_STATUS)";
JCLX.14 = "    VALUES('"ONLVOL"','INCRVOL','ACTIVE');";
JCLX.15 = "/*";
JCLX.16= "//DUMPIT EXEC PGM=FDRABR,REGION=0M";
JCLX.17= "//SYSPRIN1 DD SYSOUT=*";
JCLX.18= "//SYSPRIN2 DD SYSOUT=*";
JCLX.19= "//SYSPRIN3 DD SYSOUT=*";
JCLX.20= "//DUMMY1   DD DUMMY";
JCLX.21="//TAPE1 DD DSN=I1ONLV,DISP=(,KEEP),UNIT=TA80,VOL=(,,,255)";
JCLX.22 ="//TAPE2 DD DSN=I2ONLV,DISP=(,KEEP),UNIT=TA80,VOL=(,,,255)";
JCLX.23="//TAPE3 DD DSN=I3ONLV,DISP=(,KEEP),UNIT=TA80,VOL=(,,,255)";
JCLX.24="//DUMMY2 DD DUMMY";
JCLX.25= "//SYSPRINT DD SYSOUT=*";
JCLX.26 = "//SYSUDUMP DD SYSOUT=X";
JCLX.27 = "//SYSIN DD *";
JCLX.28 = " DUMP TYPE=ABR,ONLVOL,";
JCLX.29 = "  AUTOUPD=YES,";
JCLX.30 = "  BUFNO=MAX,";
JCLX.31 = "  COMPRESS=ALL,";
JCLX.32 = "  DATA=USED,";
JCLX.33 = "  DATEP=NONE,";
JCLX.34 = "  DSNENQ=TEST,";
JCLX.35 = "  ENQ=RESERVE,";
JCLX.36 = "  ENQERR=NO,";
JCLX.37 = "  ENQERR=PROCESS,";
JCLX.38 = "  FORMAT=NEW,";
JCLX.39 = "  LBPZERO=INVALID,";
JCLX.40 = "  MAXDD=512,MAXERR=1,";
JCLX.41 = "  PRINT=ABR,";
JCLX.42 = "  RETPD=9999,";
JCLX.43 = "  SMSCONSTRUCT=NO,";
JCLX.44 = "  SMSMANAGE=NO";
JCLX.45 = " S CATDSN=SYS1.UCATPRD1.CLUSTER";
JCLX.46 = " S CATDSN=SYS1.UCATPRD2.CLUSTER";
JCLX.47 = " S CATDSN=SYS1.UCATPRD3.CLUSTER";
JCLX.48 = " S CATDSN=SYS1.UCATPROD.CLUSTER";
JCLX.49 = " S CATDSN=SYS1.UCATTSOE.CLUSTER";
JCLX.50 = " S CATDSN=SYSS.TLMS.V5R3M0.RMF.CLUSTER";
JCLX.51 = " S CATDSN=SYSS.TLMS.V5R3M0.VMF";
JCLX.52 = " S CATDSN=SYSS.TLMS.V5R3M0.VMFINDEX.CLUSTER";
JCLY.0 = 25; /* COUNT OF INCR JOB STATEMENTS */
JCLY.1 = "// IF (RC<=8 & ^ABEND) THEN";
JCLY.2 = "//LOAD2 EXEC PGM=IKJEFT01,DYNAMNBR=32,PARM='%DB2TIACK'";
JCLY.3 = "//SYSTSPRT DD SYSOUT=*";
JCLY.4 = "//SYSPRINT DD SYSOUT=*";
JCLY.5 = "//SYSTSIN DD DUMMY";
JCLY.6 = "//SYSPROC DD DSN=SYSS.TECH.COMMON.EXECLIB,DISP=SHR";
JCLY.7 = "//SYSIN DD *";
JCLY.8 = " UPDATE BUILD.TABRVOLS SET DUMP_STATUS='COMPLETE'";
JCLY.9 = "    WHERE VOLSER='"ONLVOL"' AND DUMP_TYPE='INCRVOL';";
JCLY.10 = " COMMIT;";
JCLY.11 = "/*";
JCLY.12 = "// ENDIF";
JCLY.13 = "// IF (RC>8 × ABEND) THEN";
JCLY.14 = "//LOAD3 EXEC PGM=IKJEFT01,DYNAMNBR=32,PARM='%DB2TIACK'";
JCLY.15 = "//SYSTSPRT DD SYSOUT=*";
JCLY.16 = "//SYSPRINT DD SYSOUT=*";
JCLY.17 = "//SYSTSIN DD DUMMY";
JCLY.18 = "//SYSPROC DD DSN=SYSS.TECH.COMMON.EXECLIB,DISP=SHR";
JCLY.19 = "//SYSIN DD *";
JCLY.20 = " UPDATE BUILD.TABRVOLS SET DUMP_STATUS='FAILURE'";
JCLY.21 = "    WHERE VOLSER='"ONLVOL"' AND DUMP_TYPE='INCRVOL' AND ";
JCLY.22 = "    DUMP_STATUS='ACTIVE';";
JCLY.23 = "/*";
JCLY.24 = "// ENDIF";
JCLY.25 = "//";
INCRCTR=1;
DO I = 1 TO JCLX.0; /* START JCL */
    INCR.INCRCTR = JCLX.I;
    INCRCTR=INCRCTR+1;
END;
K = WORDS(FCTNLIST);
DSNLIST="";
DO I = 1 TO K;
    FCTE=WORD(FCTNLIST,I);
    IF SYMBOL("FCT.FCTE")="VAR" THEN DO;
       DUMMY=OUTTRAP("LISTC.");
       "LISTC ENT('"FCT.FCTE"') ALL";
       DUMMY=OUTTRAP("OFF");
       TYPE=WORD(LISTC.1,1);
       SELECT;
         WHEN (TYPE="CLUSTER") THEN DO;
             IF WORDPOS(FCT.FCTE,DSNLIST)=0 THEN DO;
                 DSNLIST=DSNLIST FCT.FCTE;
                 INCR.INCRCTR=" S CATDSN="FCT.FCTE;
                 INCRCTR=INCRCTR+1;
             END;
             END;
         WHEN (TYPE="PATH") THEN NOP;
         WHEN (TYPE="AIX") THEN DO;
             DO X = 1 TO LISTC.0;
                IF POS("CLUSTER--",LISTC.X)^=0 THEN DO;
                      PARSE VAR LISTC.X . "CLUSTER--" CLDSN . ;
                      CLDSN=STRIP(CLDSN);
             IF WORDPOS(CLDSN,DSNLIST)=0 THEN DO;
                 DSNLIST=DSNLIST CLDSN;
                 INCR.INCRCTR=" S CATDSN="CLDSN;
                 INCRCTR=INCRCTR+1;
                      END;
                    END;
             END X;
             END;
         OTHERWISE DO;
             IF WORDPOS(FCT.FCTE,DSNLIST)=0 THEN DO;
                 DSNLIST=DSNLIST FCT.FCTE;
                 INCR.INCRCTR=" S CATDSN="FCT.FCTE;
                 INCRCTR=INCRCTR+1;
             END;
             END;
       END;
   END;
END;
DO I = 1 TO JCLY.0; /* START JCL */
    INCR.INCRCTR = JCLY.I;
    INCRCTR=INCRCTR+1;
END;
"EXECIO * DISKW INCROUT (FINIS STEM INCR.";
EXIT 0;

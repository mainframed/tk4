/*  REXX EXEC : ( NWALLOCV ).
    FUNCTION  : VERIFIES AND/OR ALLOCATES THE HISTORY AN OLD HISTORY
                DATASETS FOR EACH SERVER VOLUME SPECIFIED IN THE VOLUMES
                PARM FILE FOR THE NETWORK SYSTEMS USER ACCESS LAN BACKUP
                                                                    */
TRACE O
/*     */
HOUSE_KEEPING:
ADDRESS TSO
ARG SERVER SERVOL
IF SERVER = '' THEN DO
   SAY '*** PARM ERROR: LAN SERVER NAME NOT PASSED ON COMMAND LINE.***'
   SAY '*** NWALLOCV EXEC TASK CANCELLED. ***'
   EXIT 1
END
IF SERVOL = '' THEN DO
   SAY '*** PARM ERROR: BACKUP VOL NOT SPECIFIED FOR 'SERVER' LAN BACKUP
   SAY '*** NWALLOCV EXEC TASK CANCELLED. ***'
   EXIT 2
END
VOLPARM = SYSDSN("'SYSS.NETCA."SERVER"."SERVOL".VOLUMES'")
IF VOLPARM = 'DATASET NOT FOUND' THEN DO
   SAY '*** INPUT DSN ERROR: DATASET NOT FOUND FOR:'
   SAY '               (SYSS.NETCA.'SERVER'.'SERVOL'.VOLUMES). ***'
   SAY '*** NWALLOCV EXEC TASK CANCELLED. ***'
   EXIT 28
END
V = 0
DSNSUFX = 'H O'
X = MSG("OFF")
/*  JULDATE = DATE(J)
   JNODE = 'J'JULDATE  */
"FREE FILE(ISPFILE)"
CALL DELETE_WORK_DATASETS
/* *** NWPDS = 'PTECH3.NETCA.'××SERVER'.'JNODE
NWDSN = SYSDSN("'"NWPDS"'")
IF NWDSN = 'OK' THEN SIGNAL MAIN_ROUTINE
CALL DELETE_WORK_DATASETS
"ALLOC DA('"NWPDS"') LIKE('SYS1.PARMLIB') NEW SPACE(1,0) DIR(5) CYLINDER
SRC = RC
IF SRC ^= 0 THEN DO
   SAY '*** ALLOCATE ERROR: ERROR ALLOCATING DATASET ('SERVER'.'JNODE').
   SAY '*** NWALLOC EXEC TASK CANCELLED - RETURN CODE: ('SRC'). ***'
   EXIT SRC
END            *** */

/*     */
MAIN_ROUTINE:
DO 2
   V = V + 1
   SUFX = WORD(DSNSUFX,V)
   VOLDSN = SYSDSN("'PTECH3.NETCA."SERVER"."SERVOL"."SUFX"'")
   IF VOLDSN = 'DATASET NOT FOUND' THEN CALL ALLOCATE_VOLUME_DATASET
END
EXIT 0

/*     S U B R O U T I N E S   S E C T I O N     */

/*     */
DELETE_WORK_DATASETS:
ADDRESS TSO
HLQ = 'PTECH3.NETCA.'SERVER
"DELETE   ('PTECH3.NETCA."SERVER".LISTING')   NONVSAM SCRATCH PURGE"
RETURN
X = OUTTRAP("LSTCAT.","*","CONCAT")
"LISTCAT LEVEL("HLQ")"
SRC = RC
IF SRC ^= 0 THEN DO
   SAY '*** LISTCAT ERROR: MAINT CLEANUP FOR 'SERVER' WORK FILES BYPASSE
   RETURN
END
DO L = 1 TO LSTCAT.0
   DATAKEY = POS("NONVSAM ------- ",LSTCAT.L)
   IF DATAKEY ^= 0 THEN DO
      DATADSN = WORD(LSTCAT.L,3)
      DATADSN = STRIP(DATADSN)
      PARSE VALUE DATADSN WITH NODE1 '.' NODE2 '.' NODE3 '.' NODE4
      JULKEY = SUBSTR(NODE4,1,1)
      IF JULKEY = 'J' THEN DO
         "DELETE   ('"DATADSN"')   NONVSAM SCRATCH PURGE"
      END
   END
END
RETURN

/*     */
ALLOCATE_VOLUME_DATASET:
"ALLOC DA('PTECH3.NETCA."SERVER"."SERVOL"."SUFX"')
LIKE('SYSS.NETCA.MODEL.HIST') NEW SPACE(1,1) TRACKS BLKSIZE(3120)"
SRC = RC
IF SRC ^= 0 THEN DO
   SAY '*** ALLOCATE ERROR: ERROR ALLOCATING 'SERVER' DATASET:'
   SAY '                    (PTECH3.NETCA.'SERVER'.'SERVOL'.'SUFX'). ***
   SAY '*** NWALLOCV EXEC TASK CANCELLED - RETURN CODE: ('SRC'). ***'
   EXIT SRC
END
RETURN

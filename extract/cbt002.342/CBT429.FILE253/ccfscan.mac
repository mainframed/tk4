/*  REXX EXEC :
    THIS EXEC IS DESIGNED TO FACILITATE THE CA-LIBRARIAN SCAN UTILITY
    OF MODULES RESIDING ON A MASTER DATASET.  */

TRACE O
/*     */
HOUSE_KEEPING:
ADDRESS ISPEXEC
"CONTROL ERRORS RETURN"
ACCTCCF = 5200010520000000
LIBSTAT.1 = 'TEST'
LIBSTAT.2 = 'TURN'
LIBSTAT.3 = 'QA'
LIBSTAT.4 = 'EMRG'
LIBSTAT.5 = 'PROD'
LIBTYPE.1 = 'COPY'
LIBTYPE.2 = 'JCL'
LIBTYPE.3 = 'PROC'
LIBTYPE.4 = 'RAMI'
LIBTYPE.5 = 'SRCE'
LIBTYPE.6 = 'SYSI'
M = 'S'
SC = 01
EC = 72
JC = 8
BEGMOD = '*'
ENDMOD = 'ALL'
SCOD = 'ALL'
LN = 00
DELIM = ''
DELIMITER = '/ @ $ % *'
TSOID = SYSVAR(SYSUID)
TSOUS = SUBSTR(TSOID,1,4)
IF TSOUS = 'TECH' THEN M = 'G'
"VGET (ACCTCDE) PROFILE"
IF RC ^= 0 THEN ACCTCDE = ACCTCCF
ADDRESS TSO
X = MSG("OFF")
"FREE FILE(CNTLDD)"
CNTLLIB = 'SYSS.TESTCCF.ISPFILE.CNTLLIB'
MEMBER = TSOID'J'

/*     */
DISPLAY_LIBSCAN_PANELS:
ADDRESS ISPEXEC
"DISPLAY PANEL(LBSCANP1)"
SRC = RC
IF SRC > 8 THEN DO
   SAY '*** PANEL ERROR: ISPF DIALOG ERROR INVOKING PANEL ( LBSCANP1 ).
   SAY '*** LIBSCAN EXEC TASK CANCELLED - RETURN CODE: ('SRC'). ***'
   EXIT
END
IF SRC = 8 THEN EXIT 0
"DISPLAY PANEL(LBSCANP2)"
SRC = RC
IF SRC > 8 THEN DO
   SAY '*** PANEL ERROR: ISPF DIALOG ERROR INVOKING PANEL ( LBSCANP2 ).
   SAY '*** LIBSCAN EXEC TASK CANCELLED - RETURN CODE: ('SRC'). ***'
   EXIT
END
IF SRC = 8 THEN EXIT 0

/*     */
BUILD_SCAN_SUBMIT_JCL:
ADDRESS TSO
CALL ASSIGN_SCAN_VARIABLES
CALL BUILD_SCAN_JCL
CALL BUILD_SCAN_SYSIN
CALL WRITE_SCAN_JOB
CALL SUBMIT_SCAN_JOB
"DELSTACK"
"ALLOC DA('"CNTLLIB"("MEMBER")') FILE(CNTLDD) SHR"
"DELETE '"CNTLLIB"("MEMBER")' FILE(CNTLDD)"
"FREE FILE(CNTLDD)"
EXIT 0

/*     S U B R O U T I N E S   S E C T I O N     */

/*     */
ASSIGN_SCAN_VARIABLES:
C = JC
REGION = 'REGION=6M'
S = LIBSTAT
IF S = 1 THEN DO
   C = 8
   REGION = 'REGION=6M,TYPRUN=HOLD'
END
T = LIBTYPE
JN = JOBNAME
JOBN = LENGTH(JN)
UPPER SCAN1 SCAN2 SCAN3 SCAN4 SCAN5 SCAN6 SCAN7 SCAN8 SCAN9 SCAN10
LBUSER = 'TEMP002'
LBPW = 'LOGROUTE'
IF JOBN < 8 THEN JN = LEFT(JN,8)
MASTRDSN = 'SYSA.'LIBSTAT.S××LIBTYPE.T'.MASTER'
SCOL = LENGTH(SC)
IF SCOL < 2 THEN SC = RIGHT(SC,2,0)
ECOL = LENGTH(EC)
IF ECOL < 2 THEN EC = RIGHT(EC,2,0)
PLEN = LENGTH(LN)
IF PLEN < 2 THEN LN = RIGHT(LN,2,0)
ZONE = 'STR='SC',END='EC
LPRT = ',CTX='LN
IF BEGMOD = '*' THEN DO
   IF ENDMOD = 'ALL' THEN SCANR = '-SCANR ,Z9ZZZZZZ'
   IF ENDMOD ^= 'ALL' THEN SCANR = '-SCANR ,'××ENDMOD
   RETURN
END
IF ENDMOD = 'ALL' THEN SCANR = '-SCANR '××BEGMOD
IF ENDMOD ^= 'ALL' THEN SCANR = '-SCANR '××BEGMOD××','××ENDMOD
RETURN

/*     */
BUILD_SCAN_JCL:
J = 0
"DELSTACK"
RCD.1 = "//"JN" JOB" ACCTCDE",'"TSOID".LIBRSCAN',NOTIFY="TSOID","
RCD.2 = "//     CLASS="C",MSGCLASS="M",MSGLEVEL=(0,0),"REGION
RCD.3 = "//LIBRSCAN EXEC PGM=AFOLIBR"
RCD.4 = "//SYSPRINT DD SYSOUT=*"
RCD.5 = "//LIST     DD SYSOUT=*"
RCD.6 = "//INDEX    DD SYSOUT=*"
RCD.7 = "//OSJOB    DD DUMMY"
RCD.8 = "//MASTER   DD DSN="MASTRDSN",DISP=SHR"
RCD.9 = "//OSJOB    DD DUMMY"
RCD.10 = "//SYSIN    DD *"
RCD.11 = "-OPT UTILITY"
DO 11
   J = J + 1
   QUEUE RCD.J
END
IF ENDMOD ^= 'ALL' THEN DO
   J = J + 1
   RCD.J = SCANR
   QUEUE RCD.J
END
RETURN

/*     */
BUILD_SCAN_SYSIN:
N = 0
R = 0
SCNCNT = 0
SCAN.1 = STRIP(SCAN1)
SCAN.2 = STRIP(SCAN2)
SCAN.3 = STRIP(SCAN3)
SCAN.4 = STRIP(SCAN4)
SCAN.5 = STRIP(SCAN5)
SCAN.6 = STRIP(SCAN6)
SCAN.7 = STRIP(SCAN7)
SCAN.8 = STRIP(SCAN8)
SCAN.9 = STRIP(SCAN9)
SCAN.10 = STRIP(SCAN10)
DO 10
   N = N + 1
   IF SCAN.N = '' THEN ITERATE
   R = R + 1
   SCAND.R = SCAN.N
   SCNCNT = SCNCNT + 1
END
R = 0
DO SCNCNT
   I = 0
   R = R + 1
/* DLEN = LENGTH(SCAND.R)
   IF DLEN > 58 THEN DO
      ZONE = ''              N O O P
      LPRT = ''
   END                     */
   DO 5
      I = I + 1
      W = WORD(DELIMITER,I)
      D = POS(W,SCAND.R)
      IF D ^= 0 THEN ITERATE
      DELIM = W
      LEAVE
   END
   IF DELIM = '' THEN DELIM = '#'
   RCD.R = "-SCAN" DELIM××SCAND.R××DELIM××ZONE××LPRT
   IF SC = 01 & EC = 72 THEN DO
      RCD.R = "-SCAN" DELIM××SCAND.R××DELIM××LPRT
   END
END
R = R + 1
RCD.R = "-END"
R = R + 1
RCD.R = "/*"
R = R + 1
RCD.R = "//"
RCDCNT = J + R
RETURN

/*     */
WRITE_SCAN_JOB:
ADDRESS TSO
"ALLOC DA('"CNTLLIB"("MEMBER")') FILE(CNTLDD) SHR"
SRC = RC
IF SRC ^= 0 THEN DO
   SAY '*** DATASET ALLOCATE ERROR: ('CNTLLIB'('MEMBER'). ***'
   SAY '*** CCFSCAN EXEC SUBTASK CANCELLED - RETURN CODE: ('SRC'). ***'
   EXIT SRC
END
DO R = 1 TO RCDCNT
   QUEUE RCD.R
END
"EXECIO" RCDCNT "DISKW CNTLDD (FINIS"
SRC = RC
IF SRC ^= 0 THEN DO
   SAY '*** WRITE ERROR: ('CNTLLIB'('MEMBER'). ***'
   SAY '*** LIBSCAN EXEC TASK CANCELLED - RETURN CODE: ('SRC'). ***'
   EXIT
END
RETURN

/*     */
SUBMIT_SCAN_JOB:
ADDRESS TSO
"SUBMIT ('"CNTLLIB"("MEMBER")')"
SRC = RC
IF SRC ^= 0 THEN DO
   SAY '*** SUBMIT ERROR: MEMBER ( 'CNTLLIB'('MEMBER'). ***'
   SAY '*** CCFSCAN EXEC SUBTASK CANCELLED - RETURN CODE: ('SRC'). ***'
   EXIT SRC
END
SAY '+++ JOB' JOBNAME ' SUBMITTED. +++'
"DELETE '"CNTLLIB"("MEMBER")' FILE(CNTLDD)"
"FREE FILE(CNTLDD)"
RETURN

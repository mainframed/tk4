EW01     TITLE '''IEDQEW'' - TCAM GET SCHEDULER'
IEDQEW   CSECT
*A000000-999999                                                @X31X8A0
         SPACE 3
**************************** MICROFICHE FLAGS *************** SUPT CODE
*CHANGE-ACTIVITY = AS FOLLOWS:                                  SA21903
*D250000-251000                                                 SA55392
*C454000                                                        SA55392
*C164000                                                        SA54921
*A341640                                                        SA54271
*C341725-341733                                                 SA54271
*C495000                                                        SA54942
*A655000                                                        SA54942
*A603000,133000                                                  A47127
*C102600,663000                                                  A47127
*A121000,156000,167000,253500,328000,402000,539000,544000,567000 S21101
*A686000,539500                                                  S21101
*C 149000,201000,337000,509000,439000-443000,578000-580000       S21101
*C504000                                                         S21101
*D 142000-143000,149000,161000-165000,201000,222000-232000       S21101
*D 314000-315000,317000,346000-351000,362000,383340-385100       S21101
*D 412000,436000,452000,498500-501000,505000                     S21101
*D 548000,550000-551000,565000,570000,625000                     S21101
*D 629000,669000-673000,696000-697000,709000                     S21101
*A340000                                                        SA56624
*C655000                                                        SA56624
*A485000                                                        SA59016
*D506000                                                        SA59016
*D693000                                                        SA58456
*A695000,748600                                                 SA58456
*A205500                                                        SA55392
*C102600,424000,424400,424720,748000                             A47133
*C006400-118000,143120,149000,151000,153000,162000,166000,166500 Y02027
*C167284,167292,167552,167560,167596-167626,167782,167839,167856 Y02027
*C168000,178000,183000,198000,200000,208000-209000,247000,261000 Y02027
*C266000,270000-274600,279000-286000,289000,291000,301070,301000 Y02027
*C310000,319000,321000,323000,328700,3300000,332000,338000,339000Y02027
*C340000,344000,353000,361000,369000,378000,387000,396000,405000 Y02027
*C414000,433000-434000,449000,473200,482000,485500,486000,487000 Y02027
*C488000-490000,493000,497120,497280,497400,497480,497520,497560 Y02027
*C497600,497840-497880,519000,521000,525000,527000,530000,534000 Y02027
*C536000,544100,555000,556030,556180-556360,557000,585000,586300 Y02027
*C621620,621680,622000,630000,631000-632500,636000-637000,639000 Y02027
*C649000,655600-658000,662000-662500,664400,666000,674300,695400 Y02027
*C695600,696200,696800,698000,728000,746000,746200,748300,748600 Y02027
*C750000,033600                                                  Y02027
*A142700,156520-156500,165800,166200,199500,205800,213500        Y02027
*A247200-247600,290500,301070-301840,338500,344500,449500,473300 Y02027
*A486500,487500,519500,584500,620200-620600,624800,630500,639500 Y02027
*A642500,650100-650600,655600-655700,666800-673200,674400        Y02027
*A686850-686950,721200,724300-724800,725400-727400,72900         Y02027
*A746010-746110,748400-748500,748700,032950,033605-033620,267500 Y02027
*D148500,149500-150000,152000,154000-155000,167000,167220-167240 Y02027
*D167774-167778,190000-191000,210000,240000-243000,254000        Y02027
*D293000-298000,353300-360000,363000-368000,370000-377000        Y02027
*D379000-386000,388000-394600,397000-4040000,405200-413000       Y02027
*D414500-432000,439000-448000,439000-448000,450000-473000        Y02027
*D494000-496000,497640,497760,516000,522000,556390,599000-611000 Y02027
*D621040,821080,621120,621340,633000,658500,697400               Y02027
*D701000,702000,703000-705000,718000-719000,722000-723000,731000 Y02027
*D733000,735000-742000,748800,751000,752000,764000               Y02027
*A353300-353600,383100,431600-431700,461100-461500              SA60013
*D453000-454000                                                 SA60013
*A556640-556650                                                 SA60004
*A341290,341361,405000,721000                                    S22024
*C466600-467000                                                 SA60322
*D247500,438500,445000                                          SA61747
*A280000                                                        SA62970
*C291000-292000                                                 SA62970
*D295000,299000                                                 SA62970
*A167309-167339                                                 SA62953
*C167299                                                        SA62953
*A470000                                                        SA63027
*C159000,185000,202000,205600,476000                            SA63961
*C160000,186000,203000,205700,477000                            SA63961
*A695000                                                        SA63961
*A603000                                                        SA63985
*C133200-134500                                                 SA65385
*A309500                                                        SA65388
*A291000,663000                                                 SA67159
*C290500,663100                                                @ZA01105
*A519000                                                       @SA64355
*C461300,592000                                                @SA68228
*A674600                                                       @SA68228
*D240000-241000                                                @SA69091
*C196000                                                       @SA69658
*A031550,033150                                                @ZA00203
*A091245-091260                                                @SA69973
*A655000                                                       @ZA02616
*A488000,658500                                                 SA67792
*A341320                                                         X03039
*C006900,341361                                                  X03039
*C746200-747600,495000,497600,497560                             S21903
*A394000,399000                                                 SA56234
*D726000-727000,729000-730000,732000,743000-744000               S21903
*A353300-353600,383100,431600-431700,461100-461500              SA60013
*D453000-454000                                                 SA60013
*A556640-556650                                                 SA60004
*A286000                                                       @SA69063
*A186000                                                       @SA71093
*C663000                                                       @SA71938
*A696200                                                       @YA06305
*A654000,661000                                                @XA05282
*C592000,684000                                                @XA05282
*A121197                                                       @ZA01154
*D294000-297000                                                @ZA02059
*C186600                                                       @SA73367
*A184000                                                       @SA73367
*C663000,663300                                                @SA74016
*A006000                                                       @Z30X8AM
*C086000                                                       @ZA02645
*A090000,323000,654500,672400,090200                           @ZA03050
*C493000,497520,650200                                         @ZA03050
*D318000-319000,655500                                         @ZA03050
*A661000                                                       @ZA02649
*A245000,748000                                                @ZA03097
*D556480-556630,556660-556690                                  @YA09297
*A639500                                                       @YA09297
*D098500-116000                                                @SA75446
*A084600,085350,748400                                         @ZA05000
*D746100,746110                                                @ZA05000
*C085070                                                       @ZA05000
*C289000,663100                                                @OZ07798
*C643300-644100                                                OZ07100
*A283000,290000,291000                                         @OY11980
*D696400-696600                                                @OS76679
*A158000                                                       @OS77017
*C025070                                                       @OZ09292
*D027810                                                       @OZ09292
*A022420                                                       @OZ09927
*A642500,748240,686900                                         @OZ11164
*A086120                                                       @OZ08360
*C643500-644600                                                @OZ11164
*C044100,044500                                                @OZ14162
*A290300                                                       @OY14498
*C290030                                                       @OY14498
*A663000,746090                                                @OZ11199
*A489500                                                       @OZ15631
*C655100-655200                                                @OZ15631
*A047300,674600,649000,748270                                  @OY15490
*A695000                                                       @OZ17615
* A000000,005581,024200,024500,086080,086120,086130,086140,    @G36XRAW
* A143000,143100,143120,143140,156600,156700,159000,160000,    @G36XRAW
* A185000,186000,198000,199000,202000,203000,205600,205700,    @G36XRAW
* A650300,663200,663300,672600,672800                          @G36XRAW
* C000230,006020,024300,086120,086140,086600,091480,121199,    @G36XRAW
* C125000,143100,143140,153000,156700,160000,165200,184400,    @G36XRAW
* C186000,199000,203000,205700,220000,245120,273800,300000,    @G36XRAW
* C328000,341324-341326,341361,341364,345000,479000,650400,    @G36XRAW
* C663300,672800                                               @G36XRAW
* D341328-341336,341322                                        @G36XRAW
*A205600                                                       @OZ26860
*D205501                                                       @OZ26860
*C488600-488700,489700,655100,657300-657600                    @OX16398
*A727800,727900                                                @OX16398
*D084600                                                       @Z40X9AG
*C085000-085280                                                @Z40X9AG
*        INCLUDE OX16398 AND Z40X9AG IN LEVEL 10               @OZ27023
*C488700                                                       @OZ27022
* DUMMY APAR                                                   @OZ27328
*D200000                                                       @OZ26356
*A203000                                                       @OZ26356
*A245080,748280                                                @OZ26305
*300000,663300,695120                                          @OZ26305
*C301280                                                       @OZ28213
*A086920                                                       @OZ26376
*C037400                                                       @OY20522
***********************************************************************
*TITLE: 'IEDQEW' GET SCHEDULER                                        *
*                                                                     *
*MODULE-NAME = IEDQEW                                           SA21903
*                                                                     *
*DESCRIPTIVE NAME = TCAM GET SCHEDULER                          SA21903
*                                                                     *
* COPYRIGHTS = 'NONE'                                           SA21903
*                                                                     *
* STATUS: CHANGE LEVEL 10                                      @G36XRAW
*                                                                     *
*FUNCTION: THIS ROUTINE PERFORMS THREE FUNCTIONS: (1) GET-MCP SUBTASK *
*   WHEN A GET IS ISSUED, (2) GET SCHEDULER, (3),RETRIEVING MESSAGES. *
*   THIS ROUTINE CONTAINS THE GET QCB TO WHICH SVC 102 POST AN RCB    *
*   IN AN AIB. THIS SUBTASK CHECKS FOR MESSAGES ON THE READ AHEAD     *
*   QUEUE. FOR QSAM IF NO MESSAGES,EXIT IS MADE TO THE DISPATCHER TO  *
*   WAIT.  FOR BSAM IF NO MESSAGES ON READ AHEAD OR DEST QCB, THE     *
*   WORKAREA POINTER IN THE PEWA IS ZEROED AND ECB IS POSTED COMPLETE *
*   TO RETURN TO IEDQEB.                                              *
*                                                                     *
*   IF BUFFER IS ON QUEUE, THE DATA IS MOVED FROM THE BUFFER INTO     *
*   THE WORKAREA OF THE AIB.  THE DATA IS MOVED UNTIL AN ENTIRE       *
*   WORK UNIT IS MOVED, THE WORKAREA IS FULL, OR THE END OF A MESSAGE *
*   IS REACHED, OR END OF BUFFERS. WHEN BUFFERS ARE EMPTIED, THEY     *
*   ARE RETURNED TO THE BUFFER RETURN QCB. THE WORKAREA POINTER IN    *
*   THE PEWA IS ZEROED, WORKAREA FULL IS SET IN AIB, AND ECB IS POSTED*
*   COMPLETE TO RETURN TO IEDQEB.                                     *
*                                                                     *
*   AT THE USER'S OPTION, THIS SUBTASK PLACES THE NAME OF THE SOURCE  *
*   TERMINAL, DATE, TIME, AND/OR WORKAREA CONTENTS DESCRIPTOR BYTE    *
*   IN THE WORKAREA.                                                  *
*                                                                     *
*   THE SCHEDULER ROUTINE PERFORMS A READ AHEAD FUNCTION FROM A       *
*   DESTINATION QUEUE IN ANTICIPATION OF A USER'S GET OR READ.  ALSO, *
*   IT REACTS TO AND SERVICES RETRIEVE REQUESTS.  IT WAITS ON EITHER  *
*   THE READ-AHEAD OR PROCESS QCB.  IT WAITS ON THE DESTINATION       *
*   PROCESS QCB UNTIL A COMPLETE MESSAGE HAS BEEN RECEIVED.  FULL     *
*   BUFFERS ARE POSTED TO THE DESTINATION SCHEDULER.  WHEN THE        *
*   DESTINATION SCHEDULER SEES AN EOM BUFFER, IT BRANCHES TO A        *
*   SPECIAL ENTRY POINT IN THE GET SCHEDULER.  IT QWAITS ON THE READ- *
*   AHEAD QCB, POSTS A SPECIAL ELEMENT TO ITSELF, AND RETURNS CONTROL *
*   TO THE DESTINATION SCHEDULER.                                     *
*                                                                     *
*   AS LONG AS BUFFERS ARE AVAILABLE, THE GET SCHEDULER POSTS AN ERB  *
*   TO DISK I/O TO READ DATA FROM THE DESTINATION QUEUE.  IT RECEIVES *
*   THE ERB CONTAINING A BUFFER CHAIN.  BUFFERS ARE PLACED IN A QUEUE *
*   PRIOR TO POSTING THEM TO THE SEND MH FOR THE APPLICATION PROGRAM. *
*   CARE IS TAKEN TO INSURE THAT NO MORE THAN ONE MESSAGE HAS BEEN    *
*   PROCESSED BY MH BUT NOT BY THE APPLICATION PROGRAM AT ANY GIVEN   *
*   TIME.  A HEADER BUFFER IS NOT POSTED TO MH FOR PROCESSING AND     *
*   SUBSEQUENT POSTING TO THE READ-AHEAD QCB UNTIL THE EOM BUFFER FOR *
*   THE PREVIOUS MESSAGE HAS BEEN FLAGGED SERVICED.                   *
*   IF THE WORKAREA ADDRESS OF THE AIB IS IN THE PEWA WHEN A FULL     *
*   BUFFER IS PLACES ON THE RAQUEUE, THE DATA IS MOVE BY THE GET      *
*   SUBTASK.                                                          *
*                                                                     *
*   WHEN A GET IS ISSUED AFTER A POINT, THIS ROUTINE WAITS FOR THE ERB*
*   TO BECOME FREE.  AT THAT TIME, FULL BUFFERS ARE SAVED ALONG WITH  *
*   SCB INFORMATION NECESSARY TO RESUME SEQUENTIAL GET.  IT THEN      *
*   PREPARES THE SCB AND ERB FOR RECALL FROM THE SPECIFIED DESTINATION*
*   QUEUE AND POSTS THE ERB TO DISK I/O.  AN ERB WITH RECALLED BUFFER *
*   ATTACHED IS RETURNED.  EACH HEADER IN QBACK CHAIN IS TESTED FOR   *
*   THE CORRECT INPUT OR OUTPUT SEQUENCE NUMBER.  IF IT CANNOT BE     *
*   FOUND, AN ERROR CODE IS STORED IN THE PEWA. IF THE DESIRED NUMBER *
*   IS FOUND, THE ENTIRE MESSAGE IS RECALLED.  IF THE GET SCHEDULER   *
*   RECEIVES AN 'EXIT-RETRIEVE-MODE' REQUEST BEFORE THE ENTIRE        *
*   MESSAGE IS RECALLED, IT RETURNS FILLED BUFFERS TO BUFFER AND      *
*   RETURNS TO SEQUENTIAL GET MODE.  THIS ACTION ALSO OCCURS WHEN     *
*   THE EOM BUFFER IS RETRIEVED.                                      *
*                                                                     *
*ENTRY POINT:                                                         *
*        IEDQEW                                                       *
*        TAG   (BY IEDQHM, CALCULATED BY OFFSET IN GETQCB)            *
*                                                                     *
*INPUT:                                                               *
*   1  - ONE OF THE FOLLOWING:                                        *
*        (1) ELEMENT REQUEST BLOCK                                    *
*        (2) PARAMETER LIST                                           *
*        (3) FULL BUFFER                                              *
*        (4) BUFFER WHEN GET SCHEDULER WAITING IN DESTINATION QCB     *
*        (5) SPECIAL 'QWAIT' ELEMENT                                  *
*   11 - DISPATCHER ADDRESS                                           *
*   13 - REGISTER SAVEAREA ADDRESS                                    *
*   15 - ENTRY POINT ADDRESS                                          *
*                                                                     *
*OUTPUT:                                                              *
*        NONE                                                         *
*                                                                     *
*EXTERNAL ROUTINES:                                                   *
*        OS POST - CROSS MEMORY                                       *
*                                                                     *
*EXITS-NORMAL:                                                        *
*        DSPDISP                                                      *
*        DSPCHAIN                                                     *
*        DSPPOSTR                                                     *
*                                                                     *
*EXIT-ERROR:  NONE                                                    *
*                                                                     *
*TABLES/WORKAREAS:                                                    *
*        AIB                                                          *
*        PEB                                                          *
*        TNT                                                          *
*        AVT                                                          *
*        QCB                                                          *
*        SCB                                                          *
*        LCB                                                          *
*        PROCESS/TERMINAL ENTRY                                       *
*        PCB                                                          *
*        PEWA                                                         *
*                                                                     *
*NOTES: THE OPERATION OF THIS MODULE DEPENDS UPON AN INTERNAL         *
*   REPRESENTATION OF THE EXTERNAL CHARACTER SET WHICH IS EQUIVALENT  *
*   TO THE ONE USED AT ASSEMBLY TIME.  THE CODING HAS BEEN ARRANGED   *
*   SO THAT REDEFINITION OF 'CHARACTER' CONSTANTS, BY REASSEMBLY,     *
*   WILL RESULT IN A CORRECT MODULE FOR THE NEW DEFINITIONS.          *
*                                                                     *
***********************************************************************
         EJECT
RZERO    EQU   0                        GENERAL COUNTER REGISTER
RPARM    EQU   1                        PARAMETER REGISTER
RBASE2   EQU   2                        SECOND BASE REGISTER     Y02027
RSTCB    EQU   3                        STCB BASE REGISTER       Y02027
RWORK    EQU   4                        GENERAL WORK REGISTER    Y02027
RTEMP    EQU   5                        GENERAL WORK REGISTER
RRCB     EQU   RPARM                    RCB BASE REGISTER
RBFR     EQU   6                        BUFFER ADDRESS           Y02027
RQCB     EQU   7                        QCB BASE REGISTER
RGETWORK EQU   8                        PROCESS ENTRY WORKAREA
*                                       BASE REGISTER
RSCB     EQU   9                        SCB BASE REGISTER
RCOUNT   EQU   9                        COUNT OF BYTES FILLED    Y02027
RERB     EQU   10                       ERB BASE REGISTER
RDISP    EQU   11                       DISPATCHER BASE REGISTER
RBASE    EQU   12                       GET SCHEDULER BASE REGISTER
RAVT     EQU   13                       AVT BASE REGISTER
RETURN   EQU   14                       RETURN ADDRESS REGISTER
RENTRY   EQU   15                       ENTRY POINT/RETURN CODE REG
*              THE FOLLOWING 3 WORDS IS A QCB-STCB FOR THE MCP-  Y02027
*              GET ROUTINE. ELEMENTS (IN AIB) ARE POSTED TO THIS Y02027
*              QCB BY SVC 102.  SINCE THE FIRST 2 WORDS ARE NOT  Y02027
*              NEEDED FOR QCB, THEY CONTAIN THE OFFSET AND       Y02027
*              BRANCH IF ENTERED AS A SCHEDULER.                 Y02027
         DS    0F                                                Y02027
GETQCB   DC    AL2(TAG-IEDQEW)          OFFSET USED BY HM        Y02027
         SPACE 2
         SPACE 2
         USING *,RENTRY                 BASE REG FOR BRANCH      Y02027
         B     GETSCHED                 BRANCH TO GET SCHEDULER  Y02027
         DS    0F                       STCB POINTER AND STCB    Y02027
         DC    AL1(DSPMCPL6)            MCPL FOR LAT STCB FOR    Y02027
*                                       RAQCB (QEVENT)           Y02027
         DC    AL3(GSTCB)               QCB STCB POINTER         Y02027
*                                       FOR GET QCB              Y02027
         DC    AL2(0)                   PRIORITY OF LAST STCB    Y02027
*                                       INDICATOR                Y02027
IEDQEW   IEDHJN
GSTCB    DC    AL1(DSPMCPL2)            GET                      Y02027
         DC    AL1(0)                   STCB                     Y02027
*              CODE EXECUTED AS RESULT OF ELEMENT POSTED TO      Y02027
*              GET QCB.                                          Y02027
         EJECT                                                   Y02027
*                                                                Y02027
*              ADDRESSABILITY                                    Y02027
*                                                                Y02027
         BALR  RBASE,RZERO              ESTABLISH ADDRESSABILITY Y02027
LABEL    EQU   *                                                 Y02027
         DROP  RENTRY                                            Y02027
         USING *,RBASE                  CSECT ADDRESSABILITY     Y02027
         LA    RBASE2,GETSCHED-LABEL(RBASE) ESTABLISH SECOND     Y02027
         USING GETSCHED,RBASE2          BASE REGISTER            Y02027
         EJECT
         USING IEDQPEWA,RGETWORK        GET SCHEDULER                  X
                                        PROCESS ENTRY                  X
                                        WORKAREA ADDRESSABILITY
         USING IEDQDISP,RDISP           DISPATCHER ADDRESSABILITY
         USING AVTSAVE2,RAVT            AVT ADDRESSABILITY       Y02027
         USING IEDQQCB,RQCB             QCB ADDRESSABILITY
         USING IEDQSCB,RSCB             SCB ADDRESSABILITY
         USING LCBERB,RERB              ERB ADDRESSABILITY
         SH    RRCB,AVTHA16             BACK UP TO BEGINNING OF  Y02027
         USING IEDQAIB,RRCB             AIB FOR ADDRESSABILITY   Y02027
         L     RGETWORK,AIBGPEWA        GET PEWA ADDRESS         Y02027
         LA    RETURN,DSPDISP           SET RETURN FOR POSSIBLE  Y02027
*                                       ERROR OR EMPTY QUEUE     Y02027
         MVC   PEWAWA,AIBWAPTR          SAVE WORK AREA PTR     @OZ09927
         MVC   PEWAECBA(4),AIBECBA       MOVE ECB ADDR           Y02027
         TM    PEWAFLG,PEWASTOP         PROCESS ENTRY DISABLED   Y02027
         BO    STOPERR                  BR IF YES                Y02027
*                                                                Y02027
*              TEST FOR GET FOR RETRIEVAL                        Y02027
*                                                                Y02027
         CLI   PEWARTVE+TWO,BLANK       RETRIEVE TERMINATION     Y02027
         BE    OUTRX                    BRANCH IF YES            Y02027
         TM    PEWAOPTC,RTVFLG          RETRIEVE MODE FLAG SET   Y02027
         BNO   NORETR                   RETRIEVE NOT REQUESTED   Y02027
         TM    PEWAGSW,RETRIEVE         RETRIEVE OK NOW          Y02027
         BO    RETRVE                   BRANCH IF YES            Y02027
NORETR   EQU   *                                                 Y02027
         CLI   PEWASAVE,AVTECD12        RETRIEVE ERROR           Y02027
         BE    GOODRETC                 BRANCH IF YES TO RETURN  Y02027
*                                                                Y02027
*              CHECK FOR MESSAGE READ AHEAD                      Y02027
*                                                                Y02027
         CLC   PERAQCB+1(3),AVTDELAD+1  READ-AHEAD QUEUE EMPTY   Y02027
         BNE   GO                       BRANCH IF NOT EMPTY      Y02027
         TM    AIBMACRF,QSAMFLG         QSAM DCB                 Y02027
         BNO   NOTQSAM                  BRANCH IF NOT QSAM     @G36XRAW
         BAL   RETURN,DSPDISP           BRANCH IF QSAM TO      @G36XRAW
*                                       DISPATCH. IEDQEB WILL    Y02027
*                                       WAIT TILL MSG PUT ON Q.  Y02027
NOTQSAM  EQU   *                                               @G36XRAW
         XC    AIBDECS+1(3),AIBDECS+1   CLEAR TO ZERO            Y02027
         MVI   AIBDECS,EOQ              SET C.C. TO INDICATE READY02027
*                                       AHEAD QUEUE AND DEST. Q. Y02027
*                                       ARE EMPTY BEFORE TESTS   Y02027
         TM    PEWAFLG,ERBBUSY          ERB POSTED               Y02027
         BNO   SETECB                   NO, BR                 @OZ09292
         MVI   AIBDECS,EOD              ON DEST. QUEUE BUT NOT   Y02027
*                                       ON READ-AHEAD QUEUE      Y02027
SETECB   EQU   *                        PREPARE FOR POST         Y02027
         XC    PEWAWA(4),PEWAWA         ZERO WORKAREA POINTER SO Y02027
*                                       MSG WILL NOT BE PUT IN   Y02027
*                                       AIB WHEN PUT ON R.A. Q.  Y02027
         MVC   AIBCMPTG(4),PEWAECBA     PUT ECB ADDR IN POST LISTY02027
         MVC   PEWAECBA+ONE(3),AIBDECBG+ONE SET DECBAS ECBTO BE  Y02027
*                                       POSTED WHEN MSG PUT ON   Y02027
*                                       R.A QUEUE.               Y02027
         SR    RENTRY,RENTRY            GOOD RETURN              Y02027
         B     XMPOST1                  CROSS MEMORY POST ECB    Y02027
*                                       SVC 102 IS WAITING ON    Y02027
         SPACE 2
STOPERR  EQU   *                                                 Y02027
         LA    RENTRY,STOPQRC           DISABLE ENTRY CODE       Y02027
         B     XMPOST                   RETURN                   Y02027
         EJECT                                                   Y02027
GO       EQU   *                        MESSAGE ON QUEUE         Y02027
         USING IEDQPRF,RBFR             BUFFER PREFIX ADDRESS    Y02027
         L     RBFR,PEWAPEBF            GET ADDR OF PART BUFFER  Y02027
         TM    PEWAOPTC,PARTBUF         PARTIAL BUFFER EMPTY     Y02027
         BNZ   BEGIN                    BRANCH IF PARTIAL BUFFER Y02027
*                                                                Y02027
*              INITIALIZE FOR NEW BUFFER                         Y02027
*                                                                Y02027
         L     RBFR,PERAQCB             ADDR OF NEW BUFFER       Y02027
         ST    RBFR,PEWAPEUN            SAVE CURRENT UNIT        Y02027
         LH    RTEMP,PRFSIZE            GET BUFFER SIZE          Y02027
         N     RTEMP,AVTCLRHI           AND CLEAR TOP HALF WORD  Y02027
         LA    RWORK,AVTTXTSZ           ASSUME TEXT, PREFIX SIZE Y02027
         TM    PRFSTAT1,PRFNHDRN        HEADER BUFFER ?          Y02027
         BO    TEXT                     BRANCH IF TEXT           Y02027
         LA    RWORK,AVTHDRSZ           GET HEADER PREFIX SIZE   Y02027
TEXT     SR    RTEMP,RWORK              COMPUTE DATA SIZE AND    Y02027
         STH   RTEMP,PEWAPSZE           SAVE IN PEWA             Y02027
         STH   RTEMP,PEWAUSZE           ASSUME DATA SIZE IS LESS Y02027
*                                       THAN UNIT SIZE           Y02027
         LH    RTEMP,AVTKEYLE           GET LENGTH OF A BUFFER   Y02027
*                                       UNIT LESS UNIT MANAGEMENTY02027
*                                       AREA                     Y02027
         CH    RTEMP,PRFSIZE            CAN LOGICAL BUFFER BE    Y02027
*                                       CONTAINED IN ONE UNIT    Y02027
         BNL   CKCLOSE                  BRANCH IF NO             Y02027
         SR    RTEMP,RWORK              SUBTRACT PREFIX SIZE TO  Y02027
         STH   RTEMP,PEWAUSZE           OBTAIN MAX DATA LENGTH   Y02027
CKCLOSE  EQU   *                        CHECK FOR CLOSEDOWN      Y02027
         ICM   RCOUNT,THREE,PRFSIZE     ZERO LENGTH BUFFER       Y02027
         BNZ   NFCLOSE                  BRANCH IF NO             Y02027
         MVC   PERAQCB+ONE(3),PRFLINK   DELINK BUFFER            Y02027
         B     CLOSE                    POST CLOSE ELEMENT       Y02027
NFCLOSE  EQU   *                                                 Y02027
         TM    PRFSTAT1,PRFNHDRN        HEADER BUFFER ?          Y02027
         BO    BEGIN                    BRANCH IF NO             Y02027
         NI    PEWAGSW+1,AVTEFF-EOM     TURN OFF EOM             Y02027
         TM    AVTBIT1,AVTCLOSN+AVTQUCKN CLOSEDOWN IN PROGRESS   Y02027
         BNO   CHECKEOF                 BRANCH IF NO             Y02027
CLOSE    EQU   *                                                 Y02027
         LA    RENTRY,FOUR              SET EODAD CODE           Y02027
         LA    RETURN,DSPDISP           SET RETURN TO DISPATCHEROZ00203
         B     XMPOST                   CROSS MEMORY POST ECB    Y02027
*                                       TO RETURN TO IEDQEB      Y02027
CHECKEOF EQU   *                                                 Y02027
         NI    PEWAGSW,AVTEFF-RETRIEVE  CAN NOT DO RETRIEVE      Y02027
         TM    PRFSTAT1,PRFEOFN         SETEOF DONE FOR BUFFER   Y02027
         BNO   BEGIN                    BRANCH IF NO             Y02027
         OI    PEWAOPTC,EODADFLG        SET EODAD TO BE INSPECTEDY02027
*                                       ON NEXT GET/READ         Y02027
         EJECT
BEGIN    EQU   *                        CHECK FOR SOWA ERROR     Y02027
*                                       DURING GET               Y02027
         L     RWORK,AIBWAPTR           WORKAREA ADDRESS         Y02027
         CLC   PEWASOWA(2),AVTFZERO     VALID SOWA SPECIFIED     Y02027
         BNE   SOWAOK                   BRANCH IF YES            Y02027
BADLRECL EQU   *                        LRECL=0 FOR FIXED IS INVAY02027
         MVI   AIBDECS,SOWACC           BAD SOWA CODE            Y02027
         LA    RENTRY,SOWACC            SET COMPLETION CODE      Y02027
         LA    RETURN,DSPDISP           SET RETURN TO DISPATCHEROZ00203
         B     XMPOST                   CROSS MEMORY POST ECB    Y02027
*                                       TO RETURN TO IEDQEB      Y02027
SOWAOK   SR    RCOUNT,RCOUNT            CLEAR REGISTER           Y02027
         TM    AIBRECFG,FIXFLG          FIXED OR UNDEFINED?      Y02027
         BNO   VARIABLE                 BR IF NEITHER            Y02027
         CLI   AIBRECFG,FIXFLG          IS IT FIXED              Y02027
         BNE   OPTCDTST                 BR IF NOT                Y02027
         CLC   PEWALREC(2),AVTFZERO     LRECL=0                  Y02027
         BE    BADLRECL                 BR TO SET COMP CODE      Y02027
         B     OPTCDTST                 CK OPTCD                 Y02027
VARIABLE EQU   *                                                 Y02027
*                                                                Y02027
*                                       IF VARIABLE              Y02027
*              ADJUST SIZES FOR PREFIX                           Y02027
*                                                                Y02027
         XC    0(4,RWORK),0(RWORK)      ZERO PREFIX              Y02027
         LA    RWORK,PRFLEN(RWORK)      INCREMENT WORKAREA PTR   Y02027
*                                       BY SAM PREFIX LENGTH     Y02027
         LA    RCOUNT,PRFLEN(RCOUNT)    INCREMENT BYTE COUNTER   Y02027
*                                       BY SAM PREFIX LENGTH     Y02027
         TM    AIBMACRF,QSAMFLG         QSAM DCB                 Y02027
         BO    OPTCDTST                 BRANCH IF YES            Y02027
         TM    AIBRECFG,BLKFLG          VARIABLE BLOCKED         Y02027
         BNO   OPTCDTST                 BRANCH IF NO             Y02027
         XC    0(4,RWORK),0(RWORK)      ZERO BSAM PREFIX         Y02027
         LA    RWORK,PRFLEN(RWORK)      UPDATE WORKAREA PTR FOR  Y02027
*                                       BSAM PREFIX              Y02027
         LA    RCOUNT,PRFLEN(RCOUNT)    UPDATE BYTE COUNTER FOR  Y02027
*                                       BSAM PREFIX              Y02027
OPTCDTST EQU   *                                                 Y02027
         TM    AIBOPTCG,CTLBYTE         OPTCD=C SPECIFIED        Y02027
         BNO   TSEARCH                  BRANCH IF NO             Y02027
         ST    RWORK,AIBCTLG            SAVE ADDRESS OF CTL BYTE Y02027
*                                       IN WORKAREA              Y02027
         MVI   0(RWORK),ISEGFLAG        SET DEFAULT VALUE        Y02027
         LA    RWORK,CBYTELEN(RWORK)    INCREMENT WORKAREA PTR   Y02027
*                                       BY ONE                   Y02027
         LA    RCOUNT,CBYTELEN(RCOUNT)  INCREMENT BYTE COUNTER   Y02027
*                                       BY ONE                   Y02027
*                                                                Y02027
*              CHECK FOR DATE, TIME, AND SOURCE OPTIONS          Y02027
*                                                                Y02027
TSEARCH  EQU   *                                                 Y02027
         TM    AIBOPTCG,TNMEFLG         OPTCD=W SPECIFIED        Y02027
         BNO   CHKDTS                   NO, CHECK DATE           Y02027
         MVC   0(8,RWORK),BLANKS        INITIALIZE FIELD         Y02027
CHKDTS   EQU   *                                                 Y02027
         L     RTEMP,PEWAPROC           PROCESS ENTRY ADDRESS    Y02027
         TM    PEWAOPT2,PEWADATE        DATE=YES SPECIFIED?    @OY20522
         BNO   CHKNAME                  NO CHECK FOR NAME NEEDED Y02027
         TM    PRFSTAT1,PRFNHDRN        HEADER?                  Y02027
         BO    CHKNAME                  NO, IGNORE DATE AND TIME Y02027
         TM    PEWAOPTC,PARTBUF         IS THIS A PARTIAL BUFFER Y02027
         BO    CHKNAME                  YES, DATE PROVIDED       Y02027
         ICM   RTEMP,SEVEN,PEWADTSA     DTS AREA SPECIFIED       Y02027
         BZ    CHKNAME                  NO IGNORE TIME/DATE      Y02027
         MVI   AIBKEY+ONE,AVTEZERO      ZERO TPDATE              Y02027
         MVC   AIBKEY+TWO(SIX),AIBKEY+ONE DATE TIME FIELD        Y02027
         MVC   PEWAELEM+EIGHT(EIGHT),BLANKS BLANK NAME           Y02027
         OI    PEWAOPT2,DATE            INDICATE OPTION USED     Y02027
         B     NAME                     GET NAME                 Y02027
CHKNAME  EQU   *                                                 Y02027
         TM    AIBOPTCG,TNMEFLG         DCBOPTCD=W               Y02027
         BNO   NOSEARCH                 BRANCH IF NO             Y02027
NAME     EQU   *                                                 Y02027
         MVI   AIBKEY,AVTEZERO          INIT AIB FOR NO TPDATE   Y02027
         SR    RSTCB,RSTCB              CLEAR FOR ICM            Y02027
         ICM   RSTCB,THREE,PRFSRCE      GET TERMNAME TABLE INDEX Y02027
*                                       FOR SOURCE               Y02027
         BZ    NONAME                   BRANCH IF NO SOURCE      Y02027
*                                       SPECIFIED                Y02027
         L     RTEMP,AVTRNMPT           ADDR OF TERMNAME TABLE   Y02027
         BCTR  RSTCB,RZERO              DECREMENT INDEX BY ONE   Y02027
         STH   RSTCB,PEWASRCE           STORE INDEX              Y02027
         SR    RSTCB,RSTCB              CLEAR AGAIN              Y02027
         IC    RSTCB,TNTENLEN-IEDQTNTD(RTEMP) LENGTH OF TNT ENTRYY02027
         LR    RENTRY,RSTCB             SAVE ENTRY LENGTH        Y02027
         AH    RSTCB,AVTHA3             BUMP TO TTABLE POINTER   Y02027
         LA    RTEMP,TNTOFF(RTEMP)      ADDR OF FIRST ENTRY IN   Y02027
*                                       TERMNAME TABLE           Y02027
         MH    RSTCB,PEWASRCE           COMPUTE DISPLACEMENT OF  Y02027
         AR    RTEMP,RSTCB              THE SOURCE TNT ENTRY     Y02027
         LR    RSTCB,RENTRY             RESTORY ENTRY LENGTH     Y02027
NONAME   EQU   *                                                 Y02027
         BCTR  RSTCB,RZERO              DECREMENT NUMBER OF      Y02027
*                                       BYTES BY ONE             Y02027
         TM    AIBOPTCG,TNMEFLG         DCBOPTCD=W               Y02027
         BNO   MOVESRC                  BRANCH IF NO, CHECK DATE Y02027
         LTR   RSTCB,RSTCB              OFFSET PRESENT           Y02027
         BM    NOMOVE                   BRANCH IF NONE           Y02027
         EX    RSTCB,MOVENME            MOVE NAME                Y02027
NOMOVE   EQU   *                                                 Y02027
         LA    RWORK,SRCELEN(RWORK)     INCREMENT WORKAREA PTR   Y02027
*                                       BY LENGTH OF SOURCE NAME Y02027
         LA    RCOUNT,SRCELEN(RCOUNT)   INCREMENT BYTE COUNTER BYY02027
MOVESRC  EQU   *                        LENGTH OF SOURCE NAME    Y02027
         TM    PEWAOPT2,DATE            DATE SPECIFIED           Y02027
         BNO   NOSEARCH                 NO IGNORE NAME           Y02027
         LA    RENTRY,PEWAELEM          GET TPDATE SRC ADDRESS   Y02027
         LTR   RSTCB,RSTCB              OFFSET PRESENT           Y02027
         BM    NOMOVE2                  BRANCH IF NO             Y02027
         EX    RSTCB,MOVE2              MOVE SOURCE              Y02027
NOMOVE2  EQU   *                                                 Y02027
         CLC   PRFSRCE,PRFDEST          OPCTL RESPONSE         @SA69063
         BE    NOSEARCH                 BRANCH YES             @SA69063
         LA    RSTCB,PRFSHDR            GET START OF DATA        Y02027
         AH    RSTCB,PRFSCAN            BUMP PAST IDLES          Y02027
         MVC   AIBKEY+ONE(SEVEN),ONE(RSTCB) PUT DATE TIME IN AIB Y02027
         MVI   AIBKEY,DATE              INDICATE DATE/TIME STAMP Y02027
*                                       AVAILABLE IN AIB         Y02027
         EJECT
NOSEARCH EQU   *                                                 Y02027
         LH    RTEMP,PEWASOWA           SIZE OF WORKAREA         Y02027
         N     RTEMP,AVTCLRHI           CLEAR HIGH ORDER HALF    Y02027
         SR    RTEMP,RCOUNT             EFFECTIVE WORKAREA LENGTHY02027
         STH   RTEMP,PEWASOWA           SAVE LENGTH              Y02027
         MVC   PEWALREC(2),AIBLRECL     INIT WORK AREA FIELD     Y02027
         L     RENTRY,PEWAMOVE          ADDR OF NEXT BYTE FOR    Y02027
*                                       PART-EMPTY BUFFER        Y02027
         TM    PEWAOPTC,PARTBUF         PARTIALLY EMPTY BUFFER   Y02027
         BNO   NOTEMPTY                 BRANCH IF NO           @OZ14162
         MVI   AIBEXLFG,AVTEZERO        SET NO CHECKPOINT TAKEN@OZ14162
         B     PARTEMP                  PROCESS PARTIALLY      @OZ14162
*                                        EMPTY BUFFER          @OZ14162
NOTEMPTY EQU   *                                               @OZ14162
         LA    RENTRY,PRFSTXT           ADDR OF DATA IN BUFFER   Y02027
*                                       IF TEXT                  Y02027
         TM    PRFSTAT1,PRFNHDRN        HEADER BUFFER            Y02027
         BNO   HDRBFR                   BRANCH IF YES          @OZ14162
         MVI   AIBEXLFG,AVTEZERO        SET NO CHECKPOINT TAKEN@OZ14162
         B     POSTHDRX                 PROCESS NON-HEADER BFR @OZ14162
HDRBFR   EQU   *                                               @OZ14162
         LA    RENTRY,PRFSHDR           ADDR OF DATA IN HEADER   Y02027
*                                                                Y02027
*              CHECK FOR ENVIRONMENT CHECKPOINT TAKEN            Y02027
*                                                                Y02027
         TM    AIBEXLFG,CKPTFLG         CHECK POINT EXIT SPECIF'DY02027
         BNO   SETNO                    BRANCH IF NO             Y02027
         L     RTEMP,AIBPCBAD           GET PCB ADDRESS          Y02027
         TM    PCBOFLG-IEDQPCB(RTEMP),PCBCKPTN  CKPT ISSUED SINCEY02027
*                                       LAST HEADER EXAMINED     Y02027
         BNO   SETNO                    BRANCH IF NO             Y02027
         NI    PCBOFLG-IEDQPCB(RTEMP),PCBCKPTF IF YES,TURN OFF   Y02027
*                                       FLAG                     ×02027
         B     CTEST                    BYPASS NO SETTING        Y02027
SETNO    MVI   AIBEXLFG,AVTEZERO        SET NO CHECKPOINT TAKEN  Y02027
*                                       IF AIBEXLFG = CKPTFLG    Y02027
*                                       EXLST EXIT IS TO BE TAKENY02027
CTEST    EQU   *                                                 Y02027
         TM    AIBOPTCG,CTLBYTE         CONTROL BYTE SPECIFIED   Y02027
         BNO   POSTHDRX                 BRANCH IF NO             Y02027
         L     RTEMP,AIBCTLG            GET ADDRESS CONTROL BYTE Y02027
*                                       IN WORK AREA             Y02027
         MVI   0(RTEMP),HDRFLG          SET HEADER FLAG IN       Y02027
*                                       CONTROL BYTE             Y02027
         EJECT
*                                                                Y02027
*              FOR MULTIPLE RETRIEVAL, SEVERAL FIELDS MUST BE    Y02027
*              MOVED INTO THE USERS WORKAREA                     Y02027
*                                                                Y02027
         TM    PRFSTAT1,PRFDUPLN        RECALLED BUFF          @OY15490
         BNO   POSTHDRX                 BR NO                  @OY15490
         TM    PEWARTVE+THREE,MULTSEQ   MULTIPLE RETIEVAL MODE   Y02027
         BNO   POSTHDRX                 BRANCH IF NO             Y02027
         MVC   ZERO(2,RWORK),PRFSRCE    SAVE SOURCE TNT OFFSET   Y02027
         MVC   TWO(1,RWORK),PRFSTAT1    STATUS                   Y02027
         MVC   THREE(2,RWORK),PRFISEQ   INPUT SEQUENCE NUMBER    Y02027
         MVC   FIVE(2,RWORK),PRFCORE    OUTPUT SEQUENCE NUMBER   Y02027
         MVC   SEVEN(2,RWORK),PRFDEST   DESTINATION              Y02027
         MVC   NINE(1,RWORK),PRFSCAN+ONE GIVE USER NO. OF IDLES  Y02027
         LH    RTEMP,PEWASOWA           WORKAREA SIZE            Y02027
         N     RTEMP,AVTCLRHI           CLEAR HI-ORDER HALF      Y02027
         LA    RSTCB,TEN                SIZE OF RETR INFO        Y02027
         SR    RTEMP,RSTCB              SUBTRACT 10              Y02027
         STH   RTEMP,PEWASOWA           RESET WORK AREA SIZE     Y02027
         LA    RWORK,TEN(RWORK)         UPDATE WORKAREA PTR      Y02027
         LA    RCOUNT,TEN(RCOUNT)       UPDATE BYTE COUNTER      Y02027
         B     PARTEMP                  PRETEND IDLES NOT THERE  Y02027
         EJECT
POSTHDRX EQU   *                                                 Y02027
         LH    RSTCB,PRFSCAN            GET IDLE COUNT           Y02027
         TM    PEWAOPT2,DATE            DATE/TIME SPECIFIED      Y02027
         BZ    NODTS                    BR IF NO                 Y02027
         LA    RSTCB,PARMLEN(RSTCB)     BUMP PAST DATE/TIME      Y02027
         NI    PEWAOPT2,AVTEFF-DATE     TURN OFF FLAG            Y02027
NODTS    EQU   *                                                 Y02027
         LH    RTEMP,PEWAUSZE           UNIT COUNT               Y02027
         SR    RTEMP,RSTCB              SUBTRACT IDLE COUNT      Y02027
         STH   RTEMP,PEWAUSZE           UPDATE UNIT LENGTH       Y02027
         LH    RTEMP,PEWAPSZE           BUFFER LENGTH            Y02027
         N     RTEMP,AVTCLRHI           CLEAR HIGH ORDER HALF    Y02027
         SR    RTEMP,RSTCB              SUBTRACT IDLE COUNT      Y02027
         STH   RTEMP,PEWAPSZE           UPDATE BUFFER LENGTH     Y02027
         AR    RENTRY,RSTCB             BUMP PAST IDLE CHARS     Y02027
PARTEMP  EQU   *                                                 Y02027
         TM    AIBRECFG,VARFLG          VARIABLE OR UNDEFINED    Y02027
         BO    WUTST                    BRANCH IF YES            Y02027
*                                                                Y02027
*              FIXED FORMAT                                      Y02027
*                                                                Y02027
         CLC   PEWALREC(2),AIBLRECL     START OF WORKAREA        Y02027
         BNE   SZETST                   BRANCH IF NO             Y02027
         LH    RTEMP,PEWALREC           SIZE OF WORKAREA         Y02027
         N     RTEMP,AVTCLRHI           CLEAR HI-ORDER HALF      Y02027
         SR    RTEMP,RCOUNT             SUBTRACT PREFIX LENGTH   Y02027
         STH   RTEMP,PEWALREC           AND SAVE                 Y02027
SZETST   EQU   *                                                 Y02027
         CLC   PEWAUSZE(2),PEWALREC     AMOUNT OF DATA IN UNIT   Y02027
*                                       GREATER THAN WORKAREA    Y02027
         BNH   EMPTYBFR                 BRANCH IF ALL DATA IN    Y02027
*                                       BUFFER FITS IN WORKAREA  Y02027
         SR    RSTCB,RSTCB              CLEAR FOR ICM            Y02027
         ICM   RSTCB,THREE,PEWALREC     GET NUMBER OF BYTES IN   Y02027
*                                       BUFFER TO BE MOVED       Y02027
         SR    RTEMP,RTEMP              CLEAR FOR ICM            Y02027
         ICM   RTEMP,THREE,PEWAPSZE     SIZE OF LOGICAL DATA     Y02027
         SR    RTEMP,RSTCB              COMPUTE AMOUNT LEFT IN   Y02027
*                                       LOGICAL BUFFER AFTER MOVEY02027
         STH   RTEMP,PEWAPSZE           SAVE COUNT FOR NEXT MOVE Y02027
         LH    RTEMP,PEWAUSZE           BYTES IN BUFFER UNIT     Y02027
         SR    RTEMP,RSTCB              COMPUTE AMOUNT LEFT IN   Y02027
*                                       BUFFER UNIT              Y02027
         STH   RTEMP,PEWAUSZE           STORE COUNT FOR NEXT MOVEY02027
         LR    RTEMP,RENTRY             ADDR OF FIRST/NEXT BYTE  Y02027
*                                       IN BUFFER TO BE MOVED    Y02027
         AR    RTEMP,RSTCB              ADDR OF NEXT BYTE TO BE  Y02027
*                                       MOVED AFTER MOVE         Y02027
         ST    RTEMP,PEWAMOVE           SAVE ADDR FOR NEXT MOVE  Y02027
         AR    RCOUNT,RSTCB             INCREMENT COUNT OF BYTES Y02027
*                                       USED IN WORKAREA         Y02027
         BCTR  RSTCB,RZERO              SUBTR 1 FOR EXECUTE      Y02027
         EX    RSTCB,MOVER              MOVE DATA FROM BUFFER TO Y02027
*                                       WORKAREA                 Y02027
*                                                                Y02027
*        WORK AREA IS FULL                                       Y02027
*                                                                Y02027
         OI    PEWAOPTC,PARTBUF         TURN ON PARTIAL BUFFER   Y02027
         ST    RBFR,PEWAPEBF            SAVE ADDR OF PARTIALLY   Y02027
*                                       EMPTY BUFFER             Y02027
         B     OFLOTST                  BRANCH TO FINISH UP      Y02027
         EJECT
*        VARIABLE OR UNDEFINED FORMAT                            Y02027
*                                                                Y02027
WUTST    EQU   *                                                 Y02027
         LA    RSTCB,PEWATRT            GET TRT TABLE            Y02027
         SR    RZERO,RZERO              CLEAR REGISTER           Y02027
         IC    RZERO,AVTSCBSZ           SCB SIZE                 Y02027
         AR    RSTCB,RZERO              GET TRT PAST SCB         Y02027
         TM    AIBOPTCG,MSGFLG          WORK UNIT A MESSAGE      Y02027
         BO    RECORD                   BRANCH IF YES            Y02027
*                                                                Y02027
*        CHECK PROCESS ENTRY FOR USER SPECIFIED RECORD DELIMITER Y02027
*                                                                Y02027
         L     RETURN,PEWAPROC          ADDRESS OF PROCESS ENTRY Y02027
         SR    RTEMP,RTEMP              CLEAR REG FOR IC         Y02027
         IC    RTEMP,TRMCHCIN-IEDQTRM(RETURN) SET UP TRT INDEX   Y02027
         STC   RTEMP,0(RTEMP,RSTCB)     PUT STOPPER IN TRT TABLE Y02027
         STC   RTEMP,PEWARDEL           SAVE RECORD DELIMITER    Y02027
RECORD   EQU   *                                                 Y02027
*        PREPARE TO SCAN BUFFER FOR RECORD DELIMITER             Y02027
*                                                                Y02027
         LH    RTEMP,PEWASOWA           NUMBER OF BYTES OF DATA  Y02027
*                                       IN BUFFER TO BE SCANNED  Y02027
         CLC   PEWAUSZE(2),PEWASOWA     AMOUNT OF DATA IN BUFFER Y02027
*                                       GREATER THAN WORKAREA    Y02027
         BH    SCANNER                  BRANCH IF YES            Y02027
         LH    RTEMP,PEWAUSZE           NUMBER OF BYTES LEFT     Y02027
*                                       IN BUFFER                Y02027
SCANNER  EQU   *                                                 Y02027
         LR    RZERO,RRCB               SAVE AIB ADDRESS         Y02027
         LR    RETURN,RBASE2            SAVE THRU TRT            Y02027
         STH   RTEMP,PEWASCAN           SAVE SCAN LENGTH         Y02027
         BCTR  RTEMP,RZERO              SUBTR 1 FOR EXECUTE      Y02027
         EX    RTEMP,SCAN               SCAN BUFFER FOR RECDEL   Y02027
         LR    RBASE2,RETURN            RESTORE AFTER TRT        Y02027
         BZ    NORECDEL                 BRANCH IF NO RECORD      Y02027
*                                       DELIMITOR FOUND IN BUFFERY02027
*        IF RECORD DELIMITER FOUND                               Y02027
*        - RRCB CONTAINS ADDRESS OF RECORD DELIMITER             Y02027
*        - RSTCB CONTAINS THE FUNCTION BYTE THAT STOPPED THE SCANY02027
*                                                                Y02027
         LA    RSTCB,ONE(RRCB)          GET ADDR 1 BYTE PAST     Y02027
         ST    RSTCB,PEWAMOVE           RECDEL AND SAVE          Y02027
         LR    RRCB,RZERO               RESTORE AIB BASE         Y02027
         TM    AIBOPTCG,CTLBYTE         DCBOPTCD=C SPECIFIED     Y02027
         BNO   NEOR                     BRANCH IF NO             Y02027
         TM    AIBOPTCG,MSGFLG          MESSAGE MODE             Y02027
         BO    NEOR                     BRANCH IF YES            Y02027
         L     RTEMP,AIBCTLG            GET ADDR OF CTL BYTE     Y02027
         OI    0(RTEMP),EOR                                      Y02027
NEOR     EQU   *                                                 Y02027
         TM    PEWAOPT2,DELETE          SHOULD RECDEL BE DELETED Y02027
         BZ    RECDELIN                 BRANCH IF NO             Y02027
         BCTR  RSTCB,RZERO              SUBTRACT 1 TO RECDEL     Y02027
         LH    RTEMP,PEWAPSZE           GET COUNT OF DATA IN BUF Y02027
         BCTR  RTEMP,RZERO              AND SUBTR 1 FOR RECDEL TOY02027
         STH   RTEMP,PEWAPSZE           BE DELETED AND SAVE      Y02027
         LH    RTEMP,PEWAUSZE           GET COUNT OF DATA IN UNITY02027
         BCTR  RTEMP,RZERO              AND SUBTR 1 FOR RECDEL TOY02027
         STH   RTEMP,PEWAUSZE           BE DELETED AND SAVE      Y02027
RECDELIN EQU   *                                                 Y02027
         SR    RSTCB,RENTRY             COMPUTE COUNT FOR MOVE   Y02027
*                                       RECDEL - FIRST DATA BYTE Y02027
         STH   RSTCB,PEWASCAN           SAVE COUNT               Y02027
         AR    RCOUNT,RSTCB             ADD TO NUMBER OF BYTES   Y02027
*                                       OF WORKAREA USED         Y02027
         BCTR  RSTCB,RZERO              SUBTR 1 FOR EXECUTE      Y02027
         EX    RSTCB,MOVER              MOVE DATA FROM BUFFER    Y02027
*                                       TO WORKAREA              Y02027
         L     RENTRY,PEWAMOVE          NEXT BYTE TO BE MOVED    Y02027
         AH    RWORK,PEWASCAN           ADDR OF NEXT EMPTY BYTE  Y02027
*                                       IN WORKAREA              Y02027
         XC    PEWASOWA,PEWASOWA        ZERO WORKAREA SIZE       Y02027
         STH   RCOUNT,PEWALREC          STORE RECORD LENGTH      Y02027
         LH    RTEMP,PEWAPSZE           COUNT OF DATA IN BUFFER  Y02027
         N     RTEMP,AVTCLRHI           CLEAR HI-ORDER BYTE      Y02027
         SH    RTEMP,PEWASCAN           COMPUTE AMOUNT LEFT IN   Y02027
         STH   RTEMP,PEWAPSZE           LOGICAL BUFFER AND STORE Y02027
         LH    RTEMP,PEWAUSZE           LENGTH OF DATA IN UNIT   Y02027
         SH    RTEMP,PEWASCAN           COMPUTE AMOUNT LEFT IN   Y02027
         STH   RTEMP,PEWAUSZE           UNIT AND SAVE            Y02027
         ST    RBFR,PEWAPEBF            SAVE ADDR OF PARTIALLY   Y02027
*                                       EMPTY BUFFER             Y02027
         OI    PEWAOPTC,PARTBUF         TURN ON PARTIAL BUFFER   Y02027
         NC    PEWAUSZE(2),PEWAUSZE     UNIT EMPTY               Y02027
         BNZ   CLEAN                    BRANCH IF NO             Y02027
         NC    PEWAPSZE(2),PEWAPSZE     BUFFER EMPTY             Y02027
         BNZ   PCHNTST                  BRANCH IF NO             Y02027
BCLEAN   NI    PEWAOPTC,AVTEFF-PARTBUF  TURN OFF PARTIAL BUFFER  Y02027
         BAL   RETURN,POSTBUF           POST EMPTY BUFFER TO RETBY02027
         LR    RRCB,RERB                RESTORE AIB BASE         Y02027
         EJECT
CLEAN    EQU   *                                                 Y02027
         STH   RCOUNT,PEWALREC          COUNT OF BYTES MOVED     Y02027
         TM    AIBRECFG,UNDFLG          UNDEFINED LENGTH SPEC'D  Y02027
         BO    OFLOTST                  BRANCH IF YES            Y02027
         L     RWORK,PEWAWA             GET ADDR OF WORKAREA     Y02027
         MVC   0(2,RWORK),PEWALREC      MOVE RECORD LENGTH IN WA Y02027
         TM    AIBMACRF,QSAMFLG         QSAM REQUEST             Y02027
         BO    OFLOTST                  BRANCH IF YES            Y02027
         TM    AIBRECFG,BLKFLG          BLOCK RECORDS SPECIFIED  Y02027
         BNO   OFLOTST                  BRANCH IF NO             Y02027
         LR    RTEMP,RCOUNT             GET LOGICAL RECORD LENGTHY02027
         SH    RTEMP,AVTHA4             SUBTR SAM PREFIX         Y02027
         STH   RTEMP,FOUR(RWORK)        STORE SIZE IN PREFIX     Y02027
         B     OFLOTST                  CHECK FOR PARIALLY EMPTY Y02027
*                                       BUFFER                   Y02027
         EJECT
*        BUFFER SCANNED BUT NO RECORD DELIMITER FOUND            Y02027
*        DATA MUST BE MOVED FROM BUFFER TO WORKAREA AND IF WORK  Y02027
*        AREA IS NOT FULL, NEXT BUFFER EXAMINED                  Y02027
*                                                                Y02027
NORECDEL EQU   *                                                 Y02027
         LR    RRCB,RZERO               RESTORE AIB BASE         Y02027
         LH    RSTCB,PEWASCAN           GET SCAN LENGTH          Y02027
         AR    RCOUNT,RSTCB             ADD TO NUMBER OF BYTES   Y02027
*                                       USED IN WORKAREA         Y02027
         STH   RCOUNT,PEWALREC          SAVE NUMBER MOVED        Y02027
         BCTR  RSTCB,RZERO              SUBTR 1 FOR EXECUTE      Y02027
         EX    RSTCB,MOVER              MOVE DATA TO WORKAREA    Y02027
         LH    RSTCB,PEWASOWA           WORKAREA SIZE            Y02027
         N     RSTCB,AVTCLRHI           CLEAR HI-ORDER HALF      Y02027
         LH    RTEMP,PEWASCAN           COUNT OF BYTES MOVED     Y02027
         N     RTEMP,AVTCLRHI           CLEAR HI-ORDER HALF      Y02027
         SR    RSTCB,RTEMP              SUBTR NUMBER OF BYTES    Y02027
         STH   RSTCB,PEWASOWA           MOVED AND SAVE           Y02027
         AR    RWORK,RTEMP              ADDR OF NEXT EMPTY BYTE  Y02027
*                                       IN WORKAREA              Y02027
         LH    RSTCB,PEWAPSZE           COUNT OF BYTES LEFT IN   Y02027
*                                       LOGICAL BUFFER           Y02027
         N     RSTCB,AVTCLRHI           CLEAR HI-ORDER HALF      Y02027
         SR    RSTCB,RTEMP              SUBTR NUMBER OF BYTES    Y02027
         STH   RSTCB,PEWAPSZE           MOVED AND SAVE DATA LEFT Y02027
         LH    RSTCB,PEWAUSZE           COUNT OF BYTES IN UNIT   Y02027
         SR    RSTCB,RTEMP              SUBTR NUMBER OF BYTES    Y02027
         STH   RSTCB,PEWAUSZE           LEFT IN UNIT AND STORE   Y02027
         CLC   PEWASOWA(2),PEWAUSZE     UNIT   EMPTY AND WORKAREAY02027
*                                       FULL                     Y02027
         BNE   CHECK                    BRANCH IF NO             Y02027
         NC    PEWAPSZE(2),PEWAPSZE     LOGICAL BUFFER EMPTY     Y02027
         BZ    BCLEAN                   BRANCH IF YES            Y02027
CHECK    EQU   *                                                 Y02027
         CLC   PEWASOWA(2),PEWAUSZE     COMPARE WORKAREA TO UNIT Y02027
*                                       SIZE                     Y02027
         BL    SETPART                  BRANCH IF WORKAREA FULL  Y02027
*                                       AND UNIT NOT EMPTY       Y02027
         NC    PEWAPSZE(2),PEWAPSZE     LOGICAL BUFFER EMPTY     Y02027
         BNZ   PCHNTST                  BRANCH IF WORKAREA NOT   Y02027
*                                       FULL AND LOGICAL BUFFER  Y02027
*                                       NOT EMPTY                Y02027
         EJECT
*                                                                Y02027
*        WORKAREA NOT FULL AND LOGICAL BUFFER EMPTY              Y02027
*                                                                Y02027
         BAL   RETURN,POSTBUF           POST EMPTY BUFFER TO RETBY02027
         LR    RRCB,RERB                RESTORE AIB BASE         Y02027
         NI    PEWAOPTC,AVTEFF-PARTBUF  TURN OFF PARTIAL BUFFER  Y02027
         TM    PRFSTAT1,PRFNLSTN        BUFFER CONTAIN END OF MSGY02027
         BO    QCBTEST                  BRANCH IF NO             Y02027
         OI    PEWAGSW,RETRIEVE         SET RETRIEVE OK          Y02027
         OI    PEWAGSW+1,EOM            SET EOM LAST TIME FLAG   Y02027
         B     CLEAN                    RETURN ANY EMPTY BUFFERS Y02027
*                                                                Y02027
*              BUFFER NOT EMPTY                                  Y02027
*                                                                Y02027
SETPART  EQU   *                                                 Y02027
         AH    RENTRY,PEWASCAN          ADDR OF NEXT BYTE TO BE  Y02027
         B     SETPARTA                 MOVED                    Y02027
PCHNTST  L     RTEMP,PEWAPEUN           GET ADDR OF PARTIALLY    Y02027
         L     RTEMP,EIGHT(RTEMP)       EMPTY UNIT               Y02027
         ST    RTEMP,PEWAPEUN           AND UPDATE TO NEXT UNIT  Y02027
         LA    RENTRY,AVTUMALN(RTEMP)   GET ADDR OF FIRST BYTE   Y02027
*                                       OF DATA                  Y02027
         MVC   PEWAUSZE(2),PEWAPSZE     ASSUME SHORT BUFFER COUNTY02027
         CLC   PEWAPSZE(2),AVTKEYLE     BUFFER A FULL UNIT       Y02027
         BL    NOTFULL                  BR IF NO                 Y02027
         MVC   PEWAUSZE(2),AVTKEYLE     SET FULL BUFFER COUNT    Y02027
NOTFULL  NC    PEWASOWA(2),PEWASOWA     WORKAREA FULL            Y02027
         BNZ   WUTST                    NO, BRANCH               Y02027
SETPARTA EQU   *                                                 Y02027
         OI    PEWAOPTC,PARTBUF         TURN ON PARTIAL BUFFER   Y02027
         ST    RENTRY,PEWAMOVE          SAVE ADDR FOR NEXT GET   Y02027
         ST    RBFR,PEWAPEBF            SAVE ADDR OF PARTIAL BFR Y02027
         B     CLEAN                    RETURN BUFFERS           Y02027
         EJECT
*        ALL DATA IN BUFFER CAN BE MOVED INTO WORKAREA           Y02027
*                                                                Y02027
EMPTYBFR EQU   *                                                 Y02027
         SR    RSTCB,RSTCB              CLEAR                    Y02027
         SR    RTEMP,RTEMP              REGISTERS FOR ICM        Y02027
         ICM   RSTCB,THREE,PEWAUSZE     NUMBER OF BYTES IN UNIT  Y02027
*                                       LEFT TO BE MOVED         Y02027
         ICM   RTEMP,THREE,PEWAPSZE     NUMBER OF BYTES IN       Y02027
*                                       LOGICAL BUFFER TO BE     Y02027
*                                       MOVED                    Y02027
         SR    RTEMP,RSTCB              COMPUTE AMOUNT LEFT IN   Y02027
         STH   RTEMP,PEWAPSZE           LOGICAL BUFFER AND SAVE  Y02027
         LH    RTEMP,PEWALREC           COUNT OF BYTES LEFT IN   Y02027
         N     RTEMP,AVTCLRHI           WORK AREA                Y02027
         SR    RTEMP,RSTCB              CALCULATE NUMBER OF BYTESY02027
         STH   RTEMP,PEWALREC           OF WORKAREA LEFT AND SAVEY02027
         AR    RCOUNT,RSTCB             COUNT OF BYTES LEFT IN   Y02027
*                                       WORKAREA                 Y02027
         BCTR  RSTCB,RZERO              SUBTR 1 FOR EXECUTE      Y02027
         EX    RSTCB,MOVER              MOVE DATA TO WORKAREA    Y02027
         LA    RSTCB,ONE(RSTCB)         ADD ONE TO COUNT         Y02027
         AR    RWORK,RSTCB              COMPUTE ADDR OF NEXT     Y02027
*                                       EMPTY BYTE IN WORKAREA   Y02027
         NC    PEWAPSZE(2),PEWAPSZE     IS BUFFER EMPTY          Y02027
         BZ    DONE                     BRANCH IF YES            Y02027
         L     RTEMP,PEWAPEUN           GET ADDR OF PARIALLY     Y02027
         L     RTEMP,EIGHT(RTEMP)       EMPTY UNIT               Y02027
         ST    RTEMP,PEWAPEUN           AND UPDATE TO NEXT UNIT  Y02027
         LA    RENTRY,AVTUMALN(RTEMP)   GET ADDR OF FIRST BYTE   Y02027
*                                       OF DATA                  Y02027
         MVC   PEWAUSZE(2),PEWAPSZE     ASSUME SHORT BUFFER COUNTY02027
         CLC   PEWAPSZE(2),AVTKEYLE     BUFFER A FULL UNIT       Y02027
         BL    SHORTBUF                 BRANCH IF NO             Y02027
         MVC   PEWAUSZE(2),AVTKEYLE     SET FULL BUFFER COUNT    Y02027
SHORTBUF EQU   *                                                 Y02027
         ST    RENTRY,PEWAMOVE          NEXT BYTE TO BE MOVED    Y02027
         OI    PEWAOPTC,PARTBUF         SET PARTIAL BUFFER       Y02027
         B     NOPOST                   SKIP BUFFER POST         Y02027
DONE     EQU    *                                                Y02027
         BAL   RETURN,POSTBUF           POST EMPTY BUFFER TO RETBY02027
         LR    RRCB,RERB                RESTORE AIB BASE         Y02027
NOPOST   EQU   *                                                 Y02027
         CLC   PEWALREC(2),AVTFZERO     WORKAREA FULL            Y02027
         BE    CLEANUP                  BRANCH IF YES            Y02027
         NI    PEWAOPTC,AVTEFF-PARTBUF  TURN OFF PARTIAL BUFFER  Y02027
         NC    PEWAPSZE(2),PEWAPSZE     LOGICAL BUFFER EMPTY     Y02027
         BNZ   SZETST                   BRANCH IF NO             Y02027
         TM    PRFSTAT1,PRFNLSTN        EOM IN BUFFER            Y02027
         BO    QCBTEST                  BRANCH IF NO             Y02027
*                                                                Y02027
         OI    PEWAGSW,RETRIEVE         SET RETRIEVE OK          Y02027
         OI    PEWAGSW+1,EOM            SET EOM FLAG             Y02027
         NI    PEWAGSW,AVTEFF-INCWA     NOT INCOMPLETE WORKAREA  Y02027
         EJECT
*                                                                Y02027
*              CHECK FOR WORKAREA OVERFLOW TO BE SET             Y02027
*                                                                Y02027
OFLOTST  TM    PEWAOPTC,PARTBUF         PARTIAL BUFFER           Y02027
         BNO   CLEANUP                  BRANCH IF NO             Y02027
         TM    AIBOPTCG,CTLBYTE         CONTROL BYTE SPECIFIED   Y02027
         BO    CLEANUP                  BRANCH IF YES            Y02027
         TM    AIBOPTCG,MSGFLG          WORK UNIT A MESSAGE      Y02027
         BNO   CLEANUP                  BRANCH IF NO             Y02027
         OI    PEWAOPTC,SYNADFLG        SET SYNAD EXIT FLAG      Y02027
CLEANUP  EQU   *                                                 Y02027
         STH   RCOUNT,PEWALREC          SAVE AMOUNT OF DATA MOVEDY02027
         TM    AIBOPTCG,MSGFLG          IS WORK UNIT A MESSAGE   Y02027
         BO    BACKUP                   BRANCH IF YES            Y02027
         CLI   PEWARDEL,AVTEZERO        WAS RECORD DELIMITER     Y02027
*                                       SPECIFIED                Y02027
         BE    BACKUP                   BRANCH IF NO             Y02027
         LA    RSTCB,PEWATRT            GET ADDR OF TRT TABLE    Y02027
         SR    RTEMP,RTEMP              CLEAR REGISTER           Y02027
         IC    RTEMP,AVTSCBSZ           GET SCB SIZE             Y02027
         AR    RSTCB,RTEMP              GET TRT PAST SCB         Y02027
         IC    RTEMP,PEWARDEL           GET RECORD DELIMITER     Y02027
         AR    RSTCB,RTEMP              ADDR OF BYTE IN TABLE    Y02027
         MVI   0(RSTCB),AVTEZERO        CLEAR TRT TABLE          Y02027
         MVI   PEWARDEL,AVTEZERO        SET SWITCH BACK TO ZERO  Y02027
BACKUP   EQU   *                                                 Y02027
         TM    AIBOPTCG,CTLBYTE         CONTROL BYTE IN WORKAREA Y02027
         BZ    GOBACK                   BRANCH IF NO             Y02027
         L     RTEMP,AIBCTLG            ADDR OF CONTROL BYTE     Y02027
         OI    0(RTEMP),ISEGFLAG        SET BIT TO INDICATE      Y02027
*                                       INTERMEDIATE SEGMENT     Y02027
         CLC   PEWAPSZE(2),AVTFZERO     BUFFER EMPTY             Y02027
         BNE   GOBACK                   BRANCH IF YES            Y02027
         TM    PRFSTAT1,PRFNLSTN        BUFFER CONTAIN EOM       Y02027
         BO    GOBACK                   BRANCH IF NO             Y02027
         OI    0(RTEMP),EOMFLAG         SET BITS TO INDICATE     Y02027
*                                       LAST SEGMENT OF MESSAGE  Y02027
         OI    PEWAGSW,RETRIEVE         SET RETRIEVE OK          Y02027
         OI    PEWAGSW+1,EOM            SET EOM LAST TIME FLAG   Y02027
GOBACK   EQU   *                                                 Y02027
         MVI   AIBDECS,WAFULL           SET BUFFERS IN AIB       Y02027
*                                       WORKAREA                 Y02027
         XC    PEWAWA(4),PEWAWA         ZERO WORKAREA PTR        Y02027
CONTRET  EQU   *                                                 Y02027
         LA    RETURN,CONTINU           SET RETURN AFTER POST    Y02027
GOODRETC EQU   *                                                 Y02027
         SR    RENTRY,RENTRY            SET GOOD COMPLETION CODE Y02027
*        POST APPLICATION PROGRAM ECB COMPLETE -PECB OR DECB     Y02027
XMPOST   EQU   *                                                 Y02027
         MVC   AIBCMPTG(4),PEWAECBA     PUT ECB ADDR IN LIST     Y02027
         NI    PEWAFLG,POSTOFFF         TURN POST FLAG OFF       Y02027
         XC    PEWAECBA,PEWAECBA        CLEAR ECB PTR            Y02027
XMPOST1  EQU   *                                                 Y02027
         LR    RZERO,RENTRY             LOAD COMPLETION CODE     Y02027
         MVI   AIBCMPTG,ZERO            ZERO HIGH ORDER BYTE     Y02027
*                                       OF ECB PTR               Y02027
         L     RERB,PEPCBAD             GET PCB ADDRESS          Y02027
         L     RERB,PCBPEBAD-IEDQPCB(RERB) GET PEB ADDRESS       Y02027
         LTR   RERB,RERB                TEST IF AP IS ACTIVE     Y02027
         BZ    FREEAIB                  BRANCH IF NO             Y02027
         L     RERB,PEBASCB-IEDQPEB(RERB) GET ASCB ADDRESS       Y02027
         LTR   RERB,RERB                TEST IF FLAG HAS         Y02027
*                                       INVALIDATED ASCB ADDR    Y02027
         BM    FREEAIB                  BRANCH IF NEG. FLAG ON   Y02027
         L     RENTRY,PEPCBAD           PCB ADDR               @ZA05000
         L     RENTRY,PCBPEBAD-IEDQPCB(RENTRY) PEB ADDR        @ZA05000
         L     RERB,CVTPTR              CVT ADDR               @ZA05000
         ICM   RERB,ALL,CVTAQAVT-CVTMAP(RERB)  TCX ADDR        @ZA05000
         CLC   PEBASID-IEDQPEB+TWO(2,RENTRY),TCXASID-IEDQTCX(RERB)
*                                       IS A.P. A SUBTASK OF   @ZA05000
*                                         MCP                  @ZA05000
         BNE   XMPOST2                  NO, DO CROSS MEMORY    @ZA05000
*                                         POST                 @ZA05000
         L     RPARM,AIBCMPTG           GET ECB ADDR           @ZA05000
         POST  (1),(0)                  DO NORMAL POST         @ZA05000
         B     XMPOST3                  CONTINUE               @ZA05000
XMPOST2  EQU   *                                               @ZA05000
*        ISSUE SVC 102 TO SCHEDULE SRB TO POST THE             @Z40X9AG
*        ECB IN THE APPLICATION PROGRAM'S MEMORY               @Z40X9AG
         MVC   AIBSSGAS,PEBASCB-IEDQPEB(RENTRY) SET ASCB ADDR  @Z40X9AG
         MVC   AIBSSGID,PEBASID+TWO-IEDQPEB(RENTRY) SET ASID   @Z40X9AG
         STC   RZERO,AIBSSGCC           SET COMPLETION CODE    @Z40X9AG
         MVC   AIBSSGTC,PEBTCB-IEDQPEB(RENTRY) SET TCB ADDR    @Z40X9AG
         MVI   AIBSSGF1,AIBSSGEC        SET ENTRY CODE         @Z40X9AG
         LA    RPARM,AIBCMPTG           POINT TO PARM LIST     @Z40X9AG
         AQCTL                          SVC 102                @Z40X9AG
*                                                                Y02027
XMPOST3  EQU   *                                               @ZA05000
         LA    RERB,PEERB               RELOAD ERB ADDRESS       Y02027
         BR    RETURN                   BRANCH AS SET UP TO      Y02027
*                                       DSPDISP,NOTRET,CONTINU     2027
CONTINU  EQU   *                                                 Y02027
         L     RTEMP,PEWALCBA           DUMMY LCB ADDRESS        Y02027
         TM    LCBSTAT1-IEDQLCB(RTEMP),LCBRCLLN  RETRIEVE MODE   Y02027
         BNO   CKREADA                  BRANCH IF NO             Y02027
         TM    PRFSTAT1,PRFNLSTN        EOM BUFFER               Y02027
         BNO   CONTINU1                 BRANCH IF YES          @ZA02645
         TM    LCBERBST-IEDQLCB(RTEMP),LCBEOMSG                @ZA02645
*                                       EOM BUFFER RETRIEVED   @ZA02645
         BNO   BLDERBB                  YES, CONTINUE RECALL   @ZA02645
CONTINU1 EQU   *                                               @ZA02645
         CLC   PERAQCB+ONE(THREE),AVTDELAD+ONE READ AHEAD QUE    Y02027
*                                       EMPTY                    Y02027
         BE    QEMPTY                   BRANCH IF QUEUE EMPTY  @G36XRAW
         BAL   RETURN,DSPDISP           NO, BRANCH NO CLEAN UP @G36XRAW
QEMPTY   EQU   *                                               @G36XRAW
         TM    PEWARTVE+THREE,MULTSEQ   IS THIS MULT RETRIEVE  @OZ08360
         BNO   NOMLTRVE                 BR- NOT MULTI RETRIEVE @G36XRAW
         BAL   RETURN,DSPDISP           BR YES TO DISPATCHER   @G36XRAW
NOMLTRVE EQU   *                                               @G36XRAW
         B     RCLEANX                  CLEAN UP RETRIEVE        Y02027
CKREADA  EQU   *                                                 Y02027
         CLC   PEWACBUF+ONE(3),AVTDELAD+ONE  CHAIN EMPTY         Y02027
         BNE   MHPOST                   BRANCH IF NO             Y02027
         TM    LCBERBST-IEDQLCB(RTEMP),LCBEOMSG  EOM SEG READ    Y02027
         BO    NOTRET                   BRANCH IF YES READ AHEAD Y02027
         TM    PRFSTAT1,PRFNLSTN        EOM BUFFER               Y02027
         BO    BLDERB                   BRANCH IF NO             Y02027
         B     NOTRET                   START READ AHEAD         Y02027
FREEAIB  EQU   *                                                 Y02027
         MVI   AIBSTATE,AIBFREE         SET AIB AS FREE          Y02027
         BAL   RETURN,DSPDISP           BRANCH TO AVOID XMPOST @G36XRAW
         EJECT
QCBTEST  EQU   *
         CLC   PERAQCB+ONE(3),AVTDELAD+ONE  MORE BUFFERS ON CHAINY02027
         BE    QWAIT                    BRANCH IF NO             Y02027
         L     RBFR,PERAQCB             GET ADDR OF NEXT BUFFER  Y02027
         ST    RBFR,PEWAPEUN            SAVE CURRENT UNIT        Y02027
         LH    RTEMP,AVTKEYLE           GET LENGTH OF UNIT LESS  Y02027
*                                       UNIT MANAGEMENT AREA     Y02027
         ST    RBFR,PEWAPEBF            SAVE PARTIAL BFR ADDR  @OZ26376
         LA    RSTCB,AVTTXTSZ           LENGTH OF TEXT PREFIX    Y02027
         SR    RTEMP,RSTCB              COMPUTE DATA LENGTH IN   Y02027
         STH   RTEMP,PEWAUSZE           UNIT AND SAVE            Y02027
         LH    RTEMP,PRFSIZE            GET LOGICAL BUFFER SIZE  Y02027
         N     RTEMP,AVTCLRHI           CLEAR HI-ORDER HALF      Y02027
         SR    RTEMP,RSTCB              SUBTRACT LENGTH OF PREFIXY02027
         STH   RTEMP,PEWAPSZE           AND STORE DATA SIZE      Y02027
         LA    RENTRY,PRFSTXT           INITIALIZE WITH DATA ADDRY02027
         CLC   PEWAUSZE(2),PEWAPSZE     LOGICAL BUFFER FIT IN    Y02027
*                                       ONE UNIT                 Y02027
         BL    POSTHDRX                 BRANCH IF YES            Y02027
         MVC   PEWAUSZE(2),PEWAPSZE     ADJUST UNIT SIZE         Y02027
         B     POSTHDRX                 GET NEXT BUFFER          Y02027
QWAIT    EQU    *                       WAIT FOR NEXT ELEMENT    Y02027
         L     RTEMP,PEWALCBA           DUMMY LCB ADDRESS        Y02027
         ST    RWORK,PEWANEB            SAVE ADDR OF NEXT EMPTY  Y02027
*                                       BYTE IN WORKAREA         Y02027
         ST    RCOUNT,PEWAPEUN          SAVE NUMBER OF BYTES USEDY02027
         OI    PEWAGSW,INCWA            SET INCOMPLETE WORKAREA  Y02027
         TM    LCBSTAT1-IEDQLCB(RTEMP),LCBRCLLN RETRIEVE MODE    Y02027
         BO    BLDERBB                  YES, BRANCH GET NXT BUFF Y02027
         B     CKREADA                  WHEN ELEMENT IS PUT ON   Y02027
*                                       RAQCB, BRANCH WILL BE    Y02027
*                                       TAKEN TO QCBTEST         Y02027
         EJECT
*                                                                Y02027
*              RETURN EMPTY BUFFER TO RETURN BUFFER QUEUE        Y02027
*                                                                Y02027
POSTBUF  MVC   PERAQCB+ONE(3),PRFLINK   REMOVE EMPTY BUFFER FROM Y02027
*                                       READ AHEAD QCB           Y02027
         TM    PRFSTAT1,PRFDUPLN        RECALL                 @ZA03050
         BNZ   POSTBUF1                 BRANCH IF YES          @ZA03050
         SR    RERB,RERB                CLEAR REGISTER           Y02027
         IC    RERB,PEWABFCT            CURRENT BUFFER COUNT     Y02027
         LA    RERB,ONE(RERB)           ADD ONE TO COUNT         Y02027
         STC   RERB,PEWABFCT            NEW BUFFER COUNT         Y02027
POSTBUF1 EQU   *                                               @ZA03050
         LR    RERB,RRCB                SAVE AIB ADDRESS         Y02027
         TM    PRFSTAT1,PRFNLSTN        EOM BUFFER               Y02027
         BO    NOTEOM                   BRANCH IF NO             Y02027
*                                                                Y02027
*              SAVE EOM BUFFER UNTIL NEXT EOM BUFFER             Y02027
*                                                                Y02027
         L     RTEMP,PEWALCBA           GET LCB ADDRESS          Y02027
         TM    LCBSTAT1-IEDQLCB(RTEMP),LCBRCLLN  RETRIEVE MODE   Y02027
         BO    NOTEOM                   BRANCH IF YES            Y02027
         MVC   PRFSVFFO,PRFQCBA         MOVE FROM SAVED LOCATION Y02027
         OI    PEWAFLG,MHOK             SET ALRIGHT TO SEND      Y02027
*                                       MESSAGE TO MH            Y02027
         L     RSTCB,EOMSAVE            GET LAST EOM BUFFER      Y02027
         ST    RBFR,EOMSAVE             SAVE NEW EOM BUFFER      Y02027
         LTR   RSTCB,RSTCB              EOM BUFFER SAVED?        Y02027
         BZR   RETURN                   BRANCH IF NO             Y02027
*                                                                Y02027
*              POST PREVIOUS EOM BUFFER TO MARK SERVICED         Y02027
*                                                                Y02027
         LA    RTEMP,PEWASCB            SCB ADDR               @SA69973
         L     RRCB,PEWAPROC            PROCESS ENTRY ADDR     @SA69973
         MVC   SCBDESTQ-IEDQSCB(3,RTEMP),TRMDESTQ-IEDQTRM(RRCB) SA69973
*                                       SET DEST QCB ADDR      @SA69973
         LA    RTEMP,AVTDSIOB           ADDR OF DISK I/O QCB     Y02027
         STCM  RTEMP,SEVEN,PRFQCBA-IEDQPRF(RSTCB) STORE BUFFER   Y02027
         MVI   PRFPRI-IEDQPRF(RSTCB),PRIDKSRV BUFFER SERVICED PRIY02027
         MVI   PRFTIC-IEDQPRF(RSTCB),TIC                         Y02027
         LR    RRCB,RSTCB               SET REG FOR TPOST        Y02027
         B     DSPPOSTR                 POST BUFFER TO DSKIO Q   Y02027
*                                       RETURN IS VIA REGISTER 14Y02027
*                                       WHICH RETURNS TO CALLER  Y02027
NOTEOM   EQU   *                                                 Y02027
         LA    RTEMP,AVTBFRTB           ADDR OF RETURN BUF QCB   Y02027
         STCM  RTEMP,SEVEN,PRFQCBA      STORE QCB IN ELEMENT     Y02027
         MVI   PRFPRI,PRIBFRTB          PRIORITY OF POST         Y02027
         LR    RRCB,RBFR                SET UP REG1 FOR DSPPOSTR Y02027
         B     DSPPOSTR                 POST BUFFER TO RETURN    Y02027
*                                       BUFFER QUEUE             Y02027
*                                       RETURN IS VIA REGISTER   Y02027
*                                       14 WHICH RETURNS TO      Y02027
*                                       CALLING ROUTINE          Y02027
*                                                                Y02027
*              INSTRUCTIONS FOR EXECUTE STATEMENTS               Y02027
*                                                                Y02027
MOVER    MVC   0(1,RWORK),0(RENTRY)     EXECUTE INSTRUCTION THAT Y02027
*                                       MOVES DATA FROM BUFFER   Y02027
*                                       TO WORKAREA              Y02027
SCAN     TRT   0(1,RENTRY),0(RSTCB)     EXECUTE INSTRUCTION THAT Y02027
*                                       SCANS BUFFER FOR USER'S  Y02027
*                                       RECDEL                   Y02027
MOVENME  MVC   0(1,RWORK),0(RTEMP)      EXECUTE INSTRUCTION THAT Y02027
*                                       MOVES TERMNAME TO SOURCE Y02027
*                                       FIELD IN WORKAREA        Y02027
MOVE2    MVC   EIGHT(1,RENTRY),0(RTEMP) EXECUTE INSTRUCTION THAT Y02027
*                                       MOVES SOURCE TO WORKAREA Y02027
PATCH    DC    25H'0'                   PATCH AREA               Y02027
         EJECT
GETSCHED EQU   *                        GET SCHEDULER            Y02027
         LA    RBASE2,GETSCHED-IEDQEW-TWO(RENTRY) LOAD BASE REG  Y02027
*                                       FOR GET SCHEDULER PORTIONY02027
         LA    RBASE,LABEL-IEDQEW-TWO(RENTRY) ESTABLISH FIRST    Y02027
*                                       BASE REGISTER            Y02027
         DROP  RRCB                                              Y02027
         USING IEDQRECB,RRCB                                     Y02027
*                                                                Y02027
*              BUFFER POSTED TO DESTINATION QCB                  Y02027
*                                                                Y02027
         TM    QCBDSFLG,QCBFQCB         DESTINATION QCB
         BNO   ELEMTEST                 BRANCH IF NO
         SPACE 2
         TM    PRFSTAT1-IEDQPRF(RRCB),PRFNHDRN   IS THIS A HDR   S21101
         BO    BYPASS                  NO, NO CHECK FOR INIT     S21101
         L     RWORK,PRFLCB-1-IEDQPRF(,RPARM)   GET LCB ADDRESS  S21101
         TM    LCBSTAT1-IEDQLCB(RWORK),LCBINITN    INITIATE MODE S21101
         BNO   BYPASS                  NO, DO NOT INITIATE GET   S21101
         STM   RPARM,RQCB,AVTSAVE3+24  SAVE REGISTERS            S21101
         LA    RENTRY,TAG              SET BASE FOR ROUTINE      S21101
         BALR  RETURN,RENTRY           BRANCH - RETURN FROM      S21101
*                                       DSPPOSTR                 S21101
         LM    RPARM,RQCB,AVTSAVE3+24  RESTORE REGISTERS         S21101
         L     RSTCB,QCBSTCHN-1         DEST SCHED STCB        @ZA01154
         BAL   RETURN,DSPBYPAS          START INIT MODE        @G36XRAW
*                                                                     *
*        GET SCHEDULER HAS BEEN POSTED A FULL BUFFER                  *
*                                                                     *
BYPASS   EQU   *
         L     RSTCB,4(0,RSTCB)         ADDRESS OF STCB FOR
*                                       DESTINATION SCHEDULER
         BAL   RETURN,DSPBYPAS          PASS FULL BUFFER TO    @G36XRAW
*                                       DESTINATION SCHEDULER
         EJECT
CHNGTST  EQU   *                                                 S21101
*                                                                S21101
         OI    PEWAFLG,RAFLG            ALLOW READ AHEAD         Y02027
         CLC   PERAQCB+1(3),AVTDELAD+1  READ-AHEAD QCB EMPTY     S21101
         BE    RQEMPTY                  BR-YES READ QUE EMPTY  @G36XRAW
         BAL   RETURN,DSPDISP           NO-DO NOT CHANGE QCB'S @G36XRAW
RQEMPTY  EQU   *                                               @G36XRAW
         CLC   PEWACBUF+ONE(3),AVTDELAD+ONE  BUFFER READY FOR MH Y02027
         BE    GOMH                     BR-YES                 @G36XRAW
         BAL   RETURN,DSPDISP           BRANCH IF NO           @G36XRAW
GOMH     EQU   *                                               @G36XRAW
*                                                                     *
*        PUT GET SCHEDULER'S STCB INTO DESTINATION QCB                *
*                                                                     *
         L     RSTCB,PEWAPROC           PROCESS ENTRY ADDRESS
         L     RSTCB,TRMDESTQ-1-IEDQTRM(0,RSTCB) SET REG TO POINT
*                                       TO QCB TO WHICH STCB IS
*                                       TO BE MOVED
         LA    RQCB,PERAQCB             ADDRESS OF QCB NOW       Y02027
*                                       CONTAINING THE STCB      Y02027
         BAL   RETURN,DSPUNAV           MOVE SCHEDULER         @G36XRAW
         EJECT
NOTRET   EQU   *                                                 S21101
*                                                                Y02027
*              LOOK FOR NEXT MESSAGE TO GET                      Y02027
*                                                                Y02027
         TM    PEWAFLG,RAFLG           CAN WE DO READ-AHEAD NOW  S21101
         BO    RDAHEAD                 BR-YES                  @G36XRAW
         BAL   RETURN,DSPDISP          BRANCH IF NO            @G36XRAW
RDAHEAD  EQU   *                                               @G36XRAW
         NI    PEWAFLG,X'FF'-RAFLG     SET NO READ-AHEAD NOW     S21101
ERBFIX   EQU   *
* FIND PRIORITY QCB CONTAINING A MESSAGE
         TM    PEWAFLG,CFLG+PEWASTOP    STOPPED WITH CLOSE     @OS77017
*                                        PENDING               @OS77017
         BO    CLOSDOWN                 YES, BRANCH            @OS77017
         TM    PEWAFLG,ERBBUSY+PEWASTOP ERB NOT POSTABLE        SA63961
         BZ    ERBPOST                  BR IF IS POSTABLE      @G36XRAW
         BAL   RETURN,DSPDISP           EXIT IF YES            @G36XRAW
ERBPOST  EQU   *                                               @G36XRAW
         CLC   PEWACBUF+ONE(3),AVTDELAD+ONE  NEW READ POSSIBLE   Y02027
         BE    ERBFIXA                  BRANCH IF YES           SA54921
         CLC   PERAQCB+1(3),AVTDELAD+1  R.A. QUEUE EMPTY        SA54921
         BE    MHPOST                   BRANCH IF YES           SA54921
         BAL   RETURN,DSPDISP           EXIT TO DISPATCHER     @G36XRAW
ERBFIXA  EQU   *                                                SA54921
         LA    RSCB,PEWASCB             ADDRESS OF SCB           Y02027
         L     RSTCB,PEWAPROC           PROCESS ENTRY ADDRESS    Y02027
         MVC   SCBDESTQ(3),TRMDESTQ-IEDQTRM(RSTCB) SET DESTQ     Y02027
         L     RQCB,TRMDESTQ-ONE-IEDQTRM(0,RSTCB) DEST QCB ADDR. Y02027
         SPACE 1
         USING IEDQPCB,RWORK                                     S21101
         L     RWORK,QCBINSRC-1        GET INITIATE SOURCE LCB   S21101
         N     RWORK,CLEAR             CLEAR IN-SOURCE BITS      S21101
         LA    RQCB,ZERO(RQCB)          CLEAR FOR COMPARE        Y02027
         L     RTEMP,PEWALCBA          PUT DEST LCB ADDR         S21101
         CLR   RWORK,RQCB               IS THERE INITIATE MSG    Y02027
         BE    NOINIT                  NO, CHECK FOR PRIORITY MSGS21101
         MVC   QCBINSRC(3),LCBINSRC-IEDQLCB(RWORK)  REMOVE LCB   S21101
*                                      FROM INITIATE CHAIN       S21101
         IC    RZERO,LCBCHAIN-IEDQLCB(,RWORK)  SAVE DISPOSITION SA62953
*                                       STATUS BITS             SA62953
         ST    RTEMP,LCBINSRC-ONE-IEDQLCB(,RWORK) IN SOURCE LCB SA62953
         STC   RZERO,LCBCHAIN-IEDQLCB(,RWORK)  RESTORE DISPOSI- SA62953
*                                       TION STATUS BITS        SA62953
         L     RWORK,LCBSCBA-1-IEDQLCB(RWORK)  SOURCE SCB ADDR   S21101
         MVC   SCBSCHDR,SCBDCHDR-IEDQSCB(RWORK)                  S21101
         TM    QCBDSFLG,QCBREUS+QCBNREUS    REUSABILITY IN       S21101
         BNZ   MOVEIT                   BRANCH IF YES            Y02027
         MVC   SCBSCHDR,SCBCCHDR-IEDQSCB(RWORK)                  S21101
MOVEIT   EQU   *                                                 Y02027
         MVC   SCBSCSEG,SCBSCHDR       SET HEADER ADDRESS        S21101
         NI    SCBQTYPE,X0F            CLEAR Q-TYPE              S21101
         OI    LCBSTAT1-IEDQLCB(RTEMP),LCBSENDN+LCBINITN         S21101
         NI    LCBSTAT1-IEDQLCB(RTEMP),AVTEFF-LCBRCLLN ENSURE    Y02027
*                                       RECALL NOT SET           Y02027
         B     INITSEND                 GO TO INITIATE SENDING  SA52971
         USING IEDQPQCB,RSTCB           QCB BASE                 Y02027
         SPACE 1
NOINIT   EQU   *                                                 S21101
         NI    LCBSTAT1-IEDQLCB(RTEMP),AVTEFF-LCBINITN           Y02027
         SR    RTEMP,RTEMP             CLEAR WORK REGISTER       S21101
         TM    QCBDSFLG,QCBHELD         REUSABILITY IN           Y02027
         BO    CHNGTST                  BRANCH IF YES
         LA    RSTCB,IEDQPQCB-IEDQQCB(RQCB) PRIORITY QCB ADDR.   Y02027
LOOP     EQU   *
         NC    QCBFFEFO(THREE),QCBFFEFO IS THERE A MSG FOR THIS        X
                                        PRIORITY LEVEL
         BNZ   BUILDSCB                 BRANCH IF YES
         CLI   QCBPRIPQ,ZERO            IS THIS THE LAST PRIORITY      X
                                        QCB FOR THIS MASTER QCB
         BZ    CHNGTST                  BRANCH IF YES- ASSUME THAT     X
                                        GET SCHEDULER ACTIVATED        X
                                        FROM READ-AHEAD QCB
         LA    RSTCB,QCBPEND            GET ADDRESS OF NEXT PQCB Y02027
         LA    RTEMP,ONE(RZERO,RTEMP)   INCREMENT PQCB COUNTER
         B     LOOP                     TEST THIS PRIORITY QCB
         EJECT
BUILDSCB EQU   *
*                                                                     *
*        PREPARE SCB FOR USE IN READING MESSAGE FROM DESTINATION QCB  *
*                                                                     *
         CLI   PEWABFCT,AVTEZERO        BUFFER LIMIT REACH       Y02027
         BNE   SKIPRDFG                 BYPASS TURNING RAFLG ON  Y02027
SETRAFLG EQU   *                                               @SA73367
         OI    PEWAFLG,RAFLG            ALLOW READ AHEAD         Y02027
         BAL   RETURN,DSPDISP           BR TO DISP             @G36XRAW
SKIPRDFG EQU   *                        CONT BUILDING SCB        Y02027
         TM    PEWAFLG,ERBBUSY+PEWASTOP ERB NOT POSTABLE        SA63961
         BZ    ERBPOSTA                                        @G36XRAW
         BAL   RETURN,DSPDISP           EXIT IF YES            @G36XRAW
ERBPOSTA EQU   *                                               @G36XRAW
         CLC   PERAQCB+1(3),AVTDELAD+1  R.A.Q. EMPTY           @SA71093
         BNE   SETRAFLG                 SET RAFLG AND EXIT     @SA73367
         MVC   SCBSCHDR,QCBFFEFO        MOVE DISK/CORE RECORD
         MVC   SCBSCSEG,QCBFFEFO        NUMBER INTO SCB
         NI    SCBQTYPE,X0F             CLEAR QUEUE TYPE
         STC   RTEMP,SCBPRI             PUT PRIORITY QCB INDEX         X
                                        INTO SCB
         L     RWORK,PEWALCBA           LCB ADDRESS
         MVI   LCBSTAT1-IEDQLCB(RWORK),LCBSENDN  SET FOR SEND  @SA69658
INITSEND EQU   *                                                SA52971
         XC    SCBFEFO,SCBFEFO          CLEAR SCB FOR SENDING   SA52971
         OI    QCBFLAG,QCBSDFFO         MARK QCB AS IN PROCESS  SA52971
*                                       OF SENDING MESSAGE      SA52971
BLDERB   EQU   *
         CLI   PEWABFCT,AVTEZERO        BUFFER SUPPLY EXHAUSTED  Y02027
         BNE   MORBUF                   BR-NO                  @G36XRAW
         BAL   RETURN,DSPDISP           BRANCH IF YES          @G36XRAW
MORBUF   EQU   *                                               @G36XRAW
         LA    RERB,PEERB               RELOAD ERB ADDRESS       Y02027
         TM    PEWAFLG,ERBBUSY+PEWASTOP ERB NOT POSTABLE        SA63961
         BZ    ERBPOST1                 BR- NO                 @G36XRAW
         BAL   RETURN,DSPDISP           EXIT IF YES            @G36XRAW
ERBPOST1 EQU   *                                               @G36XRAW
         MVC   LCBERBCT(1),PEWABFCT     NO. BUFFERS WANTED     @OZ26356
         L     RWORK,PEWALCBA           LCB ADDRESS             SA57355
         MVC   LCBTTCIN,LCBTTBIN-IEDQLCB(RWORK)                 SA57355
*                                       SET UP TTCIN            SA57355
BLDERBB  EQU   *
         TM    PEWAFLG,ERBBUSY+PEWASTOP ERB NOT POSTABLE        SA63961
         BZ    ERBPOST2                 BR NO                  @OZ26860
         BAL   RETURN,DSPDISP           EXIT IF YES            @G36XRAW
ERBPOST2 EQU   *                                               @G36XRAW
         LA    RERB,PEERB               RELOAD ERB ADDRESS       Y02027
         LA    RWORK,AVTDSIOB           GET ADDRESS OF DISK I/O        X
                                        QCB FROM AVT
         STCM  RWORK,SEVEN,LCBERBQB     PUT ADDR OF DISK I/O QCB Y02027
*                                       IN ERB                   Y02027
         XC    LCBERBCH(3),LCBERBCH     CLEAR BFR CHAIN FIELD
         MVI   LCBERBST,0
         MVI   LCBERBPY,PRIAPERB        FLAG AS GET/READ ERB
         LA    RSCB,PEWASCB             GET SCB ADDR             Y02027
         ST    RSCB,LCBSCBA-1           ADDRESS OF CURRENT SCB
         LR    RPARM,RERB               SET UP DISPATCHER
*                                       PARAMETER REGISTERS
         OI    PEWAFLG,ERBBUSY          TURN ON ERB-BUSY FLAG
         LA    RTEMP,PERAQCB            READ-AHEAD QCB ADDRESS
         ST    RTEMP,PERCQCB            RETURN ADDRESS OF ERB
         BAL   RETURN,DSPPOST           POST ERB TO DISK I/O   @G36XRAW
         EJECT
ELEMTEST EQU   *
*                                                                     *
*        DETERMINE TYPE OF ELEMENT POSTED TO READ-AHEAD QUEUE         *
*                                                                     *
         LR    RGETWORK,RQCB            INIT POINTER TO GET/READ       X
                                        WORKAREA
         LA    RSCB,PERAQCB-IEDQPEWA    DISPL OF QCB IN PEWA
         SR    RGETWORK,RSCB            ADDRESS OF PEWA
         LA    RSCB,PEWASCB             ADDRESS OF SCB
         LA    RERB,PEERB               ADDRESS OF ERB
         CLI   RECBKEY,DUMMY            SPECIAL QWAIT ELEMENT
         BNE   ELEMTST1                 BRANCH IF NO
         TM    PEWAFLG,CFLG             CLOSE REQUESTED
         BNO   NOTRET                   BRANCH IF NO
         L     RPARM,PEWARCB            SPECIAL ELEMENT FOR
*                                        IEDQEU
         TS    FORTY7(RPARM)            SET POSTED FLAG        @OZ26305
         BC    4,DSPDISP                GET OUT,RCB ON RDY Q   @OZ26305
         XC    5(3,RPARM),5(RPARM)      CLEAR LINK FIELD
         BAL   RETURN,DSPPOST           POST ELEM TO IEDQEU    @G36XRAW
ELEMTST1 EQU   *
         CLI   RECBPRI,RETPRI           RETRIEVE TERMINATION?  @ZA03097
         BE    OUTRZ                    YES, EMPTY QCBACK CHAIN@ZA03097
*                                       IF MULTIPLE RETRIEVAL  @ZA03097
         CLI   RECBPRI,PRIAPBFR         IS ELEMENT A FULL BUFFER
         BNE   ERBTEST                  BRANCH IF NO             Y02027
*                                                                Y02027
*              FULL BUFFER ON READ AHEAD QUEUE                   Y02027
*                                                                Y02027
         L     RWORK,PEWALCBA           LCB ADDRESS
         NI    LCBSTAT1-IEDQLCB(RWORK),LCBRCLLF INDICATE NO RECALL
         OI    PEWAFLG,POSTAP           SET ECB-TO-BE-POSTED FLAG
         MVI   PRFSCAN-IEDQPRF(RRCB),AVTEZERO ZERO SCAN POINTER
         MVC   PRFTQBCK+1-IEDQPRF(SEQLEN,RRCB),SCBOSEQ           A42396
*                                       SAVE THE SEQUENCE NUMBER A42396
         MVC   PRFQCBA-IEDQPRF(3,RRCB),SCBFEFO SAVE FEFO PTR    SA52971
         LR    RTEMP,RQCB               GET ADDRESS OF HEAD OF THE     X
                                        READ-AHEAD QCB ELEM CHAIN
         SH    RTEMP,AVTHA4             SIMULATE AN RCB
LOOPA    EQU   *
         CLC   5(3,RTEMP),AVTDELAD+1    IS THIS THE LAST ELEMENT
*                                       IN THE ELEMENT CHAIN
         BE    HANGIT                   BRANCH IF YES            Y02027
         L     RTEMP,FOUR(RZERO,RTEMP)  GET ADDRESS OF NEXT ELEMENT    X
                                        IN THE CHAIN
         B     LOOPA                    CHECK NEW ELEMENT
HANGIT   EQU   *
         STCM  RRCB,SEVEN,FIVE(RTEMP)   HANG BUFFER ON READ AHEADY02027
*                                       QCB ELEMENT CHAIN        Y02027
         L     RTEMP,4(0,RTEMP)         ADDR OF NEXT BUFFER
         LR    RBFR,RTEMP               GET BUFFER ADDR          Y02027
         MVC   5(3,RTEMP),AVTDELAD+1    ADDR OF DUMMY LAST ELEMENT
         TM    PRFSTAT1-IEDQPRF(RTEMP),PRFNLSTN  EOM BUFFER
         BO    NOTNOW                   BRANCH IF NO
         OI    PEWAFLG,RAFLG            SET READ-AHEAD FLAG
         XC    SCBSCHDR(3),SCBSCHDR     ZERO HDR PTR TO MAKE    SA52971
*                                         HM03 TEST FAIL        SA52971
         EJECT
NOTNOW   EQU   *
         TM    PRFSTAT1-IEDQPRF(RTEMP),PRFNHDRN  HEADER BUFFER
         BO    NOIDLE                   BRANCH IF NO
         L     RPARM,PEWAPROC           PROCESS ENTRY ADDRESS
         L     RPARM,TRMDESTQ-1-IEDQTRM(0,RPARM) QCB ADDRESS
         CLC   PRFSCAN-IEDQPRF(2,RTEMP),AVTFZERO RESERVE CHARS LEFT
         BE    NOIDLE                   BRANCH IF NO
*                                                                     *
*        REPLACE RESERVE CHARACTERS WITH EBCDIC IDLE CHARACTERS FOR   *
*        SUPPORT OF COMPATIBLE QTAM GET.                              *
*                                                                     *
         LH    RWORK,PRFSCAN-IEDQPRF(0,RTEMP) RESERVE CHAR COUNT
         LA    RPARM,PRFSHDR-IEDQPRF(0,RTEMP) FIRST RESERVE CHAR
IDLE     EQU   *
         MVI   AVTEZERO(RPARM),IDLECHAR INSERT IDLE CHARACTER
         LA    RPARM,1(0,RPARM)         BUMP TO NEXT CHAR
         BCT   RWORK,IDLE               SUBTRACT AND BRANCH IF
*                                       ALL IDLES NOT INSERTED
NOIDLE   EQU   *
         TM    PEWAFLG,POSTAP           NEED TO POST ECB
         BNO   RAGO                     BRANCH IF NO TO CHECK    Y02027
*                                       FOR POSSIBLE READ AHEAD  Y02027
POST     EQU   *                                                 Y02027
         NC    PEWAECBA+ONE(3),PEWAECBA+ONE  ECB TO POST         Y02027
         BZ    POSTPOST                 BRANCH IF NO             Y02027
         ICM   RRCB,ALL,PEWAWA          GET WORKAREA ADDRESS     Y02027
         BNZ   RAIB                     BRANCH IF ADDR IS THERE  Y02027
         LA    RRCB,AVTSAVE3            USE AVT SAVEAREA AS      Y02027
*                                       FAKE AIB EXTENSION       Y02027
         B     CONTRET                  CROSS MEMORY POST        Y02027
RAIB     EQU   *                                                 Y02027
         LA    RWORK,AIBWAG-IEDQAIB     GET AIB EXTENSION SIZE   Y02027
         SR    RRCB,RWORK               GET AIB BASE             Y02027
         TM    PEWAGSW,INCWA            INCOMPLETE WORKAREA      Y02027
         BZ    GO                       BRANCH IF NO - START AT  Y02027
*                                       BEGINNING OF WORKAREA    Y02027
*                                       IF YES, WAITING FOR MSG  Y02027
*                                       ON RAQCB IN GET          Y02027
         L     RWORK,PEWANEB            RESTORE ADDR OF NEXT     Y02027
*                                       EMPTY BYTE IN WORKAREA   Y02027
         L     RCOUNT,PEWAPEUN          RESTORE NUMBER OF BYTES  Y02027
*                                       USED                     Y02027
         NI    PEWAGSW,AVTEFF-INCWA     TURN OFF INCOMPLETE BIT  Y02027
         B     QCBTEST                  BR                       Y02027
POSTPOST EQU   *
         NI    PEWAFLG,POSTOFFF         TURN OFF POST-NEEDED FLAG
RAGO     EQU   *
         L     RTEMP,PEWALCBA           DUMMY LCB ADDRESS
         TM    LCBSTAT1-IEDQLCB(RTEMP),LCBRCLLN RETRIEVE MODE
         BNO   NOTRET                   BRANCH IF NO
         TM    PRFSTAT1,PRFNLSTN        EOM BUFFER               Y02027
         BO    BLDERBB                  BRANCH IF NO
         BAL   RETURN,DSPDISP           EXIT TO DISPATCHER     @G36XRAW
         EJECT
*                                                                Y02027
*              ERB POSTED TO READ AHEAD QCB                      Y02027
*                                                                Y02027
CLOSDOWN EQU   *
         LA    RWORK,AVTBFRTB           ADDR OF BUFFER RETURN QCB
         SR    RTEMP,RTEMP              CLEAR REGISTER           Y02027
         ICM   RTEMP,SEVEN,LCBERBCH     ADDRESS OF FIRST FULL BFRY02027
         BZ    ENDC                     BRANCH IF MSG CANCELLED  Y02027
RETLOOP  EQU   *                                                 Y02027
         STCM  RWORK,SEVEN,PRFQCBA-IEDQPRF(RTEMP) PUT BUFFER     Y02027
*                                       RETURN QCB INTO BUFFER   Y02027
         MVI   PRFPRI-IEDQPRF(RTEMP),PRIBFRTB  BUFFER-RETURN PRI Y02027
         MVC   PRFTQBCK-IEDQPRF(1,RTEMP),SCBPRI SET PRIORTY    @OY11980
*                                        LEVEL QUEUE OFFSET    @OY11980
         MVC   PRFTQBCK+1-IEDQPRF(2,RTEMP),SCBOSEQ  SAVE       @OY11980
*                                        SEQUENCE NUMBER       @OY11980
         CLC   PRFLINK-IEDQPRF(2,RTEMP),AVTFZERO LAST BUFFER     Y02027
         BZ    ENDC                     BRANCH IF YES            Y02027
         L     RTEMP,PRFLINK-ONE-IEDQPRF(RTEMP) ADDR OF NEXT BFR Y02027
         B     RETLOOP                  GET NEXT BUFFER
ENDC     EQU   *
         L     RPARM,PEWARCB            ADDR OF SPECIAL ELEMENT@OZ07798
*                                       FOR OPEN/CLOSE SUBTASK
         ICM   RWORK,SEVEN,LCBERBCH     GET FIRST BUFFER       @OY14498
         BZ    ENDC1                    BRANCH IF ZERO ADDRESS @OY14498
         TM    PRFSTAT1-IEDQPRF(RWORK),PRFNHDRN  HEADER BUFFER @OY11980
         BNO   ENDC1                    BRANCH IF YES          @OY11980
         CLC   PERAQCB+1(3),AVTDELAD+1  READY QUEUE EMPTY      @OY11980
         BNE   ENDC1                    BRANCH IF NO           @OY11980
         MVC   PERAQCB+1(3),LCBERBCH    PUT THE TEXT BUFFER ON @OY11980
*                                        BUFFER READ AHEAD OR  @OY11980
*                                        READ AHEAD QUEUE SO   @OY11980
*                                        IEDQEU RECONSTRUCTS   @OY11980
*                                        THE FEFO CHAIN        @OY11980
         L     RWORK,PERAQCB            ADDRESS OF BUFFER      @OY14498
ZEROLINK EQU   *                                               @OY14498
         NC    FIVE(THREE,RWORK),FIVE(RWORK)  LINK FIELD ZERO  @OY14498
         BZ    PUTDELAD                 YES, BRANCH            @OY14498
         L     RWORK,FOUR(,RWORK)       ADDRESS NEXT BUFFER    @OY14498
         B     ZEROLINK                 LOOK AT THIS BUFFER    @OY14498
PUTDELAD EQU   *                                               @OY14498
         MVC   FIVE(THREE,RWORK),AVTDELAD+1  GET DELEM ADDRESS @OY14498
         XC    FIVE(3,RPARM),FIVE(RPARM)  CLEAR LINK FIELD OF  @OY11980
*                                        SPECIAL ELEMENT       @OY11980
         B     ENDC2                                           @OY11980
ENDC1    EQU   *                        DO NOT ADD BUFFERS     @OY11980
*                                        TO CHAIN              @OY11980
          MVC   FIVE(3,RPARM),LCBERBCH   ADD BUFFERS TO CHAIN  @ZA01105
POSTEU   EQU   *                                               SA67159
ENDC2    EQU   *                                               @OY11980
         TS    FORTY7(RPARM)            SET RCB POSTED FLAG    @OZ26305
         BC    8,ENDC3                  BR,IF RCB REQUIRES POST@OZ26305
         ICM   RPARM,SEVEN,FIVE(RPARM)  ELSE, GET NEXT ELEMENT @OZ26305
         BNZ   ENDC3                      AND POST             @OZ26305
         B     DSPDISP                  NO POST REQUIRED       @OZ26305
ENDC3    EQU   *                                               @OZ26305
         BAL   RETURN,DSPCHAIN          POST ELEMENT           @OZ26305
ERBTEST  EQU   *
         NI    PEWAFLG,ERBFREE          TURN OFF ERB-BUSY FLAG
         L     RWORK,PEWALCBA           LCB ADDRESS
         TM    PEWAFLG,CFLG             CLOSEDOWN IN PROGRESS
         BNO   NOTCLOSE                 BR,NO                  @OZ28213
         TM    LCBSTAT1-IEDQLCB(RWORK),LCBRCLLN   RETRIEVE?    @OZ28213
         BO    OUTRX                    BR, YES                @OZ28213
         B     CLOSDOWN                 BR, NO                 @OZ28213
NOTCLOSE EQU   *                                               @OZ28213
         TM    LCBSTAT1-IEDQLCB(RWORK),LCBRCLLN  RETRIEVE MODE
         BO    RECALL                   BRANCH IF YES
         NC    LCBERBCH(3),LCBERBCH     CANCELLED MESSAGE
         BNZ   MHQ                      BRANCH IF NO             Y02027
         TM    PEWAFLG,RFLG             WAITING TO DO RETRIEVAL  Y02027
         BO    RETERB                   BRANCH IF YES            Y02027
         B     ERBFIX                   CONTINUE TO READ AHEAD   Y02027
         EJECT
MHQ      EQU   *
*                                                                     *
*        MOVE BUFFERS TO PRE-MH QUEUE FROM ELEMENT REQUEST BLOCK      *
*                                                                     *
         SR    RTEMP,RTEMP              CLEAR TO ZERO
         LR    RERB,RPARM               ERB ADDRESS
MHLOOP   EQU   *
         L     RWORK,LCBERBCH-1         ADDR OF A FULL BUFFER
         MVC   LCBERBCH(3),RECBLINK-IEDQRECB(RWORK) CLOSE THE CHAIN
         LR    RPARM,RWORK              BUFFER ADDRESS
         MVI   4(RPARM),PRIAPBFR        SET BUFFER PRIORITY
         MVC   PRFTQBCK-IEDQPRF(1,RPARM),SCBPRI SAVE QCB PRTY    A49227
         TM    PRFSTAT1-IEDQPRF(RPARM),PRFNHDRN HEADER BUFFER   SA65388
         BO    MHLOOP1                  BRANCH IF NO            SA65388
         MVI   PEPCBAD,AVTEZERO         CLEAR QRESET FLAG       SA65388
         NC    SCBOSEQ,SCBOSEQ          QRESET MESSAGE          SA65388
         BZ    MHLOOP1                  BRANCH IF NO            SA65388
         MVI   PEPCBAD,AVTEFF           SET QRESET FLAG         SA65388
MHLOOP1  EQU   *                                                SA65388
         CLI   PEPCBAD,AVTEFF           QRESET BUFFER           SA65388
         BNE   MHLOOP2                  BRANCH IF NO            SA65388
PRFRESET EQU   X'20'                    QRESET BUFFER FLAG      SA65388
         OI    PRFTIC-IEDQPRF(RPARM),PRFRESET SET QRESET BUFFER SA65388
MHLOOP2  EQU   *                                                SA65388
         TM    PRFSTAT1-IEDQPRF(RPARM),PRFNLSTN EOM BUFFER      SA65388
         BO    MHLOOP3                  BRANCH IF NO            SA65388
         MVI   PEPCBAD,AVTEZERO         CLEAR QRESET FLAG       SA65388
MHLOOP3  EQU   *                                                SA65388
         LA    RQCB,PEWACBUF            MH READ AHEAD CHAIN      Y02027
         BAL   RETURN,DSPPRIOR          PUT BUFFER ON CHAIN
         LA    RTEMP,1(0,RTEMP)
         CLC   LCBERBCH(2),AVTFZERO     IS CHAIN EMPTY
         BNE   MHLOOP                   NO, CONTINUE             S21101
*                                                                     *
*        POST FULL BUFFERS TO MESSAGE HANDLER                         *
*                                                                     *
         SR    RZERO,RZERO              CLEAR REG TO ZERO
         IC    RZERO,PEWABFCT           CURRENT COUNT            Y02027
         SR    RZERO,RTEMP              NEW COUNT
         STC   RZERO,PEWABFCT           CURRENT BUFFER COUNT     Y02027
         TM    PEWAFLG,RFLG             WAITING TO DO RETRIEVAL@ZA03050
         BO    RETERB                   BRANCH IF YES          @ZA03050
         TM    PEWAFLG,MHOK             MAY BFRS GO TO MH NOW
         BO    MHPOST                   BRANCH IF YES
         TM    PRFSTAT1-IEDQPRF(RWORK),PRFNLSTN END OF MSG
         BO    BLDERB                   BRANCH IF NO
         BAL   RETURN,DSPDISP           EXIT TO DISPATCHER     @G36XRAW
         SPACE 1
MHPOSTX EQU    *                                                 S21101
         CLC   PEWACBUF+ONE(3),AVTDELAD+ONE  CHAIN EMPTY         Y02027
         BE    BLDERB                   BRANCH IF YES           SA51083
MHPOST   EQU   *
         CLC   PEWACBUF+ONE(3),AVTDELAD+ONE  CHAIN EMPTY         Y02027
         BE    ERBFIX                   BRANCH IF YES
         L     RPARM,PEWACBUF           FULL BUFFER ADDRESS      Y02027
         L     RWORK,PEPCBAD            PCB ADDRESS
         MVC   1(3,RPARM),PCBMH         PREPARE TO POST TO MH
         MVC   PRFLCB-IEDQPRF(3,RPARM),PEWALCBA+1 DUMMY LCB ADDR
         L     RETURN,PEWALCBA          LCB ADDRESS
         OI    LCBSTAT1-IEDQLCB(RETURN),LCBSENDN                 S21101
         MVC   PEWACBUF+ONE(3),PRFLINK-IEDQPRF(RPARM) CLOSE      Y02027
*                                       ELEMENT CHAIN            Y02027
         LA    RSCB,PEWASCB                                      Y02027
         ST    RSCB,LCBSCBA-1-IEDQLCB(0,RETURN) SCB ADDR         Y02027
         L     RTEMP,PEWAPROC           PROCESS ENTRY ADDRESS   SA56624
         MVC   SCBDESTQ(3),TRMDESTQ-IEDQTRM(RTEMP)   SET QCB AD SA56624
         BAL   RETURN,DSPPOSTR          POST BUFFER TO MH
         EJECT
        TM    PRFSTAT1-IEDQPRF(RRCB),PRFNHDRN  HEADER BUFFER
         BO    NOPE                     BRANCH IF NO
         LA    RWORK,AVTINOUT
         ST    RWORK,PEWASCB+4
         L     RWORK,PEWALCBA           DUMMY LCB ADDRESS
         MVC   LCBTTCIN-IEDQLCB(2,RWORK),PRFDEST-IEDQPRF(RRCB) SET
*                                       PROCESS ENTRY TNT OFFSET
NOPE     EQU   *
         TM    PRFSTAT1-IEDQPRF(RRCB),PRFLOCK LOCK INQUIRY
         BNO   NOLOCK                   BRANCH IF NO
         NI    PRFSTAT1-IEDQPRF(RRCB),AVTEFF-PRFLOCK
*                                       SET NEITHER LOCK NOR SETEOF
         LR    RWORK,RRCB               SAVE BUFFER ADDRESS
         SR    RPARM,RPARM              CLEAR REGISTER TO ZERO
         LH    RPARM,PRFSRCE-IEDQPRF(0,RWORK)  SOURCE OFFSET
         N     RPARM,AVTCLRHI           CLEAR HIGH-ORDER HALF
        L     RENTRY,AVTRNMPT          CONVERSION LOGIC ADDRESS
         BALR  RETURN,RENTRY            CONVERT OFFSET TO ADDRESS
         LR    RENTRY,RPARM             SAVE TERM ENTRY ADDRESS  S22024
         L     RPARM,TRMDESTQ-1-IEDQTRM(0,RPARM)  QCB ADDRESS
         L     RPARM,QCBDCBAD-1-IEDQQCB(0,RPARM)  DCB ADDRESS
         TM    DCBOFLGS-IHADCB(RPARM),DCBOPEN  IS DCB OPENED
         BNO   NOTLOCK                  BRANCH IF NO
         TM    TRMSTATE-IEDQTRM(RENTRY),TRMPREF    3705 TERM   @G36XRAW
         BNO   NOT3705                  BR NO                  @G36XRAW
         L     RPARM,TRMDESTQ-1-IEDQTRM(RENTRY) GET QCB ADDR     S22024
         SH    RPARM,QCBHDRSZ           DECREMENT TO PLCB ADDR @ZM47936
         USING IEDNQCB,RPARM            SET BASE                 S22024
         ICM   RPARM,15,QCBPLCBA-1      GET PLCB ADDRESS         S22024
         BNM   NOTLOCK                  BRANCH POSITIVE - NO     S22024
*                                       PLCB ASSIGNED            S22024
         LA    RETURN,NUMEXT            SET DEB EXTENTS TO ONE   S22024
         B     LCBLOOP                  AND CHECK FOR LCB        S22024
NOT3705  EQU   *                                                 S22024
         L     RENTRY,DCBDEBAD-IHADCB(0,RPARM)  DEB ADDRESS
         SR    RETURN,RETURN            CLEAR COUNTER TO ZERO
         IC    RETURN,OFF(0,RENTRY)     NUMBER OF LCB'S IN LINE GROUP
         SR    RZERO,RZERO              CLEAR COUNTER TO ZERO
         LA    RZERO,LCBFLAG1-IEDQLCB
         SR    RENTRY,RENTRY            CLEAR REGISTER TO ZERO
         IC    RENTRY,DCBEIOBX-IHADCB(0,RPARM)  LCB LENGTH
         L     RPARM,DCBIOBAD-IHADCB(0,RPARM)   IOB ADDRESS
         SR    RPARM,RZERO              DUMMY LCB ADDRESS
         AR    RPARM,RENTRY             ADDR OF FIRST REAL LCB
LCBLOOP  EQU   *
         CLC   LCBTTCIN-IEDQLCB(2,RPARM),PRFSRCE-IEDQPRF(RWORK)
*                                       RIGHT LCB FOR SOURCE
         BE    SETLOCK                  BRANCH IF YES
NEXTLCB  EQU   *                                                SA54271
         AR    RPARM,RENTRY             ADDR OF NEXT REAL LCB
         BCT   RETURN,LCBLOOP           CHECK NEXT LCB
         B     NOTLOCK                  BRANCH WHEN ALL CHECKED  S21903
         EJECT
SETLOCK  EQU   *
         L     RTEMP,LCBSCBA-1-IEDQLCB(,RPARM) SCB ADDRESS      SA54271
         TM    SCBSTATE-IEDQSCB(RTEMP),SCBLCK1N SOURCE LOCKED   SA54271
         BNO   NEXTLCB                  BRANCH IF NO            SA54271
         TM    LCBINSRC+2-IEDQLCB(RPARM),LOCKI  LOCK INQUIRY
         BNO   NOTLOCK                  BRANCH IF NO
         NI    LCBINSRC+2-IEDQLCB(RPARM),AVTEFF-LOCKI SET NOT INQ
         OI    LCBINSRC+2-IEDQLCB(RPARM),LOCKR  SET RESPONSE DUE
         L     RPARM,PEPCBAD            PCB ADDRESS
         L     RPARM,PCBLCBAD-IEDQPCB(0,RPARM) LCB ADDRESS
         LH    RENTRY,LCBINCAM-IEDQLCB(0,RPARM) LOCK RESPONSE CNT
         LA    RENTRY,1(0,RENTRY)       BUMP COUNT BY ONE
         STH   RENTRY,LCBINCAM-IEDQLCB(0,RPARM) SET NEW RESPONSE CNT
NOTLOCK  EQU   *
         LR    RPARM,RWORK              RESTORE BUFFER ADDRESS
NOLOCK   EQU   *
         TM    PRFSTAT1-IEDQPRF(RPARM),PRFNLSTN EOM BUFFER
         BO    MHPOSTX                  BRANCH IF NO
         NI    PEWAFLG,AVTEFF-MHOK      BUFFER MAY NOT BE POSTED Y02027
*                                       TO MH                    Y02027
         BAL   RETURN,DSPDISP           EXIT TO DISPATCHER     @G36XRAW
         EJECT
RETRVE   EQU   *                                                 Y02027
*                                                                Y02027
*              REMOVE STCB FROM DEST QCB SO GET SCHEDULER WILL   Y02027
*              NOT PUT MESSAGES ON QUEUE                         Y02027
         L     RQCB,PEWAPROC            ADDR OF TERM ENTRY       Y02027
         L     RQCB,TRMDESTQ-ONE-IEDQTRM(RQCB) ADDR OF DEST Q.   Y02027
         LA    RSTCB,QCBSTVTO-IEDQQCB(RQCB)  GET ADDR OF STCB    Y02027
         CLM   RSTCB,SEVEN,PEWAQCBS+ONE STCB IN DEST QUEUE       Y02027
         BE    RETERB                   BRANCH IF STCB IN        Y02027
*                                       CORRECT QUEUE            Y02027
         LA    RSTCB,PERAQCB            GET RAQCB ADDRESS        Y02027
         BAL   RETURN,DSPUNAVR          MOVE STCB TO RAQCB       Y02027
*                                                                Y02027
RETERB   EQU   *                                                 Y02027
*                                                                Y02027
*        THIS SUBROUTINE RETRIEVES MESSAGES BY DESINATION/OUTPUT SEQ  *
*        NUMBER OR BY SOURCE/INPUT SEQ NUMBER BY USING RECALL FUNCTION*
*                                                                     *
         LA    RSCB,PEWASCB             SCB ADDRESS
         LA    RERB,PEERB               ERB ADDRESS
         TM    PEWAFLG,ERBBUSY+PEWASTOP ERB NOT POSTABLE        SA63961
         BZ    RSETUP                   BRANCH IF NO            SA63961
         OI    PEWAFLG,RFLG             RETRIEVE MODE FLAG
         BAL   RETURN,DSPDISP           WAIT FOR THE ERB       @G36XRAW
         SPACE 2
RSETUP   EQU   *
         CLI   PEWARTVE+TWO,BLANK       RETRIEVE TERMINATION     Y02027
         BE    OUTRZ                    BRANCH IF YES
*   SAVE SCB INFORMATION IN PROCESS ENTRY WORKAREA
         NI    PEWAFLG,AVTEFF-FIRSTR    INITIALIZE TO 1ST TIME   99226
         MVC   PEWAQCBL+ONE(3),PERAQCB+ONE SAVE ANY FULL BUFFERS Y02027
         MVI   PEWASAVE,AVTECD12        SET FOR POSSIBLE ERROR   Y02027
*                                       ZEROED WHEN CORRECT MSG  Y02027
*                                       FOUND                    Y02027
         MVC   PEWASAVE+ONE(3),SCBSCSEG SAVE ADDR OF CURRENT SEG Y02027
         MVC   PEWASAVE+FOUR(4),SCBUNTCT SAVE CNT & HDR ADDR     Y02027
         MVC   PEWASAVE+EIGHT(4),SCBSTATE SAVE DEST QCB ADDR     Y02027
         MVC   PEWASAVE+TWENTY4(7),SCBSCHDR SAVE CHDR + FFEFO  @OX16398
         MVC   PEWASAVE+THIRTY1(3),SCBDCHDR SAVE CURRENT HEADER@OZ27022
         XC    PEWASAVE+TWELVE(3),PEWASAVE+TWELVE CLEAR BYTES    Y02027
         MVC   PEWASAVE+TWENTY2(2),SCBOSEQ   SAVE SEQUENCE NO.   Y02027
         L     RTEMP,PEWALCBA           GET LCB ADDR           @OZ15631
         MVC   PEWASAVE+THIRTY4(1),LCBERBST-IEDQLCB(RTEMP)     @OX16398
*                                       SAVE ERB STATE         @OZ15631
         L     RTEMP,PEWARTVE+FOUR      TERMINAL ENTRY ADDRESS   Y02027
         L     RWORK,TRMDESTQ-1-IEDQTRM(0,RTEMP) DEST QCB ADDR
         NC    QCBQBACK-IEDQQCB(3,RWORK),QCBQBACK-IEDQQCB(RWORK)
         BZ    RCLEAN2                  EXIT WITH RC=X'0C'     @ZA03050
         ST    RWORK,SCBSTATE           ADDR OF RETRIEVAL QCB
***********************************************************************
*        AT THIS POINT WE HAVE TO CHECK FOR MULTIPLE RETRIEVAL   99226
*        IF IT IS A MULTIPLE RETRIEVAL SITUATION PEWASAVE+16 WILLY02027
*        CONTAIN THE STARTING QBACK CHAIN TO USE FOR THIS        99226
*        RETRIEVAL..... SO HERE WE GO                            99226
***********************************************************************
         TM    PEWARTVE+THREE,MULTSEQ   SEE IF MULTIPLE          Y02027
*                                      RETRIEVAL IS IN PROGRESS  99226
         BNO   NOTAMULT                BRANCH IF NOT MLTPL RET   99226
         TM    PEWARTVE+THREE,MRM       FIRST TIME               Y02027
         BO    NOTOMULT                IF 1ST TIME MULTI         99226
         NC    PEWASAVE+SIXTEEN(3),PEWASAVE+SIXTEEN QBACK SAVED  Y02027
         BZ    RCLEAN2                  BRANCH IF NO,RC=X'0C'  @ZA03050
         MVC   SCBDEOB+ONE(3),PEWASAVE+SIXTEEN USE SAVED ONE     Y02027
*                                      OF THE  ORIGINAL QBACK    99226
         B     MULTXNOW                CONTINUE MULTIPLE PROCESS 99226
NOTOMULT EQU   *                                                 99226
         NI    PEWARTVE+THREE,AVTEFF-MRM TURN OFF 1ST TIME SW    Y02027
         XC    PEWASAVE+SIXTEEN(3),PEWASAVE+SIXTEEN CLEAR        Y02027
*                                       BACKCHAIN PTR            Y02027
NOTAMULT EQU   *                                                 99226
         MVC   SCBDEOB+1(3),QCBQBACK-IEDQQCB(RWORK) QBACK POINTER
MULTXNOW EQU   *                                                 99226
         MVI   SCBDEOB,0
         L     RTEMP,PEWALCBA           LCB ADDRESS
         MVI   LCBSTAT1-IEDQLCB(RTEMP),LCBRCLLN+LCBRECVN RECALL  S21101
         MVC   PERAQCB+1(3),AVTDELAD+1
         XC    LCBTTCIN(2),LCBTTCIN     CLEAR FOR RETRIEVE
         B     BLDERBA                  GO PREPARE FOR RECALL    S21903
         EJECT
RECALL   EQU   *
*
*    PROCESS RECALLED BUFFER POINTED TO BY ERB
*
         NC    LCBERBCH(3),LCBERBCH     BFR NO LONGER ON QUEUE
         BZ    SETERR3                  BRANCH IF YES
         L     RBFR,LCBERBCH-1          ADDRESS OF RECALLED      Y02027
*                                       BUFFER                   Y02027
         NI    PRFSTAT1,PRFEOFF         CLEAR LOCK/EOF BIT     @SA64355
         LA    RTEMP,AVTBFRTB           BUFFER RETURN QCB ADDR
         STCM  RTEMP,SEVEN,PRFQCBA      PUT QCB PTR IN BUFFER    Y02027
         MVI   PRFPRI,PRIBFRTB
         MVI   PRFSCAN,AVTEZERO         CLEAR IDLE COUNT
         MVI   LCBERBCT,1               SET BFR RECALL COUNT
         CLI   PEWASAVE,ZERO            SUBSEQUENT READ OF MSG   Y02027
         BNE   NOTSUB                   BRANCH IF NO
         LR    RPARM,RBFR               DISP PARM                Y02027
         LA    RQCB,PERAQCB             ELEMENT CHAIN ADDRESS
         BAL   RETURN,DSPPRIOR          HANG BUFFER ON READ-AHEAD Q
         CLI   PEWARTVE+TWO,BLANK       RETRIEVE TERMINATION     Y02027
         BE    OUTRZ                    BRANCH IF YES
         B     SAVBFRX                  BRANCH IF NO             S21903
NOTSUB   EQU   *
         CLI   PEWARTVE+TWO,BLANK       RETRIEVE TERMINATION     Y02027
         BE    OUTR                     BRANCH IF YES
         CLI   PEWARTVE+TWO,AIBIN       SCAN BY INPUT SEQ. NO.   Y02027
         BE    INPUT                    BRANCH IF YES
         TM    PRFSTAT1,PRFNHDRN        HEADER BUFFER
         BNO   HDR                      BRANCH IF YES
SETDEOB  EQU   *                                                 S21101
         NC    PRFTQBCK(3),PRFTQBCK     END OF QBACK CHAIN       S21101
         BZ    SETERR                   BRANCH IF YES            S21101
         MVC   SCBDEOB+1(3),PRFTQBCK    SET UP TO RECALL HDR
*   RETURN UNWANTED BUFFER TO BUFFER RETURN QUEUE
*
         SPACE 2
EMPTYRTN EQU   *
         LR    RPARM,RBFR               BUFFER ADDR FOR DISPATCHRY02027
         BAL   RETURN,DSPPOSTR          POST BUFFER AND RETURN   S21101
BLDERBA  EQU   *                                                 S21101
         MVC   SCBSCHDR(3),SCBDEOB+1
         XC    SCBXTRA(3),SCBXTRA
         XC    SCBNTXT(3),SCBNTXT
         NI    SCBQTYPE,X'0F'
         MVI   SCBDEOB,AVTEZERO         CLEAR DEOB               S99226
         MVI   LCBERBCT,1               BUFFER RECALL COUNT
         B     BLDERBB                  DO ANOTHER RECALL
         EJECT
HDR      EQU   *
         CLC   PEWARTVE(2),PRFDEST      CORRECT DESTINATION      Y02027
         BNE   GETITX                   BRANCH IF NO
         TM    PEWARTVE+THREE,MULTSEQ   MULTIPLE RETRIEVAL       Y02027
         BNO   DESNOT                  BRANCH NO                 99226
***********************************************************************
*        IF YES WE WISH TO RETRIEVE ONE AND SAVE QBACK CORRECTLY 99226
***********************************************************************
         MVC   PEWASAVE+SIXTEEN(3),PRFHQBCK  SAVE BACK CHAIN PTR Y02027
         MVC   PEWASAVE+TWENTY(2),PEWARTVE+THREE  MOVE SEQ. NO.  Y02027
*                                       TO SAVEAREA              Y02027
         NI    PEWASAVE+TWENTY,AVTEFF-MULTSEQ-MRM RESET FLAGS    Y02027
         CLC   PEWASAVE+TWENTY(2),SCBOSEQ IS THIS MESSAGE WANTED Y02027
         BNL   SAVBFR1                  YES, SAVE SEQ NUMBER     Y02027
         NC    PEWASAVE+SIXTEEN(3),PEWASAVE+SIXTEEN END OF CHAIN Y02027
         BZ    SETERR                   BRANCH IF YES            Y02027
         MVC   SCBDEOB+ONE(3),PEWASAVE+SIXTEEN MOVE QBACK FOR    Y02027
*                                       SEARCH                   Y02027
         B     EMPTYRTN                RETURN BUFFER POST ERB    99226
SAVBFR1  EQU   *                       FOUND MESSAGE ROUTINE     99226
         NC    SCBOSEQ(2),SCBOSEQ       MESSAGE SENT YET        SA60004
         BZ    GETIT                    NO, CONTINUE SCAN       SA60004
         B     SAVBFR                  NOW RETRIEVE THE MESSAGE  99226
DESNOT   EQU   *                       SINGLE RETRIEVAL ROUTINE  99226
         CLC   PEWARTVE+THREE(2),SCBOSEQ COMPARE SEARCH ARGUMENT Y02027
*                                       WITH OUTPUT SEQ NO.
         BE    SAVBFR                   BEGIN MSG RETVL IF FOUND
*    ASSUME THAT WE MUST CONTINUE THE SEARCH
GETIT    EQU   *
         NC    PRFHQBCK(3),PRFHQBCK     END OF BACK CHAIN
         BZ    SETERR                   BRANCH IF YES
         MVC   SCBDEOB+1(3),PRFHQBCK    SET UP TO SEARCH
         B     EMPTYRTN                 RETURN BFR & POST ERB
         SPACE 1
GETMOREX EQU   *                                                 S21101
         TM    PRFSTAT1,PRFNHDRN        HEADER BUFFER            S21101
         BO    GETITZ                   BRANCH IF NO             S21101
GETITX   EQU   *
         LH    RPARM,PRFDEST            DESTINATION OFFSET
         N     RPARM,AVTCLRHI           CLEAR HIGH-ORDER HALFWORD
         L     RENTRY,AVTRNMPT          TNT CONVERSION ROUTINE
         BALR  RETURN,RENTRY            GET TERM ENTRY ADDRESS
         CLC   TRMDESTQ-IEDQTRM(3,RPARM),SCBDESTQ SAME QUEUE
         BE    GETIT                    BRANCH IF YES
GETITZ   EQU   *
         NC    PRFTQBCK,PRFTQBCK        END OF QBACK CHAIN
         BNZ   SETDEOB                  NO, CONTINUE THE SEARCH  S21101
SETERR   EQU   *
         NI    PEWAOPTC,AVTEFF-RTVFLG   TURN OFF RETRIEVE MODE   Y02027
         MVI   PEWASAVE,AVTECD12        SET ERROR INDICATOR      Y02027
OUTR     EQU   *
         XC    PEWASAVE+SIXTEEN(3),PEWASAVE+SIXTEEN CLEAR MULTRETY02027
*                                      QBACK CHAIN JUST IN CASE  99226
         LA    RTEMP,AVTBFRTB           BUFFER RETURN QCB
         ST    RTEMP,PRFQCBA-1          PREPARE TO RETURN BUFFER
         LR    RPARM,RBFR               DISPATCHER PARAMETER     Y02027
         BAL   RETURN,DSPPOSTR          POST BUFFER
SETLCBAD EQU   *                                               @XA05282
         L     RTEMP,PEWALCBA           LCB ADDRESS            @XA05282
         B     RCLEAN2                  START CLEANUP          @XA05282
         EJECT
INPUT    EQU   *
*    SCAN FOR 'LAST TEXT' SEGMENTS
*   WHEN ONE IS FOUND, RECALL RELATED HEADER TO CHECK INPUT SEQNO
         TM    SCBSTAT1,PRFNLSTN        EOM BUFFER RECALLED
         BO    NOTLAST                  BRANCH IF NO             Y02027
LASTSEG  EQU   *
         CLC   PEWARTVE(2),PRFSRCE      CORRECT SOURCE           Y02027
         BNE   GETMOREX                 BRANCH IF NO
         TM    PRFSTAT1,PRFNHDRN        HEADER BUFFER
         BNO   ISEQ                     BRANCH IF YES
         OI    PEWAFLG,FIRSTR           SET FIRST-TIME SWITCH
         MVC   PEWASAVE+TWELVE(3),PRFTQBCK   SAVE TEXT QBACK     Y02027
         MVC   SCBDEOB+1(3),PRFCHDR     SET UP TO RECALL HEADER
         B     EMPTYRTN                 RETURN BFR AND POST ERB  S21903
NOTLAST  EQU   *                                                 Y02027
         TM    PEWAFLG,FIRSTR           FIRST TIME THROUGH       Y02027
         BNO   GETIT                    BRANCH IF YES            Y02027
ISEQ     EQU   *
         TM    PEWARTVE+THREE,MULTSEQ   MULTI-RETRIEVAL MODE     Y02027
         BNO   NOMULTIN                 BRANCH IF NO             Y02027
         MVC   PEWASAVE+TWENTY(2),PEWARTVE+THREE  MOVE SEQ. NO.  Y02027
*                                       TO WORKAREA              Y02027
         NI    PEWASAVE+TWENTY,AVTEFF-MULTSEQ-MRM CLEAR MULTI    Y02027
*                                       RETRIEVE FLAGS           Y02027
         CLC   PEWASAVE+TWENTY(2),PRFISEQ IS THIS MESSAGE WANTED Y02027
         BL    NOTSEQ                   BRANCH IF YES            Y02027
COMPBACK EQU   *                                                 99226
         TM    PEWAFLG,FIRSTR          FIRST TIME HEADER         99226
         BNO   OURGETX                 GO SAVE THE CORRECT QBACK 99226
         MVC   PEWASAVE+SIXTEEN(3),PEWASAVE+TWELVE PUT QBACK     Y02027
         NI    PEWAFLG,AVTEFF-FIRSTR   CLEAR FIRST TIME HEADER   99226
         B     SAVBFR                  GO AND RETREIVE THE MSG   99226
OURGETX  EQU   *                                                 99226
         LH    RPARM,PRFDEST           GET THE DESTINATION OFFST 99226
         N     RPARM,AVTCLRHI          CLEAR THE HIGH ORDER HALF 99226
         L     RENTRY,AVTRNMPT         GET TNT CONVERSION ROUTINE99226
         BALR  RETURN,RENTRY           GET THE TERMINAL ADDRESS  99226
         CLC   TRMDESTQ-IEDQTRM(3,RPARM),SCBDESTQ  SAME QUEUE    99226
         BE    OURHQ                   YES SAVE THE CORRECT QBACK99226
         MVC   PEWASAVE+SIXTEEN(3),PRFTQBCK SAVE PROPER QBACK    Y02027
         B     SAVBFR                  NOW GO AND GET THE MSG    99226
OURHQ    EQU   *                                                 99226
         MVC   PEWASAVE+SIXTEEN(3),PRFHQBCK  SAVE QBACK          Y02027
         B     SAVBFR                  GO AND GET THE MESSAGE    99226
NOMULTIN EQU   *                                                 99226
         CLC   PEWARTVE+THREE(2),PRFISEQ COMPARE SEARCH ARGUMENT Y02027
         BE    SAVBFR                   BRANCH IF MSG FOUND
NOTSEQ   EQU   *                                                 Y02027
         TM    PEWAFLG,FIRSTR           FIRST-TIME HEADER
         BNO   GETITX                   BRANCH IF NO             A41026
*   ASSUME SEQUENCE NUMBER NOT REACHED YET
*
         NC    PEWASAVE+TWELVE(3),PEWASAVE+TWELVE END OF CHAIN   Y02027
         BZ    SETERR                   BRANCH IF YES            Y02027
         MVC   SCBDEOB+ONE(3),PEWASAVE+TWELVE QBACK FROM CURRENT Y02027
*                                       LAST TEXT                Y02027
         XC    PEWASAVE+TWELVE(3),PEWASAVE+TWELVE CLEAR QBACK PTRY02027
         NI    PEWAFLG,AVTEFF-FIRSTR    SET NOT FIRST-TIME
         B     EMPTYRTN                 RETURN BFR AND POST ERB  S21903
SAVBFR   EQU   *
         MVI   PEWASAVE,ZERO            SET NORMAL COMPLETION C. Y02027
         ST    RBFR,PERAQCB             SAVE HDR BFR ON R-A QCB  Y02027
         MVI   PRFSCAN,AVTEZERO         CLEAR IDLE COUNT
         MVC   PRFLINK,AVTDELAD+1       SET UP LINK FIELD
         NI    PEWAOPTC,AVTEFF-RTVFLG   TURN OFF RETRIEVE MODE   Y02027
*                                       NEXT GET NOT IN RET. MODEY02027
         MVC   PRFCORE(2),SCBOSEQ       SAVE SEQUENCE NUMBER   @YA09297
*                                        FOR MULTIPLE RETRIEVE @YA09297
*                                        USE. GET/READ ROUTINE @YA09297
*                                        WILL PASS IT BACK     @YA09297
*                                        TO THE USER.          @YA09297
SAVBFRX  EQU   *
         TM    PRFSTAT1,PRFNLSTN        EOM BUFFER
         BNO   POST                     BRANCH IF YES
         LA    RERB,PEERB               RELOAD ERB ADDRESS       Y02027
         CLC   SCBSCSEG(3),SCBCRCD      HAS THIS RECORD BEEN   @OZ11164
*                                        READ BEFORE           @OZ11164
         BE    NOTLAST1                 YES, BR                @OZ11164
         TM    SCBSTAT1,PRFNLSTN        EOM BUFFER             OZ07100
         BO    NOTLAST1                 BR IF NO               OZ07100
         MVI   AVTDOUBL,AVTEZERO        CLEAR HI BYTE          @OZ11164
         MVC   AVTDOUBL+1(3),SCBXTRA    CURRENT EXTRE RECORD   @OZ11164
         MVC   SCBNTXT(3),SCBCRCD       ASSUME NO EXTRA        @OZ11164
         L     RTEMP,AVTDOUBL           GET IT                 @OZ11164
         LTR   RTEMP,RTEMP              ANY EXTRA RECORDS      @OZ11164
         BZ    NOTLAST1                 BR IF NO               @OZ11164
         LH    RRCB,SCBSIZE             GET PREFIX SIZE        @OZ11164
         N     RRCB,AVTCLRHI            CLEAR HIGH HALFWORD    @OZ11164
XTRALOOP EQU   *                                               @OZ11164
         LA    RTEMP,INCR(,RTEMP)       BUMP ADDRESS           @OZ11164
         SH    RRCB,AVTKEYLE            REDUCE BY KEY LENGTH   @OZ11164
         BP    XTRALOOP                 BR IF STILL PLUS       @OZ11164
         SH    RTEMP,CONST              ADJUST REG             @OZ11164
         ST    RTEMP,AVTDOUBL           LAST EXTRA FOR NTXT    @OZ11164
         MVC   SCBNTXT(3),AVTDOUBL+1    SET STOPPER FOR        @OZ11164
*                                        READING EOM           @OZ11164
NOTLAST1 EQU   *                                               @OZ11164
         NI    SCBQTYPE,X'0F'
         MVI   LCBERBCT,1               UNIT COUNT
         L     RTEMP,PEWALCBA           LCB ADDRESS
         MVI   LCBSTAT1-IEDQLCB(RTEMP),LCBRCLLN+X'01' SET RECALL FLAGS
         B     POST                     POST ECB AND DO RECALL
SETERR3  EQU   *
         MVI   PEWASAVE,AVTECD12        SET ERROR CODE           Y02027
         NI    PEWARTVE+THREE,RESETRM   RESET MRM              @OY15490
RCLEAN   EQU   *
         CLI   PEWASAVE,AVTECD12        ERROR                    Y02027
         BE    RCLEAN2                  YES,CLEANUP            @ZA03050
         CLI   PEWARTVE+TWO,ZERO        RETRIEVE TERMINATION     Y02027
         BE    RCLEANX                  BR-YES                 @G36XRAW
         BAL   RETURN,DSPDISP           NO, WAIT FOR GET TO    @G36XRAW
*                                       CLEANUP                  Y02027
RCLEANX  EQU   *
*   EOM EMPTY SO GET OUT OF RETRIEVE MODE
         L     RTEMP,PEWALCBA           LCB ADDRESS
         TM    LCBSTAT1-IEDQLCB(RTEMP),LCBRCLLN RETRIEVE MODE
         BNO   ERBFIX                   BRANCH IF NO
RCLEAN2  EQU   *                                               @XA05282
         L     RTEMP,PEWALCBA           LCB ADDRESS            @ZA03050
         MVI   LCBSTAT1-IEDQLCB(RTEMP),LCBSENDN CLEAR RECALL FLGSA56624
         MVC   LCBERBST-IEDQLCB(1,RTEMP),PEWASAVE+THIRTY4      @OX16398
*                                       RESTORE ERB STATUS     @OZ15631
         LA    RERB,PEERB               RELOAD ERB ADDRESS       Y02027
         LA    RSCB,PEWASCB             ADDRESS OF SCB           Y02027
         MVC   SCBSCSEG(3),PEWASAVE+ONE RESTORE CURRENT SEG ADDR Y02027
         MVC   SCBUNTCT(4),PEWASAVE+FOUR RESTORE CNT & HDR ADDR  Y02027
         MVC   SCBSTATE(4),PEWASAVE+EIGHT RESTORE PROC QCB ADDR  Y02027
         MVC   SCBSCHDR(7),PEWASAVE+TWENTY4 RESTORE CHDR + FFEFO@X16398
         MVC   SCBDCHDR(3),PEWASAVE+THIRTY1 RESTORE CURRENT HDR@OX16398
         MVC   SCBOSEQ,PEWASAVE+TWENTY2 RESTORE SEQ NUMBER       Y02027
         L     RTEMP,PEPCBAD            PROCESS CONTROL BLOCK
         MVC   LCBERBCT(1),PCBBUFMX-IEDQPCB(RTEMP)  RESET RAQ LIM
         NI    PEWAFLG,X'FF'-RFLG       TURN OFF RETRIEVE MODE FLAG
         NI    PEWAOPTC,AVTEFF-RTVFLG   CLEAR RETRIEVE FLAG    @ZA02649
         NC    PERAQCB+5(3),PERAQCB+5   BFR ADDR ZERO          @XA05282
         BNZ   NOTZERO                  BRANCH IF NO           @XA05282
         MVC   PERAQCB+5(3),AVTDELAD+1  SET DELEM ADDR         @XA05282
NOTZERO  EQU   *                                               @XA05282
         MVC   PERAQCB+ONE(3),PEWAQCBL+ONE RESTORE FULL BFR CHAINY02027
         XC    PEWAQCBL+ONE(3),PEWAQCBL+ONE  SHOW NO BUFFERS     Y02027
         XC    PEWAELEM+8(3),PEWAELEM+8  CLEAR COUNT TO ZERO   @SA74016
         MVI   PEWARTVE,XC2             RESTORE APPL. PROG. FLG@OZ11199
         L     RPARM,PEWARCB            RCB ADDRESS            @OZ07798
         TM    PEWAFLG,CFLG             CLOSEDOWN ACTION        SA67159
         BNO   NOCLOSE                  BR-NO                  @G36XRAW
         TS    FORTY7(RPARM)            SET RCB POSTED FLAG    @OZ26305
         BC    4,DSPDISP                GET OUT, RCB ON RDY Q  @OZ26305
         BAL   RETURN,DSPPOST           POST RCB               @OZ26305
NOCLOSE  EQU   *                                               @G36XRAW
         CLC   PERAQCB+1(3),AVTDELAD+1  QUEUE EMPTY?             A47127
         BNE   PREPOST                  BRANCH IF NO             Y02027
         OI    PEWAFLG,RAFLG            SET READ AHEAD FLAG      A47127
PREPOST  EQU   *                                                 Y02027
         NC    PEWAECBA,PEWAECBA        ECB TO POST              Y02027
         LA    RETURN,NOTRET            SET FOR BRANCH TO TRY A  Y0202M
*                                       READ AHEAD               Y02027
         BZR   RETURN                   BRANCH IF NO             Y02027
         LA    RRCB,AVTSAVE3            USE AVT SAVEAREA         Y02027
*                                       AS FAKE AIB              Y02027
         B     GOODRETC                 CROSS MEMORY POST        Y02027
OUTRX    EQU   *                                                 Y02027
         TM    PEWAFLG,ERBBUSY          ERB NOT POSTABLE       @ZA03050
         BNO   ERBPOST3                 BR-NO                  @G36XRAW
         BAL   RETURN,DSPDISP                                  @G36XRAW
ERBPOST3 EQU   *                                               @G36XRAW
         MVI   PEWARTVE+TWO,ZERO        RESET TERMINATION FLAG   Y02027
OUTRZ    EQU   *
         XC    PEWASAVE+SIXTEEN(3),PEWASAVE+SIXTEEN CLEAR        Y02027
*                                       MULTIPLE RETRIEVAL       Y02027
*                                      QBACK CHAIN JUST IN CASE  99226
         NI    PEWARTVE+THREE,RESETRM   RESET MRM              @OY15490
OUTRZ1   EQU   *                                               @SA68228
         CLC   PERAQCB+1(3),AVTDELAD+1  QUEUE EMPTY
         BE    RCLEAN                   BRANCH IF YES
         L     RPARM,PERAQCB            ADDRESS OF FIRST BUFFER
RLOOP    EQU   *
         L     RTEMP,PRFLINK-1-IEDQPRF(0,RPARM) NEXT BUFFER
         XC    PRFLINK-IEDQPRF(3,RPARM),PRFLINK-IEDQPRF(RPARM)
         BAL   RETURN,DSPPOSTR          POST BFR TO RETURN QCB
         LA    RTEMP,0(0,RTEMP)
         C    RTEMP,AVTDELAD            LAST BUFFER
         BE    SETLCBAD                 BRANCH IF YES          @XA05282
         LR    RPARM,RTEMP              BUFFER ADDRESS
         B     RLOOP                    GO RETURN THIS BUFFER
         SPACE 1
**  **  C O N S T A N T S  **  **                                S21101
         SPACE 1
CLEAR    DC    0F'0',X'00FFFFFC'                                 S21101
BLANKS   DC    8C' '                    EIGHT BLANKS TO CLEAR    Y02027
*                                       NAME FIELD               Y02027
CONST    DC    H'8'                     CONSTANT               @OZ11164
QCBHDRSZ DS    0H                       QCB HDR SIZE           @ZM47936
         DC    AL2(QCBPRFSZ)            QCB HDR SIZE           @ZM47936
PATCH1   DC    25H'0'                   PATCH AREA               Y02027
         EJECT
*        THIS LOGIC IS ACTIVATED BY THE DESTINATION SCHEDULER         *
*        WHEN AN EOM BUFFER IS POSTED TO A PREVIOUSLY EMPTY           *
*        DESTINATION QUEUE.                                           *
TAG      EQU   *
         USING *,RENTRY
         L     RWORK,QCBPREN            PROCESS ENTRY ADDRESS
         L     RGETWORK,TRMSTAT-IEDQTRM(0,RWORK) PEWA ADDRESS
         TM    PEWAFLG,CFLG             CLOSE PENDING          @OZ17615
         BNO   TAG1                     BR, NO                 @OZ17615
         ICM   RPARM,SEVEN,PEWARCB+ONE   GET CLOSE RCB         @OZ17615
         TS    FORTY7(RPARM)            SET POSTED FLAG        @OZ26305
         BC    8,DSPPOSTR               POST RCB FOR CLOSE     @OZ26305
         BR    RETURN                   RETURN, RCB ON READY Q @OZ26305
TAG1     EQU   *                                               @OZ17615
         TM    PEWAFLG,PEWASTOP         ENTRY CLOSED            SA63961
         BNZR  RETURN                   BR IF YES                Y02027
         MVC   QCBSTCHN(3),QCBSLINK     MOVE GET SCHEDULER TO    Y02027
         MVC   QCBSLINK(3),PEWAQCBS+ONE READ AHEAD QCB AS DONE   Y02027
         LA    RWORK,QCBSTVTO           BY DSPUNAV. DEST QCB'S   Y02027
         ST    RWORK,PEWAQCBS           STCB POINTS TO HM        Y02027
         LA    RWORK,PERAQCB            READ-AHEAD QCB ADDRESS
         ST    RWORK,PEWAELEM
         OI    PEWAFLG,RAFLG            SET 'READ NOW' FLAG      S22025
         MVI   PEWAELEM,DUMMY           CHANGE-Q ELEMENT FLAG
         MVI   PEWAELEM+4,X'C0'         CHANGE-Q ELEM PRIORITY
         XC    PEWAELEM+5(3),PEWAELEM+5 SET LINK FIELD TO ZERO
         LA    RPARM,PEWAELEM           ADDR OF DUMMY ELEMENT
         L     RWORK,PEWALCBA           LCB ADDRESS
         NI    LCBSTAT1-IEDQLCB(RWORK),LCBRCLLF NO RECALL
         B     DSPPOSTR                 POST DUMMY ELEMNT &RTN
*                                       TO DESTINATION SCHEDULER
         DROP  RENTRY
** **  E Q U A T E S  **
         SPACE 2
LOCKI    EQU   X'10'                    LOCK INQUIRY FLAG        S21903
ZERO     EQU   0                        ZERO-BYTE DISPLACEMENT
ONE      EQU   1                        ONE-BYTE DISPLACEMENT
TWO     EQU    2                        DISPLACEMENT             Y02027
NUMEXT   EQU   1                        NUMBER OF DEB EXTENTS    S22024
THREE    EQU   3                        THREE-BYTE DISPLACEMENT
FOUR     EQU   4                        DISPLACEMENT             Y02027
FIVE     EQU   5                        DISPLACEMENT             Y02027
SIX      EQU   6                        DISPLACEMENT             Y02027
EIGHT    EQU   8                        EIGHT-BYTE DISPLACEMENT
NINE     EQU   9                        DISPLACEMENT             Y02027
TEN      EQU   10                       DISPLACEMENT             Y02027
TWELVE   EQU   12                       DISPLACEMENT             Y02027
SIXTEEN  EQU   16                       DISPLACEMENT             Y02027
TWENTY   EQU   20                       DISPLACEMENT             Y02027
TWENTY2  EQU   22                       DISPLACEMENT             Y02027
TWENTY4  EQU   24                       DISPLACEMENT             Y02027
THIRTY   EQU   30                       DISPLACEMENT             Y02027
THIRTY1  EQU   31                       DISPLACEMENT           @OX16398
THIRTY4  EQU   34                       DISPLACEMENT           @OX16398
THIRT3   EQU   33                       DISPLACEMENT           @OZ15631
SEVEN    EQU   7                        MASK OF 0111             Y02027
ALL      EQU   15                       MASK OF 1111             Y02027
SEQLEN   EQU   2                        SEQ NUMBER LENGTH        S21903
DUMMY    EQU   X'08'                    QWAIT ELEMENT KEY
BLANK    EQU   C' '                     RETRV TRMNATION INDICATR S21903
QSAMFLG  EQU   X'40'                    QSAM DCBMACRF IDENTIFIER Y02027
EOQ      EQU   X'02'                    BOTH QUEUES EMPTY        Y02027
EOD      EQU   X'01'                    READ AHEAD QUEUE EMPTY   Y02027
SOWACC   EQU   X'52'                    ERROR CODE               Y02027
DATET    EQU   X'10'                    DATE=YES IS SPECIFIED    Y02027
STOPQRC  EQU   20                       DISABLED ENTRY R.C.      Y02027
TIC      EQU   X'08'                    TIC OP CODE              Y02027
PRFLEN   EQU   4                        PREFIX LENGTH            Y02027
SRCELEN  EQU   8                        LENGTH OF SOURCE FIELD   Y02027
PARMLEN  EQU   8                        LENGTH OF DATE/TIME      Y02027
CBYTELEN EQU   1                        CONTROL BYTE LENGTH      Y02027
XC2      EQU   X'C2'                    FLAG FOR APPL. PROG.   @OZ11199
OFF      EQU   X'10'                    TEN-BYTE DISPLACEMENT    S21903
DCBOPEN  EQU   X'10'                    TO TEST FOR OPEN DCB     S21903
LOCKR    EQU   X'20'                    RESPONSE DUE FLAG        S21903
IDLECHAR EQU   X'17'                    EBCDIC IDLE CHARACTER    S21903
X0F      EQU   X'0F'                    TO CLEAR Q-TYPE FLAGS    S21903
DISKAD   EQU   X'03'                    FLAGS USED IN DISK ADDR  A47133
RETPRI   EQU   X'50'                    PRIORITY OF ELEMENT    @ZA03097
*                                       POSTED TO IEDQEW BY    @ZA03097
*                                       IEDQEU IF CLOSEDOWN IS @ZA03097
*                                       REQ DURING RETRIEVE    @ZA03097
INCR     EQU   4                        INC VALUE FOR ADDR     @OZ11164
RESETRM  EQU   X'7F'                    FLAG TO RESET MRM      @OY15490
FORTY7   EQU   47                       RCB OFFSET FOR POSTED  @OZ26305
*                                        FLAG                  @OZ26305
         EJECT
*                             DSECTS
         TTCXD                                                 @ZA05000
         EJECT
CVTMAP   CVT   DSECT=YES                                       @ZA05000
         EJECT
        TAIBD  EXT=(GETREAD,POINT)
        TPEBD
         TTNTD
         TPRIOR
         TAVTD
         TQCBD                          QUEUE CONTROL BLOCK
         TSCBD
         TLCBD                          LINE CONTROL BLOCK
         TRECBD                         RESOURCE CONTROL BLOCK
         TSTCBD                         SUBTASK CONTROL BLOCK
         TTRMD
         TPRFD
         TDISPD
         TPCBD
         TPEWAD
         TDEBAPD
         DCBD  DSORG=TX
         END

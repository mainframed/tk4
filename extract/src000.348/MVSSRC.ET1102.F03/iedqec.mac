EC01     TITLE '''IEDQEC'' - TCAM PUT SCHEDULER'
         SPACE 1
IEDQEC   CSECT
*A000000-999999                                                @X31X8A0
         SPACE 3
******************** MICROFICHE FLAGS *********************** SUPT CODE
*C186000,191000,327000,360000,460000,                            S21903
*C474000,505000,510000,550000,624000                             S21903
*C340000                                                        SA52991
*A314000,345000,630000                                          SA52991
*A250200                                                        SA52508
*C081200                                                        SA52508
*A420000                                                         A44891
*D422700,431000-437000,570000                                    A44891
*C409000                                                         A44891
*C081400,655950                                                  A42404
*C081200                                                         S22025
*A126000,592000                                                  A48279
*C081400                                                         A48279
*D656000                                                         A48279
*A109000,541000,549000,564000                                   SA51096
*C523000,524000                                                  S21903
*A564500                                                        SA57699
*D564000                                                        SA57699
*C122000                                                        SA59182
*A240000,247000                                                  S22024
*A497500                                                        SA58449
*A549000,564000                                                 SA50196
*C110000                                                        SA50196
*C006000                                                         S21903
*A126300                                                        SA59526
*           CLEAN-UP                                            S21903
*A389000                                                        OY00458
*A031300-031900,033200-033600,053100-053600,065500,078500,       Y01004
*A080050-081840,121500,123500,235100-235700,240005-240055,249900,Y01004
*A267427-267476,267565-267615,422060-422420,422700,447400,       Y01004
*A479500,498500,549600-549700,561000,612500,624100-624900,655985,Y01004
*A656090-656590                                                  Y01004
*C018200,080000,081000,081200,121000-124000,249600,250200-250400,Y01004
*C287000,371000-373000,376000-378000,422000,479000-481000,498000 Y01004
*D077000,087000,125000,250600,266000,354000,356000,366000,454000,Y01004
*D566000-571000,606000,635000,639000-640000,648000,652000        Y01004
*C497620                                                         Y05330
*A292600                                                        OX02215
*C122000                                                        SA66354
*C007000-014500,018400-018600,020000,022000,031600,035000,043000 Y02027
*C072000,080150-080400,080500,080600,080700,080800,081000,081060 Y02027
*C081200,081300,091000,122000,136000,149000,150400,153000,154000 Y02027
*C155000,156000,177000,182000,191000,191500,209000,218000,229000 Y02027
*C235000,243000,247300,247500,249000,253000,254000,257300,257900 Y02027
*C258500,259000,260000,267350,267700,267840,268000,269000,287000 Y02027
*C292300,293000,295000,299000,324000,329000,345240,345330-347140 Y02027
*C364000,398000,400000,415000,422180,465500,467000,497620,498000 Y02027
*C501000,503000-504000,514000,521000-548200,600000-602000,611000 Y02027
*C614200,622000,623000-624900,656490,663000,670000               Y02027
*D053200-053500,065500,076000,080050,080550,080650,080750,081120 Y02027
*D081400-081900,106000,106000-109000,111000-114000,118000        Y02027
*D122200-126500,157000-167000,205-206000,210000,213000           Y02027
*D235100-235700,240008-240100,247600-247700,249600,257600.258200 Y02027
*D267420,257476,267565-267615,267910,267950,271200,292000,345270 Y02027
*D345300,348000,399000,401000,404000,470000-482000,505000-507000 Y02027
*D549000-565000,612500,614400-615000,616000,617000,618000,619000 Y02027
*D620000,621000,623000-624900,641000-653300,654200-654800,656290 Y02027
*D668000                                                         Y02027
*A031800,035200-035600,062500,080900,096000-105900,152300-152600 Y02027
*A153040,153880,154200-154600,155070-155840,156100-156800        Y02027
*A229100-229800,249400,267840-269840,292400,393200-393600,402000 Y02027
*A429000-433000,443500,469200-469600,498500,611500,616200,618200 Y02027
*A620200,656498-656578,670500                                    Y02027
*A 655990                                                      @SA69971
*C 587000-588000                                               @SA69971
*A148000,216000,217000,465000                                  @YA04914
*C173000,214000                                                @YA04914
*D200000,471000,484000,500000-510000,593000                    @YA04914
*C006800                                                       @Z30X8AM
*D098200,09800,100300,616200                                   @ZA02061
*A240000                                                       @Z30X8AM
*A099100,630000                                                @ZA02061
*A213000                                                       @YA07129
*A305000,321000,655990                                         @SA72774
*D148200-148800,214000                                         @YA08769
*C292605,292625,292645,292655-292670                           @ZA03747
*A099170                                                       @ZA04005
*A100500,100600,656538                                         @ZA04032
*A533000,661000                                                @ZA05000
*D656498,656506                                                @ZA05000
*C534500                                                       @ZA05000
*C122000                                                       @YA10439
*C100650                                                       @OY11959
*C547600                                                       @OZ07798
*A134000                                                       @OX12583
* A002930,247000,497560,497700,533000,533370,536000,613000     @G36XRAW
* C002001,245200,247400,530000,532500-533000,550000-550500,    @G36XRAW
* C613000                                                      @G36XRAW
* C247100,245300                                               @G36XRAW
* D497620,498000,533400,536500                                 @G36XRAW
* D245400-245800                                               @G36XRAW
* A497565-497575,497750,533010,533020,537000,613500            @G36XRAW
*A186500,655400                                                @XA11307
*C153040,183000                                                @XA11307
*C533500-536000                                                @Z40X9AG
*   INCLUDE APAR OX11037 THAT WAS LEFT OUT OF TCAM10           @OZ27031
*   INCLUDE LVL9 DEVELOPMENT CODE THAT WAS LEFT OUT OF TCAM10  @OZ27030
*                                       PEWA DSECT CHG         @OZ27843
*A186940                                                       @OZ26689
         SPACE 4
***********************************************************************
*                                                                     *
*TITLE: 'IEDQEC' PUT SCHEDULER                                        *
*                                                                     *
*  MODULE NAME = IEDQEC                                               *
*                                                                     *
*  DESCRIPTIVE NAME = PUT SCHEDULER                                   *
*                                                                     *
*  COPYRIGHT = 'NONE'                                                 *
*                                                                     *
*  STATUS:  CHANGE LEVEL 10                                    @G36XRAW
*                                                                     *
*                                                                     *
*FUNCTION: THE ROUTINE IS DIVIDED INTO TWO SECTIONS (1)PUT-MCP        *
*   SUBTASK WHEN A PUT MACRO IS ISSUED AND (2) PUT SCHEDULER.         *
*   THE PUT-MCP SUBTASK IS ACTIVATE BY THE DISPATCHER WHEN AN RCB     *
*   IN THE AIB IS POSTED TO THE PUT QCB IN THIS ROUTINE. IF TERM      *
*   NAME OF THE MESSAGE DESTINAION IS SPECIFIED, IT IS VERIFIED       *
*   AND OFFSET OBTAINED. THE ERB IS POSTED TO THE REQUEST BUFFER      *
*   QUEUE TO GET BUFFERS FROM TCAM BUFFER POOL.                       *
*                                                                     *
*   THE PUT SCHEDULER IS ACTIVATED WHEN ELEMENT IS POSTED TO SCHED.   *
*   (1) ERB CONTAINING EMPTY BUFFERS                                  *
*   (2) LCB POSTED BY BD AT END OF MESSAGE TIME.                      *
*   THIS ROUTINE MOVES DATA FROM THE WORKAREA IN THE AIB TO MCP       *
*   BUFFERS, AND POSTS FULL BUFFERS TO THE MH POINTED TO BY THE PCB.  *
*   IF THE TERMINAL IS IN LOCK MODE AND MESSAGE IS THE RESPONSE,      *
*   ITS SEND SCHEDULER IS INSERTED IN STCB CHAIN OF LCB.              *
*                                                                     *
*   IF THE DCB INDICATES RECORD FORMAT W/O WORK AREA CONTENTS         *
*   DESCRIPTOR BYTE, THE CURRENT LAST FULL BUFFER IS SAVED.  CLOSE    *
*   POSTS THIS BUFFER TO THE MH, FLAGGING IT AS END OF MESSAGE.       *
*                                                                     *
*                                                                     *
*   WHEN WORKAREA IS EMPTY OR LCB IS ELEMENT, ECB IS POSTED           *
*   COMPLETE VIA CROSS MEMORY POST                                    *
*                                                                     *
*ENTRY POINT:                                                         *
*        IEDQEC                                                       *
*         PSTCB+2 - RCB IN AIB IS POSTED TO PUT-QCB                   *
*INPUT:                                                               *
*   1  - ADDRESS OF ERB, LCB OR SPECIAL ELEMENT                       *
*   1  - ADDRESS OF ERB, LCB, OR RCB IN AIB.                          *
*   11 - ADDRESS OF DISPATCHER                                        *
*   13 - ADDRESS OF REGISTER SAVEAREA                                 *
*   15 - ENTRY POINT ADDRESS                                          *
*OUTPUT:                                                              *
*   1  - ADDRESS OF ERB OR BUFFER                                     *
*   11 - SEE 'INPUT'                                                  *
*   13 - SEE 'INPUT'                                                  *
*EXTERNAL ROUTINES:                                                   *
*        DISPATCHER-IGG019RB(DSPPOSTR)                                *
*        DISPATCHER-IGG019RB(DSPLIFOR)                                *
*        AQCTL-SVC 102                                                *
*         OS POST - CROSS MEMORY                                      *
*         IEDQA1                                                      *
*EXITS-NORMAL:                                                        *
*        EXITS TO DISPATCHER(DSPCHAIN) TO POST ERB OR FULL BUFFER(S)  *
*        EXITS TO DISPATCHER(DSPPOST) TO POST A FULL BUFFER, OR TO    *
*   POST A SPECIAL ELEMENT TO THE OPEN/CLOSE SUBTASK                  *
*        EXITS TO DISPATCHER(DSPDISP) TO DISPATCH THE NEXT SUBTASK    *
*EXITS-ERROR:                                                         *
*         COMPLETION CODES OF:                                        *
*         X'54' - DESTINATION ERROR                                   *
*         X'5C' - THRESHOLD REACHED OR PUT IN PROGRESS                *
*         X'5E' - QUICK CLOSE                                         *
*TABLES/WORKAREAS:                                                    *
*        AVT                                                          *
*        LCB                                                          *
*        PROCESS ENTRY                                                *
*        PROCESS ENTRY WORKAREA                                       *
*        DEB                                                          *
*        PCB                                                          *
*         AIB                                                         *
*        SCB                                                          *
*        QCB                                                          *
*        DCB                                                          *
*ATTRIBUTES:REENTRANT,REFRESHABLE                                     *
*
*NOTES: THE OPERATION OF THIS MODULE DEPENDS UPON AN INTERNAL         *
*   REPRESENTATION OF THE EXTERNAL CHARACTER SET WHICH IS EQUIVALENT  *
*   TO THE ONE USED AT ASSEMBLY TIME.  THE CODING HAS BEEN ARRANGED   *
*   SO THAT REDEFINITION OF 'CHARACTER' CONSTANTS, BY REASSEMBLY,     *
*   WILL RESULT IN A CORRECT MODULE FOR THE NEW DEFINITIONS.          *
*                                                                     *
*                                                                     *
***********************************************************************
         EJECT
         SPACE
*                                                                     *
*           S Y M B O L I C    R E G I S T E R S                      *
*                                                                     *
         SPACE
RZERO    EQU   0                        GENERAL WORK REGISTER
RPARM    EQU   1                        PARAMETER REGISTER
*                                       AIB BASE REGISTER        Y02027
RCNT     EQU   2                        NUMBER OF BYTES IN BUFFER
RTEMP    EQU   3                        GENERAL WORK REGISTER
RNUM     EQU   4                        NUMBER OF BYTES TO BE MOVED
RUNIT    EQU   5                        ADDR OF CURRENT BUFFER UNIT
RWORK    EQU   6                        ADDRESS OF DATA IN WORKAREA
RBUF     EQU   7                        ADDR OF NEXT EMPTY BYTE
*                                       IN CURRENT BUFFER UNIT
RPEWA    EQU   8                        PROCESS ENTRY WORKAREA
RERB     EQU   9                        ELEMENT REQUEST BLOCK
RPCB     EQU   10                       PROCESS CONTROL BLOCK    Y02027
RDISP    EQU   11                       ADDRESS OF DISPATCHER
RBASE    EQU   12                       ADDRESS VECTOR TABLE
RAVT     EQU   13                       ADDRESS VECTOR TABLE(AVT)
RETURN   EQU   14                       RETURN ADDRESS
RBFR     EQU   15                       ADDR OF BUFFER PREFIX    Y01004
RENTRY   EQU   15                       ENTRY POINT ADDRESS
         SPACE 2
         USING *,RENTRY                 ESTABLISH ADDRESSABILITY Y01004
         B     PUTSCHED                 BRANCH TO PUT SCHEDULER  Y02027
         DS    F                        LINK FIELD OF QCB        Y02027
         DC    X'08'                    MCPL FOR LAST STCB       Y02027
         DC    AL3(PSTCB)               QCB STCB POINTER         Y02027
         DC    X'00000000'              PRIORITY AND LAST STCB   Y02027
*                                       INDICATOR                Y02027
IEDQEC   IEDHJN
PSTCB    DC    X'0400'                  PUT STCB                 Y02027
*                                                                Y02027
*              CODE EXECUTED AS RESULT OF ELEMENT POSTED TO      Y02027
*              PUT QCB                                           Y02027
*                                                                Y02027
         BALR  RBASE,RZERO              ESTABLISH ADDRESSABILITY Y02027
LABEL    EQU   *                                                 Y02027
         DROP  RENTRY                                            Y02027
         USING *,RBASE                  CSECT ADDRESSABILITY     Y02027
         EJECT
*                                                                     *
*      C O N T R O L   B L O C K   A D D R E S S A B I L I T Y        *
*                                                                     *
         SPACE
         USING IEDQDISP,RDISP           TCAM DISPATCHER
         USING IEDQPCB,RPCB             PROCESS CONTROL BLOCK (PCB)
         USING IEDQPEWA,RPEWA           PROCESS ENTRY WORKAREA (PEWA)
         USING AVTSAVE2,RAVT            AVT ADDRESSABILITY       Y02027
         USING LCBERB,RERB              ELEMENT(EMPTY BUFFER)
*                                       REQUEST BLOCK(ERB)
         USING IEDQPRF,RBFR             BUFFER PREFIX
         SPACE
         SH    RPARM,AVTHA16            BACK UP TO BEGINNING OF  Y02027
         USING IEDQAIB,RPARM            AIB FOR ADDRESSABILITY   Y02027
*                                                                Y02027
*              TEST FOR ABORT CONDITIONS                         Y02027
*                                                                Y02027
         L     RPEWA,AIBPPEWA           GET PEWA ADDRESS         Y02027
         L     RPCB,AIBPCBAD            GET PCB ADDRESS          Y02027
         LA    RENTRY,NOBFRS            SET RETURN CODE IF ERROR Y02027
         TM    AVTBIT3,THRESH           QUEUE THRESHOLD CONDITIONY02027
         BNZ   XMPOST1                  BRANCH IF YES            Y02027
         TM    PCBOFLG,PCBPIPN          PUT IN PROGRESS          Y02027
         BO    XMPOST1                  BRANCH IF YES            Y02027
*                                                                Y02027
*              CHECK DESTINATION OF MESSAGE                      Y02027
*                                                                Y02027
         L     RWORK,AIBWAPTR           GET ADDRESS OF WORKAREA  Y02027
         AH    RWORK,AIBMSTRT           ADD IN ANY PREFIX TO GET Y02027
*                                       TO MESSAGE START         Y02027
         LH    RNUM,AIBWASZE            GET SIZE OF WORK AREA    Y02027
         TM    AIBOPTCP,TNMEFLG         TERMNAME OF MSG. DEST.   Y02027
*                                       SPECIFIED IN WORKAREA    Y02027
         BZ    UPDATE                   BRANCH IF NO             Y02027
         LR    RTEMP,RPARM              SAVE AIB ADDRESS THRU    Y02027
*                                       BRANCH TO BINARY SEARCH  Y02027
         LR    RPARM,RWORK              LOAD ADDR OF TERMNAME    Y02027
*                                       IN REG 1                 Y02027
         LA    RZERO,EIGHT              LOAD MAXIMUM LENGTH      Y02027
         LA    RENTRY,ADDR(RPARM)       BUMP TO END            @ZA02061
NAMELOOP EQU   *                                               @ZA02061
         CLI   ZERO(RENTRY),BLANK       END OF NAME            @ZA02061
         BNE   NAMEEND                  YES, BRANCH            @ZA02061
         BCTR  RENTRY,0                 DECREMENT ADDRESS      @ZA02061
         BCT   RZERO,NAMELOOP           SEARCH AGAIN           @ZA02061
         LR    RENTRY,RZERO             CLEAR REG              @ZA02061
         LR    RPARM,RTEMP              RESTORE AIB ADDRESS    @ZA04005
         B     STDEST                   SET SOURCE TO ZERO     @ZA02061
NAMEEND  EQU   *                                               @ZA02061
         L     RENTRY,AVTMSGS-ONE       GET VCON TABLE ADDR      Y02027
         L     RENTRY,EIGHT(RENTRY)     LOAD ADDR OF IEDQA1      Y02027
         BAL   RETURN,FOUR(RENTRY)      BRANCH TO SEARCH ROUTINE Y02027
*                                       AT SECOND ENTRY POINT    Y02027
         LR    RPARM,RTEMP              RESTORE AIB ADDRESS      Y02027
         LTR   RENTRY,RENTRY            VALID TERMNAME           Y02027
         BNZ   STDEST                   BRANCH IF YES            Y02027
         LA    RENTRY,DEST              DEST ERROR CODE          Y02027
         B     XMPOST1                  EXIT TO IEDQEB           Y02027
STDEST   EQU   *                                                 Y02027
         STH   RENTRY,PEWAOFF           SAVE TERMNAME OFFSET     Y02027
         LA    RWORK,TRMLEN(RWORK)      ADDRESS OF BYTE FOLLOW-  Y02027
*                                       ING DESTINATION          Y02027
         LA    RENTRY,LENERR            ERROR COMPLETION CODE  @ZA04032
         SH    RNUM,TNAMEL              DECREMENT WORKAREA SIZE  Y02027
         BM    XMPOST1                  BRANCH IF NEGATIVE     @OY11959
UPDATE   EQU   *                                                 Y02027
         ST    RWORK,PEWAMOVE           SAVE ADDR OF DATA IN W.A.Y02027
         TM    AIBOPTCP,MSGFLG          IS WORK UNIT A MESSAGE   Y02027
         BO    NORDEL                   BRANCH IF YES            Y02027
         TM    AIBRECFP,VARFLG          VARIABLE OR UNDEFINED    Y02027
         BNO   NORDEL                   BRANCH IF NEITHER        Y02027
         L     RTEMP,PEWAPROC           PROCESS TERM ENTRY       Y02027
         CLI   TRMCHCIN-IEDQTRM(RTEMP),AVTEZERO RECDEL PRESENT   Y02027
         BE    NORDEL                   BRANCH IF NO             Y02027
         LA    RNUM,ONE(RNUM)           ADD 1 TO WORKAREA SIZE   Y02027
NORDEL   EQU   *                                                 Y02027
         STH   RNUM,PEWALREC            SET SIZE OF WORKAREA     Y02027
         CLM   RNUM,THREE,AVTFZERO      IS DATA TO MOVE          Y02027
         BNE   CKPTTEST                 BRANCH IF YES            Y02027
         SR    RENTRY,RENTRY            SET GOOD COMPLETION CODE Y02027
         TM    AIBOPTCP,CTLBYTE         CONTROL BYTE SPECIFIED   Y02027
         BNO   XMPOST1                  BRANCH IF NO             Y02027
         CLI   PEWACTL,EOMFLAG          LAST PORTION OF MESSAGE  Y02027
         BNE   XMPOST1                  BRANCH IF NO             Y02027
*                                                                Y02027
*              CHECK FOR ENVIRONMENT CHECK POINT TAKEN SINCE     Y02027
*              LAST PUT                                          Y02027
*                                                                Y02027
CKPTTEST EQU   *                                                 Y02027
         TM    AIBEXLFP,CKPTFLP         CHECKPOINT EXIT SPECIFIEDY02027
         BNO   SETNO                    BRANCH IF NO             Y02027
         TM    PCBOFLG,PCBCKPTN         CHECKPOINT ISSUE SINCE   Y02027
*                                       LAST HEADER              Y02027
         BNO   SETNO                    BRANCH IF NO             Y02027
         NI    PCBOFLG,PCBCKPTF         IF YES, TURN OFF FLAG    Y02027
         B     SETCTL                   BRANCH IF YES            Y02027
SETNO    MVI   AIBEXLFP,AVTEZERO        SET NO CHECKPOINT TAKEN  Y02027
*                                       IF AIBEXLFP=CKPTFG,      Y02027
*                                       EXLST EXIT IS TO BE TAKENY02027
*                                                                Y02027
*        SET SEQUENCE FLAG FOR SEGMENT OF MESSAGE                Y02027
*                                                                Y02027
SETCTL   EQU   *                                                 Y02027
         TM    AIBOPTCP,CTLBYTE         CONTROL BYTE SPECIFIED   Y02027
         BO    NEWPUT                   BRANCH IF YES            Y02027
         CLI   PEWACTL,AVTEZERO         FIELD INITIALIZED        Y02027
         BNE   NXTA                     BRANCH IF YES            Y02027
         MVI   PEWACTL,MESSAGE          SET COMPLETE MSG FLAG    Y02027
         TM    AIBOPTCP,MSGFLG          WORK UNIT A MESSAGE      Y02027
         BO    NEWPUT                   BRANCH IF YES            Y02027
         MVI   PEWACTL,HDRFLG           SET AS HEADER FIRST SEG  Y02027
         B     NEWPUT                   BRANCH TO CONTINUE       Y02027
NXTA     EQU   *                                                 Y02027
         TM    AIBOPTCP,MSGFLG          WORK UNIT A MESSAGE      Y02027
         BO    NEWPUT                   BRANCH IF YES            Y02027
         MVI   PEWACTL,ISEGFLAG         SET INTERMEDIATE SEGMENT Y02027
         EJECT                                                   Y02027
NEWPUT   EQU   *                                                 Y02027
         OI    PCBOFLG,PCBPIPN          SET PUT IN PROGRESS      A50196
         LA    RERB,PEERB               ADDRESS OF ELEMENT REQUEST
*                                       BLOCK FROM PROCESS ENTRY
*                                       WORKAREA
         TM    PEWAFLG,PBUF             PART-EMPTY BUFFER TO FILL
         BO    SETUP                    BRANCH IF YES
         CLM   RNUM,HALF,AVTFZERO       IS THIS A NO-DATA OPERA- Y01004
*                                       TION (WORKAREA SIZE = 0) Y01004
         BE    SETUP                    BRANCH IF YES          @YA10439
         B     BUFSAVE                  BRANCH IF DATA OPERATION Y02027
SETUP    EQU   *
         NI    PEWAFLG,AVTEFF-PBUF      SET NOT PARTIAL BUFFER
         L     RBFR,PERAQCB             BUFFER PREFIX ADDRESS
         LTR   RBFR,RBFR                IS 1ST PUT 0 LENGTH    @OX12583
         BZ    CLEANX                   BR YES, POST A.P.      @OX12583
         XC    PERAQCB(4),PERAQCB
         L     RBUF,PEWACBUF            ADDR OF FIRST EMPTY BYTE Y02027
         L     RPARM,PEWATIC            ADDR OF CURRENT UNIT
         LH    RCNT,PRFSIZE             INITIALIZE COUNTER
         L     RTEMP,PRFLCB-1           LCB ADDRESS
*                                                                     *
*        INITIALIZE LCB FOR USE AFTER BUFFER ENTERS MESSAGE HANDLER   *
*                                                                     *
         LA    RZERO,PEWASCB
         ST    RZERO,LCBSCBDA-1-IEDQLCB(0,RTEMP) SCB DIRECTORY ADDR
         ST    RZERO,LCBSCBA-1-IEDQLCB(0,RTEMP)
         MVI   LCBSTAT1-IEDQLCB(RTEMP),LCBRECVN SET RECIEVE SWITCH
         OI    LCBERBST-IEDQLCB(RTEMP),LCBDLNKN
         MVI   LCBRSKEY-IEDQLCB(RTEMP),PSVTO PUT SCHEDULER MCPL
         MVC   LCBISZE-IEDQLCB(1,RTEMP),PCBRSERH RESERVE CNT TO LCB
         MVC   LCBTTCIN-IEDQLCB(2,RTEMP),PRFSRCE TNT OFFSET
         ST    RPEWA,LCBERCCW-IEDQLCB(RTEMP)
         L     RZERO,PEWAQCBL           END OF THIS UNIT         Y02027
         SR    RZERO,RBUF               NUMBER OF EMPTY BYTES LEFT
         CLC   PEWALREC(2),AVTFZERO     SPECIAL NO-DATA EOM CASE Y02027
         BNE   MOVE                     BRANCH IF NO
         NI    PRFSTAT1,AVTEFF-PRFNLSTN FLAG BUFFER AS EOM
         B     POSTBUF                  POST BUFFER TO MH
         EJECT
PUTSCHED EQU   *                                                 Y02027
         LA    RBASE,LABEL-IEDQEC(RENTRY) SCHED ADDRESSABILITY   Y02027
         CLI   LCBRSKEY-IEDQLCB(RPARM),PSVTO LCB
         BNE   NOTLCB                   BRANCH IF NO           @XA11307
         CLI   LCBPRI-IEDQLCB(RPARM),DELAYPRI   LCB CAME       @XA11307
*                                         OFF OF TIME DELAY    @XA11307
         BNE   CLEANUP                  BRANCH IF NO           @XA11307
         MVI   LCBPRI-IEDQLCB(RPARM),RESETPRI NOT DELY PRIORITY@XA11307
         MVI   LCBSTAT1-IEDQLCB(RPARM),LCBRECVN  SET RECEIVE   @XA11307
*                                        SWITCH                @XA11307
         L     RPEWA,LCBERCCW-IEDQLCB(,RPARM) RESTORE PEWA ADDR@XA11307
         L     RPCB,PEPCBAD             PCB ADDRESS            @VS41903
         L     RWORK,PEWANEB            RESTORE DATA ADDRESS   @VS41903
         LH    RNUM,PEWALREC            DATA LEFT IN WORKAREA  @VS41093
         B     NEWPUT                                          @XA11307
NOTLCB   EQU   *                                               @XA11307
         LR    RERB,RPARM               ERB ADDRESSABILITY       Y02027
         LA    RPCB,PEERB-IEDQPEWA      GET OFFSET TO PEWA       Y02027
         LR    RPEWA,RERB               GET ADDR OF ERB IN PEWA  Y02027
         SR    RPEWA,RPCB               COMPUTE PEWA ADDRESS     Y02027
         L     RPCB,PEPCBAD             PCB ADDRESSABILITY       Y02027
         L     RWORK,PEWANEB            RESTORE ADDR OF DATA     Y02027
         LH    RNUM,PEWALREC            DATA LEFT IN WORKAREA    Y02027
         B     NEXTBUFX                 BRANCH FOR ERB           Y02027
*                                                                Y02027
*        PICK UP AND POST BUFFER SAVED FROM LAST OPERATION       Y02027
*                                                                Y02027
BUFSAVE  EQU   *                                                 Y02027
         ICM   RBFR,ALL,PERAQCB         ADDRESS OF SAVED BUFFER  Y02027
         BZ    NEXTBUFX                 BRANCH IF NO BUFFER TO   Y02027
*                                       POST                     Y02027
         XC    PERAQCB,PERAQCB          CLEAR ADDR OF PARTIAL    Y02027
*                                       BUFFER                   Y02027
         L     RTEMP,PRFLCB-ONE         GET LCB ADDRESS          Y02027
         MVC   LCBTTCIN-IEDQLCB(2,RTEMP),PRFSRCE GET SRCE OFFSET Y02027
         LA    RZERO,PEWASCB            SCB ADDRESS              Y02027
         ST    RZERO,LCBSCBA-ONE-IEDQLCB(RTEMP) STORE IN LCB     Y02027
NEXTBUF  EQU   *
         MVC   LCBERBCH(3),PRFLINK      REMOVE BFR FROM ERB CHAIN
         XC    PRFLINK,PRFLINK          SET LINK FIELD TO ZERO
*                                                                     *
*              FLAG THE LAST UNIT OF BUFFER BY STORING INVALID        *
*              TIC ADDRESS IN ITS TIC FIELD.                          *
*                                                                     *
SETFLAG  EQU     *
         L     RPARM,PEWATIC            ADDR OF CURRENT BFR UNIT
TICX     EQU   *
         NC    9(2,RPARM),9(RPARM)      LAST UNIT IN BUFFER
         BZ    TICIT                    BRANCH IF YES
         L     RPARM,8(0,RPARM)         GET ADDR OF NEXT UNIT
         B     TICX                     GO CHECK FOR LAST UNIT
TICIT    EQU   *
         MVI   11(RPARM),INVTIC         INVALID TIC ADDRESS
         LR    RPARM,RBFR               BUFFER PREFIX ADDRESS
         BAL    RETURN,DSPPOSTR         POST FULL BUFFER
         XC    PERAQCB(4),PERAQCB       CLEAR CURRENT BFR ADDR
         L     RPCB,PEPCBAD             RESTORE PCB ADDRESS
NEXTBUFX EQU   *
         ICM   RBFR,ADDR,LCBERBCH       ADDRESS OF NEXT EMPTY    Y01004
*                                       BUFFER.                  Y01004
         BZ    ERB                      IF NO EMPTY BUFFERS ARE  Y01004
*                                       LEFT, BRANCH TO GET MORE Y01004
*                                                                     *
*              INITIALIZE BUFFER PREFIX                               *
*                                                                     *
BUFINIT  EQU   *
         MVI   PRFSTAT1,PRFNHDRN
         LA    RCNT,PRFSTXT-PRFSUNIT    HEADER PREFIX LENGTH   @YA04914
         MVI   PRFPRI,PRIAPBFR          SET BUFFER PRIORITY
         MVI   PRFTIC,TIC               SET UP TIC FIELD
         LA    RBUF,PRFSTXT             START OF TEXT LABEL
         C     RWORK,PEWAMOVE           IS THIS THE BEGINNING OF Y02027
*                                       A NEW WORKAREA
         BNE   GO                       BRANCH IF NOT TO AVOID
*                                       TESTING FOR HEADER
         MVI   PRFSTAT1,AVTEZERO        INIT BFR STATUS FIELD
         TM    PEWACTL,HDRFLG           HEADER SEGMENT           Y02027
         BO    PUTTEST                  BRANCH IF YES          @XA11307
         OI    PRFSTAT1,PRFNHDRN        SET NOT-HEADER FLAG IN
*                                       BUFFER PREFIX
         B     GO                       BRANCH TO INITIALIZE LCB S21903
*                                       AND BUFFER PREFIX.       S21903
         SPACE 2                                               @XA11307
***************************************************************@XA11307
*                                                             *@XA11307
*                                                             *@XA11307
*  THIS CODE CONTROLS THE PROLIFIC PUTER.  THE USER SPECIFIES *@XA11307
*  A MAXIMUM NUMBER OF PUT'S (STORED IN PCBPACE) AND A TIME   *@XA11307
*  DELAY IN SECONDS (STORED IN PCBDELAY).  THUS AFTER THE     *@XA11307
*  SPECIFIED NUMBER OF PUT'S HAVE BEEN PROCESSED, A SPECIAL   *@XA11307
*  PRIORITY (X'D6') IS SET IN LCBPRI AND THE PUT LCB IS       *@XA11307
*  POSTED TO THE TIME DELAY SUBTASK.  AFTER THE REQUIRED DELAY*@XA11307
*  THE PUT LCB IS POSTED TO ITSELF BY TIME DELAY.             *@XA11307
*                                                             *@XA11307
*                                                             *@XA11307
***************************************************************@XA11307
PUTTEST  EQU   *                                               @XA11307
         NC    PCBPACE(TWO),PCBPACE     HAS USER SPECIFIED MAX @XA11307
*                                        NUMBER OF PUTS        @XA11307
         BZ    CLOSTST                  BRANCH IF NO           @XA11307
         NC    PCBDELAY(TWO),PCBDELAY   HAS USER SPECIFIED A   @XA11307
*                                        TIME DELAY            @XA11307
         BZ    CLOSTST                  BRANCH IF NO           @XA11307
         LH    RTEMP,PCBCNT             GET PUT COUNT          @XA11307
         LA    RTEMP,ONE(,RTEMP)        INCREMENT PUT COUNT    @XA11307
         STH   RTEMP,PCBCNT             RESET PUT COUNT        @XA11307
         CH    RTEMP,PCBPACE            HAS MAX NUMBER OF PUTS @XA11307
*                                        BEEN PROCESSED        @XA11307
         BNH   CLOSTST                  BRANCH IF NO           @XA11307
         XC    PCBCNT,PCBCNT            RESET PUT COUNT FOR    @XA11307
*                                        NEXT TIME DELAY       @XA11307
         L     RPARM,PCBLCBAD           GET LCB ADDRESS IN REG1@XA11307
*                                        FOR TIME DELAY ROUTINE@XA11307
         MVI   LCBPRI-IEDQLCB(RPARM),DELAYPRI  PRIORITY TO     @XA11307
*                                        SIGNAL TIME DELAY     @XA11307
         LA    RTEMP,AVTDELYB           TIME DELAY QUEUE       @XA11307
         ST    RTEMP,LCBQCBA-1-IEDQLCB(,RPARM)  FOR POST       @XA11307
         LA    RTEMP,LCBSTCBA-1-IEDQLCB(,RPARM) SET UP STCB TO @XA11307
         ST    RTEMP,LCBSTCBA-1-IEDQLCB(,RPARM) POINT TO ITSELF@XA11307
         MVI   LCBSTAT1-IEDQLCB(RPARM),LCBFREEN  SET LCB AS    @XA11307
*                                        FREE FOR TIME DELAY   @XA11307
         MVI   LCBRSKEY-IEDQLCB(RPARM),ENTRYFLG SET FLAG FOR   @XA11307
*                                        ENTRY AFTER DELAY     @XA11307
         MVC   LCBEOLTD-IEDQLCB(TWO,RPARM),PCBDELAY            @XA11307
*                                        TIME DELAY PARAMETER  @XA11307
         MVI   LCBTDL-IEDQLCB(RPARM),OFFSET INDEX FOR DELAY    @XA11307
         ST    RWORK,PEWANEB            SAVE ADDR OF NEXT BYTE @OZ26689
*                                       OF DATA IN WORK AREA   @OZ26689
         ST    RPARM,LCBCHAIN-IEDQLCB(,RPARM) QCB ADDESS       @XA11307
         ST    RPEWA,LCBERCCW-IEDQLCB(,RPARM) SAVE PEWA ADDRESS@XA11307
         NI    PCBOFLG,PIPOFF           TURN OFF PUT IN        @VS41517
*                                        PROGRESS BIT          @XA11307
         BAL   RETURN,DSPPOST           BRANCH TO TIME DELAY   @XA11307
CLOSTST  EQU   *
         TM    AVTBIT1,AVTCLOSN+AVTQUCKN CLOSEDOWN IN PROGRESS
         BNO   GO                       BRANCH IF NO
         OI    PERCQCB+3,PBUF           SET ERROR FLAG
         LA    RENTRY,QUICKC            SET CONDITION CODE       Y02027
         B     ERREXIT                  POST A.P. ECB            Y02027
         EJECT
GO       EQU   *
*                                                                     *
*        INITIALIZE LCB AND BUFFER PREFIX                             *
*                                                                     *
         MVC   PRFLCB(3),PCBLCBAD+1     PUT ADDRESS OF SOURCE LCB
*                                       INTO BUFFER PREFIX
         L     RPARM,PRFLCB-1           LCB ADDRESS
         MVI   LCBSTAT1-IEDQLCB(RPARM),LCBRECVN SET RECIEVE SWITCH
         OI    LCBERBST-IEDQLCB(RPARM),LCBDLNKN
         MVI   LCBRSKEY-IEDQLCB(RPARM),PSVTO PUT SCHEDULER MCPL
         LA    RZERO,PEWASCB            SOURCE SCB ADDRESS
         ST    RZERO,LCBSCBA-1-IEDQLCB(RPARM) STORE IT IN LCB
         ST    RZERO,LCBSCBDA-1-IEDQLCB(0,RPARM)
         ST    RPEWA,LCBERCCW-IEDQLCB(RPARM) SAVE PEWA ADDRESS
         MVC   PRFQCBA(3),PCBMH         ADDRESS OF MESSAGE HANDLER
*                                       TO PROCESS THIS BUFFER
         MVC   PRFSRCE(2),PEWAPETO      MOVE TERMNAME TABLE OFSETY02027
*                                       OF PUT PROCESS ENTRY INTO
*                                       SOURCE FIELD IN BFR PREFIX
         MVC   LCBTTCIN-IEDQLCB(2,RPARM),PRFSRCE  TNT OFFSET   @YA07129
         TM    PRFSTAT1,PRFNHDRN        HEADER BUFFER
         BO    STARTY                   BRANCH IF NO
         MVC   LCBISZE-IEDQLCB(1,RPARM),PCBRSERH HEADER RESERVE@YA04914
         LA    RBUF,PRFSHDR             START OF HEADER LABEL
         LA    RCNT,PRFSHDR-PRFSUNIT    HEADER PREFIX LENGTH   @YA04914
         MVC   PRFDEST(2),PEWAOFF       MOVE DESTINATION OFFSET  Y02027
*                                       TO TERMNAME TABLE FROM
*                                       PUT/WRITE WORKAREA INTO
*                                       BUFFER PREFIX
         NC    PRFDEST(2),PRFDEST       DESTINATION OFFSET VALID
         BZ    STARTY                   BRANCH IF NOT TO BYPASS
*                                       LOCK MODE FUNCTIONS
         L     RPARM,PCBLCBAD           APPL PROG LCB ADDRESS
         NC    LCBINCAM-IEDQLCB(2,RPARM),LCBINCAM-IEDQLCB(RPARM)
*                                       OUTSTANDING LOCK RESPONSE
         BZ    STARTY                   BRANCH IF NO
         ST    RWORK,PEWANEB            SAVE ADDR OF NEXT BYTE OFY02027
*                                       DATA IN W.A. TO BE MOVED Y02027
         ST    RBUF,PEWAPEUN            SAVE ADDR OF DATA IN BUF.Y02027
         ST    RENTRY,PEWASAVE          SAVE BUFFER ADDR         Y02027
         ST    RERB,PEWASAVE+4          SAVE ERB ADDR            Y02027
*                                                                Y02027
* REGISTERS 2,4, AND 8 MUST NOT BE CHANGED OR MUST BE SAVED AND  Y02027
* RESTORED IN PEWASAVE BEFORE GOING TO START.                    Y02027
*
         EJECT
*                                                                     *
*      TEST TO SEE IF MESSAGE DESTINATION IS IN LOCK MODE             *
*                                                                     *
         SR    RPARM,RPARM              CLEAR WORK REGISTER TO ZERO
         LH    RPARM,PEWAOFF            DESTINATION OFFSET       Y02027
         N     RPARM,AVTCLRHI           CLEAR HIGH-ORDER HALF
         L     RENTRY,AVTRNMPT          ADDRESS OF OFFSET
*                                       CONVERSION LOGIC
         BALR  RETURN,RENTRY            CONVERT OFFSET TO TERMINAL
*                                       TABLE ENTRY ADDRESS
         LR    RTEMP,RPARM              SAVE ENTRY ADDRESS     @Z30X8AM
         TM    TRMSTATE-IEDQTRM(RPARM),SINGLE VALID TERM ENTRY
         BNZ   START                    BRANCH IF NO
         L     RPARM,TRMDESTQ-1-IEDQTRM(0,RPARM) GET ADDRESS OF
*                                       DEST QCB FROM TERM ENTRY
         LR    RUNIT,RPARM              SAVE DEST QCB ADDRESS    Y02027
         L     RPARM,QCBDCBAD-1-IEDQQCB(0,RPARM) GET ADDRESS OF
*                                       DCB FROM DEST QCB
*                                       VTAM TERMINAL            X03039
         TM    DCBOFLGS-IHADCB(RPARM),DCBOPEN  IS DCB OPENED
         BNO   START                    BRANCH IF NO
         TM    TRMSTATE-IEDQTRM(RTEMP),TRMPREF VTAM TERMINAL   @G36XRAW
         BNO   NOT3705                  BR NO                  @G36XRAW
         LR    RPARM,RUNIT              RESTORE OCB ADDRESS      Y02027
         SH    RPARM,QCBHDRSZ           BACKUP TO RN PREFIX    @ZM47936
         ICM   RPARM,ALL,QCBPLCBA-ONE-IEDNQCB(RPARM) PLCB ADDR   Y02027
         BNM   START                    BRANCH IF POSITIVE - NO  S22024
*                                       PLCB ASSIGNED            S22024
         B     LCBLOOP                  BRANCH TO LCBLOOP        S22024
NOT3705  EQU   *                                                 S22024
         SR    RERB,RERB                CLEAR COUNTER TO ZERO    Y02027
         ICM   RERB,ONE,QCBLKRLN-IEDQQCB(RUNIT) GET LOCK         Y02027
*                                       RELATIVE LINE NUMBER.    Y01004
         BZ    START                    BRANCH IF TERMINAL IS   SA52508
*                                       NOT LOCKED.             SA52508
         SR    RZERO,RZERO              CLEAR REG TO ZERO
         LA    RZERO,LCBFLAG1-IEDQLCB
         SR    RBUF,RBUF                CLEAR REG TO ZERO        Y02027
         IC    RBUF,DCBEIOBX-IHADCB(RPARM) LCB LENGTH            Y02027
         L     RPARM,DCBIOBAD-IHADCB(0,RPARM)  GET ADDRESS OF
*                                       IOB FROM DCB
         SR    RPARM,RZERO              ADDR OF DUMMY LCB
         MR    RBUF-ONE,RERB            COMPUTE LCB DISPLACEMENT Y02027
         AR    RPARM,RBUF               ADDR OF LCB              Y02027
LCBLOOP  EQU   *                                                 Y02027
         CLC   LCBTTCIN-IEDQLCB(2,RPARM),PEWAOFF  LCB FOR MESSAGEY02027
*                                       DESTINATION              Y02027
         BNE   START                    BRANCH IF NO
         EJECT
*                                                                     *
*        INSURE THAT CURRENT MESSAGE IS CORRECT RESPONSE              *
*                                                                     *
         LR    RZERO,RPARM              SAVE LCB ADDRESS
         L     RPARM,LCBSCBA-1-IEDQLCB(0,RPARM) GET ADDRESS OF
*                                       SCB FROM LCB
         TM    SCBSTATE-IEDQSCB(RPARM),SCBLCK1N+SCBMSGLN  LOCK MODE
         BZ    START                    BRANCH IF NO
         LR    RPARM,RZERO              RESTORE LCB ADDRESS
         L     RPARM,LCBINSRC-1-IEDQLCB(0,RPARM) INQUIRY DEST OFFSET
         SRL   RPARM,8
         N     RPARM,AVTCLRHI           CLEAR HIGH-ORDER HALFWORD
         LTR   RPARM,RPARM              LINE NOT LOCKED
         BZ    START                    BRANCH IF NO
         LR    RTEMP,RZERO              SAVE SOURCE LCB ADDRESS  Y02027
         L     RENTRY,AVTRNMPT          TNT OFFSET CONVERTER
         BALR  RETURN,RENTRY            GET TERM ENTRY ADDRESS
         L     RPARM,TRMDESTQ-1-IEDQTRM(0,RPARM) DEST QCB ADDRESS
         CLC QCBDCBAD-IEDQQCB(3,RPARM),PEPCBAD+ONE PCB'S EQUAL   Y02027
         BNE   START                    BRANCH IF NO
         LR    RZERO,RTEMP              RESTORE SOURCE LCB ADDR  Y02027
         L     RPARM,LCBSCBA-ONE-IEDQLCB(RTEMP) GET ADDRESS OF   Y02027
*                                       SCB FROM LCB             Y02027
         TM    LCBINSRC+2-IEDQLCB(RTEMP),LOCKR   LINE DUE A RESPONSE
         BNO   START                    BRANCH IF NO
         NI    LCBINSRC+2-IEDQLCB(RTEMP),AVTEFF-LOCKR
         LA    RTEMP,PEWASCB            SOURCE SCB
         MVC   SCBSTATE-IEDQSCB(1,RTEMP),SCBSTATE-IEDQSCB(RPARM)
*                                       COPY LOCK FLAGS TO SOURCE SCB
         NI    SCBSTATE-IEDQSCB(RTEMP),SCBLCK1N+SCBMSGLN
         LR    RPARM,RZERO              ADDRESS OF SOURCE LCB
         L     RPCB,PEPCBAD             RESTORE PCB ADDRESS      Y02027
         L     RTEMP,PCBLCBAD           APPL PROG LCB ADDRESS
         LH    RETURN,LCBINCAM-IEDQLCB(0,RTEMP)  LOCK RESPONSE COUNT
         BCTR  RETURN,0                 DECREMENT COUNT BY ONE
         STH   RETURN,LCBINCAM-IEDQLCB(0,RTEMP)  NEW RESPONSE COUNT
         TM    QCBSLINK+TWO-IEDQQCB(RUNIT),RELEASE  RELEASE IN   Y02027
*                                       EFFECT                   Y02027
         BO    START                    BRANCH IF YES
         TM    QCBINSRC+2-IEDQQCB(RUNIT),QCBDELAY              @ZA03747
*                                       QCB IN TIME DELAY QUEUE OX02215
         BNO   NOTIMQ                   BRANCH IF NO            OX02215
         LR    RTEMP,RPARM              SAVE LCB ADDRESS        OX02215
         LR    RPARM,RUNIT              GET QCB ADDRESS        @ZA03747
         L     RENTRY,AVTHG02           ADDRESS OF TIME DELAY   OX02215
*                                       REMOVAL ROUTINE         OX02215
         BALR  RETURN,RENTRY            REMOVE QCB FROM TDQ     OX02215
         LR    RPARM,RTEMP              RESTORE LCB ADDRESS     OX02215
         LA    RETURN,QCBSTVTO-IEDQQCB(,RUNIT) ADDRESS OF SEND @ZA03747
*                                        SCHEDULER STCB        @ZA03747
         MVC   QCBSLINK-IEDQQCB(3,RUNIT),QCBSTCHN-IEDQQCB(RUNIT)
         STCM  RETURN,ADDR,QCBSTCHN-IEDQQCB(RUNIT)             @ZA03747
*                                       PUT SEND SCHEDULER BACK OX02215
*                                       INTO THE QCB            OX02215
NOTIMQ   EQU   *                                                OX02215
*                                                                     *
*        FIND SEND SCHEDULER AND INSERT IT'S STCB IN LCB              *
*                                                                     *
         L     RTEMP,QCBSTVTO-IEDQQCB(RUNIT) ADDR OF TOP STCB    Y02027
         LA    RTEMP,0(0,RTEMP)         CLEAR HIGH-ORDER BYTE
         LA    RZERO,QCBSTVTO-IEDQQCB(RUNIT) ADDR OF STCB        Y02027
         LA    RBUF,LCBSTCBA-1-IEDQLCB(0,RPARM) STCB CHAIN ADDR
         CR    RTEMP,RZERO              SEND SCHED ON DEST QCB
         BNE   STCBOUT                  BRANCH IF NO
         MVC   QCBSTCHN-IEDQQCB(3,RUNIT),QCBSLINK-IEDQQCB(RUNIT) Y02027
*                                       REMOVE SEND SCHED FROM CHAIN
         LR    RPARM,RZERO              SEND SCHEDULER ADDRESS
INSERT   EQU   *
         BAL   RETURN,DSPLIFOR          PUT SEND SCHEDULER ON TOP
         B     START                    RETURN TO MAINLINE CODE
STCBOUT  EQU   *
         LA    RETURN,NOPLCBS           SET FOR POSSIBLE SCAN  @SA72774
         CLI   LCBFLAG1-IEDQLCB(RPARM),AVTEZERO PLCB             S22024
         BE    STCBOUTX                 BRANCH YES - USE COMMON  S22024
*                                       CODE                     S22024
         TM    LCBSTAT2-IEDQLCB(RPARM),LCBDIAL DIAL LINE
         BO    DIAL                     BRANCH IF YES
STCBOUTX EQU   *
         L     RTEMP,LCBSTCBA-1-IEDQLCB(0,RPARM) TOP STCB IN LCB
         LA    RWORK,4(0,RPARM)         SIMULATE FIRST ELEMENT
STCBLOOP EQU   *
         LA    RTEMP,0(0,RTEMP)         CLEAR HIGH-ORDER BYTE
         CR    RTEMP,RZERO              DESIRED SEND SCHED STCB
         BE    DELINK                   BRANCH IF YES
         CLI   4(RTEMP),AVTEZERO        END OF STCB CHAIN       SA52991
         BCR   AVTECD8,RETURN           BRANCH IF YES           SA52991
         LR    RWORK,RTEMP
         L     RTEMP,4(0,RTEMP)         ADDR OF NEXT STCB
         B     STCBLOOP                 GET NEXT STCB
DELINK   EQU   *
         MVC   5(3,RWORK),5(RTEMP)      DELINK STCB
         LR    RPARM,RTEMP              DISP PARM REG
         B     INSERT                   PUT STCB ON TOP OF CHAIN
         EJECT                                                 @SA72774
NOPLCBS  EQU   *                                               @SA72774
         SPACE 1                                               @SA72774
* THIS SUBROUTINE SETS UP PARAMETERS NEEDED TO SCAN THE  *     @SA72774
* 'NO-PLCBS' CHAIN FOR THE SEND SCHEDULER IF IT IS NOT   *     @SA72774
* ALREADY IN THE PLCB.                                   *     @SA72774
         SPACE 2                                               @SA72774
         L     RWORK,AVTSAVTP           SECONDARY AVT ADDRESS  @SA72774
         L     RWORK,SAVTPLCB-IEDNSVTD(,RWORK)                 @SA72774
*                                       PLCB RETURN QCB ADDRESS@SA72774
         L     RTEMP,FOUR(,RWORK)       FIRST ELEMENT ON QUEUE @SA72774
         B     STCBLOOP                 GO SCAN 'NO-PLCB' CHAIN@SA72774
         EJECT
DIAL     EQU   *
         TM    QCBTSOF1-IEDQQCB(RUNIT),QCBDELAY QCB IN TIME DELAYY02027
         BNO   DIALQ                    BRANCH IF NO
         LR    RPARM,RZERO              STCB ADDRESS
         B     INSERT                   BRANCH TO INSERT         S21903
*                             SEND SCHEDULER'S STCB IN LCB CHAIN S21903
DIALQ    EQU   *
         L     RWORK,QCBDCBAD-ONE-IEDQQCB(RUNIT) DCB ADDR        Y02027
         SR    RTEMP,RTEMP              CLEAR REGISTER TO ZERO
         IC    RTEMP,DCBEIOBX-IHADCB(0,RWORK)   LCB SIZE
         L     RWORK,DCBIOBAD-IHADCB(0,RWORK) IOB ADDRESS
         LA    RWORK,0(0,RWORK)         CLEAR HIGH-ORDER BYTE
         LA    RETURN,LCBFLAG1-IEDQLCB+8 OFFSET TO DIALOUT QUEUE
         SR    RWORK,RETURN             ADDR OF DIALOUT CALL Q
         AR    RWORK,RTEMP              ACTUAL LCB ADDRESS
DCQLOOP  EQU   *
         L     RTEMP,4(0,RWORK)         ADDR OF STCB ON D.C. Q
         CLI   4(RTEMP),0               END OF D.C. QUEUE
         BE    SCANALL                  BRANCH IF YES           SA52991
         LA    RTEMP,0(0,RTEMP)         CLEAR HIGH-ORDER BYTE
         CR    RZERO,RTEMP              DEST SCHED STCB FOUND
         BE    DELINK                   BRANCH IF YES
         LR    RWORK,RTEMP              SAVE TOP STCB ADDR
         B     DCQLOOP                  GO TEST NEXT STCB
         EJECT
SCANALL  EQU   *                                                SA52991
*                                                               SA52991
*        FIND DEST QCB FOR LOCKED TERMINAL BY SCANNING THE      SA52991
*        STCB CHAIN FOR EACH LCB IN LINE GROUP.                 SA52991
*                                                               SA52991
         SPACE
         SR    RPCB,RPCB                CLEAR REGISTER           Y02027
         L     RWORK,QCBDCBAD-ONE-IEDQQCB(RUNIT) DCB ADDRESS     Y02027
         L     RERB,DCBDEBAD-IHADCB(RWORK)  ADDRESS OF DEB       Y02027
         IC    RPCB,DEBNMEXT(RERB)      NUMBER OF LCBS IN GROUP  Y02027
         L     RPARM,DCBIOBAD-IHADCB(RWORK)  IOB ADDRESS         Y02027
         LA    RERB,LCBFLAG1-IEDQLCB    OFFSET FROM LCB TO IOB   Y02027
         SR    RPARM,RERB               ADDR OF DUMMY LCB        Y02027
         IC    RERB,DCBEIOBX-IHADCB(RWORK) SIZE OF LCB           Y02027
RLNLOOP  EQU   *                                                 Y02027
         AR    RPARM,RERB               FIRST OR NEXT LCB        Y02027
         BAL   RETURN,STCBOUTX          CHAIN STCB               Y02027
         BCT   RPCB,RLNLOOP             BRANCH- LOOK AT NEXT LCB Y02027
*                                       LOCK NOT FOUND           Y02027
         EJECT
START    EQU   *                                                 Y02027
         L     RERB,PEWASAVE+4          RESTORE ERB ADDR         Y02027
         L     RWORK,PEWANEB            RESTORE WORKAREA ADDRESS Y02027
         L     RBUF,PEWAPEUN            RESTORE ADDR OF DATA IN  Y02027
*                                       BUFFER                   Y02027
         L     RENTRY,PEWASAVE          RESTORE BUFFER ADDR      Y02027
STARTY   EQU   *
         LR    RPARM,RBFR               ADDRESS OF FIRST BUFFER UNIT
*                                       LINK FIELD
         ST    RPARM,PEWATIC            SAVE CURRENT UNIT ADDR
         MVI   PEWATIC,PSVTO
*                                                                     *
*        COMPUTE BUFFER SIZE, UNIT SIZE, AND UNITS PER BUFFER         *
*                                                                     *
         LA    RZERO,PRFSUNIT           START OF BUFFER AFTER UMA
         CLC   AVTKEYLE(2),PEWASOWA     FULL UNITS WANTED
         BNH   LESS                     BRANCH IF YES
         AH    RZERO,PEWASOWA           EMPTY BYTE COUNT
         B     CONT                     BRANCH TO                S21903
*                                       SET-END-OF-UNIT ADDR     S21903
LESS     EQU   *
         AH    RZERO,AVTKEYLE           ADDRESS OF END OF BUFFER
CONT     EQU   *
         ST    RZERO,PEWAQCBL           ADDR OF END OF THIS UNIT Y02027
         SR    RZERO,RBUF               SIZE OF DATA FIELD IN BFR
*                                                                     *
*              ALLOW SPACE IN BUFFER FOR RESERVE CHARACTERS           *
*                                                                     *
         L     RPCB,PEPCBAD             RESTORE PCB ADDRESS
         SR    RTEMP,RTEMP              CLEAR COUNTER
         TM    PRFSTAT1,PRFNHDRN        HEADER BUFFER
         BO    TEXTBFR                  BRANCH IF NO
         ICM   RTEMP,ONE,PCBRSERH       RESERVE CHARACTER COUNT. Y01004
         BZ    MOVE                     BRANCH IF NO RESERVE     Y01004
*                                       CHARACTERS FOR HEADER.   Y01004
         B     BUMPER                   BUMP POINTER & COUNTER
TEXTBFR  EQU   *
         ICM   RTEMP,ONE,PCBRSERT       RESERVE CHARACTER COUNT. Y01004
         BZ    MOVE                     BRANCH IF NO RESERVE     Y01004
*                                       CHARACTERS FOR TEXT.     Y01004
BUMPER   EQU   *
         AR    RBUF,RTEMP               BUMP PAST RESERVE CHARS
         AR    RCNT,RTEMP               ADD RESERVE CHAR COUNT
         SR    RZERO,RTEMP              SUBTRACT RESERVE COUNT
         EJECT
*                                                                     *
*        MOVE DATA FROM USER'S WORKAREA TO THE MCP BUFFER             *
*
         SPACE
MOVE     EQU   *
         LR    RTEMP,RZERO              SIZE OF DATA FIELD IN BFR
         CR    RTEMP,RNUM               MORE THAN ONE UNIT      OY00458
         BNH   MOVE1                    BRANCH IF NO            OY00458
         LR    RTEMP,RNUM               SET SMALLER COUNT       OY00458
MOVE1    EQU   *                                                OY00458
         BCTR  RTEMP,RZERO              DECREMENT COUNT BY ONE
         EX    RTEMP,MOVER              FILL THE BUFFER
         CR    RNUM,RZERO               WORKAREA EMPTY
         BH    NEXT                     BRANCH IF NO
*                                                                Y02027
*        WORKAREA IS EMPTY - PREPARE TO RETURN                   Y02027
*                                                                Y02027
         AR    RCNT,RNUM                INCREMENT COUNTER OF BYTES
*                                       MOVED INTO BUFFER
         AR    RBUF,RNUM                ADDR OF NEXT EMPTY BYTE
         STH   RCNT,PRFSIZE             STORE BYTE COUNT IN PREFIX
         TM    PEWAOPTC,MSGFLG          IS WORK UNIT A MESSAGE   Y02027
         BO    NORECDEL                 BRANCH IF YES            Y02027
         TM    PEWAGSW,VARFLG           VARIABLE FORMAT          Y02027
         BNO   NORECDEL                 BRANCH IF NO
         L     RTEMP,PEWAPROC           PROCESS ENTRY ADDRESS
         NC    TRMCHCIN-IEDQTRM(1,RTEMP),TRMCHCIN-IEDQTRM(RTEMP)
*                                       RECORD DELIMITER SPECIFIED
         BZ    NORECDEL                 BRANCH IF NO             A44891
         BCTR  RBUF,0                   BACK UP ONE BYTE
         MVC   0(1,RBUF),TRMCHCIN-IEDQTRM(RTEMP) RECORD DELIMITER
         LA    RBUF,1(0,RBUF)           BUMP TO NEXT EMPTY BYTE
NORECDEL EQU   *
         NI    PRFSTAT1,AVTEFF-PRFNLSTN FLAG BFR AS EOM
         TM    PEWACTL,EOMFLAG          WORKAREA CONTAIN END OF  Y02027
*                                       A MESSAGE
         BO    POSTBUF                  BRANCH IF YES TO POST BFR
         OI    PRFSTAT1,PRFNLSTN        SET NOT-EOM BIT IN PREFIX
         ST    RBFR,PERAQCB             SAVE ADDR OF LAST FILLED
*                                       BUT NON-EOM BUFFER
         OI    PEWAFLG,PBUF             PARTIAL BUFFER FLAG      A44891
         C     RBUF,PERAQCB+4           IS CURRENT UNIT FULL
         BNL   FULLUNIT                 BRANCH IF YES.           Y01004
         ST    RPARM,PEWATIC            SAVE CURRENT UNIT ADDR.  Y01004
         MVI   PEWATIC,PSVTO            SET PUT SCHEDULER MCPL.  Y01004
         ST    RBUF,PEWACBUF            SAVE ADDRESS OF NEXT     Y02027
*                                       EMPTY BYTE.              Y01004
         B     CLEANX                   GO POST APPLICATION      Y01004
*                                       PROGRAM ECB.             Y01004
FULLUNIT EQU   *                                                 Y01004
         LA    RETURN,CLEANX            SET UP RETURN ADDRESS
*                                       FROM 'SETUNIT' ROUTINE.  Y01004
         NC    9(2,RPARM),9(RPARM)      ANOTHER UNIT TO FILL
         BNZ   SETUNIT                  BRANCH IF YES
         NI    PEWAFLG,AVTEFF-PBUF      SET NOT PARTIAL BUFFER
         B     CLEANX                   GO POST APPL PROG ECB
         EJECT
*                                                                Y02027
*        OBTAIN ANOTHER EMPTY UNIT OR BUFFER TO FILL             Y02027
*                                                                Y02027
NEXT     EQU   *
         OI    PRFSTAT1,PRFNLSTN        SET NOT-EOM FLAG
         AR    RCNT,RZERO
         STH   RCNT,PRFSIZE
         SR    RNUM,RZERO               COMPUTE SIZE OF DATA
*                                       REMAINING IN WORKAREA
         STH   RNUM,PEWALREC            AND SAVE                 Y02027
         AR    RWORK,RZERO              ADDRESS OF NEXT BYTE OF
*                                       DATA TO BE MOVED
         NC    9(2,RPARM),9(RPARM)      ANOTHER UNIT IN BUFFER
         BZ    NEXTBUF                  BRANCH IF NO
         LA    RETURN,MOVE              SET UP RETURN ADDRESS
*                                       FROM 'SETUNIT' ROUTINE.  Y01004
SETUNIT  EQU   *
         L     RBUF,8(0,RPARM)          ADDRESS OF NEXT UNIT
         MVI   8(RBUF),TIC              SET UP TIC COMMAND
         LR    RPARM,RBUF               ADDRESS OF NEXT BUFFER UNIT
*                                       LINK FIELD
         ST    RPARM,PEWATIC            SAVE CURRENT UNIT ADDR
         MVI   PEWATIC,PSVTO
         LA    RBUF,AVTUMALN(0,RBUF)    ADDRESS OF FIRST EMPTY
*                                       BYTE IN BUFFER
         CLC   AVTKEYLE(2),PEWASOWA     FULL UNITS WANTED
         BNH   LESSA                    BRANCH IF YES
         LH    RZERO,PEWASOWA           EMPTY BYTE COUNT
         B     CONTA                    BRANCH TO                S21903
*                                       COMPUTE END-OF-UNIT ADDR S21903
LESSA    EQU   *
         LH    RZERO,AVTKEYLE           NUMBER OF EMPTY BYTES
*                                       IN BUFFER
         LH    RTEMP,PEWASOWA           MAXIMUM BUFSIZE        @YA04914
         N     RTEMP,AVTCLRHI           CLEAR HIGH HALFWORD    @YA04914
         SH    RTEMP,PRFSIZE            SPACE AVAILABLE IN UNIT@YA04914
         CR    RTEMP,RZERO               LESS THAN KEY LENGTH  @YA04914
         BNL   CONTA                    NO, BRANCH             @YA04914
         LR    RZERO,RTEMP              SET SHORT LAST UNIT    @YA04914
CONTA    EQU   *
         LR    RTEMP,RBUF               FIRST EMPTY BYTE IN BFR
         ST    RBUF,PEWACBUF            FIRST EMPTY BYTE ADDRESS Y02027
         AR    RTEMP,RZERO              ADDR OF END OF THIS UNIT
         ST    RTEMP,PEWAQCBL           SAVE THIS POINTER        Y02027
         BR    RETURN                   RETURN TO CALLER
         EJECT
*                                                                Y02027
*        POST BUFFER TO MESSAGE HANDLER                          Y02027
*                                                                Y02027
POSTBUF  EQU   *
         MVC   LCBERBCH(3),PRFLINK      REMOVE BFR FROM ERB CHAIN
         XC    PRFLINK,PRFLINK          SET LINK FIELD TO ZERO
         LR    RPARM,RBFR               ADDR OF BUFFER TO POST
         L     RTEMP,PEWATIC            ADDR OF CURRENT TIC FIELD
TICLOOP  EQU   *
         NC    9(2,RTEMP),9(RTEMP)      LAST UNIT IN BUFFER
         BZ    SETTIC                   BRANCH IF YES
         L     RTEMP,8(0,RTEMP)         GET ADDR OF NEXT UNIT
         B     TICLOOP                  GO CHECK FOR LAST UNIT
SETTIC   EQU   *
         MVI   11(RTEMP),INVTIC         SET INVALID TIC ADDRESS TO
*                                       INDICATE END OF BUFFER
         L     RTEMP,PRFLCB-1           LCB ADDRESS
         ST    RPEWA,LCBERCCW-IEDQLCB(RTEMP) SAVE PEWA ADDR IN LCB
         XC    PERAQCB(4),PERAQCB       CLEAR CURRENT BFR ADDR
         TM    PRFSTAT1-IEDQPRF(RPARM),PRFNLSTN EOM BUFFER      SA58449
         BNO   YESEOM                   BRANCH IF YES          @G36XRAW
         BAL   RETURN,DSPPOST           POST BUFFER            @G36XRAW
YESEOM   EQU   *                                               @G36XRAW
         OI    PEWAFLG,ERBBUSY          SET LCB TO BE POSTED
         BAL   RETURN,DSPPOST           POST BUFFER            @G36XRAW
         SPACE 3
         EJECT
CLEANUP  EQU   *
*                                                                     *
*        POST WAITING APPLICATION PROGRAM COMPLETE               Y02027
*                                                                     *
         L     RPEWA,LCBERCCW-IEDQLCB(RPARM) RESTORE PEWA ADDR
         NI    PEWAFLG,AVTEFF-ERBBUSY   SET LCB NOT LOOSE
         MVI   PEWASCB,AVTEZERO         RESET SCBSTATE TO NOT LOCK
         NI    LCBERBST-IEDQLCB(RPARM),LCBDLNKF SET ERB NOT POSTED
         TM    PEWAFLG,CFLG             CLOSE IN PROGRESS
         BO    CLOSE                    BRANCH IF YES
CLEANX   EQU   *
         SR    RENTRY,RENTRY            SET GOOD RETURN CODE     Y02027
ERREXIT  EQU   *                                                 Y02027
         L     RPCB,PEPCBAD             GET PCB ADDRESS          Y02027
         NI    PCBOFLG,AVTEFF-PCBPIPN   SET PUT DONE             Y02027
*                                                                Y02027
*              POST APPLICATION PROGRAM ECB COMPLETE             Y02027
*                                                                Y02027
XMPOST   EQU   *                                                 Y02027
         LA    RZERO,AIBWAP-IEDQAIB     GET OFFSET TO AIB W.A.   Y02027
         L     RPARM,PEWAWA             GET ADDR OF AIB WORKAREA Y02027
         SR    RPARM,RZERO              GET AIB ADDRESSABILITY   Y02027
XMPOST1  EQU   *                                                 Y02027
         LR    RZERO,RENTRY             LOAD COMPLETION CODE     Y02027
         MVC   AIBCMPTP(4),PEWAECBA     STORE ECB  IN LIST       Y02027
         L     RERB,PCBPEBAD            GET PEB ADDRESS          Y02027
         LTR   RERB,RERB                TEST IF AP IS ACTIVE     Y02027
         BNZ   XMPOST2                  YES, BYPASS AIB FREEING  Y02027
         MVI   AIBSTATE,AIBFREE         FREE AIB                 Y02027
         BAL   RETURN,DSPDISP           BR TO AVOID XMPOST     @G36XRAW
XMPOST2  EQU   *                                                 Y02027
         L     RERB,PEBASCB-IEDQPEB(RERB) GET ASCB ADDRESS       Y02027
         LTR   RERB,RERB                TEST IF FLAG HAS         Y02027
*                                       INVALIDATED ASCB ADDR    Y02027
         BNM   NONEGFLG                 BRANCH IF NEGATIVE FLG @G36XRAW
*                                       OFF-                   @G36XRAW
         BAL   RETURN,DSPDISP           BRANCH-AVOID XMPOST    @G36XRAW
NONEGFLG EQU   *                                               @G36XRAW
         L     RENTRY,PCBPEBAD          PEB ADDR               @ZA05000
         L     RTEMP,CVTPTR             ADDR OF CVT            @ZA05000
         ICM   RTEMP,ALL,CVTAQAVT-CVTMAP(RTEMP)  ADDR OF TCX   @ZA05000
         CLC   PEBASID-IEDQPEB+TWO(2,RENTRY),TCXASID-IEDQTCX(RTEMP)
*                                       IS A.P. SUBTASK OF MCP @ZA05000
         BNE   XMPOST3                  BR, NO                 @ZA05000
         L     RPARM,AIBCMPTP           GET ECB ADDR           @ZA05000
         POST  (1),(0)                  DO NORMAL POST         @ZA05000
         BAL   RETURN,DSPDISP           RETURN TO DISPATCHER   @G36XRAW
XMPOST3  EQU   *                                               @ZA05000
*        ISSUE SVC 102 TO SCHEDULE SRB TO POST THE             @Z40X9AG
*        ECB IN THE APPLICATION PROGRAM"S MEMORY               @Z40X9AG
         MVC   AIBSSPAS,PEBASCB-IEDQPEB(RENTRY) SET ASCB ADDR  @Z40X9AG
         MVC   AIBSSPID,PEBASID+TWO-IEDQPEB(RENTRY) SET ASID   @Z40X9AG
         STC   RZERO,AIBSSPCC           SET COMPLETION CODE    @Z40X9AG
         MVC   AIBSSPTC,PEBTCB-IEDQPEB(RENTRY) SET TCB ADDR    @Z40X9AG
         MVI   AIBSSPF1,AIBSSPEC        SET ENTRY CODE         @Z40X9AG
         LA    RPARM,AIBCMPTP           POINT TO PARM LIST     @Z40X9AG
         AQCTL                          SVC 102                @Z40X9AG
         BAL   RETURN,DSPDISP           BRANCH-TO DISPATCHER   @G36XRAW
        SPACE 2
*                                                                Y02027
*        CLOSE IS WAITING FOR END OF MESSAGE THROUGH MH          Y02027
*        POST ELEMT SET UP BY CLOSE                              Y02027
*                                                                Y02027
CLOSE    EQU   *                                                 Y02027
         LA    RZERO,AIBWAP-IEDQAIB     GET OFFSET TO AIB W.A.   Y02027
         L     RPARM,PEWAWA             GET ADDR OF AIB WORKAREA Y02027
         SR    RPARM,RZERO              GET START OF AIB         Y02027
         MVI   AIBSTATE-IEDQAIB(RPARM),AIBFREE FREE UP AIB
         L     RPCB,PEPCBAD             GET PCB ADDRESS          Y02027
         NI    PCBOFLG,AVTEFF-PCBPIPN   SET PUT AS FINISHED      Y02027
         L     RPARM,PEWARCB            GET ADDR OF RCB SET    @OZ07798
*                                       UP BY CLOSE              Y02027
         BAL   RETURN,DSPPOST           EXIT TO DISPATCHER TO  @G36XRAW
*                                       POST ELEM TO READY QUE @G36XRAW
         EJECT
         EJECT
ERB      EQU   *
         SPACE
*                                                                     *
*     INITIALIZE ERB TO OBTAIN EMPTY BUFFERS                          *
*                                                                     *
         SPACE
         LA    RPARM,AVTBFREB           ADDRESS OF AVAILABLE
*                                       BUFFER QCB
         ST    RPARM,LCBERB             INITIALIZE ERB KEY AND
*                                       QCB FIELDS
         MVI   LCBERBPY,PRIINTRQ        SET ERB PRIORITY
         XC    LCBERBLK(3),LCBERBLK     CLEAR ERB LINK FIELD TO ZERO
         MVI   LCBERBST,PUTFLG          FLAG THIS ERB AS A PUT ERB
         XC    LCBERBCH(3),LCBERBCH     SET BUFFER CHAIN PTR TO ZERO
         SR    RZERO,RZERO              CLEAR WORK REG         @SA69971
         IC    RZERO,PCBBUFIN           IN/OUT COUNT           @SA69971
         SRL   RZERO,FOUR               ISOLATE BUFIN          @SA69971
         STC   RZERO,LCBERBCT           INITIALIZE BFR REQ     @SA69971
         MVC   LCBERBCT+1(1),PEUNCT     UNITS PER BUFFER
         LA    RZERO,PEWASCB            SCB ADDRESS
         ST    RZERO,LCBSCBA-1          ADDRESS OF CURRENT SCB
         L     RPARM,PCBLCBAD           LCB ADDRESS
         ST    RZERO,LCBSCBA-1-IEDQLCB(,RPARM) SET SCB FOR MSG   A48279
         LA    RZERO,PERAQCB            ADDRESS OF PUT SCHEDULER
*                                       QCB
         ST    RZERO,PERCQCB            MAKE ADDRESS OF QCB
*                                       AVAILABLE TO BUFFER REQUEST
*                                       SUBTASK
         MVI   LCBPRI-IEDQLCB(RPARM),PRIAPBFR  LCB PRIORITY
         MVI   LCBERBST-IEDQLCB(RPARM),LCBDLNKN SET DELINK SWITCHY02027
         LA    RZERO,LCBRSKEY-IEDQLCB(RPARM) STCB ADDRESS        Y02027
         ST    RZERO,LCBRSKEY-IEDQLCB(RPARM) PUT STCB IN LCB     Y02027
         MVI   LCBRSKEY-IEDQLCB(RPARM),PSVTO PUT SCHEDULER VTO
         MVI   LCBLSPCI+2-IEDQLCB(RPARM),1 INVALID CCW OP CODE
         EJECT
*                                                                     *
*        POST ERB TO BUFFER REQUEST QCB VIA DISPATCHER                *
*                                                                     *
         SPACE
         ST    RWORK,PEWANEB            SAVE ADDRESS OF NEXT     Y02027
*                                       BYTE OF DATA IN WORKAREA Y02027
         LR    RPARM,RERB               ADDRESS OF ERB TO POST
         BAL   RETURN,DSPCHAIN          POST ERB TO BUFFER     @G36XRAW
*                                       REQUEST                @G36XRAW
         SPACE 3
*                                                                Y02027
TNAMEL   DC    H'8'                     SIZE OF TERMNAME         Y02027
QCBHDRSZ DS    0H                       SIZE OF QCB HEADER     @ZM47936
         DC    AL2(QCBPRFSZ)                                   @ZM47936
PATCH    DC    25H'0'                   PATCH AREA               Y02027
*                                                                Y02027
         EJECT
*                                                                     *
*     E Q U A T E S   A N D   R E A D - O N L Y   C O N S T A N T S   *
*                                                                     *
         SPACE
ERBKEY   EQU   X'00'                    ELEMENT REQUEST BLOCK KEY
BLANK    EQU   C' '                     BLANK TERMNAME         @ZA02061
DEBNMEXT EQU   X'10'                    EXTENT OFFSET IN DEB    SA52991
MOVER    DS    0H
         MVC   0(1,RBUF),0(RWORK)       EXECUTED INSTRUCTION THAT
*                                       MOVES DATA FROM A USER'S
*                                       WORKAREA TO A MCP BUFFER
PSVTO    EQU   X'12'                    HEX UI                   S22024
PUTFLG   EQU   X'02'                    PUT ERB IDENTIFIER
OUTFLG   EQU   X'0F'                    HEX 0F                   S22024
DCBOPEN  EQU   X'10'                    HEX 10                   S22024
LOCKR    EQU X'20'                      HEX 20                   S22024
SINGLE   EQU   X'60'                    HEX 60                   S22024
RELEASE  EQU   X'01'                    HEX 01                   S22024
ENTRYFLG EQU   X'12'                    FLAG FOR ENTRY AFTER   @XA11307
*                                        TIME DELAY            @XA11307
OFFSET   EQU   X'14'                    OFFSET TO THE QCB      @XA11307
DELAYPRI EQU   X'D6'                    TIME DELAY SIGNAL      @XA11307
RESETPRI EQU   X'E0'                    LCB PRIORITY AFTER     @XA11307
*                                        TIME DELAY            @XA11307
PIPOFF   EQU   X'FD'                    TURN OFF PUT IN        @XA11307
*                                        PROGRESS BIT          @XA11307
TIC      EQU   X'08'                    TIC COMMAND
ONE      EQU   1                        MASK TO ICM LO-ORDER BYTEY01004
INVTIC   EQU   2                        INVALID TIC ADDRESS
HALF     EQU   3                        MASK TO ICM HALFWORD.    Y01004
ADDR     EQU   7                        MASK TO ICM AN ADDRESS.  Y01004
ALL      EQU   15                       MASK TO ICM ALL 4 BYTES. Y01004
TRMLEN   EQU   8                        LENGTH OF TERMINAL NAME  Y02027
THRESH   EQU   X'C0'                    QUEUES FULL              Y02027
NOBFRS   EQU   X'5C'                    THRESH OR PUT IN PROGRESSY02027
DEST     EQU   X'54'                    DESTINATION ERROR C.C.   Y02027
QUICKC   EQU   X'5E'                    QUICK CLOSE COMPLETION C.Y02027
LENERR   EQU   X'52'                    INVALID WORK UNIT LNGTH@ZA04032
ZERO     EQU   0                        DISPLACEMENT             Y02027
TWO      EQU   2                        DISPLACEMENT             Y02027
THREE    EQU   3                        MASK OF 0011             Y02027
FOUR     EQU   4                        DISPLACEMENT             Y02027
EIGHT    EQU   8                        DISPLACEMENT             Y02027
         EJECT
         TPRIOR
         EJECT
*                                                                     *
*              D  S  E  C  T  S                                       *
*                                                                     *
         SPACE 3
         TTCXD                                                 @ZA05000
         EJECT
CVTMAP   CVT   DSECT=YES                                       @ZA05000
         EJECT
         SPACE
         TAVTD                                                   Y02027
         TLCBD                          LINE CONTROL BLOCK
         TPRFD                          BUFFER PREFIX
         TDISPD                         TCAM DISPATCHER
         TTRMD                          PUT PROCESS ENTRY
         TPCBD                          PROCESS CONTROL BLOCK
         TAIBD EXT=PUTWRITE                                      Y02027
         TPEBD                                                   Y02027
         TPEWAD                         PROCESS ENTRY WORKAREA
         TSCBD
         TQCBD
         DCBD  DSORG=TX
MASKOFF  EQU   X'FF'-LCBTETEN-LCBBFRSZ-LCBABRTN
         END

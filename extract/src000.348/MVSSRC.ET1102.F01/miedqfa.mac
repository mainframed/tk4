         MACRO
         MIEDQFA  &X
.*A-000000-999999                                              @X31X8Q0
.*A513900                                                      @OX12563
         LCLC     &CH
         LCLA     &A
* CHANGE ACTIVITY = AS FOLLOWS:
* ****************** MICROFICHE FLAGS *********************** SUPT CODE
* A281400,751500,752100,756900,759600                            A44866
* C283500                                                        A44866
* A473700                                                        A42363
* C085200,487800,495900,501000,501900,826200-826500              A42363
* D243700                                                        A42363
* A487800,831300                                                  M2321
* C085200,495300,661700                                           M2321
* A206100                                                         M6298
* C085200,183600-184200                                           M6298
* D176100-176400                                                  M6298
* A221300,221320                                                 A49211
* C085200,221200                                                 A49211
* D220800                                                        A49211
* A757100                                                        A49228
* C738000,756000                                                 A49228
* A284700                                                        A41025
* C085200,089100-092100                                          A41025
* D088200-088500                                                 A41025
* A238200                                                        A42400
* C085200                                                        A42400
* C085200,153903,155080                                          A47133
* A054900,056100,096300,150300,153900,154100,154500,154800       S21101
* A155060,155080,156600,166800,167100,178800,179400,180000       S21101
* A180600,180800,180840,217800,235500,340800,456300,479100       S21101
* A485400,504600,661500,840300                                   S21101
* C021300,026700,027300,030300,032400-033300,037200,040500       S21101
* C063300,071700,076200,085200,092700,105900,112200,116700       S21101
* C121200,130500-131100,139800,141000,143400,145200,146100       S21101
* C154120,155066-155084,161100,163500,180220,182700,186900       S21101
* C188400,192000,218400,220800-221100,236100-237000,238400       S21101
* C238599,239400,653700,257100,260400-261600,262200-269700       S21101
* C287400,288000,288600,329100,331200,339900,345000,346800       S21101
* C362100,363000,388200,399000,399900,404400,405300,426300       S21101
* C431700,435600,438000,438600,535800,547800,558600,574500       S21101
* C612600,691200,709500,726600,729300,766500,767100,767700       S21101
* C774000,793200,821100,822000,827400,857100-857400              S21101
* D117900-119100,129900,132900-138000,147000-148200              S21101
* D154600-154800,179100,180300-180818,218700,219600,226500       S21101
* D229800,230400,232800,249600,258000-258900,259500-259800       S21101
* D270300-270600,333300-334200,339300,527100-528300,859800       S21101
* A451300,485760-485940,513601-513810,539730-539970,540700       S22026
* A765930-766140,766600,860800                                   S22026
* C067800,450300,550800-551700                                   S22026
* D513000                                                        S22026
* C341400                                                        A44895
* A228300                                                       SA54922
* C221320                                                       SA54922
* A562500,282900                                                SA54262
* C478500-479300                                                SA52972
* A514800                                                       SA57087
* A518100                                                       SA55393
* D551400-552600                                                SA56898
* C485880                                                       SA57333
* A153900,219900,223500,428700,438900,503700,521700             SA52971
* C153000-153250,153600,153903-153994,154120,155070-155400      SA52971
* C164400-164500,181040-181240,217900,220500,220900-221040      SA52971
* C221200-221360,222600-222900,225000-226800,227400-228000      SA52971
* C234000-235600,429000-429150,478500-479300,484200-484800      SA52971
* C500700-500800,504700-504840,513600-513619,522300-531600      SA52971
* C532800-533400                                                SA52971
* D001800-006600,154000-154100,163800,228400,485500,            SA52971
* D507300-507600,532200                                         SA52971
* A445500,515400,738300,741900,753100,755700                    SA52984
* C445200,445800,755940                                         SA52984
* D449400-457200,743400-743700                                  SA52984
* D055800,790500-791100,795600-798000                           SA51078
* A202600-202700,214300,795600-796600                           SA51078
* C231900                                                       SA51078
* A033070-033490                                                SA51783
* D145200,150400-150580,154900-155070,156000-156900,178900      SA51783
* D179500,179800-179900,180100-180840                           SA51783
* A148510-148650,148860-149040                                  SA51783
* A154126-154150,181280-181440,215420-215680,221040-221220      SA50192
* A221382-221392                                                SA50192
* C220980                                                       SA50192
* D221040-221200                                                SA50192
* A056150,549650,553850-554060                                   S22024
* D550500                                                        S22024
* A256230-256470                                                SA61800
* C350100,359400                                                SA59522
* D358200                                                       SA59522
* A460200,546240,554400                                         SA61767
* C546020                                                       SA61767
* D238400                                                       SA61768
* C238406-238408,238420,238460,238484,238496-238599             SA61768
* A509700                                                       SA62949
* C 358000                                                      SA62976
* A 661760                                                      SA63623
* C481800                                                       SA66617
* A522300                                                       SA66626
* A786900                                                       SA68051
* D787800                                                      @SA68051
.*C013390                                                      @Z30X8QE
* A207600                                                      @YA03936
* A602700,603000                                               @SA70861
* C495440                                                      @SA70861
* A786900                                                      @SA68051
* A38910,384600                                                @SA69655
*A482700                                                       @YA05477
.*D814500                                                      @SA73185
.*A202800                                                      @YA06869
*A482100                                                       @YA08105
*D518170-518310                                                @YA08105
*A733200,751500                                                @YA07705
*A154200                                                       @SA71965
*A504600                                                       @SA74867
*D513780-513810                                                @OX11340
*A056300,445740,445961                                         @OZ09304
*C445560-445590                                                @OZ09304
*C439140                                                       @OZ09304
*A056350,385800,389280                                         @OZ14195
*A056350                                                       @OS79957
*C445932-445961                                                @OS79957
*A514900                                                       @OX11340
*C 554050                                                      @Y17XA0Z
*A615600                                                       @OS77389
*A452100,759300,782700                                         @OX20639
*D456000,459000,463800                                         @OX20639
*A455400,455700,459600,459900                                  @OX20639
*A445930                                                       @OY20265
*A389300                                                       @OZ30296
         SPACE 3
.**********************************************************************
         AIF   ('&X' NE 'CORE').CDS
&A       SETA  1 .                                               S22025
IEDQFA1  TITLE '''IEDQFA'' - CPB INITIALIZATION - CORE ONLY' .   S22025
IEDQFA1  CSECT
         AGO   .OK
.CDS     AIF   ('&X' NE 'DISK').BOTH
&A       SETA  2
IEDQFA2  TITLE '''IEDQFA'' - CPB INITIALIZATION - DISK ONLY' .   S22025
IEDQFA2  CSECT
         AGO   .OK
.BOTH    ANOP
&A       SETA  3
IEDQFA3  TITLE '''IEDQFA'' - CPB INITIALIZATION - CORE AND DISK' S22025
IEDQFA   CSECT
IEDQFA3  EQU   * .
.OK      ANOP
&CH      SETC  'IEDQFA&A'
         ENTRY IEDQFQ .
***********************************************************************
*                                                                     *
*  TITLE: MIEDQFA - CPB INITIALIZATION                                *
*                                                                     *
         AIF   ('&X' NE 'CORE').TAG1
*  MODULE NAME = IEDQFA1                                              *
*                                                                     *
*  DESCRIPTIVE NAME = CPB INITIALIZATION - CORE ONLY                  *
         AGO   .TAG3
.TAG1    AIF   ('&X' NE 'DISK').TAG2
*  MODULE NAME = IEDQFA2                                              *
*                                                                     *
*  DESCRIPTIVE NAME = CPB INITIALIZATION - DISK ONLY                  *
         AGO   .TAG3
.TAG2    ANOP
*  MODULE NAME = IEDQFA(3)                                            *
*                                                                     *
*  DESCRIPTIVE NAME = CPB INITIALIZATION - CORE AND DISK              *
.TAG3    ANOP
*                                                                     *
*  COPYRIGHT = 'NONE'                                                 *
*                                                                     *
*  STATUS -- CHANGE LEVEL 8                                    @Z30X8QE
*                                                                     *
*FUNCTION -- THIS ROUTINE CONSISTS OF 2 PARTS                         *
*   1. FA - THIS ROUTINE WILL INITIALIZE CPBS TO WRITE OR READ        *
*     BUFFER UINTS TO OR FROM DISK.                                   *
*   2. FQ - THIS ROUTINE WILL HANDLE CPBS AFTER DISK I/O HAS BEEN     *
*   COMPLETED.                                                        *
*                                                                     *
*ENTRY POINTS -- THIS MODULE HAS TWO ENTRY POINTS                     *
*   1. 'IEDQFA' - TO QUEUE A BUFFER ON DISK OR TO OBTAIN FULL         *
*      BUFFERS FROM A MESSAGE QEUUE                                   *
*   2. 'IEDQFQ' - TO HANDLE CPBS AFTER DISK OPERATIONS AND FILL       *
*      BUFFERS FROM DATA IN CPBS WHICH HAVE READ A RECORD             *
*      OR FROM UNITS IN A MAIN STORAGE QUEUE.                         *
*   CALLING SEQUENCE                                                  *
*                  L     R1,ELEMAD                                    *
*                  L     R15,QCBSTCHN-1                               *
*                  LA    R15,2(R15)                                   *
*                  BR    R15                                          *
*                                                                     *
*INPUT -- ENTRY IS ALWAYS FROM THE DISPATCHER.  DIFFERENT INPUT       *
*   IS EXPECTED AT THE TWO ENTRY POINTS                               *
*   1.  IEDQFA -                                                      *
*      A. BUFFER TO BE WRITTEN ON DISK.  IT WILL CONTAIN THE          *
*         RELATIVE RECORD NIMBERS FOR THE UNITS OF THE BUFFER         *
*         THE BUFFER IS POSTED TO THE DISK I/O QCB FROM THE      S21101
*         DESTINATION SCHEDULER.                                      *
*      B. BUFFERS TO BE FLAGGED SERVICED, INTERCEPTED, OR CANCELED    *
*         ON THE MESSAGE QUEUES                                       *
*         POSTED BY BUFFER DISPOSITION, INTERCEPT, OR CANCEL          *
*      C. ERB - AN ERB WILL BE POSTED TO OBTAIN FULL BUFFERS.         *
*         SEND SCHEDULER WILL POST THE ERB TO OBTAIN FULL BUFFERS     *
*         TO SATISFY AN INITIAL REQUEST FOR SENDING                   *
*         BUFFER DISPOSTION WILL POST THE ERB FOR RECALL              *
*         EOBCHECK WILL POST FOR RECALLED BUFFERS                     *
*         THE GET SCHEDULER WILL POST TO OBTAIN FULL BUFFERS TO       *
*         SATISFY A GET                                               *
*         PCI APPENDAGE WILL POST TO GET BUFFERS FOR                  *
*         SUBSEQUENT TRANSMISSION                                     *
*         THE ADDRESS OF THE FIRST BYTE OF DATA TO PUT IN THE         *
*         BUFFER WILL BE IN SCBDEOB                                   *
*                                                                     *
*   2.  IEDQFQ                                                        *
*      A. QCB - THE CPB CLEANUP QCB WILL BE POSTED TO ITSELF     S21101
*         TO INITIATE CLEANING UP OF THE CPBS.                        *
*         THE QCB WILL BE POSTED BY DISK END APPENDAGE AFTER DISKS21101
*         I/O IS COMPLETE AND THE COMPLETED CPBS HAVE BEEN            *
*         PLACED ON THE AVTDKAPQ.                                     *
*      B. BUFFER - A BUFFER UNIT WILL BE POSTED TO SATISFY            *
*         A REQUEST FROM FQ.                                          *
*         BUFFER RETURN WILL POST THE AVAILABLE UNIT TO THE           *
*         CLEANUP QCB                                                 *
*                                                                     *
*OUTPUT -- THE COMBINED OUTPUT OF FA AND FQ WILL BE                   *
*   1. BUFFERS WRITTEN ON DISK                                        *
*   2. ERB WITH FULL BUFFERS POSTED TO ACTIVATE QCB OF THE GET   S21101
*      SCHEDULER.                                                     *
*   3. ERB WITH RECALLED BUFFERS POSTED TO THE SPECIFIED QCB.         *
*   4. DUPLICATE HEADERS POSTED TO SPECIFIED QCB.                     *
*   5. CPBS PUT BACK INTO THE FREE POOL.                              *
*                                                                     *
*EXTERNAL ROUTINES --                                                 *
*        'IEDQDISP' - DSPPOSTR - PLACE AN ELEMENT ON THE READY   S21101
*   QUEUE BY PRIORITY.                                           S21101
*        IGG019RC-WTORTN-DISK ERROR HANDLING                     99226
*        ANY EXTERNAL SUBROUTINE WHOSE ADDRESS IS IN THE PRFTIC SA51783
*        FIELD OF A BUFFER POSTED TO IEDQFA WITH 'EE' PRIORITY  SA51783
*        TO REQUEST A CPB.                                      SA51783
*        THESE SUBROUTINES ARE:                                 SA51783
*        'BUILDCPB' - IN IEDQGQ                                 SA51783
*        'NEWPFEFO' - IN IGG019RP                               SA51783
*        'UPFEFO' - IN IGG019RP                                 SA51783
*                                                                     *
*EXITS-NORMAL -- FA - WHEN THERE ARE NO MORE CPBS AVAILABLE           *
*   OR ELEMENTS TO PROCESS, EXIT IS TO EXCP DRIVER. WHO WILL          *
*   RETURN TO THE DISPATCHER.                                         *
*   FQ - WHEN ALL CPBS HAVE BEEN PROCESSED EXIT IS TO FA              *
*                                                                     *
*EXITS-ERROR-BRANCH TO THE WTORTN OF IGG019RC ON DISK ERRORS     99226
*   A LOGICAL READ ERROR MAY OCCUR WHEN PERFORMING A RECALL      99226
*   A LOGICAL READ ERROR MAY OCCUR WHEN A REQUEST IN MADE TO          *
*   READ A RECORD AND THE RECORD NUMBER OF  RECORD WHEN READ          *
*   DOES NOT AGREE WITH THE REQUESTED RECORD NUMBER.                  *
*   APPROPRIATE ERROR FLAGS ARE SET AND THE ERB IS RETURNED           *
*   TO THE SPECIFIED QCB.                                        S21101
*                                                                     *
*TABLES/WORKAREAS --                                                  *
*   LOCAL FLAGS IN THE TIC FIELD OF THE BUFFERS ARE                   *
*   XBUFFER,XSPECIAL,XREUSDSK,XPARTIAL,XNONREUS.                      *
*   IN THE ERB STATUS FIELD FLAGS ARE                                 *
*   XMSG,XXUSED,XXINQ,XCOMPL,XERROR                                   *
*   LOCAL CONSTANTS - XMASK FOR TERM DSECT                            *
*   DSECTS USED - LCB,SCB,PRF,TRM,AVT,QCB,CPB,DATA,DCB,DISP           *
*   AVTFIELDS - ACTIB,APLKN,APLKF,AVFCT,BFDSB,BFREB,BFRTB,BIT1        *
*   BIT2,CADDR,DATLN,DKAPQ,DKENQ,DOUBL,DSKCT,EA,EINPR,EZERO,FCPB      *
*   RC,RO,HDRSZ,IA,INCPQ,KEYLE,MHCOB,NCPBQ,NOBFQ,PARM,PARM3,     S21101
*   REUSQ,TRNMPT,RUFTN,TXTSZ,UMALN.                                   *
*                                                                     *
*ATTRIBUTES -- REUSEABLE, REFRESHABLE, ENABLED, RESIDENT              *
*                                                                     *
*NOTES -- THE OPERATION OF THIS MODULE DOES NOT DEPEND UPON A         *
*    PARTICULAR INTERNAL REPRESENTATION OF THE EXTERNAL CHARACTER     *
*    SET.                                                             *
*                                                                     *
**********************************************************************
*                                                                     *
**********************************************************************
*                                                                     *
R0       EQU   0 .                      WORK REG
*                                       ADDR OF LAST THING POSTED
R1       EQU   1 .                      PARAMETER REG
*                                       WORK REG
R2       EQU   2 .                      ADDRESS OF CPB UNIT
*                                       ADDRESS OF QCB OT POST TO
*                                       ADDRESS OF BUFFER UNIT
RSCB     EQU   3 .                      SCB ADDRESS
R3       EQU   3 .
RLCB     EQU   4 .                      LCB ADDRESS
R5       EQU   5 .                      WORK REG
*                                       DUMMY CPB REG
RPRF     EQU   6 .                      BUFFER PREFIX ADDRESS
RPREFIX  EQU   6 .                      BUFFER PREFIX ADDRESS
R6       EQU   6 .
RQCB     EQU   7 .
R7       EQU   7 .
R8       EQU   8 .                      NUMBER OF UNITS IN BFR
*                                       ADDR OF LAST UNIT OF BFR
RPQ      EQU   9 .                      ADDRESS OF PRIORITY
*                                       DEST QCB
R9       EQU   9 .
*                                       WORK REG
*                                       ADDRESS TO MOVE FROM
RDCB     EQU   10 .                     ADDRESS OF DCB
R10      EQU   10 .                     VALUE OF ADDR FOR RECORD
R11      EQU   11 .                     DISPATCHER BASE
*                                       WORK REG
*                                       COUNT TO MOVE
RBASE    EQU   12 .                     PROGRAM BASE REG
RSAVE    EQU   13 .                     ADDR OF AVT SAVE 2
R14      EQU   14 .                     ADDRESS TO MOVE TO
*                                       WORK REG
R15      EQU   15 .                     ADDRESS OF CPB
**********************************************************************
**                                                                    *
*                       CONDITIONS FOR BCR INSTRUCTIONS          S21101
*                                                                S21101
ONES     EQU   1 .                                               S21101
PLUS     EQU   2 .                                               S21101
NOTZERO  EQU   7 .                                               S21101
ZERO     EQU   8 .                                               S21101
EQUAL    EQU   8 .                                               S21101
NOTMINUS EQU   11 .                                              S21101
NOTONES  EQU   14 .                                              S21101
LASTNOFF EQU   X'04'                                            SA52971
DCBOPEN  EQU   X'10' .
XXCTUSED EQU   X'80' .             THE DISABLED CT IS BEING REFER'D
XCTZERO  EQU   X'7F' .
LGB      EQU   X'80' .                  DSORG TO INDICATE LGB    S22024
INCR     EQU   4 .                      INCREMENT VALUE FOR ADDR S21101
DIV4     EQU   2 .                      VALUE TO DIVIDE BY 4     S21101
EIGHT    EQU   8                        MASK FOR ICM           @OZ09304
AD       EQU   7                        ICM/STCM MASK            Y02027
FOUR     EQU   4                        CONSTANT               @OS79957
FIVE     EQU   5                        CONSTANT               @OS79957
TWO      EQU   2 .                                             @OZ14195
*
*
*        THE FOLLOWING FLAGS ARE IN THE ERB STATUS BYTE
*        X'08' MUST NEVER BE ON
*
*
XXHMSG   EQU   X'80' .                  END OF MSG RCVD IN HM
XRDERR   EQU   X'20' .                  LOGICAL RD ERR FROM DISK
*     INITIATE MODE WITH CORE QUEUES - THE NTXT IS NOT THERE YET
*        IF A LOGICAL READ ERROR OCCURS IN INITIATE MODE - FA WILL
*        DROP THE ERB LEAVING LCBDLNK SWITCH SET TO 'NOT POSTABLE'
*        PCI WILL NOT POST THE ERB.  LOGICAL READ ERROR WILL ALSO BE
*        SET IN ERBST.  WHEN HM RECEIVES A BFR IN INIT MODE UNDER
*        THESE CONDITIONS - THE ERB FOR THE DESTINATION LINE WILL
*        BE REPOSTED TO FA WITH AN E0 PRIORITY REQUESTING
*        THE BUFFERS OF THIS MESSAGE AGAIN.  THE DESTINATION LCB
*        WILL BE FOUND FROM THE LCBINSRCE CHAIN OF THE SOURCE LCB.
XCOMPL   EQU   X'02' .
*        COMPLETE REQUEST HAS BEEN DONE
XXXINQ   EQU   X'10' .                  ERB IS IN BFR RTN Q
XMSG     EQU   X'40' .                  END OF MSG FROM THE QUEUE
*
*
*        THE FOLLOWING FLAGS ARE IN THE BUFFER TIC FIELD         S21101
*
*
XPARTIAL EQU   X'40' .
*        NOT A COMPLETE BFR - NO PRFX HERE
XREUSDSK EQU   X'20' .
*        BFR TO BE QUEUED ON REUSABLE DISK
XSPECIAL EQU   X'80' .
*        THE SPECIAL OPERATION REQUIRED IS DONE BUT BFR NOT WRITTEN
XBUFFER  EQU   X'01' .
*        FEFO PTR DONE BUT BFR NOT WRITTEN
XNRDISK  EQU   X'10' .                  TO BE QUEUED ON MR DISK
XSRVCD   EQU   X'02' .                 TO BE FLAGGED SERVICED
*                                                                     *
ONE      EQU   1 .
PCIADD   EQU   X'50' .                                           S22026
XLOGEOM  EQU   X'80' .                  NO PCI SPEC.- END OF INIT
*                                       IAL REQUEST FOR LINE
*        PRFTIC FLAGS WILL BE AS FOLLOWS
*              X'28' - TO BE QUEUED ON REUS DISK
*              X'18' - TO BE QUEUED ON NONREUS DISK
*              AS SET BY DEST SCHEDULER
*              X'88' - SPECIAL FLAG - 2 OPERATIONS WERE TO BE
*              PERFORMED AS A RESULT OF THIS BUFFER BUT CPBS WERE
*              NOT AVAILABLE FOR BOTH
*              X'48' - PARTIAL BUFFER ONLY - NOT ENOUGH CPBS WERE
*              AVAILABLE TO QUEUE THE LAST UNITS
*              WITH THIS FLAG THE SCB ADXR AND NO. OF UNITS LEFT
*              TO QUEUE IN THE BUFFER WILL BE IN THE FIRST       S21101
*              WORD .  THE VALUE OF ADDR IS IN THE SCB
*              X'01'- FEFO PTR HAS BEEN WRITTEN BUT NOT THE BUFFER
*              X'02' - TO BE FLAGGED SERVICED
*                                                                     *
*        ERB STATUS WILL BE AS FOLLOWS
*        IT MUST NEVER HAVE THE X'08' BIT ON
*       X'04' - TRANSMISSION ERROR - TREAT THE REQUEST
*        AS COMPLETED
*        X'02' / COMPLETE - ALL INFO THAT WAS REQUESTED HANDLED
*        ALL CPBS ARE NOT IN
*       XX'20' - ERB IS ALREADY IN THE BFR REQ Q
*                                                                     *
***********************************************************************
*
*    THIS ROUTINE WILL INITIALIZE CPB(S) TO WRITE UNIT(S) OF A   S21101
*    BUFFER TO DISK OR TO READ DISK RECORDS TO SATISFY A REQUEST
*    MADE BY AN ERB.
*
***********************************************************************
         USING AVTSAVE2,RSAVE .                                  S22025
         USING IEDQLCB,RLCB .
         USING IEDQDATA,R2 .
         USING IEDQSCB,RSCB .
         USING IEDQPRF,RPREFIX .
         USING IEDQDISP,R11 .
         USING IEDQQCB,RQCB .
         USING IEDQPQCB,RPQ .
         USING IHADCB,R10 .
         USING IEDQCPB,R15 .
***********************************************************************
         EJECT
*STCB FOR DISK I/O QCB                                                *
         SPACE 2
         DC    AL1(DSPMCPL2) .
         DC    AL1(PROCESS-&CH) .
         SPACE 2
CPBINIT  EQU   * .
         USING *,RBASE .
         LR    RBASE,R15 .
         SR    R0,R0 .
*    CLEAR POST REG
&CH      IEDHJN NOCPBQ .                MODULE ID AND DATE
         SPACE 3
*        THIS SECTION DEALS WITH A NEWLY POSTED ELEMENT - IF IT IS
*        A BUFFER IT WILL GET THE SCB PRI FOR THE PRILVL QCB AND
*        SAVE IT.  IF A MESSAGE IS TO BE SERVICED IT WILL FORCE THIS
*        REQUEST TO BE HANDLED FIRST.
         SPACE  3
         MVI   PRFKEY-IEDQPRF(R1),XCTZERO .
         LR    RPRF,R1 .
         TM    PRFTIC,CPBTICC .         IS THIS A BFR
         BNO   TESTQ .                  BR NOT BFR               A41025
         LA    R2,0(RPRF) .             INSURE POSITIVE R2       A41025
         NI    PRFTIC,CPBTICC+XNRDISK+XREUSDSK
*        THESE ARE THE ONLY VALID FLAGS AT THIS POINT            S21101
         L     RLCB,PRFLCB-1 .          LCB ADDR
         L     RSCB,LCBSCBA-1 .         SCB ADDR
         IC    R2,SCBPRI .              SAVEPRTY QCB
         L     RQCB,SCBDESTQ-1 .
         ST    RQCB,PRFQCBA-1 .
         STC   R2,PRFKEY .
         AIF   (&A NE 1).F002
         B     SRVCDMSG .
         AGO   .F003
.F002    ANOP
         CLI   PRFPRI,PRIDKSRV .
         BE    SRVCDMSG .
         CLI   PRFPRI,PRIFEFO .         IS THIS A REQUEST AN UP  S21101
*                                         DATE OF A FEFO POINTER S21101
         BE    UPFEFO .                   YES, GO UPDATE DISK PTRS21101
*                                         NO, NOT SO             S21101
         LH    R1,PRFSIZE .
         BAL   R14,SUBTRKEY .
         AH    R1,AVTKEYLE .
         STC   R1,PRFPRI .
         TM    PRFSTAT1,PRFNLSTN .      LAST BFR FOR LOCK
         BO    CKINIT .                 BR NO - NO FLAG NEEDED
         TM    PRFSTAT1,PRFDUPLN+PRFERMGN .
*        DUPL HDR OR ERRMSG FOR ORGIGINAL MSG
         BNZ   CKINIT .                 BR IF EITHER
         TM    QCBFLAG,QCBPROC .        IS THIS THE LOCK LINE DEST
         BO    CKINIT .                 BR IF NOT LINE DEST
         TM    SCBSTATE,SCBLCK1N+SCBMSGLN .   LOCK
         BZ    CKINIT .                 BR NOT LOCK
         BM    EXTLOCK .
         NI    SCBSTATE,X'FF'-(SCBLCK1N+SCBMSGLN) .   FLAGS OFF
EXTLOCK  EQU   * .
         OI    PRFTIC,XBUFFER .         SET FLAG NOT TO WRITE FEFO
CKINIT   EQU   * .
         ST    RPRF,AVTDOUBL .
         CLC   AVTDOUBL+1(3),SCBDEOB+1 . WAS THE LAST SUCCESSFUL EOB
*        IN THIS BUFFER
         BNE   TESTQ .
         MVC   SCBDEOB+1(3),PRFCRCD .   SET ADDR THIS RECORD
.F003    ANOP
TESTQ    EQU   * .
         NC    AVTNCPBQ+1(2),AVTNCPBQ+1 .
         BZ    TESTELEM .
         LA    R2,AVTNCPBQ .            ADDR OF NO CPBQ
         LR    R15,RPRF .               SET FOR QMGR
         BAL   R11,ENQMGRB .
         SPACE 3
*        CHECKS FOR MORE ELEMENTS TO BE PROCESSED BEFORE THE EXITS21101
         SPACE 3
PROCESS  EQU   * .
         ICM   RPREFIX,AD,AVTNCPBQ+ONE  ANY CPBS THERE           Y02027
         BZ    CALLEXCP .
         MVC   AVTNCPBQ+1(3),PRFLINK .  DELINK ELEM
TESTELEM EQU   * .
         AIF   (&A NE 1).F004
         B     ERB .
         AGO   .F005
.F004    ANOP
         TM    PRFTIC,CPBTICC .         IS THIS A BFR
         BNO   ERB .
         SPACE 3
*        WILL WRITE A BUFFER OF DISK ALONG WITH THE FEFO POINTER
*        IF NEEDED AND WILL HANDLE CANCELED MESSAGE REQUESTS AND
*        SERVICED MESSAGES.
         SPACE 3
*
*  FOR A BUFFER WHICH HAS BEEN PARTIALLY WRITTEN ON DISK, THE FIRST
*  OF THE UNITS NOT WRITTEN WILL APPEAR ON THE NCPBQ.            S21101
*  THE TIC FIELD WILL HAVE X'18' INDICATING A PARTIALLY QUEUED
*  BUFFER AND A '20' TO INDICATE REUSEABLE DISK OR X'40' FOR NON-
* REUSABLE DISK.  PRFKEY WILL HAVE THE VALUE
* OF ADDRESS FOR THIS UNIT IN BYTES 2,3,4,
* AND THE NUMBER OF REMAINING UNITS IN BYTE 1
*
         TM    PRFTIC,XPARTIAL .        HAS THIS BFR BEEN PARTIALLY
         BNO   CKSERVD .                WRITTEN ON DISK - BR NO
         SR    R8,R8 .
         IC    R8,PRFKEY .              NO. OF UNITS LEFT
         L     R10,PRFKEY .             VALUE OF ADDR
REQUEST  EQU   * .
         BAL   R9,BIGSUBR .
         BAL   R9,SAVE .
         STCM  R10,AD,CPBADDR+ONE       SET ABSOLUTE RECORD NO.  Y02027
         ST    R10,DATFEFO-1-IEDQDATA(R6) .  SET REC NO THIS REC
         MVI   DATFLAGS-IEDQDATA(R6),DATNPRFX .  SET FLAG
         XC    DATCOUNT-IEDQDATA(2,R6),DATCOUNT-IEDQDATA(R6) .
         BAL   R11,EXCPINQ1 .
         BCT   R8,NEXTXTRA .           DECR NO UNITS IN BFR
         IC    R1,AVTDOUBL .
         STC   R1,DATCOUNT-IEDQDATA(R6) . SET SIZE OF DATA IN
         B     PROCESS .                 LAST UNIT
NEXTXTRA EQU   * .
         LA    R10,INCR(0,R10) .        ADD 4 TO ADDR            S21101
NEXTRA   EQU   * .
         LH    R2,AVTDOUBL .
         L     R6,PRFTIC .               NEST UNIT
         STC   R2,PRFTIC .             RESTORE PARTIAL FLAGS
         STCM  R2,PLUS,PRFPRI           RESTORE SIZE OF LAST UNITY02027
         B     REQUEST .
SAVE     EQU   * .
         ICM   R2,PLUS,PRFPRI           SAVE SIZE OF ALST UNIT   Y02027
         IC    R2,PRFTIC .              SAVE FLAGS
         STH   R2,AVTDOUBL .          SAVE ALL
         BR    R9 .                     RETURN
RENQELEM EQU   * .
         TM    PRFTIC,XPARTIAL+CPBTICC .IS THIS A PARTIAL BFR
         BNO   ENQUEUE .                BR NO
         ST    R10,PRFKEY .             VALUE OF ADDR
         STC   R8,PRFKEY .              COUNT OF REMAINING UNITS
ENQUEUE  EQU   * .
*        THIS ELEMENT MUST BE PUT FIRST ON THE FIFO NCPBQ
         ICM   R14,AD,AVTNCPBQ+1        GET TOP OF QUEUE         Y02027
         STCM  R14,AD,PRFLINK           CHAIN TO BUFFER          Y02027
         ST    RPREFIX,AVTNCPBQ .       PUT ELEM FIRST ON CHAIN
         BNZ   CALLEXCP .               BR YES
         ST    RPREFIX,AVTNCPBQ+4 .     IF NO SET PTR TO LAST
         B     CALLEXCP .
BIGSUBR  EQU   * .
         BAL   R14,REQCPB .
         L     R1,CPBXREAF .            UNIT ADDR
         BAL   R14,UNITFREE .           FREE BUFFER              S21101
FREEUNIT EQU   * .
         L     RQCB,PRFQCBA-1 .
         BAL   R14,WRKD .
         BR    R9 .
.F005    ANOP
         AIF   (&A EQ 1).F006
WRKD     EQU   * .
         MVI   CPBRDWR,CPBWRKC .
         ST    RPREFIX,CPBXREAF .       ADDR OF START OF BFR TO WR
         MVI   CPBXDWR,CPBWRC .         INTO DATA FIELD
*   A '00' FLAG INDICATES THAT THIS RECORD HAD A PREFIX          S21101
*        THE FEFO POINTER IS SET TO 0.
         BR    R14 .                   RETURN
REQCPB1  EQU   * .
         LA    R2,0(R3) .               INSURE R2 IS POSITIVE    S21101
*                                         AND NON ZERO           S21101
         LNR   R2,R2 .
REQCPB   EQU   * .
         ICM   R15,AD,AVTFCPB+ONE       ANY CPBS THERE           Y02027
         BZ    RENQELEM .               BR NO
         MVC   AVTFCPB+1(3),CPBNEXT .  DELINK
         LTR   R2,R2 .
         BCR   NOTMINUS,R14 .                                    S21101
         L     R2,CPBXREAF .            SET UNIT ADDR FOR WR DATA
*              TO PASS ON - IT SHOULD REMAIN THE SAME
         MVI   CPBRDWR,CPBWRC .         WRITE DATA COMMAND
         MVI   CPBXDWR,CPBNOPC .        NOP COMMAND CODE
         MVC   CPBADDR+1(3),PRFCHDR .   SET VALUE OF ADDR
         TM    PRFSTAT1,PRFNHDRN .      IS THIS A HEADER
         BCR   1,R14 .                  BR IF NOT HDR            S21101
SETCRCD  EQU   * .
         MVC   CPBADDR+1(3),PRFCRCD .   SET ADDR OF THIS BFR IF HDR
         BR    R14 .
UPFEFO   EQU   * .                                              SA51783
         MVI   PRFSTAT1,X'FF'-PRFNLSTN-PRFNHDRN .               SA51783
*                                       FLAG AS PRIFEFO REQUEST SA51783
NOSPEC   EQU   * .                                              SA51783
         BAL   R14,REQCPB .             GO REQUEST A CPB        SA51783
         SPACE
         L     R11,AVTEA .              SET DSP BASE FOR SUBRTN SA51783
         L     R14,PRFTIC .             SAVE RETURN ADDRESS     SA51783
         ST    R15,PRFTIC .             PASS ADDRESS OF CPB     SA51783
         LR    R15,R14 .                SET RETURN ADDRESS      SA51783
         BALR  R14,R15 .                RETURN TO CALLING SBRTN SA51783
         SPACE
         BAL   R11,EXCPINQ1 .           GO ENQUEUE CPB          SA51783
         B     PROCESS .                GO PROCESS NEXT ELEMENT SA51783
         SPACE
CKSERVD  EQU   * .
         CLI   PRFSTAT1,X'FF'-PRFNLSTN-PRFNHDRN .               SA51783
*                                       PRIFEFO REQUEST         SA51783
         BE    NOSPEC .                 BR YES                  SA51783
         SPACE
         L     RLCB,PRFLCB-1 .          LCB ADDRESS
         L     RQCB,PRFQCBA-1 .
         SR    R11,R11 .
         IC    R11,PRFKEY .
         BAL   R14,FINDEST2 .
         TM    PRFSTAT1,PRFNLSTN .      IS THIS A LAST BFR
         BO    CKCNCLD .                BR NO
         TM    PRFTIC,XSRVCD .         TO BE FLAGGED SERVICED
         BNO   CKCNCLD .               BR NO
         B     JUSTONE .                ALL OTHER PROCESSING IS DONE
.F006    ANOP
SRVCDMSG EQU   * .
         OI    PRFTIC,XSRVCD .          SET FOR LATER IN CASE OF
         TM    PRFSTAT1,PRFNHDRN .      IS THIS A HDR-EOM       SA52971
         BNO   HDRLAST .                BR YES, IF NOT HDR-EOM, SA52971
         MVC   PRFCRCD(3),PRFCHDR .     SET REC NOS AND FLAGS   SA52971
         MVC   PRFCORE(3),PRFCHDR .                             SA52971
         NI    PRFSTAT1,X'FF'-PRFNHDRN .TO LOOK LIKE HDR-EOM    SA52971
HDRLAST  EQU   * .                                              SA52971
         SR    R11,R11 .
         IC    R11,PRFTQBCK .           GET PRI LEVEL           SA52971
         BAL   R14,FINDEST2 .
         TM    QCBFLAG,QCBPROC        . APPLICATION PROGRAM      S21101
         BO    FEFORSET               . YES - BR                 S21101
*** THIS SUBROUTINE DESTROYS REGS 0,1,2, AND 11.  THE QCB       SA52971
*   EXTENSION IS RETURNED IN REG2.  RETURN IS TO +0 IF THIS     SA52971
*   IS NOT A CONCENTRATOR AND TO +4 IF IT IS A CONCENTRATOR.    SA52971
         BAL   R10,FINDLVL .            GO SEE IF PRI LVL       SA52971
         B     SETSDFFO .               BR IF NOT A CONC        SA52971
         TM    QCBEFLG-IEDQQCBE(R2),QCBEOPL .                   SA52971
*        IS THIS A PLVL CONC                                    SA52971
         BNO   SETSDFFO .               BR IF NOT PLVL          SA52971
*** WHEN MARKING SRVCD, IF CONC IS PLVL QUEUED, THE SCB USED    SA52971
*   IS NOT THE REAL ONE, SINCE 'SCBFEFO' CANNOT BE UPDATED,     SA52971
*   HM03 WILL UPDATE THE QCB EXTENSION; THEREFORE, THE          SA52971
*   EQUIVALENT OF SCBFEFO (PRFSRCE) MUST NOW BE UPDATED WITH THESA52971
*   CORRECT FEFO POINTER.                                       SA52971
         MVC   PRFSRCE(3),QCBEFEFO-IEDQQCBE(R2) SAVE FEFO       SA52971
         XC    QCBEHDR-IEDQQCBE(3,R2),QCBEHDR-IEDQQCBE(R2) ZERO SA52971
*                                         HDR PTR AS HM03 FLAG  SA52971
         B     FEFORSET .               GO DON'T RESET 'SENDING'SA52971
SETSDFFO EQU   * .                                              SA52971
         NI    QCBFLAG,X'FF'-QCBSDFFO . RESET CURRENTLY SENDING SA52971
FEFORSET EQU   * .                                              SA52971
         LR    R1,R6 .                  SET COMPARE REG WITH BFRSA52971
*                                         ADDRESS               SA52971
         AIF   (&A NE 3).F006AA .                               SA52971
         TM    PRFCRCD+L'PRFCRCD-1,CPBQTYPE IS THIS DISK ADDR   SA52971
         BNZ   TSTLF .                  YES, WE'RE SET FOR COMP SA52971
         L     R1,PRFCRCD-1 .           GET FEFO CHAIN ADDRESS  SA52971
TSTLF    EQU   * .                                              SA52971
.F006AA  ANOP  , .                                              SA52971
         CLC   PRFCRCD-IEDQPRF(3,R1),QCBLFEFO LAST MSG          SA52971
         BNE   NOQCB .                  NO, BR                   S22025
         MVI   QCBDATFL,DATSENT .       FLAG MESSAGE SERVICED    S21101
         MVC   QCBDATSQ(2),PRFTQBCK+1 . SAVE SEQ OUT            SA52971
*                                       IS THIS SCAN START      SA50192
         CLC   PRFCRCD-IEDQPRF(,R1),QCBPFEFO .                  SA50192
         BNE   NOQCB .                  BR NO                   SA50192
         SPACE
         OI    QCBDATFL,DATIFEFO .      SET INITIAL FEFO        SA50192
NOQCB    EQU   *                          .                      S21101
         BAL   R14,DECRMGCT .
         TM    QCBDSFLG,QCBDISK         CORE ONLY              @SA71965
         BNZ   NOQCB1                   BRANCH IF NO           @SA71965
         NC    QCBFFEFO,QCBFFEFO        FEFO CHAIN EMPTY       @SA71965
         BNZ   NOQCB1                   BRANCH IF NO           @SA71965
         XC    QCBLFEFO,QCBLFEFO        ERASE NONUNIQUE        @SA71965
*                                       CORE QUEUE BRF ADDR    @SA71965
NOQCB1   EQU   *                                               @SA71965
         L     R1,PRFTIC .              SAVE NEXT UNIT
         MVI   SCBHBFNO,AVTEZERO .      CLEAR FOR NEXT MSG
         CLI   PRFNBUNT,ONE .
         BE    JUSTONE .
         IC    R5,PRFNBUNT .            NO. OF UNITS IN THIS BFR
         MVI   PRFNBUNT,ONE .           REPLACE NUMBER OF UNITS
         BCTR  R5,0 .                   FREED
*        FREE ALL BUT FIRST UNIT - 1 HAS NEXT UNIT ADDR
         STC   R5,PRFNBUNT-IEDQPRF(R1) .   NEW NO. OF UNITS
         BAL   R14,RTNBFR .
         L     RQCB,PRFQCBA-1 .         RESTORE QCB ADDR
JUSTONE  EQU   * .
         AIF   (&A NE 3).F008
         LA    R15,FROMDISK .           SET RTN ADDR
         TM    QCBDSFLG,QCBCORE .       MSG IN CORE
         BCR   NOTONES,R15 .            BR NO                    S21101
*
*  WHEN A MSG IS READ TO SEND, SCBQTYPE IS SET TO INDICATE WHICH
*  TYPE OF Q THE MSG IS BEING SENT FROM.
*
*  PRFTIC WILL BE FLAGGED WITH A X'80' IF A SPECIAL CONDITION EXISTS
*
         TM    PRFTIC,XSPECIAL .        HAS THIS MSG BEEN FREED FROM
         BCR   ONES,R15 .               THE CORE Q - BR YES      S21101
         LR    R7,R15 .
         TM    PRFCHDR+L'PRFCHDR-1,CPBQTYPE SENT FROM CORE      SA52971
         BNZ   DISKMSG .                NO, BR                  SA52971
.F008    AIF   (&A EQ 2).F009
         TM    LCBSTAT1,LCBINITN .      SENDING INIT MSG
         BNO   FREEIT .                 BR NO
*        IF INITIATE MODE - THE MSG COULD BE FLAGGED SERVICED ( AS
*        IN THE CASE OF ADDRESSING ERRORS) BEFORE THE MESSAGE HAS
*        COMPLETELY ARRIVED. - IF THIS HAPPENS, THE MSG SHOULD
*        NOT BE FLAGGED SERVICED BUT ADDED TO THE FEFO Q WHEN
*        IT IS COMPLETELY RECEIVED.
         L     R1,PRFCORE-1 .           ADDR OF A BFR OF THIS
*                                       MSG IN THE QUEUE.
         L     R1,PRFLCB-1-IEDQPRF(R1) .  ADDR OF SRCE LCB
         TM    LCBSTAT1-IEDQLCB(R1),LCBINITN+LCBRECVN .
*        IS SRCE LINE STILL TRANSMITTING AN INIT MODE MSG
         BNO   FREEIT .                 BR NO
         L     R7,LCBINSRC-1-IEDQLCB(R1) .  ADDR OF DEST LINE
         LA    R7,0(R7) .               CLEAR FOR COMPARE
         LA    RLCB,0(RLCB) .           CLEAR FOR COMPARE
         CLR   R7,RLCB .                STILL SENDING TO THIS LINE
         BNE   FREEIT .                 BR NO
*        IF THE LCB HAS REACHED BFR DISPOSITION - THE EOM BFR
*        HAS REACHED DEST. SCH. - BD WILL FREE ALL UNUSED BFRS
*        BEFORE POSTING THE EOM BFR TO H M.
         NC    LCBLSPCI-IEDQLCB(2,R1),LCBLSPCI-IEDQLCB(R1) .
*        HAVE THE BFRS BEEN FREED
         BZ    FREEIT .                 BR IF BFRS HAVE BEEN BFRRE
*        BY BD
         NI    LCBSTAT1-IEDQLCB(R1),X'FF'-LCBINITN .
*        RESET INIT MODE FOR THIS SOURCE TO FORCE MSG INTO FEFO
         B     POSTBFR .                DO NOT FREE MSG FROM Q
FREEIT   EQU   * .
         L     R15,ADFREEMS .           FREE MSG FROM CORE QUEUE UNI
         BALR  R7,R15 .                 UNITS
         L     RQCB,PRFQCBA-1 .         RESTORE QCB ADDR
         AIF   (&A NE 3).F009
         TM    QCBDSFLG,QCBREUS+QCBNREUS .
*                       WAS THIS MSG DISK QUEUED ALSO
         BZ    POSTBFR .               BR NO
*
*  THIS SPECIAL FLAG MEANS THE MSG HAS BEEN FREED FROM THE CORE Q
*  BUT NOT FLAGGED SERVICED ON DISK.
*
.F009    AIF   (&A EQ 1).F010
         AIF   (&A EQ 2).F009A
FROMDISK EQU   * .
         OI    PRFTIC,XSPECIAL .        FLAG SPECIAL - FREED FROM CORE
         LPR   R2,R2 .                  RESET 2
.F009A   ANOP
         BAL   R14,REQCPB1 .            SET A CPB
         USING IEDQDATA,R2                                       S21101
         MVI   DATFLAGS,DATSENT  .      FLAG MSG SERVICED        S21101
         TM    PRFSVFFO+L'PRFSVFFO-1,CPBQTYPE  DISK ADDR        SA52971
         BNZ   DISKADDR                 BRANCH YES              SA52971
         NI    PRFSVFFO+L'PRFSVFFO-1,X'FF'-LASTNOFF  INSURE     SA52971
*                                       PROPER CORE ADDRESS     SA52971
DISKADDR EQU   *                                                SA52971
         MVC   DATFEFO(3),PRFSRCE .     SET FEFO PTR            SA52971
         MVC   DATSEQOT(2),PRFTQBCK+1 . SET SEQ OUT             SA52971
         CLC   QCBPFEFO,PRFCRCD .       IS THIS PFEFO           SA50192
         BNE   NOTPFEFO .               BR NO                   SA50192
         SPACE
         OI    DATFLAGS,DATIFEFO .      SET INITIAL FEFO        SA50192
NOTPFEFO EQU   * .                                              SA50192
         BAL   R11,EXCPINQ1 .
.F010    ANOP
POSTBFR  EQU   * .
         LR    R1,RPREFIX .             FREE THIS UNIT
         BAL   R14,UNITFREE .                                    S21101
         B     PROCESS .                GO GET NEXT ELEM
DECRMGCT EQU   * .
         LH    R11,QCBMSGCT .           DECREASE MSGCT BY ONE     M6298
         BCTR  R11,0 .                                            M6298
         STH   R11,QCBMSGCT .                                     M6298
         BR    R14 .
         AIF   (&A EQ 1).F011
CKCNCLD  EQU   * .
         TM    PRFSTAT1,PRFCNCLN .
         BNO   CKDUPLHD .               BR NO
         AIF   (&A NE 3).F010BB
         TM    QCBDSFLG,QCBCORE .       CORE W/ DISK BACKUP
         LA    R7,NOBACKUP .            SET RTN ADDR
         BCR   NOTONES,R7 .             BR IF DISK ONLY          S21101
*        IF YES - FREE THE MSG FROM THE CORE QUEUE
         TM    LCBSTAT1,LCBINITN .      INIT MODE
         BNO   DISKMSG .                BR NO - FREE MSG
         TM    LCBINSRC+2,XXXON .       BEING SENT
         BCR   NOTONES,R7 .             BR IF BEING SENT-NO FREE S21101
DISKMSG  EQU   * .
         L     R15,ADFREEMS .           ADDR OF SUBROUTINE
         MVC   AVTDOUBL+4(3),PRFCRCD .  DISK ADDR OF BFR
         TM    PRFSTAT1,PRFNHDRN .      THIS A HDR
         BNO   CRCDOK .                 BR IF HDR
         MVC   AVTDOUBL+4(3),PRFCHDR .  ADDR OF HDR ON DISK
CRCDOK   EQU   * .
         L     R2,QCBCFHDR-1 .          ADDR OF FIRST ON P QCB
         LA    R2,0(R2) .               CLEAR HI
CKCRCD   EQU   * .
         LTR   R2,R2 .                  IS ONE THERE
         BCR   ZERO,R7 .                IF NO - RETURN           S21101
         ST    R2,AVTDOUBL .            ADDR OF BFR TO FREE
         CLC   AVTDOUBL+4(3),PRFCRCD-IEDQPRF(R2) .
*        THIS THE HDR COPY OF THIS MSG
         BE    HAVEADDR-FREEMSG(R15) .  BR YES - THIS IS IT - GO
*        FREE IT
         L     R2,PRFNHDR-IEDQPRF(R2) . NEXT HDR IN Q
         SRL   R2,8 .                   SHIFT ADDR OVER
         B     CKCRCD .                 GO LOOK AT THIS ONE
NOBACKUP EQU   * .
.F010BB  ANOP
         L     RQCB,PRFQCBA-1 .         RESTORE QCB ADDR
         TM    PRFSTAT1,PRFNHDRN .      HDR SEG
         BNO   WRITE .                  YES - PUT CNCLD FLAG WITH BFR
         TM    PRFTIC,XSPECIAL .
         BO    WRITEBFR .               CNCLD FLAG HAS BEEN DONE
         BAL   R14,REQCPB1 .
         BAL   R14,DECRMGCT .
         XC    DATFLAGS-IEDQDATA(6,R2),DATFLAGS-IEDQDATA(R2) .
*        CLEAR DATA FIELD
         MVI   DATFLAGS-IEDQDATA(R2),DATCNCLD .SET CNCLD FLAG
         OI    PRFTIC,XBUFFER+XSPECIAL . FLAG FOR CNCL DONE AND FEFO
         BAL   R11,EXCPINQ1 .
         B     WRITEBFR .                 TO WRITE OUT THIS BFR
CKDUPLHD EQU   * .
*            FROM BFR PRFX INTO SCB PRF WORK AREA
         TM    PRFSTAT1,PRFDUPLN .      IS THIS A DUPL HDR
         BNO   WRITEBFR .               BR NO
         BAL   R8,SETFEFO .
         BAL   R14,REQCPB .
         NI    PRFTIC,X'FF'-XBUFFER .  SET FLAG OFF
         LR    R10,R6 .
         L     R6,CPBXREAF .            ADDR OF CPB UNIT
         LH    R14,AVTKEYLE .
         EX    R14,TRANSFER .           TRANSFER DATA TO CPB UNIT
         BAL   R14,WRKD .
*                                       SAVE PRI LEVEL ON DISK  SA51078
         MVC   PRFPLQCB,PRFKEY-IEDQPRF(R10) .                   SA51078
         XC    DATFLAGS-IEDQDATA(8,R6),DATFLAGS-IEDQDATA(R6) . CLEAR
         LR    R2,R10                   SAVE REG               @YA06869
         SR    R11,R11                  CLEAR FOR IC           @YA06869
         IC    R11,PRFPLQCB             GET PRIORITY LEVEL     @YA06869
         BAL   R14,FINDEST2             GET PRIORITY QCB       @YA06869
         MVC   DATFLAGS-IEDQDATA(,R6),QCBDATFL  SET DATA FLAGS @YA06869
         LR    R10,R2                   RESTORE REG            @YA06869
         BAL   R14,SETCRCD .           SET REC. NO. AND DATA SET
         BAL   R11,EXCPINQ1 .
         LR    R1,R10 .
         L     R2,LCBRCQCB .            ADDR TO POST TO
         MVI   PRFPRI-IEDQPRF(R1),PRIRCQCB .  SET PRTY
         LA    R14,PROCESS .            SET RTN ADDR
         NI    PRFTIC-IEDQPRF(R1),X'FF'-XBUFFER .  FLAG OFF
         B     POST .                   POST BFR
CNCLDCK  EQU   * .
         TM    PRFSTAT1,PRFNHDRN .      IF NOT A HDR - IGNORE IT
         BO    NOSET .
         BAL   R14,DECRMGCT .                                     M6298
         OI    DATFLAGS-IEDQDATA(R6),DATCNCLD .      SET CNCLD FLAG
         B     NOSET .                  CONTINUE
WRITEBFR EQU   * .
         TM    PRFSTAT1,PRFNLSTN .      IS THIS A LAST SEG
         BO    WRITE .                  BR NO
         LH    R1,PRFSRCE               SOURCE OFFSET          @YA03936
         N     R1,AVTCLRHI              CLEAR HI HALF          @YA03936
         LTR   R1,R1                    SOURCE SPECIFIED?      @YA03936
         BZ    NOTPROC                  BRANCH IF NO           @YA03936
         L     R15,AVTRNMPT             CORRECT OFFSET TO      @YA03936
         BALR  R14,R15                  AN ADDRESS             @YA03936
         TM    TRMSTATE-IEDQTRM(R1),TRMPROC PUT PROCESS?       @YA03936
         BNO   NOTPROC                  BRANCH IF NO           @YA03936
         CLC   TRMSTAT+1-IEDQTRM(2,R1),AVTFZERO DCB CLOSED     @YA03936
         BE    CKBFRFLG                 BRANCH IF YES          @YA03936
NOTPROC  EQU   *                                               @YA03936
         TM    LCBSTAT1,LCBINITN+LCBRECVN
*        RECEIVING AN INITIATE MODE MESSAGE
         BNO   CKBFRFLG .               BR NO
         NI    LCBSTAT1,LCBINITF .      INIT OFF
         TM    LCBINSRC+2,XXXON .       IS THIS INIT MODE MSG
*                   CURRENTLY BEING SENT
         BO    CKBFR .                  BR IF NOT BEING SENT
*     DO NOT PUT THIS MSG IN THE FEFO CHAIN
         OI    PRFTIC,XBUFFER .
         B     WRITE .
XXXON    EQU   X'01' .
CKBFR    EQU   * .
         NI    LCBINSRC+2,X'FF'-XXXON .   TURN SRC BIT OFF
CKBFRFLG EQU   * .
         BAL   R8,SETFEFO .
WRITE    EQU   * .
         SR    R8,R8 .
         IC    R8,PRFNBUNT .            NO. OF UNITS TO WRITE
         BAL   R9,BIGSUBR .
         BAL   R14,SETCRCD .           SET REC. NO. AND DATA SET
         OI    PRFTIC,XPARTIAL .        SET PARTIAL FLAGS
         BAL   R9,SAVE .
         MVC   PRFPLQCB,PRFKEY .        SAVE PRI LEVEL ON DISK  SA51078
         XC    DATFLAGS-IEDQDATA(8,R6),DATFLAGS-IEDQDATA(R6) . CLEAR
         TM    PRFSTAT1,PRFCNCLN .      MSG TO BE CNCLD
         BO    CNCLDCK .                BR YES TO CK IF HDR
NOSET    EQU   * .
*                                       IS THIS HDR LAST        SA50192
         TM    PRFSTAT1,PRFNHDRN+PRFNLSTN .                     SA50192
         BNZ   NOTHDRL .                BR NO                   SA50192
         SPACE
         SR    R11,R11 .                CLEAR REG               SA50192
         IC    R11,PRFPLQCB             QCB PRIORITY LEVEL      SA50192
         BAL   R14,FINDEST2 .           GET PRIORITY QCB        SA50192
         SPACE
         CLC   QCBLFEFO,PRFCRCD .       LAST MSG ON QUEUE       SA50192
         BNE   NOTHDRL .                BR NO                   SA50192
         SPACE
*                                       SET DATA FLAGS          SA50192
         MVC   DATFLAGS-IEDQDATA(,R6),QCBDATFL .                SA50192
NOTHDRL  EQU   * .                                              SA50192
         BAL   R11,EXCPINQ1 .
         BCT   R8,WRITEUNT .            ARE ANY UNITS LEFT BR-YES
         B     PROCESS .                BR NO
WRITEUNT EQU   * .
         MVC   AVTDOUBL+5(3),PRFXTRA . VALUE OF ADDR FOR
         L     R10,AVTDOUBL+4 .          THE NEXT UNIT
         B     NEXTRA .                 PROCESS THE UNITS
SETFEFO  EQU   * .
         MVC   AVTSAVE2+64(6),QCBDATFL  SET UP WORK AREA         S21101
         TM    PRFTIC,XBUFFER .         HAS THE FEFO PTR BEEN WRITTEN
         BCR   ONES,R8 .                BR YES                   S21101
         MVC   AVTSAVE2+65(3),PRFCHDR    SAVE CURRENT HDR        S21101
         TM    PRFSTAT1,PRFNHDRN .
         BO    TESTFEFO .
         MVC   AVTSAVE2+65(3),PRFCRCD    SAVE CURRENT RCD        S21101
TESTFEFO EQU   * .
         BAL   R14,REQCPB1              GETG CPB                 S21101
         MVI   QCBDATFL,AVTEZERO .      SAVE FLAGS FOR LFEFO    SA52971
         XC    QCBDATSQ(2),QCBDATSQ .   SAVE SEQ NO. FOR LFEFO  SA52971
         NC    QCBFFEFO(3),QCBFFEFO .
         BNZ   TSTLFEFO .               BR IF ONE THERE         SA52971
         MVC   QCBFFEFO(3),AVTSAVE2+65 .SET FEFO                 A49211
* THIS MOVE CANNOT BE DONE EARLIER SINCE THERE MAY BE NO CPBS    A49211
TSTLFEFO EQU   * .                                              SA52971
         NC    QCBPFEFO(3),QCBPFEFO .   SCAN START POINT SET    SA52971
         BNZ   WRFEFO .                 BR YES                  SA50192
         MVC   QCBPFEFO(3),AVTSAVE2+65 .SET FOR FIRST TIME      SA52971
         MVC   QCBPREVF(3),AVTSAVE2+65 .SET FOR FIRST TIME      SA52971
         OI    QCBDATFL,DATIFEFO .      SET INITIAL FEFO        SA50192
         TM    PRFSTAT1,PRFNHDRN .      TEXT BFR                SA50192
         BO    SETDATFL .               BR YES                  SA50192
         SPACE
         BAL   R14,CPBFREEA .           GO LET CPB GO           SA52971
         B     SETLFEFO .               SET LAST FEFO POINTER    A49211
SETDATFL EQU   * .                                              SA50192
         XC    DATFLAGS(6),DATFLAGS .   CLEAR DATA FIELD        SA50192
         MVC   DATFLAGS,QCBDATFL .      SET DATA FLAGS          SA50192
         BAL   R11,EXCPINQ1 .           GO ENQUEUE CPB          SA50192
         B     SETLFEFO .               SET LAST FEFO POINTER   SA50192
         SPACE
WRFEFO   EQU   * .
*        IF ONLY 1 THERE THE MSG COULD HAVE BEEN READ BUT THE
*        FEFO PTR MAY NOT BE UPDATED YET , SO THE SCB IN WHICH
*        THE FEFO PTR WAS SAVED MUST BE UPDATED.
         ST    R15,AVTSAVE2+4 .         SAVE                    SA52971
         ST    R8,AVTSAVE2 .            SAVE R8
         LR    R8,R9 .                  SET PQCB FOR SUBR
         LA    R9,QCBLFEFO .            PASS PTR TO FEFO TO CHNGSA52971
         LA    R10,AVTSAVE2+65 .        PASS PTR TO NEW FEFO    SA52971
         L     R15,AVTHM02 .            FIND HM03 FROM HM02 - 4
         SH    R15,AVTHA4 .
         L     R15,0(R15) .             ADDR HM03
         BALR  R14,R15 .
         LR    R9,R8 .                  RESTORE                 SA52971
         L     R8,AVTSAVE2 .            RESTORE RTN REG
         L     R15,AVTSAVE2+4 .         RESTORE                 SA52971
         AIF   (&A EQ 2).F010A
         TM    QCBDSFLG,QCBCORE .       CORE ALSO
         BNO   NOCORE .                 BR NO
         NC    QCBCFHDR(3),QCBCFHDR .   IS ONE THERE
         BZ    NOCORE .                 BR NO
         MVC   AVTSAVE2+61(3),QCBCFHDR . ADDR FIRST IN Q         S21101
COREFEFO EQU   * .
         L     R2,AVTSAVE2+60         . MSG HDR                  S21101
         CLC   PRFCRCD-IEDQPRF(3,R2),QCBLFEFO .
*                   IS THIS THE MSG IN CORE TO PUT THE FEFO
*               PTR IN
         BE    SETCFEFO .               BR YES
         CLC   PRFNHDR-IEDQPRF(,R2),AVTFZERO                    SA51078
*                                       IS THIS THE LSAT MSG ON Q
         BE    NOCORE .
         MVC   AVTSAVE2+61(3),PRFNHDR-IEDQPRF(R2) . NEXTMSG      S21101
         B     COREFEFO .
SETCFEFO EQU   * .
         MVC   DATFEFO-IEDQDATA(3,R2),AVTSAVE2+65                S21101
.F010A   ANOP  , .                                              SA52971
NOCORE   EQU   * .                                              SA52971
         L     R2,CPBXREAF .
         MVC   CPBADDR+1(3),QCBLFEFO    FEFO PTR TO WRITE        S21101
         MVC   DATFLAGS(6),AVTSAVE2+64  SET DATA FIELD OF RECORD S21101
         BAL   R11,EXCPINQ1 .
SETLFEFO EQU   * .
         OI    PRFTIC,XBUFFER .         FEFO PTR HAS BEEN DONE
         MVC   QCBLFEFO(3),AVTSAVE2+65  UPDATE LAST FEFO         S21101
         AIF   (&A EQ 1).F010B                                   A42400
         TM    QCBDSFLG,QCBTSQ          TSO QUEUES               S22028
         BZ    LSTCB                    NO-BRANCH                S22028
         L     R14,AVTTSOPT             ADDR TSINPUT QCB        SA61768
         L     R14,TSIDEST-IEDQTSI(R14) ADDR HM STCB            SA61768
         B     FOUNDHM                  FOUND HM STCB            S22028
LSTCB    DS    0H                                                S22028
         L     R14,QCBSTCHN-1           ADDR OF FURST STCB      SA61768
CLI08    EQU   * .                                               A42400
         CLI   0(R14),DSPMCPL6          IS THIS HM STCB         SA61768
         BE    FOUNDHM .                BE YES                   A42400
         L     R14,4(R14)               ADDR OF NEXT STCB       SA61768
         B     CLI08 .                  IS THIS IT               A42400
FOUNDHM  EQU   * .                                               A42400
         LR    R0,RBASE                 SAVE BASE REG           SA61768
         LA    RBASE,6(R14)             SET HM BASE             SA61768
         L     R2,0(R14)                ADDR OF FIND STCA IN HM SA61768
         BALR  R14,R2                   HM WILL SAVE & REST REGSSA61768
         LR    RBASE,R0                 RESTORE BASE            SA61768
.F010B   ANOP                                                    A42400
         BR    R8 .
.F011    ANOP
         TITLE '''IEDQFQ'' - CPB CLEANUP' .                      S22025
*        CONTROL RECEIVED HERE WHEN CPB'S HAVE BEEN FREED BY DISKS21101
*        END APPENDAGE AND THE QCB POSTED TO ITSELF, OR A BUFFER
*        UNIT WAS POSTED BECAUSE AN EARLIER OPEARTION WAS OUT
*        OF BUFFER UNITS
         SPACE 3
         DC    C'IEDQFQ' .
IEDQFQ   DS    0H .
***********************************************************************
*
*        STCB FOR CPB CLEANUP QCB
*
         DC    AL1(DSPMCPL2) .
         DC    X'00' .
*                                                                     *
***********************************************************************
CPBCLNUP EQU   * .
         USING *,R15 .
         L     RBASE,BASE .
         DROP  R15 .
         USING IEDQCPB,R15 .
         AIF   (&A NE 1).F012
         B     CALLBUFF .
         AGO   .F013
.F012    ANOP
         LA    R7,0(R7) .               CLEAR HI
         LA    R1,0(R1) .               CLEAR HI
         CLR   R1,R7 .
*            WAS THE ELEMENT POSTED THE QCB
         BNE   CALLBUFF .
         MVI   QCBPRI,AVTEZERO .        WET THE NOT POSTED FLAG
*                                       FOR DISK END APPENDAGE
         SPACE 3
*        PUT ANY WRITE CPB'S BACK IN THE FREE POOL, AND PUT READ
*        CPB'S ON THE ENABLED QUEUE.
         SPACE 3
EMTYAPPQ EQU   * .
         LA    R1,AVTDKAPQ .            APP. CPB Q
         BAL   R14,DEQMGRC .
         B     APPQEMTY .                IF NONE THERE
         EJECT ,                                                 99226
*                                                                99226
* WHEN THE CPB COMES BACK FROM APPENDAGE, A TEST IS MADE TO      99226
* DETERMINE IF THERE WAS A DISK ERROR.  IF SO IT PICKS UP A      99226
* WTO ROUTINE IN IGG019RC TO HANDLE IT                           99226
*                                                                99226
CPBER    EQU   X'01' .                  CPB FLAG FROM DISK ERROR 99226
         TM    CPBFLAG,CPBER .          DID CPB HAVE I/O ERROR   99226
         BZ    GOODCPB .                  NO, GOOD CPB           99226
*                                         YES, I/O ERROR         99226
         LR    R7,R15 .                 GET CPB FOR WTO          99226
         L     R15,AVTFL .              GET ADDRESS OF IGG019RC  99226
         L     R15,4(,R15) .             GET 2ND WORD OF RC      99226
         BALR  R14,R15 .                CALL DISK ERROR WTO RTN  99226
*                                                                99226
         LR    R15,R7 .                 RESTORE CPB BASE         99226
GOODCPB  EQU   *                                                 99226
         TM    CPBSEEK,X'80' .          THIS ONE FIXED
         BO    PUTONENQ .
         LA    R14,EMTYAPPQ .
         BAL   R11,CKWRITE .
PUTONENQ EQU   * .
         LA    R2,AVTDKENQ .            ENABLED Q
         LA    R11,EMTYAPPQ .            SET RETN ADDR
         B     ENQMGRC .
APPQEMTY EQU   * .
         LA    R1,AVTDKENQ .            ENABLED Q
         BAL   R14,DEQMGRC .
         B     CPBSGONE .               IF NONE THERE
         TM    CPBFLAG,CPBER            CPB HAVE I/O ERROR      SA61800
         BZ    GOODCPB1                 BR NO                   SA61800
         LR    R7,R15                   GET CPB FOR WTO         SA61800
         L     R15,AVTFL                ADDR OF IGG019RC        SA61800
         L     R15,4(,R15)              ADDR OF WTO RTN IN 19RC SA61800
         BALR  R14,R15                  CALL DISK ERROR WTO RTN SA61800
*                                                               SA61800
         LR    R15,R7                   RESTORE CPB BASE        SA61800
GOODCPB1 EQU   *                                                SA61800
         TM    CPBSEEK,X'80' .          THIS ONE FIXED
         LA    R11,CALCKERB .
         BCR   ONES,R11 .                                        S21101
         LA    R14,APPQEMTY .
         B     CKWRITE .
CPBSGONE EQU   * .
         SR    R0,R0 .                  CLEAR R0 FOR POST REG
         B     PROCESS .                                         S21101
CKWRITE  EQU   * .
         OI    CPBSEEK,X'80' .          FLAG FIXED
         TM    CPBRDWR,CPBWRITB .
*                  IS THIS A WRITE OF ANY KIND
         BO    CPBFREEA .
         BR    R11 .
.F013    AIF   (&A EQ 1).F016
EXCPINQ1 EQU   * .
         LA    R14,ENQMGRC .            ADDR OF Q MGR
         B     EXCPINPT .
.F016    ANOP
CALLBUFF EQU   * .
         L     RBASE,ADRFA01 .           RESET BASE REG
         DROP  RBASE .
         USING IEDQFA01,RBASE .
         B     BUFFER .                  AND ADJUST ADDRESSIBILITY
         DROP  RBASE .
         USING CPBINIT,RBASE .
         AIF   (&A EQ 1).F017
CALCKERB EQU   * .
         L     RBASE,ADRFA01 .
         DROP  RBASE .
         USING IEDQFA01,RBASE .
         B     CKERB .
TRANSFER EQU   * .
         MVC   PRFSUNIT-1(0),PRFSUNIT-1-IEDQPRF(R10) .
.F017    ANOP
         USING CPBINIT,RBASE .
         TITLE '''IEDQFA'' - ERB' .                              S22025
*        AN ERB HAS BEEN POSTED REQUESTING A MESSAGE - THIS SECTION
*        WILL DETERMINE THE TYPE OF REQUEST, HOW MUCH DATA IS NEEDED
*        AND WHETHER TO GET IT FROM DISK OR CORE QUEUES.
         SPACE 3
ERB      EQU   * .
         LR    RLCB,RPREFIX .
         SH    RLCB,DCH .
         L     RSCB,LCBSCBA-1           SCB ADDR                SA52971
         TM    LCBERBST,LCBERROR .      TRANS ERROR ON SEND
         BNO   NOERROR .                BR IF NO ERROR
ERBERROR EQU   * .                                               A44866
         L     RBASE,ADRFA01 .          SET SECOND BASE REG
         BAL   R5,FREEBFRS-IEDQFA01(RBASE)
*        FREE ATTACHED BFRS IF ANY
ADRTAG   EQU   * .                      LABEL FOR ADDRESSIBILITY
         L     R2,LCBRCQCB .       SET TO POST THE ERB TO
         LA    R2,AVTEZERO(R2)          CLEAR HI BYTE           SA54262
         LA    R1,LCBERB .         THE SPECIFIED QCB
         MVI   LCBERBPY,PRIDSPLB-1 .    SET PRIORITY FOR POST    A44866
         LA    R14,CALLPROC-ADRTAG(R5) .  SET RTN
         B     POST-ADRTAG(R5) .        POST THE ERB
NOERROR  EQU   *
         CLI   LCBERBPY,PRIINTRQ .      INITIAL REQUEST          A41025
         BNE   QTYPSET .                BR NOT INIT              A41025
         NC    LCBERBCH(3),LCBERBCH .   ANY BFRS THERE           A41025
         BNZ   QTYPSET .                BR IF BFRS THERE         A41025
         NI    SCBQTYPE,X'0F' .         CLEAR FOR LATER TEST FOR A41025
*                                       HDR READ                 A41025
QTYPSET  EQU   *                                                 A41025
         MVI   SCBCPBNO,AVTEZERO .
         MVI   SCBNXCPB,EONE .          SET NO OF NEXT CPB TO GET
         XC    AVTDOUBL(7),AVTDOUBL .    CLEAR WORK AREA
*        THE ERBPY FIELD WILL SERVE AS A FLAG - IF IT IS NON ZERO
*        A BUFSIZE MUST BE PLACED IN ERBQB+1.  IF THE KEY
* IS ZERO THE SIZE IS THERE.
         LA    R7,SZTHERE .             SET RTN ADDR
         TM    LCBSTAT1,LCBRCLLN .      IF THIS A RECALL - NOT
         BCR   ONES,R7 .                TO BE COMPUTED NOW       S21101
         CLI   LCBERBKY,AVTEZERO .
         BCR   EQUAL,R7 .               BR IF ALREADY DONE       S21101
         NC    LCBERBCH(3),LCBERBCH .   ARE BUFFERS THERE
         BCR   ZERO,R7 .                BR IF NO BUFFER YET      S21101
*              COMPUTE ZIZE YET
         L     RPRF,LCBERBCH-1 .
         B     OFFSET .                 RTN SET ALREADY
SZTHERE  EQU   * .
         OI    LCBERBCT+1,XXCTUSED .    FLAG FOR APPENDAGE
         IC    R7,LCBERBCT+1 .          DISABLED CT
         MVI   LCBERBCT+1,AVTEZERO .    ZERO CT
         LA    R7,4096-XXCTUSED(R7) .   CLEAR HI BIT OF LOW BYTE
         IC    R2,LCBERBCT .            ENABLED CT
         AR    R2,R7 .                  ADD CTS
         STC   R2,LCBERBCT .            SET NEW CR
         L     RSCB,LCBSCBA-1 .
         BAL   R14,FINDESTQ .
         TM    LCBSTAT1,LCBRCLLN .      RECALL ?
         BO    RECALL .                 BR YES
         AIF   (&A NE 3).F026
         TM    QCBDSFLG,QCBCORE .
*                 IS THERE A CORE COPY
         BNO   DISKONLY .               BR NO
.F026    AIF   (&A EQ 2).F027
         TM    LCBERBST,XRDERR .         INIT AND NTXT NOT THERE
         BO    FIXSCSEG .
         CLI   LCBERBPY,PRISBPCI .     SB PCI REQ
         BNE   INITREQ .               BR NO TO GET ALL BFRS
CKPREV   EQU   * .
         AIF   (&A NE 1).F026A
         B     CALLFQ .
         AGO   .F028
.F026A   ANOP
         TM    SCBQTYPE,SCBCOREQ .      DID THIS MSG COME FROM CORE
         BO    CALLFQ .                 BR YES
.F027    ANOP
         SPACE 3
*        WILL BUILD CPB'S FOR A DISK READ
         SPACE 3
DISKONLY EQU   * .
         NI    LCBERBST,X'FF'-LCBRDERR ..   RESET ERROR BIY
         XC    AVTDOUBL+3(5),AVTDOUBL+3 INITIALIZE
* TH SCSEG AND SCHDR FIELDS ARE SET BE SND SCH OR GET SCH.  IF A HDR
*    IS NOT EXPECTED NEXT SCHDR IS NOT INITIALIZED. SCSEG IS ALWAYS
*    INITIALIZED TO THE NEXT SEG TO READ FOR SCHEDULER
         L     R9,SCBSCSEG-1 .          ADDR OF CURRENT SEG
         LA    R2,1 .
         TM    SCBQTYPE,X'70' .         IF QTYPE NOT ALREADY SET -
         BZ    HDRNEXT1 .               A HDR IS EXPECTED NEXT
         CLC   SCBSCSEG(3),SCBCRCD .    HAS THIS RECORD (IF IT HAS
*   A PREFIX) BEEN READ BEFORE?     ----  IF THE LAST BFR FILLED
*   WAS FILLED WITH DATA FROM WITHIN THIS PRFX RECORD AND COMPLETED
*   A REQUEST - TOO MUCH DATA WILL BE READ  SINCE IT IS OTHERWISE
*   ASSUMED THAT THE PRFX WAS READ ON A PREVIOUS OPERATION.
         BE    HDRNEXT .M               BR IF READ TO READ ONLY
*   THIS RECORD AND NO MORE.
*        SCBCPBNO IS THE NO, OF CPBS BUILT TO READ AND THE NO.
*        LEFT TO GET FROM APPENDAGE
*        SCBNXCPB IS THE NO. OF THE CPB THAT IS EXPECTED NEXT
*   CPBBFRNO CONTAINS THE NUMBER FO THE LOGICAL BFR IN WHICH THE
*        FIRST BYTE OF DATA IN THE UNIT IS TO BE PLACED.
*   CPBBFRCT CONTAINS THE NUMBER OF THE BYTE IN THE LAST UNIT
*        OF THE LAST BFR IN WHICH THE FIRST BYTE OF DATA IS PLACED.
*   CPBWKACT CONTAINS THE NUMBER OF TH BYTE IN THE CPB WORK AREA
*        WHICH IS TO BE THE FIRST BYTE TRANSFERRED.
*   CPBNUMB CONTAINS THE NUMBER OF THE CPB FOR THIS ERB.
*    AVTDOUBL+3 HAS THE NO. OF UNITS REQUESTED SO FAR
*    AVT DOUBL +4 HAS THE NO, OF UNITS IN 1 BFR
*   AVTDOUBL+5 HAS WKACT
*     WKACT SHOULD BE 0 EXCEPT FOR FISRT RECALL  , FIRST READ OR SBPCI
*   AVTDOUBL+6 HAS NUMB
*   AVTDOUBL+7 HAS BFRNO
*                           SCBUNTCTILL HAVE WHERE IN THE NEXT UNIT
*        TO BE READ FROM SIDK DATA TRANSFER WILL START.
         TM    SCBSTAT1,PRFNLSTN .      LAST SEG
         BNO   FIXNTXT .                BR YES
FIXED    EQU   * .
         MVC   AVTDOUBL+5(1),SCBUNTCT .CT OF BYTE TO READ
         L     R10,LCBDCBPT .           DCB ADDR
         MVC   AVTDOUBL+4(1),LCBERBQB . NO UNITS PER BFR
         NC    LCBERBCH(3),LCBERBCH .   ARE THERE ANY BFRS
         BZ    TRYNEXT .                BR NO
         LA    R6,LCBERBLK-1 .
         L     R14,AVTDOUBL+4 .         GET BFR NO
COUNT    EQU   * .
         NC    PRFLINK(3),PRFLINK .     IS THIS THE LAST BFR
         BZ    LASTUNIT .               BR YES
         L     R6,PRFLINK-1 .           NEXT BFR
         AR    R14,R2 .                 ADD 1 TO BFR NO
         ST    R14,AVTDOUBL+4 .
         B     COUNT .
LASTUNIT EQU   * .
         IC    R14,PRFNBUNT .           NO OF UNITS IS BFR
         MVI   AVTDOUBL+3,AVTEZERO .    SET NO REQD UNITS TO 0
         EX    R14,CLINOUNT .           NO IN 1 BFR = NO FOR BFR
         BE    TRYNEXT .                BR YES
         IC    R10,AVTDOUBL+4 .         NO. TO BE PUT IN BFR
         SR    R10,R14 .                - NO THERE ALREADY
         BCTR  R10,0 .                  -1
         STC   R10,AVTDOUBL+3 .         = NO UNITS REQD SO FAR
TRYNEXT  EQU   * .
         BAL   R14,READCPB .
*            RECORED TO BE READ.
*   THE NEXT TEXT IS THE LAST RECORD THAT CAN BE READ UNTIL THE
*   NEXT PREFIX HAS BEEN READ.  THE NTXT IS ALWAYS A HIGHER VALUE
*   OF ADDRESS THAN THE ADDITIONAL RECORDS.
*   THIS ERB SHOULD BE DROPPED NOW AND BEGIN PROCESSING THE NEXT
*   ELEMENT.
         CLC   SCBSCSEG(3),SCBNTXT .    HAS THE NEST TXT BEEN
*                                         READ
         BH    PROCESS .                BR YES(SCSEG=LAST ADDR +1)
         L     R14,AVTDOUBL .           ADD 1 TO NO UNITS
         AR    R14,R2 .                 REQUESETD SO FAR
         ST    R14,AVTDOUBL .
         EX    R14,CLINOUNT .           R14 HAS NO OF UNITS THAT
*        HAVE BEEN READ - COMPARE TO THE NO. TO READ IN DOUBL+4
         BNE   TRYNEXT .                BR IF MORE TO READ FOR 1 BFR
         CLI   LCBERBPY,PRISBPCI .     SB PCI REQ
         BE    PROCESS .                BR YES
*   IF THIS IS NOT AN INITIAL REQ OF RIRST SUBSEQUENT REQ ONLY
*   ONE BFR AT A TIME SHOULD BR FILLED.
         L     R14,AVTDOUBL+4 .         ADD 1 TO NO OF BFRS THAT
         AR    R14,R2 .                 UNITS HAVE BEEN READ FOR
         ST    R14,AVTDOUBL+4 .
         MVI   AVTDOUBL+3,AVTEZERO .    SET NO UNITS REQD =0 FOR NEW
         EX    R14,CLIREQ .             HAS THE NO. OF BFRS REQ-
*        UESTED BEEN FILLED
         BH    TRYNEXT .                BR NO
         B     PROCESS ..               BR YES
CLIREQ   CLI   LCBERBCT,X'00' .
CLINOUNT CLI   AVTDOUBL+4,X'00' .
READCPB  EQU   * .
         L     R15,AVTFCPB .             ADDR OF FIRST IF ONE THERE
         LA    R15,0(R15) .              CLEAR HI BYTE
         LTR   R15,R15 .                ANY THERE
         BZ    CKENQ .                  BR NO
         MVC   AVTFCPB+1(3),CPBNEXT .
         ST    R14,CPBSEEK .            KEEP RTN ADDR
         IC    R14,CPBADDR .                                     S21101
         ST    R9,CPBADDR .             SET ADDRESS              S21101
         STC   R14,CPBADDR .                                     S21101
         ST    RLCB,CPBAERBF .          SET LCB ADDR FOR THIS READ
         IC    R14,SCBCPBNO .           NO OF LAS< CPB
         AR    R14,R2 .                 PLUS 1
         STC   R14,SCBCPBNO .
         XC    CPBINWKA(5),CPBINWKA .
         STC   R14,CPBNUMB .            SET NUMBER OF CPB
         LA    R9,INCR(R9) .            ADD FOUR TO REC. NO.     S21101
         IC    R11,SCBSCSEG-1 .         SAVE HI BYTE
         ST    R9,SCBSCSEG-1 .          KEEP REC NO
         STC   R11,SCBSCSEG-1 .         RESTORE HI BYTE
         MVI   CPBRDWR,CPBRDKC .        READ K & D
         MVI   CPBXDWR,CPBRDC .         READ DATA
         BAL   R11,EXCPINQ2 .           PUT CPB ON INPUT Q
         LA    R2,1 .                   RESET R2
         L     R14,CPBSEEK .            RESTORE RETURN
         BR    R14 .
.F028    AIF   (&A EQ 1).F029
CKENQ    EQU   * .
         CLI   SCBCPBNO,AVTEZERO .      HAVE ANY CPBS BEEN GOTTEN
         BNE   CALLEXCP .               FOR THIS REQ. BR YES
         LA    R6,LCBERB .              NO - RE-ENQ THE ERB
         B     ENQUEUE .
.F029    AIF   (&A EQ 1).F033
FIXNTXT  EQU   * .
*    SINCE THERE IS NO NTXT, THE LAST ADD.REC. WILL BE IN NTXT
         MVI   AVTDOUBL,AVTEZERO .
         MVC   AVTDOUBL+1(3),SCBXTRA .
         MVC   SCBNTXT(3),SCBCRCD .
         L     R10,AVTDOUBL .
         LTR   R10,R10 .
         BZ    FIXED .                  BR IF NO XTRA RECORDS
         BAL   R14,SBTRKEY1 .
         SH    R10,CONST .              ADJUST R10               S21101
         ST    R10,AVTDOUBL .           LAST XTRA FOR NTXT
         MVC   SCBNTXT(3),AVTDOUBL+1 .
         B     FIXED .
CONST    DC    H'8' .                   CONSTANT                 S21101
HDRNEXT1 EQU   * .
         BAL   R14,READCPB .            GET A CPB                A44895
         BAL   R14,QTYPE .              SET QTYPE                A44895
         B     PROCESS .                CONTINUE                 A44895
HDRNEXT  EQU   * .
         BAL   R14,READCPB .
         B     PROCESS .
         SPACE 3
.F033    ANOP
QTYPE    EQU   * .
         MVI   SCBUNTCT,AVTEZERO .      SET START CNT TO FIRST
         AIF   (&A EQ 2).F034
         OI    SCBQTYPE,SCBCOREQ .      SET FLG FOR CORE READ
         AIF   (&A EQ 1).F035
         TM    QCBDSFLG,QCBCORE .
         BCR   ONES,R14 .                                        S21101
.F034    ANOP
QTYPE1   EQU   * .
         NI    SCBQTYPE,X'0F' .         CLEAR QTYPE
         OI    SCBQTYPE,SCBREUS .       ASSUME REUS DISK
         TM    QCBDSFLG,QCBREUS .
         BCR   ONES,R14 .                                        S21101
         XI    SCBQTYPE,SCBREUS+SCBNREUS .
.F035    ANOP
         BR    R14 .
         AIF   (&A EQ 2).F036
*        WILL INITIALIZE TO GET A MESSAGE FROM A CORE Q
         SPACE 3
INITREQ  EQU   * .
         TM    SCBQTYPE,X'70' .         HAS QTYPE BEEN SET ALREADY -
         BNZ   CKPREV .                 BR YES - ONE READ DONE FOR
*        THIS MSG LAREADY
         OI    SCBQTYPE,SCBCOREQ        ASSUME CORE             SA59522
         AIF   (&A NE 1).F035A
         B     CALLFQ .
         AGO   .F036
.F035A   ANOP
         TM    QCBDSFLG,QCBREUS+QCBNREUS . ANY DISK
         BZ    CALLFQ .                 BR NO
         MVC   AVTDOUBL+1(3),QCBCFHDR . YES- FIND CORE COPY OF MSG
COMPARE  EQU   * .
         NC    AVTDOUBL+1(3),AVTDOUBL+1 . LAST MSG
         BZ    NOMSG .                  BR YES
         L     R2,AVTDOUBL .            ADDR THIS MSG
         CLC   SCBSCHDR(3),PRFCRCD-IEDQPRF(R2) .
*                  IS THIS THE MSG  TO SEND
         BE    LOSTMSG1 .               TO CHECK FOR LOST MSG
         MVC   AVTDOUBL+1(3),PRFNHDR-IEDQPRF(R2) .  NEXT MSG
         B     COMPARE .
LOSTMSG1 EQU   * .
         TM    DATFLAGS-IEDQDATA(R2),DATLOSTN .  LOST MSG
         BNO   RESETSCH .               BR NOT LOST TO GET FROM CORE
*        OTHERWISE FREE MSG FROM CORE Q AND SET TO READ FROM DISK
         LR    R6,R2 .                  SET FAKE BFR ADDR
         L     R15,ADFREEMS .           BASE FOR SUBR
         BAL   R7,HAVEADDR-FREEMSG(R15) .   ENTRY PT FOR THIS
         L     RSCB,LCBSCBA-1 .         RESTORE SCB ADDR
         L     R7,SCBDESTQ-1 .          RESTORE QCB ADDR
NOMSG    EQU   * .
         NI    SCBQTYPE,X'FF'-SCBCOREQ  RESET CORE BIT          SA62976
         XC    AVTDOUBL(6),AVTDOUBL .   CLEAR WORK AREA
         L     R9,SCBSCSEG-1 .
         LA    R2,1 .
         BAL   R14,READCPB              GET A CPB               SA59522
         BAL   R14,QTYPE1               SET QUING MEDIUM        SA59522
         B     PROCESS                  PROCESS NEXT ELEMEMT    SA59522
.F036    ANOP
RECALL   EQU   * .
         MVC   SCBSCSEG(3),SCBDEOB+1 .  SET FIELDS FROM RECALL
         ST    R7,AVTDOUBL .            SAVE R7
         IC    R7,SCBDEOB .             TO LOOK NORMAL
         STC   R7,SCBUNTCT .
         LA    R7,NOSIZE .                SET RTN ADDR
         TM    LCBSTAT1,LCBRECVN .      RECV SIDE
         BCR   ONES,R7 .                BR YES - RECALL BFR THAT S21101
*                                       IS THERE - DO NOT CHANGE S21101
*                                       THE DSIZE                S21101
*        THERE - DO NOT CHANGE THE DSIZE
         TM    LCBCHAIN,LCBBFRSZ .      SPECIAL BD RECALL
         BCR   ONES,R7 .                                         S21101
         CLI   LCBERBKY,AVTEZERO .     HAS SIZE BEEN COMPUTED
         BNE   USELCB .                 SEND REQUEST
NOSIZE   EQU   * .
         L     R7,AVTDOUBL .            RESET R7
         TM    SCBQTYPE,X'F0' .         IS THIS A FIRST RECLL
         BZ    FIRSTRCL .               FROM ANYBODY BUT BT
         NC    LCBERBCH(2),LCBERBCH .   ANY BFRS THEER
         AIF   (&A NE 2).F037
         BNZ   DISKONLY .
         AGO   .F037A
.F037    ANOP
         BNZ   CKPREV .                 BR YES - ONE READ DONE
.F037A   ANOP
         AIF   (&A EQ 1).F038A
         AIF   (&A EQ 2).F038
         TM    SCBQTYPE,SCBCOREQ .
         BNO   OKREUS .                 BR NOT CORE
*        THIS IS A FIRST RECALL FROM BT
.F038A   ANOP
         TM    LCBSTAT1,LCBSENDN .      SENDING
         BO    BTSEND .                 BR YES - ADDR OF HDR IS THERE
         AIF   (&A NE 3).F038B
         TM    QCBDSFLG,QCBREUS+QCBNREUS .  ANY DISK
         BNZ   NOMSG .                  RECALL ON RCV SIDE - GET
*     FROM DISK
.F038B   ANOP
         MVC   SCBSCHDR(3),SCBCCHDR .   GET ADDR OF HDR
BTSEND   EQU   * .
         L     R2,SCBSCSEG-1 .          ADDR OF UNIT TO GET
         TM    DATFLAGS-IEDQDATA(R2),DATNPRFX . DOES IT HAVE PRFX
         BNO   CALLFQ .
         L     R6,SCBSCHDR-1 .          HDR ADDR
BTTIC    EQU   * .
         LR    R2,R6 .                  SET FOR LOOP TO FIND PRFX THAT
         B     BTTIC2 .                 GOES WITH THIS EXTRA UNIT
BTTIC1   EQU   * .
         L     R2,PRFTIC-IEDQPRF(R2) .  ADDR NEXT UNIT
BTTIC2   EQU   * .
         NC    PRFTIC+1-IEDQPRF(2,R2),PRFTIC+1-IEDQPRF(R2) . MORE THERE
         BZ    BTBFR .                  BR NO TO GET NEXT BFR
         CLC   PRFTIC+1-IEDQPRF(3,R2),SCBSCSEG . THIS IT
         BNE   BTTIC1 .                 BR IF NOT THE ONE
         LH    R2,SCBSCAN .             SAVE SEQ OUT NO
         MVC   SCBSRCE(PRFSTXT-PRFSRCE),PRFSRCE .  SET PRFX FOR BFR
         STH   R2,SCBSCAN .             SAVE SEQ OUT NO
         OI    SCBSTAT1,PRFNHDRN .      INSURE NOT A HDR BFR
         B     CALLFQ .
BTBFR    EQU   * .
         MVC   AVTDOUBL+1(3),PRFNTXT .  GET NEXT BFR IN QUEUE
         L     R6,AVTDOUBL .
         B     BTTIC .
         AGO   .F039
.F038    ANOP
         B     OKREUS .
.F039    ANOP
FIRSTRCL EQU   * .
         AIF   (&A NE 1).F040
         OI    SCBQTYPE,SCBCOREQ .
         B     CKTHERE .
         AGO   .F040A
.F040    ANOP
         LA    R1,QCBDSFLG .            ASSUME NOT BD
         LA    R2,X'10' .               SET CC FOR EX BRANCH
         TM    LCBCHAIN,LCBBFRSZ .      BD RCLL
         BNO   NOTBD .                  BR NO
         LA    R1,SCBHBFNO .            SET TO TEST DCB NOT QCB
         LA    R2,X'80' .               SET CC FOR BR
NOTBD    EQU   * .
         AIF   (&A EQ 2).F039A
         OI    SCBQTYPE,SCBCOREQ .      SET FOR CORE RECALL
         TM    0(R1),QCBREUS+QCBNREUS .   ANY DISK
         BZ    CKTHERE .
PUTRET   EQU   *                                               @SA69655
         NI    SCBQTYPE,X'FF'-SCBCOREQ .SET NOT CORE
.F039A   ANOP
         OI    SCBQTYPE,SCBREUS .       SET RES DISK
         TM    0(R1),QCBREUS .
         AIF   (&A NE 3).F039A1                                @OZ14195
BRNCHQ   EQU   *                                               @OZ14195
.F039A1  ANOP                                                  @OZ14195
         EX    R2,BRANCH .
         XI    SCBQTYPE,SCBREUS+SCBNREUS .
OKREUS   EQU   * .
         L     R9,SCBSCSEG-1 .           RECORD TO READ
         LA    R2,1 .                   INITIALIZE R2 FOR ADDS
         MVC   AVTDOUBL+5(1),SCBDEOB .
         B     HDRNEXT .
BRANCH   NOP   OKREUS .                 COND CODE FILLED BY EX   S21101
.F040A   ANOP
         AIF   (&A EQ 2).F040B
CKTHERE  EQU   * .
         AIF   (&A EQ 1).F040A1                                @SA69655
         CLI   QCBDSFLG,QCBFQCB         PUT PROCESS ENTRY      @SA69655
         BE   PUTRET                   NO, BRANCH              @SA69655
         NC    LCBTTCIN,LCBTTCIN        TTCIN ZERO?            @OZ14195
         BNZ   CALLFQ                   NO                     @OZ14195
         TM    LCBSTAT2,LCBDIAL         DIAL LINE              @OZ14195
         BO    CALLFQ                   YES                    @OZ14195
         TM    LCBCHAIN,LCBBFRSZ        BD RECALL              @OZ30296
         BO    CALLFQ                   YES, BRANCH            @OZ30296
*        THIS CODE WILL ALLOW THE CAPABILITY TO RETRIEVE A     @OZ14195
*        MESSAGE BY INPUT SEQUENCE NUMBER FOR A TERMINAL THAT  @OZ14195
*        IS CORE QUEUED.                                       @OZ14195
         OI    SCBQTYPE,SCBREUS         SET REUS               @OZ14195
         NI    SCBQTYPE,AVTEFF-SCBCOREQ TURN OFF CORE BIT      @OZ14195
         TM    SCBSCSEG+TWO,CPBQTYPE    CHECK TYPE OF QUEUES   @OZ14195
         B     BRNCHQ                   GO SET APPROPRIATE BIT @OZ14195
.F040A1  ANOP                                                  @SA69655
CALLFQ   EQU   * .
         L     RBASE,ADRFA01 .
         B     CALLFQA-IEDQFA01(RBASE) .
.F040B   ANOP
         AIF   (&A NE 3).F040C
RESETSCH EQU   * .
         L     RBASE,ADRFA01 .
         B     RESETA-IEDQFA01(RBASE) .
.F040C   ANOP
ADRFA01  DC    A(IEDQFA01) .
EONE     EQU   X'01' .
BASE     DC    A(CPBINIT) .
         DROP  RBASE .
         TITLE '''IEDQFA'', ''IEDQFQ'' - COMMON SUBROUTINES' .   S22025
         USING *,RBASE .
*        THIS SPECTION IS A GOUUP OF COMMON SUBROUTINES USED BY
*        BOTH SECTIONS OF CODE.
         SPACE 3
IEDQFA01 EQU   * .
         AIF   (&A EQ 1).F018
CPBFREE  EQU   * .
         LA    R14,GOAPQEMT .            SET RTN ADDR
*    WILL FREE CPB - NO CHECKING - RETURN
CPBFREEA EQU   * .
         L     R1,AVTFCPB .             LINK CPB INTO THE
         ST    R15,AVTFCPB .            CPB FREE POOL
         ST    R1,CPBNEXTF .
         MVI   CPBFLAG,AVTEZERO .       ZERO ALL FLAGS
         BR    R14 .                    RETURN
.F018    ANOP
ENQMGRB  EQU   * .
         BALR  R14,0 .
         USING *,R14 .                                           S21101
         L     R14,ADENQMGR .
         BR    R14 .
         DROP  R14 .                                             S21101
OFFSET   EQU   * .
         BALR  R15,0 .                  SET ADDRESSIBLITY
         USING *,15 .
         L     R15,ADROFFST .           ADDR OF SUBROUTINE
         BR    R15 .
USELCB   EQU   * .
         BALR  R15,0 .                  SET ADDRESSIBLITY
         USING *,15 .
         L     R15,ADROFFST .           ADDR OF SUBROUTINE
         USING IEDQCPB,R15 .
         B     USELCBA-OFFSETA(R15) .
         AIF   (&A EQ 1).F040D
ENQMGRC  EQU   * .
         BALR  R14,0 .
         USING *,R14 .                                           S21101
         L     R14,ADMGRX .
         BR    R14 .
         DROP  R14 .                                             S21101
ADMGRX   DC    A(ENQMGRCA) .
.F040D    ANOP
ADROFFST DC    A(OFFSETA) .
ADENQMGR DC    A(ENQMGRBA) .
DCH      DC    AL2(LCBERB-IEDQLCB) .
TAG1     EQU   * .
         AIF   (&A NE 1).F030
         B     CALPROC1 .
         AGO   .F032
.F030    AIF   (&A EQ 2).F031
         L     RSCB,LCBSCBA-1 .         SCB ADDRESS
         TM    SCBQTYPE,SCBCOREQ .      FROM CORE
         BO    CALPROC1 .               BR YES
.F031    ANOP
GOAPQEMT EQU   * .
         L     RBASE,BASE1 .            SET NEW BASE
         B     APPQEMTY-CPBINIT(RBASE) .
.F032    ANOP
CALLPROC EQU   * .
         L     RSCB,LCBSCBA-1 .
CALPROC1 EQU   * .
         L     RBASE,BASE1 .
         DROP  RBASE .
         USING CPBINIT,RBASE .
         SR    R0,R0 .                  CLEAR R0 FOR POST REG
         B     PROCESS .
         DROP  RBASE .
         USING IEDQFA01,RBASE .
.F032A   ANOP
UNITFREE EQU   * .
*        WILL POST A UNIT TO THE AVAILABLE BFR QUEUE
         MVI   PRFNBUNT-IEDQPRF(R1),X'01' .SET NO. UNITS
         MVI   PRFTIC-IEDQPRF(R1),CPBTICC .
RTNBFR   EQU   * .
         LA    R2,AVTBFRTB .            ADDR OF BFR RTN QCB
         MVI   PRFPRI-IEDQPRF(R1),PRIBFRTB .PRIORITY
POST     EQU   * .
         ST    R2,PRFQCBA-1-IEDQPRF(R1) FOR POST
NOSTORE  EQU   * .
         LA    R0,0(R1) .               DEEP ADDR LAST ELEM POSTED
         L     R11,AVTEA .
         B     DSPPOSTR .               POST AND RETURN
         AIF   (&A EQ 1).F019
EXCPINQ2 EQU   * .
*        WILL ENQUEUE A CPB ON THE FIFO EXCP INPUT Q
         BALR  R14,0 .
         USING *,R14 .
         L     R14,ADMGRCC .
         DROP  R14 .
EXCPINPT EQU   * .
         LA    R2,AVTINCPQ .            EXCP DRIVER INPUTQ
         LR    R1,R15 .                 CPB ADDR IN 1
         BR    R14 .
ADMGRCC  DC    A(ENQMGRC) .
.F019    ANOP
*        WILL BRANCH TO EXCP DRIVER IF ANY DISK OR DSPDISK OF NOT
CALLEXCP EQU   * .
         AIF   (&A EQ 1).F020
         BALR  R14,0 .                  SET ADDRESSIBILITY
         USING *,R14 .
         AIF   (&A EQ 2).F019A
         TM    AVTBIT1,AVTDISKN .       DISK SPEC.
         BZ    NOFL .                   BR NO
.F019A   ANOP
         ICM   R15,AD,AVTFL+1           IS DISK OPENED           Y02027
*        IF YES
         BCR   NOTZERO,R15 .                                     S21101
*        IS NO
NOFL     EQU   * .
.F020    ANOP
         L     R11,AVTEA .
         B     DSPDISP .
         AIF   (&A EQ 1).F021
         DROP  R14 .
.F021    ANOP
FINDLVL  EQU   * .                                              SA52971
*** THIS SUBROUTINE DESTROYS REGS 0,1,2, AND 11.  THE QCB       SA52971
*   EXTENSION IS RETURNED IN REG2.  RETURN IS TO +0 IF THIS     SA52971
*   IS NOT A CONCENTRATOR AND TO +4 IF IT IS A CONCENTRATOR.    SA52971
         TM    SCBQTYPE,SCBCONC .       IS THIS A CONCENTRATOR  SA52971
         BCR   8,R10 .                  BR IF NOT               SA52971
         LH    R2,QCBEXTO .             EXT OFFSET               S22026
         AR    R2,RQCB .                QCBE ADDR                S22026
         TM    QCBEFLG-IEDQQCBE(R2),QCBEOPL .                    S22026
*                                       PRTY LEVEL QUEUEING      S22026
         BZ    4(,R10) .                BR IF CONC              SA52971
         SR    R0,R0 .                  ZERO IC REG             SA52971
         LA    R11,QCBMEND-QCBPSIZE .   INIT TO ZEROETH PRI QCB SA52971
         BALR  R1,AVTEZERO .            SET LOOP POINT          SA52971
         SPACE 1 .                                              SA52971
         IC    R0,QCBELGTH-IEDQQCBE(,R2) GET EXTENSION LENGTH   SA52971
         AR    R2,R0 .                  POINT TO NEXT EXTENSION SA52971
         LA    R11,QCBPSIZE(,R11) .     POINT TO NEXT PRI QCB   SA52971
         CLR   R11,RPQ .                IS THIS THE ONE         SA52971
         BCR   7,R1 .                   NO, GO LOOK AT NEXT     SA52971
         B     4(,R10) .                RETURN TO +4            SA52971
FINDESTQ EQU   * .                                              SA52971
*        WILL FIND THE ADDRESS OF BOTH THE MASTER AND PRTY LVL QCBS
         L     RQCB,SCBDESTQ-1 .        ADDR OF QCB
         SR    R11,R11 .
         IC    R11,SCBPRI .              OFFSET TO PRTY QCB
FINDEST2 EQU   * .
         LA    RPQ,QCBMEND-IEDQQCB(RQCB) .
*              ADDR OF FIRST PRTY QCB
         LTR   R11,R11 .                IS THERE MORE THAN ONE
         BCR   ZERO,R14 .               BR NO                    S21101
         LA    R1,QCBPEND-IEDQPQCB .    SIZE OF A PQCB
         MR    R10,R1 .                 SIZE X NUMBER
         AR    RPQ,R11 .                ADDR OF THIS PQCB
         BR    R14 .
*        WILL DEQUEUE AND ELMENT FROM A FIFO Q
         AIF   (&A EQ 1).F025
DEQMGRC  EQU   * .
*        IN PUT PARAMETERS - R1 - Q ADDR
*        RETURN WILL BE AT R14 IF NONE OR 4(R14) IF ONE THERE
         DROP  RBASE
         USING CPBINIT,RBASE
         TS    AVTEZERO(R1)             LOCK Q FOR UPDATE        Y02027
         BNE   DEQMGRC                  YES, LOOP TILL APP. DONE Y02027
         ICM   R15,AD,1(R1)             ADDR OF FIRST ON Q       Y02027
         BNZ   DEQMGRC1                 ELEMENT ON Q             Y02027
         MVI   AVTEZERO(R1),AVTEZERO    CLEAR Q LOCK             Y02027
         BR    R14                      RETURN                   Y02027
DEQMGRC1 EQU   *                                                 Y02027
         DROP  RBASE
         USING IEDQFA01,RBASE
         MVC   1(3,R1),CPBNEXT .        DELINK THE CPB
         MVI   AVTEZERO(R1),AVTEZERO    CLEAR Q LOCK             Y02027
         B     4(R14) .                 RETURN TO +4 IF ONE THERE
SBTRKEY1 EQU   * .
         LH    R1,SCBSIZE .             GET SIZE
.F025    ANOP
SUBTRKEY EQU   * .
         BALR  R11,0 .                  SET ADDRESSIBILITY
         LA    R10,INCR(0,R10) .          INCREASE ADDRESS       S21101
         SH    R1,AVTKEYLE .            SUBTR. KEY LENGTH FROM SIZE
         BCR   PLUS,R11 .               BR IF PLUS TO SUBRT      S21101
         BR    R14 .                    BR IF ALL UNITS HAVE BEEN COUNT
         AIF   (&A EQ 2).F051 .                                 SA52971
ADFREEMS DC    A(FREEMSG) .             ADDR OF SUBROUTINE      SA52971
.F051    ANOP  , .                                              SA52971
*                                                               SA52971
*   END OF COMMON AREA                                          SA52971
*                                                               SA52971
         DC    40A(0)        XXXXXXXXXX PATCH AREA XXXXXXXXXXX @OZ09304
         TITLE '''IEDQFQ'' - CPB CLEANUP' .                      S22025
         AIF   (&A EQ 1).F041A
*        THIS SECTION DEALS WITH A CPB FROM A DISK READ.  IT HANDLES
*        ERROR CONDITIONS AND GETTING CPB'S OUT OR ORDER.
         SPACE 3
CKERB    EQU   * .
         L     RLCB,CPBAERBF .          ADDR OF ERB ASSOCIATED
*                                       WITH THIS READ
         L     RSCB,LCBSCBA-1 .
         LNR   R2,R2 .                 SET FLAG FOR FREE CPB
         TM    LCBERBST,XCOMPL .
*                   HAS THIS REQUEST BEEN COMPLETED PREVIOUSLY
         BO    ERBCPB .
         TM    LCBERBST,XXXINQ .        IS THIS ERB WAITING FOR BFR
         BO    NOBFRQ                   YES-PLACE CPB ON NOBFQ  SA52984
         CLC   CPBNUMB(1),SCBNXCPB .
         BE    CPBCK                    IF NEXT ONE GO AHEAD    SA52984
TSLOOP   EQU   *                                               @OZ09304
         TS    AVTDKENQ                 FIELD BEING USED       @OZ09304
         BNZ   TSLOOP                   YES, BRANCH AND LOOP   @OZ09304
         LA    R2,AVTDKENQ-(CPBNEXTF-IEDQCPB)  SET ADDRESS FOR @OZ09304
*                                        START OF LOOP         @OZ09304
         ICM   R15,EIGHT,AVTDKENQ       INSERT IN USE BYTE     @OZ09304
SEARCHLP EQU   *                                                SA52984
         LR    R14,R2                   SET TO NEXT CPB         SA52984
SRCHLP   EQU   *                                                 Y02027
         ICM   R2,AD,CPBNEXT-IEDQCPB(R14) IS THIS THE LAST CPB   Y02027
         BNZ   CPBCK1                   IF NOT-CHECK THIS ONE   SA52984
         MVI   AVTDKENQ,AVTEZERO        FREE FIELD             @OZ09304
         LA    R2,AVTDKAPQ .
         L     R14,AENQMGR .            ADDR OF Q MGR            S22026
         BALR  R11,R14                  ENQ CPB                  Y02027
         B     GOAPQEMT .
CPBCK1   EQU   *                                                SA52984
         L     R2,CPBNEXTF-IEDQCPB(R14) NEXT CPB                SA52984
         TM    CPBRDWR-IEDQCPB(R2),CPBWRITB  IS IT WRITE CPB    SA52984
         BO    SEARCHLP                 YES                     SA52984
         CLC   CPBAERB(3),CPBAERB-IEDQCPB(R2) SAME LCB          SA52984
         BNE   SEARCHLP                 NO-GET NEXT ONE         SA52984
         CLC   SCBNXCPB(1),CPBNUMB-IEDQCPB(R2)  NEXT THIS LCB   SA52984
         BNE   SEARCHLP                 NO-GET NEXT ONE         SA52984
         ICM   R15,EQUAL,CPBNEXTF-IEDQCPB(R14)  SAVE HIGH BYTE @OY20265
         CS    R2,R15,CPBNEXTF-IEDQCPB(R14)  REPLACE THIS CPB  @OS79957
*                                        WITH NEXT FOR THIS LCB@OS79957
         BNE   SRCHLP                   CS FAILED, RECHAIN     @OS79957
         XC    CPBNEXT-IEDQCPB(3,R15),CPBNEXT-IEDQCPB(R15)     @OS79957
*                                       CLEAR LINK POINTER     @OS79957
         OC    CPBNEXT(3),CPBNEXT-IEDQCPB(R2)  GET NEW LINK PTR@OS79957
         BNZ   END                      BR IF NOT LAST IN CHAIN@OS79957
         STCM  R15,AD,AVTDKENQ+FIVE     SET NEW LAST           @OS79957
END      EQU   *                                               @OS79957
         MVI   AVTDKENQ,AVTEZERO        FREE FIELD             @OZ09304
         LR    R15,R2                   NEW CPB TO PROCESS      SA52984
CPBCK    EQU   *                                                SA52984
         L     R2,CPBXREAF .
         TM    DATFLAGS,DATNPRFX .
         BO    CKRECNO .
         CLC   CPBADDR+1(3),PRFCRCD-IEDQPRF(R2) .
*                 WAS THERE A LOGICAL READ ERROR
         BNE   RDERROR .                BR YES
CKEOB    EQU   * .
         TM    LCBERBST,LCBERROR+LCBRDERR .
*        READ ERROR OR LINE ERROR
         BNZ   ANYBFRS .                BR IF EITHER
         B     NEXTCPB .                BR TO PROCESS THIS CPB
AENQMGR  DC    A(ENQMGRCA) .            ADDR OF Q MGR            S22026
CKRECNO  EQU   * .
         CLC   CPBADDR+1(3),DATFEFO .
         BE    CKEOB .
.F041A   ANOP                                                  @OX20639
RDERROR  EQU   * .
         OI    LCBERBST,XRDERR .        SET RDERR FLAG
ANYBFRS  EQU   * .
**    SET FLAG TO UPDATE ONLY THE CPB COUNT OF ALL SCB FIELDS
         LNR   R2,R2 .                 SET FLAG
         MVC   SCBSCSEG(3),CPBADDR+1 .  SET FOR NEXT READ IF INIT
         BAL   R14,FREECPBA .
         TM    LCBSTAT1,LCBINITN .
         BNO   NOTINIT .                BR IF NOT INIT
         TM    LCBERBST,LCBERROR .      LINE ERROR ON SEND
         BO    NOTINIT .                BR YES
         AIF   (&A EQ 1).F041B                                 @OX20639
         LA    R14,GOAPQEMT .           SET RTN ADDR
.F041B   ANOP                                                  @OX20639
INITPOST EQU   * .
         MVI   LCBERBKY,XCTZERO   .     SET FIRST BYTE OF ERB    S21101
*                                 .     NON ZERO SO HM WILL KNOW S21101
*                                 .     NOT TO POST              S21101
         TM    LCBERBST,XXHMSG .        EOM RCVD IN HM YET
         BCR   14,R14 .                 BR IF NO TO DROP ERB
         LA    R2,AVTDSIOB .            ADDR TO POST ERB TO FA
         LA    R1,LCBERB .
         CLI   LCBERBPY,PRIINTRQ .      INITIAL REQUEST
         BE    POST .                   YES - LEAVE THE PRTY
         MVI   LCBERBPY,PRISBPCI .      SET LOW PRTY
         B     POST .                   POST ERB TO FA
NOTINIT  EQU   * .
         BAL   R5,FREEBFRS .
         AIF   (&A EQ 1).F041C                                 @OX20639
         LA    R14,GOAPQEMT .
.F041C   ANOP                                                  @OX20639
         LA    R1,LCBERB .
         L     RSCB,LCBSCBA-1           SCB ADDRESS             SA61767
         TM    SCBQTYPE,SCBCONC .       CONC                     S22026
         BZ    CHKRCALL .               BRANCH IF NO             S22026
         TM    LCBERBST,LCBERROR .      LINE ERROR               S22026
         BO    POSTERR .                BRANCH IF YES            S22026
CHKRCALL EQU   * .                                               S22026
         TM    LCBSTAT1,LCBRCLLN .      RECALL
         BO    ERBRCQCB .               BR YES
POSTERR  EQU   * .                                               S22026
         MVI   LCBERBPY,PRIDSPLB-1 .    POST WITH LOWER PRTY
         TM    LCBERBST,LCBERROR .      LINE ERROR
         BO    ERBRCQCB .               BR YES TO RETURN ERB
*        IS RECALL ERB SHOULD BE POSTED TO RCQCB WITH NO BFRS
*        IS NOT RECALL POST AN EOM BFR TO MH WITH ERR BITS SET
         LA    R15,ABCODE3 .           SET 15 TO ABEND CODE
         BAL   R14,AVTABEND .          SET 14 TO ADDR OF ABEND
*        AND GO TO THE RTN TO ABEND
ABCODE3  EQU   X'03' .                 LOGICAL READ ERROR
         EJECT
*        THIS SECTION DEALS WITH A CPB UNIT THAT IS THE NEXT READ
*        EXPECTED OR A CORE UNIT.
         SPACE 3
         AIF   (&A EQ 2).F042
FIXSCSEG EQU   * .
         USING CPBINIT,RBASE .
         NI    LCBERBST,X'FF'-LCBRDERR .RESET READ ERROR
         AIF   (&A NE 3).F042A
         TM    SCBQTYPE,SCBCOREQ .      CORE QUEUEING
         BNO   DISKONLY .               BR NO
.F042A   ANOP
         L     RBASE,ADRFA01 ..         SET UP SECOND BASE
         USING IEDQFA01,RBASE .
         L     R2,SCBCORE-1 .            ADD  LAST BFR THERE
         TM    PRFSTAT1-IEDQPRF(R2),PRFNLSTN .  THIS NOW LAST
         BO    CKNTXT .                 BR NOW LAST NOW
         MVC   SCBSCSEG(3),SCBCORE .    RESET BFR ADDR
         B     CALLFQA .
CKNTXT   EQU   * .
         NC    PRFNTXT-IEDQPRF(3,R2),PRFNTXT-IEDQPRF(R2) .
         BZ    INITERR .
         MVC   SCBSCSEG(3),PRFNTXT-IEDQPRF(R2) .   ADDR NEXT BFR
         B     CALLFQA .
.F042    AIF   (&A EQ 1).F043
NEXTCPB  EQU   * .
         MVC   SCBSCSEG(3),CPBADDR+1 .  RESET SCSEG
         L     R2,CPBXREAF .
.F043    ANOP
NEXTCPB1 EQU   * .
         TM    DATFLAGS-IEDQDATA(R2),DATNPRFX .
*              DOES IS HAVE A PREFIX
         BO    CKBFRA .                 BR NO PRFX
         LA    R11,FIXPRFX1 .           SET RTN ADDR             A42363
         LH    R7,PRFSCAN-IEDQPRF(R2) . SAVE SCAN PRT (NO IDLES)
         STH   R7,DATSCAN-IEDQDATA(R2) .  WHILE PROCESSING THIS UNIT
         LH    R7,SCBSCAN .             SAVE SEQ OUT NO
         TM    PRFSTAT1-IEDQPRF(R2),PRFNHDRN .
*              IS I T A HEADER
         BO    FIXPRFX .                BR NO
         TM    DATFLAGS-IEDQDATA(R2),DATLOSTN LOST MSG
         BNO   CONTINUE .               BR NO
         OI    SCBERR3,SCBLOSTN .       SET SCB ERR BIT
CONTINUE EQU   * .
*   ALLOW CNCL MSG IF RECALL
         TM    LCBSTAT1,LCBRCLLN .      RECALL
         BO    FIXSCHDR .
         BAL   R14,FINDESTQ .
*              ALLOW INTCP MSG IF RECALL
         TM    DATFLAGS-IEDQDATA(R2),DATCNCLD+DATSENT HAS THIS  SA52971
*                                         MSG BEEN CANCELLED OR SA52971
*                                         SENT                  SA52971
         BNZ   RTNSCHD .                BR IF EITHER            SA52971
         AIF   (&A EQ 1).F044
         LR    R5,R15 .                 SAVE 15
         LH    R1,PRFDEST-IEDQPRF(R2) . TRM OFFSET
         N     R1,AVTCLRHI .            SET UP ADDR OF TNT TO
         L     R15,AVTRNMPT .           CONVERT OFFSET TO TRM
         BALR  R14,R15 .                ENTRY ADDRESS
         USING IEDQTRM,R1 .
         LR    R15,R5 .                 RESTORE 15
         TM    TRMSTATE,TRMLIST+TRMPROC LIST OR PROCESS ENTRY   SA66617
*                                         INTERCEPTED           SA66617
         BNZ   NOINTC .                 BR NO
         CLI   SCBUNTCT,AVTEZERO        FIRST READ OF HDR      @YA08105
         BNE   NOINTC                   BR NO                  @YA08105
         TM    TRMSTATE,TRMHELDN .      IS THE TRM INTERCEPTED
         BO    FLAGINTC .               BR YES
         TM    SCBSTATE,SCBLCK1N+SCBMSGLN LOCK MODE            @YA05477
         BNZ   NOINTC                   BRANCH IF YES          @YA05477
         TM    LCBSTAT1,LCBINITN        INITIATE MODE          @YA05477
         BO    NOINTC                   BRANCH IF YES          @YA05477
         NC    QCBINTFF(3),QCBINTFF     POSSIBLE RELEASE       @YA05477
         BNZ   NOINTC                   BRANCH IF NO           @YA05477
         CLC   SCBSCHDR(3),QCBFFEFO     SENDING FEFO MSG       @YA05477
         BNE   RTNSCHD                  BRANCH IF NO           @YA05477
NOINTC   EQU   * .
.F044    ANOP
         NC    SCBFEFO(3),SCBFEFO .     HAS IT BEEN UPDATED ALREADY
         BNZ   NOFEFOUP .               BR YES
         MVC   SCBFEFO(3),DATFEFO-IEDQDATA(R2) SET THE FEFO PTR SA52971
NOFEFOUP EQU   * .
*                                       SAVE FEFO PTR
         MVC   LCBTTBIN(2),PRFDEST-IEDQPRF(R2) .
         TM    SCBQTYPE,SCBCONC .       CONC                     S22026
         BZ    NOTCONCC .               BRANCH IF NO             S22026
         MVC   LCBTTCIN(2),PRFDEST-IEDQPRF(R2)                  SA57333
NOTCONCC EQU   * .                                               S22026
FIXOSEQ  EQU   * .
         LH    R7,DATSEQOT .
         B     FIXPRFX1 .               ALL HEADERS COME HERE
*        BRANCH TO AVOID TEST FOR RETRIEVE
FIXPRFX  EQU   * .
         NC    LCBTTCIN(2),LCBTTCIN .   IF ZERO THIS IS A RETRIEVE
         BCR   7,R11 .                  BR NOT RETR TO FIXPRFX1  A42363
         TM    LCBSTAT2,LCBDIAL         IF 0, COULD BE DIAL       M2321
         BCR   1,R11                    BRANCH IF DIAL-IT IS NOT  M2321
*                                       RETRIEVE                  M2321
         MVC   SCBSCHDR(3),PRFCHDR-IEDQPRF(R2) .
*        SET HDR ADDR THAT CORRESPONDS TO THIS BFR
FIXPRFX1 EQU   * .
         MVC   SCBSRCE(PRFSTXT-PRFSRCE),PRFSRCE-IEDQPRF(R2) .
         MVC   SCBCHDR(3),SCBSCHDR .    SET HDR ADDR
         STH   R7,SCBSCAN .             RESTORE SEQ OUT NO
         BAL   R7,SIZECK .
         LH    R7,PRFSIZE-IEDQPRF(R2) . GET SIZE OF BFR
         XC    DATCOUNT(2),DATCOUNT .
         CH    R7,AVTKEYLE .
         BH    CKBFRA .
         STC   R7,CPBINWKA .
         B     FIXWKACT .
FIXSCHDR EQU   * .
         AIF   (&A EQ 1).F045
         MVC   SCBSCHDR(3),PRFCRCD-IEDQPRF(R2) .     SET SCHDR TO THIS
         AIF   (&A EQ 2).F046
         TM    SCBQTYPE,SCBCOREQ .      IS THIS CORE
         BNO   CKBDRCL .                BR NOT CORE - SCHDR IS OK
.F045    ANOP
         MVC   SCBSCHDR(3),PRFCORE-IEDQPRF(R2) .    RESET SCHDR TO THIS
.F046    ANOP
CKBDRCL  EQU   * .
         NC    LCBTTCIN(2),LCBTTCIN .   RETRIEVE
         BNZ   NOTRET1                  NOT RETRIEVE, CONTINUE    M2321
         TM    LCBSTAT2,LCBDIAL         IS THIS DIAL LCB?         M2321
         BO    NOTRET1                  YES,CANT BE RETRIEVE   @SA70861
         TM    DATFLAGS-IEDQDATA(R2),DATCNCLD  CANCELLED MSG?  @SA70861
         BNO   FIXOSEQ                  NO, HANDLE RETRIEVE    @SA70861
         OI    PRFSTAT1-IEDQPRF(R2),PRFCNCLN                   @SA70861
*                                            SET MSG CANCELLED @SA70861
         B     FIXOSEQ                  HANDLE RETRIEVE        @SA70861
NOTRET1  EQU   *                                                  M2321
         TM    LCBCHAIN,LCBBFRSZ .      SPECIAL RECALL
         BCR   14,R11 .                 BR NO TO FIXPRFX1        A42363
         TM    SCBQTYPE,SCBCOREQ .      IS THIS CORE Q'D         A42363
         BCR   1,R11 .                  BR YES TO FIXPRFX1       A42363
         AIF   (&A EQ 1).F046A
*        IS DUPL HDR ON DISK - SCBMBSSA WILL HAVE XTRA OR NTXT
         LR    R1,RSCB .                SET FOR MBSSA ( REUS DSK)
         TM    SCBQTYPE,SCBNREUS .      IS IT REUS
         BNO   ONEOK .                  BR IF REUS
         LA    R1,4(R1) .               SET FOR MBSSA+4 N NON REUS)
ONEOK    EQU   * .
.F046A   ANOP
         TM    SCBHBFNO,X'0F' .         FIRST BD RCLL
         BNZ   NOTFIRST .
         MVC   SCBTRANS(3),SCBSCHDR .   SET HDR ADDR FOR NEXT RCLL
NOTFIRST EQU   * .
         AIF   (&A EQ 1).F046B
         MVC   SCBMBSSA-IEDQSCB(3,R1),PRFXTRA-IEDQPRF(R2) .
*        ASSUME MORE THAN 1 UNIT IN BFR - IF NOT SET NTXT
         NC    PRFXTRA-IEDQPRF(3,R2),PRFXTRA-IEDQPRF(R2)        SA52971
*        MORE THAN ONE UNIT                                     SA52971
         BCR   7,R11 .                  BR MORE THAN 1           A42363
         MVC   SCBMBSSA-IEDQSCB(3,R1),PRFNTXT-IEDQPRF(R2) .
.F046B   ANOP
         BR    R11 .                    BR TO FIXPRFX1           A42363
         SPACE 3
*        THIS SECTION DEALS WITH FREEING THE LINE AFTER FINDING
*        A CANCLED OR INTERCEPTED MESSAGE AND WILL PUT AN INTERCEPTED
*        MESSAGE IN THE INTERCEPT QUEUE.
         SPACE 3
RTNSCHD  EQU   * .
         NI    QCBFLAG,X'FF'-QCBSDFFO . RESET FLAG - NO LONGER  SA52971
*                                         SENDING FROM QUEUE    SA52971
         CLC   SCBSCHDR(3),QCBFFEFO .   IS THIS THE FIRST FEFO MSG
         BNE   RTNSCHD1 .               BR NO
         MVC   QCBFFEFO(3),DATFEFO-IEDQDATA(R2) . UPDATE FEFO
         OC    QCBFFEFO(3),QCBFFEFO     ONLY FEFO MSG?         @SA74867
         BNZ   ANYHELD                  NO, CHECK FOR HELD MSGS@SA74867
         MVC   QCBFFEFO(3),SCBFEFO      MOVE FROM SCB - MAY    @SA74867
*                                        HAVE BEEN UPDATED     @SA74867
*                                        WHILE READING 1ST FEFO@SA74867
ANYHELD  EQU   *                                               @SA74867
         NC    QCBINTFF(3),QCBINTFF .   ANY HELD MSGS ON LEVEL  SA52971
         BNZ   RTNSCHD1 .               BR SOME THERE           SA52971
         MVC   QCBPFEFO(3),QCBPREVF .   SET PTR TO MSG THAT IS  SA52971
*                                         PREVIOUS TO THE FIRST SA52971
*                                         UNSENT MSG IN THE FEFOSA52971
*                                         CHAIN                 SA52971
         MVC   QCBPREVF(3),PRFCRCD-IEDQPRF(R2) SET PTR TO MSG   SA52971
*                                       PREVIOUS TO FFEFO       SA52971
RTNSCHD1 EQU   * .
         AIF   (&A NE 3).F047
         TM    SCBQTYPE,SCBCOREQ .      IS THIS MSG CORE QUEUED
         BO    CORERTN .               BR YES
.F047    AIF   (&A EQ 1).F048
         LH    R14,AVTDSKCT .           DECR FOR THIS READ
         BCTR  R14,0 .
         STH   R14,AVTDSKCT .
         BAL   R14,CPBFREEA .          FREE THE CPB
RTNSCHED EQU   * .
         LA    R14,GOAPQEMT .
         AIF   (&A EQ 2).F049
         B     XTNSCHED .
.F048    ANOP
CORERTN  EQU   * .
         TM    QCBDSFLG,QCBDISK         ANY DISK                SA62949
         BNZ   NOMSGCT                  IF DISK, MSGCT DONE     SA62949
         LH    R14,QCBMSGCT             LOAD COUNT              SA62949
         BCTR  R14,0                    DECREMENT               SA62949
         STH   R14,QCBMSGCT             STORE COUNT             SA62949
NOMSGCT  EQU   *                                                SA62949
         LR    R6,R2 .
         ST    R2,AVTDOUBL .            SET MSG ADDR
         L     R15,ADFREEMS .
         BAL   R7,HAVEADDR-FREEMSG(R15) .
RTNSCHD2 EQU   * .
         LA    R14,CALLPROC .           SO CPB Q WILL NOT BE CHECKED
XTNSCHED EQU   * .
.F049    ANOP
         L     RSCB,LCBSCBA-1 .         SCB ADDR
         NI    SCBQTYPE,X'FF'-SCBBFMM . SET NOT MIDDLE OF MSGL
         L     RQCB,SCBDESTQ-1 .        DEST Q ADDR
*** THIS SUBROUTINE DESTROYS REGS 0,1,2, AND 11.  THE QCB       SA52971
*   EXTENSION IS RETURNED IN REG2.  RETURN IS TO +0 IF THIS     SA52971
*   IS NOT A CONCENTRATOR AND TO +4 IF IT IS A CONCENTRATOR.    SA52971
         BAL   R10,FINDLVL .            GO FIND QCB EXTENSION   SA52971
         B     RESETLCB .               BR NOT CONC             SA52971
         NI    QCBEFLG-IEDQQCBE(R2),255-QCBEDATA .               S22026
*                                       RESET QCBEDATA           S22026
         LA    R1,LCBERB .              ERB ADDR                 S22026
         L     R2,AVTCSCH .             CONC SCH ADDR            S22026
         SH    R2,AVTHA2 .              SUB TWO                  S22026
         B     POST .                   POST ERB TO Q9           S22026
RESETLCB EQU   * .                                               S22026
         LA    R2,AVTBFRTB .            ADDR OF BFR RTB QCB
         CLI   LCBFLAG1,LCBPLCB         PLCB                   @YM08981
         BNE   NOTPLCB                  BR NO                  @YM08981
         XC    SCBERRST,SCBERRST        CLEAR ERROR WORD       @YM08981
*                                       TO RESET ANY BITS THAT @YM08981
*                                       MAY HAVE BEEN SET DUE  @YM08981
*                                       TO A PREVIOUS DIAL     @YM08981
*                                       CONTACT ERROR OR PURGE @YM08981
*                                       EXIT TAKEN PRIOR TO    @YM08981
*                                       DIAL CONTACT           @YM08981
         B     NOBSDIAL                 SKIP EP ONLY CODE      @YM08981
NOTPLCB  EQU   *                                               @YM08981
         TM    LCBSTAT2,X'06'           BSC DIAL               @OX12563
         BNO   NOBSDIAL                 BR IF NO               @OX12563
         MVC   LCBSTAT1(1),LCBSENS0     SET LINE STATE         @OX12563
         MVC   SCBBSCFM(1),LCBSENS1     SET FORMAT BITS        @OX12563
NOBSDIAL EQU   *                                               @OX12563
         ST    R2,SCBDESTQ-1 .          INTO SCB FOR BD POST
         CLI   LCBERBPY,PRIAPERB .      IS THIS AN APPL. PGM.
         BE    ERBRCQCB .               YES - RETURN ERB NOT LCB
         CLI   LCBRSKEY,DSPBUFSC        IS THIS A BFRD TERM     SA57087
         BNE   POSTLCB                  BR IF NOT BFRD          SA57087
         XI    LCBSTAT1,LCBRECVN+LCBSENDN  RESET LCBSTATE      @OX11340
         OI    LCBSTAT2,LCBNEGRP        SET NEG RESP FLG        SA57087
         NI    QCBSTAT,X'FF'-QCBSEND    RESET SENDING FLG       SA57087
POSTLCB  EQU   *                                                SA57087
         LR    R2,RLCB .
         LR    R1,R2 .
         MVI   LCBPRI,PRILNFRE          SET LCB PRIORITY        SA52984
         B     POST .
         AIF   (&A EQ 1).F050
SET14    EQU   * .
         LA    R14,GOAPQEMT .
         B     POST .
FLAGINTC EQU   * .
*        IF TERMINAL IS IN LOCK MODE SEND THE RESPONSE ANYWAY
         TM    SCBSTATE,SCBLCK1N+SCBMSGLN .LOCKED TERMINAL
         BNZ   NOINTC .                 BR IF LOCKED TO SEND ANYWAY
         TM    LCBSTAT1,LCBINITN .      INITIATE MODE
         BNO   OKHOLD .                 BR NOT INIT TO HOLD MSG
         NI    LCBSTAT1,LCBINITF .      SET NOT INIT
         MVC   DATFEFO-IEDQDATA(3,R2),QCBFFEFO . SET FOR MOVES LATER
         L     R5,PRFLCB-1-IEDQPRF(R2) . SRCE LCB ADDR
         TM    LCBSTAT1-IEDQLCB(R5),LCBINITN . STILL INIT MODE
         BNO   OKHOLD .                 BR NO TO HOLD MSG
         NI    LCBSTAT1-IEDQLCB(R5),LCBINITF .RESET INIT MODE
         B     RTNSCHD1 .               GO TO RETURN THE LINE
OKHOLD   EQU   * .
         TM    QCBDSFLG,QCBREUS+QCBNREUS .  ANY DISK
         BZ    RTNSCHD .                BR NO
         MVC   SCBSCHDR(3),PRFCRCD-IEDQPRF(R2) RESET SCB        SA52971
*** IF DISK QUEUED, THIS IS A NOP.  IF CORE WITH DISK BACK UP,  SA52971
*   THIS WILL SET THE DISK ADDRESS OF THE HEADER INSTEAD OF THE SA52971
*   MAIN STORAGE ADDRESS OF THE HEADER                          SA52971
         NC    QCBINTFF(3),QCBINTFF .   ANY FEFO MSGS THERE
         BNZ   RTNSCHD .                BR IF SOME ALREADY THERESA52971
         CLC SCBSCHDR(3),QCBFFEFO       FIRST FEFO MESSAGE      SA66626
         BNE   RTNSCHD                  NO,DON'T UPDATE INTFF   SA66626
         MVC   QCBINTFF(3),PRFCRCD-IEDQPRF(R2) .
         B     RTNSCHD .                FREE THE CPB THIS TIME
.F050    AIF   (&A EQ 1).F052 .                                 SA52971
ERBCPB   EQU   * .
         BAL   R14,FREECPBA .
         LA    R6,LCBERBCH-5 .          SET ERBCH FOR LINK FIELD
         BAL   R14,BFRLINK .            GO LIND THE LAST BFR
         L     R6,PRFLINK-1 .           NEXT IN CHAIN
BFRLINK  EQU   *
         NC    PRFLINK(3),PRFLINK .     ANOTHER THERE
         BCR   NOTZERO,R14 .            BR NOT ZER0 TO GET NEXT  S21101
         B     CKENQERB .
.F052    ANOP
         SPACE 3
*        THIS SECTION WILL POST THE ERB AFTER A REQUEST IS COMPLETED
*        IF NECESSARY OR WILL FREE THE ERB TO BE POSTED AGAIN FRO
*        ANOTHER REQUEST.
         SPACE 3
*   TO CKREQ WHEN END OF MESSAGE GOTTEN FROM THE QUEUE
*    TO CKREQ WHEN THE REQUEST HAS BEEN COMPLETED -- BUFFERS FILLED
CKREQ    EQU   * .
         L     RSCB,LCBSCBA-1 .         RESTORE IN CASE OF DISP BAL
         BAL   R11,FIXDEOB .            CC WILL REMAIN UNCHANGED
         BO    FIXRECAL .               BR YES
         TM    SCBQTYPE,SCBCONC .       CONC                     S22026
         BZ    NOTCONCA .               BRANCH IF NO
         L     RSCB,LCBSCBDA-1 .        LINE SCB ADDR            S22026
         MVI   LCBERBPY,PRIFSPCI .      SET TO POST BUFFERS      S22026
         TM    SCBSTAT1,SCBCBGN .       CONC MSG BEGIN           S22026
         L     RSCB,LCBSCBA-1 .         RESET SCB ADDR           S22026
         BO    LOGICEOM .               BRANCH IF YES
NOTCONCA EQU   * .                                               S22026
         CLI   LCBERBPY,PRIINTRQ .
*              IS THIS AN INITIAL REQ
         BE    LOGICEOM .               BR YES
CMIDMSG  EQU   * .                                               S22026
         CLI   LCBERBPY,PRIAPERB .      APPLICATION PGM ERB
         BE    ERBRCQCB .               BR YES
         AIF   (&A EQ 1).F053
         LA    R5,GOAPQEMT .
         AIF   (&A EQ 2).F054
         TM    SCBQTYPE,SCBCOREQ .
         BNO   CKRQTYPE .
.F053    ANOP
         LA    R5,CALPROC1 .
CKRQTYPE EQU   * .
.F054    ANOP
         CLI   LCBERBPY,PRIFSPCI .
         BNE   FREEBFRS .
         TM    SCBQTYPE,SCBCONC .       CONCENTRATOR             S22026
         BZ    NOTCONCD .               BRANCH IF NO             S22026
         MVI   LCBERBPY,PRIINTRQ-1 .    RESET PRIORITY
NOTCONCD EQU   * .                                               S22026
         L     RDCB,LCBDCBPT .
         L     R2,DCBMH-1 .
         CLI   LCBFLAG1,LCBPLCB         THIS A PLCB            @YM06085
         BNE   GOTMH                    BR NO, HAVE MH ADDRESS @YM06085
         L     R2,LCBMHA-1              GET PROPER MH QCB      @YM06085
GOTMH    EQU   *                                               @YM06085
         LA    R15,PRIMHBFR .
         B     FREEBFR1 .
FREEBFRS EQU   * .
         TM    LCBSTAT1,LCBRCLLN        IS THIS A RECALL        SA61767
         BO    NOCONC                   IF RECALL NO NEED TO    SA61767
*                                        RESET EDATA            SA61767
         BAL   R14,FINDESTQ             GET QCB & PQCB          SA61767
         BAL   R10,FINDLVL              QCBE ADDR IF CONC       SA52971
         B     NOCONC                   BRANCH IF NOT CONC      SA52971
         L     R1,LCBERBCH-1            BUFFER ADDR             SA52971
         LA    R1,AVTEZERO(R1)          CLEAR HI-ORDER BYTE     SA52971
         LTR   R1,R1                    BUFFER THERE            SA52971
         BZ    NOCONC                   BRANCH IF NO            SA52971
         TM    PRFSTAT1-IEDQPRF(R1),PRFNHDRN                    SA52971
*                                       HEADER BUFFER           SA52971
         BO    NOCONC                   BRANCH IF NO            SA52971
         NI    QCBEFLG-IEDQQCBE(R2),255-QCBEDATA                SA52971
*                                       RESET QCBEDATA          SA52971
         NI    SCBQTYPE,AVTEFF-SCBBFMM  RESET MIDDLE MSG BIT    SA61767
NOCONC   EQU   *                                                SA52971
         LA    R15,PRIBFRTB .           SET PRTY FOR SUBRTN
         LA    R2,AVTBFRTB .
FREEBFR1 EQU   * .
         BALR  R14,0 .
         NC    LCBERBCH(3),LCBERBCH .
         BCR   ZERO,R5 .                                         S21101
         L     R1,LCBERBCH-1 .
         STC   R15,PRFPRI-IEDQPRF(R1) . SET PRIORITY
         MVC   LCBERBCH(3),PRFLINK-IEDQPRF(R1) .
         B     POST .
LOGICEOM EQU   * .
         OI    LCBERBST,LCBDLNKN .      SET FOR PCI
         L     RDCB,LCBDCBPT .          DCB ADDR                 S22024
         TM    LCBERBST,XMSG .          HAS EOM BEEN DONE
         BO    POSTERB .                BR YES
         TM    DCBPCI,PCIADD .          PCI=ADD SPECIFIED        S22026
         BNZ   POSTERB .                BRANCH IF YES            S22026
         TM    SCBQTYPE,SCBBBFTM+SCBCONC .                       S22026
         NI    PRFSTAT1,PRFNLSTF .      SET LAST SEG IN BFR
POSTERB  EQU   * .
         MVI   LCBERBPY,PRIACTIV .
         LA    R2,AVTACTIB .            ACTIVATE QCB
         TM    DCBDSORG,LGB .           IS BLOCK DCB OR LGB      S22024
         BNO   RCPOST .                 BRANCH IF DCB            S22024
         L     R2,AVTSAVTP              GET POINTER TO SECONDARY S22024
*                                        AVT                     S22024
         L     R2,SAVTCNIR-IEDNSVTD(R2)  NIR QCB ADDR          @Y17XA0Z
RCPOST   EQU   * .
         LA    R1,LCBERB .
         L     RSCB,LCBSCBA-1           SCB ADDRESS             SA61767
         AIF   (&A NE 3).F055
         TM    SCBQTYPE,SCBCOREQ .
         BNO   SET14 .
.F055    AIF   (&A NE 2).F056A
         B     SET14 .
         AGO   .F056
.F056A   ANOP
         LA    R14,CALPROC1 .
         B     POST .
.F056    ANOP
FIXDEOB  EQU   * .
         NI    LCBERBST,X'FF'-XCOMPL .  RESET REQUEST COMPLETE
         TM    LCBSTAT1,LCBRCLLN .      RECALL
         BCR   NOTONES,R11 .                                     S21101
         L     R2,SCBSCSEG-1 .          UPDATE SCB DEOB
         ST    R2,SCBDEOB .
         IC    R2,SCBUNTCT .
         STC   R2,SCBDEOB .
         BR    R11 .
FIXRECAL EQU   * .
         L     RPREFIX,LCBERBCH-1 .     ADDR FIRST BFR
         OI    PRFSTAT1,PRFDUPLN .      SER DUPL FLAG
         MVI   LCBERBPY,PRIRCQCB .      SET PRTY FOR RECALLS
         MVI   SCBUNTCT,AVTEZERO .
         MVI   SCBNXCPB,AVTEZERO .      SET FOR MH
ERBRCQCB EQU   * .
         L     R2,LCBRCQCB .
         LA    R2,AVTEZERO(R2)          CLEAR HI BYTE           SA54262
*        LEAVE PRTY SET TO D0 FOR AN APPL PGM
         B     RCPOST .
         EJECT
*        THIS SECTION OF CODE WILL INITIALIZE THE FIELDS NEEDED
*        TO CONSTRUCT A BUFFER FROM A UNIT OF DATA.  THE UNIT IS
*        A CPB UNIT JUST READ FROM DISK OR A UNIT IN THE CORE QUEUE
*        THESE ARE THE FIELDS AND THRIR MEANINGS
*        CPBINWKA - THE COUNT OF DATA TO BE MOVED FROM THE UNIT
*              INTO THE BUFFER.
*        CPBWKACT - THE COUNT OF DATA IN THE UNIT THAT HAS NOT YET
*              BEEN TRANSFERED INTO A BUFFER.
*        DATCOUNT - THE COUNT OF DATA IN A UNNIT THAT DOES NOT HAVE
*              A PREFIX - IF =0 - UNIT IS FULL
*        CPBTOUNT - THE COUNT OF DATA TO BE MOVED INTO A BUFFER UNIT
*              TO FILL THE UNIT OF THE BUFFER
*        CPBUNTCT - COUNT OF DATA BYTES ALREADY IN A BUFFER UNIT.
*        SCBUNTCT - THE COUNT OF DATA BYTES ALREADY TRANSFERRED OUT
*              OF THE UNIT QUEUED AT SCBSCSEG.
         SPACE 3
CKBFRA   EQU   * .
         MVC   CPBINWKA(1),AVTKEYLE+1 . SET COUNT OF DATA IN WKA TO
*        KEYLE
         CLI   DATCOUNT,AVTEZERO .      IS COUNT =0
         BE    FIXWKACT .
         MVC   CPBINWKA(1),DATCOUNT .   CORRECT CONUT
FIXWKACT EQU   * .
         CLI   SCBUNTCT,AVTEZERO .      ANY NOT MOVED
         BE    HAVEBUF .                BR NO
         IC    R8,SCBUNTCT .            AMT LEFT TO MOVE
         IC    R14,CPBINWKA .           TOTAL DATA THERE
         SR    R14,R8 .                 SUBTRACT FOR AMY LEFT
         STC   R14,CPBINWKA .           NEW AMT OF DATA THERE
         STC   R8,CPBWKACT .           SET AMT MOVED ALREADY
HAVEBUF  EQU   * .
         NC    LCBERBCH(3),LCBERBCH .   ANY BFRS THERE
         BNZ   BFRTHERE .               BR YES
         LR    R8,R15 .                 SAVE CPB ADDR
         LA    R7,SIZTHERE .
         CLI   LCBERBKY,AVTEZERO .
         BCR   EQUAL,R7 .                                        S21101
         TM    DATFLAGS,DATNPRFX .
         BO    USELCB .
         LR    RPRF,R2 .
         BAL   R7,OFFSET .
SIZTHERE EQU   * .
         LR    R15,R8 .                 RSTORE CPB ADDR
         LA    RPRF,LCBERBLK-1 .        INITIALIZE
         LA    R8,LCBERB .
*        SET UP AMOUNT OF DATA TO BE MOVED INTO THE NEW UNIT
NEWBUFB  EQU   * .
         LA    R14,AVTUMALN(R2) .       SET FOR MOVE
         MVC   CPBTOUNT(1),AVTKEYLE+1 . COUNT TO UNT = KEYLE
         CLC   LCBERBQB+1(2),AVTKEYLE . BFR LARGER THAT KEYLE
         BH    NEWBUFC .                BR YES
         MVC   CPBTOUNT(1),LCBERBQB+2 . CORRECT COUNT
NEWBUFC  EQU   * .
         SR    R7,R7 .
*        SET R7 TO INDICATE A PREFIX IS NEEDED
*        GET A NEW UNIT
         BAL   R9,GETBFR .
NEWBUFD  EQU   * .
         LA    R9,AVTUMALN(R5) .        ADDR TO MOVE FROM
NEWBUFA  EQU   * .
         AIF   (&A EQ 1).F056C
         LA    R1,0(R1) .               MAKE R1 POSITIVE
.F056C   ANOP
         SPACE        3
*        THIS SECTION WILL DETERMINE WHETHER THE BUFFER UNIT AND
*        CPB UNIT ( OR QUEUED UNIT IN CORE) CAN BE SWAPPED OR DATA
*        MUST BE TRANSFERRED.
         SPACE 3
         CLI   CPBWKACT,AVTEZERO .      ANY MOVED
*        IF ANY HAS ALREADY BEEN MOVED FROM THE WORK UNIT BR TO
*        SKIP OVER IT
         BNE   MOVEWKBS(R7) .
         TM    DATFLAGS,DATNPRFX .      UNIT HAVE PRFS
*        IF NOT - ONE MAY OR MAY NOT BE NEEDED - GO CHECK
         BO    SETMOVE1(R7) .
*        THE UNIT HAS A PREFIX
         LTR   R7,R7 .                  IS A PRFX NEEDED
         BNZ   SETMOVE .                BR NO
         AIF   (&A EQ 1).F056D
*        HAVE PRFX AND NEED PRFX - IS DISK AND NOT A HDR - IDLE
*        CHARACTERS MUST BE REMOVED.
         TM    PRFSTAT1-IEDQPRF(R2),PRFNHDRN .     HDR
         BNO   MAYSWAP .                BR HDR
         TM    LCBSTAT1,LCBRCLLN+LCBRECVN .
*     LEAVE IDLES IF RECALL ON RCV OR FROM BD
         BO    MAYSWAP .                BR IF RECALL
         TM    LCBCHAIN,LCBBFRSZ .      FROM BD
         BO    MAYSWAP .                BR YES
         CLI   DATSCAN+1-IEDQDATA(R2),AVTEZERO .   ANY IDLES
         BZ    MAYSWAP .                BR IF NO IDLES TO REMOVE
         LNR   R1,R1 .                  SET FLAG FOR IDLES
.F056D   ANOP
MAYSWAP  EQU   * .
         CLC   CPBTOUNT(1),CPBINWKA .   IS THE AMT OF DATA THE
*        UNIT CAN HODD LESS THAN AMT TO MOVE IN WKA
         BL    MOVUNT2(R7) .
         CLI   CPBUNTCT,AVTEZERO .      ANY ALREADY IN UNIT
         BNE   PARTFULL .               BR IF DATA THERE
         AIF   (&A EQ 3).F057
         AIF   (&A NE 1).F058
         B     MOVUNT2(R7) .
         AGO   .F059
.F057    ANOP
*        THE UNIT AND BFR UNIT CAN BE SWAPPED IF NOT CORE QUEUED
         TM    SCBQTYPE,SCBCOREQ .
         BO    MOVUNT2(R7) .
.F058    ANOP
         LTR   R1,R1 .                  ANY IDLES TO REMOVE
         BM    BLDPRF1 .                BR YES TO MOVE DATA
*        SWAP CPB UNIT AND BFR
         ST    R5,CPBXREAF .
         MVI   CPBWKACT,AVTEZERO .
         LTR   R7,R7 .                  PRFX NEEDED
         BNZ   TICLINK .                BR NO
         TM    PRFSTAT1-IEDQPRF(R2),PRFNHDRN .   HDR
         BNO   NOMOVE .                 BR NO - YES SET UP THE ADDR
         MVC   PRFCHDR-IEDQPRF(3,R2),SCBSCHDR . OF CORRECT HDR
NOMOVE   EQU   * .
         STH   R7,PRFSIZE-IEDQPRF(R2) .
         LR    R5,R2 .
         BAL   R7,FIXIT .
.F059    ANOP
         AIF   (&A EQ 1).F059A
ADDWKA   EQU   * .
         IC    R11,CPBINWKA .
         MVI   CPBINWKA,AVTEZERO .
.F059A   ANOP
STORE    EQU   * .
         N     R11,XMASK .
         AH    R11,PRFSIZE .
         STH   R11,PRFSIZE .
         NC    LCBTTCIN(2),LCBTTCIN     RETRIEVE?              @SA70861
         BNZ   NOTRET3                  BRANCH IF NO           @SA70861
         TM    LCBSTAT2,LCBDIAL         DIAL LCB?              @SA70861
         BNO   NOTRET4                  BRANCH IF NO           @SA70861
NOTRET3  EQU   *                                               @SA70861
         NI    PRFSTAT1,PRFCNCLF
NOTRET4  EQU   *                                               @SA70861
         IC    R14,CPBWKACT .
         STC   R14,SCBUNTCT .
         CH    R11,LCBERBQB+1 .
         BNL   BUFCPB .
BFNOTFUL EQU   * .
         CLI   CPBINWKA,AVTEZERO .      ALL WKA BEEN MOVED
         BNE   NXTUNT .                 BR YE  NO
BFRFULL  EQU   * .
         LA    R2,0(R2) .               CLEAR FOR LTR
         BAL   R14,FREECPBA .
         TM    SCBSTAT1,PRFNLSTN .               LAST BFR
         BO    CKENQERB .
         AIF   (&A NE 3).F060
         TM    SCBQTYPE,SCBCOREQ .
         BO    ENDMSG1 .
.F060    AIF   (&A EQ 1).F061
         NC    SCBXTRA(3),SCBXTRA .     ANY XTRA RECORDS
         BZ    ENDMSG .                  BR NO
         CLC   CPBADDR+1(3),SCBCRCD .   HAS THIS PRFX ONLY BEEN
         BE    CKENQERB .               READ - BR YES TO READ XTRA AND
*        FIX NTXT - IF ONLY PRFX READ NTXT COULD BE TXT QBCK CHN
         CLC   CPBADDR+1(3),SCBNTXT .   LAST XTRA READ
         BNE   CKENQERB .              BR NO TO INIT NEXT READ
ENDMSG   EQU   * .
         CLI   CPBINWKA,AVTEZERO .      ALL MOVED
         BNE   CKENQERB .               NO - NOT EOM
         BAL   R10,SETEOM .
.F061    ANOP
ENDMSG1  EQU   * .
         LA    R14,CKENQERB .
         NC    LCBERBCH(2),LCBERBCH .   THIS BFR BEEN FREED YET
         BCR   ZERO,R14 .               BR IF FREED              S21101
         B     FULLBUF .
SETEOM   EQU   * .
         NI    PRFSTAT1,PRFNLSTF .      SET NOT LAST OFF
         OI    LCBERBST,LCBEOMSG .      SET EOM GOTTEN
         MVI   SCBUNTCT,AVTEZERO .      SET TO 0 FRO MH
         MVI   SCBNXCPB,AVTEZERO .      SET FOR MH
         BR    R10 .                    RETURN
CKENQERB EQU   * .
         TM    LCBERBST,LCBEOMSG .      END OF MSG GOTTEN
         BO    CKREQ .
         AIF   (&A EQ 1).F061AA
         TM    LCBERBST,LCBERROR        LCB ERROR              @OS77389
         BNO   NOSNDERR                 NO, BRANCH             @OS77389
         NI    LCBERBST,AVTEFF-LCBPRCPG TURN OFF BFR REQUEST   @OS77389
         B     POSTERR                                         @OS77389
NOSNDERR EQU   *                                               @OS77389
.F061AA  ANOP
         CLI   LCBERBCT,AVTEZERO .
         BNE   ENQERB .
         OI    LCBERBCT+1,XXCTUSED .    FLAG THE DISABLED COUNT
         CLI   LCBERBCT+1,XXCTUSED .    IS THE DISABLED CT 0
         BNE   ADDCTS .                 BR IF DISA. CT NOT 0
         NI    LCBERBCT+1,X'FF'-XXCTUSED .
*        SET DISABLED COUNT FLAG OF
         OI    LCBERBST,LCBDLNKN .      SET FOR PCI
         LH    R11,LCBERBCT .
         LTR   R11,R11 .
         BZ    CKREQ .
         TM    LCBERBST,LCBDLNKN .
         BNO   CKREQ .
         NI    LCBERBST,LCBDLNKF .
         B     ENQERB .
         SPACE 3
*        THIS SECTION WILL DETERMINE HAW TO BUILD THE BUFFER UNIT WHEN
*        DATA IS TO BE MOVED.
         SPACE 3
SETMOVE1 EQU   * .
*        IF UNIT DOES NOT HAVE A PREFIX - BR *+(R7)
         B     BUILDPRF .
         B     MAYSWAP .
MOVEWKBS EQU   * .
*        IF PART OF WORK AREA HAS BEEN MOVED - BR TO *+(R7)
         B     MOVEWKA .
         B     MOVUNT2+4 .
         AIF   (&A EQ 1).F061A
TICLINK  EQU   * .
         LR    R5,R2 .
         LA    R7,ADDWKA .              RETURN ADDRESS
         B     LINKTIC .                USE COMMON CODE
*
.F061A   ANOP
*        IF MORE DATA IN WORK AREA THAN NEEDED IN UNIT
MOVUNT2  EQU   * .
*        COULD SWAP IF NOT CORE QUEUED
         B     BLDPRF1 .
         LA    R7,MOVEWKB .             SET RETURN ADDRESS
LINKTIC  EQU   * .
         ST    R5,PRFTIC-IEDQPRF(R8) .
         MVI   PRFTIC-IEDQPRF(R8),CPBTICC .
         LR    R8,R5 .
         XC    PRFLINK-IEDQPRF(6,R8),PRFLINK-IEDQPRF(R8) .
         MVI   PRFTIC+3-IEDQPRF(R8),X'02' .
         MVI   PRFTIC-IEDQPRF(R8),CPBTICC .  SET TIC
         BR    R7 .                     RETURN
*
MOVEUNTA EQU   * .
*        HERE TO MOVE AMOUNT OF DATA NEEDED IN NEW UNIT
         LR    R8,R5 .
         IC    R11,CPBTOUNT .
MOVESET  EQU   * .
         LA    R7,4095(R11) .           SUBRT ONE FOR MOVE
         EX    R7,MOVE .                MOVE DATA
         IC    R14,CPBWKACT .           ADD AMOUNT MOVED THIS
         AR    R14,R11 .                TIME TO AMOUNT ALREADY
         STC   R14,CPBWKACT .           MOVED FROM WORK AREA
         IC    R14,CPBINWKA .           SUBTR AMOUNT MOVED
         SR    R14,R11 .                FROM AMOUNT LEFT TO
         STC   R14,CPBINWKA .           MOVE FROM WORK AREA
         B     STORE .
BFRTHERE EQU   * .
         BAL   R14,LAST .
         B     NEWBUFB .                BR IF LAST BFR FULL
         LA    R14,AVTUMALN(R2) .       FROM ADDR + 12
         LA    R7,4 .                   SET NO PRFX NEEDED
         LTR   R11,R11 .
         BP    NEWBUFA .                THE LAST UNIT NOT FULL
         BAL   R9,ADDNBUNT .
         B     NEWBUFD .
PARTFULL EQU   * .
         LA    R14,AVTUMALN(R2) .       SET 14  FOR MOVE
         B     MOVEWKB .                BR TO MOVE DATA
MOVEWKA  EQU   * .
         LA    R14,AVTUMALN(R2) .       FROM ADDR + 12
         B     BUILDPRF .
IDLETEST EQU   * .
         TM    LCBSTAT1,LCBRCLLN+LCBRECVN .      SHOULD IDLES
         BO    SAVEIDLE .               RESERVE CHARACTERS ARE TO BE
*        BE SAVED - ---- YES IF THIS IS A BD RECALL OR A
*        RECALL ON THE RECEIVE SIDE - BT
         TM    LCBCHAIN,LCBBFRSZ .      BD RECALL
         BO    SAVEIDLE .
         B     BLDPRF2 .                SAVED
BLDPRF1  EQU   * .
*    WILL ENTER HERE ONLY IF HAVE A PREFIX AND NEED ONE BUT
*    A SWAP IS NOT POSSIBLE.
         SR    R1,R1 .
         IC    R1,DATSCAN+1-IEDQDATA(R2) .    NO. IDLES
*        SHOULD ALSO BE SKIPPED
         LA    R11,AVTTXTSZ .           SIZE OF TXT PRF
         TM    SCBSTAT1,PRFNHDRN .      IS THIS IS HCR
         BO    IDLETEST .               BR NOT HDR TO TEST FOR IDLES
         MVC  PRFHQBCK-IEDQPRF(PRFSHDR-PRFSTXT,R5),PRFHQBCK-IEDQPRF(R2)
***********************
*        UPDATE HDR ONLY FIELDS SINCE THE HDR IS STILL AVAILABLE
         LA    R11,AVTHDRSZ .           CORRECT SIZE FOR HDR
SAVEIDLE EQU   * .
         LH    R7,DATSCAN-IEDQDATA(R2) .    SAVE SCAN AND IDLES
         SR    R1,R1 .                   IDLES SHOULD REMAIN IN HDRS
BLDPRF2  EQU   * .
         AR    R1,R11 .                 NO IDLES + SIZE OF PRFX
         IC    R9,CPBINWKA .            SUBTR PRF SIZE FROM COUNT
         SR    R9,R1 .                  OF DATA TO MOVE FROM WK AREA
         STC   R9,CPBINWKA .
         STC   R1,CPBWKACT .            SET AMT MOVED
         B     BLDPRF3 .                TREAT AS NEW BFR NOT NEW REC
BUILDPRF EQU   * .
*    ENTER HDRE IF NEED A PREFIX BUT DO NOT HAVE ONE
         LA    R11,AVTTXTSZ .           INITIALIZE TXT PRF SIZE
         OI    SCBSTAT1,PRFNHDRN .      THIS MUST NOT BE HDR
BLDPRF3  EQU   * .
         MVC   PRFSRCE-IEDQPRF(AVTTXTSZ-4,R5),SCBSRCE .
         NI    SCBSTAT1,X'D7' .         INTERCPT AND DULP OFF
         STH   R7,PRFSCAN-IEDQPRF(R5) . ZERO THE SCAN PRT
         STC   R11,CPBUNTCT .           SET AMT IN UNIT NOW
         IC    R9,CPBTOUNT .
         SR    R9,R11 .
         STC   R9,CPBTOUNT .
         STH   R11,PRFSIZE-IEDQPRF(R5) .
*              NEXT MOVE TO UNIT ADDR + PRFX SIZE + 12
         BAL   R7,FIXIT .
*        SET FOR DEOB FOR EOB'S - THE THE QUEEU ADDR OF
         MVC   PRFCRCD(3),SCBSCSEG .    THIS RECORD
         TM    PRFSTAT1,PRFNHDRN .      IS THIS A HDR
         BNO   MOVEWKB                  BRANCH IF NOT HEADER     S21101
         MVC   PRFCHDR(3),SCBSCHDR .    SET HDR ADDRESS
MOVEWKB  EQU   * .
         SR    R9,R9 .
         IC    R9,CPBUNTCT .
         LA    R9,AVTUMALN(R9,R5) .
         SR    R11,R11 .                CLEAR FOR IC AND ADD
         IC    R11,CPBWKACT .           ADD WKACT TO
         AR    R14,R11 .                THE FROM ADDRESS
         CLC   CPBTOUNT(1),CPBINWKA .   MORE IN UNT THAN WKA
         BNH   MOVEUNTA .
*        HERE TO MOVE AMOUNT OF DATA AVAILABLE
         IC    R11,CPBINWKA .
         B     MOVESET .
FIXIT    EQU   * .
         OI    SCBSTAT1,PRFNHDRN .      INSURE NHDR FOR NEXT TIME
         IC    R11,PRFLINK-1 .
         ST    R5,PRFLINK-1 .
         STC   R11,PRFLINK-1 .
         LR    RPRF,R5 .                NEW BFR ADDR
         XC    PRFLINK(7),PRFLINK .     CLEAR LINK AND TIC
         MVI   PRFTIC+3,X'02' .
         MVI   PRFTIC,CPBTICC .         SET TIC OP CODE
         LR    R8,R5 .                  NEW LAST UNIT ADDR
         ST    RLCB,PRFLCB-1 .          SET LCB ADDR
         MVI   PRFNBUNT,X'01' .         SET NUMB UNITS
         OI    PRFSTAT1,PRFNLSTN .      SET NOT LAST SEG
         NC    LCBTTCIN(2),LCBTTCIN .   IS THIS RETRIEVE         S21101
         BNZ   NOTRET2                  BR NOT RETRIEVE           M2321
         TM    LCBSTAT2,LCBDIAL         IF 0, COULD BE DIAL-IF    M2321
         BCR   14,R7                    NOT DIAL, THIS IS RETR.   M2321
NOTRET2  EQU   *                                                  M2321
         TM    LCBCHAIN,LCBBFRSZ        IS THIS FROM BD         SA63623
         BOR   R7                        BR IF YES               A63623
         IC    R9,SCBUNTCT .            THIS BYTE ADDRESS WITH IN
         STC   R9,PRFNTXT .             THIS RECORD
         BR    R7 .
NXTUNT   EQU   * .
         BAL   R9,ADDNBUNT .
         MVC   CPBTOUNT(1),AVTKEYLE+1 . SET AMT TO MOVE TO UNIT
         BAL   R7,LINKTIC .
         LA    R14,AVTUMALN(R2) .       FROM ADDR +12
         LH    R11,PRFSIZE .            DATA THERE
         LH    R9,LCBERBQB+1 .          SIZE NEEDED
         SR    R9,R11 .                 AMT LEFT TO GET
         MVI   CPBUNTCT,AVTEZERO .      AMOUNT ALREADY IN UNIT =0
         CH    R9,AVTKEYLE .            THIS UNIT TO BE FILLED
         BH    MOVEWKB .                BR YES
         STC   R9,CPBTOUNT .            RESET COUNT TO MOVE
         B     MOVEWKB .
SETMOVE  EQU   * .
*        HERE IF UNIT HAS A PREFIX AND ONE IS NOT NEEDED - SET
*        TO SKIP OVER THE PREFIX
         TM    SCBSTAT1,PRFLOCK .       THIS LOCK MODE MSG
         BNO   NOLOCK .                 BR NO
         OI    PRFSTAT1,PRFLOCK .       SET LOCK IN THIS BFR
NOLOCK   EQU   * .
         SR    R1,R1 .
         IC    R1,DATSCAN+1-IEDQDATA(R2) .    IDLES IN BFR
         LA    R1,AVTTXTSZ(R1) .        + SIZE OF PRFX
         STC   R1,CPBWKACT .            INTO WKACT FOR AMT MOVED
         IC    R11,CPBINWKA .
         SR    R11,R1 .                 SUBTR SIZE OF TXT AND IELES
         STC   R11,CPBINWKA .
         CLI   CPBUNTCT,AVTEZERO .      ANY IN THIS UNIT ALREADY
         BNE   MOVEWKB .                BR YES
         B     MOVUNT2+4 .
ADDCTS   EQU   * .
         SR    R0,R0 .                  ADD THE DISABLED CT TO THE
         IC    R0,LCBERBCT+1 .
         MVI   LCBERBCT+1,AVTEZERO .
         LA    R11,AVTE80-1 .           SET FOR NR TO CLEAR
         NR    R0,R11 .                 FLAG FROM DISABLED COUNT
         IC    R11,LCBERBCT .
         AR    R11,R0 .
         STC   R11,LCBERBCT .
ENQERB   EQU   * .
         BAL   R11,FIXDEOB .
         LA    R15,LCBERB .             ELEM ADDR
         LA    R2,AVTNCPBQ .
         BAL   R11,ENQMGRB .
         B     TAG1 .
BUFCPB   EQU   * .
         TM    PRFSTAT1,PRFNLSTN .      LAST BFR FULL
         BO    NOCOMPL .                BR NOT LAST BUT FULL
         OI    LCBERBST,LCBCOMPL .      SET REQ COMPLETE
NOCOMPL  EQU   * .
         BAL   R14,FULLBUF .
         L     RLCB,PRFLCB-1 .
         L     RSCB,LCBSCBA-1 .
         TM    LCBERBST,XCOMPL .        REQ COMPLETE
         BO    BFRFULL .
         CLI   CPBINWKA,AVTEZERO .      ALL WK AREA MOVED
         BE    BFNOTFUL .
         B     HAVEBUF .
LASTTEST EQU   * .
         IC    R1,CPBWKACT .           COUNT INTO WORK AREA
         CLI   CPBINWKA,AVTEZERO .      ALL MOVED
         BNE   LASTEST .                BR NO
         SR    R1,R1 .                  SET TO 0
LASTEST  EQU   * .
         STC   R1,SCBUNTCT .            RESET UNTCT
         BR    R9 .
         SPACE 3
*        THIS SECTION WILL FIND THE LAST UNIT OF THE LAST BUFFER
*        ASSOCIATED WITH THE ERB AND THE AMOUNT OF DATA IN IT.
         SPACE 3
LAST     EQU   * .
         L     RPRF,LCBERBCH-1 .
         B     CKNEXTA .
CKNEXT   EQU   * .
         L     RPRF,PRFLINK-1 .          ADDR NEXT BFR
CKNEXTA  EQU   * .
         NC    PRFLINK(3),PRFLINK .     IS THERE A NEXT BFR
         BNZ   CKNEXT .
         TM    LCBSTAT1,LCBRCLLN+LCBRECVN .      RECALL BFR THERE
         BO    DATTEST .                BR TO NOT CHANGE BFR SIZE
         TM    LCBCHAIN,LCBBFRSZ .      IF IT IS SPECIAL RECALL
         BNO   LAST1 .                 BR NOT SPECIAL RECALL
DATTEST  EQU   * .
         TM    DATFLAGS-IEDQDATA(R2),DATNPRFX .  IF A PRFX HAS BEEN
         BCR   14,R14 .                 READ ASSUME LAST BFR IS FULL
LAST1    EQU   * .
         LR    R11,R2 .                 SAVE R2
         LA    R2,((SCBSIZE-IEDQSCB)-(PRFSIZE-IEDQPRF))(R3) .
*        USE LAST SAVED PRFX
         BAL   R7,SIZECK .             CHECK BFR SIZE
         LR    R2,R11 .                 RESTORE 2
         LH    R7,AVTKEYLE .            GT KEYLENGTH
         LR    R8,RPRF .
         LH    R11,PRFSIZE .
         CH    R11,LCBERBQB+1 .         IS BFR FULL
         BCR   EQUAL,R14 .              IF YES, RETURN           S21101
         LH    R1,LCBERBQB+1 .          SIZE THERE ALREADY
BFRUNIT  EQU   * .
         SR    R11,R7 .                 SIZE THERE - KEY
         SR    R1,R7 .                  SIZE TO GET - KEY
         NC    PRFTIC+1-IEDQPRF(2,R8),PRFTIC+1-IEDQPRF(R8) .
         BZ    RETURN .                 BR IF NO NEXT UNIT
         L     R8,PRFTIC-IEDQPRF(R8) .  NEXT UNIT ADDR
         B     BFRUNIT .
RETURN   EQU   * .
         LR    R5,R8 .                  SET LAST UNIT ADDR
         LTR   R11,R11 .                LAST UNIT FULL
         BNM   SETUNTCT .               BR IF FULL
         AR    R11,R7 .                 ADD FOR AMOUNT THERE
         AR    R1,R7 .                  ADJUST SIZE ALSO
SETUNTCT EQU   * .
         STC   R11,CPBUNTCT .           SET COUNT ALREADY IN UNT
         CR    R1,R7 .                  IS SIZE LEFT TO MOVE LESS
         BL    SUBTREM .                THAN KEY -- BR YES
         LR    R1,R7 .                  RESET FOR STC
SUBTREM  EQU   * .
         SR    R1,R11 .                 SIZE LEFT - AMT THERE
         STC   R1,CPBTOUNT .            IS COUNT TO MOVE TO UNIT
         LR    R5,R8 .
         B     4(R14) .
         SPACE 3
*        THIS SECTION WILL FREE A CPB IF DISK QUEUEING AND INITIALIZE
*        FOR THE NEXT OPERATION, WAIT FOR THE NEXT CPB IF ONE, OR
*        IF THE REQUEST IS COMPLETE, FREE THE ERB TO WAIT FOR THE
*        NEXT REQUEST.    IF CORE QUEUED THE NEXT UNIT OF THE
*        MESSAGE IF FOUND IN THE CORE QUEUE AND INITIALIZED FOR DATA
*        TRANSFER OR IF THE REQUEST IF COMPLETE IT WILL SET UP TO
*        WAIT FOR THE NEXT REQUEST.
         SPACE 3
*    WILL SUBTR 1 FROM CPB COUNT AND GO TO APPQEMTY
*    WILL RETURN
FREECPBA EQU   * .
         IC    R1,SCBCPBNO .
         BCTR  R1,0 .
         STC   R1,SCBCPBNO .
         LTR   R2,R2 .                 TEST FLAG NOT TO UPDATE
         BM    NOUNTCT .                 BR IF NO UPDATE
         BAL   R9,LASTTEST .
NOUNTCT  EQU   * .
         AIF   (&A NE 3).F062
         TM    SCBQTYPE,SCBCOREQ .
         BO    CORECPB .
.F062    AIF   (&A EQ 1).F063
         IC    R1,SCBNXCPB .            SAVE HI BYTEM
         LA    R1,1(R1) .               ADD ONE TO NO. OF NEXT CPB
         STC   R1,SCBNXCPB .            RESTORE HI BYTE
         LH    R1,AVTDSKCT .            SUBTR ONE FROM DISK CT
         BCTR  R1,0 .
         STH   R1,AVTDSKCT .
         LTR   R2,R2 .             COMPRTEST TO UPDATE FLAG
         BM    TESTLAST .               BR NO UPDATE
         CLI   CPBINWKA,AVTEZERO .      ANY DATA LEFT
         BNE   TESTLAST .               BR YES
         TM    DATFLAGS-IEDQDATA(R2),DATNPRFX .    HAVE A PRFX
         BNO   CKLAST2 .                BR YES
         L     R9,CPBADDR .             ADDR THIS RECORD
         LA    R9,INCR(R9) .            ADD FOUR                 S21101
         IC    R11,SCBSCSEG-1 .
         ST    R9,SCBSCSEG-1 .
         STC   R11,SCBSCSEG-1 .
         B     TESTLAST .
CKLAST2  EQU   * .
         NC    SCBXTRA(3),SCBXTRA .     ANY XTRAS
         BZ    CKLAST3 .                BR NO
         MVC   SCBSCSEG(3),SCBXTRA .
         B     TESTLAST .
CKLAST3  EQU   * .
         MVC   SCBSCSEG(3),SCBNTXT .
TESTLAST EQU   * .
         CLI   SCBCPBNO,AVTEZERO .
         BE    CPBFREEA .               IF 0 RETURN
         B     CPBFREE .                IF NOT RETURN TO APPQEMTY
.F063    AIF   (&A EQ 2).F064
CORECPB  EQU   * .
         NC    PRFTIC+1-IEDQPRF(2,R2),PRFTIC+1-IEDQPRF(R2) .
         BZ    GETCORE .
         CLI   CPBINWKA,AVTEZERO .      ANY DATA LEFT
         BNE   DEOBSET .                BR YES
         MVC   SCBSCSEG(3),PRFTIC+1-IEDQPRF(R2) .
         L     R2,PRFTIC-IEDQPRF(R2) .
         B     DEOBSET .
GETCORE  EQU   * .
         CLI   CPBINWKA,AVTEZERO .      ALL DATA MOVED
         BNE   DEOBSET .                BR NO
         TM    SCBSTAT1,PRFNLSTN .
         BNO   SETCPBNA .
         TM    LCBSTAT1,LCBINITN .      INIT MODE
         BNO   MOVENTXT .               BR NOT INIT
         NC    SCBNTXT(3),SCBNTXT .     IS THE BUFFER THERE
         BNZ   MOVENTXT .               BR YES
INITERR  EQU   * .
         OI    LCBERBST,LCBRDERR .      SET LOGICAL READ ERROR
         LA    R14,TAG1 .               SET RTN ADDR
         B     INITPOST .
MOVENTXT EQU   * .
         MVC   SCBSCSEG(3),SCBNTXT .
         L     R2,SCBSCSEG-1 .
DEOBSET  EQU   * .
         TM    LCBERBST,XCOMPL .        REQ COMPLETE
         BO    SETCPBNO .               BR YES
         XC    AVTDOUBL(5),AVTDOUBL .   CLEAR WORK AREA
         B     NEXTCPB1 .
SETCPBNA EQU   * .
         BAL   R10,SETEOM .
SETCPBNO EQU   * .
         MVI   SCBCPBNO,AVTEZERO .
         BR    R14 .
.F064    ANOP
*        SILL GET SIZE OF BFR THAT IS QUEUED IF FROM BD REQ.
SIZECK   EQU   * .
         TM    LCBSTAT1,LCBRCLLN+LCBRECVN .
         BO    SIZECK1 .
         TM    LCBCHAIN,LCBBFRSZ .      RECALL FROM BFR DISPOSITION
         BCR   NOTONES,R7 .             BR NOT BD RECALL         S21101
*        WHEN ENTERED HERE FROM 'OFFSET' - THIS ROUTINE HAS NO BASE
SIZECK1  EQU   * .
         LH    R8,PRFSIZE-IEDQPRF(R2) . SIZE IN BFR READ
         STH   R8,LCBERBQB+1 .          SET TO BUILD BFRS SAME SIZE
         SR    R10,R10 .                AS THE BFR ON THE QUEUE
         BALR  R1,0 .
         LA    R10,1(R10) .             ADD ON E TO COMPUTE NO UNITS
         SH    R8,AVTKEYLE .            LESS ONE UNIT
         BCR   PLUS,R1 .                BR IF NOT ALL UNITS      S21101
         STH   R10,LCBERBQB-1 .         SET NO UNITS IN BFR TO RECALL
         BR    R7 .                     RETURN
ADDNBUNT EQU   * .
         IC    R11,PRFNBUNT .
         LA    R11,1(R11) .
         STC   R11,PRFNBUNT .
         B     NOSET11 .
GETBFR   EQU   * .
         SR    R11,R11 .
NOSET11  EQU   * .
         NC    AVTBFREB+1(3),AVTBFREB+1 ARE ANY BFRS THERE
         BZ    NOBFRS .
         LH    R5,AVTAVFCT .            SUBTR. ONE FROM AV BF CT
         N     R5,AVTCLRHI              CLEAR HIGH BYTES       @YA07705
         BCTR  R5,0 .
         STH   R5,AVTAVFCT .
         L     R5,AVTBFREB .            ADDR OF UNIT
         L     R1,PRFLINK-1-IEDQPRF(R5) ADDR OF NEXT UNIT
         ST    R1,AVTBFREB .            INTO BFR REQ QCB
CLRBFR   EQU   *
         XC    PRFLINK-1-IEDQPRF(8,R5),PRFLINK-1-IEDQPRF(R5) .
         MVI   PRFTIC-IEDQPRF(R5),8 .   SET TIC OP CODE
         BR    R9 .
NOBFRS   EQU   * .
         AIF   (&A NE 3).F065
         TM    SCBQTYPE,SCBCOREQ .      READ FROM CORE
         BO    PUTERB .                 BR YES NO CPB CHAIN
.F065    AIF   (&A EQ 1).F065B
*        SAVE NEEDED REGS FOR RTN ON R9 WHEN BFR IS AVAILABLE
         STM   R6,R11,CPBSEKFL .        SAVE REGS FOR STATUS     A49228
         ST    R14,CPBUNUSD .
         MVI   CPBSEEK,X'FF'            STE FLAG IN ORIG CPB    SA52984
NOBFRQ   EQU   *                                                SA52984
         L     R1,AVTNOBFQ .
         ST    R1,CPBNEXTF .
         ST    R15,AVTNOBFQ .
         AIF   (&A EQ 2).F065C
         B     TESTFLAG
.F065B   ANOP
PUTERB   EQU   * .
         LTR   R11,R11 .
         BZ    TESTFLAG .
         BCTR  R11,0 .
         STC   R11,PRFNBUNT .
TESTFLAG EQU   * .
.F065C   ANOP
         AIF   (&A EQ 1).F066
         TM    LCBERBST,XXXINQ .        IS THE ERB ALREADY IN THE
         BO    GOAPQEMT .
.F066    ANOP
         IC    R11,CPBWKACT .           RESTORE SCBUNTCT
         STC   R11,SCBUNTCT .
         OI    LCBERBST,XXXINQ .        FLAG ON
         MVC   LCBERBLK(3),AVTBFRTB+1 .
         IC    R1,LCBERBPY .
         STC   R1,LCBERB .
         LA    R1,LCBERB .
         MVI   LCBERBPY,PRIDSKBF .
         ST    R1,AVTBFRTB .
         B     TAG1 .
         SPACE 3
*        THIS SECTION DEALS WITH A UNIT POSTED TO CPB CLEANUP AS A
*        RESULT OF AS ERB APPEARING IN THE BUFFER RETURN QUEUE BECAUSE
*        THERE WERE NO UNITS AVAILABLE.
         SPACE 3
BUFFER   EQU   * .
         LR    R5,R1 .                  SET NEW UNIT ADDR
         L     RLCB,PRFLCB-1-IEDQPRF(R1) .   LCB ADDR
         NI    LCBERBST,X'FF'-XXXINQ .  RESET FLAG
         L     RSCB,LCBSCBA-1 .
         IC    R1,LCBERB .
         STC   R1,LCBERBPY .
         AIF   (&A NE 3).F068
         TM    SCBQTYPE,SCBCOREQ .      READ FROM CORE
         BO    SETCPBAD .               BR YES TO RECOMPUTE CPB AD
.F068    AIF   (&A EQ 1).F069
         LH    R1,AVTAVFCT .            DECR. CT. OF AV. UNITS
         N     R1,AVTCLRHI              CLEAR HIGH BYTES       @YA07705
         TM    LCBERBST,LCBERROR .      IS THERE AN ERROR        A44866
         BO    NODECR .                 BR YES, BFR RETURN       A44866
         BCTR  R1,0 .
         STH   R1,AVTAVFCT .
NODECR   EQU   * .                                               A44866
         LA    RLCB,0(RLCB) .           CLEAR HI BYTE
         LA    R15,AVTNOBFQ-(CPBNEXTF-IEDQCPB) INITIALIZE FOR LP
CKCPB    EQU   * .
         LR    R14,R15 .                SAVE ADDR LAST CPB
CKCPBA   EQU   *                                                SA52984
         L     R15,CPBNEXTF-IEDQCPB(R14) . NEXT CPB
         L     R2,CPBAERBF .            ERB ADDR
         LA    R2,0(0,R2) .             CLEAR HI BYTE
         CR    RLCB,R2 .                SAME LCB
         BNE   CKCPB .                  NO, GO CHECK NEXT CPB    S22025
         MVC   CPBNEXT-IEDQCPB(3,R14),CPBNEXT .  REMOVE CPB
         CLI   CPBSEEK,X'FF'            IS THIS THE ORIG.       SA52984
         BE    HAVECPB                  YES-PROCESS             SA52984
         LR    R6,R14                   SAVE ADDR OF CPB PREVUS SA52984*
                                         TO THIS                SA52984
         LA    R2,AVTDKENQ              PUT THIS CPB ON Q       SA52984
         BAL   R11,ENQMGRC              TO BE PROCESSED LATER   SA52984
         LR    R14,R6                   RESTORE ADDR OF PREV    SA52984
         B     CKCPBA                   CONTINUE SEARCH         SA52984
HAVECPB  EQU   *                                                SA52984
*        RESTORE NEEDED REGS FOR RTN ON R9
         L     R2,CPBXREAF .            UNIT ADDR
         LM    R6,R11,CPBSEKFL .        RESTORE REGS FOR STATUS  A49228
         L     R14,CPBUNUSD .
         TM    LCBERBST,LCBERROR .      LINE ERROR               A44866
         BNO   CLRBFR .                 BRANCH IF NOT            A44866
         MVC   PRFLINK-IEDQPRF(3,R5),AVTBFREB+1 .                A44866
         ST    R5,AVTBFREB .            RETURN BFR JUST GOTTEN   A44866
         LTR   R11,R11 .                IS THI NEW UNIT A SINGLE A49228
*        UNIT BFR OR A SUBSEQUENT UNIT OF THE LAST BFR           A49228
         BZ    ANYBFRS .                BR IF NOT A SUBS. UNIT   A49228
         BCTR  R11,0 .                  DECR. NO. UNITS IN LAST  A49228
         STC   R11,PRFNBUNT .           SINCE THIS ONE WAS COUNTEA49228
         B     ANYBFRS .                RETURN EXTRA BFRS & ERB  A44866
.F069    AIF   (&A EQ 2).F070
SETCPBAD EQU   * .
*        AND START OVER FOR THIS CPB
         MVC   PRFLINK-IEDQPRF(3,R5),AVTBFREB+1 .
         ST    R5,AVTBFREB .            REPLACE BFR IN THE POOL
         LA    R15,AVTDOUBL-(CPBINWKA-IEDQCPB) SET DOUBL AS CPB  S22025
*                                            WORK AREA           S22025
         L     R2,SCBSCSEG-1 .          SET 2 TO UNIT ADDR
         CLM   R2,AD,PRFCORE-IEDQPRF(R2)  BFR STILL IN CORE Q  @OX20639
         BNE   RDERROR                  NO, BRANCH             @OX20639
         XC    AVTDOUBL(6),AVTDOUBL .
         TM    LCBERBST,LCBERROR .      LINE ERROR               A44866
         BNO   NEXTCPB1 .               BRANCH IF NOT            A44866
         L     RBASE,BASE1 .            RESET BASE               A44866
         B     ERBERROR-CPBINIT(RBASE) . RETURN BUFFERS & ERB    A44866
         SPACE 3
*        THIS SECTION DETERMINES WHAT TO DO WITH A BUFFER THAT IS FULL
         SPACE 3
.F070    ANOP
FULLBUF  EQU   * .
         IC    R1,LCBERBCT .
         BCTR  R1,0 .
         STC   R1,LCBERBCT .            RESET ENABLED CT -1
         OI    LCBERBCT+1,XXCTUSED .    FLAG DIABLED CT
         IC    R11,LCBERBCT+1 .         GET DISABLED CT
         MVI   LCBERBCT+1,AVTEZERO .    ZERO THE COUNT
         IC    R1,LCBERBCT .            GET NEW ENABLED CT
         AR    R1,R11 .                 ADD COUNTS
         STC   R1,LCBERBCT .
         NI    LCBERBCT,X'FF'-XXCTUSED . FLAG OFF
         CLI   LCBERBCT,AVTEZERO .
         BNE   RTNPRI .                 BR NO
         OI    LCBERBST,XCOMPL .        SET REQ COMPLETE
RTNPRI   EQU   * .
         BAL   R9,LASTTEST .            SET UP SCBUNTCT
         TM    SCBQTYPE,SCBCONC .       CONC                     S22026
         BZ    NOTCONCB .               BRANCH IF NO             S22026
         L     RSCB,LCBSCBDA-1 .        LINE SCB ADDR            S22026
         TM    SCBSTAT1,SCBCBGN .       CONC MSG BEGIN           S22026
         L     RSCB,LCBSCBA-1 .         RESET SCB ADDR           S22026
         BZ    CONCMID .                BRANCH IF NO             S22026
         BR    R14 .                    BRANCH                   S22026
NOTCONCB EQU   * .                                               S22026
         CLI   LCBERBPY,PRIINTRQ .       INIT REQ
         BCR   EQUAL,R14 .              BR YES                   S21101
CONCMID  EQU   * .                                               S22026
         CLI   LCBERBPY,PRIAPERB .      APPLICATION ERB
         BCR   EQUAL,R14 .              BR YES                   S21101
         TM    LCBSTAT1,LCBRCLLN .      IS THIS RECALL
         BCR   ONES,R14 .               BR YES -DON'T POST TO MH S21101
         L     R1,LCBERBCH-1 .          BFR ADDR FORNPOST
         MVC   LCBERBCH(3),PRFLINK-IEDQPRF(R1) .  DECHAIN BFR
         MVI   PRFPRI-IEDQPRF(R1),PRIMHBFR .
         L     RDCB,LCBDCBPT .
         MVC   PRFQCBA-IEDQPRF(3,R1),DCBMH . SET QCB ADDR FOR MH
         CLI   LCBFLAG1,LCBPLCB         THIS A PLCB            @YM06085
         BNE   NOSTORE                  BR NO, HAVE PROPER MH  @YM06085
         MVC   PRFQCBA-IEDQPRF(3,R1),LCBMHA GET PROPER MH QCB  @YM06085
         B     NOSTORE .
MOVE     MVC   0(0,R9),0(R14) .
BASE1    DC    A(CPBINIT) .
XMASK    DC    X'000000FF' .
         AIF   (&A NE 3).F071
         SPACE 3
*        THIS SECTION INITIALIZES THE CPB ADDRESS AND BUFFER SIZE
*        FOR A CORE QUEUED OPERATION.
         SPACE 3
RESETA   EQU   * .
         MVC   SCBSCHDR(3),AVTDOUBL+1 .
         MVC   SCBSCSEG(3),SCBSCHDR .
.F071    AIF   (&A EQ 2).F072
CALLFQA  EQU   * .
         L     R2,SCBSCSEG-1 .
         L     RPRF,SCBSCHDR-1 .
         TM    LCBSTAT1,LCBRCLLN .      RECALL
         BNO   SETCPB .                 BR NO
         ST    R6,AVTDOUBL .            SET BFR ADDR
         CLC   AVTDOUBL+1(3),PRFCORE .
*        IS THIS BFR STILL IN THE CORE QUEUE
         BE    SETCPB .                 BR YES
         LA    R5,ERBRCQCB .            SET RTN ADDR
         B     FREEBFRS .               RETURN 0 TP BD
SETCPB   EQU   * .
         BALR  R7,0                     TO EXTEND BASE         @Y17XA0Z
         USING *,R7                     TELL ASSEMBLER         @Y17XA0Z
         LA    R7,HAVESIZE .            SET RTN
         DROP  R7                       DROP EXTENDED BASE     @Y17XA0Z
         CLI   LCBERBKY,AVTEZERO .      SIZE THERE
         BCR   EQUAL,R7 .               BR IF EQUAL TO SIZE THERES21101
         TM    PRFSTAT1,PRFNHDRN .      THIS A HDR
         BNO   OFFSET .
         L     RPREFIX,PRFCHDR .         GET ADDR OF HDR
         SRL   RPREFIX,8 .             SHIFT OUT LOW BYTE
         B     OFFSET .
HAVESIZE EQU   * .
         XC    AVTDOUBL(7),AVTDOUBL .   CLEAR FOR WORK AREA
         LA    R15,AVTDOUBL-(CPBINWKA-IEDQCPB) SET DOUBL AS CPB  S22025
*                                            WORK AREA           S22025
         IC    R9,LCBERBQB .
*        THE NO OF UNITS PER BUFFER WILL BE IN ERBQB
         IC    R8,LCBERBCT .
         MR    R8,R8 .
         STC   R9,SCBCPBNO .
         B     NEXTCPB1 .               BR TO PROCESS THIS BFR UNIT
.F072    ANOP
THREE    EQU   3                        LENGTH                 @OX20639
         AIF   (&A EQ 2).F077
         SPACE 3
*        THIS SECTION WILL FREE A MESSAGE FROM THE CORE QUEUE AND
*        UPDATE THE MSUNIT COUNT.
         SPACE 3
FREEMSG  EQU   * .
         DROP  12 .
         USING *,R15 .
         MVC   AVTDOUBL+1(3),PRFCHDR .  GET ADDR OF CORE UNIT THIS
         TM    PRFSTAT1,PRFNHDRN .
         BO    USECHDR .
         MVC   AVTDOUBL+1(3),PRFCORE .
USECHDR  EQU   * .
         L     R2,AVTDOUBL .            MSG HDR CAME FROM
HAVEADDR EQU   *                                                SA68051
         LA    R2,0(,R2) .              CLEAR HIGH ORDER BYTE
*        THE MSG MUST BE REMOVED FROM THE HDR CHAIN
*    R6 DOES NOT HAVE A BFR ADDR, R2 HAS THE HDR ADDR OF MSG
         L     R10,AVTCADDR .           NO. OF CORE UNITS IN USE
         LR    R8,R9 .
         DROP  RPREFIX .
         USING PRFSUNIT,R8 .
*        SET BASE SO THAT QCBCFHDR WILL COINCIDE WILH
*        PRFNHDR
         LA    R8,((QCBCFHDR-IEDQPQCB)-(PRFNHDR-PRFSUNIT))(R8) .
COMPARE1 EQU   * .
         CLC   PRFNHDR(3),PRFCORE-IEDQPRF(R2) .
*        IS THIS THE MSG TO REMOVE
         BE    TAKEOUT .                BR UES
         LNR   R2,R2 .                  SET FLAG FOR RTN HERE
         NC    PRFNHDR(3),PRFNHDR .     IS THIS THE LAST ONE
         BCR   ZERO,R7 .                BR YES - MSG NOT THERE   S21101
         LPR   R2,R2 .                  RESET  FLAG FOR NO RTN
         MVC   AVTDOUBL+5(3),PRFNHDR .  ADDR OF NEXT MSG
         L     R8,AVTDOUBL+4 .
         LA    R8,PRFSUNIT-IEDQPRF(R8) .SET BASE FOR USIGN
         B     COMPARE1 .
TAKEOUT  EQU   * .
         MVC   PRFNHDR(3),PRFNHDR-IEDQPRF(R2) .
*                                       LINK NHDR OF THIS MSG   SA51078
*                                       INTO NHDR OF PREV ONE   SA51078
         DROP  R8 .
         USING IEDQPRF,RPREFIX .
         LR    R8,R6 .                  SET 8 FOR MOVE
         TM    PRFSTAT1,PRFNHDRN .      IS THIS A HDR
         BNO   MVCCRCD .                BR IF HDR TO SET CRCD TO
*        DISK HDR ADDRESS
         LA    R8,PRFCHDR-PRFCRCD(R8) . IF NOT HDR SET TO UPDATE
*        THE CHDR FIELD TO THE REAL ADDRESS OF THE DISK HDR
MVCCRCD  EQU   * .
         MVC   PRFCRCD-IEDQPRF(3,R8),PRFCRCD-IEDQPRF(R2) .
*        UPDATE TO THE PROPER DISK ADDRESS OF THE HDR TO WRITE
*        THE SERVICED FLAG
         TM    DATFLAGS,DATLOSTN+DATINITL .       THIS MSG LOST
         BM    LOSTMSG .                BR IF LOST BUT NOT INIT
*        TO FREE 1 UNIT
         TM    PRFSTAT1-IEDQPRF(R2),PRFDUPLN .
*                                       IS THIS A DUPL HDR
         BNO   ALLDUPL .                BR YES
*        WHEN IN CORE QUEUES DUPL HDRS ARE COUNTED IN FIRST TIC
         CLI   PRFNBUNT-IEDQPRF(R2),EONE .  ONLY 1 UNIT IN BFR
         BH    GETTIC .                 BR MORE THAN 1
         MVC   AVTDOUBL+5(3),PRFNTXT-IEDQPRF(R2) .
         L     R14,AVTDOUBL+4 .         ADDR NEXT BFR
         B     GETDUPCT .
GETTIC   EQU   * .
         L     R14,PRFTIC-IEDQPRF(R2) . ADDR NEXT UNIT
GETDUPCT EQU   * .
         LA    R14,0(R14) .             CLEAR HI BYTE
         LTR   R14,R14 .                MORE BUFFERS FOR THIS DUPL
         BZ    LOSTMSG .                BR NO TO FREE 1 UNIT
*        THERE IS NO COUNT TO UPDATE IN THIS CASE
         SR    R11,R11 .
         IC    R11,PRFTIC-IEDQPRF(R14) .NUMBER OF DUPL HDRS
         LTR   R11,R11 .
         BZ    ALLDUPL .                BR IF NONE LEFT
         BCTR  R11,0 .                  DECR COUNT
         STC   R11,PRFTIC-IEDQPRF(R14) .RESTORE
LOSTMSG  EQU   * .
         XC    PRFTIC+1-IEDQPRF(3,R2),PRFTIC+1-IEDQPRF(R2) .
         MVI   PRFNBUNT-IEDQPRF(R2),EONE .  SET TO 1 UNIT
         LR    R1,R2 .                  POST FREED UNIT
         LA    R2,AVTBFRTB .
         OI    PRFCORE+2-IEDQPRF(R1),EONE .  SET ADDR BAD
         MVI   PRFPRI-IEDQPRF(R1),PRIBFRTB .
         ST    R7,AVTDOUBL+4 .          SAVE RETURN ADDR
         L     R7,ADRTNBFR .
         BAL   R14,POST-RTNBFR(R7) .
         L     R7,AVTDOUBL+4 .           RESTORE RETURN ADDR
         BCTR  R10,R0 .
CKCMIN   EQU   * .
         ST    R10,AVTCADDR .           RESTORE CADDR
         CL    R10,AVTCMIN .            HAS THE NO. OF CORE UNITS
         BNL   CKCMAX .                 REACHED THE MINIMUN BR NO
         OI    AVTSYSER,AVTCMINN .      SET FLAG FOR MIN
CKCMAX   EQU   * .
         CL    R10,AVTCMAX .            HAS CADDR BECOME LOWER
         BCR   10,R7 .                  BR NO
         NI    AVTSYSER,AVTCMAXF .      MAX OFF
         NI    AVTBIT3,AVTRECVF .       SET REV SWITCH ON
         BR    R7 .                     RETURN
ALLDUPL  EQU   * .
         LA    R5,1(R5) .               RESET NO. OF UNITS
         ST    R7,AVTDOUBL+4 .          SAVE RTN ADDR
         SR    R8,R8 .
SETBFR   EQU   * .
         L     R1,AVTDOUBL .             BFR ADDRESS
         OI    PRFCORE+2-IEDQPRF(R1),EONE .  SET BAD ADDR
         IC    R8,PRFNBUNT-IEDQPRF(R1) .    NO UNITX
         L     R7,ADRTNBFR .
         BALR  R14,R7 .
         SR    R10,R8 .                 SUBTRACT NO IN THIS BFR
         L     R1,AVTDOUBL .             FROM CADDR
         BAL   R7,CKCMIN .
         L     R7,AVTDOUBL+4 .          RTN ADDR
         TM    PRFSTAT1-IEDQPRF(R1),PRFNLSTN .
         BCR   ZERO,R7 .                                         S21101
*    IF THE LAST BFR WAS THE LAST SEGMENT RETURN
         NC    PRFNTXT-IEDQPRF(3,R1),PRFNTXT-IEDQPRF(R1) .
         BCR   ZERO,R7 .                BR IF NO NTXT            S21101
         MVC   AVTDOUBL+1(3),PRFNTXT-IEDQPRF(R1) .
*                        ADDR OF NEXT TXT BFR
         B     SETBFR .
ADRTNBFR DC    A(RTNBFR) .
         DROP  15 .
         USING IEDQCPB,R15 .
.F077    ANOP
         SPACE 3
*        WILL GET THE BUFFER SIZE FROM THE TERMINAL TABLE OR DCB
*        FOR BUILDING THE BUFFERS.
         SPACE 3
         USING *,15 .
OFFSETA  EQU   * .
         TM    LCBSTAT1,LCBSENDN .      SEND OPERATION           A42363
         BO    OFFSET1 .                BR YES                   A42363
         TM    LCBSTAT1,LCBRCLLN .      THIS A RECALL            A42363
         BNO   OFFSET1 .                BR NOT RECALL            A42363
*        THIS CODE TO EXECUTE ONLY IF RECEIVE RECALL - TEST FOR  A42363
*        RCV AND RCLL WILL CAUSE RETRIEVE TO PROGRAM CK          A42363
         L     R1,ADRSZCK1 .
         TM    LCBCHAIN,LCBBFRSZ .      SPECIAL RECALL
         BCR   ONES,R1 .                                         S21101
OFFSET1  EQU   * .
         LH    R1,PRFDEST .
         TM    PRFSTAT1,PRFNHDRN .      IS THIS A HDR
         BNO   TERMENTR .               BR YES
*        IF NOT A HDR DOES NOT CONTAIN THE DEST OFFSET
USELCBA  EQU   * .
         LH    R1,LCBTTCIN .            DEST OFFSET
TERMENTR EQU   * .
         N     R1,AVTCLRHI .
         LTR   R1,R1 .                  IS TTCIN 0 - TTCIN IS THE ONLY
*        ONE OF THE FIELDS PICKED UP THAT CAN BE 0
         BNZ   TTCINOK .                BR IF NOT 0 - THIS ISNOT
*        RETRIEVE
         TM    LCBSTAT2,LCBDIAL         IS THIS DIAL LCB          M2321
         BO    TTCINOK                  YES,BRANCH -NOT RETRIEVE  M2321
         MVC   LCBERBQB+1(2),AVTKEYLE . IF RETRIEVE - SET TO BUILD
         MVI   LCBERBQB,X'01' .         SINGLE UNIT BFRS
         MVI   LCBERB,X'00' .
         BR    R7 .                     RETURN
TTCINOK  EQU   * .
         L     R15,AVTRNMPT .
         BALR  R14,R15 .
*        TERM TABLE ENTRY ADDRESS IS IN R1,  IF BUFFER SIZE IS
*        SPECIFIED IN T TABLE, PUT IT IN LCBERBQP+1, IF NOT
*        USE DCBBFSZE.
         USING *,15 .
         LR    R15,R14 .                RESET ADDRESSIBILITY
         USING IEDQTRM,R1 .
         TM    TRMDEVFL,X'80' .         IS A BFR SZ SPECIFIED
         BNO   USEDCBA .
*        IF FROM T TABLE
         SR    R10,R10 .                ZERO REG
         LA    R14,TRMOPNO+1 .          LOC OF BFR SZ IF NO OPT
         TM    TRMSTATE,TRMOPTFN .      ARE OP. SPECIFIED
         BNO   NONE .                   BR NO
         LR    R14,R10 .                ZERO 14
         IC    R14,TRMOPNO .            NO OF OPT FIELDS
         LA    R14,TRMOPT+1(R14) .      ADDR OF OPT FIELDS + 1  + NO
*        OF OPT FIELDS GIVES THE LOCATION OF BFR SIZE
         DROP  R1 .
NONE     EQU   * .
         MVC   LCBERBQB+1(2),0(R14) .   SET ERBQB
         LH    R1,LCBERBQB+1 .
         L     R11,ADSBTR .
         BALR  R14,R11 .
         SRL   R10,DIV4 .               ADJUST R10               S21101
         B     SIZEDONE .
USEDCBA  EQU   * .
         L     RDCB,LCBDCBPT .          DCB ADDR
         LH    R1,DCBBFSZE .            SET SIZE AND NUMBER OF
         STH   R1,LCBERBQB+1 .          UNITS IN BFR IN
         IC    R10,DCBUNTCT .           ERBQB AND ERBQB+1
SIZEDONE EQU   * .
         STC   R10,LCBERBQB .
         MVI   LCBERBKY,AVTEZERO .     SET SIZE THERE FLAG
         BR    R7 .
ADSBTR   DC    A(SUBTRKEY) .
ADRSZCK1 DC    A(SIZECK1) .
         USING IEDQCPB,R15 .
*        WILL ENQUEUE AN ELEMENT ( BFR ,ERB, OR CPB) ON A FIFO Q
ENQMGRBA EQU   * .
         USING ENQMGRBA,R14
*        INPUT PARAMETERS - R2 - Q ADDR, R15 - ELEM ADDR
*        R14 - BASE REG     R1 - SCRATCH REG      15 WILL BE KEPT
         XC    PRFLINK-IEDQPRF(3,R15),PRFLINK-IEDQPRF(R15) .
*        CLEAR LINK FIELD OF BFR OR ERB
         LTR   R2,R2 .                  SET POSITIVE COND CODE
         BAL   R14,NOMPCK               SKIP TS INSTRUCTION      Y02027
         AIF   (&A EQ 1).F023
ENQMGRCA EQU   * .
*        WHEN ENTERED HERE THE HI BYTE OF 14 IS 0
.F023    ANOP
         USING *,R14 .
MPLOOP   EQU   *                                                 Y02027
         TS    AVTEZERO(R2)             LOCK Q FOR UPDATE        Y02027
         BNE   MPLOOP                   YES, LOOP TILL APP. DONE Y02027
NOMPCK   EQU   *                                                 Y02027
         L     R1,4(R2) .               ADDR LASR ON Q
         LA    R1,PRFLINK-IEDQPRF(R1) . SET ADDR OF LINK FIELD
         AIF   (&A EQ 1).F024
         SPM   R14 .                    RESET COND CODE
         BP    ENQBFR .                 BR IF A BFR OR ERB
         LA    R1,((CPBNEXT-IEDQCPB)-(PRFLINK-IEDQPRF))(R1) .
*        IF IT WAS A CPB CORRECT THE ADDR OF LINK FIELD
         XC    CPBNEXT(3),CPBNEXT .     ZERO CPB LINK FIELD
.F024    ANOP
ENQBFR   EQU   * .
         ST    R15,4(R2) .              SET NEW LAST ELEM
         NC    1(3,R2),1(R2) .          IS ONE ON THE Q
         BNZ   ENQNMTY .                BR IF YES
         MVC   1(3,R2),5(R2) .          IF NOT SET ADDR OF FIRST
         MVI   AVTEZERO(R2),AVTEZERO    CLEAR Q LOCK             Y02027
         BR    R11 .                    RETURN
ENQNMTY  EQU   * .
         MVC   0(3,R1),5(R2) .          LINK THIS ONE TO PREVIOUS
         MVI   AVTEZERO(R2),AVTEZERO    CLEAR Q LOCK             Y02027
         BR    R11 .                    LAST ONE AND RETURN
         TITLE '''IEDQFA'' - DSECTS' .                           S22025
*        TPRIOR
         TPRIOR
         EJECT , .                                               S22025
*        DCBD
         DCBD  DSORG=TX .
DCBBFSZE EQU   DCBBUFSI .
         EJECT , .                                               S22025
*        TDISPD
         TDISPD
         EJECT , .                                               S22025
*        TCPBD 3330                                              S21101
         TCPBD 3330                                              S21101
         EJECT , .                                               S22025
*        TDATD
         TDATAD
         EJECT , .                                               S22025
*        TSCBD
         TSCBD
XFEFO    EQU   SCBFEFO .
SCBSQOUT EQU   SCBCLSEG+1-IEDQSCB .
         EJECT , .                                               S22025
*        TQCBD
         TQCBED .                       QCBE DSECT               S22026
         TQCBD
         EJECT , .                                               S22025
*        TPRFD
         TPRFD
         EJECT , .                                               S22025
*        TLCBD
         TLCBD
LCBNSRCD EQU   X'01' .                  IN-SOURCE CHAIN FLAG     S22025
         EJECT , .                                               S22025
*        TTRMD
         TTRMD
         EJECT , .                                               S22025
*        TAVTD , .                                               S22025
         TAVTD , .                                               S22025
         TTSID                                                   S22028
         MEND

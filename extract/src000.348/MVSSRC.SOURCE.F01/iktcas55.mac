         TITLE 'IKTCAS55-- ESTAE EXIT ROUTINE'
IKTCAS55 CSECT ,                                                   0001
@MAINENT DS    0H                                                  0001
         USING *,@15                                               0001
         B     @PROLOG                                             0001
         DC    AL1(16)                                             0001
         DC    C'IKTCAS55  80.232'                                 0001
         DROP  @15
@PROLOG  DS    0H                                                  0002
         BALR  R15,0
         USING *,R15
         C     R0,INDSDWA            TEST IS THERE SDWA
         BNE   YSDWA                 BR IF YES -R0 NOT 12
         B     START                 BR AROUND NO SDWA
INDSDWA  DC    F'12'                 CODE 12 MEANS NO SDWA
YSDWA    STM   R14,R12,12(R13)       SAVE REGS IN SDWA
         L     R2,0(R1)              R1 PTR ADDR OF PARAMETER
START    BALR  R12,0                 R12 BASE REG
         USING *,R12
         USING @DATD-4,R2             R2 PTR PARAMETR PASSED FROM
*                                     TASK AND R2+4 IS WORK AREA FOR
*                                     ESTAE WHICH MAY BE USED FOR
*                                     AUTO DATA
*      ETWAWA=''B ;                    /* CLEAR THE WORK AREA        */
         XC    ETWAWA(48,R2),ETWAWA(R2)                            0036
*      STM(R0,R2,SAVE) ;               /* SAVE REGISTERS 0,1,2       */
         STM   R0,R2,SAVE                                          0037
*      SAVER(4)=R14  ;                 /* SAVE RETURN REG            */
         ST    R14,SAVER+12                                        0038
*      TWAPTR=ETWATWA ;                /* TWA ADDRESSIBILITY         */
         L     TWAPTR,ETWATWA(,R2)                                 0039
*/*                                                                  */
*/*      VALIDITY CHECK THE ID OF TASK PASSED IN PARAMETER           */
*/*                                                                  */
*      IF ETWAID^='MAIN'               /* IF IT IS NOT MAIN TASK     */
*         THEN IF ETWAID^='VTAM'       /* IF IT IS NOT VTAM INT TASK */
         CLC   ETWAID(4,R2),@CC00302                               0040
         BE    @RF00040                                            0040
*           THEN IF ETWAID^='USER'     /* IF IT IS NOT USER INT TASK */
         CLC   ETWAID(4,R2),@CC00303                               0041
         BE    @RF00041                                            0041
*             THEN IF ETWAID^='COMM'   /* IF IT IS NOT CON COMM TASK */
         CLC   ETWAID(4,R2),@CC00304                               0042
         BE    @RF00042                                            0042
*               THEN DO ;              /* THEN ABEND                 */
         CLC   ETWAID(4,R2),@CC00305                               0043
         BE    @RF00043                                            0043
*                 R1=RCABEND ;         /* SET ABEND INDICATOR        */
         SLR   R1,R1                                               0045
*                 CALL RTNR;           /* THE ROUTINE PROCESS RETURN */
         BAL   @14,RTNR                                            0046
*                 END ;                                            0047
*    /*                                                              */
*    /*        CHECK AND ESTABLISH RETRY CRITERIOR THAT IS:          */
*    /*          1 RETRY ADDR SPECIFIED IN FOOTPRINTS                */
*    /*          2 NO PREVIOUS RETRY RECORDS FOR THIS ROUTINE        */
*    /*                                                              */
*      DO INDEX=4 TO 2 BY -1           /* PIN POINT THE LAST FTPRINT */
*         WHILE(ETWAEIFC(INDEX)=0);    /* WHICH CONTAIN THE FUNCTION */
@RF00043 DS    0H                                                  0048
@RF00042 DS    0H                                                  0048
@RF00041 DS    0H                                                  0048
@RF00040 LA    INDEX,4                                             0048
@DL00048 LR    @06,INDEX                                           0048
         SLA   @06,3                                               0048
         SLR   @03,@03                                             0048
         IC    @03,ETWAEIFC-8(@06,R2)                              0048
         C     @03,@CF00150                                        0048
         BNE   @DC00048                                            0048
*      END ;                           /* CODE                       */
         BCTR  INDEX,0                                             0049
         C     INDEX,@CF00073                                      0049
         BNL   @DL00048                                            0049
@DC00048 DS    0H                                                  0050
*      IF ETWAEIFC(INDEX)^=0           /* IF THERE IS FUNCTION CODE  */
*         THEN DO ;                    /* THEN FURTHER CHECKING      */
         SLR   @06,@06                                             0050
         LR    @03,INDEX                                           0050
         SLA   @03,3                                               0050
         SLR   @15,@15                                             0050
         IC    @15,ETWAEIFC-8(@03,R2)                              0050
         CR    @06,@15                                             0050
         BE    @RF00050                                            0050
*         IF ETWAERA(INDEX)^=0         /* IF RETRY ADDR SPECIFIED    */
*            THEN DO ;                 /* FURTHER CHECKING           */
         L     @15,ETWAERA-9(@03,R2)                               0052
         LA    @15,0(,@15)                                         0052
         LTR   @15,@15                                             0052
         BZ    @RF00052                                            0052
*             IF ETWAERRS(INDEX)^=0    /* IF REG SAVE AREA ADDR VALID*/
*                THEN DO ;             /* FURTHER CHECKING           */
         C     @06,ETWAERRS-8(@03,R2)                              0054
         BE    @RF00054                                            0054
*                DO R8=1 TO 7              /* CHECK RETRY RECORD AREA*/
*                   WHILE(ETWARTFC(R8) /*     IF THERE IS A MATCH,   */
*                    ^= ETWAEIFC(INDEX)) ; /* MEANS RETRIED BEFORE   */
         LA    R8,1                                                0056
@DL00056 LR    @06,INDEX                                           0056
         SLA   @06,3                                               0056
         SLR   @03,@03                                             0056
         IC    @03,ETWARTFC-1(R8,R2)                               0056
         SLR   @15,@15                                             0056
         IC    @15,ETWAEIFC-8(@06,R2)                              0056
         CR    @03,@15                                             0056
         BE    @DC00056                                            0056
*                END ;                                             0057
         AL    R8,@CF00062                                         0057
         C     R8,@CF00064                                         0057
         BNH   @DL00056                                            0057
@DC00056 DS    0H                                                  0058
*                IF R8>= 8             /* IF NO MATCH                */
*                   THEN DO ;          /* PROCESS RETRY              */
         C     R8,@CF00060                                         0058
         BL    @RF00058                                            0058
*                   DO R8=1 TO 7             /* FIND AN AVAILABLE    */
*                     WHILE(ETWARTFC(R8)     /* SLOT IN RETRY RECORD */
*                           ^=0);            /* AREA                 */
         LA    R8,1                                                0060
@DL00060 SLR   @06,@06                                             0060
         IC    @06,ETWARTFC-1(R8,R2)                               0060
         C     @06,@CF00150                                        0060
         BE    @DC00060                                            0060
*                   END ;                                          0061
         AL    R8,@CF00062                                         0061
         C     R8,@CF00064                                         0061
         BNH   @DL00060                                            0061
@DC00060 DS    0H                                                  0062
*                ETWARTFC(R8)=ETWAEIFC(INDEX) ;/* RECORD RETRY       */
         LR    @06,INDEX                                           0062
         SLA   @06,3                                               0062
         SLR   @03,@03                                             0062
         IC    @03,ETWAEIFC-8(@06,R2)                              0062
         STC   @03,ETWARTFC-1(R8,R2)                               0062
*                R1=RCRETRY ;          /* RETRY INDICATOR            */
         LA    R1,4                                                0063
*                CALL RTNR  ;          /* TO PROCESS RETURN          */
         BAL   @14,RTNR                                            0064
*                   END ;                                          0065
*                END ;                                             0066
*            END ;                                                 0067
*         END ;                                                    0068
*         ELSE ETWAEIFC(INDEX)=DUMMYFC;/* NO FUNCTION CODE IN FTPRINT*/
         B     @RC00050                                            0069
@RF00050 LR    @06,INDEX                                           0069
         SLA   @06,3                                               0069
         LA    @03,255                                             0069
         STC   @03,ETWAEIFC-8(@06,R2)                              0069
*                                      /* SUPPLY A DUMMY CODE        */
*    /*                                                              */
*    /*        FAIL RETRY CRITERIOR - TASK WILL BE ABENDED.          */
*    /*                                                              */
*    /*          IF THE SUBTASK HAS NO PREVIOUS ABEND RECORD,        */
*    /*          A RE-ATTACH W.E. IS BUILT AND QUEUE ON SYNCHRONOUS  */
*    /*          TO RE-ATTACH THE SUBTASK.                           */
*    /*                                                              */
*    /*          IF MAIN TASK OR  PREVIOUS ABENDED SUBTASK, NO       */
*    /*             RE-ATTACH DONE AND TCAS WILL TERMINATE.          */
*    /*             IN THAT CASE, TWO W.E.S ARE BUILT- CALL TCAS     */
*    /*             TERMINATION AND TERMINATE MAIN TASK.             */
*    /*                                                              */
*      DO R8= 1 TO 3 WHILE             /* FIND AVAILABLE SLOT IN     */
*         ETWAABFC(R8)^=0  ;           /* ABEND RECORD AREA          */
@RC00050 LA    R8,1                                                0070
@DL00070 SLR   @06,@06                                             0070
         IC    @06,ETWAABFC-1(R8,R2)                               0070
         C     @06,@CF00150                                        0070
         BE    @DC00070                                            0070
*      END ;                                                       0071
         AL    R8,@CF00062                                         0071
         C     R8,@CF00146                                         0071
         BNH   @DL00070                                            0071
@DC00070 DS    0H                                                  0072
*      ETWAABFC(R8)  =  ETWAEIFC(INDEX); /* SET RECORD               */
         LR    @06,INDEX                                           0072
         SLA   @06,3                                               0072
         SLR   @03,@03                                             0072
         IC    @03,ETWAEIFC-8(@06,R2)                              0072
         STC   @03,ETWAABFC-1(R8,R2)                               0072
*      CALL TERM ;                     /* TO DO SOME TERMINATION WORK*/
         BAL   @14,TERM                                            0073
*      IF ETWAID='MAIN'                /* IS MAIN TASK ABEND         */
*         THEN DO ;                    /* YES                        */
         CLC   ETWAID(4,R2),@CC00302                               0074
         BNE   @RF00074                                            0074
*         R1=RCABEND ;                 /* SET ABEND INDICATOR        */
         SLR   R1,R1                                               0076
*         CALL RTNR ;                  /* TO PROCESS RETURN          */
         BAL   @14,RTNR                                            0077
*         END ;                                                    0078
*         RFY WESTD BASED(ADDR(BUILDWE)); /* BUILD FIRST W.E. AREA   */
@RF00074 DS    0H                                                  0080
*         WECODE1T=TCML ;              /* ASSIGN TASK CODE MAIN TASK */
         LA    @06,BUILDWE                                         0080
         MVI   WECODE1T(@06),X'01'                                 0080
*         WECODE2T=TCML ;              /* SECONDARY T.C. MAIN TASK   */
         MVI   WECODE2T(@06),X'01'                                 0081
*         WECODE2F=FCMLAT ;            /* SECONDARY F.C. ABEND MAIN  */
         MVI   WECODE2F(@06),X'92'                                 0082
*         WELEN=12 ;                   /* W.E. LENGTH                */
         MVC   WELEN(2,@06),@CH00148                               0083
*      BUILDWE1=BUILDWE ;              /* INIT SECOND W.E.           */
         MVC   BUILDWE1(12),BUILDWE                                0084
*      WERC=TTECDT+TTECFR ;            /* DETACH SUBTASK AND FREE    */
         MVC   WERC(2,@06),@CH00343                                0085
*                                      /* X MEMORY REQUEST ENTRY CODE*/
*      RFY  WESTD BASED (ADDR(BUILDWE1));                          0086
*      WECODE1F=FCMLET ;               /* END OF MAIN TASK F.C.      */
         LA    @03,BUILDWE1                                        0087
         MVI   WECODE1F(@03),X'91'                                 0087
*         RFY WESTD BASED(ADDR(BUILDWE)); /* BUILD FIRST W.E. AREA   */
*         IF ETWAID='VTAM'             /* IS THIS VTAM INT           */
*            THEN DO ;                 /* YES                        */
         CLC   ETWAID(4,R2),@CC00303                               0089
         BNE   @RF00089                                            0089
*            IF ETWAABFC(2)^=0         /* PREVIOUS ABEND RECORD EXIST*/
*               THEN DO ;              /* YES                        */
         CLI   ETWAABFC+1(R2),0                                    0091
         BE    @RF00091                                            0091
*               WECODE1F=FCMLTT ;      /* TCAS TERMINATION F.C.      */
         MVI   WECODE1F(@06),X'80'                                 0093
*               WENEXT=ADDR(BUILDWE1) ; /* CHAIN NEXT W.E.           */
         ST    @03,WENEXT(,@06)                                    0094
*               ADDR(BUILDWE1)->WERC=RCVABE ;  /* SET ABEND REASON   */
         MVC   WERC(2,@03),@CH00032                                0095
*                                      /* VTAM INT SUBTASK ABEND     */
*               END ;                                              0096
*               ELSE DO ;                                          0097
         B     @RC00091                                            0097
@RF00091 DS    0H                                                  0098
*            WECODE1F=FCMLAV ;         /* SET F.C. ATTACH VTAM INT   */
         LA    @06,BUILDWE                                         0098
         MVI   WECODE1F(@06),X'50'                                 0098
*            WENEXT=ADDR(BUILDWE1) ;   /* SET CHAIN TO NEXT WE       */
         LA    @03,BUILDWE1                                        0099
         ST    @03,WENEXT(,@06)                                    0099
*            RFY WESTD BASED (ADDR(BUILDWE1));                     0100
*            WECODE1T=TCVI ;           /* VTAM INT SUBTASK           */
         MVI   WECODE1T(@03),X'02'                                 0101
*            WECODE1F=FCVIAS ;         /* TO START LOGON AGAIN       */
         MVI   WECODE1F(@03),X'14'                                 0102
*            WECODE2F=FCMLSC ;         /* 2ND DESTINATION IF FAIL    */
         MVI   WECODE2F(@03),X'10'                                 0103
*            WENEXT=ADDR(BUILDWE2);    /* PTR TO RETURN WE   @ZA19856*/
         LA    @06,BUILDWE2(,TWAPTR)                               0104
         ST    @06,WENEXT(,@03)                                    0104
*            RFY WESTD BASED(ADDR(BUILDWE2)); /*RETURN WE PTR@ZA19856*/
*            WECODE1T=TCML;            /* MAIN TASK ID       @ZA19856*/
         LA    @06,524                                             0106
         ALR   @06,TWAPTR                                          0106
         MVI   WECODE1T(@06),X'01'                                 0106
*            WECODE1F=FCMLSC;          /* START COMM PROC    @ZA19856*/
         MVI   WECODE1F(@06),X'10'                                 0107
*            WECODE2F=FCRTN;           /* RETURN             @ZA19856*/
         MVI   WECODE2F(@06),X'FF'                                 0108
*            RFY WESTD BASED (ADDR(BUILDWE)) ;                     0109
*            TWAVFL5='0'B ;            /* RESET ACB OPEN BIT         */
*            TWAVFL6='0'B ;            /* RESET START LOGON BIT      */
         NI    TWAVFL5(TWAPTR),B'11110011'                         0111
*            END ;                                                 0112
*            R9=0 ;                    /* ZERO FOR COMPARE SWAP      */
@RC00091 SLR   R9,R9                                               0113
*            R10=ADDR(BUILDWE) ;       /* ADDR OF 1ST W.E. TO BE QED */
         LA    R10,BUILDWE                                         0114
*            TWAVFL2='1'B ;            /* SET ABEND BIT              */
         OI    TWAVFL2(TWAPTR),B'01000000'                         0115
*            CS(R9,R10,TWASYNQH) ;     /* QUEUE W.E. ON SYNC Q       */
         CS    R9,@10,TWASYNQH(TWAPTR)                             0116
*            IF R9=0                   /* IF SUCCESSFUL              */
*               THEN TWAVFL4='1'B ;    /* SET ESTAE COMPLETION BIT   */
         LTR   R9,R9                                               0117
         BNZ   @RF00117                                            0117
         OI    TWAVFL4(TWAPTR),B'00010000'                         0118
*            END ;                                                 0119
*            ELSE                      /* NOT VTAM                   */
*            IF ETWAID='USER'          /* IS THIS USER INT           */
*               THEN DO ;              /* YES                        */
         B     @RC00089                                            0120
@RF00089 CLC   ETWAID(4,R2),@CC00304                               0120
         BNE   @RF00120                                            0120
*         IF ETWAEIFC(INDEX)=FCUICR    /* IS IT A.S. CREATION F.C.   */
*            THEN CALL CLEANUP ;       /* YES, BR TO CLEAN UP ROUTINE*/
         LR    @06,INDEX                                           0122
         SLA   @06,3                                               0122
         SLR   @03,@03                                             0122
         IC    @03,ETWAEIFC-8(@06,R2)                              0122
         C     @03,@CF00196                                        0122
         BNE   @RF00122                                            0122
         BAL   @14,CLEANUP                                         0123
*            IF ETWAABFC(2)^=0         /* PREVIOUS ABEND RECORD EXIST*/
*               THEN DO ;              /* YES                        */
@RF00122 CLI   ETWAABFC+1(R2),0                                    0124
         BE    @RF00124                                            0124
*               WECODE1F=FCMLTT ;      /* TCAS TERMINATION F.C.      */
         LA    @06,BUILDWE                                         0126
         MVI   WECODE1F(@06),X'80'                                 0126
*               WENEXT=ADDR(BUILDWE1) ; /* CHAIN NEXT W.E.           */
         LA    @03,BUILDWE1                                        0127
         ST    @03,WENEXT(,@06)                                    0127
*               ADDR(BUILDWE1)->WERC=RCUABE ;  /* SET ABEND REASON   */
         MVC   WERC(2,@03),@CH00237                                0128
*                                      /* USER INT SUBTASK ABEND     */
*               END ;                                              0129
*               ELSE                                               0130
*               WECODE1F=FCMLAU ;      /* F.C. ATTACH USER INT       */
         B     @RC00124                                            0130
@RF00124 LA    @06,BUILDWE                                         0130
         MVI   WECODE1F(@06),X'60'                                 0130
*               TWAUFL2='1'B ;         /* SET ABEND BIT              */
@RC00124 OI    TWAUFL2(TWAPTR),B'01000000'                         0131
*               R9=0 ;                 /* ZERO FOR COMPARE SWAP      */
         SLR   R9,R9                                               0132
*               R10=ADDR(BUILDWE) ;    /* R10 PTR 1ST WE TO BE QED   */
         LA    R10,BUILDWE                                         0133
*               CS(R9,R10,TWASYNQH);   /* QUEUE W.E. ON SYNC Q       */
         CS    R9,@10,TWASYNQH(TWAPTR)                             0134
*               IF R9=0                /* IF SUCCESSFUL              */
*                  THEN TWAUFL4='1'B ; /* SET ESTAE COMPLETION BIT   */
         LTR   R9,R9                                               0135
         BNZ   @RF00135                                            0135
         OI    TWAUFL4(TWAPTR),B'00010000'                         0136
*               END ;                                              0137
*            ELSE                      /* NOT USER                   */
*            IF ETWAID='COMM'          /* IS THIS CON COMM INT       */
*               THEN DO ;              /* YES                        */
         B     @RC00120                                            0138
@RF00120 CLC   ETWAID(4,R2),@CC00305                               0138
         BNE   @RF00138                                            0138
*            IF ETWAABFC(2)^=0         /* PREVIOUS ABEND RECORD EXIST*/
*               THEN DO ;              /* YES                        */
         CLI   ETWAABFC+1(R2),0                                    0140
         BE    @RF00140                                            0140
*               WECODE1F=FCMLTT ;      /* TCAS TERMINATION F.C.      */
         LA    @06,BUILDWE                                         0142
         MVI   WECODE1F(@06),X'80'                                 0142
*               WENEXT=ADDR(BUILDWE1) ; /* CHAIN NEXT W.E.           */
         LA    @03,BUILDWE1                                        0143
         ST    @03,WENEXT(,@06)                                    0143
*               ADDR(BUILDWE1)->WERC=RCCABE ;  /* SET ABEND REASON   */
         MVC   WERC(2,@03),@CH00239                                0144
*                                      /* CON COMM SUBTASK ABEND     */
*               END ;                                              0145
*               ELSE                                               0146
*               WECODE1F=FCMLAC ;      /* F.C. ATTACH CON COMM INT   */
         B     @RC00140                                            0146
@RF00140 LA    @06,BUILDWE                                         0146
         MVI   WECODE1F(@06),X'70'                                 0146
*               TWACFL2='1'B ;         /* SET ABEND BIT              */
@RC00140 OI    TWACFL2(TWAPTR),B'01000000'                         0147
*               R9=0 ;                 /* ZERO FOR COMPARE SWAP      */
         SLR   R9,R9                                               0148
*               R10=ADDR(BUILDWE) ;    /* 1ST W.E. ADDR TO BE QUEUED */
         LA    R10,BUILDWE                                         0149
*               CS(R9,R10,TWASYNQH);   /* QUEUE W.E. ON SYNC Q       */
         CS    R9,@10,TWASYNQH(TWAPTR)                             0150
*               IF R9=0                /* IF SUCCESSFUL              */
*                  THEN TWACFL4='1'B ; /* SET ESTAE COMPLETION BIT   */
         LTR   R9,R9                                               0151
         BNZ   @RF00151                                            0151
         OI    TWACFL4(TWAPTR),B'00100000'                         0152
*               END ;                                              0153
@RF00151 DS    0H                                                  0154
*      R1=RCABEND ;                    /* ABEND INDICATOR            */
@RF00138 DS    0H                                                  0154
@RC00120 DS    0H                                                  0154
@RC00089 SLR   R1,R1                                               0154
*      CALL RTNR ;                     /* TO PROCESS EXIT            */
         BAL   @14,RTNR                                            0155
         EJECT
*    /*                                                              */
*    /*        THE FOLLOWING ROUTINE IS AN INTERFACE TO THE          */
*    /*        ABEND ROUTINE FOR CLEAN UP WORK TO BE PERFORMED       */
*    /*        IN THE ABEND ROUTINE. THE LINKAGE IS ESTABLISHED      */
*    /*        TO BRANCH AND LINK TO THE ABEND ROUTINE.              */
*    /*                                                              */
*CLEANUP : PROC OPTIONS(NOSAVE,NOSAVEAREA) ;                       0156
         B     @PB00002                                            0156
CLEANUP  DS    0H                                                  0157
*      R8=R14 ;                        /* SAVE RETURN REG            */
         LR    R8,R14                                              0157
*      R9=R13 ;                        /* SAVE R13                   */
         LR    R9,R13                                              0158
*      R13=ETWAERRS(INDEX) ;           /* LOAD SAVE AREA ADDR IN R13 */
         LR    @06,INDEX                                           0159
         SLA   @06,3                                               0159
         L     R13,ETWAERRS-8(@06,R2)                              0159
*      R15=R13->EEWA4 ;                /* LOAD ENTRY ADDR            */
         L     R15,EEWA4(,R13)                                     0160
*      GEN ;                                                       0161
         BALR  14,15                  BR BACK TO ABEND ROUTINE
*      R13=R9 ;                        /* RESTORE R13                */
         LR    R13,R9                                              0162
*      R14=R8 ;                        /* RESTORE RETURN REG         */
         LR    R14,R8                                              0163
*      END  CLEANUP ;                                              0164
@EL00002 DS    0H                                                  0164
@EF00002 DS    0H                                                  0164
@ER00002 BR    @14                                                 0164
         EJECT
*    /*                                                              */
*    /*        FOLLOWING ROUTINE CALLS MESSAGE ROUTINE TO GET        */
*    /*        TERMINATING MESSAGE AND ISSUE THE MESSAGE.            */
*    /*                                                              */
*    /*        CALL TCAS TERMINATION ROUTINE  FOR DUMP SERVICE.      */
*    /*                                                              */
*    /*        A GETMAIN AREA IS OBTAINED FOR SAVE AREA AND MESSAGE  */
*    /*        ISSUING AREA. AFTER IT IS DONE, THE AREA IS FREED.    */
*    /*                                                              */
*TERM : PROC OPTIONS (NOSAVE,NOSAVEAREA) ;                         0165
TERM     DS    0H                                                  0166
*      R8=R14 ;                        /* SAVE RETURN REG            */
         LR    R8,R14                                              0166
*      GEN ;                                                       0167
         GETMAIN R,LV=GSTLEN          GETMAIN FOR WORK STORAGE
*      R10=R13 ;                       /* SAVE ORIGINAL R13 CONTENT  */
         LR    R10,R13                                             0168
*      R13=R1  ;                       /* NEWLY OBTAINED SAVE AREA   */
         LR    R13,R1                                              0169
*      IF ETWAID='MAIN'×ETWAABFC(2)^=0 /* IS IT MAIN TASK OR 2ND     */
*         THEN DO ;                    /* ABEND, YES DO              */
         CLC   ETWAID(4,R2),@CC00302                               0170
         BE    @RT00170                                            0170
         CLI   ETWAABFC+1(R2),0                                    0170
         BE    @RF00170                                            0170
@RT00170 DS    0H                                                  0171
*      R1=2 ;                          /* MSG 2 - TERMINATING MSG    */
         LA    R1,2                                                0172
*      CALL IKTCAS56 ;                 /* GET MSG 2 SPECIFIED IN R1  */
         L     @15,TWAMSG(,TWAPTR)                                 0173
         BALR  @14,@15                                             0173
*      R9=R1->EEWA3 ;                  /*R1 PTR LENGTH AND MSG       */
         L     R9,EEWA3(,R1)                                       0174
*                                      /* GET LENGTH OUT FOR MOVING  */
*      R1=R1+4 ;                       /* POINTS TO THE MSG          */
         AL    R1,@CF00080                                         0175
*      R13->AREA(1:R9)=R1->AREA(1:R9); /* MOVE MSG INTO WORK AREA    */
         LR    @06,R9                                              0176
         BCTR  @06,0                                               0176
         EX    @06,@SM00349                                        0176
*                                      /* WHICH IS POINTED TO BY R13 */
*      IF ETWAID='MAIN'                /* IF MAIN TASK ABEND         */
*         THEN R13->EEWA5=RSMABE ;     /* INSERT REASON CODE         */
         CLC   ETWAID(4,R2),@CC00302                               0177
         BNE   @RF00177                                            0177
         MVC   EEWA5(4,R13),@CC00241                               0178
*         ELSE                         /* NOT MAIN TASK              */
*         IF ETWAID='VTAM'             /*IF VTAM INT SUBTASK ABEND   */
*          THEN R13->EEWA5=RSVABE ;    /* INSERT REASON CODE         */
         B     @RC00177                                            0179
@RF00177 CLC   ETWAID(4,R2),@CC00303                               0179
         BNE   @RF00179                                            0179
         MVC   EEWA5(4,R13),@CC00243                               0180
*          ELSE                        /* NOT VTAM                   */
*          IF ETWAID='USER'            /* IF USER INT SUBTASK ABEND  */
*           THEN R13->EEWA5=RSUABE ;   /* INSERT REASON CODE         */
         B     @RC00179                                            0181
@RF00179 CLC   ETWAID(4,R2),@CC00304                               0181
         BNE   @RF00181                                            0181
         MVC   EEWA5(4,R13),@CC00245                               0182
*           ELSE                       /* NOT USER                   */
*            IF ETWAID='COMM'          /* IF CON COMM SUBTASK ABEND  */
*             THEN R13->EEWA5=RSCABE ; /* INSERT REASON CODE         */
         B     @RC00181                                            0183
@RF00181 CLC   ETWAID(4,R2),@CC00305                               0183
         BNE   @RF00183                                            0183
         MVC   EEWA5(4,R13),@CC00247                               0184
*      R1=R13 ;                        /* R1 PTR TO THE MSG          */
@RF00183 DS    0H                                                  0185
@RC00181 DS    0H                                                  0185
@RC00179 DS    0H                                                  0185
@RC00177 LR    R1,R13                                              0185
*      GEN ;                                                       0186
         WTO   MF=(E,(1))             ISSUE TERMINATINE MSG
*      IF ETWAID='MAIN'                /* IS MAIN TASK ABEND         */
*         THEN R1=TTECDM+TTECFR ;      /* SET ENTRY CODE DUMP SERVICE*/
         CLC   ETWAID(4,R2),@CC00302                               0187
         BNE   @RF00187                                            0187
         LA    R1,5                                                0188
*                                      /* AND FREE X MEMORY REQUEST  */
*         ELSE R1=TTECDM ;             /* IF NOT MAIN TASK - ONLY    */
         B     @RC00187                                            0189
@RF00187 LA    R1,1                                                0189
*                                      /* REQUEST DUMP SERVICE       */
*      CALL IKTCAS52 ;                 /*   TCAS TERMINATION ROUTINE */
@RC00187 L     @15,TWATTSR(,TWAPTR)                                0190
         BALR  @14,@15                                             0190
*      END ;                                                       0191
*      ELSE DO ;                       /* NOT TERMINATE TCAS         */
         B     @RC00170                                            0192
@RF00170 DS    0H                                                  0193
*      R1=20 ;                         /* GET MSG 20- RECOVERY MSG   */
         LA    R1,20                                               0193
*      CALL IKTCAS56 ;                 /* MSG MODULE                 */
         L     @15,TWAMSG(,TWAPTR)                                 0194
         BALR  @14,@15                                             0194
*      R9=R1->EEWA3 ;                  /* GET MSG LENGTH             */
         L     R9,EEWA3(,R1)                                       0195
*      R1=R1+4 ;                       /* R1 PTR TO MSG TEXT         */
         AL    R1,@CF00080                                         0196
*      R13->AREA(1:R9)=R1->AREA(1:R9); /* MOVE MSG OUT FOR INSERTION */
         LR    @06,R9                                              0197
         BCTR  @06,0                                               0197
         EX    @06,@SM00349                                        0197
*      IF ETWAID='VTAM'                /* IF VTAM SUBTASK ABEND      */
*         THEN R13->EEWA6=' VTAM INTERFACE      '; /* INSERT WORDS   */
         CLC   ETWAID(4,R2),@CC00303                               0198
         BNE   @RF00198                                            0198
         MVC   EEWA6(21,R13),@CC00332                              0199
*         ELSE IF ETWAID='USER'        /* IF USER SUBTASK ABEND      */
*         THEN R13->EEWA6=' USER INTERFACE      '; /* INSERT WORDS   */
         B     @RC00198                                            0200
@RF00198 CLC   ETWAID(4,R2),@CC00304                               0200
         BNE   @RF00200                                            0200
         MVC   EEWA6(21,R13),@CC00334                              0201
*      R1=R13 ;                         /* R1 PTR TO THE MSG         */
@RF00200 DS    0H                                                  0202
@RC00198 LR    R1,R13                                              0202
*      GEN ;                                                       0203
         WTO   MF=(E,(1))      ISSUE RECOVERY IN PROGRESS MSG
*      END ;                                                       0204
*      R9=R13 ;                        /* WORK AREA ADDR IN R9       */
@RC00170 LR    R9,R13                                              0205
*      GEN ;                                                       0206
         FREEMAIN R,LV=GSTLEN,A=(R9)     FREEMAIN THE WORK AREA
*      R13=R10 ;                       /* RESTORE R13                */
         LR    R13,R10                                             0207
*      R14=R8 ;                        /* RESTORE RETURN REG         */
         LR    R14,R8                                              0208
*      END TERM ;                                                  0209
@EL00003 DS    0H                                                  0209
@EF00003 DS    0H                                                  0209
@ER00003 BR    @14                                                 0209
         EJECT
*    /*                                                              */
*    /*      THIS ROUTINE PROCESS THE RETURN OF CONTROL TO RTM       */
*    /*        THERE ARE 2 WAYS OF RETURN:                           */
*    /*        BR14 IF NO SDWA IS PROVIDED                           */
*    /*        VIA SETRP MACRO IF SDWA IS PROVIDED                   */
*    /*                                                              */
*RTNR  : PROC OPTIONS(NOSAVE,NOSAVEAREA) ;                         0210
RTNR     DS    0H                                                  0211
*      RFY (R14,R15) RSTD ;                                        0211
*      R15=R1 ;                        /* R15 SHOULD CONTAIN RETURN  */
         LR    R15,R1                                              0212
*                                      /* CODE WHICH WAS IN R1       */
*      LM(R0,R2,SAVE) ;                /* RESTORE PARAMETER REGS     */
         LM    R0,R2,SAVE                                          0213
*      R14=SAVER(4) ;                  /* RESTORE R14                */
         L     R14,SAVER+12                                        0214
*      IF R0=NOSDWA                    /* IS THERE SDWA              */
*         THEN DO ;                    /* NO, NO SDWA PROVIDED       */
         C     R0,@CF00148                                         0215
         BNE   @RF00215                                            0215
*         R0=ADDR(RETRY) ;             /* R0 CONTAINS RETRY ADDR     */
         LA    R0,RETRY                                            0217
*         GEN ;                                                    0218
         BR    R14                    BACK TO CALLER
*         END ;                                                    0219
*         ELSE DO ;                                                0220
         B     @RC00215                                            0220
@RF00215 DS    0H                                                  0221
*        IF R15=RCRETRY                /* IF RETRY SPECIFIED         */
*            THEN DO ;                 /* YES                        */
         C     R15,@CF00080                                        0221
         BNE   @RF00221                                            0221
*            GEN REFS(RETRY) ;                                     0223
         SETRP REGS=(14,12),RC=4,RETADDR=RETRY,FRESDWA=YES
*            END ;                                                 0224
*            ELSE DO ;                 /* NOT RETRY SPECIFIED        */
         B     @RC00221                                            0225
@RF00221 DS    0H                                                  0226
*            GEN ;                                                 0226
         SETRP REGS=(14,12),RC=0
*            END;                                                  0227
*            END ;                                                 0228
*      END  RTNR ;                                                 0229
@EL00004 DS    0H                                                  0229
@EF00004 DS    0H                                                  0229
@ER00004 BR    @14                                                 0229
@PB00004 DS    0H                                                  0229
         EJECT
*    /*                                                              */
*    /*        THE FOLLOWING ROUTINE IS AN INTERFACE TO THE          */
*    /*        ABEND ROUTINE FOR  RETRY. LINKAGE IS ESTABLISHED TO   */
*    /*        BRANCH BACK TO THE ABEND ROUTINE.                     */
*    /*        AT ENTRY R1 CONTAINS THE ADDR OF PARAMETER PASSED     */
*    /*        FROM ESTAE MACRO.                                     */
*    /*                                                              */
*RETRY  :                                                          0230
*      GEN ;                                                       0230
RETRY    DS    0H                                                  0230
         BALR  R12,0                  R12 IS BASE REG
         USING *,R12                  ADDRESSIBILITY
         USING @DATD-4,R1             R1 PTR PARAMETR PASSED FROM
*                                     TASK AND R1+4 IS WORK AREA FOR
*                                     ESTAE WHICH MAY BE USED FOR
*                                     AUTO DATA
*      RFY ETWA BASED(R1) ;            /* PARAMETER ADDRESSIBILITY   */
*      DO INDEX=4 TO 2 BY -1           /* PIN POINT THE LAST FTPRINT */
*         WHILE(ETWAEIFC(INDEX)=0);    /* WHICH CONTAIN THE FUNCTION */
         LA    INDEX,4                                             0232
@DL00232 LR    @06,INDEX                                           0232
         SLA   @06,3                                               0232
         SLR   @03,@03                                             0232
         IC    @03,ETWAEIFC-8(@06,R1)                              0232
         C     @03,@CF00150                                        0232
         BNE   @DC00232                                            0232
*      END ;                           /* CODE, RETRY ADDR, AND SAVE */
         BCTR  INDEX,0                                             0233
         C     INDEX,@CF00073                                      0233
         BNL   @DL00232                                            0233
@DC00232 DS    0H                                                  0234
*                                      /* AREA ADDR                  */
*      R13=ETWAERRS(INDEX) ;           /* LOAD SAVE AREA ADDR        */
         LR    @06,INDEX                                           0234
         SLA   @06,3                                               0234
         L     R13,ETWAERRS-8(@06,R1)                              0234
*      R15=ETWAERA(INDEX) ;            /* LOAD RETRY ADDR            */
         L     R15,ETWAERA-9(@06,R1)                               0235
         LA    R15,0(,R15)                                         0235
*      GEN ;                                                       0236
         LM    R0,R12,20(R13)         RESTORE REGS FROM SAVE AREA
         LM    R13,R14,8(R13)         RESTORE R13 AND R14
         BR    R15                    BRANCH TO RETRY ROUTINE
GSTLEN   EQU   80
         IHASDWA
IKTCAS55 CSECT
*      END  IKTCAS55                                               0237
*/* THE FOLLOWING INCLUDE STATEMENTS WERE FOUND IN THIS PROGRAM.      *
*/*%INCLUDE SYSLIB  (IKTCASWA)                                        *
*;                                                                 0237
@DATA    DS    0H
@CH00343 DC    H'6'
@CH00032 DC    H'48'
@CH00237 DC    H'52'
@CH00239 DC    H'56'
@SM00349 MVC   AREA(0,R13),AREA(R1)
@DATD    DSECT
         DS    0F
IKTCAS55 CSECT
         DS    0F
@CF00150 DC    F'0'
@CF00062 DC    F'1'
@CF00073 DC    F'2'
@CF00146 DC    F'3'
@CF00080 DC    F'4'
@CF00064 DC    F'7'
@CF00060 DC    F'8'
@CF00148 DC    F'12'
@CH00148 EQU   @CF00148+2
@CF00196 DC    XL4'11'
@DATD    DSECT
         DS    0D
BUILDWE  DS    CL12
BUILDWE1 DS    CL12
SAVER    DS    4A
         ORG   *+1-(*-@DATD)/(*-@DATD) INSURE DSECT DATA
@ENDDATD EQU   *
IKTCAS55 CSECT
         NOPR  ((@ENDDATD-@DATD)/49*16)
         DS    0F
@SIZDATD DC    AL1(0)
         DC    AL3(@ENDDATD-@DATD)
         DS    0D
@CC00332 DC    C' VTAM INTERFACE      '
@CC00334 DC    C' USER INTERFACE      '
@CC00241 DC    C'  32'
@CC00243 DC    C'  48'
@CC00245 DC    C'  52'
@CC00247 DC    C'  56'
@CC00302 DC    C'MAIN'
@CC00303 DC    C'VTAM'
@CC00304 DC    C'USER'
@CC00305 DC    C'COMM'
         DS    CL2
PATCH    DC    25F'0'
@00      EQU   00                      EQUATES FOR REGISTERS 0-15
@01      EQU   01
@02      EQU   02
@03      EQU   03
@04      EQU   04
@05      EQU   05
@06      EQU   06
@07      EQU   07
@08      EQU   08
@09      EQU   09
@10      EQU   10
@11      EQU   11
@12      EQU   12
@13      EQU   13
@14      EQU   14
@15      EQU   15
TWAPTR   EQU   @11
R0       EQU   @00
R1       EQU   @01
R2       EQU   @02
INDEX    EQU   @07
R8       EQU   @08
R9       EQU   @09
R10      EQU   @10
R12      EQU   @12
R13      EQU   @13
R14      EQU   @14
R15      EQU   @15
TWAR     EQU   0
TWASYNQH EQU   TWAR+4
TWATTSR  EQU   TWAR+28
TWAMSG   EQU   TWAR+48
TWAMFL   EQU   TWAR+80
TWAVFL   EQU   TWAR+81
TWAVFL2  EQU   TWAVFL
TWAVFL4  EQU   TWAVFL
TWAVFL5  EQU   TWAVFL
TWAVFL6  EQU   TWAVFL
TWAUFL   EQU   TWAR+82
TWAUFL2  EQU   TWAUFL
TWAUFL4  EQU   TWAUFL
TWACFL   EQU   TWAR+83
TWACFL2  EQU   TWACFL
TWACFL4  EQU   TWACFL
TWAM     EQU   TWAR+84
TWAME    EQU   TWAM+68
TWAMEI   EQU   TWAME
TWAV     EQU   TWAR+184
TWAVE    EQU   TWAV+68
TWAVEI   EQU   TWAVE
TWAVI    EQU   TWAR+284
TWAU     EQU   TWAR+300
TWAUE    EQU   TWAU+68
TWAUEI   EQU   TWAUE
TWAUI    EQU   TWAR+400
TWAC     EQU   TWAR+408
TWACE    EQU   TWAC+68
TWACEI   EQU   TWACE
TWACI    EQU   TWAR+508
TWAWORKE EQU   TWAR+524
WESTD    EQU   0
WECODE1  EQU   WESTD
WECODE1T EQU   WECODE1
WECODE1F EQU   WECODE1+1
WECODE2  EQU   WESTD+2
WECODE2T EQU   WECODE2
WECODE2F EQU   WECODE2+1
WENEXT   EQU   WESTD+4
WERC     EQU   WESTD+8
WELEN    EQU   WESTD+10
IKTCAS52 EQU   0
IKTCAS56 EQU   0
EEWA3    EQU   0
EEWA4    EQU   16
EEWA5    EQU   45
EEWA6    EQU   17
AREA     EQU   0
ETWA     EQU   0
ETWAID   EQU   ETWA
ETWAWA   EQU   ETWA+4
ETWATWA  EQU   ETWA+52
ETWAABFC EQU   ETWA+56
ETWARTFC EQU   ETWA+60
ETWAE    EQU   ETWA+68
ETWAEI   EQU   ETWAE
ETWAEIFC EQU   ETWAEI
ETWAERA  EQU   ETWAEI+1
ETWAERRS EQU   ETWAE+4
SAVE     EQU   SAVER
BUILDWE2 EQU   TWAWORKE
         AGO   .@UNREFD                START UNREFERENCED COMPONENTS
WERC2    EQU   WERC+1
WERC1    EQU   WERC
WECD2MIF EQU   WECODE2F
WECD2MAF EQU   WECODE2F
WECDMIF  EQU   WECODE1F
WECDMAF  EQU   WECODE1F
TWAEND   EQU   TWAR+536
@NM00005 EQU   TWACI+13
TWACSKIP EQU   TWACI+12
TWACMODQ EQU   TWACI+8
TWACSTPQ EQU   TWACI+4
TWACECB  EQU   TWACI
TWACERRS EQU   TWACE+4
TWACERA  EQU   TWACEI+1
TWACEIFC EQU   TWACEI
TWACRTFC EQU   TWAC+60
TWACABFC EQU   TWAC+56
TWACTWA  EQU   TWAC+52
TWACEWA  EQU   TWAC+4
TWACID   EQU   TWAC
TWAUACQH EQU   TWAUI+4
TWAUECB  EQU   TWAUI
TWAUERRS EQU   TWAUE+4
TWAUERA  EQU   TWAUEI+1
TWAUEIFC EQU   TWAUEI
TWAURTFC EQU   TWAU+60
TWAUABFC EQU   TWAU+56
TWAUTWA  EQU   TWAU+52
TWAUEWA  EQU   TWAU+4
TWAUID   EQU   TWAU
TWAVACQH EQU   TWAVI+12
TWAVTHQH EQU   TWAVI+8
TWAVTEQH EQU   TWAVI+4
TWAVECB  EQU   TWAVI
TWAVERRS EQU   TWAVE+4
TWAVERA  EQU   TWAVEI+1
TWAVEIFC EQU   TWAVEI
TWAVRTFC EQU   TWAV+60
TWAVABFC EQU   TWAV+56
TWAVTWA  EQU   TWAV+52
TWAVEWA  EQU   TWAV+4
TWAVID   EQU   TWAV
TWAMERRS EQU   TWAME+4
TWAMERA  EQU   TWAMEI+1
TWAMEIFC EQU   TWAMEI
TWAMRTFC EQU   TWAM+60
TWAMABFC EQU   TWAM+56
TWAMTWA  EQU   TWAM+52
TWAMEWA  EQU   TWAM+4
TWAMID   EQU   TWAM
@NM00004 EQU   TWACFL
TWACFL1  EQU   TWACFL
@NM00003 EQU   TWAUFL
TWAUFL3  EQU   TWAUFL
TWAUFL1  EQU   TWAUFL
@NM00002 EQU   TWAVFL
TWAVFL3  EQU   TWAVFL
TWAVFL1  EQU   TWAVFL
@NM00001 EQU   TWAMFL
TWAMFL1  EQU   TWAMFL
TWACCOMP EQU   TWAR+76
TWAUCOMP EQU   TWAR+72
TWAVCOMP EQU   TWAR+68
TWAMECB  EQU   TWAR+64
TWACTCB  EQU   TWAR+60
TWAUTCB  EQU   TWAR+56
TWAVTCB  EQU   TWAR+52
TWADEQAS EQU   TWAR+44
TWAEESR  EQU   TWAR+40
TWAPPSR  EQU   TWAR+36
TWATCSR  EQU   TWAR+32
TWAINIT  EQU   TWAR+24
TWATCAST EQU   TWAR+20
TWACSCB  EQU   TWAR+16
TWAASCB  EQU   TWAR+12
TWAPASQH EQU   TWAR+8
TWARSON  EQU   TWAR+2
TWACOMP  EQU   TWAR
.@UNREFD ANOP                          END UNREFERENCED COMPONENTS
@RF00052 EQU   @RC00050
@RF00054 EQU   @RC00050
@RF00058 EQU   @RC00050
@RF00117 EQU   @RC00089
@RF00135 EQU   @RC00120
@PB00003 EQU   @PB00004
@RC00215 EQU   @EL00004
@RC00221 EQU   @EL00004
@PB00002 EQU   @PB00003
@ENDDATA EQU   *
         END   IKTCAS55,(C'PLS2013',0702,80232)

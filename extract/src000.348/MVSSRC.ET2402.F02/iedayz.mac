         TITLE 'IEDAYZ - TSO SCHEDULER ROUTINE'
IEDAYZ   CSECT
         SPACE 3
*  CHANGE ACTIVITY AS FOLLOWS:
******************** MICROFICHE FLAGS *********************** SUPT CODE
*C064000-064200,064400,065000,163000,194000,211940,212025,213300,S21903
*C237170,237808,238000-238860,327000,352600,371000,413500,576000,S21903
*C578400,629000,688700,707000,733000,819000,843000,903000,971000,S21903
*C971070,036100-036600,036800,040000-048000,064600,066000,113000 S21903
*A003936,036660-036730,211766-211772,238360-238380,238820-238860 S22028
*A765013,765022,789023-789026,789161-789167,789185               S22028
*A135000,234900,287000                                          SA55387
*C002792,002848-002876,003056-003064,003432-003440,              S22028
*D117000,234600,284000                                          SA55387
*C068000-069000,177000-178000,211936,237100-237200,404000-404500 S22028
*C765024                                                         S22028
*A759000,971000,684200                                           S22029
*C405000,763200,764000                                           S22029
*D405500-413500,581000-584000                                    S22029
*A684120,684200                                                   M2550
*C069000,602600,682350                                            M2550
*D682350-682900                                                   M2550
*A318400                                                          M5954
*C069000                                                          M5954
*A729000                                                          M6360
*C069000,688000,729000,730500                                     M6360
*A688200,689000,729100                                           A42370
*A723400                                                         A42372
*A161000                                                         A44022
*A235800                                                         A44022
*A328500                                                         A44022
*C069000,723400                                                  A42372
*C069000                                                          M0892
*C684220,684340                                                   M0892
*A688200,689000,729100                                           A42370
*A689650                                                          M0892
*A687210,687290                                                   M0892
*A723400                                                         A42372
*A814010-814050,903010,903020                                    A52506
*C816000,818000,824000                                           A52506
*C830000,834000,836000,881000,882000,884000,887000,890000        A52506
*770003-770030,036805-036815,C776000                            SA56332
*A354000-355000,216000-217000                                   SA56307
*A763290                                                        SA59184
*A237050,237100                                                 SA59987
*D236800                                                        SA59987
*C232340-232360                                                 SA62315
*D684206-684212                                                 SA62394
*A189000,190000                                                 SA65440
*D689650-689700                                                 SA68242
*A689000                                                        SA68242
*A689650                                                        SA68242
*D689800                                                        SA68242
*C237760,765015,765021-765024                                  @SA71937
*A237784                                                       @SA71937
*C842000,843000                                                @SA73152
*C067000,640000                                                  Y01004
*C003520,003884,031000-032000,187000,199500,317200,789320-789330 X02004
*D185000,188000,199600-199700,317800,789340                      X02004
*A064350                                                         Y01948
*C003964,057000,064300,364000                                    Y01948
*D002176,002476-002504,002904-002928,003160-003208,003576-003616,Y01948
*D003872-003876,003900,003968-003972,028000-029000,033000,063000,Y01948
*D125000,154000,288000,313000,343000,368000,789700               Y01948
*A233060                                                        OY00523
*A 204600,727000                                               @SA68674
*C 205400,728700-728800                                        @SA68674
*D884800,884900                                                @YA05130
*C684000                                                       @YA05164
*A689650                                                        OY03940
*C689600                                                        OY03940
*D689100-689200,689700                                          OY03940
*D001143,884100-884900                                         @YA05475
*C237760                                                       @ZA03087
* C684006-684008                                               @YA07698
*A237784                                                       @YA08799
*C233040,237760                                                @YA08799
*A236100                                                       @SA74985
*D881000-903020                                                @YA10969
*A881000                                                       @YA10969
*A843600                                                       @SA76279
*D765021                                                       @OY12417
*
         SPACE 3
*                                                                     *
*A682620-682860                                                @SA67152
*C429000,505000,789030                                         @ZA01117
*C682620-682780                                                @SA67152
*        TCAM LEVEL 10 CHANGES                                 @G36XRYP
*                                                              @G36XRYP
*A211720,237140,577000,591000,985000                           @G36XRYP
*C192000,211766,211780,211840,211880,211937,237120,237140      @G36XRYP
*C237808,327000,577000,733000,765022,792000,921000             @G36XRYP
*C210600,236700,347000,733992                                  @OY14092
*A761100                                                       @OY14092
*D232400-232600                                                @YA12685
*D789010,789020                                                @OZ14196
*A002900,A003156,A036800,C057000,C513000,A517000               @OZ14196
*D002904-002928,003160-003200,517800-532600                    @OZ17622
*C057000,513000-516000                                         @OZ17622
*A684360                                                       @OZ28271
*C765027                                                       @OZ28271
*A122000                                                       @OY20733
*D237560,237570                                                @OY20841
*C205400-205700,728500-728840                                  @OS76502
*A178200                                                       @OZ35418
* $01=OZ41285  JTC2202  79.11.06 047252:                           @01A
* $02=OZ41495  JTC2202  79.11.06 047252:                           @02A
* $03=OZ41521  JTC2202  79.11.06 047252:                           @03A
* $P1=ZM11064  JTC2202  80.02.19 098061:                           @P1A
* $11=OZ44959  JTC2302  80.03.27 398332:                           @11A
* $21=OZ55529  ETC2402  81.12.21 460025: INCREASE LOOP COUNT       @21A
***********************************************************************
*                                                                     *
*  TITLE: 'IEDAYZ' TIME SHARING SCHEDULER                             *
*                                                                     *
*  $MOD(IEDAYZ) COMP(Y@) PROD(TCAM):                               @01C
*                                                                     *
*  DESCRIPTIVE NAME = TIME SHARING SCHEDULER                          *
*                                                                     *
*  COPYRIGHT = 'NONE'                                                 *
*                                                                     *
*  STATUS:  VERSION 10.0                                       @G36XRYP
*                                                                     *
*FUNCTION --  THE FUNCTION OF THE TIME SHARING SCHEDULER VARIES, DE-  *
*   PENDING UPON THE ROUTINE FROM WHICH IT RECEIVES CONTROL, AND THE  *
*   ENTRY POINT.                                                      *
*      WHEN THIS ROUTINE IS ENTERED FROM THE LEASED RECEIVE SCHEDULER *
*   (IGG019R3), IT LINKS TO THE TERMNAME TABLE CODE (IEDQTNT) TO GET  *
*   THE TERMINAL ENTRY, FROM WHICH IT EXTRACTS THE DESTINATION QCB    *
*   ADDRESS.  IF THE TERMINAL IS NOT DEDICATED TO A TIME SHARING      *
*   SESSION, THE LCB POINTER TO THE CURRENT INVITATION LIST ENTRY IS  *
*   UPDATED, AND CONTROL RETURNS TO THE LEASED RECEIVE SCHEDULER.  IF *
*   A TIME SHARING SESSION IS IN PROGRESS WITH THE TERMINAL, THIS     *
*   ROUTINE CHECKS VARIOUS SCHEDULING BITS IN THE QCB TO DETERMINE    *
*   WHETHER OR NOT TO INITIATE A READ OPERATION.  IF A HARDWARE       *
*   ATTENTION INTERRUPT HAS JUST BEEN RECEIVED, THIS ROUTINE SETS OFF *
*   THE SIMULATED ATTENTION READ REQUEST BIT IN THE QCB AND EXITS TO  *
*   THE DISPATCHER POST FUNCTION TO POST THE LCB TO THE ATTENTION     *
*   ROUTINE SPECIFIED IN THE MH.  WHEN THE DECISION TO START A READ   *
*   OPERATION OR NOT HAS BEEN MADE, THIS ROUTINE DETERMINES IF A RE-  *
*   QUEST FOR A SIMULATED ATTENTION READ IS PRESENT WHICH OVERRIDES   *
*   THE PREVIOUS DECISION.  IF SO, THE SPECIAL SIMULATED ATTENTION    *
*   READ CHANNEL PROGRAM WILL BE INITIATED.                           *
*      IF NO READ OPERATION IS TO BE STARTED, THIS ROUTINE CHECKS TO  *
*   SEE IF A SIMULATED ATTENTION BY TIME DELAY INTERVAL WAS REQUESTED.*
*   IF IT WAS, A CHECK IS MADE TO SEE IF A SEND OPERATION WAS RE-     *
*   QUESTED OR IF THE QCB IS ALREADY IN THE TIME DELAY QUEUE.  IF     *
*   NEITHER OF THESE CONDITIONS EXISTS, THIS ROUTINE SETS THE PRIOR-  *
*   ITY, THE TIME DELAY INTERVAL, AND THE TIME DELAY FLAG IN THE QCB  *
*   AND LINKS TO THE TIME DELAY SUBTASK (IEDQHG) TO INSERT THE QCB    *
*   INTO THE TIME DELAY QUEUE.  THIS ROUTINE THEN UPDATES THE INVI-   *
*   TATION LIST POINTER TO POINT TO THE NEXT ENTRY, UPDATES THE LCB   *
*   POINTER TO THE CURRENTLY CONNECTED TERMINAL, AND BRANCHES BACK TO *
*   THE BEGINNING TO GET THE TERMINAL ENTRY AND QCB ADDRESS FOR THE   *
*   NEW TERMINAL AND REPEAT THE PROCEDURE FOR IT.  WHEN THE END OF    *
*   THE INVITATION LIST IS REACHED, THIS ROUTINE CHECKS TO SEE IF     *
*   ANY ENTRIES WERE POLLED.  IF THEY WERE, THE START OF POLLING LIST *
*   BIT IS SET ON IN THE LCB, AND CONTROL RETURNS TO THE LEASED RE-   *
*   CEIVE SCHEDULER.  IF NO ENTRIES WERE POLLED, THIS ROUTINE SETS    *
*   THE LCB INVITATION LIST POINTER TO POINT TO THE FIRST ENTRY AND   *
*   EXITS TO THE DISPATCHER BYPASS FUNCTION TO IMMEDIATELY ACTIVATE   *
*   THE NEXT STCB IN THE LCB'S CHAIN.                                 *
*      IF A READ OPERATION IS TO BE STARTED, THIS ROUTINE CHECKS TO   *
*   SEE IF THE QCB IS IN THE TIME DELAY QUEUE.  IF IT IS, THIS ROU-   *
*   TINE LINKS TO THE TIME DELAY SUBTASK TO REMOVE IT FROM THE QUEUE. *
*   FINALLY, THIS ROUTINE SETS ON THE TIME SHARING BUFFER BIT IN THE  *
*   LCB, UPDATES THE LCB INVITATION LIST POINTER, AND RETURNS CONTROL *
*   TO THE LEASED RECEIVE SCHEDULER.                                  *
*      WHEN THIS ROUTINE IS ENTERED FROM THE DIAL RECEIVE SCHEDULER   *
*   (IGG019R1), THE SAME TESTS ARE MADE TO DETERMINE WHETHER OR NOT   *
*   TO INITIATE A READ OPERATION.  THE SAME PROCESSING ALSO OCCURS    *
*   WHEN A QCB IS TO BE INSERTED INTO OR REMOVED FROM THE TIME DELAY  *
*   QUEUE, OR IF THE LCB IS TO BE POSTED TO THE ATTENTION ROUTINE.    *
*      IF NO REGULAR READ OPERATION IS TO BE STARTED, BUT A SIMULATED *
*   ATTENTION READ WAS REQUESTED, THIS ROUTINE SETS OFF THE NEGATIVE  *
*   RESPONSE TO POLLING BIT IN THE LCB AND INITIATES THE SPECIAL      *
*   SIMULATED ATTENTION READ CHANNEL PROGRAM.  OTHERWISE, AFTER PER-  *
*   FORMING ANY NECESSARY TIME DELAY PROCESSING, THIS ROUTINE FREES   *
*   THE LINE, PUTS UP A PREPARE CHANNEL PROGRAM ON THE LINE TO MONI-  *
*   TOR FOR AN ATTENTION INTERRUPT, SETS OFF THE SEND PRIORITY BIT    *
*   AND THE NEGATIVE RESPONSE TO POLLING BIT IN THE LCB, AND EXITS TO *
*   THE DISPATCHER DISPATCH FUNCTION TO DISPATCH THE NEXT SUBTASK.    *
*      IF A REGULAR READ OPERATION IS TO BE STARTED, THIS ROUTINE     *
*   PERFORMS ANY NECESSARY TIME DELAY PROCESSING AND CHECKS TO SEE IF *
*   A NEGATIVE RESPONSE TO POLLING WAS RECEIVED ON THE LAST POLL.  IF *
*   IT WAS, THE LCB IS SET TO RE-POLL, AND A CHECK IS MADE TO SEE IF  *
*   THE POLLING DELAY INTERVAL IN THE DCB IS ZERO.  IF IT IS NOT, A   *
*   PREPARE CHANNEL PROGRAM IS PUT UP ON THE LINE TO MONITOR FOR AN   *
*   ATTENTION INTERRUPT, AND THIS ROUTINE EXITS TO THE DISPATCHER     *
*   POST FUNCTION TO POST THE LCB TO THE TIME DELAY QCB.  IF THE      *
*   POLLING DELAY IS ZERO, IF A NEGATIVE RESPONSE TO POLLING WAS NOT  *
*   RECEIVED, OR IF A SIMULATED ATTENTION READ OPERATION IS TO BE     *
*   STARTED, THIS ROUTINE SETS ON THE TIME SHARING BUFFER BIT IN THE  *
*   LCB AND RETURNS CONTROL TO THE DIAL RECEIVE SCHEDULER.  NO UP-    *
*   DATING OF INVITATION LIST POINTERS TAKES PLACE WHEN ENTRY IS FROM *
*   THE DIAL RECEIVE SCHEDULER.                                       *
*      THIS ROUTINE IS ALSO ENTERED FROM THE QEVENT ENTRY POINT IN    *
*   THE LEASED RECEIVE SCHEDULER WHEN TSO IS IN THE SYSTEM.  QEVENT   *
*   IS DISPATCHED AS THE LAST STCB IN THE CHAIN OF SCHEDULER STCB'S   *
*   FOR A LINE.  AFTER LINKING TO THE TERMNAME TABLE CODE AND GETTING *
*   THE ADDRESSES OF THE DCB, INVITATION LIST, AND DESTINATION QCB,   *
*   THIS ROUTINE CHECKS TO SEE IF THE FOLLOWING CONDITIONS ARE MET:   *
*   (1) THE TERMINAL IS DEDICATED TO A TIME SHARING SESSION, (2) A    *
*   PREPARE IS NOT ALREADY UP ON THE LINE, (3) THE TERMINAL HAS THE   *
*   ATTENTION FEATURE, (4) AN ATTENTION EXIT WAS SPECIFIED IN THE MH, *
*   AND (5) THE INVITATION LIST CONSISTS OF ONLY ONE ENTRY.  IF ALL   *
*   OF THESE CONDITIONS ARE NOT MET, CONTROL IS RETURNED TO THE       *
*   QEVENT ROUTINE.  THIS ROUTINE NEXT CHECKS TO SEE IF THE TERMINAL  *
*   IS A 2741.  IF IT IS NOT, A CHECK IS MADE TO SEE IF THE TERMINAL  *
*   CAN TIME OUT.  IF IT CAN, CONTROL IS RETURNED TO THE QEVENT ROU-  *
*   TINE.  IF IT IS INHIBITED FROM TIMING OUT, THIS ROUTINE SETS UP   *
*   A PREPARE ON THE LINE, LINKS TO THE ACTIVATE - I/O GENERATOR      *
*   MODULE (IEDQKA) TO BUILD THE CHANNEL PROGRAM, AND BRANCHES TO THE *
*   ROUTINE SPECIFIED BELOW THAT ISSUES THE EXCP.                     *
*      IF THE TERMINAL IS A 2741, THE LINE IS TO BE FREED.  IF THE    *
*   LCB INDICATES THAT A CIRCLE D HAS NOT BEEN SENT TO THE 2741, THIS *
*   ROUTINE GENERATES A WRITE CIRCLE D - PREPARE CHANNEL PROGRAM TO   *
*   PUT THE LINE INTO RECEIVE MODE AND MONITOR FOR AN ATTENTION INTER-*
*   RUPT.  IF A CIRCLE D HAS BEEN SENT, THE LINE IS ALREADY IN RE-    *
*   CEIVE MODE, SO A PREPARE CHANNEL PROGRAM IS GENERATED.  THE CCW   *
*   STARTING ADDRESS IS SET IN THE LCB.  THIS ROUTINE THEN LOADS THE  *
*   IOB ADDRESS IN REGISTER 1, ISSUES THE EXCP SVC (SVC 0) TO START   *
*   THE CHANNEL PROGRAM, AND RETURNS CONTROL TO THE QEVENT ROUTINE.   *
*      THIS ROUTINE IS ENTERED FROM THE SEND SCHEDULER (IGG019R4)     *
*   WHEN IT HAS BEEN DISPATCHED OFF THE QCB.  IT FIRST CHECKS TO SEE  *
*   IF A SIMULATED ATTENTION READ WAS REQUESTED.  IF IT WAS, CONTROL  *
*   PASSES TO THE DISPATCHER AT DSPUNAV TO REMOVE THE STCB FROM ITS   *
*   CURRENT QCB AND INSERT IT IN THE SEND SCHEDULER'S QCB.  IF NOT, A *
*   CHECK IS MADE TO SEE IF A WRITE BREAK HAS BEEN REQUESTED.  IF IT  *
*   HAS NOT, CONTROL RETURNS TO THE SEND SCHEDULER.  IF A WRITE BREAK *
*   HAS BEEN REQUESTED, THIS ROUTINE SETS OFF THE READ PRIORITY BIT   *
*   IN THE QCB AND TESTS SEVERAL STATUS BITS IN THE LCB AND QCB TO    *
*   DETERMINE WHETHER OR NOT A WRITE BREAK CHANNEL COMMAND CAN BE     *
*   ISSUED.  IF IT CAN NOT, CONTROL RETURNS TO THE SEND SCHEDULER.    *
*   IF THE LINE IS LEASED, THIS ROUTINE LINKS TO THE TERMNAME TABLE   *
*   CODE, GETS THE TERMINAL ENTRY, AND EXTRACTS THE QCB ADDRESS.  IF  *
*   THE TERMINAL FOR WHICH THE WRITE BREAK WAS REQUESTED IS NOT CUR-  *
*   RENTLY CONNECTED, CONTROL RETURNS TO THE SEND SCHEDULER.  OTHER-  *
*   WISE, THIS ROUTINE GETS THE ADDRESS OF THE FIRST BUFFER, SETS THE *
*   WRITE BREAK IN PROGRESS BIT ON IN THE LCB, GETS THE UCB ADDRESS,  *
*   AND ISSUES AN IOHALT SVC (SVC 33).  THE IOHALT INTERRUPT WILL BE  *
*   HANDLED BY LINE END APPENDAGE, WHICH WILL CAUSE A BREAK CHANNEL   *
*   PROGRAM TO BE EXECUTED.  AFTER THE IOHALT IS ISSUED, CONTROL      *
*   PASSES TO THE DISPATCHER AT DSPUNAV TO SWITCH THE STCB TO THE     *
*   SEND SCHEDULER'S QCB.                                             *
*      IF THIS ROUTINE IS ENTERED FROM THE TIME SHARING DESTINATION   *
*   SCHEDULER (IEDAYD), A WRITE BREAK HAS BEEN REQUESTED.  THE PRO-   *
*   CESSING IS THE SAME AS WHEN ENTERED FROM THE SEND SCHEDULER ABOVE,*
*   EXCEPT THAT THE FIRST TWO CHECKS FOR SIMULATED ATTENTION AND      *
*   WRITE BREAK ARE BYPASSED, AND CONTROL IS ALWAYS RETURNED TO THE   *
*   TIME SHARING DESTINATION SCHEDULER.                               *
*      THIS ROUTINE MAY ALSO BE ENTERED FROM THE SEND SCHEDULER WHEN  *
*   IT HAS BEEN DISPATCHED OFF THE LCB.  IF A TSO SESSION IS NOT IN   *
*   PROGRESS, AND NO NON-TSO (QUEUING) FUNCTIONS ARE TO BE PERFORMED, *
*   CONTROL RETURNS TO THE SEND SCHEDULER TO PUT THE SEND SCHEDULER'S *
*   STCB BACK IN THE QCB'S CHAIN.  IF A NON-TSO OUTPUT FUNCTION IS TO *
*   BE PERFORMED, CONTROL RETURNS TO THE SEND SCHEDULER TO INITIATE A *
*   SEND OPERATION.  IF A TSO SESSION IS IN PROGRESS, THE VARIOUS     *
*   SCHEDULING BITS IN THE QCB ARE CHECKED TO DETERMINE WHETHER OR    *
*   NOT TO INITIATE A TSO SEND OPERATION.  IF A SEND OPERATION IS TO  *
*   BE INITIATED, CONTROL RETURNS TO THE SEND SCHEDULER TO DO SO.  IF *
*   A SIMULATED ATTENTION READ OR A READ OF A PARTIAL INPUT LINE IS   *
*   REQUESTED, IT TAKES PRIORITY OVER OUTPUT.  IN THIS CASE, IF THE   *
*   LCB IS IN THE TIME DELAY QUEUE, THIS ROUTINE LINKS TO THE TIME    *
*   DELAY SUBTASK TO REMOVE IT.  THEN THE LCB IS POSTED TO ITSELF,    *
*   AND CONTROL PASSES TO THE DISPATCHER BYPASS FUNCTION TO IMMEDI-   *
*   ATELY ACTIVATE THE NEXT STCB IN THE LCB'S CHAIN.                  *
*      THIS ROUTINE IS ENTERED FROM THE ACTIVATE - I/O                *
*   GENERATOR MODULE BEFORE IT BUILDS AN INPUT OR OUTPUT CHANNEL      *
*   PROGRAM.  THIS ROUTINE FIRST LINKS TO THE TERMNAME TABLE CODE,    *
*   GETS THE TERMINAL ENTRY, AND EXTRACTS THE QCB ADDRESS FROM IT.    *
*   IF A TSO SESSION IS NOT IN PROGRESS, CONTROL IMMEDIATELY RETURNS  *
*   TO THE ACTIVATE - I/O GENERATOR MODULE.  FOR INPUT, IF A HARDWARE *
*   ATTENTION WAS RECEIVED OR IF A TPUT WAS REQUESTED, THE LCB IS     *
*   POSTED EITHER TO THE ATTENTION ROUTINE SPECIFIED IN THE MH OR TO  *
*   ITSELF, RESPECTIVELY, AND CONTROL IS PASSED TO THE DISPATCHER     *
*   CHAIN FUNCTION TO POST THE INPUT BUFFERS TO THE BUFFER RETURN     *
*   SUBTASK.  IF A PREPARE IS UP ON THE LINE, THIS ROUTINE ISSUES AN  *
*   IOHALT SVC (SVC 33) TO HALT I/O ON THE LINE.  THEN ANOTHER CHECK  *
*   FOR A HARDWARE ATTENTION ON INPUT IS MADE, AND, IF ONE WAS RE-    *
*   CEIVED, IT IS PROCESSED AS STATED ABOVE.  OTHERWISE, CONTROL IS   *
*   RETURNED TO THE ACTIVATE - I/O GENERATOR MODULE AFTER THE IOHALT  *
*      FINALLY, THIS ROUTINE IS ENTERED WHEN EITHER THE ATTENTION     *
*   ELEMENT OR THE LCB IS POSTED TO THE LOCAL RECEIVE SCHEDULER.  IF  *
*   THIS ROUTINE IS ACTIVATED BECAUSE THE ATTENTION ELEMENT WAS       *
*   POSTED, THE SCHEDULER DETERMINES IF THE QCB IS DEDICATED TO TSO.  *
*   IF THE QCB IS DEDICATED AND THE START MI/WCC CHARACTER (2260/3270)*
*   HAS NOT BEEN SENT, THE SCHEDULER RETURNS CONTROL TO THE TCAM      *
*   DISPATCHER.  OTHERWISE THE ROUTINE POSTS THE LCB TO ITSELF. IF THE*
*   SCHEDULER IS ACTIVATED BECAUSE THE LCB WAS POSTED, AND IF TIME    *
*   SHARING IS NOT ACTIVE, THE ROUTINE RETURNS CONTROL TO THE         *
*   LOCAL RECEIVE SCHEDULER.  IF THE START MI/WCC PROMPT HAS BEEN     *
*   SENT THE ROUTINE RETURNS TO THE LOCAL RECEIVE SCHEDULER.  IF      *
*   THE QCB IS ON THE TIME DELAY QUEUE, THE ROUTINE REMOVES IT        *
*   FROM THE QUEUE.  IF A SIMULATED ATTENTION IS REQUESTED, THE       *
*   ROUTINE BRANCHES TO THE TSO MSGEN ROUTINE TO SEND A               *
*   PROMPT.  IF NO TGET HAS BEEN REQUESTED, THE ROUTINE               *
*   RETURNS TO THE LOCAL RECEIVE SCHEDULER.  OTHERWISE, THE           *
*   ROUTINE BRANCHES TO THE TSO MSGEN ROUTINE TO SEND THE             *
*   START MI/WCC PROMPT.                                              *
*                                                                     *
*ENTRY POINTS -- AYZ000 - ON ENTRY FROM THE LEASED RECEIVE SCHEDULER, *
*   TO DETERMINE WHETHER OR NOT TO INITIATE A READ OPERATION.         *
*   CALLING SEQUENCE          L    R6,AVTTSOPT                        *
*                             L    R6,TSISCHED-IEDQTSI(,R6)           *
*                             BAL  R3,0(,R6)                          *
*                                                                     *
*   AYZ100 - ON ENTRY FROM THE DIAL RECEIVE SCHEDULER, TO DETERMINE   *
*   WHETHER OR NOT TO INITIATE A READ OPERATION.                      *
*   CALLING SEQUENCE          L    R6,AVTTSOPT                        *
*                             L    R6,TSISCHED-IEDQTSI(,R6)           *
*                             BAL  R2,4(,R6)                          *
*                                                                     *
*   AYZ300 - ON ENTRY FROM THE QEVENT ROUTINE OF THE LEASED RECEIVE   *
*   SCHEDULER, TO GENERATE A PREPARE CHANNEL PROGRAM WHEN A LINE CON- *
*   NECTED TO A 2741 IS TO BE FREED.                                  *
*   CALLING SEQUENCE          L    R6,AVTTSOPT                        *
*                             L    R6,TSISCHED-IEDQTSI(,R6)           *
*                             BAL  R3,16(,R6)                         *
*                                                                     *
*   AYZ400 - ON ENTRY FROM THE SEND SCHEDULER WHEN IT IS DISPATCHED   *
*   OFF THE QCB, TO DETERMINE WHETHER OR NOT A WRITE BREAK CHANNEL    *
*   COMMAND CAN BE ISSUED.                                            *
*   CALLING SEQUENCE          L    R6,AVTTSOPT                        *
*                             L    R6,TSISCHED-IEDQTSI(,R6)           *
*                             BAL  R3,8(,R6)                          *
*                                                                     *
*   AYZ410 - ON ENTRY FROM THE TIME SHARING DESTINATION SCHEDULER, TO *
*   DETERMINE WHETHER OR NOT A WRITE BREAK CHANNEL COMMAND CAN BE     *
*   ISSUED.                                                           *
*   CALLING SEQUENCE          L    R6,AVTTSOPT                        *
*                             L    R6,TSISCHED-IEDQTSI(,R6)           *
*                             BAL  R3,28(,R6)                         *
*                                                                     *
*   AYZ500 - ON ENTRY FROM THE SEND SCHEDULER WHEN IT IS DISPATCHED   *
*   OFF THE LCB, TO DETERMINE WHETHER OR NOT TO INITIATE A SEND       *
*   OPERATION.                                                        *
*   CALLING SEQUENCE          L    R6,AVTTSOPT                        *
*                             L    R6,TSISCHED-IEDQTSI(R6)            *
*                             BAL  R2,12(,R6)                         *
*                                                                     *
*   AYZ600 - ON ENTRY FROM THE ACTIVATE - I/O GENERATOR MODULE BEFORE *
*   BUILDING AN INPUT OR OUTPUT CHANNEL PROGRAM.                      *
*   CALLING SEQUENCE          L    R6,AVTTSOPT                        *
*                             L    R6,TSISCHED-IEDQTSI(,R6)           *
*                             BAL  R3,24(,R6)                         *
*                                                                     *
*   AYZ700 - ON ENTRY FROM THE LOCAL RECEIVE SCHEDULER (IGG019Q1)     *
*   WHEN EITHER THE ATTENTION ELEMENT OR THE LCB IS POSTED TO THE     *
*   LOCAL RECEIVE SCHEDULER.                                          *
*                             L    R6,AVTTSOPT                        *
*                             L    R6,TSISCHED-IEDQTSI(,R6)           *
*                             BAL  R3,32(,R6)                         *
*                                                                     *
*INPUT -- IEDAYZ IS ENTERED AT ENTRY POINT AYZ000 FROM THE LEASED RE- *
*   CEIVE SCHEDULER WITH THE FOLLOWING REGISTERS SET.                 *
*   R3 HAS THE RETURN ADDRESS IN THE LEASED RECEIVE SCHEDULER         *
*   R4 HAS THE LCB ADDRESS                                            *
*   R6 HAS THE BASE ADDRESS OF IEDAYZ                                 *
*   R8 HAS THE ADDRESS OF THE CURRENT INVITATION LIST ENTRY           *
*   R9 HAS THE INVITATION LIST ADDRESS                                *
*   R10 HAS THE DCB ADDRESS                                           *
*   R11 HAS THE DISPATCHER ADDRESS                                    *
*   R13 HAS THE ADDRESS OF AVTSAVE2                                   *
*   R15 HAS THE BASE ADDRESS OF THE LEASED RECEIVE SCHEDULER          *
*                                                                     *
*      IEDAYZ IS ENTERED AT ENTRY POINT AYZ100 FROM THE DIAL RECEIVE  *
*   SCHEDULER WITH THE FOLLOWING REGISTERS SET.                       *
*   R2 HAS THE RETURN ADDRESS IN THE DIAL RECEIVE SCHEDULER           *
*   R3 HAS THE STCB ADDRESS                                           *
*   R4 HAS THE LCB ADDRESS                                            *
*   R6 HAS THE BASE ADDRESS OF IEDAYZ                                 *
*   R10 HAS THE DCB ADDRESS                                           *
*   R11 HAS THE DISPATCHER ADDRESS                                    *
*   R12 HAS THE BASE ADDRESS OF THE DIAL RECEIVE SCHEDULER            *
*   R13 HAS THE ADDRESS OF AVTSAVE2                                   *
*                                                                     *
*      IEDAYZ IS ENTERED AT ENTRY POINT AYZ300 FROM THE QEVENT ENTRY  *
*   POINT IN THE LEASED RECEIVE SCHEDULER WITH THE FOLLOWING REGIS-   *
*   TERS SET.                                                         *
*   R3 HAS THE RETURN ADDRESS IN THE QEVENT ROUTINE                   *
*   R4 HAS THE LCB ADDRESS                                            *
*   R6 HAS THE BASE ADDRESS OF IEDAYZ                                 *
*   R10 HAS THE DCB ADDRESS                                           *
*   R13 HAS THE ADDRESS OF AVTSAVE2                                   *
*   R15 HAS THE BASE ADDRESS OF THE QEVENT ROUTINE                    *
*                                                                     *
*      IEDAYZ IS ENTERED AT ENTRY POINT AYZ400 FROM THE SEND SCHED-   *
*   ULER, WHEN IT IS DISPATCHED OFF THE QCB, WITH THE FOLLOWING       *
*   REGISTERS SET.                                                    *
*   R3 HAS THE RETURN ADDRESS IN THE SEND SCHEDULER                   *
*   R4 HAS THE LCB ADDRESS                                            *
*   R6 HAS THE BASE ADDRESS OF IEDAYZ                                 *
*   R7 HAS THE DESTINATION QCB ADDRESS                                *
*   R10 HAS THE DCB ADDRESS                                           *
*   R11 HAS THE DISPATCHER ADDRESS                                    *
*   R13 HAS THE ADDRESS OF AVTSAVE2                                   *
*   R15 HAS THE BASE ADDRESS OF THE SEND SCHEDULER                    *
*                                                                     *
*      IEDAYZ IS ENTERED AT ENTRY POINT AYZ410 FROM THE TIME SHARING  *
*   DESTINATION SCHEDULER WITH THE FOLLOWING REGISTERS SET.           *
*   R2 HAS THE RETURN ADDRESS IN THE TIME SHARING DESTINATION         *
*      SCHEDULER                                                      *
*   R3 HAS THE RETURN ADDRESS IN THE TIME SHARING DESTINATION         *
*      SCHEDULER                                                      *
*   R4 HAS THE LCB ADDRESS                                            *
*   R6 HAS THE BASE ADDRESS OF IEDAYZ                                 *
*   R7 HAS THE DESTINATION QCB ADDRESS                                *
*   R10 HAS THE DCB ADDRESS                                           *
*   R11 HAS THE DISPATCHER ADDRESS                                    *
*   R13 HAS THE ADDRESS OF AVTSAVE2                                   *
*                                                                     *
*      IEDAYZ IS ENTERED AT ENTRY POINT AYZ500 FROM THE SEND SCHED-   *
*   ULER, WHEN IT IS DISPATCHED OFF THE LCB, WITH THE FOLLOWING       *
*   REGISTERS SET.                                                    *
*   R2 HAS THE RETURN ADDRESS IN THE SEND SCHEDULER                   *
*   R3 HAS THE ADDRESS OF THE NEXT STCB                               *
*   R4 HAS THE LCB ADDRESS                                            *
*   R6 HAS THE BASE ADDRESS OF IEDAYZ                                 *
*   R7 HAS THE DESTINATION QCB ADDRESS                                *
*   R9 HAS THE SCB ADDRESS                                            *
*   R11 HAS THE DISPATCHER ADDRESS                                    *
*   R12 HAS THE BASE ADDRESS OF THE SEND SCHEDULER                    *
*   R13 HAS THE ADDRESS OF AVTSAVE2                                   *
*                                                                     *
*      IEDAYZ IS ENTERED AT ENTRY POINT AYZ600 FROM THE ACTIVATE -    *
*   I/O GENERATOR MODULE WITH THE FOLLOWING REGISTERS SET.            *
*   R2 HAS THE LCB ADDRESS                                            *
*   R3 HAS THE RETURN ADDRESS IN ACTIVATE - I/O GENERATOR             *
*   R4 HAS THE DCB ADDRESS                                            *
*   R6 HAS THE BASE ADDRESS OF IEDAYZ                                 *
*   R11 HAS THE DISPATCHER ADDRESS                                    *
*   R13 HAS THE ADDRESS OF AVTSAVE2                                   *
*   R15 HAS THE BASE ADDRESS OF ACTIVATE - I/O GENERATOR              *
*                                                                     *
*      IEDAYZ IS ENTERED AT ENTRY POINT AYZ700 FROM THE LOCAL RECEIVE *
*   SCHEDULER WITH THE FOLLOWING REGISTERS SET.                       *
*   R3 HAS THE RETURN ADDRESS IN THE LOCAL RECEIVE SCHEDULER          *
*   R4 HAS THE LCB ADDRESS                                            *
*   R6 HAS THE BASE ADDRESS OF IEDAYZ                                 *
*   R13 HAS THE ADDRESS OF AVTSAVE2                                   *
*                                                                     *
*OUTPUT -- ON LINKING TO THE TERMNAME TABLE CODE THE FOLLOWING REGIS- *
*   TERS ARE SET.                                                     *
*   R1 HAS THE TERMINAL INDEX OR LINE ENTRY                           *
*   R14 HAS THE RETURN ADDRESS IN IEDAYZ                              *
*   R15 HAS THE ENTRY POINT ADDRESS                                   *
*                                                                     *
*      ON LINKING TO THE TIME DELAY SUBTASK THE FOLLOWING REGISTERS   *
*   ARE SET.                                                          *
*   R1 HAS THE ADDRESS OF THE QCB OR LCB TO BE REMOVED FROM OR IN-    *
*      SERTED INTO THE TIME DELAY QUEUE.                              *
*   R14 HAS THE RETURN ADDRESS IN IEDAYZ                              *
*   R15 HAS THE ENTRY POINT ADDRESS                                   *
*                                                                     *
*      ON LINKING TO THE ACTIVATE - I/O GENERATOR MODULE THE TP CODE  *
*   FLAG IS SET IN THE LCB AND THE FOLLOWING REGISTERS ARE SET.       *
*   R2 HAS THE LCB ADDRESS                                            *
*   R5 HAS THE RETURN ADDRESS IN IEDAYZ                               *
*   R12 HAS THE ENTRY POINT ADDRESS                                   *
*                                                                     *
*      ON ENTRY TO THE EXCPVR ROUTINE, REGISTER 1 CONTAINS THE   X02004
*   ADDRESS OF THE IOB.  ON LINKING TO THE IOHALT SVC ROUTINE REGIS-  *
*   TER 1 CONTAINS THE UCB ADDRESS.                                   *
*                                                                     *
*      ON RETURN TO THE LEASED RECEIVE SCHEDULER, THE LCB INVITATION  *
*   LIST POINTER IS UPDATED, AND, AT END OF LIST, THE LCB START OF    *
*   POLLING LIST BIT IS SET ON.  REGISTER 7 CONTAINS THE DESTINATION  *
*   QCB ADDRESS, AND REGISTER 6 IS CLEARED TO ZERO.                   *
*                                                                     *
*      ON RETURN TO THE DIAL RECEIVE SCHEDULER, REGISTER 7 CONTAINS   *
*   THE DESTINATION QCB ADDRESS, AND REGISTER 14 CONTAINS THE SCB     *
*   ADDRESS.  IF A TSO SESSION IS IN PROGRESS, THE LCB TIME SHARING   *
*   BUFFER BIT IS ON, AND THE LCB IS SET TO RE-POLL.                  *
*                                                                     *
*      ON RETURN TO THE QEVENT ROUTINE, REGISTER 7 CONTAINS THE       *
*   DESTINATION QCB ADDRESS.  IF THE DEVICE IS A 2741 OR A DEVICE IN- *
*   HIBITED FROM TIMING OUT, THE LCB PREPARE BIT IS ON.  FOR 2741'S,  *
*   THE LCB POINTS TO THE BEGINNING CCW OF THE GENERATED PREPARE      *
*   CHANNEL PROGRAM.                                                  *
*                                                                     *
*      ON RETURN TO THE SEND SCHEDULER, WHEN POSTED OFF THE QCB,      *
*   REGISTER 14 CONTAINS THE ENTRY POINT OF THE DISPATCHER DISPATCH   *
*   FUNCTION, UNLESS A WRITE BREAK WAS REQUESTED, BUT COULD NOT BE    *
*   ISSUED.  IN THAT CASE, THE QCB READ PRIORITY BIT IS SET OFF.      *
*   ON RETURN TO THE SEND SCHEDULER, WHEN POSTED OFF THE LCB, TO      *
*   START A SEND OPERATION, THE QCB READ PRIORITY BIT IS ALSO SET     *
*   OFF, EXCEPT WHEN A WRITE BREAK WAS REQUESTED.                     *
*                                                                     *
*      ON RETURN TO THE TIME SHARING DESTINATION SCHEDULER, THE QCB   *
*   READ PRIORITY BIT IS SET OFF.  IF THE REQUESTED WRITE BREAK COULD *
*   BE ISSUED, THE LCB WRITE BREAK BIT IS ON, AND REGISTER 8 CONTAINS *
*   THE ADDRESS OF THE FIRST BUFFER.                                  *
*                                                                     *
*      ON RETURN TO THE ACTIVATE - I/O GENERATOR MODULE, REGISTER 7   *
*   CONTAINS THE DESTINATION QCB ADDRESS AND REGISTER 14 CONTAINS THE *
*   SCB ADDRESS.  IF IOHALT WAS ISSUED, THE LCB PREPARE BIT IS OFF.   *
*                                                                     *
*      ON EXIT TO THE DISPATCHER POST FUNCTION, REGISTER 7 CONTAINS   *
*   THE DESTINATION QCB ADDRESS AND REGISTER 1 CONTAINS THE ADDRESS   *
*   OF THE LCB TO BE POSTED.  IF THE EXIT IS TAKEN AFTER A HARDWARE   *
*   ATTENTION, THE QCB SIMULATED ATTENTION READ BIT IS OFF, THE LINE  *
*   IS SET TO SEND MODE, AND THE LCB IS SET TO BE POSTED TO THE       *
*   ATTENTION ROUTINE SPECIFIED IN THE MH.  IF THE EXIT IS TAKEN      *
*   AFTER A NEGATIVE RESPONSE TO POLLING, A PREPARE IS PUT UP ON THE  *
*   LINE, AND THE LCB IS SET TO RE-POLL AND TO BE POSTED TO THE TIME  *
*   DELAY QUEUE.  REGISTER 14 CONTAINS THE SCB ADDRESS.               *
*                                                                     *
*      ON EXIT TO THE DISPATCHER BYPASS FUNCTION, THE LCB IS POSTED   *
*   TO ITSELF, REGISTER 7 CONTAINS THE DESTINATION QCB ADDRESS, AND   *
*   REGISTER 1 CONTAINS THE LCB ADDRESS.  IF ENTRY WAS FROM THE       *
*   LEASED RECEIVE SCHEDULER, THE LCB INVITATION LIST POINTER POINTS  *
*   TO THE FIRST ENTRY, AND THE ADDRESS OF THE NEXT STCB IS SET IN    *
*   REGISTER 3.                                                       *
*                                                                     *
*      ON EXIT TO THE DISPATCHER DISPATCH FUNCTION, THE LINE IS FREED *
*   AND A PREPARE IS PUT UP ON IT.  THE LCB IS SET TO RE-POLL, REGIS- *
*   TER 7 CONTAINS THE DESTINATION QCB ADDRESS, AND REGISTER 14 CON-  *
*   TAINS THE SCB ADDRESS.                                            *
*                                                                     *
*      ON EXIT TO THE DISPATCHER AT DSPUNAV, REGISTER 3 CONTAINS THE  *
*   LCB ADDRESS.  IF AN IOHALT WAS ISSUED, THE QCB READ PRIORITY BIT  *
*   IS OFF, THE LCB WRITE BREAK BIT IS ON, AND REGISTER 8 CONTAINS    *
*   THE ADDRESS OF THE FIRST BUFFER.                                  *
*                                                                     *
*      ON EXIT TO THE DISPATCHER CHAIN FUNCTION, THE LINE IS SET TO   *
*   SEND MODE, REGISTER 7 CONTAINS THE DESTINATION QCB ADDRESS, AND   *
*   REGISTER 14 CONTAINS THE SCB ADDRESS.  THE INPUT BUFFERS ARE SET  *
*   TO BE POSTED TO BUFFER RETURN, AND THE LCB IS POSTED EITHER TO    *
*   ITSELF OR TO THE ATTENTION ROUTINE SPECIFIED IN THE MH, DEPENDING *
*   UPON WHETHER A TPUT WAS REQUESTED OR A HARDWARE ATTENTION RE-     *
*   CEIVED, RESPECTIVELY.                                             *
*                                                                     *
*EXTERNAL ROUTINES -- IEDQTNT - TO GET THE TERMINAL ENTRY FROM THE    *
*   TERMINAL OR LINE ENTRY IN THE LCB.                                *
*   IEDQHG - TO REMOVE AN LCB OR A QCB FROM THE TIME DELAY QUEUE, OR  *
*   TO INSERT A QCB INTO IT.                                          *
*   IEDQKA - TO BUILD A PREPARE CHANNEL PROGRAM                       *
*   IOHALT SVC ROUTINE - TO HALT I/O ON A LINE                        *
*   EXCPVR ROUTINE (SVC 114) - TO START A PREPARE CHANNEL PGM.   X02004
*                                                                     *
*EXITS-NORMAL -- TO THE LEASED RECEIVE SCHEDULER                      *
*   TO THE DIAL RECEIVE SCHEDULER                                     *
*   TO THE QEVENT ROUTINE IN THE LEASED RECEIVE SCHEDULER             *
*   TO THE SEND SCHEDULER                                             *
*   TO THE TIME SHARING DESTINATION SCHEDULER                         *
*   TO THE ACTIVATE - I/O GENERATOR MODULE                            *
*   TO THE DISPATCHER POST FUNCTION                                   *
*   TO THE DISPATCHER BYPASS FUNCTION                                 *
*   TO THE DISPATCHER DISPATCH FUNCTION                               *
*   TO THE DISPATCHER AT DSPUNAV                                      *
*   TO THE DISPATCHER CHAIN FUNCTION                                  *
*   TO THE LOCAL RECEIVE SCHEDULER                                    *
*                                                                     *
*EXITS-ERROR -- NONE                                                  *
*                                                                     *
*TABLES/WORKAREAS -- CVT, AVT, TSB, QCB, TSID, LCB, DCB, SCB,         *
*   BUFFER PREFIX, TERMINAL ENTRY, INVITATION LIST, TPRIOR ERB.       *
*                                                                     *
*ATTRIBUTES -- REENTRANT, ENABLED, PROBLEM PROGRAM MODE.         Y01948
*                                                                     *
*NOTES -- THE OPERATION OF THIS MODULE DOES NOT DEPEND UPON A         *
*   PARTICULAR INTERNAL REPRESENTATION OF THE EXTERNAL CHARACTER SET. *
*                                                                     *
***********************************************************************
         SPACE 2
*        REGISTER EQUATES
         SPACE
R0       EQU   0                        WORK REGISTER
R1       EQU   1                        WORK REGISTER
RTRM     EQU   1                        ADDRESS OF TERM ENTRY, WORK REG
RECB     EQU   1                        ADDR OF ELEMENT TO DSPPOST
R2       EQU   2                        WORK REGISTER
RETURN   EQU   3                        RETURN ADDRESS, WORK REG
RSTCB    EQU   3                        STCB BASE REGISTER        @P1A
RLCB     EQU   4                        ADDRESS OF LCB, WORK REG
R5       EQU   5                        WORK REGISTER
FFF      EQU   4095                     CONTROL COUNT              @21C
RBASE    EQU   6                        ROUTINE BASE REGISTER
RQCB     EQU   7                        ADDRESS OF DEST QCB, WORK REG
R7       EQU   7                        WORK REGISTER
R8       EQU   8                        ADDRESS OF BUFFER, WORK REG
R9       EQU   9                        WORK REGISTER
RDCB     EQU   10                       ADDRESS OF DCB, WORK REG
R10      EQU   10                       WORK REGISTER
RDISP    EQU   11                       ADDRESS OF DISPATCHER, WORK REG
R12      EQU   12                       WORK REGISTER
R13      EQU   13                       ADDRESS OF AVTSAVE2
RSCB     EQU   14                       ADDRESS OF SCB, WORK REG
R14      EQU   14
R15      EQU   15                       WORK REGISTER
         SPACE 2
*        MISCELLANEOUS EQUATES
         SPACE
X10      EQU   X'10'
HIOCC    EQU   X'48'                    HALT I/O COMPLETION CODE Y02027
LOWBYTE  EQU   1                        MASK TO ICM LO-ORDER BYTEX02004
ADDR     EQU   7                        MASK TO STCM ADDRESSES.  X02004
INVPRFIX EQU   8                        SIZE OF INVLIST CONTROL WORDS
CATTN    EQU   X'20'                    TERMINAL HAS ATTENTION FEATURE
CTWX     EQU   X'20'                    TWX CHARACTERISTIC
WRITE    EQU   X'01'                    WRITE COMMAND            S21903
TIC      EQU   X'08'                    TIC COMMAND              S21903
ADDRCHAR EQU   X'20'                    ADDRESSING CHAR          S21903
DIALDIGS EQU   X'40'                    DIAL CHAR                S21903
CCSLI    EQU   X'60'                    CHAINING FLAGS           S21903
BUFSIZE  EQU   X'80'                    BUFFERSIZE               S21903
BSCDEV   EQU   X'90'                    BSC DEVICE               S22028
D3270    EQU   X'04'                    3270 TERMINAL            S22028
D2260    EQU   X'02'                    2260 TERMINAL            S21903
ZERO     EQU   0                        EQUATED CONSTANT       @OZ14197
FOUR     EQU   4                        EQUATED CONSTANT         A56332
EIGHT    EQU   8                        EQUATED CONSTANT         A56332
NOT      EQU   X'FF'                    A BYTE OF ALL ONES       A56332
AUTOPOLL EQU   X'09'                    AUTOPOLL COMMAND CODE    S22029
*                                       COMMAND CODE.            S22029
CMDCODE  EQU   24                       OFFSET TO AUTOPOLL       S22029
ONE      EQU   1                        DISPLACEMENT VALUE       Y02027
TWO      EQU   2                        MASK FOR SHIFTING        Y02027
THREE    EQU   3                        LENGTH VALUE             Y02027
NOTZERO  EQU   7                        MASK FOR TM INSTRUCTION  Y02027
         SPACE 2
*        ADDRESSABILITY
         SPACE
         USING AVTSAVE2,R13             AVT SAVE AREA ADDRESS    S21903
         USING IEDQDISP,RDISP           DISPATCHER ADDRESS       S21903
         USING IEDQLCB,RLCB             LCB ADDRESS              S21903
         USING IEDQPRF,R8               PRIOR ADDRESS            S21903
         USING IEDQQCB,RQCB             QCB ADDRESS              S21903
         USING IEDQSCB,RSCB             SCB ADDRESS              S21903
         USING IEDQTRM,RTRM             TERMTABLE ADDRESS        S21903
         USING IHADCB,RDCB              DCB ADDRESS              S21903
         USING IEDQSTCB,RSTCB           STCB ADDRESS               @P1A
         USING *,RBASE                  BASE ADDRESS             S21903
         SPACE 2
*        ENTRY POINTS
         SPACE
         B     AYZ000                   ENTRY FROM LEASED SCHEDULER
         B     AYZ100                   ENTRY FROM DIAL SCHEDULER
         B     AYZ400                   INITIAL ENTRY FROM SEND SCHED
         B     AYZ500                   SEND SCHED DISPATCHED OFF LCB
         B     AYZ300                   ENTRY FROM QEVENT
         B     AYZ200                   UNUSED ENTRY POINT.    @OZ17622
         B     AYZ600                   ENTRY FROM ACTIVATE
         B     AYZ410                   ENTRY FROM TS DESTINATION SCHED
         B     AYZ700                   ENTRY FROM LOCAL RECEIVE SCHED
         SPACE 2
         SPACE 2
*        CONSTANTS
         SPACE
CIRCLED  DC    X'16'                    CIRCLE D                 S21903
CIRCLECS DC    3X'1F'                   CIRCLE C                 S21903
BLAT     DC    X'C988C988'              DATA FOR TWX MONITOR CCW Y01948
*                                       (NOISE CCW).             Y01948
WRCCCW   CCW   1,CIRCLECS,X'60',3       WRITE CIRCLE C           S21903
RSPCCW   CCW   2,*,X'70',1              RESPONSE CCW             S21903
WRDCCW   CCW   1,CIRCLED,X'60',1        WRITE CIRCLE D           S21903
PREPCCW  CCW   6,*,0,1                  PREPARE CCW              S21903
SPRBTCH  CCW   1,BLAT,X'B0',4           NOISE CCW                Y01004
IEDAYZ   IEDHJN ,                                                S22028
         DS    0H
         SPACE 2
*        THIS CODE IS EXECUTED ON ENTRY FROM THE LEASED RECEIVE
*        SCHEDULER WHEN TSO IS IN THE SYSTEM.
         SPACE
AYZ000   EQU   *
         LH    RTRM,LCBTTBIN            PARAMETERS FOR TERMINAL
AYZ002   EQU   *
         N     RTRM,AVTCLRHI              NAME ROUTINE
         LR    R12,R15                  SAVE REGISTER 15
         L     R15,AVTRNMPT             TNT ADDRESS              S21903
         BALR  RSCB,R15                 BRANCH TO ROUTINE
         LR    R15,R12                  RESTORE REGISTER 15
         L     RSCB,LCBSCBA-1           GET SCB ADDRESS FOR RCV SCHED
         L     RQCB,TRMDESTQ-1          GET QCB ADDRESS
         TM    QCBFLAG,QCBTSSES         TSO SESSION IN PROGRESS?
         BO    AYZ020                   BRANCH ON YES
         B     AYZ015                   RETURN IF NOT
AYZ010   EQU   *
         TM    LCBSTAT2,LCBSYNC         BSC TERMINAL           @OY20733
         BO    AYZ014                   NO NEED TO CHK INHIBIT @OY20733
         TM    QCBTSOF2,QCBINHBN        DO WE WANT INHIBITS?
         BZ    AYZ014                   BRANCH ON NO
         OI    LCBTSOB,LCBINHBN         INDICATE USE OF INHIBITS
AYZ014   EQU   *
         OI    LCBTSOB,LCBTSBUF         TURN ON TIME SHARING BIT
AYZ015   EQU   *
         SR    RBASE,RBASE              CLEAR REGISTER
         NI    LCBTSOB,X'FF'-LCBSOPL    RESET POLL FLAG
         B     4(,RETURN)               RETURN
AYZ020   EQU   *
         ST    RTRM,SCBSCSEG-1          SAVE TERM ENTRY ADDRESS SA55387
         TM    LCBTSOB,LCBPREP          IS LINE BEING MONITORED?
         BO    AYZ060                   BRANCH ON YES
         TM    QCBTSOF2,QCBDSSMI        START MI ON SCREEN
         BO    AYZ030                   BRANCH IF YES
         TM    QCBTSOF1,QCBNOBUF+QCBPARTO+QCBWRBRK CAN WE READ?
         BNZ   AYZ040                   BRANCH ON NO
         TM    QCBFLAG,QCBREAD          READ HAVE PRIORITY?
         BO    AYZ030                   BRANCH ON YES
         TM    QCBTSOF1,QCBTPUT         SEND HAVE PRIORITY?
         BO    AYZ040                   BRANCH ON YES
         TM    QCBFLAG,QCBNOBRK         CAN WE READ AHEAD?
         BZ    AYZ030                   BRANCH ON YES
         TM    QCBTSOF1,QCBTGET         TGET ISSUED?
         BZ    AYZ040                   BRANCH ON NO
AYZ030   EQU   *
         TM    QCBTSOF1,QCBSATRD        SIMULATED ATTENTION REQUESTED?
         BO    AYZ080                   BRANCH ON YES
         TM    QCBTSOF1,QCBDELAY        IS QCB IN TIME DELAY QUEUE?
         BZ    AYZ010                   BRANCH ON NO
         LR    RECB,RQCB                SEND ADDR OF QCB TO BE REMOVED
         LR    R12,R15                 SAVE REGISTER 15
         L     R15,AVTHG02             ADDR OF TIME DELAY REMOVAL RTN
         BALR  R14,R15                  REMOVE QCB FROM DELAY Q.
         LR    R15,R12                 RESTORE REGISTER 15
         NI    QCBTSOF1,X'FF'-QCBDELAY     TURN OFF DELAY BIT    A44022
         B     AYZ010                   BRANCH TO RETURN         S21903
         SPACE 2
*        UPDATE TO NEXT INVITATION LIST ENTRY
         SPACE
AYZ040   EQU   *
         TM    QCBTSOF1,QCBSATRD        SIMULATED ATTENTION READ?
         BO    AYZ080                   BRANCH ON YES
         TM    QCBTSOF2,QCBSATTI        SIMULATED ATTN BY TIME INTERVAL
         BNO   AYZ042                   BRANCH ON NO
         BAL   RDCB,AYZ090              LINK TO TIME DELAY ROUTINE
AYZ042   EQU   *
         L     RDCB,LCBDCBPT            GET DCB ADDRESS
         SR    RTRM,RTRM                CLEAR REGISTER
         IC    RTRM,LCBUCBX             RELATIVE LINE - 1
         SLL   RTRM,2                   MULTIPLY BY FOUR
         L     RTRM,DCBINVLI(RTRM)      ADDRESS INVITATION LIST
         SR    RQCB,RQCB
         IC    RQCB,2(,RTRM)            GET SIZE OF EACH ENTRY
         AR    R8,RQCB                  UPDATE TO NEXT ENTRY
         TM    LCBSTAT2,LCBSYNC         IS THIS A BSC DEVICE     S22028
         BZ    AYZ043                   NO, BRANCH               S22028
         CLI   1(R8),X'FE'              END OF INVITATION LIST?  S22028
         BNE   AYZ050                   NO, BRANCH               S22028
         LA    R8,1(R8)                 INCREMENT PAST EOT CHAR  S22028
         B     AYZ044                   CONTINUE                 S22028
AYZ043   EQU   *                                                 S22028
         CLI   1(R8),X'FE'              END OF INVITATION LIST @OZ35418
         BE    AYZ044                   YES                    @OZ35418
         CLI   0(R8),X'FE'              END OF INVITATION LIST?  S22028
         BNE   AYZ050                   NO, BRANCH               S22028
AYZ044   EQU   *                                                 S22028
         TM    LCBTSOB,LCBSOPL          WERE ANY ENTRIES POLLED?
         BO    AYZ045                   BRANCH ON NO
         OI    LCBTSOB,LCBSOPL          TURN ON START OF POLL LIST BIT
         SR    RBASE,RBASE              CLEAR REGISTER
         BR    RETURN                   RETURN
AYZ045   EQU   *
         LA    R8,INVPRFIX(,RTRM)       POINT TO FIRST ENTRY
         STCM  R8,ADDR,LCBINVPT         UPDATE CURRENT ENTRY.    X02004
         LR    RTRM,RLCB                ADDRESS OF ELEMENT
         SR    RSTCB,RSTCB                                         @P1C
         ICM   RSTCB,ADDR,LCBSTCBA      GET FIRST STCB ADDRESS     @P1C
         CLI   STCBVTO,DSP327L          IS FIRST STCB THE 327L     @P1A
*                                       OUTPUT SCHEDULER(IEDGLO21) @P1A
         BE    NEXTSTCB                 GET NEXT STCB              @P1A
         LA    RQCB,LCBRSKEY            GET RECEIVE SCHEDULER   SA65440
*                                        STCB ADDRESS           SA65440
         CR    RQCB,RSTCB               IS RECEIVE SCHEDULER       @P1C
*                                        FIRST STCB IN CHAIN    SA65440
         BNE   AYZ047                   NO, ACTIVATE FIRST STCB SA65440
NEXTSTCB EQU   *
         ICM   RSTCB,ADDR,LCBRSLNK      ADDRESS OF NEXT STCB       @P1C
AYZ047   EQU   *                                                SA65440
         LR    RQCB,RLCB                ADDRESS OF QCB
         BAL   R14,DSPBYPAS             ACTIVATE NEXT SUBTASK  @G36XRYP
AYZ050   EQU   *
         BCTR  RQCB,0                   SUBTRACT ONE             S21903
         IC    RQCB,0(R8,RQCB)          GET INDEX BYTE
         AR    RQCB,RQCB
         SR    RTRM,RQCB                POINT TO TERMINAL INDEX
         LH    RTRM,0(,RTRM)            GET TERMINAL INDEX
         STH   RTRM,LCBTTBIN            UPDATE CURRENTLY CONNECTED
         STCM  R8,ADDR,LCBINVPT         UPDATE CURRENT ENTRY.    X02004
         B     AYZ002                   BRANCH TO PROCESS
         SPACE 2
*        HALT MONITORING CHANNEL PROGRAM
         SPACE
AYZ060   EQU   *
         SR    R8,R8
         IC    R8,LCBUCBX               RLN MINUS ONE
         SLL   R8,2                     MULTIPLY FOR INDEX
         L     RTRM,DCBDEBAD            DEB ADDRESS
         L     RTRM,32(RTRM,R8)         ADDRESS OF UCB
         LR    R8,RTRM                  SAVE UCB ADDR          @SA68674
         LA    R5,FFF(,0)               LOAD COUNT(4095)           @21C
         SPACE 1
AYZ060A  EQU   *                                               @SA68674
         MVI   LCBECBCC,HIOCC           PREVENT LOST LINE        Y02027
         IOHALT (1)
         LTR   R15,R15                  HIO COMPLETE?              @03A
         BZ    DSPDISP                  BRANCH YES                 @03A
         OC    LCBCSW,LCBCSW            CSW STORED                 @03A
         BNZ   DSPDISP                  YES RETURN TO DISP.        @03A
         BCT   R5,AYZ060A               BRANCH NO-REISSUE HIO      @03A
         B     DSPDISP                  RETURN TO DISPATCHER.      @03A
         SPACE 2
*        SIMULATED ATTENTION SUPPORT
         SPACE
AYZ080   EQU   *
         TM    QCBTSOF2,QCBSIMRD        IS READ PART REQUESTED
         BO    AYZ010                   BRANCH ON YES
AYZ085   EQU   *
         OI    QCBTSOF2,QCBSIMRD        REQUEST READ PART
         LA    R8,X0100                 ADDRESS OF CONSTANT
         ST    R8,SCBMACR-1             STORE IN SCB
         NI    LCBSTAT1,LCBOCNI+LCBOCWTN CLEAR STATUS          @OY14092
         OI    LCBSTAT1,LCBRECVN        SET LCB RECEIVING      @OY14092
         L     RETURN,LCBSCBA-1         PASS SCB ADDRESS TO IEDAYM
         SR    R9,R9                    CLEAR REGISTER
         IC    R9,TRMCHCIN              INDEX TO CHARACTERISTICS
         BCTR  R9,0                     REDUCE BY ONE
         MH    R9,AVTDCTLN              MULTIPLY BY SIZE OF A  @G36XRYP
*                                       DCT ENTRY              @G36XRYP
         A     R9,AVTCSTCS              ADD CHARACTERISTICS START
         USING IEDDCT,R9                DCT ADDRESSABILITY     @G36XRYP
         SR    R1,R1                    CLEAR REGISTER
         TM    DCTBYTE1,DCT3270         IS THIS A 3270 TRM     @G36XRYP
         BO    AYZ084                   YES, BRANCH              S22028
         TM    DCTBYTE3,DCTNOIDL        IS THIS A 2260 REMOTE  @G36XRYP
         BO    AYZ088                   BRANCH ON YES
         TM    DCTBYTE2,DCTLOCAL        IS THIS 2260 LOCAL     @G36XRYP
         BO    AYZ086                   BRANCH ON YES
         TM    DCTBYTE2,DCTTWX          IS THIS A TWX          @G36XRYP
         BO    AYZ089                   BRANCH ON YES
         LA    R8,AYZMASK               ADDRESS OF MASK
         B     AYZ087                   PREPARE TO GO TO MSGGEN
AYZ084   EQU   *                                                 S22028
         TM    DCTBYTE2,DCTBISYN+DCTSTCTL IS THIS 3270 REMOTE  @G36XRYP
         BZ    AYZ081                   NO, IT IS 3270 LOCAL     S22028
         LA    R8,AYZMASK6              ADDRESS OF MASK          S22028
         B     AYZ087                   SET CONNECTED            S22028
AYZ081   EQU   *                                                 S22028
         LA    R8,AYZMASK8              ADDRESS OF MASK          S22028
         B     AYZ087                   BRANCH                   S22028
AYZ088   EQU   *
         LA    R8,AYZMASK4              ADDRESS OF MASK
         B     AYZ087                   SET CONNECTED            S21903
AYZ086   EQU   *
         LA    R8,AYZMASK3              ADDRESS OF MASK
AYZ087   EQU   *
         MVC   LCBTTCIN,LCBTTBIN        SER 'CONNECTED'
         DROP  R9                       DROP DCT               @G36XRYP
         SR    R9,R9                    CLEAR REGISTER
         L     R12,AVTTSOPT             ADDRESS OF TIME SHARING QCB
         L     R12,TSIMSGEN-IEDQTSI(,R12) ADDRESS OF MSGGEN
         BR    R12                      BRANCH TO MSGGEN
AYZ089   EQU   *
         LA    R8,AYZMASK5              GET TWX MASK
         B     AYZ087                   SET CONNECTED            S21903
         SPACE 2
AYZ090 EQU     *
         TM    QCBTSOF2,QCBPOSTO        IS QCB ON RDY Q         SA56307
         BCR   1,RDCB                   IF SO, CNNOT DELAY      SA56307
         LR    R12,R15                  SAVE RCV SCHEDULR BASE ADDR
         BAL   R14,QTIP25               GO PREPARE TO PUT QCB    Y02027
*                                       IN TIME DELAY QUEUE      Y02027
         LTR   R15,R15                  GO TO TIME DELAY RTN?
         BNZ   DLY0010                  NO. CONTINUE.
         LR    R1,RQCB                  PASS QCB ADDRESS TO TIME DELAY
         L     R15,AVTHG01              ADDR OF TIME DELAY RTN.
         BALR  R14,R15                  GO TO TIME DELAY RTN.
DLY0010  EQU   *
         LR    R15,R12                  RESTORE RCV SCHEDULR BASE ADDR
         BR    RDCB                     RETURN
         SPACE 2
***********************************************************************
AYZ700   EQU   *
         SR    R9,R9                    ASSUME LCB POSTED
         LA    RLCB,0(RLCB)             LCB ADDRESS             SA62315
         LA    R1,0(R1)                 ELEMENT POSTED          SA62315
         CR    RLCB,R1                  ATTENTION ELEMENT       SA62315
         BE    AYZ710                   BRANCH IF LCB           SA62315
         LR    R9,RTRM                  INDICATE ATTENTION ELEMENT
AYZ710   EQU   *
         SR    R12,R12                  CLEAR REGISTER
         IC    R12,LCBUCBX              RLN - 1
         SLL   R12,2                    MULTIPLY BY FOUR
         L     RSCB,DCBINVLI(R12)       ILIST FOR THIS LINE
         CLI   1(RSCB),0                ANY ACTIVE ENTRIES
         BNE   AYZ715                   BRANCH IF YES
         LTR   R9,R9                    ATTENTION ELEMENT
         BNZ   AYZ758                   BR YES                 @YA08799
         BR    RETURN                   LINE IS STOPPED GET OUT
*
AYZ715   EQU   *
         SR    R12,R12                  CLEAR INDEX REGISTER    OY00523
         IC    R12,2(RSCB)              LIST ENTRY SIZE
         BCTR  R12,0                    REDUCE BY ONE TO INDEX
         LA    RTRM,8(RSCB)             ADDRESS OF FIRST ENTRY
         IC    R12,0(RTRM,R12)          GET INDEX BYTE
         AR    R12,R12                  DOUBLE FOR NEGATIVE INDEX
         SR    RSCB,R12                 GET TERM TABLE INDEX
         MVC   LCBTTBIN(2),0(RSCB)      TEMPORARILY TO LCB
         LH    RTRM,LCBTTBIN            GET INDEX IN REGISTER
AYZ720   EQU   *
         N     RTRM,AVTCLRHI            CLEAR HIGH ORDER HALF
         LR    R12,R15                  SAVE REGISTER 15
         L     R15,AVTRNMPT             ADDRESS TERM ENTRY ROUTINE
         BALR  RSCB,R15                 LINK TO ROUTINE
         LR    R15,R12                  RESTORE REGISTER 15
         L     RSCB,LCBSCBA-1           ADDRESS OF SCB
         L     RQCB,TRMDESTQ-1          ADDRESS OF DESTINATION QCB
         LTR   R9,R9                    ATTENTION ELEMENT POSTED
         BNZ   AYZ750                   BRANCH ON YES
         TM    QCBFLAG,QCBTSSES         IS THIS TIME SHARING
         BCR   8,RETURN                 RETURN ON NO
         ST    RTRM,SCBSCSEG-1          SAVE TERM ENTRY ADDRESS SA55387
         TM    QCBTSOF2,QCBDSSMI        HAS START MI BEEN SENT
         BCR   1,RETURN                 RETURN ON YES
         TM    QCBTSOF1,QCBDELAY        IS QCB IN TIME DELAY QUEUE
         BZ    AYZ730                   BRANCH ON NO
         LR    RECB,RQCB                ADDRESS OF ELEMENT
         LR    R12,R15                  SAVE REGISTER 15
         L     R15,AVTHG02              TIME DELAY REMOVAL RTN
         BALR  R14,R15                  REMOVE QCB FROM DELAY
         LR    R15,R12                  RESTORE REGISTER 15
         NI    QCBTSOF1,X'FF'-QCBDELAY     TURN OFF DELAY BIT    A44022
         L     RSCB,LCBSCBA-1           ADDRESS OF SCB
AYZ730   EQU   *
         TM    QCBTSOF1,QCBSATRD        SIMULATED ATTN REQUESTED
         BO    AYZ740                   BRANCH ON YES
         TM    QCBTSOF1,QCBPARTO+QCBNOBUF+QCBWRBRK CAN WE READ @SA74985
         BNZ   AYZ770                   BRANCH ON NO           @SA74985
         TM    QCBTSOF1,QCBTGET         HAS TGET BEEN REQUESTED
         BZ    AYZ770                   BRANCH ON NO
         OI    QCBTSOF2,QCBDSSMI        SET START MI SENT
         LA    R8,X0100                 ADDRESS OF CONSTANT
         ST    R8,SCBMACR-1             STORE IN SCB
         NI    LCBSTAT1,LCBOCNI+LCBOCWTN CLEAR STATUS          @OY14092
         OI    LCBSTAT1,LCBRECVN        SET LCB RECEIVING      @OY14092
         MVC   LCBTTCIN,LCBTTBIN        SET CURRENTLY CONNECTED
         SR    R9,R9                    CLEAR REGISTER
         LR    RETURN,RSCB              PASS SCB TO IEDAYM
***************  CHECK FOR 3270  ***************
         L     R1,SCBSCSEG-1            RELOAD TRM REG          SA59987
         IC    R9,TRMCHCIN              INDEX TO CHARACTERISTICS S22028
         SR    R1,R1                    CLEAR REG               SA59987
         BCTR  R9,0                     REDUCE BY ONE            S22028
         MH    R9,AVTDCTLN              MULTIPLY BY SIZE OF A  @G36XRYP
*                                       DCT ENTRY              @G36XRYP
         A     R9,AVTCSTCS              ADD CHARACTERISTICS STARTS22028
         USING IEDDCT,R9                DCT ADDRESSABILITY     @G36XRYP
         TM    DCTBYTE1,DCT3270         IS THIS A 3270 TRM     @G36XRYP
         BZ    AYZ731                   NO, BRANCH               S22028
         LA    R8,AYZMASK7              ADDRESS OF MASK          S22028
         B     AYZ732                   GET ADDRESS MSGGEN       S22028
AYZ731   EQU   *                                                 S22028
         LA    R8,AYZMASK2              ADDRESS OF MASK          S22028
AYZ732   EQU   *                                                 S22028
         DROP  R9                       DROP DCT               @G36XRYP
         SR    R9,R9                    CLEAR REGISTER           S22028
         L     R12,AVTTSOPT             ADDRESS OF TIME SHARING QCB
         L     R12,TSIMSGEN-IEDQTSI(,R12) ADDRESS OF MSGGEN ROUTINE
         BR    R12                      BRANCH TO MSGGEN
AYZ740   EQU   *
         OI    QCBTSOF2,QCBDSSMI        SET START MI SENT
         B     AYZ085                   SEND SIMATTN PROMPT
AYZ750   EQU   *
         TM    QCBFLAG,QCBTSSES         IS THIS TIME SHARING
         BZ    AYZ758                   BR NO                  @YA08799
AYZ755   EQU   *                                               @SA71937
         MVI   LCBTSTSW,AVTEZERO        LCB CAN BE REUSED      @SA71937
         BR    RETURN                   RETURN TO CALLER       @SA71937
AYZ758   EQU   *                                               @YA08799
         TM    LCBSTAT1,LCBFREEN        LCB FREE               @YA08799
         BNO   AYZ760                   BR  NO                 @YA08799
         XI    LCBSTAT1,LCBRECVN+LCBFREEN SET RECEIVING STATUS @YA08799
AYZ760   EQU   *
         MVI   LCBTSTSW,AVTEZERO        LCB CAN BE USED
AYZ761   EQU   *                                                  21008
         ST    RLCB,LCBQCBA-1           QCB FOR POST
         MVI   LCBPRI,PRILNFRE          LCB PRIORITY
         LR    RTRM,RLCB                DISPATCH PARAMETER
         BAL   R14,DSPPOST              BRANCH TO POST         @G36XRYP
AYZ770   EQU   *
         TM    QCBTSOF2,QCBSATTI        SIMULATED ATTENTION BY TIME
         BZ    AYZ780                   BRANCH ON NO
         BAL   RDCB,AYZ090              LINK TO TIME DELAY ROUTINE
AYZ780   EQU   *
         L     RDCB,LCBDCBPT            RESTORE DCB ADDRESS
         BR    RETURN                   RETURN
*******************   DISPLAY MSGGENS  ***********************
         SPACE 2
         DS    0F
AYZMASK  DC    X'000C800000000000',A(SATMSG)     SIM ATTN MSG    S21903
AYZMASK2 DC    X'000C800000000000',A(SMI)        SMI             S21903
AYZMASK3 DC    X'000C800000000000',A(SAT2260)    2260 SIM ATTN   S21903
AYZMASK4 DC    X'000C800000000000',A(SAT2260R)   2260 SIM ATTN   S21903
AYZMASK5 DC    X'000C800000000000',A(SATTWX)     TWX SIM ATTN    S21903
AYZMASK6 DC    X'000C800000000000',A(SAT3270R)   3270R SIM ATTN  S22028
AYZMASK7 DC    X'000C800000000000',A(L327PRPT)   3270L PROMPT    S22028
AYZMASK8 DC    X'000C800000000000',A(SAT3270L)   3270L SIM ATTN  S22028
X0100    DC    X'0100'                           MASK            S21903
SATMSG   DC    X'07',X'17063606360617'           SIM ATTN MSG    S21903
SATTWX   DC    X'08',X'3C113C113C113C11'         TWX SIM ATTN    S21903
SMI      DC    X'01',X'4A'                       SMI             S21903
SAT2260  DC    X'04',C'***',X'4A'                2260 SIM ATTN   S21903
SAT2260R DC    X'03',C'***'                      2260R SIM ATTN  S21903
L327PRPT DC    X'01',X'C3'                       3270L PROMPT    S22028
SAT3270L DC    X'03',C'***'                      3270L SIM ATTN  S22028
SAT3270R DC    X'03',C'***'                      3270R SIM ATTN  S22028
         DS    0H
         SPACE 2
*        THIS CODE IS EXECUTED ON ENTRY FROM THE DIAL RECEIVE
*        SCHEDULER WHEN TSO IS IN THE SYSTEM.
         SPACE
AYZ100   EQU   *
         LH    RTRM,LCBLNENT            GET LINE ENTRY
         N     RTRM,AVTCLRHI            PARAMETERS FOR TERM NAME RTN
         LTR   RTRM,RTRM                IS THERE A LINE ENTRY?
         BCR   8,R2                     RETURN IF NOT - CAN'T BE TSO
         L     R15,AVTRNMPT
         BALR  RSCB,R15                 BRANCH TO ROUTINE
         L     RSCB,LCBSCBA-1           GET ADDRESS OF SCB
         L     RQCB,TRMDESTQ-1          GET QCB ADDRESS
         TM    QCBFLAG,QCBTSSES         TSO SESSION IN PROGRESS?
         BCR   8,R2                     RETURN IF NOT
         ST    RTRM,SCBSCSEG-1          SAVE TERM ENTRY ADDRESS SA55387
         TM    LCBTSOB,LCBPREP          IS THE LINE BEING MONITORED?
         BO    AYZ060                   BRANCH ON YES
         TM    QCBTSOF1,QCBNOBUF+QCBPARTO+QCBWRBRK CAN WE READ?
         BNZ   AYZ140                   BRANCH ON NO
         TM    QCBFLAG,QCBREAD          READ HAVE PRIORITY?
         BO    AYZ120                   BRANCH ON YES
         TM    QCBFLAG,QCBNOBRK         CAN WE READ AHEAD?
         BZ    AYZ120                   BRANCH ON YES
         TM    QCBTSOF1,QCBTGET         WAS A TGET ISSUED?
         BZ    AYZ140                   BRANCH ON NO TO FREE LINE
AYZ120   EQU   *
         TM    QCBTSOF1,QCBSATRD        SIMULATED ATTENTION REQUESTED?
         BO    AYZ180                   BRANCH ON YES
         TM    LCBSTAT2,LCBNEGRP        NEGATIVE RESPONSE TO POLL?
         BZ    AYZ130                   BRANCH ON NO
         NI    LCBSTAT2,X'FF'-LCBNEGRP  SET TO REPOLL
         SR    RTRM,RTRM
         ICM   RTRM,LOWBYTE,DCBINTVL    IS THERE A POLL DELAY    X02004
         BZ    AYZ130                   BRANCH ON NO
         L     R15,LCBSTCBA-1           ADDRESS OF FIRST STCB     M5954
         CLI   0(R15),DSPDIASC          IS IT RECEIVE SCHEDULER   M5954
         BNE   AYZ130                   BRANCH IF NOT             M5954
         SPACE 2
*        PUT LINE IN DELAY QUEUE
         SPACE
         STH   RTRM,LCBEOLTD            TIME DELAY PARAMETER
         MVI   LCBTDL,X'14'             SET LCB INDEX
         MVC   LCBSTCBA,LCBRSLNK        NEXT STCB IN CHAIN
         MVI   LCBPRI,PRILNFRE          PRIORITY
         OI    LCBTSOB,LCBTSBUF         INDICATE TO DELAY RTN TSO LINE
         LA    RTRM,AVTDELYB            SET UP TO POST TO
         ST    RTRM,LCBQCBA-1             TIME DELAY QUEUE
         LR    RTRM,RLCB
         BAL   R14,DSPPOST              BRANCH TO POST         @G36XRYP
AYZ130   EQU   *
         TM    QCBTSOF1,QCBDELAY        IS QCB IN THE DELAY QUEUE?
         BZ    AYZ132                   BRANCH ON NO
         LR    RECB,RQCB                SET ADDRESS OF QCB TO BE REMOVE
         L     R15,AVTHG02              ADDRESS OF TIME DELAY REMOVAL
         BALR  R14,R15                  REMOVE QCB FROM DELAY QUEUE
         NI    QCBTSOF1,X'FF'-QCBDELAY     TURN OFF DELAY BIT    A44022
AYZ132   EQU   *
         TM    QCBTSOF2,QCBINHBN        DO WE WANT INHIBITS?
         BZ    AYZ135                   BRANCH ON NO
         OI    LCBTSOB,LCBINHBN         INDICATE USE OF INHIBITS
AYZ135   EQU   *
         OI    LCBTSOB,LCBTSBUF         TURN ON TIME SHARING BIT
         BR    R2                       RETURN
         SPACE 2
*        PUT UP PREPARE ON APPROPRIATE LINES AND FREE LINE
         SPACE
AYZ140   EQU   *
         TM    QCBTSOF1,QCBSATRD        SIMULATED ATTENTION READ?
         BO    AYZ180                   BRANCH ON YES
         TM    QCBTSOF2,QCBSATTI        SIMULATED ATTN BY TIME INTERVAL
         BO    AYZ190                   BRANCH ON YES
AYZ150   EQU   *
         NI    LCBSTAT1,LCBOCNI+LCBOCWTN CLEAR STATUS          @OY14092
         OI    LCBSTAT1,LCBFREEN        SET LCB FREE           @OY14092
         L     RSCB,LCBSCBA-1           GET ADDRESS OF SCB
         L     RTRM,SCBSCSEG-1          GET TERM ENTRY ADDRESS
         BAL   RETURN,AYZ320            BRANCH TO PUT UP PREPARE
         NI    LCBSTAT2,X'FF'-LCBNEGRP-LCBSNDPR
         B     DSPDISP                  GO TO 'FORGET' LINE
AYZ180   EQU   *
         TM    QCBTSOF2,QCBSIMRD        IS READ PART REQUESTED
         BZ    AYZ085                   BRANCH ON NO
         NI    LCBSTAT2,X'FF'-LCBNEGRP  TURN OFF NEGATIVE RESPONSE
         B     AYZ132                   CHECK INHIBITS           S21903
AYZ190   EQU   *
         TM    QCBTSOF2,QCBPOSTO        IS QCB ON RDY Q         SA56307
         BO    AYZ150                   IF SO, CNNOT DELAY      SA56307
         BAL   R14,QTIP25               GO PREPARE TO PUT QCB    Y02027
*                                       IN TIME DELAY QUEUE      Y02027
         LTR   R15,R15                  GO TO TIME DELAY RTN?
         BNZ   AYZ150                   NO - GO SET LCB FREE.    Y01948
         LR    R1,RQCB                  PASS QCB ADDRESS TO TIME DELAY
         L     R15,AVTHG01              ADDR OF TIME DELAY RTN.
         BALR  R14,R15                  GO TO TIME DELAY RTN.
         B     AYZ150                   SET LCB FREE             S21903
         SPACE 2
**************************************************************** Y02027
*        SET UP QCB FOR INSERTION ON TIME DELAY QUEUE          * Y02027
**************************************************************** Y02027
QTIP25   EQU   *                                                 Y02027
         LA    R15,FOUR                 SET POSSIBLE RET CODE    Y02027
         TM    QCBTSOF1,QCBTPUT+QCBDELAY    IF A SEND OPER REQ'D Y02027
         BCR   NOTZERO,R14              OR IF QCB ALREADY ON TIMEY02027
*                                       DELAY Q, RETURN TO CALLERY02027
         L     R1,AVTTSOPT              GET ADDR OF TSINPUT QCB  Y02027
         USING IEDQTSI,R1               TSI ADDRESSIBILITY       Y02027
         MVC   QCBELCHN(THREE),TSISIMAT+ONE   SET UP TO POST QCB Y02027
         DROP  R1                       TO SIMULATED ATTN RTN    Y02027
*                                       WHEN TIME DELAY EXPIRES  Y02027
         MVI   QCBPRI,PRITIME           SET PRIORITY             Y02027
         BAL   R2,GETTSB                GO FIND TSB            @ZA01117
         SPACE 1
         USING TSB,R5                   TSB ADDRESSIBILITY       Y02027
         MVC   QCBEOLDT(TWO),TSBATNTC   UPDATE TIME INTERVAL     Y02027
         DROP R5                                                 Y02027
         OI    QCBTSOF1,QCBDELAY        SET DELAY FLAG           Y02027
         MVC   QCBLINK(THREE),QCBCARCT  SAVE CARRIAGE CNT & TJID Y02027
         MVI   QCBRETCT,AVTEZERO        MARK ELEMENT AS A QCB    Y02027
         SR    R15,R15                  SET OK RETURN CODE       Y02027
         BR    R14                      RETURN TO CALLER         Y02027
         SPACE 1
GETTSB   EQU   *                                                 Y02027
         L     R5,CVTPTR                GET CVT PTR              Y02027
         L     R5,CVTASVT-CVT(R5)       GET ASVT PTR             Y02027
         LA    R5,ASVTENTY-ASVT(R5)     GET ASCB LIST PTR        Y02027
         LH    R15,QCBTJID              GET TJID                 Y02027
         BCTR  R15,AVTEZERO             ADJUST FOR PROPER OFFSET Y02027
         SLL   R15,TWO                  MULTIPLY BY 4            Y02027
         AR    R5,R15                                            Y02027
         L     R5,AVTEZERO(,R5)         ASCB BASE                Y02027
         L     R5,ASCBTSB-ASCB(R5)      GET TSB                  Y02027
         BR    R2                       RETURN TO CALLER       @ZA01117
         SPACE 1
*        THIS ENTRY POINT IS NO LONGER USED                    @OZ17622
AYZ200   EQU   *
         SPACE 2
*        THIS CODE IS EXECUTED ON ENTRY FROM QEVENT WHEN TSO IS IN
*        THE SYSTEM.
         SPACE
AYZ300   EQU   *
         USING IEDQTRM,RTRM             REEST ADDRESSIBILITY     Y02027
         SR    RTRM,RTRM
         IC    RTRM,LCBUCBX             RLN MINUS ONE
         L     RDCB,LCBDCBPT            PICK UP DCB ADDRS
         SR    R5,R5                    CLEAR REGISTER
         IC    R5,DCBILCT               GET NUMBER OF LISTS
         BCTR  R5,0                     REDUCE BY ONE
         CR    RTRM,R5                  IS RLN GREATER THAN NUMBER
*                                       OF LISTS
         BCR   2,RETURN                 RETURN ON YES
         SLL   RTRM,2                   MULTIPLY BY FOUR
         L     RSCB,DCBINVLI(RTRM)      GET INVITATION LIST ADDRESS
         CLI   0(RSCB),1                ONLY ONE ENTRY?
         BCR   7,RETURN                 BRANCH ON NO TO RETURN
         SH    RSCB,AVTHA2              POINT TO TERMINAL INDEX
         LH    RTRM,0(RSCB)             PARAMETERS FOR TERMINAL
         N     RTRM,AVTCLRHI              NAME ROUTINE
         ST    R15,AVTDOUBL             SAVE QEVENT BASE REGISTER
         L     R15,AVTRNMPT
         BALR  RSCB,R15                 BRANCH TO ROUTINE
         L     R15,AVTDOUBL             RESTORE QEVENT BASE REGISTER
         L     RQCB,TRMDESTQ-1          GET QCB ADDRESS
         TM    QCBFLAG,QCBTSSES         IS IT A TIME SHARING SESSION?
         BCR   8,RETURN                 BRANCH ON NO TO RETURN
AYZ320   EQU   *
         TM    LCBSTAT1,LCBOCNI         NON-IMMEDIATE OP CNTL    @01A
         BOR   RETURN                   BRANCH YES               @01A
         TM    LCBTSOB,LCBPREP          IS THERE ALREADY A PREPARE UP?
         BCR   1,RETURN                 RETURN IF YES
         SR    R5,R5
         IC    R5,TRMCHCIN              INDEX TO CHARACTERISTIC ENTRY
         BCTR  R5,0                     SUBTRACT ONE             S21903
         MH    R5,AVTDCTLN              MULTIPLY BY SIZE OF A  @G36XRYP
*                                       DCT ENTRY              @G36XRYP
         A     R5,AVTCSTCS              ADD ADDRESS OF TABLE
         USING IEDDCT,R5                DCT ADDRESSABILITY     @G36XRYP
         TM    LCBSTAT2,LCBDIAL         IS IT A DIAL LINE?
         BZ    AYZ325                   BRANCH ON NO
         MVC   LCBTTBIN,LCBLNENT        MOVE IN TERMIANL INDEX
         B     AYZ330                   CHECK CONNECTED          S21903
AYZ325   EQU   *
         TM    DCTBYTE1,DCTATTEN        TERMINAL HAVE ATTEN    @G36XRYP
         BCR   8,RETURN                 RETURN ON NO
         SR    R8,R8
         IC    R8,LCBUCBX               RLN MINUS ONE
         SLL   R8,2                     MULTIPLY BY FOUR
         L     R8,DCBINVLI(R8)          GET INVITATION LIST ADDRESS
         CLI   0(R8),1                  ONLY ONE ENTRY?
         BCR   7,RETURN                 BRANCH ON NO TO RETURN
AYZ330   EQU   *
         NC    LCBTTCIN,LCBTTCIN        TERMINAL CONNECTED?
         BNZ   AYZ3300                  YES. INITIALIZATION UNNECESSARY
         MVC   LCBTTCIN,LCBTTBIN        INITIALIZE FOR MSGGEN ROUTINE
AYZ3300  EQU   *
         TM    DCTBYTE2,DCTTWX          IS IT A TWX            @G36XRYP
         BO    AYZ340                   BRANCH ON YES
         TM    LCBTSOB,LCB2741N         IS IT A 2741?
         BO    AYZ360                   BRANCH ON YES
         SPACE 2
*        PUT UP PREPARE FOR 1050
         SPACE
         DROP  R5                       DROP DCT               @G36XRYP
         SR    R5,R5                    CLEAR REGISTER
         LA    R8,TRMOPNO               ADDRESS OF NUMBER OF OPTIONS
         TM    TRMDEVFL,ADDRCHAR        ARE ADDRESSING CHARS PRESENT
         BCR   14,RETURN                RETURN ON NO
         TM    TRMSTATE,TRMOPTFN        ARE OPTION FIELDS PRESENT
         BNO   AYZ331                   BRANCH ON NO
         IC    R5,TRMOPNO               NUMBER OF OPTION FIELDS
         LA    R8,3(R5,R8)              SKIP OVER OPTION FIELDS
AYZ331   EQU   *
         TM    TRMDEVFL,BUFSIZE+DIALDIGS ARE DIAL DIGITS OR BUFFER
*                                       SIZE SPECIFIED
         BZ    AYZ335                   BRANCH IF NEITHER PRESENT
         BM    AYZ333                   BRANCH IF ONLY ONE PRESENT
*   BOTH BUFFER SIZE AND DIAL DIGITS PRESENT
         IC    R5,0(R8)                 LENGTH OF DEVICE FIELD
         LA    R8,1(R5,R8)              SKIP OVER FIELD
AYZ333   EQU   *
         IC    R5,0(R8)                 LENGTH OF DEVICE FIELD
         LA    R8,1(R5,R8)              SKIP OVER FIELD
AYZ335   EQU   *
         MVC   LCBCPA(8),WRCCCW         WRITE EOT CCW
         XC    LCBCPA+8(8),LCBCPA+8     CLEAR CCW AREA
         MVC   LCBCPA+15(1),0(R8)       SET CCW COUNT
         LA    R8,1(R8)                 SKIP PAST COUNT
         ST    R8,LCBCPA+8              STORE ADDRESS OF ADDRESSING
*                                       CHARACTERS IN CCW
         MVI   LCBCPA+8,WRITE           SET CCW COMMAND CODE
         MVI   LCBCPA+12,CCSLI          SET CCW FLAGS
         MVC   LCBCPA+16(24),RSPCCW     MOVE REST OF CHANNEL PROGRAM
         MVI   LCBTPCD,X10              SET TP OP CODES
         MVC   LCBTPCD+1(4),LCBTPCD     AND PROPAGATE
         TM    LCBSTAT2,LCBRESP         RESPONSE OWED
         BZ    AYZ390                   BRANCH NO
*
       L       R8,LCBCPA                WRITE EOT ADDRESS
         BCTR  R8,0                     BACK IT UP TO EOA SEQUENCE
         ST    R8,LCBCPA                PUT BACK
         NI    LCBSTAT2,X'FF'-LCBRESP   RESET RESPONSE OWED BIT
         B     AYZ390                   BRANCH TO EXCP
         SPACE 2
AYZ360   EQU   *
         SPACE 2
*        PUT UP A PREPARE FOR A 2741
         SPACE
         TM    LCBTSOB,LCBCIRCD         WAS CIRCLE D OR CIRCLE C SENT?
         BO    AYZ385                   BRANCH IF IT WAS CIRCLE D
         MVC   LCBCPA(16),WRDCCW        SET UP CHANNEL PROGRAM
         MVI   LCBTPCD+1,X10            MOVE IN TP CODE
         B     AYZ390                   SET UP CCW               S21903
         SPACE 2
*        PUT UP MONITOR CHANNEL PROGRAM FOR TWX
         SPACE 2
AYZ340   EQU   *
         MVC   LCBCPA(8),SPRBTCH   SET UP CCW
         MVI   LCBTPCD+1,X10       SET SECOND TP OP CODE
         LA    RTRM,LCBCPA         ADDRESS OF WRITE
         ST    RTRM,LCBCPA+8       SET UP TIC ADDRESS
         MVI   LCBCPA+8,TIC        SET OP CODE
         B     AYZ390              CONYINUE
*
AYZ385   EQU   *
         MVC   LCBCPA(8),PREPCCW        SET UP CHANNEL PROGRAM
AYZ390   EQU   *
         MVI   LCBTPCD,X10              MOVE IN TP CODE
         OI    LCBTSOB,LCBPREP          SET 'PREPARE ON LINE' BIT
         LA    RTRM,LCBCPA
         ST    RTRM,LCBSTART-1          MOVE IN START ADDRESS OF CCW
         LA    RTRM,LCBFLAG1            IOB ADDRESS IN REG 1 FOR EXCP
         ST    R15,AVTDOUBL             SAVE QEVENT BASE REGISTER
         EXCPVR (1),SUBSYS                                       Y01004
         L     R15,AVTDOUBL             RESTORE QEVENT BASE REGISTER
         BR    RETURN                   RETURN
         SPACE 2
*        THIS CODE IS EXECUTED ON ENTRY FROM THE SEND SCHEDULER WHEN
*        IT IS DISPATCHED OFF THE QCB, AND THE PRESENT TERMINAL IS
*        DEDICATED TO A TIME SHARING SESSION.  CODE AT ENTRY POINT
*        AYZ410 IS EXECUTED ON ENTRY FROM THE TS DESTINATION SCHEDULER
*        WHEN A TPUT WITH THE BREAK OPTION HAS BEEN REQUESTED.
         SPACE
AYZ400   EQU   *
         TM    QCBTSOF1,QCBDISC         ARE WE LOGGONG OFF
         BO    AYZ402                   BRANCH YES                M2550
         ST    R15,AVTSAVE3+4           SAVE REG 15            @SA67152
         BAL   R2,GETTSB                GET TSB                @SA67152
         L     R15,AVTSAVE3+4           RESTORE REG 15         @SA67152
         TM    TSBSTAT-TSB(R5),TSBDISC  IS IT LOGGING OFF      @SA67152
         BZ    AYZ400A                  NO  BRANCH             @SA67152
         NI    QCBTSOF2,NOT-QCBDSSMI    SMI OFF                @SA67152
         B     AYZ403                                          @SA67152
AYZ400A  EQU   *                                               @SA67152
         TM    QCBTSOF1,QCBSATRD        SIMULATED ATTENTION READ?
         BZ    AYZ400B                  NOT REQUESTED          @YA05164
         LR    RETURN,RLCB              MOVE SEND SCH TO LCB   @YA05164
         BAL   R14,DSPUNAVR             MOVE AND RETURN        @YA05164
         TM    LCBSTAT1,LCBFREEN        LCB FREE ?             @YA05164
         BNO   DSPDISP                  DISPATCH NEXT UNIT     @YA05164
         XI    LCBSTAT1,LCBSENDN+LCBFREEN   SEND ON,FREE OFF   @YA07698
         B     AYZ761                   POST LCB               @YA05164
         SPACE 1                                               @YA05164
AYZ400B  EQU   *                                               @YA05164
         TM    QCBTSOF1,QCBTPUT         Q IS THERE AN OUTSTANDING 21008
*                                       TPUT                      21008
         BO    AYZ401                   YES - CONTINUE SEND       21008
*                                       OPERATION                 21008
         TM    QCBTSOF1,QCBTGET         Q IS THERE AN OUTSTANDING 21008
*                                       TGET                      21008
         BO    AYZ498                   YES - SCHEDULE RECEIVE    21008
*                                       OPERATION                 21008
AYZ401   EQU   *                                                  21008
         TM    QCBTSOF2,QCBDSSMI        HAS STARTMI BEEN SENT
         BO    AYZ495                   BRANCH ON YES
         B     AYZ403                   BRANCH AROUND 2741 CODE   M2550
AYZ402   EQU   *
*  THE FOLLOWING CARD FOR M0892 REPLACES CODE ADDED BY PTM2550 TO
*  CHECK FOR A 2741 LEASED LOGGING OFF AND SETTING THE FIRST TIME
*  SWITCH IN LCBTPCD+11 TO CAUSE INITIAL READ AFTER LOGOFF TO SKIP
*  WRITE CIRCLE C. THIS IS TO ALLOW THE KEYBOARD TO LOCK, AND KEEP THE
*  METER FROM RUNNING UNTIL A USER WISHES TO LOG ON AGAIN.
*  THE CODE IS NOW A SUBROUTINE
         BAL   R2,AYZ403A               CHK FOR 2741 LEASED
AYZ403   EQU   *                                                  M2550
         TM    QCBTSOF1,QCBSATRD        SIMATTN?               @OZ28271
         BZ    AYZ403B                  NO                     @OZ28271
         MVI   QCBSATCT,ZERO            ZERO LINE COUNT        @OZ28271
         MVI   QCBCARCT,ZERO            ZERO CARRIAGE COUNT    @OZ28271
AYZ403B  EQU   *                                               @OZ28271
         NI    QCBTSOF1,X'FF'-QCBSATRD  RESET SIMATTN
         NI    QCBTSOF2,X'FF'-QCBSIMRD  READ INDICATORS
         LA    RSCB,DSPDISP             SET UP REG 14 FOR RETURN
         TM    QCBTSOF1,QCBWRBRK        WRITE BREAK REQUESTED?
         BO    AYZ405                   BRANCH ON YES
         TM    QCBFLAG,QCBREAD          DOES READ HAVE PRIORITY?
         BO    AYZ495                   BRANCH ON YES
         BR    RETURN                   RETURN
         SPACE 1                                                  M0892
AYZ403A  EQU   *                                                  M0892
*  REMAINING PART  OF SUBROUTINE ADDED BY M2550 NOW MOVED BY M0892...
         TM    LCBTSOB,LCB2741N         IS THIS A 2741 LEASED     M2550
         BCR   8,R2                     BRANCH NO                 M2550
         TM    LCBSTAT2,LCBDIAL         IS IT LEASED LINE         M2550
         BCR   1,R2                     BRANCH NO                 M2550
         MVI   LCBTPCD+11,X'AB'         SET FIRST TIME SWITCH     M2550
         BR    R2                       RETURN TO CALLER          M2550
AYZ405   EQU   *
         LA    R2,AYZ496                SET RETURN NOT FROM IEDAYDM6360
         B     AYZ411                   BRANCH                   A42370
AYZ410   EQU   *
         TM    QCBTSOF1,QCBDISC         ARE WE LOGGING OFF       A42370
         BNO   AYZ410A                  BRANCH NO               OY03940
         BAL   R2,AYZ403A               CHK FOR 2741 LSD LOGOFF   M0892
AYZ410A  EQU   *                                                OY03940
         LA    R2,AYZ497                SET TO HIO RET CODE     OY03940
         SPACE 3
AYZ411   EQU   *                                                SA68242
         NI    QCBFLAG,X'FF'-QCBREAD    TURN OFF 'READ PRIORITY' BIT
         SPACE 2
*        DETERMINE WHETHER A WRITE BREAK CHANNEL COMMAND CAN BE
*        ISSUED.  IF SO, ISSUE AN IOHALT.
         SPACE
         TM    LCBSTAT1,LCBFREEN        IS LCB FREE
         BO    AYZ412                   BRANCH ON YES
         TM    LCBSTAT1,LCBRECVN        IS LINE RECEIVING
         BCR   8,RETURN                 BRANCH ON NO TO RETURN
AYZ412   EQU   *
         TM    LCBTSOB,LCBWRBRK         WRITE BREAK IN PROGRESS
         BCR   1,RETURN                 RETURN IF YES
         TM    LCBSTAT2,LCBMSGNN        IS IT FOR MSGGEN?
         BCR   1,RETURN                 RETURN IF YES
         CLI   LCBCPA+CMDCODE,AUTOPOLL  IS LINE IN AUTOPOLL?     S22029
         BCR   8,RETURN                 YES. DO NOT BREAK LINE.  S22029
         TM    QCBTSOF1,QCBDISC         ARE WE LOGGING OFF
         BO    AYZ415                   BRANCH ON YES
         TM    QCBFLAG,QCBNOBRK         CAN TERMINAL BE BROKEN?
         BCR   1,RETURN                 BRANCH ON NO TO RETURN
AYZ415   EQU   *
         TM    LCBSTAT2,LCBDIAL         IS IT A DIAL LINE?
         BO    AYZ425                   BRANCH ON YES
         LH    RTRM,LCBTTCIN            GET INDEX TO TERMINAL
         N     RTRM,AVTCLRHI
         LR    R8,R15                   SAVE REG 15
         L     R15,AVTRNMPT             ADDRESS OF TERMINAL NAME RTN
         BALR  RSCB,R15                 GET TERM ENTRY ADDRESS   S21903
         LR    R15,R8                   RESTORE REG 15
         LA    RSCB,DSPDISP             SET UP REG 14 FOR RETURN
         L     RTRM,TRMDESTQ-1          ADDRESS OF QCB
         LA    RTRM,0(RTRM)
         LA    RQCB,0(RQCB)             CLEAR HIGH ORDER BYTE
         CR    RTRM,RQCB                ARE WE CONNECTED TO THIS TERM?
         BCR   7,RETURN                 BRANCH ON NO TO RETURN
AYZ425   EQU   *
         L     R8,LCBLSPCI-1            GET ADDRESS OF FIRST BUFFER
         SR    RSCB,RSCB
         IC    RSCB,LCBUCBX             RLN MINUS ONE
         SLL   RSCB,2                   MULTIPLY BY FOUR FOR INDEX
         L     RTRM,DCBDEBAD            DEB ADDRESS
         L     RTRM,32(RTRM,RSCB)       UCB ADDRESS
         TM    QCBFLAG,QCBNOBRK         CAN WE ISSUE BREAK
         BO    AYZ440                   BRANCH NO BREAK FEATURE
         OI    LCBTSOB,LCBWRBRK         BIT TO TELL CEA TO BREAK
         LR    R8,RTRM                  SAVE UCB ADDR          @SA68674
         SPACE 1
AYZ440   EQU   *
         SPACE 2
*        ISSUE IOHALT
         SPACE
         MVI   LCBECBCC,HIOCC           PREVENT LOST LINE        Y02027
         IOHALT (1)
         BR    R2                       RETURN TO CALLER       @OS76502
AYZ496   EQU   *                                                  M6360
         LR    RETURN,RLCB              TO MOVE SEND SCHED TO LCB M6360
         BAL   R14,DSPUNAVR             MOVE IT AND RETURN        M6360
AYZ497   EQU   *                                                 A42370
         TM    LCBSTAT1,LCBFREEN        LCB FREE
         BNO   DSPDISP                  BRANCH NO                S22029
         XI    LCBSTAT1,LCBFREEN+LCBSENDN  SET LCB SENDING       S22029
         B     AYZ760                   POST LCB                 S22029
AYZ495   EQU   *
         LR    RETURN,RLCB              MOVE SEND SCHEDULER TO LCB
         BAL   R14,DSPUNAV              BRANCH TO UNAVAIL      @G36XRYP
AYZ498   EQU   *                                                  21008
         NI    LCBSTAT2,X'FF'-LCBSNDPR  RESET SEND PRIORITY FLAG  21008
         CLI   LCBSTAT1,LCBFREEN        Q IS THE LINE FREE?       21008
         BE    AYZ499                   YES - GO CHECK FOR        21008
*                                       PARTIAL OUTPUT OR NO BUFR 21008
         NI    LCBTSOB,X'FF'-LCBSOPL    RESET START OF POLLING    21008
*                                       LIST INDICATOR            21008
         B     DSPDISP                  DISPATCH NEXT SUBTASK     21008
AYZ499   EQU   *                                                  21008
         TM    QCBTSOF1,QCBNOBUF+QCBPARTO Q IS THERE A PARTIAL    21008
*                                         OUTPUT LINE OR NO BFRS  21008
         BM    DSPDISP                  DISPATCH NEXT SUBTASK     21008
         NI    LCBSTAT1,LCBOCNI+LCBOCWTN CLEAR STATUS          @OY14092
         OI    LCBSTAT1,LCBSENDN        SET LCB SENDING        @OY14092
         B     AYZ761                   GO POST LCB               21008
         SPACE 2
*        THIS CODE IS EXECUTED ON ENTRY FROM THE SEND SCHEDULER WHEN
*        IT IS DISPATCHED OFF THE LCB AND TIME SHARING IS IN THE
*        SYSTEM.
         SPACE
AYZ500   EQU   *
         TM    QCBFLAG,QCBTSSES         TSO SESSION IN PROGRESS  S22029
         BNO   TCFUNCT                  NO - CHK TCAM FUNCTIONS  S22029
         TM    QCBTSOF1,QCBDELAY        IS QCB ON DELAY QUEUE    S22029
         BNO   CHKTJID                  CHECK FOR NON-ZERO TJID  S22029
*    QCB TSSES WILL BE ON WHEN TJID IS ZERO ONLY FOR THE LAST    S22029
*    PASS THROUGH THE SEND SCHEDULER WHEN A TSO SESSION ENDS     S22029
         CLC   AVTFZERO(2),QCBLINK+1    CHECK SAVED TJID         S22029
         BE    RESETSES                 ZERO TJID GO RESET TSSES S22029
         B     AYZ510                   CONTINUE TSO PROCESSING  S22029
CHKTJID  CLC   AVTFZERO(2),QCBTJID      IS IT A ZERO TJID        S22029
         BNE   AYZ510                   CONTINUE TSO PROCESSING  S22029
RESETSES NI    QCBFLAG,X'FF'-QCBTSSES   RESET TSO SESSION FLAG   S22029
         TM    LCBSTAT1,LCBOCWTN        STOPLINE IN PROGRESS   @OY14092
         BZ    RETSCHD                  NO                     @OY14092
         SR    R5,R5                    CLEAR REG              @OY14092
         IC    R5,LCBUCBX               PICK UP RLN-1          @OY14092
         SLL   R5,2                     MULTIPLY BY FOUR       @OY14092
         L     R5,DCBINVLI(R5)          GET ADDR INVLIST       @OY14092
         SR    RETURN,RETURN            CLEAR REG              @OY14092
         IC    RETURN,1(R5)             ACTIVE ENTRIES         @OY14092
         LTR   RETURN,RETURN            ANY ACTIVE ENTRIES?    @OY14092
         BZ    RETSCHD                  NO                     @OY14092
         LA    R8,7(R5)                 PT TO 1ST ENTRY-1      @OY14092
NEXTONE  EQU   *                                               @OY14092
         SR    R1,R1                    CLEAR REG              @OY14092
         IC    R1,2(R5)                 SIZE OF ENTRY          @OY14092
         AR    R8,R1                    PT TO INDEX BYTE       @OY14092
         SR    R0,R0                    CLEAR REG              @OY14092
         IC    R0,0(R8)                 PICK UP INDEX BYTE     @OY14092
         SLL   R0,1                     MULTIPLY BY 2          @OY14092
         LR    R1,R5                    SET PTR TO INV LIST    @OY14092
         SR    R1,R0                    BACK UP TO TNT INDEX   @OY14092
         LH    R1,0(R1)                 PICK UP TNT INDEX      @OY14092
         L     R15,AVTRNMPT             TERMNAME LOOKUP        @OY14092
         BALR  R14,R15                  GO TO TNT LOOKUP       @OY14092
         L     R1,TRMDESTQ-IEDQTRM-1(R1) PICK UP QCB           @OY14092
         TM    QCBFLAG-IEDQQCB(R1),QCBTSSES IS TSO SESSION     @OY14092
*                                           IN PROGRESS?       @OY14092
         BNZ   RETSCHD                  YES EXIT               @OY14092
         BCT   RETURN,NEXTONE           DECREMENT ACTIVE CNT   @OY14092
         NI    LCBSTAT1,AVTEFF-LCBOCWTN TURN OFF BIT           @OY14092
         OI    LCBSTAT1,LCBOCNI         SET NON-IMMEDIATE BIT  @OY14092
RETSCHD  EQU   *                                               @OY14092
         B     0(R2)                    DELAY SENDING TCAM MSGS  S22029
TCFUNCT  EQU   *                        CHECK FOR TCAM FUNCTIONS S22029
         TM    QCBDSFLG,QCBDISK+QCBCORE ANY NON-TSO FUNCTIONS?
         BZ    0(R2)                    PUT SEND SCH BACK IN QCB S22029
         L     RDCB,LCBDCBPT            PICKUP MHANDLER THIS     S22029
         LR    R8,RQCB                  DEST QCB FOR TESTING     S22029
         TM    LCBSTAT2,LCBDIAL         IS IT A DIAL LINE        S22029
         BZ    AYZ506                   NO - DONOT CHK LINE ENTRYS22029
         LH    RTRM,LCBLNENT            GET LINE ENTRY INDEX     S22029
         N     RTRM,AVTCLRHI            IS THERE A TERM OFFSET  SA59184
         BZ    AYZ506                   NO, BRANCH              SA59184
         L     R15,AVTRNMPT             GET ADDR OF TNT CODE     S22029
         BALR  R14,R15                  BRANCH TO ROUTINE        S22029
         L     R8,TRMDESTQ-1            GET LINE ENTRY QCB       S22029
AYZ506   EQU   *                                                 S22029
         L     R14,DCBMH-1              GET OWNING MH QCB        S22029
         USING CURMHQCB,R14             SMH QCB ADDRESSABILITY   S22029
         TM    QCBDSFLG-IEDQQCB(R8),QCBALTMH                     S22029
*                                       IS TERMINAL CONNECTED TO S22029
*                                       OWNING MSG HANDLER       S22029
         BZ    CHKTCAM                  YES. CHECK FOR TCAM MH   S22029
         L     R14,CURMHALT-1           PICKUP ALTERNATE MH      S22029
CHKTCAM  EQU   *                                                 S22029
         TM    CURMHFG2,CURMHTS         IS TERMINAL CURRENTLY    S22029
*                                       CONNECTED TO A TCAM MH?  S22029
         BO    0(R2)                    NO. DELAY SEND OPERATION S22029
*                                       UNTIL TERMINAL IS CONN-  S22029
*                                       ECTED TO A TCAM MH.      S22029
         B     8(R2)                    YES. BEGIN SENDING.      S22029
AYZ510   EQU   *
         TM    QCBTSOF1,QCBDISC         ARE WE LOGGING OFF
         BO    AYZ511                   BRANCH IF YES
         TM    QCBTSOF2,QCBDSSMI        START MI ON SCREEN
         BNO   AYZ512                   BRANCH ON NO
         LR    R2,RQCB                  SAVE REG 7               S22028
         LR    R1,RLCB                  ELEMENT IN REG ONE     @SA71937
         LR    RQCB,RLCB                FOR UNAVAIL
         BAL   R14,DSPBYPAS             RETURN TO DISPATCHER   @G36XRYP
AYZ511   EQU   *
         TM    QCBTSOF1,QCBSATRD        SIMATTN?               @OZ28271
         BZ    AYZ511A                  NO                     @OZ28271
         MVI   QCBSATCT,ZERO            ZERO LINE COUNT        @OZ28271
         MVI   QCBCARCT,ZERO            ZERO CARRIAGE COUNT    @OZ28271
AYZ511A  EQU   *                                               @OZ28271
         NI    QCBTSOF1,X'FF'-QCBSATRD  RESET SIATTN
         NI    QCBTSOF2,X'FF'-QCBSIMRD       READ INDICATORS
AYZ512   EQU   *
         CLI   LCBTSTSW,AVTEFF          IS SWITCH SET
         BNE   AYZ505                   BRANCH ON NO
         MVI   LCBTSTSW,X'F0'           INSURE CONNECTION FOR SEND
AYZ505   EQU   *
         L     RDCB,LCBDCBPT            GET DCB
         TM    LCBTSOB,LCBPREP          IS LINE BEING MONITORED?
         BO    AYZ060                   BRANCH ON YES
         TM    QCBTSOF1,QCBSATRD        SIMULATED ATTENTION READ?
         BO    AYZ520                   BRANCH ON YES
         TM    QCBTSOF1,QCBWRBRK        WAS A WRITE READ REQUESTED @11C
         BZ    AYZ515                   BRANCH ON NO
         NI    QCBFLAG,X'FF'-QCBREAD    TURN OFF READ PRIORITY BIT
AYZ514   EQU   *                                                SA56332
         TM    QCBTSOF1,QCBDELAY        IS QCB ON DELAY Q        A56332
         BC    EIGHT,FOUR(R2)           IF NOT RTN TO SEND       A56332
         LR    RECB,RQCB                ADDRESS OF QCB ELEMENT   A56332
         L     R15,AVTHG02              TIME DELAY REMOVAL       A56332
         BALR  R14,R15                  REMOVE FROM DELAY        A56332
         NI    QCBTSOF1,NOT-QCBDELAY    INDICATE NOT ON DELAY    A56332
         B    4(R2)                     RETURN TO START SEND
AYZ515   EQU   *
         TM    QCBFLAG,QCBREAD          READ HAVE PRIORITY?
         BO    AYZ520                   BRANCH ON YES
         TM    QCBTSOF1,QCBTPUT         ANY OUTPUT?
         BO    AYZ514                   BR YES TO START SEND    SA56332
         BR    R2                       PUT SEND SCH BACK IN QCB
         SPACE 2
*        A READ OF A PARTIAL INPUT LINE HAS PRIORITY OVER OUTPUT.
         SPACE
AYZ520   EQU   *
         TM    LCBINSRC+2,QCBDELAY      IS LCB IN THE DELAY QUEUE?
         BZ    AYZ530                   BRANCH ON NO
         LR    RECB,RLCB                SEND ADDR OF LCB TO BE REMOVED
         LR    R12,R15                 SAVE REGISTER 15
         L     R15,AVTHG02             ADDR OF TIME DELAY REMOVAL RTN
         BALR  R14,R15                  REMOVE LCB FROM DELAY Q.
         LR    R15,R12                 RESTORE REGISTER 15
         LR    R2,RQCB                  SAVE REG 7
         LA    RQCB,LCBRSKEY            LINK REC SCHED INTO STCB CHAIN
         LR    RTRM,RQCB
         BAL   R14,DSPPRIOR             DISPATCHER WILL DO LINK
         LR    RQCB,R2                  RESTORE REG 7
AYZ530   EQU   *
         TM    QCBTSOF2,QCBDSSMI        START MI ON SCREEN       S22028
         BO    AYZ530B                  YES, BRANCH              S22028
         BAL   R2,GETTSB                GO FIND TSB            @ZA01117
*                                       WITH TSB ADDRESS IN R5   Y02027
         LH    R14,TSBASRCE-TSB(R5)     LOAD TERM INDEX
         SR    R9,R9                    CLEAR REGISTER
         IC    R9,LCBUCBX               RLN-1
         SLL   R9,2                     MULTIPLY BY FOUR
         L     R5,DCBINVLI(R9)          INVITATION LIST ADDR
         LR    R12,R5                   SAVE ADDR
         LA    R12,8(R12)               FIRST ACTIVE ENTRY
AYZ530A  EQU   *
         TM    LCBSTAT2,LCBSYNC         IS THIS A BSC DEVICE     S22028
         BZ    AYZ530D                  NO, BRANCH               S22028
         CLI   1(R12),X'FE'             END OF INVITATION LIST   S22028
         BNE   AYZ530E                  NO, BRANCH               S22028
         LA    R12,1(R12)               INCREMENT PAST EOT CHAR  S22028
         B     AYZ530B                  BRANCH                   S22028
AYZ530D  EQU   *                                                 S22028
         CLI   0(R12),X'FE'             END OF LIST
         BE    AYZ530B                  BRANCH IF YES
AYZ530E  EQU   *                                                 S22028
         LR    R15,R12                  SAVE CURRENT ENTRY ADDR
         SR    R2,R2                    CLEAR REGISTER
         IC    R2,2(R5)                 GET SIZE OF LIST ENTRY
         BCTR  R2,0                     REDUCE BY ONE
         LA    R12,0(R12,R2)            ADDR OF INDEX BYTE
         IC    R2,0(R12)                PICK UP INDEX
         SLL   R2,1                     MULTIPLY BY TWO
         LR    R9,R5                    INVITATION LIST ADDR
         SR    R9,R2                    POINT TO TERM INDEX
         LH    R9,0(R9)                 LOAD TERM INDEX
         LA    R12,1(R12)               POINT TO NEXT ENTRY
         CR    R9,R14                   TERM INDEX EQUAL
         BNE   AYZ530A                  BRANCH IF NO
         STCM  R15,ADDR,LCBINVPT        UPDATE INVITATION LIST   X02004
*                                       ADDRESS.                 X02004
AYZ530B  EQU   *
         LA    RETURN,LCBRSKEY          ACTIVATE RECEIVE SCHEDULER
         LR    RTRM,RLCB                ADDRESS OF ELEMENT
         LR    RQCB,RLCB                ADDRESS OF QCB
         BAL   R14,DSPBYPAS             ACTIVATE NEXT SUBTASK  @G36XRYP
         SPACE 2
*        THIS CODE IS EXECUTED ON ENTRY FROM ACTIVATE BEFORE
*        BUILDING AN INPUT OR OUTPUT CHANNEL PROGRAM WHEN TSO IS IN
*        THE SYSTEM.
         SPACE
*  PLEASE NOTE DIFFERENT BASE REGS FOR LCB AND DCB DSECTS.       A52506
         DROP  RLCB                                              A52506
         DROP  RDCB                                              A52506
         USING IEDQLCB,R2               ACTIVATE LCB BASE        A52506
         USING IHADCB,RLCB              ACTIVATE DCB BASE        A52506
AYZ600   EQU   *
         TM    LCBSTAT2,LCBDIAL         IS THIS A DIAL LINE      A52506
         BZ    AYZ691                   NO, BRANCH
         LH    RTRM,LCBLNENT            GET LINE ENTRY FOR DIAL  A52506
         B     AYZ692                   GET TERM ENTRY           S21903
AYZ691   EQU   *
         LH    RTRM,LCBTTBIN            TO BE CONN. INDEX FOR LSD 52506
AYZ692   EQU   *
         LR    RQCB,R15                 SAVE REGISTER 15
         L     R15,AVTRNMPT             ADDRESS OF TERM NAME TABLE
         BALR  RSCB,R15                 GET TERM ENTRY ADDRESS
         LR    R15,RQCB                 RESTORE REGISTER 15
         L     RSCB,LCBSCBA-1           GET SCB ADDRESS          A52506
         L     RQCB,TRMDESTQ-1          GET ADDRESS OF DESTINATION QCB
         TM    QCBFLAG,QCBTSSES         IS THIS A TSO SESSION?
         BCR   8,RETURN                 BRANCH ON NO TO RETURN
         TM    LCBSTAT1,LCBRECVN        IS LINE RECEIVING        A52506
         BCR   8,RETURN                 BRANCH ON NO TO RETURN
         TM    LCBSTAT2,LCBMSGNN        IS IT FOR MSGGEN         A52506
         BCR   1,RETURN                 BRANCH ON YES TO RETURN
         TM    QCBFLAG,QCBREAD          READ HAVE PRIORITY?
         BCR   1,RETURN                 RETURN ON YES
         TM    QCBTSOF1,QCBSATRD        SIM ATTN READ IN PROGRS@SA73152
         BOR   RETURN                   YES - BRANCH           @SA73152
         TM    QCBFLAG,QCBNOBRK         IS IT A BREAK TERMINAL @SA73152
         BZ    BREAK                    YES-SEE BREAK REQUESTED@SA73152
         TM    QCBTSOF1,QCBTGET         WAS A TGET ISSUED      @SA73152
         BOR   RETURN                   YES - BRANCH           @SA73152
BREAK    EQU   *                                               @SA73152
         TM    QCBTSOF1,QCBTPUT         WAS A TPUT ISSUED      @SA73152
         BZR   RETURN                   NO - BRANCH            @SA73152
         NI    QCBTSOF2,AVTEFF-QCBDSSMI TURN OFF SMI           @SA76279
         L     R12,AVTMSGS-1            GET ADDR OF BD         @YA10969
         MVC   LCBQCBA,1(R12)                                  @YA10969
         MVI   LCBPRI,PRILCB            PRIORITY FOR CLEANUP   @YA10969
         LR    RTRM,R2                  POST LCB               @YA10969
         BAL   R14,DSPPOST                                     @G36XRYP
         EJECT
CURMHQCB DSECT                                                   S22029
         SPACE 2                                                 S22029
CURMHFG1 DS    AL1                      FLAG BYTE - UNUSED       S22029
CURMHALT DS    AL3                      ADDR OF ALTERNATE MH     S22029
CURMHFG2 DS    AL1                      FLAG BYTE                S22029
*        BIT DEFINITIONS                                         S22029
CURMHTS  EQU   X'01'                    INDICATES A TIME-SHARING S22029
*                                       MESSAGE HANDLER          S22029
CURMHLEX DS    AL3                      EXIT ADDRESS OF LOGON    S22029
*                                       MACRO IN THIS MH         S22029
CURMHLEN DS    AL1                      LENGTH OF STARTMH QCB    S22029
         SPACE 3                                                 S22029
         TTRMD
         EJECT
         TAVTD
         TTSID
         TSCBD
         TSTCBD                                                    @P1A
         TLCBD
         TQCBD
         TPRFD
         DCBD  DSORG=TX
         TDCTD
         TDISPD
         TPRIOR
CVT      CVT
         IKJTSB
CVTTSCVT EQU   CVTRMS+4                 ******  FOR TESTING***** MVMTST
CVTMAP   EQU   CVT                      TEST                     MVMTST
         IHAASCB                                                 Y02027
         SPACE 2
         IHAASVT                                                 Y02027
         SPACE 2
         TTCXD                                                   Y02027
         SPACE 3
         END

         TITLE '** IEAVCKEY-VS2/SU7 CHANGE STORAGE PROTECT KEY ROUTINE *
                **      '
IEAVCKEY CSECT ,                                                   0001
@MAINENT DS    0H                                                  0001
         USING *,@15                                               0001
         B     @PROLOG                                             0001
         DC    AL2(@EP00001-@MAINENT)
         DC    AL1(16)                                             0001
         DC    C'IEAVCKEY  76.239'                                 0001
CKEYRTRY DS    0H                                                  0001
         USING *,@15                                               0001
         B     @PROLOG                                             0001
         DC    AL2(@EP00241-CKEYRTRY)
         ENTRY CKEYRTRY
         DROP  @15
@PROLOG  AH    @15,4(,@15)                                         0001
         BR    @15                                                 0001
@EP00001 DS    0H                                                  0002
*                                     /*ENTRY LINKAGE
         USING PSA,0                  ADDRESS LOW STORAGE
         L     @15,PSAAOLD            ADDRESS
         USING ASCB,@15                 CURRENT ASCB
         L     @15,ASCBLDA            ADDRESS
         USING LDA,@15                  LDA
         LA    @15,CFAPWKAR           TEMP ADDRESSABILITY
         USING @DATD,@15                FOR WORK/SAVE AREA
*
*        THE 75-WORD AREA, CFAPWKAR, IN THE LDA IS USED AS A WORK/SAVE
*        AREA TO ACHIEVE REENTRANT ATTRIBUTE.
*
         STM   @00,@14,SAVEREGS       SAVE CALLER'S REGS
*
*        IF THE CALLING PGM IS NOT PSW KEY 0, A PGM CHECK WILL RESULT
*        FROM EXECUTION OF THIS INSTRUCTION.
*
         DROP  @15
         LR    @09,@15                DATAREG
         USING @DATD,@09              ADDRESS WORK/SAVE AREA
         BALR  @10,0                  CODEREG
         USING *,@10                  ADDRESSABILITY FOR MODULE
FRRON   SETFRR A,FRRAD=CKFRR,PARMAD=PARMPTR,WRKREGS=(REG03,REG04),    --
               RELATED=(FRR,CKEY(FRROFF,FRROFF2))
*   CKEYBASE=REG10;                 /* INITIALIZE FRR PARM AREA      */
         L     @12,PARMPTR                                         0042
         ST    REG10,CKEYBASE(,@12)                                0042
*   IF REQUEST=LTYPE THEN           /* DETERMINE INTERFACE USED      */
         CLI   REQUEST,128                                         0043
         BNE   @RF00043                                            0043
*     CALL LISTPROC;                /* PROCESS L-TYPE REQUESTS       */
         BAL   @14,LISTPROC                                        0044
*   ELSE                                                           0045
*     CALL REGPROC;                 /* PROCESS R-TYPE REQUESTS       */
         B     @RC00043                                            0045
@RF00043 BAL   @14,REGPROC                                         0045
*   GEN SETS(REG03,REG04);                                         0046
@RC00043 DS    0H                                                  0046
*                       /*
FRROFF   SETFRR D,WRKREGS=(REG03,REG04),RELATED=(FRR,CKEY(FRRON))
*   IF RETCODE^=0 THEN              /* TEST RETURN CODE              */
         LTR   RETCODE,RETCODE                                     0047
         BZ    @RF00047                                            0047
*     DO;                           /* ABEND(O8F) SYSTEM             */
*       RESPECIFY                                                  0049
*        (GPR01F) RESTRICTED;                                      0049
*       GPR01F=((O8F)&'00000FFF'X)*4096;/* COMP CODE IN BITS 8-19    */
         LA    GPR01F,143                                          0050
         N     GPR01F,@CF01514                                     0050
         SLA   GPR01F,12                                           0050
*       SVC(13);                    /* ISSUE ABEND SVC               */
         SVC   13                                                  0051
*       RESPECIFY                                                  0052
*        (GPR01F) UNRESTRICTED;                                    0052
*     END;                          /* ABEND(O8F) SYSTEM NOT ZERO: 0053
*                                      CHANGE KEY FAILED             */
*   REG00=OLDKEYFP;                 /* ZERO: CHANGE KEY SUCCESSFUL.
*                                      RETURN ORIGINAL STORAGE KEY   */
@RF00047 SLR   REG00,REG00                                         0054
         IC    REG00,OLDKEYFP                                      0054
*   GEN REFS(SAVEREGS);                                            0055
*                             /*
         LM    @01,@14,INR1           RESTORE CALLER'S REGS
*   RETURN;                         /* RETURN TO CALLING PGM         */
@EL00001 DS    0H                                                  0056
@EF00001 DS    0H                                                  0056
@ER00001 BR    @14                                                 0056
*                                                                  0057
*   /*****************************************************************/
*   /*                                                               */
*   /* ROUTINE TO PROCESS R-TYPE REQUESTS                            */
*   /*                                                               */
*   /*****************************************************************/
*                                                                  0057
*REGPROC:                                                          0057
*   PROC OPTIONS(NOSAVE);                                          0057
REGPROC  DS    0H                                                  0058
*   RETAD1=REG14;                   /* SAVE RETURN ADDRESS           */
         ST    REG14,RETAD1                                        0058
*   FLAGS=0;                        /* INTERNAL INDICATORS OFF       */
         MVI   FLAGS,X'00'                                         0059
*   ELTAD=ADDR(INR1);               /* ONE VA RANGE GIVEN BY INPUT R1
*                                      AND R2                        */
*                                                                  0060
         LA    @12,INR1                                            0060
         ST    @12,ELTAD                                           0060
*   /*****************************************************************/
*   /*                                                               */
*   /* VALIDITY CHECK INPUT PARAMETERS: STORAGE DEFINED BY VA RANGE  */
*   /* MUST BE IN PROBLEM PROGRAM SUBPOOLS                           */
*   /*                                                               */
*   /*****************************************************************/
*                                                                  0061
*   CALL PAGEVCK;                   /* VALIDITY CHECK: STORAGE IN  0061
*                                      PROBLEM PROGRAM SUBPOOLS      */
         BAL   @14,PAGEVCK                                         0061
*   IF RETCODE=0 THEN               /* TEST RETURN CODE              */
         LTR   RETCODE,RETCODE                                     0062
         BNZ   @RF00062                                            0062
*     DO;                           /* RC ZERO: VA RANGE VALID       */
*       SAVEKEY=YES;                /* SAVE ORIGINAL KEY             */
         OI    SAVEKEY,B'10000000'                                 0064
*       GEN REFS(PSALITA,FLC) SETS(REG11,REG12,REG13);             0065
*                                                   /*OBTAIN SALLOC
LOCKON   SETLOCK OBTAIN,TYPE=SALLOC,MODE=UNCOND,                      --
               RELATED=(PAGES,CKEY(LOCKOFF))
*       LPC=NONE;                   /* NO KEY FOR ANY PAGE CHANGED   */
*                                                                  0066
         SLR   @12,@12                                             0066
         ST    @12,LPC                                             0066
*       /*************************************************************/
*       /*                                                           */
*       /* CHANGE STORAGE KEY: THE XPTPROT FIELD IN THE XPTE AND THE */
*       /* HARDWARE KEY FOR EACH PAGE IS CHANGED                     */
*       /*                                                           */
*       /*************************************************************/
*                                                                  0067
*       CALL ELTPROC;               /* CHANGE STORAGE KEY FOR RANGE  */
         BAL   @14,ELTPROC                                         0067
*       IF RETCODE^=0 THEN          /* TEST RETURN CODE              */
         LTR   RETCODE,RETCODE                                     0068
         BZ    @RF00068                                            0068
*         CALL RECOVER;             /* RC NOT ZERO: CHANGE         0069
*                                      INCOMPLETE, RESTORE ORIGINAL
*                                      KEY                           */
         BAL   @14,RECOVER                                         0069
*       ELSE                                                       0070
*         ;                         /* RC ZERO: KEY CHANGED          */
@RF00068 DS    0H                                                  0071
*       GEN REFS(PSALITA,FLC) SETS(REG11,REG12,REG13);             0071
*                                                  /*RELEASE SALLOC
LOCKOFF  SETLOCK RELEASE,TYPE=SALLOC,                                 --
               RELATED=(PAGES,CKEY(LOCKON))
*     END;                                                         0072
*   ELSE                                                           0073
*     ;                             /* RC NOT ZERO: VA RANGE INVALID
*                                      , KEY NOT CHANGED             */
@RF00062 DS    0H                                                  0074
*   REG14=RETAD1;                   /* RESTORE RETURN ADDRESS        */
         L     REG14,RETAD1                                        0074
*   RETURN CODE(RETCODE);           /* RETURN TO TOP ROUTINE         */
@EL00002 DS    0H                                                  0075
@EF00002 DS    0H                                                  0075
@ER00002 BR    @14                                                 0075
*   END REGPROC;                                                   0076
*                                                                  0077
*   /*****************************************************************/
*   /*                                                               */
*   /* ROUTINE TO PROCESS L-TYPE REQUESTS                            */
*   /*                                                               */
*   /*****************************************************************/
*                                                                  0077
*LISTPROC:                                                         0077
*   PROC OPTIONS(NOSAVE);                                          0077
LISTPROC DS    0H                                                  0078
*   RETAD1=REG14;                   /* SAVE RETURN ADDRESS           */
         ST    REG14,RETAD1                                        0078
*   FLAGS=0;                        /* INTERNAL INDICATORS OFF       */
         MVI   FLAGS,X'00'                                         0079
*   LPC=NONE;                       /* NO KEY FOR ANY PAGE CHANGED   */
         SLR   @12,@12                                             0080
         ST    @12,LPC                                             0080
*   ELTAD=INR1-LENGTH(LISTELT);     /* ADDRESS-8 OF FIRST ELEMENT IN
*                                      LIST                          */
         L     @12,INR1                                            0081
         SL    @12,@CF00068                                        0081
         ST    @12,ELTAD                                           0081
*   GEN REFS(PSALITA,FLC) SETS(REG11,REG12,REG13);                 0082
*                                                                  0082
*                                                   /*OBTAIN SALLOC
LOCKON2  SETLOCK OBTAIN,TYPE=SALLOC,MODE=UNCOND,                      --
               RELATED=(PAGES,CKEY(LOCKOFF2))
*   /*****************************************************************/
*   /*                                                               */
*   /* VALIDITY CHECK INPUT PARAMETERS: PARAMETER LIST MUST BE IN    */
*   /* FIXED STORAGE. STORAGE DEFINED BY EACH ELEMENT IN LIST MUST BE*/
*   /* IN PROBLEM PROGRAM SUBPOOLS                                   */
*   /*                                                               */
*   /*****************************************************************/
*                                                                  0083
*   DO UNTIL(ERROR=YES×LASTELT=YES);/* CHECK EACH ELT IN LIST OR   0083
*                                      UNTIL ERROR IS DETECTED       */
@DL00083 DS    0H                                                  0084
*     ELTAD=ELTAD+LENGTH(LISTELT);  /* LIST ELEMENT ADDRESS          */
         LA    @12,8                                               0084
         AL    @12,ELTAD                                           0084
         ST    @12,ELTAD                                           0084
*     CALL ELTVCK;                  /* VALIDITY CHECK: ELT IN FIXED
*                                      STORAGE                       */
         BAL   @14,ELTVCK                                          0085
*     IF RETCODE=0 THEN             /* TEST RETURN CODE              */
         LTR   RETCODE,RETCODE                                     0086
         BNZ   @RF00086                                            0086
*       DO;                         /* RC ZERO: ELEMENT VALID        */
*         CALL PAGEVCK;             /* VALIDITY CHECK: VA RANGE IN 0088
*                                      PROBLEM PGM SUBPOOLS          */
         BAL   @14,PAGEVCK                                         0088
*         IF RETCODE^=0 THEN        /* TEST RETURN CODE              */
         LTR   RETCODE,RETCODE                                     0089
         BZ    @RF00089                                            0089
*           ERROR=YES;              /* RC NOT ZERO: RANGE INVALID    */
         OI    ERROR,B'01000000'                                   0090
*         ELSE                                                     0091
*           ;                       /* RC ZERO:RANGE VALID           */
@RF00089 DS    0H                                                  0092
*       END;                                                       0092
*     ELSE                          /* RC NOT ZERO: ELT INVALID      */
*       ERROR=YES;                  /* INDICATE ERROR CONDITION      */
         B     @RC00086                                            0093
@RF00086 OI    ERROR,B'01000000'                                   0093
*   END;                                                           0094
*                                                                  0094
@RC00086 DS    0H                                                  0094
@DE00083 TM    ERROR,B'01000000'                                   0094
         BO    @DC00083                                            0094
         L     @12,ELTAD                                           0094
         TM    LASTELT(@12),B'10000000'                            0094
         BNO   @DL00083                                            0094
@DC00083 DS    0H                                                  0095
*   /*****************************************************************/
*   /*                                                               */
*   /* CHANGE STORAGE KEY: THE FIELD XPTPROT IN THE XPTE AND THE     */
*   /* HARDWARE KEY FOR EACH PAGE IS CHANGED                         */
*   /*                                                               */
*   /*****************************************************************/
*                                                                  0095
*   IF ERROR=NO THEN                /* WAS AN ERROR DETECTED ?       */
         TM    ERROR,B'01000000'                                   0095
         BNZ   @RF00095                                            0095
*     DO;                           /* NO: CONTINUE KEY PROCESSING   */
*       ELTAD=INR1-LENGTH(LISTELT); /* ADDRESS-8 OF FIRST ELT IN LIST*/
         L     @12,INR1                                            0097
         SL    @12,@CF00068                                        0097
         ST    @12,ELTAD                                           0097
*       SAVEKEY=YES;                /* SAVE ORIGINAL KEY             */
         OI    SAVEKEY,B'10000000'                                 0098
*       DO UNTIL(LASTELT=YES×ERROR=YES);/* CHANGE KEY OF ALL RANGES
*                                      OR UNTIL ERROR IS DETECTED    */
@DL00099 DS    0H                                                  0100
*         ELTAD=ELTAD+LENGTH(LISTELT);/* LIST ELEMENT ADDRESS        */
         LA    @12,8                                               0100
         AL    @12,ELTAD                                           0100
         ST    @12,ELTAD                                           0100
*         CALL ELTPROC;             /* CHANGE KEY OF SINGLE RANGE    */
         BAL   @14,ELTPROC                                         0101
*         IF RETCODE^=0 THEN        /* TEST RETURN CODE              */
         LTR   RETCODE,RETCODE                                     0102
         BZ    @RF00102                                            0102
*           DO;                                                    0103
*             ERROR=YES;            /* INDICATE ERROR CONDITION      */
         OI    ERROR,B'01000000'                                   0104
*             CALL RECOVER;         /* RESTORE ORIGINAL KEY          */
         BAL   @14,RECOVER                                         0105
*           END;                                                   0106
*         ELSE                                                     0107
*           ;                       /* RC ZERO: KEY CHANGED          */
@RF00102 DS    0H                                                  0108
*       END;                                                       0108
@DE00099 L     @12,ELTAD                                           0108
         TM    LASTELT(@12),B'10000000'                            0108
         BO    @DC00099                                            0108
         TM    ERROR,B'01000000'                                   0108
         BNO   @DL00099                                            0108
@DC00099 DS    0H                                                  0109
*     END;                                                         0109
*   ELSE                                                           0110
*     ;                             /* YES: KEY UNCHANGED            */
@RF00095 DS    0H                                                  0111
*   GEN REFS(PSALITA,FLC) SETS(REG11,REG12,REG13);                 0111
*                                                /*RELEASE SALLOC
LOCKOFF2 SETLOCK RELEASE,TYPE=SALLOC,                                 --
               RELATED=(PAGES,CKEY(LOCKON2))
*   REG14=RETAD1;                   /* RESTORE RETURN ADDRESS        */
         L     REG14,RETAD1                                        0112
*   RETURN CODE(RETCODE);           /* RETURN TO TOP ROUTINE         */
@EL00003 DS    0H                                                  0113
@EF00003 DS    0H                                                  0113
@ER00003 BR    @14                                                 0113
*   END LISTPROC;                                                  0114
*                                                                  0115
*   /*****************************************************************/
*   /*                                                               */
*   /* ROUTINE TO CHANGE THE KEY OF THE STORAGE AREA DEFINED BY ONE  */
*   /* VA RANGE                                                      */
*   /*                                                               */
*   /*****************************************************************/
*                                                                  0115
*ELTPROC:                                                          0115
*   PROC OPTIONS(NOSAVE);                                          0115
ELTPROC  DS    0H                                                  0116
*   RETAD2=REG14;                   /* SAVE RETURN ADDRESS           */
         ST    REG14,RETAD2                                        0116
*   PGAD=FPA;                       /* FIRST PAGE PROCESSED          */
*                                                                  0117
         L     @12,ELTAD                                           0117
         L     @12,FPA-1(,@12)                                     0117
         LA    @12,0(,@12)                                         0117
         ST    @12,PGAD                                            0117
*   /*****************************************************************/
*   /*                                                               */
*   /* STORAGE KEY CHANGED BY CHANGING THE PROTECT KEY FOR EACH PAGE */
*   /* IN THE VA RANGE. PROCESSING IS NOT COMPLETED IF A PAGE IN THE */
*   /* VA RANGE IS FOUND THAT HAS NOT BEEN GETMAINED.                */
*   /*                                                               */
*   /*****************************************************************/
*                                                                  0118
*NEWSEG:                            /* REPEATED FOR EACH PAGE IN A 0118
*                                      NEW SEGMENT                   */
*   RESPECIFY                                                      0118
*    (REG01,                                                       0118
*     REG02,                                                       0118
*     REG03) RSTD;                  /* REGS USED BY FINDPAGE         */
NEWSEG   DS    0H                                                  0119
*   REG01=PGAD;                     /* PAGE ADDRESS                  */
         L     REG01,PGAD                                          0119
*   REG02=RSMHDPTR;                 /* RSMHD ADDRESS                 */
         L     @12,ASCBPTR                                         0120
         L     REG02,RSMHDPTR(,@12)                                0120
*   REG03=PVTPTR;                   /* PVT ADDRESS                   */
         L     @12,CVTPTR                                          0121
         L     @12,PVTPTR(,@12)                                    0121
         LR    REG03,@12                                           0121
*   CALL IEAVFP2;                   /* GET PGTE,XPTE FOR PAGE        */
         L     @15,PVTPFP2(,@12)                                   0122
         BALR  @14,@15                                             0122
*   PTEPTR=REG00;                   /* ADDRESS PGTE                  */
         ST    REG00,PTEPTR                                        0123
*   XPTEPTR=REG01;                  /* ADDRESS XPTE                  */
         ST    REG01,XPTEPTR                                       0124
*   RESPECIFY                                                      0125
*    (REG01,                                                       0125
*     REG02,                                                       0125
*     REG03) UNRSTD;                                               0125
*   IF RETCODE=0 THEN               /* TEST RETURN CODE              */
         LTR   RETCODE,RETCODE                                     0126
         BNZ   @RF00126                                            0126
*SAMESEG:                                                          0127
*     DO;                           /* RC ZERO: PGTE,XPTE FOUND.   0127
*                                      REPEATED FOR EACH PAGE IN THE
*                                      SAME SEGMENT.                 */
SAMESEG  DS    0H                                                  0128
*       IF PGTPAM=YES THEN          /* PAGE GM ASSIGNED ?            */
         L     @12,PTEPTR                                          0128
         TM    PGTPAM(@12),B'00000001'                             0128
         BNO   @RF00128                                            0128
*         DO;                       /* YES: KEY WILL BE CHANGED      */
*           IF SAVEKEY=YES THEN     /* SAVE KEY OF THIS PAGE ?       */
         TM    SAVEKEY,B'10000000'                                 0130
         BNO   @RF00130                                            0130
*             DO;                   /* YES: XPTPROT IS SAVED         */
*               OLDKEYFP=XPTPROT;   /* ORIGINAL STORAGE KEY          */
         L     @12,XPTEPTR                                         0132
         IC    @11,XPTPROT(,@12)                                   0132
         STC   @11,OLDKEYFP                                        0132
*               SAVEKEY=NO;         /* NO OTHER KEY IS SAVED         */
         NI    SAVEKEY,B'01111111'                                 0133
*             END;                                                 0134
*           ELSE                                                   0135
*             ;                     /* NO: CONTINUE                  */
@RF00130 DS    0H                                                  0136
*           LPC=PGAD;               /* PAGE ADDRESS BEING PROCESSED  */
         L     @12,PGAD                                            0136
         ST    @12,LPC                                             0136
*           CALL KEYCHG;            /* CHANGE KEY OF PAGE            */
         BAL   @14,KEYCHG                                          0137
*           PGAD=PGAD+C4K;          /* NEXT PAGE ADDRESS IN RANGE    */
         L     @12,@CF00106                                        0138
         AL    @12,PGAD                                            0138
         ST    @12,PGAD                                            0138
*           COND1=NO;                                              0139
*           COND2=NO;                                              0140
         NI    COND1,B'11001111'                                   0140
*           IF PGAD<=LPA THEN       /* ALL PAGES PROCESSED ?         */
         L     @11,ELTAD                                           0141
         L     @11,LPA-1(,@11)                                     0141
         LA    @11,0(,@11)                                         0141
         CR    @12,@11                                             0141
         BH    @RF00141                                            0141
*             DO;                   /* NO: CONTINUE WITH NEXT PAGE   */
*               COND1=YES;          /* INDICATE PAGE EXISTS          */
         OI    COND1,B'00100000'                                   0143
*               IF SEG^=NEW THEN    /* PAGE IN SAME SEGMENT ?        */
         TM    SEG,B'11110000'                                     0144
         BZ    @RF00144                                            0144
*                 DO;               /* YES: PGTE,XPTE BY INCREMENTING
*                                      DOWN TABLES                   */
*                   PTEPTR=PTEPTR+LENGTH(PGTPTE);/* NEXT PGTE ADDRESS*/
         LA    @12,2                                               0146
         AL    @12,PTEPTR                                          0146
         ST    @12,PTEPTR                                          0146
*                   XPTEPTR=XPTEPTR+LENGTH(XPTE);/* NEXT XPTE ADDRESS*/
         LA    @12,12                                              0147
         AL    @12,XPTEPTR                                         0147
         ST    @12,XPTEPTR                                         0147
*                   COND2=YES;      /* INDICATE SAME SEGMENT         */
         OI    COND2,B'00010000'                                   0148
*                 END;                                             0149
*               ELSE                                               0150
*                 ;                 /* NO: PGTE,XPTE BY FINDPAGE     */
@RF00144 DS    0H                                                  0151
*             END;                                                 0151
*           ELSE                                                   0152
*             ;                     /* YES: END PROCESSING           */
@RF00141 DS    0H                                                  0153
*         END;                                                     0153
*       ELSE                        /* NO: ERROR CONDITION           */
*         DO;                                                      0154
         B     @RC00128                                            0154
@RF00128 DS    0H                                                  0155
*           RETCODE=8;              /* IDENTIFY ERROR                */
         LA    RETCODE,8                                           0155
*           ERROR=YES;              /* INDICATE ERROR DETECTED       */
         OI    ERROR,B'01000000'                                   0156
*         END;                                                     0157
*     END;                                                         0158
*   ELSE                            /* RC NOT ZERO: NO PGTE,XPTE     */
*     DO;                                                          0159
         B     @RC00126                                            0159
@RF00126 DS    0H                                                  0160
*       RETCODE=16;                 /* IDENTIFY ERROR                */
         LA    RETCODE,16                                          0160
*       ERROR=YES;                  /* INDICATE ERROR DETECTED       */
         OI    ERROR,B'01000000'                                   0161
*     END;                                                         0162
*   IF COND2=YES&ERROR=NO THEN      /* SAME SEG AND NO ERROR ?       */
@RC00126 TM    COND2,B'00010000'                                   0163
         BNO   @RF00163                                            0163
         TM    ERROR,B'01000000'                                   0163
         BZ    @RT00163                                            0163
*     GOTO SAMESEG;                 /* YES: REPEAT SAMESEG           */
*   ELSE                                                           0165
*     ;                             /* NO: CONTINUE                  */
@RF00163 DS    0H                                                  0166
*   IF COND1=YES&ERROR=NO THEN      /* NEW SEG AND NO ERROR ?        */
         TM    COND1,B'00100000'                                   0166
         BNO   @RF00166                                            0166
         TM    ERROR,B'01000000'                                   0166
         BZ    @RT00166                                            0166
*     GOTO NEWSEG;                  /* YES: REPEAT NEWSEG            */
*   ELSE                                                           0168
*     ;                             /* NO: ALL PAGES ARE PROCESSED OR
*                                      ERROR HAS BEEN DETECTED       */
@RF00166 DS    0H                                                  0169
*   REG14=RETAD2;                   /* RESTORE RETURN ADDRESS        */
         L     REG14,RETAD2                                        0169
*   RETURN CODE(RETCODE);           /* RETURN TO CALLING ROUTINE     */
@EL00004 DS    0H                                                  0170
@EF00004 DS    0H                                                  0170
@ER00004 BR    @14                                                 0170
*   END ELTPROC;                                                   0171
*                                                                  0172
*   /*****************************************************************/
*   /*                                                               */
*   /* ROUTINE TO VERIFY THAT A PARAMETER LIST ELEMENT IS IN FIXED   */
*   /* STORAGE AT THE TIME IEAVCKEY WAS INVOKED.                     */
*   /*                                                               */
*   /*****************************************************************/
*                                                                  0172
*ELTVCK:                                                           0172
*   PROC OPTIONS(NOSAVE);                                          0172
ELTVCK   DS    0H                                                  0173
*   GEN REFS(ELTAD);                                               0173
*                 /*
*         ELEMENT IS IN REAL STORAGE IF THE FIRST AND LAST BYTE OF
*         THE ELEMENT ARE IN REAL STORAGE
         L     @15,ELTAD              ELEMENT VA
         LRA   @15,C0(@15)            FIRST BYTE IN REAL STORAGE ?
         BNZ   ERR12                  NO: ERROR CONDITION
         L     @15,ELTAD              YES: ELEMENT ENDING
         LA    @15,C7(@15)                 VIRTUAL ADDRESS
         LRA   @15,C0(@15)            LAST BYTE IN REAL STORAGE?
         BNZ   ERR12                  NO: ERROR CONDITION
         SR    @15,@15                YES: ELT IN FIXED STORAGE
         BR    @14                    RETURN TO LISTPROC
ERR12    LA    @15,12                 IDENTIFY ERROR
*   RETURN;                         /* RETURN TO LISTPROC            */
@EL00005 DS    0H                                                  0174
@EF00005 DS    0H                                                  0174
@ER00005 BR    @14                                                 0174
*   END ELTVCK;                                                    0175
*                                                                  0176
*   /*****************************************************************/
*   /*                                                               */
*   /* ROUTINE TO VERIFY STORAGE DEFINED BY A VA RANGE IS FROM       */
*   /* SUBPOOLS 0-127, 251, AND 252                                  */
*   /*                                                               */
*   /*****************************************************************/
*                                                                  0176
*PAGEVCK:                                                          0176
*   PROC OPTIONS(NOSAVE);                                          0176
PAGEVCK  DS    0H                                                  0177
*   IF FPA<=LPA THEN                /* WRAP AROUND NOT PERMITTED     */
         L     @12,ELTAD                                           0177
         CLC   FPA(3,@12),LPA(@12)                                 0177
         BH    @RF00177                                            0177
*     DO;                                                          0178
*       IF FPA>=PASTRT THEN         /* STORAGE ABOVE PRIVATE AREA  0179
*                                      START ?                       */
         L     @11,CVTPTR                                          0179
         L     @01,GDAPTR(,@11)                                    0179
         L     @11,FPA-1(,@12)                                     0179
         LA    @11,0(,@11)                                         0179
         C     @11,PASTRT(,@01)                                    0179
         BL    @RF00179                                            0179
*         DO;                       /* YES: CONTINUE                 */
*           IF LPA<CURRGNTP THEN    /* STORAGE BELOW CURRENT REGION
*                                      TOP ?                         */
         L     @11,ASCBPTR                                         0181
         L     @01,LDAPTR(,@11)                                    0181
         L     @12,LPA-1(,@12)                                     0181
         LA    @12,0(,@12)                                         0181
         C     @12,CURRGNTP(,@01)                                  0181
         BNL   @RF00181                                            0181
*             RETCODE=0;            /* YES: STORAGE RANGE VALID      */
         SLR   RETCODE,RETCODE                                     0182
*           ELSE                                                   0183
*             RETCODE=4;            /* NO: STORAGE RANGE INVALID     */
         B     @RC00181                                            0183
@RF00181 LA    RETCODE,4                                           0183
*         END;                                                     0184
*       ELSE                                                       0185
*         RETCODE=4;                /* NO: STORAGE RANGE INVALID     */
         B     @RC00179                                            0185
@RF00179 LA    RETCODE,4                                           0185
*     END;                                                         0186
*   ELSE                                                           0187
*     RETCODE=4;                                                   0187
         B     @RC00177                                            0187
@RF00177 LA    RETCODE,4                                           0187
*   RETURN CODE(RETCODE);           /* RETURN TO CALLING ROUTINE     */
@RC00177 DS    0H                                                  0188
@EL00006 DS    0H                                                  0188
@EF00006 DS    0H                                                  0188
@ER00006 BR    @14                                                 0188
*   END PAGEVCK;                                                   0189
*                                                                  0190
*   /*****************************************************************/
*   /*                                                               */
*   /* ROUTINE TO CHANGE PROTECT KEY AND FETCH PROTECT FLAG OF A     */
*   /* SINGLE PAGE-REFERENCE BIT IS PRESERVED-CHANGE BIT IS TURNED   */
*   /* ON- THIS IS DONE TO PREVENT ANOTHER CPU FROM TURING IT ON     */
*   /* WHILE THE KEY IS BEING CHANGED AND THUS LOSING THE CHANGE     */
*   /*                                                               */
*   /*****************************************************************/
*                                                                  0190
*KEYCHG:                                                           0190
*   PROC OPTIONS(NOSAVE);                                          0190
KEYCHG   DS    0H                                                  0191
*   XPTPROT=KEYANDFP;               /* CHANGE KEY IN XPTE            */
         L     @12,XPTEPTR                                         0191
         IC    @11,KEYANDFP                                        0191
         STC   @11,XPTPROT(,@12)                                   0191
*   XPTCKF=YES;                     /* INDICATE KEY FOR PAGE WAS   0192
*                                      CHANGED                       */
         OI    XPTCKF(@12),B'00100000'                             0192
*   GEN REFS(PGAD,RCBITS,INR1,CHANGBIT);                           0193
*                                    /*
*         CHANGE HARDWARE KEY IF PAGE IS ASSIGNED TO A FRAME IN REAL
*         STORAGE
         L     @15,PGAD               PAGE VA
         LRA   @15,C0(@15)            PAGE IN REAL STORAGE ?
         BNZ   CHGEND                 NO:ROUTINE COMPLETE
         ISK   @00,@15                YES: HDW KEY FOR PAGE
         N     @00,RCBITS             SAVE REFERENCE BIT      @ZA11388
         O     @00,CHANGBIT           TURN ON CHANGE BIT      @ZA11388
         O     @00,NEWKEY             APPEND BITS TO NEW KEY
         SSK   @00,@15                CHANGE HDW KEY OF FIRST 2K
         LA    @15,C2K(@15)           ADDRESS OF SECOND 2K
         ISK   @00,@15                HDW KEY FOR HALF PAGE
         N     @00,RCBITS             SAVE REFERENCE BIT      @ZA11388
         O     @00,CHANGBIT           TURN ON CHANGE BIT      @ZA11388
         O     @00,NEWKEY             APPEND BITS TO NEW KEY
         SSK   @00,@15                CHANGE HDW KEY OF SECOND 2K
CHGEND   EQU   *
*   RETURN CODE(0);                 /* RETURN TO CALLING ROUTINE     */
         SLR   @15,@15                                             0194
@EL00007 DS    0H                                                  0194
@EF00007 DS    0H                                                  0194
@ER00007 BR    @14                                                 0194
*   END KEYCHG;                                                    0195
*                                                                  0196
*   /*****************************************************************/
*   /*                                                               */
*   /* ROUTINE TO RESTORE THE ORIGINAL STORAGE KEY FOR ALL PAGES     */
*   /* WHOSE KEY HAS BEEN CHANGED. THE ROUTINE IS CALLED INTERNALLY  */
*   /* WHEN AN INVALID PAGE HAS BEEN DETECTED IN THE VA RANGE        */
*   /* REQUESTED DURING CHANGE KEY PROCESSING. IT IS ALSO A PART OF  */
*   /* RETRY PROCESSING REQUESTED BY THE FRR FOR UNEXPECTED ERRORS.  */
*   /*                                                               */
*   /*****************************************************************/
*                                                                  0196
*RECOVER:                                                          0196
*   PROC OPTIONS(NOSAVE);                                          0196
RECOVER  DS    0H                                                  0197
*   INRCV=YES;                      /* INDICATE ROUTINE ENTERED      */
         L     @12,PARMPTR                                         0197
         OI    INRCV(@12),B'10000000'                              0197
*   RETAD2=REG14;                   /* SAVE RETURN ADDRESS           */
         ST    REG14,RETAD2                                        0198
*   IF LPC^=NONE THEN               /* KEY FOR ANY PAGES CHANGED ?   */
         L     @12,LPC                                             0199
         LTR   @12,@12                                             0199
         BZ    @RF00199                                            0199
*     DO;                           /* YES: RESTORE KEY              */
*       RCSAVE=REG15;               /* SAVE RC OF CALLING ROUTINE    */
         ST    REG15,RCSAVE                                        0201
*       KEYANDFP=OLDKEYFP;          /* ORIGINAL STORAGE KEY          */
         IC    @12,OLDKEYFP                                        0202
         STC   @12,KEYANDFP                                        0202
*       IF REQUEST=LTYPE THEN       /* DETERMINE REQUEST TYPE        */
         CLI   REQUEST,128                                         0203
         BNE   @RF00203                                            0203
*         DO;                       /* L-TYPE REQUEST                */
*           ELTAD=INR1;             /* FIRST ELEMENT ADDRESS         */
         L     @12,INR1                                            0205
         ST    @12,ELTAD                                           0205
*           DO UNTIL(LPG=LPC);      /* KEY FOR EACH RANGE CHANGED IS
*                                      RESTORED                      */
@DL00206 DS    0H                                                  0207
*             IF FPA<=LPC&LPC<=LPA THEN/* LAST RANGE THAT KEY WAS  0207
*                                      CHANGED ?                     */
         L     @12,LPC                                             0207
         L     @11,ELTAD                                           0207
         L     @08,FPA-1(,@11)                                     0207
         LA    @08,0(,@08)                                         0207
         CR    @12,@08                                             0207
         BL    @RF00207                                            0207
         L     @11,LPA-1(,@11)                                     0207
         LA    @11,0(,@11)                                         0207
         CR    @12,@11                                             0207
         BH    @RF00207                                            0207
*               LPG=LPC;            /* YES: RANGE ENDS WITH LAST PAGE
*                                      WHOSE KEY WAS CHANGED         */
         ST    @12,LPG                                             0208
*             ELSE                                                 0209
*               LPG=LPA;            /* NO: KEY FOR ENTIRE RANGE WAS
*                                      CHANGED                       */
         B     @RC00207                                            0209
@RF00207 L     @12,ELTAD                                           0209
         L     @12,LPA-1(,@12)                                     0209
         LA    @12,0(,@12)                                         0209
         ST    @12,LPG                                             0209
*             CALL KEYRSTR;         /* RESTORE KEY FOR RANGE         */
@RC00207 BAL   @14,KEYRSTR                                         0210
*             ELTAD=ELTAD+LENGTH(LISTELT);/* NEXT ELEMENT IN LIST    */
         LA    @12,8                                               0211
         AL    @12,ELTAD                                           0211

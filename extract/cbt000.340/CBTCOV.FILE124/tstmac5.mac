//LBM01199 JOB ('MVSJES3      ','LFALJMVS1BM1               '),
// 'BILL MCCOY 209',MSGLEVEL=1,PRTY=12,PERFORM=4,
// NOTIFY=L11FOTM,MSGCLASS=T
//*MAIN CLASS=Q96,ORG=RMT40
//*PASSWORD DSN=
//*DIST  PLEASE DELIVER TO BILL MCCOY  _____CUBICLE 209_____
//*DIST  PLEASE DELIVER TO BILL MCCOY  _____CUBICLE 209_____
//*DIST  PLEASE DELIVER TO BILL MCCOY  _____CUBICLE 209_____
// EXEC ASMFCL,SYSLMOD='EP.TESTLIBH(TSTRACF5)',DISP=SHR,RENT=NORENT
//ASMFCL.SYSPRINT DD SYSOUT=*
//ASMFCL.SYSLIB DD DSN=SYS1.MACLIB,DISP=SHR
//         DD DSN=EPNG.MACLIB,DISP=SHR
//         DD DSN=L11FOTM.RACF.MACLIB,DISP=SHR
         TITLE 'TESTING RACF INTERNAL MACROS'
TEST     ENTER REG=12
         USING WK1AREA,R9
         USING WK2AREA,R8
         LA    R9,AREA1
         LA    R8,AREA2
         EQREG
RACMAC   DS    0H
         MVI   WK1AREA,C' '
         MVC   WK1AREA+1(255),WK1AREA
         ICHEINTY LOCATE,ENTRY=USERIDL,                                X
               OPTIONS=(FLDEF,TESTC,TESTM,ACTION),                     X
               WKAREA=AREA1,ACTIONS=(A1,A2,A3,A4),MF=(E,I1)
         ST    R15,RETCODE1
         LTR   R15,R15
         BZ    NEXT1
         ABEND 111,DUMP
NEXT1    DS    0H
         L     R2,16               CVT ADDR
         L     R2,992(R2)          RCVT ADDR
         L     R2,188(R2)          CDE TABLE ADDR
         ST    R2,CDEADR           CDE TABLE ADDR
         USING CDETABLE,R2
         XC    CLASMASK,CLASMASK
         SR    R0,R0
         CLC   WK1DATA1,=X'0000'   ANY CLASSES?
         BE    NEXT2               NO,
         LH    R0,WK1DATA1         # CLASSES
         LA    R1,WK1DATA3         ADDRESS OF 1ST CLASS
         CLC   0(8,R1),=CL8'USER ' USER CLASS
         BNE   TOP1                NO,
         OI    IEPCAU,X'80'        SET USER CLASS
         BE    NXTCLS              YES, NOT IN CDE
TOP1     L     R2,CDEADR           RELOAD CDE ADDRESS
CKCLASS  CLC   CDESIZE,=X'0000'    ZERO SIZE
         BE    NXTCLS              END OF TABLE
         CLC   CDENAME,0(R1)       COMPARE CLASS NAMES
         BE    MATCH1              EQUAL,
         AH    R2,CDESIZE          INDEX TO NEXT CDE ENTRY
         B     CKCLASS
MATCH1   OC    CLASMASK,CDEPOS     OR IN THE POSITION MASK
NXTCLS   LA    R1,8(,R1)           INDEX TO NEXT CLASS ENTRY
         BCT   R0,TOP1             CHECK OUT NEXT CLASS
NEXT2    LA    R5,USERID           USERID ONLY
         ICHETEST FLDATA=(,(R5)),MF=(E,T01)
         SPACE
         ICHEACTN TESTS=(T01),MF=(E,A01)
         SPACE
         ICHEINTY LOCATE,ENTRY=GROUPL,                                 X
               OPTIONS=(FLDEF,TESTC,TESTM,ACTION),                     X
               WKAREA=AREA2,ACTIONS=(A01),MF=(E,I2)
         ST    R15,RETCODE2
         LTR   R15,R15
         BZ    NEXT3
         ABEND 222,DUMP
NEXT3    MVC   IEPCAUTH,CLASMASK
         MVC   IEPAUTH,WK2GRPA
         MVC   IEP#GRP,WK1DATA2
         CLC   IEP#GRP,=X'0000'
         BNE   NEXT4
         ABEND 333,DUMP
NEXT4    LA    R9,AREA1
         LH    R2,WK1SIZE3      SIZE OF CLASSES
         LA    R1,WK1DATA3      ADDR OF CLASSES
         LA    R1,2(R1,R2)      ADDR OF GROUPS
         LA    R2,IEPGROUP      ADDR OF GROUPS
         SR    R0,R0
         LH    R0,WK1DATA2      # GROUPS
         CH    R0,=H'30'        MAXIMUM 30 GROUPS
         BNH   MOVE1            WITHIN LIMIT
         MVC   IEP#GRP,=X'0000'
         B     ABEND9
MOVE1    MVC   0(8,R2),0(R1)    MOVE ONE
         LA    R1,8(R1)         NEXT GROUP
         LA    R2,8(R2)         NEXT GROUP
         BCT   R0,MOVE1         MOVE ALL GROUPS
ABEND9   ABEND 999,DUMP
CLASMASK DC    F'0'
CDEADR   DC    F'0'
RETCODE1 DC    F'0'
RETCODE2 DC    F'0'
AREA1    DC    CL256' '
AREA2    DC    CL256' '
USERIDL  DC    AL1(6)
USERID   DC    CL8'U00103 '
GROUPL   DC    AL1(4)
GROUP    DC    CL8'G001 '
IEP      DS    0CL256
         DS    0F
IEPGLV   DC    X'FF',AL3(256)
IEPAUTH  DC    X'00'
IEPFLG1  DC    X'00'
IEP#GRP  DC    H'0'
         DC    X'000000'
IEPCAU   DC    X'00'
         EQU   X'80'    USER
IEPCAUTH DC    F'0'
IEPGROUP DC    CL8' '
         DC    29CL8' '
I1       ICHEINTY LOCATE,TYPE='USR',ACTIONS=(,,,),MF=L,                X
               ENTRY=0,WKAREA=0
A1       ICHEACTN FIELD=CLCNT,MF=L
A2       ICHEACTN FIELD=CONGRPCT,MF=L
A3       ICHEACTN FIELD=CLNAME,MF=L
A4       ICHEACTN FIELD=CONGRPNM,MF=L
I2       ICHEINTY LOCATE,TYPE='GRP',ACTIONS=(,,,),MF=L,                X
               ENTRY=0,WKAREA=0
T01      ICHETEST FIELD=USERID,FLDATA=(8,0),MF=L
A01      ICHEACTN FIELD=USERACS,TESTS=(),MF=L
CDETABLE DSECT
CDESIZE  DS    CL2        SIZE OF ENTRY
CDEID#   DS    CL1        ID NUMBER
CDENAME  DS    CL8        CLASS NAME
         DS    CL13
CDEPOS   DS    CL4        CLASS POSITION
         DS    CL4
WK1DSECT DSECT
WK1AREA  DS    0CL256
         DS    CL26
WK1TSIZE DS    CL2        SIZE OF ALL FOLLOWING INFO
WK1SIZE1 DS    CL2        SIZE OF # CLASSES
WK1DATA1 DS    CL2        # CLASSES
WK1SIZE2 DS    CL2        SIZE OF # GROUPS
WK1DATA2 DS    CL2        # GROUPS
WK1SIZE3 DS    CL2        SIZE OF ALL ENTRIES
WK1DATA3 DS    0CL8       ENTRIES
         DS    CL240      PADDING
WK2AREA  DS    0CL31
         DS    CL26
WK2SIZE  DS    CL2                 LENGTH OF ALL EXTRACTED DATA
WK2GPAL  DS    CL2                 LENGTH OF GROUP AUTHORITY
WK2GRPA  DS    CL1                 USER'S GROUP AUTHORITY
         DS    CL240      PADDING
         END
//LINK.SYSIN DD *
 SETCODE AC(1)
//      EXEC PGM=TSTRACF5
//STEPLIB DD DSN=EP.TESTLIBH,DISP=SHR
//SYSUDUMP DD SYSOUT=*

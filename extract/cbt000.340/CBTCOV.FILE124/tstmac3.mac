//LBM01199 JOB ('MVSJES3      ','LFALJMVS1BM1               '),
// 'BILL MCCOY 209',MSGLEVEL=1,PRTY=12,PERFORM=4,
// NOTIFY=L11FOTM,MSGCLASS=T
//*MAIN CLASS=Q96,ORG=RMT40
//*PASSWORD DSN=EP.TESTLIBH,P=XXXX
//*DIST  PLEASE DELIVER TO BILL MCCOY  _____CUBICLE 209_____
//*DIST  PLEASE DELIVER TO BILL MCCOY  _____CUBICLE 209_____
//*DIST  PLEASE DELIVER TO BILL MCCOY  _____CUBICLE 209_____
// EXEC ASMFCL,SYSLMOD='EP.TESTLIBH(TSTRACF3)',DISP=SHR,RENT=NORENT
//ASMFCL.SYSPRINT DD SYSOUT=*
//ASMFCL.SYSLIB DD DSN=SYS1.MACLIB,DISP=SHR
//         DD DSN=EPNG.MACLIB,DISP=SHR
//         DD DSN=L11FOTM.RACF.MACLIB,DISP=SHR
         TITLE 'TESTING RACF INTERNAL MACROS'
TEST     ENTER REG=12
         EQREG
         B     TOP
         OPEN  (SYSIN,(INPUT))
         OPEN  (SYSPRINT,(OUTPUT))
GETCARD  CLI   COL80,C'A'
         BE    ABEND
         GET   SYSIN
         LR    R3,R1
         MVC   USERID,0(R3)
         LA    R1,USERID+7
         LA    R0,8
CKLGTH   CLI   0(R1),C' '
         BNE   STLGTH
         BCTR  R1,0
         BCT   R0,CKLGTH
         ABEND 222,DUMP
STLGTH   STC   R0,USERIDL
         MVC   COL80,79(R3)
         BAL   R2,GETLINE
         MVC   1(5,R4),=C'USER='
         MVC   6(8,R4),0(R3)
         BAL   R2,RACMAC
*
         C     R15,=F'0'
         BE    NOERR
         B     LOGOUT
NOERR    DS    0H
         MVC   15(6,R4),=C'FLAGS='
         MVC   21(10,R4),FLAGS
         MVC   32(8,R4),=C'DFLTGRP='
         MVC   40(8,R4),WK1DATA7
         MVC   49(2,R4),=C'P='
         MVC   51(16,R4),PASSWORD
         B     GETCARD
LOGOUT   MVC   15(12,R4),=C'RETURN CODE='
         MVC   27(2,R4),RETURN
         B     GETCARD
GETLINE  PUT   SYSPRINT
         LR    R4,R1
         MVI   0(R4),C' '
         MVC   1(120,R4),0(R4)
         MVI   0(R4),X'09'
         BR    R2
ABEND    ABEND 111,DUMP
EOF      CLOSE (SYSIN,,SYSPRINT)
         EXIT  RC=0
TOP      DS    0H
RACMAC   DS    0H
         MVI   WK1AREA,C' '
         MVC   WK1AREA+1(255),WK1AREA
         ICHEINTY LOCATE,ENTRY=USERIDL,                                X
               OPTIONS=(FLDEF,TESTC,TESTM,ACTION),                     X
               WKAREA=WK1AREA,ACTIONS=(A1,A2,A3,A4,A5),MF=(E,I1)
         ST    R15,RETCODE
         ABEND 888,DUMP
         MVC   WORK(1),WK1DATA1
         MVC   WORK+1(1),WK1DATA2
         MVC   WORK+2(1),WK1DATA3
         MVC   WORK+3(1),WK1DATA4
         MVC   WORK+4(1),WK1DATA5
         UNPK  FLAGS(11),WORK(6)
         TR    FLAGS(10),HEXTAB-240
         MVC   WORK(8),WK1DATA6
         UNPK  PASSWORD(9),WORK(5)
         UNPK  PASSWORD+8(9),WORK+4(5)
         TR    PASSWORD(16),HEXTAB-240
         MVC   WORK(1),RETCODE+3
         UNPK  RETURN(3),WORK(2)
         TR    RETURN(2),HEXTAB-240
         BR    R2
         EJECT
COL80    DC    C' '
WORK     DC    D'0'
         DC    CL1' '
FLAGS    DC    CL10' '
         DC    CL1' '
PASSWORD DC    CL16' '
         DC    CL1' '
RETURN   DC    CL2' '
         DC    CL1' '
HEXTAB   DC    X'F0F1F2F3F4F5F6F7F8F9C1C2C3C4C5C6'
         DC    C'THE FOLLOWING IS THE WORK AREA'
RETCODE  DC    F'0'
WK1AREA  DS    0CL256
         DS    CL24
         DS    CL2
WK1TSIZE DS    CL2        SIZE OF ALL FOLLOWING INFO
WK1SIZE1 DS    CL2        SIZE OF FLAG1
WK1DATA1 DS    CL1        FLAG1
WK1SIZE2 DS    CL2        SIZE OF FLAG2
WK1DATA2 DS    CL1        FLAG2
WK1SIZE3 DS    CL2        SIZE OF FLAG3
WK1DATA3 DS    CL1        FLAG3
WK1SIZE4 DS    CL2        SIZE OF FLAG4
WK1DATA4 DS    CL1        FLAG4
WK1SIZE5 DS    CL2        SIZE OF FLAG5
WK1DATA5 DS    CL1        FLAG5
WK1SIZE6 DS    CL2        SIZE OF PASSWORD
WK1DATA6 DS    CL8        PASSWORD
WK1SIZE7 DS    CL2        SIZE OF DEFAULT GROUP
WK1DATA7 DS    CL8        DEFAULT GROUP
         DS    CL240      PADDING
USERIDL  DC    AL1(7)
USERID   DC    CL8'L11FOTM '
I1       ICHEINTY LOCATE,TYPE='USR',ACTIONS=(,,,,),MF=L,               X
               ENTRY=0,WKAREA=0
A1       ICHEACTN FIELD=DFLTGRP,MF=L
A2       ICHEACTN FIELD=CLCNT,MF=L
A3       ICHEACTN FIELD=CONGRPCT,MF=L
A4       ICHEACTN FIELD=CLNAME,MF=L
A5       ICHEACTN FIELD=CONGRPNM,MF=L
SYSIN    DCB   DSORG=PS,MACRF=GL,DDNAME=SYSIN,EODAD=EOF,RECFM=FB,      X
               LRECL=80,BLKSIZE=80
SYSPRINT DCB   DSORG=PS,MACRF=PL,DDNAME=SYSPRINT,RECFM=FBM,            X
               LRECL=121,BLKSIZE=121
         END
//LINK.SYSIN  DD *
 SETCODE AC(1)
//   EXEC PGM=TSTRACF3
//STEPLIB DD DSN=EP.TESTLIBH,DISP=SHR
//SYSPRINT DD SYSOUT=*
//SYSUDUMP DD SYSOUT=*
//SYSIN    DD *
L11FOTM G001

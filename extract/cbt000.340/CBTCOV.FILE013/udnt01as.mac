DATEXSZ  CSECT
         ENTRY  DATEX,EXDRU,E15
*        ABEND 03    KEINE SUCHKARTEN VORHANDEN
*        ABEND 04    SUCHBEGRIFF,BEDINGUNG ODER DISPLACEMENT FALSCH GEL
*        ABEND 06    SUCHBEGR DURCH WIEDERHOLUNG LAENGER ALS 28 BYTES
*        ABEND 07    KARTE NICHT ALS SUCHKARTE GEKENNZEICHNET
*        ABEND 08    ZEICHENFOLGE DES  SUCHBEGR NICHT MODULO 2
*        ABEND 10    SORTIN-KARTE FALSCH BEI DATEX ALS SORTEXIT
*        ABEND 20    ERFOLGLOSES OPEN FUER EINE QSAM ODER ISAM-DATEI
*        ABEND 30    AUSNAHMEBEDINGUNGEN BEI I/O
*
         EJECT
*   AUFBAU DER BATCH KARTEN
         SPACE 3
**OR00001BNE001F0
**. .    .  .  .
**. .    .  .  .....HEXADEZIMAL DARGESTELLTER SUCHBEGRIFF, PER BYTE
**. .    .  .       2 LOCHUNGEN, DEZIMAL 0 WAERW F LOCHUNG AUF SPALTE
**. .    .  .       16 UND 0 (NULL) LOCHUNG AUF SPALTE 17
**. .    .  .
**. .    .  ........GIBT AN, WIE OFT DIE AB SPALTE 16 GELOCHTEN ZEICHEN
**. .    .          WIEDERHOLT WERDEN MUESSEN, UM DEN SUCHBEGRIFF
**. .    .          ZU ERGEBEN.
**. .    .          FEHLT DIESER OPERAND, WIRD 1 ANGENOMMEN
**. .    .          DER WERT MUSS RECHTSBUENDIG GELOCHT WERDEN, DER
**. .    .          SUCHBEGRIFF DARF DUCH DIE WIEDERHOLUNG NICHT
**. .    .          LAENGER ALS 256 BYTES WERDEN
**. .    .
**. .    ...........GIBT DIE BEDINGUNG AN, BEI DEREN ERFUELLUNG DIE
**. .               SAETZE GEDRUCKT WERDEN SOLLEN
**. .               MOEGLICHE BEDINGUNGEN: BH, BL, BNE, BE, BNL, BNH
**. .               ODER GT, LT, NE, EQ, GE, LE. FEHLT DIESER OPERAND,
**. .               WIRD GLEICH (BE,EQ) ANGENOMMEN. DIE BEDINGUNGEN
**. .               MUESSEN RECHTSBUENDIG GELOCHT WERDEN
**. .
**..................GIBT DAS DISPLACEMENT DES SUCHBEGRIFFES ZUM SATZ-
**.                 ANFANG AN. (5 STELLEN, MAX 4095). DER WERT MUSS
**.                 RECHTSBUENDIG GELOCHT WERDEN; FEHLT DIESER
**.                 OPERAND SO WIRD EIN DISPLACEMENT VON 0 ANGENOMMEN
**.
**..................OR ZEIGT AN, DASS HIER EINE NEUE GRUPPE VON SUCH-
**                  BEGRIFFEN BEGINNT. BEIM FEHLEN DIESES OPERANDEN
**                  WIRD AND ANGENOMMEN, WAS BEDEUTET DASS DER HIER GE-
**                  LOCHTE SUCHBEGRIFF NOCH ZUR SELBEN GRUPPE GEHOERT
**
**..................DIESE BEIDEN STERNE SIND KENNZEICHEN FUER BATCH-
**                  KARTEN; FEHLEN SIE, SO WIRD DAS PROGRAMM ABGEBROCHEN
               >
**
**
         SPACE 3
**  ZUSAETLICH GIBT ES NOCH DIE MOEGLICHKEIT, DAS PROGRAMM BEIM FINDEN
**  EINES BESTIMMTEN ORDNUNGSBEGRIFFES ABZUBRECHEN:
**
**
**  00001END02000
**. .    .  .  .
**. .    .  .  .....SUCHBEGRIFF
**. .    .  .
**. .    .  ........WIEDERHOLUNGSFAKTOR
**. .    .
**. .    ...........MUSS END SEIN
**. .                    ===
**. .
**. ................DISPLACEMENT
**.
**..................BLANK
**
**..................BATCH KARTEN KENNZEICHEN
         SPACE  5
*              BEDEUTUNG DER GESETZTEN BIT IM FELD SCHALTER:
*              X'01' = *
*              X'02' = X
*              X'04' = D
*              X'08' = O
*              X'10' = C
*              X'20' = H
*              X'40' = S
*              X'80' = Z
         EJECT
*                PROGRAMMABSCHNITT ZUR ANALYSE VON PARMINFORMATIONEN.
*                EINSTELLIGE ALPHANUMERISCHE SCHLUESSEL (X,C,*...)
*                SOWIE EIN VARIABEL LANGES ZIFFERNFELD TRETEN IN
*                BELIEBIGER REIHENFOLGE AUF
         BC    15,8(15)                SPRUNG UEBER ADRESSKONSTANTE
         DC    A(TRANSTAB+74)          ADRESSE 1. SONDERZ AUS TRANSTAB
         L     15,4(15)                ADRESSE NACH R15
         MVC   0(54,15),183(15)        ALLE SONDERZEICHEN NACH TRANSTAB
*                                      ----
*DATEX   BASER 3,END99
* LADEN DER BASISREGISTER              *****
E15      NOPR  0
EXDRU    NOPR  0
         DS    0H                      *****
DATEX    STM   14,12,12(13)            *****
         BALR  10,0                    *****
         USING *,10,11,12              *****
         LA    11,4095(10)             *****
         LA    11,1(11)                *****
         LA    12,4095(11)             *****
         LA    12,1(12)                *****
         CNOP  2,4                     *****
         B     M0001M01                *****
M0001M00 DS    18F                     *****
M0001M01 ST    13,M0001M00+4           *****
         LA    13,M0001M00             *****
         B     START                   *****
END99    L     13,M0001M00+4           *****
         L     14,12(13,0)             *****
         LM    0,12,20(13)             *****
         SR    15,15                   COMPLETION CODE=0
         BR    14                      *****
START    NOP   LESSEQU                 AUF B WENN DATEX ALS SORTEXIT L.
START2   NOP   PROGENDE                AUF B WENN IN DRUCK PZAEHLER=0
         L     4,0(1)                  ADR. PARMLISTE IN R4
         SR    3,3                     LOESCHEN R3 FUER VERGLEICH
         SR    5,5                     LOESCHEN R5 FUER P.LAENGE
         CH    3,0(4)                  KEINE PARMINE WENN HALBW. LEER
         BNE   PARMDA                  PARMLAENGE VORH.
         LA    4,DEFAULT               ADR. ERSATZPARAMETER IN R4
PARMDA   TM    0(4),X'F0'              STAMMT LAENGE AUS SORTINKARTE?
         BZ    PARMDA2                 NEIN, NORMALES PARM
         PACK  LEN,0(2,4)              LAENGE PACKEN IN DWORT
         CVB   5,LEN
         BCTR  5,0
         BCTR  5,0                     MINUS 2 = PARMLEN
         OI    LESSEQU+1,X'F0'         WEICHE FUER RETURN4 AUF AN
         OI    START+1,X'F0'
         NI    WEICHE15+1,X'0F'        AUF NOP BEI E15
         NI    ENDWEI+1,X'0F'          BEW DASS B SATZZ+EXIT L SATZ NOC
*                                      MITSORTIERT WIRD
         B     PARMDA2+4
PARMDA2  IC    5,1(4)                  PARMLAENGE IN R5
         BCTR  5,0                     LAENGE MINUS 1
         STC   5,TRT+1                 ALS TRT-LAENGE EINSETZEN
         SPACE 3
*                DIE GESUCHTEN ZIECHEN WERDEN NACHEINANDER IN DIE
*                TRT-TABELLE EINGESETZT UND NACH DEM TRT WIEDER
*                GELOESCHT. BEDING.SCHL.=NULL, WENN REIN ZEICHEN VORH.
         MVI   TRTTAB+92,C'*'
         EX    0,TRT
         STC   3,TRTTAB+92
         BC    8,NOBATCH
         OI    SCHALTER,X'01'
NOBATCH  MVI   TRTTAB+231,C'X'
         EX    0,TRT
         STC   3,TRTTAB+231
         BC    8,NOISAM
         OI    SCHALTER,X'02'
         B     PRUEFOUT
NOISAM   MVI   TRTTAB+196,C'D'
         EX    0,TRT
         STC   3,TRTTAB+196
         BC    8,NOTTR
         OI    SCHALTER,X'05'
         B     PRUEFOUT
NOTTR    MVI   TRTTAB+214,C'O'
         EX    0,TRT
         STC   3,TRTTAB+214
         BC    8,PRUEFOUT
         OI    SCHALTER,X'09'
PRUEFOUT MVI   TRTTAB+195,C'C'
         EX    0,TRT
         STC   3,TRTTAB+195
         BC    8,NOCHARDR
         OI    SCHALTER,X'10'
         B     NOHEXDR
NOCHARDR MVI   TRTTAB+200,C'H'
         EX    0,TRT
         STC   3,TRTTAB+200
         BC    8,NOHEXDR
         OI    SCHALTER,X'20'
NOHEXDR  MVI   TRTTAB+227,C'T'
         EX    0,TRT
         STC   3,TRTTAB+227
         BC    8,NOTRENN
         NI    TRENWEI1+1,X'0F'
         NI    TRENWEI2+1,X'0F'
NOTRENN  MVI   TRTTAB+226,C'S'
         EX    0,TRT
         STC   3,TRTTAB+226
         BC    8,PRUEFZ
         OI    SCHALTER,X'40'
PRUEFZ   MVI   TRTTAB+233,C'Z'
         EX    0,TRT
         STC   3,TRTTAB+233
         BC    8,NOZET
         OI    SCHALTER,X'80'
         SPACE 3
NOZET    MVI   TRTTAB+197,C'E'
         EX    0,TRT
         STC   3,TRTTAB+197
         BC    8,NOTEXIT
         TM    START+1,X'F0'
         BO    NOTEXIT
         ABEND  10
NOTEXIT  MVC   TRTTAB+240(10),FFFF    FF AUF TABELLENPLATZ F0-F9
TRT      TRT   2(1,4),TRTTAB          SUCHEN ZIFFER  IN PARMFELD
         BC    8,KEINZAE              KEINE ZIFFER GEFUNDEN
         LA    3,0(1)                  ADR. 1. ZIFFER IN R3,1.BYTE BLK
         BC    2,TRTPACK              1.ZIFFER STEHT AUF LETZTEM P-BYTE
         MVC   TRTTAB(256),TRTTAB-1    FF NACH TRTTAB
         XC    TRTTAB+240(10),TRTTAB+240   F0-F9 AUF X'00'
         SR    1,4                     LAENGE BIS 1.ZIFFER IN R1
         BCTR  1,0                     LAENGE MINUS 1
         EX    1,MVCPARM               VORNULLEN IN LISTE BIS 1.ZIFFER
         EX    0,TRT                   SUCHEN ENDE ZIFFERNFOLGE
         BNE   SR13                    VERZW. WENN ENDE VOR PARMENDE
         LA    1,3(4,5)                ADR. LETZTES P-BYTE+1 IN R1
SR13     SR    1,3                     LAENGE ZIFFERNFOLGE+1 IN R1
         BCTR  1,0                     LAENGE MINUS 1
         EX    1,TRTPACK               PACKEN ZIFFERN
SCHALTPR TM    SCHALTER,X'80'          Z-BIT GESETZT?
         BZ    KEINZAE2                NEIN
         MVC   PZEILENZ,PZAEHL         UEBERTRAG NACH ZEILENZAEHLER
         NI    ZZAEHLG+1,X'0F'         NOP, DA ZZAEHLG
         NI    ZZAEHLG2+1,X'0F'        NOP, DA ZZAEHLG
KEINZAE  OI    NOPR90+1,X'F0'          SATZZAEHLG SOLL N DURCHL  WERDEN
         OI    NOPR91+1,X'F0'          SATZZAEHLG SOLL N DURCHL WERDEN
         OI    NOPLESEQ+1,X'F0'        SATZZAEHLER SOLL N DURCHL WERDEN
         SPACE 5
         OI    NOPSORT+1,X'F0'         SATZZAEHLER SOLL N DURCHL WERDEN
KEINZAE2 OPEN  (OUTPUT,(OUTPUT))
         TM    OUTPUT+48,X'10'
         BZ    ABEND20
         MVI   TRTTAB,X'FF'            TRTTAB AUF FF IN LAENGE 256
         MVC   TRTTAB+1(255),TRTTAB
         XC    TRTTAB+193(6),TRTTAB+193  FUNKTIONSBYTES A-F AUF 00
         XC    TRTTAB+240(10),TRTTAB+240 FUNKTIONSBYTES 0-9 AUF 00
         MVI   TRTTAB+64,X'00'           FUNKTIONSBYTE BLANK AUF 00
         TM    SCHALTER,X'01'
         BZ    TMC
         OPEN  (BATCHDCB,(INPUT))
         TM    BATCHDCB+48,X'10'
         BZ    ABEND20
         TM    SCHALTER,X'08'
         BZ    TMD
*        OPEN  (BISAM,(INPUT))         GEAENDERT AM 11.8.68
         CNOP  0,4                     *****
         BAL   1,*+8                   *****
         DC    AL1(128)                *****
         DC    AL3(BISAM)              *****
         SVC   19                      *****
*        OPEN  (BDAM,(INPUT))          GEAENDERT AM 11.8.68
         CNOP  0,4                     *****
         BAL   1,*+8                   *****
         DC    AL1(128)                *****
         DC    AL3(BDAM)               *****
         SVC   19                      *****
         B     ORROUT                  VERZW NACH O-ROUTINE
TMD      TM    SCHALTER,X'04'
         BZ    TMC
         MVC   BDAM+40(8),=C'INPUT   ' DDNAME INPUT STATT INPUT1
*        OPEN  (BDAM,(INPUT))          GEAENDERT AM 11.8.68
         CNOP  0,4                     *****
         BAL   1,*+8                   *****
         DC    AL1(128)                *****
         DC    AL3(BDAM)               *****
         SVC   19                      *****
         B     TTRROUT                 VERZW. IN BDAM-ROUTINE
TMC      TM    SCHALTER,X'10'
         BZ    TMH
         OI    HEXOCHAR+1,X'F0'
         OI    DRWON+1,X'F0'
         B     TMX
TMH      TM    SCHALTER,X'20'
         BZ    TMX
         OI    HEXCHAR2+1,X'F0'
         OI    HEXCHAR3+1,X'F0'
         OI    D022A+1,X'F0'
TMX      TM    SCHALTER,X'02'
         BO    ISAM          ISAM - INPUT DATEI
*        OPEN  (QSAMDCB,(INPUT))
         CNOP  0,4                     *****
         BAL   1,*+8                   *****
         DC    AL1(128)                *****
         DC    AL3(QSAMDCB)            *****
         SVC   19                      *****
         TM    QSAMDCB+48,X'10'
         BZ    ABEND20
         MVC   REG1,=A(QSAMDCB)
         B     TMV
         SPACE 3
*ISAM    OPEN  (ISAMDCB,(INPUT))
         CNOP  0,4                     *****
ISAM     BAL   1,*+8                   *****
         DC    AL1(128)                *****
         DC    AL3(ISAMDCB)            *****
         SVC   19                      *****
         TM    ISAMDCB+48,X'10'
         BZ    ABEND20
*        SETL  ISAMDCB,B
         LA    1,ISAMDCB               *****
         LA    0,16(0,0)               *****
         SLL   0,24(0)                 *****
         L     15,76(0,1)              *****
         BALR  14,15                   *****
         MVC   REG1,=A(ISAMDCB)
         SPACE 3
TMV      L     2,REG1                  LADEN ADR DES DCB
         MVC   LRECL,82(2)             SATZLAENGE AUS DCB NACH LRECL
         TM    36(2),X'80'             BIT RECFM F ODER U AN?
         BO    FIXREC                  JA, DANN DCBLRECL OKEY
         NI    BRECFMF+1,X'0F'         BRANCH UEBER RECFM V-ZWEIG NOPPE
FIXREC   TM    SCHALTER,X'40'
         BZ    TRENWEI1
         MVC   BLKSIZE,62(2)
         MVC   RECFM,36(2)
         LA    2,PUTQSAM
         MVC   62(2,2),BLKSIZE
         MVC   82(2,2),LRECL
         MVC   36(1,2),RECFM
*        OPEN  (PUTQSAM,(OUTPUT))
         CNOP  0,4                     *****
         BAL   1,*+8                   *****
         DC    AL1(143)                *****
         DC    AL3(PUTQSAM)            *****
         SVC   19                      *****
         TM    PUTQSAM+48,X'10'
         BZ    ABEND20
TRENWEI1 B     TMBATCH
         LA    2,OUTPUT2
         MVC   62(2,2),BLKSIZE
         MVC   82(2,2),LRECL
         MVC   36(1,2),RECFM
         OPEN  (OUTPUT2,(OUTPUT))
         TM    OUTPUT2+48,X'10'
         BZ    ABEND20
         SPACE 3
TMBATCH  TM    SCHALTER,X'01'
         BZ    LESSEQU
VGLGENER LA    R4,VFOLGE               BASISADR. VFOLGE IN REG.4
         LA    R3,VWERTE               BASISADR. VWERTE IN REG.3
LESKART1 GET   BATCHDCB                LESEN BATCHKARTE
         XC    SCHALT,SCHALT
         LR    R8,R1
         USING BATCHIN,R8
         MVI   DRUBER,X'11'            ZT2 NACH DEM DRUCKEN EINSETZEN
         AP    KZAEHL,=P'1'            SUCHKARTENZAEHLER PLUS 1
         CP    KZAEHL,=P'101'          MEHR ALS 100 SUCHKARTEN?
         BL    EEE                     NEIN,DRUCKEN KARTE
         WTO   'MEHR ALS 100 SUCHKARTEN, UEBERZ. KARTEN NICHT VERARB.'
         B     BATCHEND                KEINE WEITEREN KARTEN LESEN
EEE      NOP   FFF                     AUF NOP NUR BEI 1. DURCHLAUF
         OI    EEE+1,X'F0'             WEICHE AUF B SETZEN
         MVC   DRUBER+1(79),=C'LFDNR   BED. DISPLACEMENT BEDINGUNGSSCHL*
               UESSEL WIEDERHOLUNGSFAKTOR ZEICHENFOLGE'
         PUT   OUTPUT,DRUBER           DRUCKEN KOPFZEILE
         MVI   DRUBER+1,X'40'          LOESCHEN DRUBER
         MVC   DRUBER+2(78),DRUBER+1
FFF      UNPK  PDOPPELW(3),KZAEHL      BATCHKARTENZAE SOLL GEDR WERDEN
         MVC   DRUBER+1(3),PDOPPELW    IN DRUCKBEREICH
         MVZ   DRUBER+3(1),=X'F0'      VZ-BYTE AUF F
         MVC   DRUBER+6(2),KA          KA NACH DRUBER
         MVC   DRUBER+9(2),ORAND       OR-SPALTEN NACH DRUBER
         MVC   DRUBER+14(5),DISPL      DISPLACEMENT NACH DRUBER
         MVC   DRUBER+27(3),BED        BEDINGUNGS-OPERATOR NACH DRUBER
         MVC   DRUBER+48(3),WIEDERH    WIEDERHOLUNGSFAKTOR NACH DRUBER
         MVC   DRUBER+68(56),SUCHBEGR  SUCHBEGRIFF NACH DRUBER
         PUT   OUTPUT,DRUBER           DRUCKEN SUCHKARTE
         MVI   DRUBER,X'40'            LOESCHEN DRUBER IN LAENGE 123
         MVC   DRUBER+1(122),DRUBER
         CLC   KA,=C'**'               IST ES EINE BATCHKARTE?
         BE    GUELTKA                 JA, KA OKEY
         ABEND 07                      UNGUELTIGE KARTENART
GUELTKA  CLC   SUCHBEGR,DRUBER         VERGLEICH SP 16-71 GEGEN BLANK
         BNE   VERGL16                 NEIN, SUCHBEGR. VORHANDEN
KNSUCHBG ABEND 04,DUMP                 SUCHBG NICHT O. FALSCH ABGEL.
VERGL16  CLI   SUCHBEGR,C' '           SUCHBEGR. LINKSB. GELOCHT?
         BE    KNSUCHBG                JA, ABEND 04
         CLI   SUCHBEGR,C'('           2. VERGLEICHSOP.  EIN FELD D
*                                      GLEICHEN SATZS?
         BE    ROUT2                   DANN IN SPEZ. ROUTINE
         CLC   SUCHBEGR(3),=C'NUM'     NUMERIC-PRUEFUNG VERLANGT?
         BNE   NOTN
         OI    SCHALT,X'01'            VORMERKEN D VFOLGE-GR 20 LANG
         CLC   WIEDERH,=C'   '         LAENGE MUSS DANN ANGEGEBEN SEIN
         BE    KNSUCHBG
         B     PACK1315                IN GEMEINS ZWEIG
NOTN     TRT   SUCHBEGR,TRTTAB         PRUEFEN AUF UNGL. A-F,0-9,BLANK
         BNE   KNSUCHBG                ABEND 04 WENN UNZUL. ZEICHEN GEF
         LA    R5,SUCHBEGR             ADRESSE SUCHBEGR. IN R5
         SR    R2,R2                   LOESCHEN LAENGEN-REGISTER
IC6      IC    R6,1(R5)                RECHTES BYTE EINES B-PAARES IN 6
         TM    1(R5),X'F0'             0-9 GELOCHT?
         BO    *+8                     JA, ZIFFER OKEY
         LA    R6,9(R6)                ADDIEREN 9 AUF ZIFFER,ERGIBT A-F
         SRDL  R6,4                    ZIFFER NACH R7 SHIFTEN
         IC    R6,0(R5)                LINKES BYTE EINES PAARES IN R6
         TM    0(R5),X'F0'             0-9 GELOCHT?
         BO    *+8                     JA, ZIFFER OKEY
         LA    R6,9(R6)                ADDIEREN 9 AUF ZIFFER,ERGIBT A-F
         SLDL  R6,4                    BEIDE ZIFFERNTEILE RECHTSB.IN R6
         STC   R6,SUCHARBR(R2)         BYTE IN SUCHARBR. ABSPEICHERN
         LA    R5,2(R5)                LAUFREGISTER F. SUCHBEGR. PLUS 2
         LA    R2,1(R2)                LAUFREG. F. SUCHARBR. +1=LAENGE
         CLI   1(R5),X'40'             BLANK HINTER SUCHB. ERREICHT?
         BNE   IC6                     NEIN, NAECHSTES B-PAAR UMFORMEN
         CLI   0(R5),X'40'             LINKES BYTE AUCH BLANK?
         BE    SR32                    JA, SUCHBEGR OKEY
         ABEND 08                      SUCHBEGRIFF NICHT MODULO 2 ABGEL
SR32     SR    R3,R2                   LAUFREG VWERTE UM LAENGE VERMIND
         ST    R3,VWTOLNGE             WERT ABSPEICHERN
         BCTR  R2,0                    LAENGENREG. MINUS 1
         STC   R2,MOVSBEGR+1           LAENGE NACH MVC
         LA    R5,1(0)                 DEFAULT-WERT 1 FUER WIEDERH IN 5
         CLC   WIEDERH,=C'   '         WIEDERLFAKTOR IN KARTE?
         BE    KNWIEDER                NEIN
         PACK  PDOPPELW,WIEDERH        PACKEN IN DOPPELW FUER CVB
         CVB   R5,PDOPPELW             WIEDERH NACH R5 CONVERTIEREN
KNWIEDER LA    R2,1(R2)                LAENGE WIEDERHERSTELLEN
WIEDERIT AR    R3,R2                   LAUFREG VWERTE UM LAENGE ERHOEH
MOVSBEGR MVC   0(1,R3),SUCHARBR        SUCHBEGR NACH VWERTE MOVEN
         BCT   R5,WIEDERIT             NOCHMAL MOVEN,FALLS R5 UNGL NULL
         S     R3,VWTOLNGE             GESAMTLAENGE IN R3 BILDEN
         CH    R3,=H'28'               GESAMTLAENGE GR ALS 28?
         BNH   BCTR3                   NEIN,LAENGE OKEY
ABEND06  ABEND 06                      LAENGE DURCH WIEDERH. GR ALS 28
BCTR3    BCTR  R3,0                    GESAMTLAENGE MINUS 1
         STC   R3,1(R4)                ALS LAENGE IN CLC EINSETZEN
         LA    R3,28(0)                LANGE EINES VERGL-FELDES NACH B3
         AR    R3,R2                   UM ALTEN WERT R3 ERHOEHEN, R3
         A     R3,VWTOLNGE             ENTH. JETZT ADRESSE NAECHST FELD
CLCDISPL CLI   DISPL,C'*'              IST DISPL AUF EINE LEITKARTE BEZ
         BNE   *+8                     NEIN, KEIN * IN SPALTE 5
         MVI   DISPL,X'80'             X'80' ERGIBT BEIM PACKEN 0
* ABFRAGE ALS SCHALTER JEDOCH MOEGLICH
         CLI   DISPL+4,C'*'            * IN SPALTE 9, DH LEITKARTE?
         BE    KNDISPL                 DANN PACKEN USW UEBERSPRINGEN
         CLC   DISPL+1(4),=C'    '     DISPLACEMENT IN KARTE?
         BE    KNDISPL                 NEIN
         PACK  PDOPPELW,DISPL          PACKEN FUER CVB
         CVB   R5,PDOPPELW             CONVERTIEREN NACH R5
         CH    R5,=H'4096'             DISPL GR ALS 4095?
         BNL   KNSUCHBG                JA, FALSCHES DISPL
         AH    R5,=H'4096'             BASISREG 1 NACH R5
         STH   R5,2(R4)                BASISREG, UND DISPL IN CLC EINS.
KNDISPL  CLI   DISPL,X'80'             WAR * IN SPALTE 5 ?
         BNE   *+10                    NEIN, BASISREG 1 OKEY
         MVZ   2(1,R4),=X'70'          R7 ENTHAELT BASISA, IN CLC EINS.
         CLC   BED,=C'END'             END-KARTE?
         BNE   KNEND1                  NEIN
         TM    VGLFLAGS,X'10'          BEREITS END-KARTE DAGEWESEN?
         BO    KNEND1                  ALS E-FOLGEK< BEHABDELN
         OI    VGLFLAGS,X'01'          VORMERKEN END-FLAG SETZEN
         MVC   BED,=C'   '             BEDINGUNGSSCHL. AUF GLEICH
         MVC   ORAND,=C'OR'            OR EINSETZEN
KNEND1   LA    R5,OPERAT               TABELLENADR, IN R5
BEDITER  CLC   BED+1(2),0(R5)          VERGLEICHEN BED MIT OPERATOR-TAB
         BE    BEDFOUND                OPERATOR GEFUNDEN
         CLI   0(R5),X'40'             LETZTES ELEMENT ERREICHT?
         BE    KNSUCHBG                BED FALSCH GEL DA IN TAB N. GEF
         LA    R5,2(R5)                ERHOEHEN TABREGISTER
         B     BEDITER                 WEITER SUCHEN
BEDFOUND CLI   DISPL+4,C'*'            LEITKARTE F VARIABLES SUCHEN?
         BNE   NOTV                    NEIN
         OI    SCHALT,X'01'            VORMERKEN D VFOLGE-GR 20 LANG
         LA    R3,28(R3)               AUF NAE VWERTE, DA NAE CLC DUMMY
         MVC   8(2,R4),BALR1415        BALR IN VROUT2 GENERIEREN
         MVC   PDOPPELW(6),0(R4)       CLC ZWISCHENSPEICHERN
         MVZ   PDOPPELW+2(1),=X'70'    BASISREG 7 EINSETZEN
         MVC   2(6,R4),PDOPPELW        CLC UM 2 BYTES VERSCHIEBEN
         MVC   0(2,R4),LR71            UMLADEN SATZADR DAVOR GENERIEREN
         MVC   11(1,R4),3(R4)          LEN AUS 1. CLC AUCH IN NAE CLC
         LA    R4,10(R4)               R4 AUF NAE VFOLGE-GRUPPE
NOTV     CLC   SUCHBEGR(3),=C'NUM'     WAR NUM-PRUEFUNG VERLANGT?
         BE    NUMROUT
OC7      OC    7(1,R4),15(R5)          MASKE FUER BED. N. ERF. NACH BC
         LA    R4,10(R4)               ERHOEHEN VFOLGE-REGISTER
         CLC   ORAND,=C'OR'            OR-KARTE?
         BNE   LESKART1                NEIN, KEIN GRUPPENWECHSEL
         CP    KZAEHL,=P'1'            OR IN 1.KARTE?
         BE    LESKART1                JA, KEIN GRUPPENWECHSEL
UMKEHRG  LR    R6,R4                   LAUFENDE VFOLGE-ADR. NACH R6
         SH    R6,=H'24'               MASKE D L BC ALTE G. IN R6+1
         TM    SCHALT,X'01'            VFOLGE-GR 20 LANG?
         BO    *+8                     DANN OKEY
         LA    R6,10(R6)               SONST 10 VORRUECKEN
         LA    R5,OPERAT+14            ADR. MASKENSCHL. IN R5
BEDITER2 CLC   1(1,R6),1(R5)           VERGL BC-MASKE MIT TABELLE
         BE    *+12                    GEFUNDEN% MASKE FUER UMKEHRG DAN
         LA    R5,2(R5)                ERHOEHEN TABELLENINDEX
         B     BEDITER2                WEITER SUCHEN
         MVZ   1(1,R6),0(R5)           MASKE FUER BED. ERF. IN LETZT BC
         TM    VGLFLAGS,X'10'          END-FLAG GESETZT?
         BZ    KNEND2                  NEIN
         NI    VGLFLAGS,X'EF'          END-FLAG LOESCHEN
         MVC   2(2,R6),ENDE1KON        ADR. P-ENDE-ZWEIG IN BC EINSETZ.
         B     SR4                     MVC UEBERSPRINGEN
KNEND2   MVC   2(2,R6),BCR8            BCR NACH SATZAUSG GENERIEREN
         MVZ   3(1,R6),1(R6)           BED<SCHL AUS BC IN BCR EINS.
         MVC   0(2,R6),BALR140         BALR 14,0 SOLL ADR D VFOLGE-GR
*  IN R14 FESTHALTEN FUER AUSDRUCK DER BATCHIDENTIFIJATION
         TM    VGLFLAGS,X'01'          WAR END-FLAG SETZEN VORGEMERKT?
         BZ    SR4                     NEIN
         XI    VGLFLAGS,X'11'          LOESCHEN VORMERK,SETZEN END-FLAG
SR4      S     R4,=A(VFOLGE+20)        DISPLACEMENT ZUM B-REG 2 IN R4
         TM    SCHALT,X'01'            VFOLGE-GRUPPE 20 LANG?
         BO    *+8                     DANN OKEY
         LA    R4,10(R4)               SONST UM 10 ERHOEHEN
         STH   R4,PDOPPELW             DISPL ABSPEICHERN
         LA    R6,1(R6)                WEGEN VERGL MIT CLCALT
BCITER   SH    R6,=H'10'               R6 UM 1 GRUPPE IN VFOLGE RUECKS.
         C     R6,CLCALT               HINTER 1. CLC DER ALTEN GRUPPE?
         BL    VGLWEICH                JA, UEBERSPR. BC-MODIFIKATION
         CLC   1(2,R6),BALR1415        KEINE SPRUNGADR EINS IN MODIF GR
         BE    BCITER                  JA, GRUPPE MODIFIZIERT
         CLC   1(2,R6),TRTBALNP+4      GRUPPE D NUM VERAENDERT?
         BE    BCITER                   DANN GRUPPE UEBERGEHEN
         OC    1(2,R6),PDOPPELW        DISPL FUER NEUE GRUPPE NACH BC
         B     BCITER                  NOCH EIN BC VERAENDERN
VGLWEICH NOP   LESSEQU                 WEICHE AUF 1 NACH BATCHEND
         A     R4,AVFOLGE     )        ADR. NEUE GRUPPE IN R4
         ST    R4,CLCALT               ADR. NEUE GRUPPE ABSPEICHERN
         LA    R4,10(R4)               NAECHSTE VFOLGE-ADR NACH R4
         TM    SCHALT,X'01'            VFOLGE-GR 20 LANG?
         BZ    *+8                     OKEY WENN NICHT
         LA    R4,10(R4)               SONST UM
         B     LESKART1                NAECHSTE KARTE LESEN
BATCHEND CLOSE (BATCHDCB,)             CLOSE KARTENDATEI
*  TRTTAB VOR VFOLGE VERAENDERN
         MVC   TRTTAB+193(6),FFFF      A-F IN TRTTAB AUF FF
         MVI   TRTTAB+64,X'FF'         BLANK AUF FF
         CP    KZAEHL,=P'0'            KEINE SUCHKARTE VORGELEGEN?
         BNE   TMDO                    JA, KARTEN VORH.
         ABEND 03                      KEINE SUCHKARTEN VORH
TMDO     TM    SCHALTER,X'0C'          D ODER O VERLANGT?
         BZ    SETVGLW                 NEIN
         B     PROGENDE                PROGENDE BEI D/O UND KARTENENDE
SETVGLW  OI    VGLWEICH+1,X'F0'        WEICHE AUF BRANCH
         MVC   0(4,R4),BLESSEQU        AUFFANG-BRANCH NACH VFOLGE
         LA    R4,10(R4)               ERHOEHEN, ANALOG BEDFOUND+8
         B     UMKEHRG                 SPRUNG INS GRUPPENPROGRAMM
NUMROUT  LA    R3,28(R3)               EIN VWERTE-FELD UEBERGEHEN
         MVC   4(12,R4),TRTBALNP       NEUE INSTRUKTIONSFOLGE GENERIERE
         MVC   5(1,R4),1(R4)           LAENGE AUS CLC NACH TRT MOVEN
         MVC   0(2,R4),LA9             OP-CODE UND REG VON LA 9 EINS.
*      DAS DISPLACEMENT VON CLC STEHT RICHTIG FUER LA 9
         LA    R4,10(R4)               AUF NAE VFOLGE-GRUPPE SETZEN
         B     OC7
NUMROUT2 BE    NUMRET                  ALLES BLANK, WENN BED-SCHL NULL
         LA    R14,0(R14)              LOE HOECHSTES BYTE
         S     R14,=F'10'              R14 RUECKSETZEN UM LEN ADR KOENN
         SR    R2,R2                   LOESCHEN FUER IC
         IC    R2,1(R14)               URSPRUENGL TRT-LEN INS R2
         SR    R2,R1                   MINUS ADR, WO TRT BEENDET
         AR    R2,R9                   PLUS FELDANFANGSADR=RESTLEN F TR
         LA    R14,10(R14)             R14 RESTOREN
         EX    R2,TRTNUM               TRT AUF 0-9 FUER RESTL FELD
         BC    13,NUMRET               SPRUNG BEI ZERO + INCOMPLETE
         TRT   0(1,R1),TRTTAB+48       TRT AUF GUELTIGES VZ-BYTE
NUMRET   LA    R2,VFOLGE               R2 RESTOREN,WAR D TRT ZERST.
         L     R1,SATZ                 R1 EBENFALLS
         BR    14                      RUECKSRUNG AUF NOP IN VFOLGE
TRTNUM   TRT   0(1,R1),TRTTAB   MODELLBEFEHL F TRT AUF F0-F9
ROUT2    CLC   WIEDERH,=C'   '         LAENGE IN SP. 13-15 MUSS GEL S.
         BE    KNSUCHBG                SONST FEHLER
         TRT   SUCHBEGR+1(5),TRTTAB    PRUE HINTER ( AUF 0-9, BIS )
        BE     KNSUCHBG                FEHLER, DA KEINE )
         CLI   0(R1),C')'              ZEI UNGL 0-9 ODER ENDKLAMMER?
         BNE   KNSUCHBG                FEHLER, UNGUELT ZEI VOR )
         LA    R2,SUCHBEGR+1           ADR 1. STELLE INS R2
         SR    R1,R2                   DIFFERENZ = LAENGE
         BCTR  R1,0                    MINUS 1 FUER EX
         EX    R1,PACKLAE2             DISPLACEMENT2 PACKEN
         CVB   R2,PDOPPELW             NACH BINAER
         CH    R2,=H'4096'             DISPL2 GR ALS 4096
         BNL   KNSUCHBG                JA, DANN FEHLER
         STH   R2,4(R4)                DISPL IN CLC ABSPEICHERN
         MVZ   4(1,R4),=X'10'          SATZREG 1 ALS BASISREG IN CLC
         CLI   DISPL,C'*'              FOLGEKARTE F VAR. SUCHEN?
         BNE   *+10                    NEIN, BASISREG 1 IST OK
         MVZ   4(1,R4),=X'70'          R7 ALS BASISREG EINS.
PACK1315 PACK  PDOPPELW,WIEDERH        CLC-LAENGE PACKEN
         CVB   R2,PDOPPELW             NACH BINAER
         CH    R2,=H'256'              LAENGE GR ALS 256?
         BNL   KNSUCHBG                DANN FEHLER
         BCTR  R2,0                    MINUS 1
         STC   R2,1(R4)                ALS LAENGE IN CLC EINSETZEN
         LA    R3,28(R3)               R3 AUF NAE VERGLEICHSFELD
         B     CLCDISPL                IN GEMEINS ZWEIG
PACKLAE2  PACK  PDOPPELW,SUCHBEGR+1(1) MODELLBEFEHL
RETURN4  NI    LESSEQU+1,X'0F'
         L     13,M0001M00+4
         RETURN  (14,12),RC=4          CODE FUER DELETE
LESSEQU  NOP   RETURN4
         L     1,REG1                  LADEN ADR DES DCB
*        GET   (1)
         L     15,48(0,1)              *****
         BALR  14,15                   *****
         ST    1,SATZ
         L     2,REG1
         TM    36(2),X'C0'             RECFM=U?
         BM    BRECFMF                 BEI MIXED F ODER V
* FESTSTELLEN TATSAECHL SATZLAENGE BEI RECFM=U. DER CSW-REST WIRD
* VON DER DCB-BLKSIZE ABGEZOGEN.
         L     R5,68(2)                IOB-PREFIXADR INS R5
         SR    R7,R7                   LOE FUER AUFNAHME HALBWORT
         LH    R7,62(2)                BLKSIZE INS R7
         SH    R7,22(5)                CSW-REST VON BLKSIZE ABZIEHEN
         STH   R7,LRECL                TATSAECHL LAENGE ABSPEICHERN
         MVC   PUTQSAM+62(2),LRECL     AKTUELLE BLKSIZE EINS , LRECL
         MVC   OUTPUT2+62(2),LRECL     WIRD IN SATZAUSG EINGESETZT
BRECFMF  B     RECFMF                  LRECL NICHT VERAENDERN BEI F
         MVC   LRECL,0(1)              SATZLAENGE BEI V NACH LRECL
RECFMF   AP    INZAEHL,=P'1'           ZAEHLEN DER EINGEL SAETZE
         UNPK  DRUBER-5(5),INZAEHL
         OI    DRUBER-1,X'F0'
         TM    SCHALTER,X'01'          BATCH-BIT GELETZT?
         BZ    SATZAUSG                NEIN
         LA    2,VFOLGE
         LA    3,VWERTE
         LA    R15,VROUT2              SPEZ ROUTINE BEI VAR. SUCHEN
         SR    R7,R7                   LOE FUER AUFNAHME HW
         LH    R7,LRECL                SATZLAENGE INS R7
         A     R7,SATZ                 LRECL+SATZADR= SATZENDADR
         BCTR  R7,0                    R7 AUF LETZTES SATZBYTE
         ST    R7,SATZEND              ADRESSE ABSPEICHERN
         LA    R8,SATZAUSG             ADR SATZAUSG IN R8 F BCR 8
         SPACE 5
*  DIE ROUTINE VFOLGE WIRD-FALLS BATCH VERLANGT- BEI JEDEM SATZ DURCH-
*  LAUFEN. ES SIND BIS ZU 100 VERGLEICHE MOEGLICH. ENTSPRECHEND DEN
*  ANGABEN IN DEN SUCHKARTEN WIRD DURCH VGLGENER IN DEN INSTRUKTIONEN
*  MODIFIZIERT: LAENGE UND DISPLACEMENT VON CLC, MASKE UND SPRUNGADRESS
*  VON BC. EIN BRANCH NACH LESSEQ WIRD BEI WENIGER ALS 100 KARTEN
*  HINTER DEN LETZTEN VERGLEICH GELEGT.
VFOLGE   CLC   0(0,1),0(3)
         BC    0,0(0,2)
         CLC   0(0,1),28(3)
         BC    0,0(0,2)
         CLC   0(0,1),56(3)
         BC    0,0(0,2)
         CLC   0(0,1),84(3)
         BC    0,0(0,2)
         CLC   0(0,1),112(3)
         BC    0,0(0,2)
         CLC   0(0,1),140(3)
         BC    0,0(0,2)
         CLC   0(0,1),168(3)
         BC    0,0(0,2)
         CLC   0(0,1),196(3)
         BC    0,0(0,2)
         CLC   0(0,1),224(3)
         BC    0,0(0,2)
         CLC   0(0,1),252(3)
         BC    0,0(0,2)
         CLC   0(0,1),280(3)
         BC    0,0(0,2)
         CLC   0(0,1),308(3)
         BC    0,0(0,2)
         CLC   0(0,1),336(3)
         BC    0,0(0,2)
         CLC   0(0,1),364(3)
         BC    0,0(0,2)
         CLC   0(0,1),392(3)
         BC    0,0(0,2)
         CLC   0(0,1),420(3)
         BC    0,0(0,2)
         CLC   0(0,1),448(3)
         BC    0,0(0,2)
         CLC   0(0,1),476(3)
         BC    0,0(0,2)
         CLC   0(0,1),504(3)
         BC    0,0(0,2)
         CLC   0(0,1),532(3)
         BC    0,0(0,2)
         CLC   0(0,1),560(3)
         BC    0,0(0,2)
         CLC   0(0,1),588(3)
         BC    0,0(0,2)
         CLC   0(0,1),616(3)
         BC    0,0(0,2)
         CLC   0(0,1),644(3)
         BC    0,0(0,2)
         CLC   0(0,1),672(3)
         BC    0,0(0,2)
         CLC   0(0,1),700(3)
         BC    0,0(0,2)
         CLC   0(0,1),728(3)
         BC    0,0(0,2)
         CLC   0(0,1),756(3)
         BC    0,0(0,2)
         CLC   0(0,1),784(3)
         BC    0,0(0,2)
         CLC   0(0,1),812(3)
         BC    0,0(0,2)
         CLC   0(0,1),840(3)
         BC    0,0(0,2)
         CLC   0(0,1),868(3)
         BC    0,0(0,2)
         CLC   0(0,1),896(3)
         BC    0,0(0,2)
         CLC   0(0,1),924(3)
         BC    0,0(0,2)
         CLC   0(0,1),952(3)
         BC    0,0(0,2)
         CLC   0(0,1),980(3)
         BC    0,0(0,2)
         CLC   0(0,1),1008(3)
         BC    0,0(0,2)
         CLC   0(0,1),1036(3)
         BC    0,0(0,2)
         CLC   0(0,1),1064(3)
         BC    0,0(0,2)
         CLC   0(0,1),1092(3)
         BC    0,0(0,2)
         CLC   0(0,1),1120(3)
         BC    0,0(0,2)
         CLC   0(0,1),1148(3)
         BC    0,0(0,2)
         CLC   0(0,1),1176(3)
         BC    0,0(0,2)
         CLC   0(0,1),1204(3)
         BC    0,0(0,2)
         CLC   0(0,1),1232(3)
         BC    0,0(0,2)
         CLC   0(0,1),1260(3)
         BC    0,0(0,2)
         CLC   0(0,1),1288(3)
         BC    0,0(0,2)
         CLC   0(0,1),1316(3)
         BC    0,0(0,2)
         CLC   0(0,1),1344(3)
         BC    0,0(0,2)
         CLC   0(0,1),1372(3)
         BC    0,0(0,2)
         CLC   0(0,1),1400(3)
         BC    0,0(0,2)
         CLC   0(0,1),1428(3)
         BC    0,0(0,2)
         CLC   0(0,1),1456(3)
         BC    0,0(0,2)
         CLC   0(0,1),1484(3)
         BC    0,0(0,2)
         CLC   0(0,1),1512(3)
         BC    0,0(0,2)
         CLC   0(0,1),1540(3)
         BC    0,0(0,2)
         CLC   0(0,1),1568(3)
         BC    0,0(0,2)
         CLC   0(0,1),1596(3)
         BC    0,0(0,2)
         CLC   0(0,1),1624(3)
         BC    0,0(0,2)
         CLC   0(0,1),1652(3)
         BC    0,0(0,2)
         CLC   0(0,1),1680(3)
         BC    0,0(0,2)
         CLC   0(0,1),1708(3)
         BC    0,0(0,2)
         CLC   0(0,1),1736(3)
         BC    0,0(0,2)
         CLC   0(0,1),1764(3)
         BC    0,0(0,2)
         CLC   0(0,1),1792(3)
         BC    0,0(0,2)
         CLC   0(0,1),1820(3)
         BC    0,0(0,2)
         CLC   0(0,1),1848(3)
         BC    0,0(0,2)
         CLC   0(0,1),1876(3)
         BC    0,0(0,2)
         CLC   0(0,1),1904(3)
         BC    0,0(0,2)
         CLC   0(0,1),1932(3)
         BC    0,0(0,2)
         CLC   0(0,1),1960(3)
         BC    0,0(0,2)
         CLC   0(0,1),1988(3)
         BC    0,0(0,2)
         CLC   0(0,1),2016(3)
         BC    0,0(0,2)
         CLC   0(0,1),2044(3)
         BC    0,0(0,2)
         CLC   0(0,1),2072(3)
         BC    0,0(0,2)
         CLC   0(0,1),2100(3)
         BC    0,0(0,2)
         CLC   0(0,1),2128(3)
         BC    0,0(0,2)
         CLC   0(0,1),2156(3)
         BC    0,0(0,2)
         CLC   0(0,1),2184(3)
         BC    0,0(0,2)
         CLC   0(0,1),2212(3)
         BC    0,0(0,2)
         CLC   0(0,1),2240(3)
         BC    0,0(0,2)
         CLC   0(0,1),2268(3)
         BC    0,0(0,2)
         CLC   0(0,1),2296(3)
         BC    0,0(0,2)
         CLC   0(0,1),2324(3)
         BC    0,0(0,2)
         CLC   0(0,1),2352(3)
         BC    0,0(0,2)
         CLC   0(0,1),2380(3)
         BC    0,0(0,2)
         CLC   0(0,1),2408(3)
         BC    0,0(0,2)
         CLC   0(0,1),2436(3)
         BC    0,0(0,2)
         CLC   0(0,1),2464(3)
         BC    0,0(0,2)
         CLC   0(0,1),2492(3)
         BC    0,0(0,2)
         CLC   0(0,1),2520(3)
         BC    0,0(0,2)
         CLC   0(0,1),2548(3)
         BC    0,0(0,2)
         CLC   0(0,1),2576(3)
         BC    0,0(0,2)
         CLC   0(0,1),2604(3)
         BC    0,0(0,2)
         CLC   0(0,1),2632(3)
         BC    0,0(0,2)
         CLC   0(0,1),2660(3)
         BC    0,0(0,2)
         CLC   0(0,1),2688(3)
         BC    0,0(0,2)
         CLC   0(0,1),2716(3)
         BC    0,0(0,2)
         CLC   0(0,1),2744(3)
         BC    0,0(0,2)
         CLC   0(0,1),2772(3)
         BC    0,0(0,2)
BLESSEQU B     TRENWEI2
* SPEZIELLE ROUTINE, DIE AUS VFOLGE AUFGERUFEN WIRD, ENN DISPL
* DES SUCHBEGRIFFES IM SATZ NICHT FESTSTEHT
VROUT2   BE    VRETOUT                 VGLERGEBNIS AUS CLC IN VFOLGE =?
         LA    R7,1(R7)                AUF NAE SATZBYTE
         C     R7,SATZEND              BEREITS SATZENDE ERREICHET?
         BH    VRETOUT                 SPRUNG BEI JA, BEDSCHL AUF UNGL
         LA    R14,0(R14)              LOE HOECHSTES REGISTERBYTE
         S     R14,=F'8'               R14 AUF CLC ZURUECKSTELLEN
         BR    R14                     CLC AB NAE STELLE WIEDERHOLEN
VRETOUT  MVC   *+9(1),1(R14)           LAENGE AUS CLC EINSETZEN
         LA    R7,1(R7)                R7 AUF ADRESSE HINTER GES.
         LA    R7,1(R7)                WERT BRINGEN BEI GEF. + NICHT GF
         LA    R14,6(R14)              RUECKSP AUF BC D NAE GRUPPE VBER
         BR    R14                     RUECKSP M RICHTIGEM BED-SCHL
VWERTE   DC    100XL28'00'             DIE SUCHBEGR SIND I D MAX 100
*                                      FELDERN GESPEICHERT
SATZAUSG LA    R14,0(R14)              LOE HOECHSTES BYTE
         SR    R7,R7                   ZAEHLREGISTER LOESCHEN
ITERATIO CLC   0(2,R14),BALR1415       ZUSAETZL VFOLGE-GR F VAR SUCHEN?
         BE    SR14                    DANN UM EINE GRUPPE ZURUECK
          CLC  0(2,R14),TRTBALNP+4     VFOLGE-GRUPPE F NUM?
         BE    SR14                    DANN ZURUECKSETZEN
         LA    R7,1(R7)                PLUS 1 FUER JEDE GUELTIGE GRUPPE
SR14     S     R14,=F'10'              ZURUECK AUF DAVORLIEGENDE GRUPPE
         CR    R14,R2                  VFOLGE-ANFANGSADR ERREICHT?
         BNL   ITERATIO                NEIN, WEITER
         CVD   R7,PDOPPELW             REG-STAND=BATCHID CONVERTIEREN
         UNPK  BATCHID(3),PDOPPELW+6(2) ENTPACKT IN SEP FELD BEREITZST
         MVZ   BATCHID+2(1),=X'F0'     VZ-BYTE AUF F BRINGEN
         AP    AUSZAEHL,=P'1'          ZAEHLER SEL SAETZE +1
         TM    SCHALTER,X'40'          S-BIT GESETZT?
         BO    PUTS                    JA, AUSGEBEN
WEICHE15 B     BALDRU                  GEN. DRUCKEN WENN WEDER C NOCH H
         TM    SCHALTER,X'30'          BEI E NUR, WENN C ODER H
         BZ    SORTEXIT                NEIN, KEIN DRUCK
BALDRU   BAL   9,DRUCK                 DRUCKEN
         TM    START+1,X'F0'           LAUFT DATEX ALS SORTEXIT?
         BZ    LESSEQU                 NEIN, NORMAL
SORTEXIT L     1,SATZ                   SATZADR INS R1 FUER SORT
NOPSORT  NOP   RETURN12                AUF NOP NUR WENN SATZZAEHLUNG
         SP    PZAEHL,=P'1'
         BZ    ENDWEI
RETURN12 L     13,M0001M00+4
         MVC   24(4,13),SATZ
         RETURN  (14,12),RC=12        CODE FUER EINFUEGEN
PUTS     LA    1,PUTQSAM    DCBOUT
         MVC   82(2,1),LRECL
         L     0,SATZ
*        PUT   (1),(0)
         L     15,48(0,1)              *****
         BALR  14,15                   *****
         TM    SCHALTER,X'30'          C ODER H VERLANGT?
         BZ    *+8                     NEIN, KEIN DRUCK ZUS Z SELEKT.
         BAL   9,DRUCK                 DRUCKEN
         TM    START+1,X'F0'           LAUFT DATEX ALS SORTEXIT
         BO    SORTEXIT                JA
NOPLESEQ NOP   LESSEQU
         SP    PZAEHL,=P'1'
         BZ    PROGENDE
         B     LESSEQU
TRENWEI2 B     LESSEQU
         LA    1,OUTPUT2
         MVC   82(2,1),LRECL
         L     0,SATZ
         PUT   (1),(0)
         B     LESSEQU
ABEND20  ABEND  20
         SPACE 5
DRUCK    LH    5,LRECL                 LRECL EING.SATZ IN R5
         L     8,SATZ                  SATZADR. IN R8
         LA    2,DRUBER                DRUBERADR. IN R8
         SR    6,6                     LOESCHEN R6
DRWEICHE NOP   DRWON                   DRWEICHE AUF NOP BEI DRUCKBEGINN
         OI    DRWEICHE+1,X'F0'        DRWEICHE AUF B DRWON
HEXOCHAR NOP   CHARDR1                 AUF NOP WENN KEIN C-OUTPUT
         PUT   OUTPUT,RASTER-1         VORSCHUB KANAL1
         PUT   OUTPUT,RASTER           DRUCKEN NORMALES RASTER
         B     D020
CHARDR1  PUT   OUTPUT,CHRASTER-1       VORSCHUB KANAL1
         PUT   OUTPUT,CHRASTER         DRUCKEN C-RASTER
         B     D030                    VERZW. NACH C-DRUCK
DRWON    NOP   D030                    DRWON STEUEET VERZW. NACH
         B     D020                    D030/D020 AB 2. SATZ
TTR      DC    10X'00'
D020     CH    5,=H'50'                IST REST LRECL < 50
         BL    SATZKLNR                JA, KURZZEILE
         SPACE 3
* ENTPACKEN UND UEBERSETZEN VON 50 BYTES IN 10 BLOECKEN MIT 1 BLANK
* ZWISCHENRAUM. BEI KURZZEILEN WIRD DURCH BEFEHLSMDIF. AUS BLEISTE
* DIE UNPACK-ROUTINE NACH DEM 1.-10. BLOCK VERLASSEN
UNPACK   UNPK  DRUBER+1(11),0(6,8)
         TR    DRUBER+1(10),TAB-240
         MVI   DRUBER+11,X'40'
         UNPK  DRUBER+12(11),5(6,8)
         TR    DRUBER+12(10),TAB-240
         MVI   DRUBER+22,X'40'
         UNPK  DRUBER+23(11),10(6,8)
         TR    DRUBER+23(10),TAB-240
         MVI   DRUBER+33,X'40'
         UNPK  DRUBER+34(11),15(6,8)
         TR    DRUBER+34(10),TAB-240
         MVI   DRUBER+44,X'40'
         UNPK  DRUBER+45(11),20(6,8)
         TR    DRUBER+45(10),TAB-240
         MVI   DRUBER+55,X'40'
         UNPK  DRUBER+56(11),25(6,8)
         TR    DRUBER+56(10),TAB-240
         MVI   DRUBER+66,X'40'
         UNPK  DRUBER+67(11),30(6,8)
         TR    DRUBER+67(10),TAB-240
         MVI   DRUBER+77,X'40'
         UNPK  DRUBER+78(11),35(6,8)
         TR    DRUBER+78(10),TAB-240
         MVI   DRUBER+88,X'40'
         UNPK  DRUBER+89(11),40(6,8)
         TR    DRUBER+89(10),TAB-240
         MVI   DRUBER+99,X'40'
         UNPK  DRUBER+100(11),45(6,8)
         TR    DRUBER+100(10),TAB-240
         MVI   DRUBER+110,X'40'
         SPACE 3
* BYTEWEISE ENTNAHME DES BETR. ZEICHENS AUS TRANSTAB UND EINSPEICHERN
* IN DRUBER1 FUER C-ZEILE, ROUTINE WIRD VERLASSEN BEI KURZZEILE DURCH
* MODIFIKATION AUS HEXCHAR3
HEXCHAR2 NOP   NOCHAR                  HEXCHAR AUF NOP WENN H+C VERL.
ICLEISTE IC    6,0(0,8)
         IC    6,TRANSTAB(6)
         STC   6,DRUBER1+2
         IC    6,1(0,8)
         IC    6,TRANSTAB(6)
         STC   6,DRUBER1+4
         IC    6,2(0,8)
         STC   6,DRUBER1+6
         IC    6,TRANSTAB(6)
         IC    6,3(0,8)
         IC    6,TRANSTAB(6)
         STC   6,DRUBER1+8
         IC    6,4(0,8)
         IC    6,TRANSTAB(6)
         STC   6,DRUBER1+10
         IC    6,5(0,8)
         IC    6,TRANSTAB(6)
         STC   6,DRUBER1+13
         IC    6,6(0,8)
         IC    6,TRANSTAB(6)
         STC   6,DRUBER1+15
         IC    6,7(0,8)
         IC    6,TRANSTAB(6)
         STC   6,DRUBER1+17
         IC    6,8(0,8)
         IC    6,TRANSTAB(6)
         STC   6,DRUBER1+19
         IC    6,9(0,8)
         IC    6,TRANSTAB(6)
         STC   6,DRUBER1+21
         IC    6,10(0,8)
         IC    6,TRANSTAB(6)
         STC   6,DRUBER1+24
         IC    6,11(0,8)
         IC    6,TRANSTAB(6)
         STC   6,DRUBER1+26
         IC    6,12(0,8)
         IC    6,TRANSTAB(6)
         STC   6,DRUBER1+28
         IC    6,13(0,8)
         IC    6,TRANSTAB(6)
         STC   6,DRUBER1+30
         IC    6,14(0,8)
         IC    6,TRANSTAB(6)
         STC   6,DRUBER1+32
         IC    6,15(0,8)
         IC    6,TRANSTAB(6)
         STC   6,DRUBER1+35
         IC    6,16(0,8)
         IC    6,TRANSTAB(6)
         STC   6,DRUBER1+37
         IC    6,17(0,8)
         IC    6,TRANSTAB(6)
         STC   6,DRUBER1+39
         IC    6,18(0,8)
         IC    6,TRANSTAB(6)
         STC   6,DRUBER1+41
         IC    6,19(0,8)
         IC    6,TRANSTAB(6)
         STC   6,DRUBER1+43
         IC    6,20(0,8)
         IC    6,TRANSTAB(6)
         STC   6,DRUBER1+46
         IC    6,21(0,8)
         IC    6,TRANSTAB(6)
         STC   6,DRUBER1+48
         IC    6,22(0,8)
         IC    6,TRANSTAB(6)
         STC   6,DRUBER1+50
         IC    6,23(0,8)
         IC    6,TRANSTAB(6)
         STC   6,DRUBER1+52
         IC    6,24(0,8)
         IC    6,TRANSTAB(6)
         STC   6,DRUBER1+54
         IC    6,25(0,8)
         IC    6,TRANSTAB(6)
         STC   6,DRUBER1+57
         IC    6,26(0,8)
         IC    6,TRANSTAB(6)
         STC   6,DRUBER1+59
         IC    6,27(0,8)
         IC    6,TRANSTAB(6)
         STC   6,DRUBER1+61
         IC    6,28(0,8)
         IC    6,TRANSTAB(6)
         STC   6,DRUBER1+63
         IC    6,29(0,8)
         IC    6,TRANSTAB(6)
         STC   6,DRUBER1+65
         IC    6,30(0,8)
         IC    6,TRANSTAB(6)
         STC   6,DRUBER1+68
         IC    6,31(0,8)
         IC    6,TRANSTAB(6)
         STC   6,DRUBER1+70
         IC    6,32(0,8)
         IC    6,TRANSTAB(6)
         STC   6,DRUBER1+72
         IC    6,33(0,8)
         IC    6,TRANSTAB(6)
         STC   6,DRUBER1+74
         IC    6,34(0,8)
         IC    6,TRANSTAB(6)
         STC   6,DRUBER1+76
         IC    6,35(0,8)
         IC    6,TRANSTAB(6)
         STC   6,DRUBER1+79
         IC    6,36(0,8)
         IC    6,TRANSTAB(6)
         STC   6,DRUBER1+81
         IC    6,37(0,8)
         IC    6,TRANSTAB(6)
         STC   6,DRUBER1+83
         IC    6,38(0,8)
         IC    6,TRANSTAB(6)
         STC   6,DRUBER1+85
         IC    6,39(0,8)
         IC    6,TRANSTAB(6)
         STC   6,DRUBER1+87
         IC    6,40(0,8)
         IC    6,TRANSTAB(6)
         STC   6,DRUBER1+90
         IC    6,41(0,8)
         IC    6,TRANSTAB(6)
         STC   6,DRUBER1+92
         IC    6,42(0,8)
         IC    6,TRANSTAB(6)
         STC   6,DRUBER1+94
         IC    6,43(0,8)
         IC    6,TRANSTAB(6)
         STC   6,DRUBER1+96
         IC    6,44(0,8)
         IC    6,TRANSTAB(6)
         STC   6,DRUBER1+98
         IC    6,45(0,8)
         IC    6,TRANSTAB(6)
         STC   6,DRUBER1+101
         IC    6,46(0,8)
         IC    6,TRANSTAB(6)
         STC   6,DRUBER1+103
         IC    6,47(0,8)
         IC    6,TRANSTAB(6)
         STC   6,DRUBER1+105
         IC    6,48(0,8)
         IC    6,TRANSTAB(6)
         STC   6,DRUBER1+107
         IC    6,49(0,8)
         IC    6,TRANSTAB(6)
         STC   6,DRUBER1+109
         IC    6,0(0,0)
         SPACE 3
NOCHAR   LA    8,50(8)                 LAUFREG. 8 UM 50 ERHOEHEN
         SH    5,=H'50'                LRECL-REG. MINUS 50
         B     D022A                   UEBERSPRINGEN KURZSATZROUTINEN
         SPACE 5
SATZKLNR LA    15,LSCHBACK             ADR. FUER SPRUNG AUS UNPACK IN R
         SLL   5,1(0)                  VERDOPPELN LRECL-REGISTER,ENTH.
*                                      JETZT 2-98
         LH    6,AENDWRTE(5)           2 BYTES FUER INDIZ. AUS AENDWRTE
         SRDL  6,8(0)                  ISOLIEREN LINKES BYTE
         B     BLEISTE(6)              VERZW. INDIZIERT D L. BYTE
         SPACE 2
* UEBERSCHREIBEN DES AUF DEN LETZTEN BLOCK FOLGENDEN MVI DURCH EIN
* BALR 14,15. DADURCH ERFOLGT VERZW. AUS UNPACK NACH LSCHBACK.
* UEBER REG 14 KANN DAS MVI WIEDER ZURUECKGESCHRIEBEN WERDEN
BLEISTE  MVC   UNPACK+12(2),BALR
         B     UNPACK
         MVC   UNPACK+28(2),BALR
         B     UNPACK
         MVC   UNPACK+44(2),BALR
         B     UNPACK
         MVC   UNPACK+60(2),BALR
         B     UNPACK
         MVC   UNPACK+76(2),BALR
         B     UNPACK
         MVC   UNPACK+92(2),BALR
         B     UNPACK
         MVC   UNPACK+108(2),BALR
         B     UNPACK
         MVC   UNPACK+124(2),BALR
         B     UNPACK
         MVC   UNPACK+140(2),BALR
         B     UNPACK
         MVC   UNPACK+156(2),BALR
         B     UNPACK
         DS    0H
BALR     DC    XL2'05EF'
TAB      DC    C'0123456789ABCDEF'
         DS    0H
         SPACE 2
* TABELLE ENTHAELT AB 2. HALBWORT INDEXWERTE. LINKES BYT IST
* DISPLACEMENT FUER VERZW. NACH BLEISTE, RECHTES BYTE IST
* DISPLACEMENT IN DRUBER FUER LOESCHEN DER ZUVIEL UEBERSETZTEN BYTES
AENDWRTE DC    X'00000003000500070009000B0A0E0A100A120A140A161419141B'
         DC    X'141D141F14211E241E261E281E2A1E2C282F2831283328352837'
         DC    X'323A323C323E324032423C453C473C493C4B3C4D465046524654'
         DC    X'46564658505B505D505F506150635A665A685A6A5A6C5A6E'
SPACES   DC    XL9'404040404040404040'
         SPACE 2
* LOESCHEN DER ZUVIEL UEBERSETZTEN BYTES IN DRUBER BEI H-ZEILE
LSCHBACK SR    6,6                     LOESCHEN LINKES BYTE
         SLDL  6,8(0)                  RECHTES BYTE IN R6
         AR    6,2                     DRUBER-ADR. AUFADDIEREN
         MVC   0(9,6),SPACES           LOESCHEN MAX. 9 BYTES
         SH  14,=H'2'                  MVI-ADR. IN REG14
         MVC   0(2,14),=X'9240'        MVI ZURUECKSCHREIBEN
         SPACE 2
* KURZZEILENBEHANDLUNG DER C-ZEILE
HEXCHAR3 NOP   NOCHAR2
         LA    15,CHAREXIT             VERZW. ADR. IN R15
         LR    14,5                    LRECL-REG. MULTIPL.
         SLL   5,2(0)                  MIT 6 ERGIBT DISPLACEMENT
         AR    5,14                    FUER AENDERUNG IN ICLEISTE
         AR    5,14
         LH    14,BALR
         STH   14,ICLEISTE(5)          BALR 14,15 NACH ICLEISTE
         SR    6,6                     LOESCHEN RECHTES BYTE
         B     ICLEISTE                VERZW. NACH ICLEISTE
CHAREXIT SH    14,=H'2'
         MVC   0(2,14),ICLEISTE        STC ZURUECKSCHREIBEN
         SPACE 5
* VORSCHUBSTEUERUNG, DRUCKEN,LOESCHEN UND ZEILENZAEHLUNG
NOCHAR2  SR    5,5                     LOESCHEN R5, DA SATZENDE
D022A    NOP   NURHEX                  D022A AUF B WENN NRU HEX
         MVI   DRUBER-6,X'09'          ZT1 FUER H-ZEILE
         PUT   OUTPUT,DRUBER-6         DRUCKEN H-ZEILE
         CH    5,=H'0'                 SATZENDE?
         BNE   D024                    NEIN
         MVI   DRUBER1-6,X'19'         ZT3 FUER C-ZEILE WENN SATZENDE
         MVC   DRUBER1+122(3),BATCHID  BATCHKARTENID RECHTS NEBEN LETZT
*  C-ZEILE AUSDRUCKEN
         PUT   OUTPUT,DRUBER1-6        DRUCKEN C-ZEILE
         SP    OUTZAEHL,=P'4'          LINE-COUNTER MINUS 4
         B     LSCHDR1                 VERZW. NACH LOESCHEN
D024     MVI   DRUBER1-6,X'11'         ZT2 FUER C-ZEILE
         PUT   OUTPUT,DRUBER1-6        DRUCKEN Z-ZEILE
         SP    OUTZAEHL,=P'3'          LINE-COUNTER MINUS 3
LSCHDR1  MVI   DRUBER-5,X'40'
         MVC   DRUBER-4(136),DRUBER-5
         MVC   DRUBER1-6(138),DRUBER1-7
         B     ZZAEHLG                 UEBERSPR. ROUTIN H-DRUCK
         SPACE 2
NURHEX   CH    5,=H'0'                 D  SATZENDE?
         BNE   D025                    NEIN
         MVI   DRUBER-6,X'19'          ZT3 FUER H-ZEILE WENN SATZENDE
         MVC   DRUBER+122(3),BATCHID   BATCHID RECHTS BEBENLETZT H-ZEI
         PUT   OUTPUT,DRUBER-6         DRUCKEN H-ZEILE
         SP    OUTZAEHL,=P'3'          LINE-COUNTER MINUS 3
         B     LSCHDR2                 VERZW. NACH LOESCHEN
D025     MVI   DRUBER-6,X'11'          ZT2 FUER H-ZEILE
         PUT   OUTPUT,DRUBER-6         DRUCKEN H-ZEILE
         SP    OUTZAEHL,=P'2'          LINE-COUNTER MINUS 2
LSCHDR2  MVI   DRUBER-5,X'40'
         MVC   DRUBER-4(136),DRUBER-5  LOESCHEN DRUBER
         SPACE 2
ZZAEHLG  B     NOZZAEHL                WEICHE AUF NOP WENN Z VERL.
         SP    PZEILENZ,=P'1'          PZEILENZ MINUS 1 AUCH BEI H+C
         BZ    PROGENDE                VERZW. NACH ENDROUTINE WENN NULL
NOZZAEHL CP    OUTZAEHL,=P'2'          LINECOUNTER KLEINER 2
         BNL   SATZENDQ                NEIN
         ZAP   OUTZAEHL,=P'58'         LINECOUNTER AUF 58 SETZEN
         PUT   OUTPUT,RASTER-1         VORSCHUB KANAL 1
         PUT   OUTPUT,RASTER           DRUCKEN RASTER
SATZENDQ CH    5,=H'0'                 WAR SATZENDE?
         BNE   D020                    NEIN
NOPR90   NOPR  9
         SP    PZAEHL,=P'1'            SATZZAEHLER MINUS 1
         BZ    ENDWEI                  ENDE, WENN NU
         BR    9                       JA, VERLASSE DRUCKROUTINE
         SPACE 5
D030     CH    5,=H'120'               REST LRECL < 120 ?
         BL    KURZSATZ                JA
         SH    5,=H'120'               LRECL-REGISTER MINUS 120
         MVI   UEBERTR+1,X'77'         119 ALS MVC-LAENGE
         MVI   TR+1,X'77'              119 ALS TR-LAENGE
         B     UEBERTR                 UEBERSPR. KURTZSATZROUTINE
KURZSATZ BCTR  5,0                     LRECL-REG. MINUS 1
         STC   5,TR+1                  ALS LAENGE IN TR EINSETZEN
         STC   5,UEBERTR+1             ALS LAENGE IN MVC EINSETZEN
         SR    5,5                     LOESCHEN LRECL-REGISTER
UEBERTR  MVC   DRUBER(120),0(8)        UEBERTR. IN DRUBER
TR       TR    DRUBER(120),TRANSTAB    TRANSLATE, PUNKTE STATT SONDERZ.
         CH    5,=H'0'                 SATZENDE ?
         BE    D031                    JA
         MVI   DRUBER-1,X'09'          ZT1 EINSETZEN
         SP    OUTZAEHL,=P'1'          LINECOUNTER MINUS 1
         B     PUTOUT
D031     MVI   DRUBER-1,X'11'          BEI SATZENDE ZT2
         SP    OUTZAEHL,=P'2'          LINECOUNTER MINUS 2
PUTOUT   PUT   OUTPUT,DRUBER-1         DRUCKEN
         LA    8,120(8)                SATZREGISTER UM 120 ERHOEHEN
         MVI   DRUBER,X'40'            LOESCHEN DRUBER
         MVC   DRUBER+1(124),DRUBER
ZZAEHLG2 B     NOZZ2                   WEICHE AUF NOP, WENN Z ANGEG.
         SP    PZEILENZ,=P'1'          ZEILENZAEHL MINUS 1,AUCH BEI ZT2
         BZ    PROGENDE                ENDE WENN NULL
NOZZ2    CP    OUTZAEHL,=P'1'          LINECOUNTER < 1
         BNL   SATZEND2                NEIN
         ZAP   OUTZAEHL,=P'58'         58 IN LINECOUNTER
         PUT   OUTPUT,CHRASTER-1       VORSCHUB NACH KANAL 1
         PUT   OUTPUT,CHRASTER         DRUCKEN RASTER FUER C-ZEILE
SATZEND2 CH    5,=H'0'                 SATZENDE ?
         BNE   D030                    NEIN, NAECHSTE ZEILE
NOPR91   NOPR  9
         SP    PZAEHL,=P'1'            SATZZAEHLER MINUS 1
         BZ    ENDWEI                  ENDE, WENN NULL
         BR    9                       JA , NAECHSTER SATZ
         SPACE 5
ORROUT   GET   BATCHDCB                LESEN  BATCHKARTE
         LR    R2,R1                   UMLADEN SATZADRESSE
         AP    KZAEHL,=P'1'
         MVI   TRTTAB+64,X'FF'         FUNKTIONSBYTE BLANK AUF FF
         TRT   15(12,R2),TRTTAB        PRUEFEN OB ZEICHEN UNGL A-F,0-9
         BNE   KNSUCHBG                SPRUNG NACH ABEND 04
         LA    R4,6                    REG FUER AUSSERE SCHLEIFE AUF 6
         LA    R1,17(R1)               ERFORDERL WEGEN DISPL 9 IN CONVT
         B     SET32                   VERZW IN CONVT-ROUTINE
BISAMRD  READ  DECB2,K,BISAM,'S','S',TTR
         WAIT  ECB=DECB2
         TM    DECB2+24,B'11111101'    LESEN FEHLERFREI?
         BZ    READOKEY                JA, BDAMSATZ LESEN
         MVI   DRUBER,X'09'
         MVC   DRUBER+1(29),0(R2)      KARTE NACH DRUBER
         TM    DECB2+24,B'10000000'    SATZ NICHT GEFUNDEN?
         BZ    BISAMCHK                NEIN, ANDERE FEHLERART
         MVC   DRUBER+31(24),=C'OADR-SATZ NICHT GEFUNDEN'
         B     PUTBDMSG                DRUCKEN MESSAGE
BISAMCHK MVC   DRUBER+31(32),=C'AUSNAHMEBEDINGUNG BEI BISAM-READ'
         B     PUTBDMSG                DRUCKEN MESSAGE
READOKEY FREEDBUF DECB2,K,BISAM        PUFFER NACH READ FREIGEBEN
         L     R4,DECB2+16             SATZADRESSE NACH R4
         MVC   TTR(3),0(R4)            TTR AUS OADR-SATZ UEBERTRAGEN
         B     BDAMREAD                LESEN BDAMSATZ
         SPACE 5
TTRROUT  GET   BATCHDCB                LESEN TTR-KARTE
         LR    R2,R1                   UMLADEN PUFFERADR
         AP    KZAEHL,=P'1'
         CLC   0(4,1),=C'TTR='         IST ES EINE TTR-KARTE?
         BE    TTRCONVT                JA, UMFORMEN TTR
         MVI   DRUBER,X'09'            GEAENDERT AM 11.8.68
         MVC   DRUBER+1(18),0(2)       GEAENDERT AM 11.8.68
 MVC DRUBER+20(37),=C'KARTE NICHT MIT TTR= GEKENNZEICHNET'
PUTBDMSG PUT   OUTPUT,DRUBER
         MVI   DRUBER,X'40'            GEAENDERT AM 11.8.68
         MVC   DRUBER+1(79),DRUBER     GEAENDERT AM 11.8.68
         TM    SCHALTER,X'08'          WAR O-PARAM GESETZT?
         BO    ORROUT                  JA, LESEN KARTE
         B     TTRROUT
TTRCONVT MVI   TRTTAB+64,X'FF'         FUNKTIONSBYTE BLANK AUF FF
         TRT   4(6,1),TRTTAB           PRUEFEN OB ZEICHEN UNGL A-F,0-9
         BE    LA43                    SPRUNG UEBER MESSAGE
         MVI   DRUBER,X'09'
         MVC   DRUBER+1(29),0(2)
         MVC   DRUBER+31(18),=C'TTR FALSCH GELOCHT'
         B     PUTBDMSG                DRUCKEN MESSAGE
LA43     LA    R4,3                    REG FUER AUSSERE SCHLEIGE AUF 3
SET32    LA    R3,2                    REG FUER INNERE SCHLEIFE AUF 2
         IC    R6,9(R1)                RECHTESTES ZEICHEN IN R6
         TM    9(R1),X'F0'             ZIFFE 0-9 IN BYTE
         BO    SRDL                    JA,UEBERSPR. ADDITION
         LA    R6,9(R6)                ADDIEREN 9, ERG A-F
SRDL     SRDL  R6,4                    ISOLIERE RECHTES HALBBYTE IN R7
         BCTR  R1,0                    R1 MINUS 1
         BCT   R3,SET32+4              INNERE SCHLEIFE
         SLDL  R6,8                    GANZES HEX-BYTE RUECKHOLEN
         STC   R6,TTR-1(R4)            ABSPEICHERN IN TTR-FELD
         BCT   R4,SET32                AUSSERE SCHLEIFE
         TM    SCHALTER,X'08'          WAR O-PARAM GESETZT?
         BO    BISAMRD                 JA, LESEN OADR-SATZ
BDAMREAD READ  DECB1,DI,BDAM,'S','S',0,TTR
         CHECK DECB1
         MVC   SATZ,DECB1+12           ADR E/A-BEREICH NACH SATZ
         MVC   LRECL,DECB1+6           SATZLAENGE NACH LRECL
         BAL   9,DRUCK                 DRUCKEN SATZ
         FREEDBUF DECB1,D,BDAM         PUFFER FUER NEUES LESEN FREIGEB.
         TM    SCHALTER,X'08'          WAR O-PARAM GESETZT?
         BO    ORROUT                  JA
         B     TTRROUT                 RUECKSPR NACH LESEN TTR-KARTE
SYN      FREEDBUF DECB1,D,BDAM         PUFFER FUER NEUES LESEN FREIGEB.
C031     MVI   DRUBER,X'09'            GEAENDERT AM 11.8.68
         MVC   DRUBER+1(29),0(2)       GEAENDERT
         MVC   DRUBER+31(31),=C'AUSNAHMEBEDINGUNG BEI BDAM-READ'
         B     PUTBDMSG
ENDWEI   B     PROGENDE
         OI    START2+1,X'F0'          BEIM NAE AUFRUF AUS SORT,GEHTS E
*                                      SOFORT NACH ENDE
         B     RETURN12                LETZTEN SATZ NOCH AN SORT GEBEN
PROGENDE TM    SCHALTER,X'08'
         BZ    TMBDAM
         CLOSE (BISAM,)
         B     CLOSBDAM
TMBDAM   TM    SCHALTER,X'04'
         BZ    SAMCLOS
CLOSBDAM CLOSE (BDAM,)
         B     CLOSOUTP
SAMCLOS  TM    SCHALTER,X'02'
         BZ    QSAMCLOS
         CLOSE (ISAMDCB,)
         B     TMSELECT
QSAMCLOS CLOSE (QSAMDCB,)
TMSELECT TM    SCHALTER,X'40'
         BZ    OUT2CLOS
         CLOSE (PUTQSAM,)
OUT2CLOS TM    TRENWEI1+1,X'F0'        WAR TRENNEN?
         BO    SATZMSG                 DANN KEIN CLOSE OUTPUT2
         CLOSE  (OUTPUT2,)
SATZMSG  MVI   DRUBER,X'09'            VORSCHUBZEICHEN IN DRUCKBER
         MVC   DRUBER+1(42),=C'SAETZE GELESEN:         SELEKTIERT:     *
                 '
         UNPK  DRUBER+16(7),INZAEHL    ANZAHL GEL SAETZE IN DRUCKBER
         OI    DRUBER+22,X'F0'         ZONE ANGLEICHEN
         UNPK  DRUBER+36(7),AUSZAEHL   ANZAHL SEL SAETZE IN DRUCKBER
         OI    DRUBER+42,X'F0'         VZ-ZONE ANGLEICHEN
         PUT   OUTPUT,DRUBER           DRUCKEN MESSAGE
CLOSOUTP CLOSE (OUTPUT,)
         TM    START+1,X'F0'           DATEX ALS SORTEXIT?
         BZ    END99                   NEIN
         L     13,M0001M00+4
         RETURN (14,12),RC=8           CODE FUER SCHLUSS
         B     END99
         SPACE  5
SYNINPUT MVI   DRUBER,X'09'            VORSCHUBZEICHEN NACH DRUBER
         MVC   DRUBER+1(29),=C'AUSNAHMEBEDINGUNG BEI INPUT '
         B     SYN001
SYNOUTP1 MVI   DRUBER,X'09'            VORSCHUBZEICHEN NACH DRUBER
         MVC   DRUBER+1(29),=C'AUSNAHMEBEDINGUNG BEI OUTPUT1'
SYN001   ST    14,REG1                  SAVEN REG 14
         ST    13,SYNSAVE+4
         LA    13,SYNSAVE
         AP    SYNF01,=P'1'
         CP    SYNF01,=P'10'
         BH    SYN002
         PUT   OUTPUT,DRUBER
         MVI   DRUBER,X'40'            LOESCHEN DRUBER
         MVC   DRUBER+1(79),DRUBER
         L     13,SYNSAVE+4
         L   14,REG1                   RESTOREN  R14
         BR    14                      RUECKSPRUNG AUS SYNAD
SYN002   EQU   *
         MVC   DRUBER+1(48),=C'MEHR ALS 10 AUSNAHMEBEDINGUNGEN. PROGRAM*
               MABBRUCH'
         PUT   OUTPUT,DRUBER
         L     13,SYNSAVE+4
         ABEND 30,DUMP
SYNF01   DC    P'000'
SYNSAVE  DS    18F
         SPACE 5
TRANSTAB DC    64C'.'
         DC    X'40'
         DC    12C'.'
         DC    C'(+'
         DC    13C'.'
         DC    C'*)'
         DC    C'..'
         DC    C'-/'
         DC    9C'.'
         DC    C','
         DC    18C'.'
         DC    C'='
         DC    C'..'
         DC    X'818283848586878889'
         DC    7C'.'
         DC    X'919293949596979899'
         DC    8C'.'
         DC    X'A2A3A4A5A6A7A8A9'
         DC    23C'.'
         DC    X'C1C2C3C4C5C6C7C8C9'
         DC    7C'.'
         DC    X'D1D2D3D4D5D6D7D8D9'
         DC    8C'.'
         DC    X'E2E3E4E5E6E7E8E9'
         DC    6C'.'
         DC    C'0123456789'
         DC    6C'.'
SCHALTER DC    B'00000000'
SZ       DC    X'4A4B4C4D4E4F50'
         DC    9C'.'
         DC    X'5A5B5C5D5E5F6061'
         DC    9C'.'
         DC    X'6B6C6D6E6F'
         DC    10C'.'
         DC    X'7A7B7C7D7E7F'
AUSZAEHL DC    P'0000000'
INZAEHL  DC    P'0000000'
REG1     DC    F'0'      ADRESSE DES ENTSPRECHENDEN INPUTDCB
LRECL    DC    H'0'
SATZ     DC    F'0'
SCHALT   DC    X'00'
BLKSIZE  DC    XL2'00'
RECFM    DC    X'00'
         DC    B'10001011'
         DC    5X'40'
DRUBER   DC    CL132' '
         DC    6X'40'
DRUBER1  DC    132C' '
         DC    B'10001011'
RASTER   DC    X'11'
         DC    XL6'404040404040'
         DC    C'01 . . .05'
         DC    C' '
         DC    C'06 . . .10'
         DC    C' '
         DC    C'11 . . .15'
         DC    C' '
         DC    C'16 . . .20'
         DC    C' '
         DC    C'21 . . .25'
         DC    C' '
         DC    C'26 . . .30'
         DC    C' '
         DC    C'31 . . .35'
         DC    X'40'
         DC    C'36 . . .40'
         DC    X'40'
         DC    C'41 . . .45'
         DC    C' '
         DC    C'46 . . .50'
         DC    XL11'4040404040404040404040'
         DC    10X'40'
         DC    B'10001011'
CHRASTER DC    X'11'
         DC    C'1'
         DC    9C'.'
         DC    C'11'
         DC    8C'.'
         DC    C'21'
         DC    8C'.'
         DC    C'31'
         DC    8C'.'
         DC    C'41'
         DC    8C'.'
         DC    C'51'
         DC    8C'.'
         DC    C'61'
         DC    8C'.'
         DC    C'71'
         DC    8C'.'
         DC    C'91'
         DC    8C'.'
         DC    C'101'
         DC    7C'.'
         DC    C'111'
         DC    7C'.'
         DC    7X'40'
* DIE KARTEN FFFF BIS 38 X'FF' MUESSEN HINTEREINANDER LIEGEN
FFFF     DC    64X'FF'
         DC    X'FF'
TRTTAB   DC    256X'00'
          DC   10X'00'
         DC   38X'FF'
PZAEHL   DC    P'0000000'
PZEILENZ DC    P'0000000'
         DS    0H
DEFAULT  DC    H'4'
         DC    C'9999'
TRTPACK  PACK  PZAEHL,0(1,3)
         B     SCHALTPR
MVCPARM  MVC   0(1,4),NULLEN
NULLEN   DC    20X'F0'
OUTZAEHL DC    PL2'58'
KZAEHL   DC    P'000'
AVFOLGE  DC    A(VFOLGE)
CLCALT   DC    A(VFOLGE)
VGLFLAGS DC    X'00'
SUCHARBR DC    XL28'00'
VWTOLNGE DS    F
LEN      DS    D
PDOPPELW DC    D'0'
OPERAT   DC    C'GELEGTLTNEEQ  '
         DC    X'B040D02020D040B0708080708070'
PUTKONST DC    S(SATZAUSG)
ENDE1KON DC    S(PROGENDE)
SATZEND  DC    F'0'
BATCHID  DC    X'404040'  DADURCH NUR BLANKS IN DRUCKZ WENN ID N K SOLL
         DS    0H
BCR8     DC    X'0708'
BALR140  DC    X'05E0'
BALR1415 DC    X'05EF'
LR71     DC    X'1871'
LA9      DC    X'4190'
TRTBALNP DC    X'DD009000'
         DC    S(FFFF)  ADRESSE DER TRTTAB FUER BLANK
         DC    X'45E0'                 BAL 14
         DC    S(NUMROUT2)             ADRESSE FUER BAL14
         DC    X'0700'                 NOPR
R1       EQU   1
R2       EQU   2
R3       EQU   3
R4       EQU   4
R5       EQU   5
R6       EQU   6
R7       EQU   7
R8       EQU   8
R9       EQU   9
R14      EQU   14
R15      EQU   15
         LTORG
ISAMDCB  DCB   DDNAME=INPUT,MACRF=(GL,SK),DSORG=IS,BUFNO=1,            *
               EODAD=PROGENDE
QSAMDCB  DCB   DDNAME=INPUT,MACRF=(GL),DSORG=PS,BFTEK=S,EODAD=PROGENDE,*
               SYNAD=SYNINPUT,EROPT=SKP
OUTPUT   DCB   DDNAME=OUTPUT,MACRF=(PM),DSORG=PS,RECFM=FBM,BFTEK=S,    *
               LRECL=131,BLKSIZE=1048
BATCHDCB DCB   DDNAME=BATCH,MACRF=(GL),DSORG=PS,BFTEK=S,EODAD=BATCHEND,*
               RECFM=F,BLKSIZE=80
PUTQSAM  DCB   DSORG=PS,MACRF=(PM),DDNAME=OUTPUT1,SYNAD=SYNOUTP1
OUTPUT2  DCB  DSORG=PS,MACRF=(PM),DDNAME=OUTPUT2,SYNAD=SYNOUTP1
BDAM     DCB   DDNAME=INPUT1,DSORG=DA,MACRF=RISC,BUFL=3600,BUFNO=1,    *
               SYNAD=SYN
BISAM    DCB   DDNAME=INPUT,DSORG=IS,                                  *
               MACRF=(RS),BUFNO=1      GEAENDERT AM 11.8.68
BATCHIN  DSECT
         DS    0CL80
KA       DS    CL2
ORAND    DS    CL2
DISPL    DS    CL5
BED      DS    CL3
WIEDERH  DS    CL3
SUCHBEGR DS    CL56
         DS    CL1
         END   DATEXSZ

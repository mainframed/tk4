./ ADD NAME=ALLOC
//************************************
//*        XA- FAEHIGE  X-COMMANDS
//************************************
//Z223359A JOB (6685,359,2),CLASS=1,MSGCLASS=T
//ALLOC EXEC ASMFCL,LEPRM=',AC=1'
//ASM.SYSLIB DD DSN=SYS1.MACLIB,UNIT=DISK,VOL=SER=DSR00T,DISP=SHR
// DD DSN=SYS1.AMODGEN,DISP=SHR,UNIT=DISK,VOL=SER=DSR00T
// DD DSN=SYS1.MACLIB,DISP=SHR
// DD DSN=LU.MACLIB,DISP=SHR
//ASM.SYSIN DD *
         TITLE 'XALLOC                                 X-COMMAND ALLOC'
XALLOC   CSECT
XALLOC   AMODE 31
XALLOC   RMODE 24
         SPACE 3
***********************************************************************
*                                                                     *
*      PROGRAM-ID. ALLOC.                                             *
*      AUTHOR. EHNERT.                                                *
*      INSTALLATION. BAYER AG, LEVERKUSEN, RECHENZENTRUM.             *
*      DATE-WRITTEN. 26.1.1978.                                       *
*      REMARKS.                                                       *
*          DAS X-COMMAND ALLOC INFORMIERT UBER DIE ZUORDNUNG          *
*          VON EIN-/AUSGABE-EINHEITEN ZU AKTIVEN TASKS.               *
*                                                                     *
*          WIRD ALS PARAMETER EINE EINHEITEN-ADRESSE ANGEGEBEN,       *
*          SO WERDEN DIE NAMEN ALLER TASKS AUSGEGEBEN, DIE DIE        *
*          EINHEIT 'ALLOCATED' HABEN.                                 *
*          WIRD ALS PARAMETER DER NAME EINER TASK SPEZIFIZIERT,       *
*          SO GIBT DAS COMMAND DIE ADDRESSE DER ZUGEORDNETEN          *
*          EINHEITEN AUS.                                             *
*                                                                     *
*          DAS COMMAND KANN AUCH UNTER MVT UND SVS EINGESETZT         *
*          WERDEN. IN DIESEM FALLE WIRD DAS PROGRAMM ALLOCMVT         *
*          AUFGERUFEN.                                                *
*                                                                     *
***********************************************************************
         EJECT
***********************************************************************
*                                                                     *
*      INITIAL PROCESSING.                                            *
*                                                                     *
***********************************************************************
         SPACE 3
*
*      SAVE REGISTERS, ALLOCATE BASE REGISTERS,
*      AND ALLOCATE WORK AREAS.
*
         SPACE 1
         XSAVE R11,,XALLOC,WORKLEN
         LR    R10,R01                 INITIALIZE BASE OF PARM AREA
         USING WORKAREA,R13            ALLOCATE BASE OF WORK AREA
         USING XALLOC,R11              ALLOCATE BASE OF CSECT
         USING PARMAREA,R10            ALLOCATE BASE OF PARM AREA
         USING CVT,R09                 ALLOCATE BASE OF CVT
         USING ASVT,R08                ALLOCATE BASE OF ASVT
         USING ASCB,R07                ALLOCATE BASE OF ASCB
         USING TIOT,R06                ALLOCATE BASE OF TIOT
         USING UCB,R05                 ALLOCATE BASE OF UCB
         XC    FLAGBYTE,FLAGBYTE       CLEAR FLAG BYTE
         MVC   UCMID,REG4              SAVE UCM-ID.
         L     R9,16
         EJECT
*
*      GETMAIN FOR AREA TO STORE UCB OR TASK NAMES.
*
         SPACE 1
GETMAIN  EQU   *
         L     R05,SPLENGTH            LOAD LENGTH OF REQUESTED SUBPOOL
         GETMAIN R,LV=(R05)            ISSUE GETMAIN SVC
         LR    R02,R01                 LOAD ADDRESS OF SUBPOOL
         STM   R01,R02,WORKMADR            AND SAVE IT
         MVI   0(R02),C' '
         LA    R04,1(,R02)
         LA    R03,1
         BCTR  R05,0
         ICM   R03,8,0(R02)
         MVCL  R04,R02                 INITIALIZE SUBPOOL WITH BLANKS
         EJECT
*
*      PARAMETER PROCESSING.
*
         SPACE 1
PARMPROC EQU   *
         CLI   TEXT+6,C','             TASK NAME SPECIFIED ?
         BNE   UCBGIVEN                BRANCH IF NOT
TSKGIVEN EQU   *
         OI    FLAGBYTE,FLAGTSPC       SIGNAL TASK NAME GIVEN
         MVC   WORKTASK,TEXT+7         MOVE TASK NAME
         B     GETASVT                 BRANCH
UCBGIVEN EQU   *
         MVC   WTO(MSG09LEN),MSG09
         L     R00,UCMID
         BAL   R14,WTOROUT
         MVC   WTO(MSG10LEN),MSG10     ZERO FOR ICM COMMAND
         L     R00,UCMID
         BAL   R14,WTOROUT
         B     FREDAREA
         EJECT
***********************************************************************
*                                                                     *
*      SCAN ASVT TO GET VALID ASCB'S.                                 *
*                                                                     *
***********************************************************************
         SPACE 3
GETASVT  EQU   *
         L     R08,CVTASVT             LOAD ADDRESS OF ASVT
         L     R10,ASVTMAXU            LOAD MAX. NUMBER OF ASCB'S
SCANASVT EQU   *
         ICM   R07,15,ASVTFRST         LOAD ADDRESS OF ASCB
         BNP   GETNASCB                BRANCH IF ASCB NOT AVAILABLE
         ICM   R01,15,ASCBJBNI         LOAD ADDRESS OF JOB NAME
         BNZ   *+8                     BRANCH IF AVAILABLE
         ICM   R01,15,ASCBJBNS         ELSE LOAD ADDRESS OF TASK NAME
         MVC   TASKNAME,0(R01)         MOVE TASK NAME
         TM    FLAGBYTE,FLAGUSPC       UNIT NAME SPECIFIED ?
         BO    GETTIOT                 BRANCH IF YES
         CLC   WORKTASK,TASKNAME       TASK NAME FOUND ?
         BNE   GETNASCB                BRANCH IF NOT
         OI    FLAGBYTE,FLAGTFND       ELSE SET FLAG
         LA    R10,1                       AND SET NO. OF ASID'S TO 1
         B     GETTIOT                     AND BRANCH
GETNASCB EQU   *
         LA    R08,4(,R08)             INCREASE TABLE ADDRESS
         BCT   R10,SCANASVT            BRANCH TO LOOP
         B     PUTINFO                 ELSE BRANCH TO MESSAGE OUTPUT
         EJECT
***********************************************************************
*                                                                     *
*      SCAN TIOT.                                                     *
*                                                                     *
***********************************************************************
         SPACE 3
GETTIOT  EQU   *
         ST    R10,WORKASCT            SAVE CURRENT ASCB COUNT
         MVC   FRASID(2),ASCBASID
         SR    R5,R5
         L     R1,ASCBASXB
         LA    R1,8(R1)
         ST    R1,FRADDR
         LA    R1,SVCDAREA
         ST    R1,TOADDR
         LA    R1,XMVPRM
         SVC   237
         LTR   R15,R15
         BNZ   ENDSTIOT
         L     R1,SVCDAREA
         LA    R1,X'7C'(R1)
         ST    R1,FRADDR
         LA    R1,XMVPRM
         SVC   237
         LTR   R15,R15
         BNZ   ENDSTIOT
         L     R1,SVCDAREA
         LA    R1,12(R1)
         ST    R1,FRADDR
         LA    R1,XMVPRM
         SVC   237
         LTR   R15,R15
         BNZ   ENDSTIOT
         L     R1,SVCDAREA
         ST    R1,FRADDR
         LA    R1,25
         ST    R1,LENGTH
         LA    R1,XMVPRM
         SVC   237
         LTR   R15,R15
         BNZ   ENDSTIOT
         SR    R10,R10
         LA    R6,SVCDAREA
         ICM   R10,1,TIOELNGH
         LTR   R10,R10
         BZ    ENDSTIOT
         LA    R10,4(R10)
         ST    R10,LENGTH
         L     R1,FRADDR
         LA    R1,24(R1)
         ST    R1,FRADDR
         LA    R1,XMVPRM
         SVC   237
         LTR   R15,R15
         BNZ   ENDSTIOT
         LA    R6,SVCDAREA-24
SCANTIOT EQU   *
         ICM   R10,1,TIOELNGH
         BZ    ENDSTIOT
         CLC   TIOEDDNM(4),=4X'00'     FREED DD ENTRY ?
         BE    ENDSDEVE                BRANCH IF YES
         CLI   TIOESTTC,X'00'          STATUS BYTE ZERO ?
         BNE   ENDSDEVE                BRANCH IF NOT
         LR    R03,R10                 LOAD LENGTH OF TIOT DD ENTRY
         LA    R01,TIOESTTB-TIOENTRY   COMPUTE
         SR    R03,R01                     NUMBER OF
         SRA   R03,2                       DEVICE ENTRIES
         EJECT
SCANDEVE EQU   *
         CLI   TIOESTTC,X'00'          UNIT ALREADY ALLOCATED ?
         BNE   NXTDDENT                BRANCH IF NOT
         ICM   R05,7,TIOEFSRT          LOAD UCB ADDRESS
         BZ    NXTDDENT                BRANCH IF DUMMY
         TM    UCBJBNR,UCBVRDEV        VIRTUAL DEVICE ?
         BO    NXTDDENT                BRANCH IF YES
         CLI   UCBID,UCBSTND           STANDARD UCB ?
         BNE   ENDSDEVE                BRANCH IF NOT
         TM    UCBSTAT,UCBALOC         UNIT ALLOCATED ?
         BZ    ENDSDEVE                BRANCH IF NOT
         TM    FLAGBYTE,FLAGTSPC       TASK NAME SPECIFIED ?
         BO    MOVEUCBN                BRANCH IF YES
         CLC   WORKUNIT,UCBNAME        UNIT NAME FOUND ?
         BE    MOVETSKN                BRANCH IF YES
NXTDDENT EQU   *
         LA    R06,4(,R06)             SET UP TIOT BASE
         BCT   R03,SCANDEVE            BRANCH TO LOOP
ENDSDEVE EQU   *
         LA    R6,SVCDAREA
         AR    R6,R10
         CLI   0(R6),X'00'
         BZ    ENDSTIOT
         L     R1,FRADDR
         LA    R1,0(R10,R1)
         ST    R1,FRADDR
         SR    R1,R1
         ICM   R1,1,0(R6)
         LA    R1,4(R1)
         ST    R1,LENGTH
         LA    R1,XMVPRM
         SVC   237
         LTR   R15,R15
         BNZ   ENDSTIOT
         LA    R6,SVCDAREA-24
         B     SCANTIOT
ENDSTIOT EQU   *
         L     R10,WORKASCT            LOAD CURRENT ASCB COUNT
         B     GETNASCB                BRANCH
         EJECT
*
*      STORE TASK NAME IF UNIT WAS SPECIFIED.
*
         SPACE 1
MOVETSKN EQU   *
         OI    FLAGBYTE,FLAGMOUT       SET FLAG
         L     R02,WORKMADR            LOAD TASK NAME ADDR. IN SUBPOOL
         MVC   0(8,R02),TASKNAME       MOVE TASK NAME TO SUBPOOL
         LA    R02,9(,R02)             LOAD NEXT TASK NAME ADDRESS
         ST    R02,WORKMADR                AND SAVE IT
         B     ENDSTIOT                BRANCH
         SPACE 2
*
*      MOVE UNIT ADDRESS IF TASK WAS SPECIFIED.
*
         SPACE 1
MOVEUCBN EQU   *
         OI    FLAGBYTE,FLAGMOUT       SET FLAG
         MVC   WORKUNIT,UCBNAME        MOVE UNIT NAME
         TR    WORKUNIT,TRTABLE        TRANSLATE FOR COMPARE
         L     R02,SPLADDR             LOAD
         LA    R00,4                       START ADDRESS
         SR    R02,R00                     FOR COMPARE
TESTUNIT EQU   *
         AR    R02,R00                 LOAD ADDRESS OF NEXT SP. ENTRY
         CLI   0(R02),C' '             END OF ENTRIES ?
         BE    MOVEUNIT                BRANCH IF YES
         CLC   0(3,R02),WORKUNIT       COMPARE NAME WITH NAME IN SP.
         BE    NXTDDENT                BRANCH IF FOUND IN SUBPOOL
         BL    TESTUNIT                BRANCH IF ASCENDING SEQUENCE
         L     R01,WORKMADR            LOAD ADDRESS OF FIRST FREE ENTRY
SHFTUCBN EQU   *
         SR    R01,R00                 DECREASE TO GET ENTRY BEFORE
         MVC   4(3,R01),0(R01)         MOVE ENTRY TO NEXT POSITION
         CR    R01,R02                 ALL HIGHER ENTRIES SHIFTED ?
         BNE   SHFTUCBN                BRANCH IF NOT
MOVEUNIT EQU   *
         MVC   0(3,R02),WORKUNIT       MOVE NEW UNIT NAME TO SUBPOOL
         L     R02,WORKMADR            SET UP
         AR    R02,R00                     ADDRESS OF
         ST    R02,WORKMADR                FIRST FREE ENTRY
         B     NXTDDENT                BRANCH
         EJECT
***********************************************************************
*                                                                     *
*      DISPLAY INFORMATION MESSAGES.                                  *
*                                                                     *
***********************************************************************
         SPACE 3
PUTINFO  EQU   *
         TM    FLAGBYTE,FLAGMOUT       INFORMATION TO BE DISPLAYED ?
         BZ    NOINFO                  BRANCH IF NOT
         LA    R03,MSG03END-MSG03MAD+1 GET DATA LENGTH IN MESSAGE
         SR    R02,R02                 ZERO FOR DIVIDE
         LA    R01,4                   LOAD DIVISOR
         TM    FLAGBYTE,FLAGTSPC       TASK NAME SPECIFIED ?
         BO    *+8                     BRANCH IF YES
         LA    R01,9                   ELSE GET NEW DIVISOR
         DR    R02,R01                 COMPUTE MAXIMUM
         SR    R02,R02                     LENGTH OF DATA
         MR    R02,R01                     TO BE MOVED
         L     R02,SPLADDR             GET START ADDRESS
         SR    R02,R03                     IN SUBPOOL
         BCTR  R03,0                   COMPUTE
         BCTR  R03,0                       MOVE LENGTH
         TM    FLAGBYTE,FLAGTSPC       TASK NAME SPECIFIED ?
         BZ    MOVEULNE                BRANCH IF NOT
         MVC   WTO(MSG02LEN),MSG02     MOVE MESSAGE SKELETON
         MVC   MSG02TSK,WORKTASK       MOVE SPECIFIED TASK NAME
         B     PUTHLINE                BRANCH
MOVEULNE EQU   *
         MVC   WTO(MSG01LEN),MSG01     MOVE MESSAGE SKELETON
         MVC   MSG01UCB,WORKUNIT       MOVE SPECIFIED UNIT NAME
PUTHLINE EQU   *
         L     R00,UCMID               LOAD UCM-ID.
         BAL   R14,WTOROUT
         MVC   WTO(MSG03LEN),MSG03     MOVE MESSAGE SKELETON
PUTLINE  EQU   *
         LA    R02,2(R03,R02)          LOAD NEXT ADDRESS IN SUBPOOL
         CLI   0(R02),C' '             END OF DATA REACHED ?
         BE    FREDAREA                BRANCH IF YES
         EX    R03,MOVEDATA            BRANCH TO MOVE DATA TO MESSAGE
         TM    FLAGBYTE,FLAGTSPC       TASK NAME SPECIFIED ?
         BZ    *+8                     BRANCH IF NOT
         EX    R03,TRANDATA            BRANCH TO TRANSLATE UNIT NAMES
         L     R00,UCMID               LOAD UCM-ID.
         BAL   R14,WTOROUT
         B     PUTLINE                 BRANCH TO LOOP
MOVEDATA MVC   MSG03MAD(0),0(R02)      MOVE DATA TO MESSAGE
TRANDATA TR    MSG03MAD(0),TRTABLE     TRANSLATE UNIT NAMES
         EJECT
***********************************************************************
*                                                                     *
*      FINAL PROCESSING.                                              *
*                                                                     *
***********************************************************************
         SPACE 3
NOINFO   EQU   *
         TM    FLAGBYTE,FLAGTSPC       TASK NAME SPECIFIED ?
         BO    NOTINFO                 BRANCH IF YES
UCBNOALC EQU   *
         MVC   WTO(MSG05LEN),MSG05     MOVE MESSAGE SKELETON
         MVC   MSG01UCB,WORKUNIT       MOVE UNIT NAME
         B     PUTLWTO                 BRANCH
NOUCBFND EQU   *
         MVC   WTO(MSG06LEN),MSG06     MOVE MESSAGE SKELETON
         MVC   MSG01UCB,WORKUNIT       MOVE UNIT NAME
         B     PUTLWTO                 BRANCH
NOTINFO  EQU   *
         TM    FLAGBYTE,FLAGTFND       TASK FOUND ?
         BZ    NOTSKFND                BRANCH IF NOT
         MVC   WTO(MSG07LEN),MSG07     MOVE MESSAGE SKELETON
         MVC   MSG02TSK,WORKTASK       MOVE TASK NAME
         B     PUTLWTO                 BRANCH
NOTSKFND EQU   *
         MVC   WTO(MSG08LEN),MSG08     MOVE MESSAGE SKELETON
         MVC   MSG02TSK,WORKTASK       MOVE TASK NAME
PUTLWTO  EQU   *
         L     R00,UCMID               LOAD UCM-ID.
         BAL   R14,WTOROUT
         EJECT
FREDAREA EQU   *
         L     R02,SPLENGTH            LOAD LENGTH OF SUBPOOL
         L     R03,SPLADDR             LOAD ADDRESS OF SUBPOOL
         FREEMAIN R,LV=(R02),A=(R03)   ISSUE FREEMAIN SVC
RETURN   EQU   *
         XRETURN ,R
WTOROUT  EQU   *
         ST    R14,SAVE14
         L     R0,UCMID
         LA    R1,WTO
         C     R0,=CL4'ROSC'
         BNE   NOROS
         STM   R14,R12,12(R13)                   SAVE ALL REGS IN SA
*
*              NOW WE CAN ADDRESS DUMMYSECTION IN XMON
*
         LH    R0,0(R1)      LOAD LENGTH OF WTO
         SH    R0,=H'4'      DECREMENT BY 4
         STC   R0,3(R1)      INSERT LENGTH TO MESSAGE FOR USE BY ROSCOE
         LA    R0,3(R1)      LOAD MESSAGE ADDRESS
         L     R13,4(R13)    R13 --> SA IN XMON
         ST    R0,76(R13)    STORE IT IN DYN AREA OF XMON = INAREA
         OI    76(R13),X'80' SET HIGHORDER BIT ON
         L     R15,100(R13)  LOAD ROSCOE-CODE <<OUTCODE>>
         LA    R1,76(R13)    LOAD PARAMETER REGISTER
         L     R13,4(R13)    R13 --> SA IN ROSCOE
         L     R14,12(R13)   LOAD RETURNADDRESS
         LM    R2,R12,28(R13)                    LOAD REMAINDER
         BR    R14           RETURN DIRECT TO ROSCOE
NOROS    EQU   *
         C     R0,=CL4'TSO'
         BNE   DOWTO
         LH    R0,WTO
         SH    R0,=H'4'
         LA    R1,WTO+4
         SVC   93
         L     R14,SAVE14
         BR    R14
DOWTO    EQU   *
         WTO   MF=(E,WTO)
         L     R14,SAVE14
         BR    R14
SAVE14  DC    F'0'
         EJECT
***********************************************************************
*                                                                     *
*      REGISTER EQUATES.                                              *
*                                                                     *
***********************************************************************
         SPACE 2
R0       EQU   0
R1       EQU   1
R2       EQU   2
R3       EQU   3
R4       EQU   4
R5       EQU   5
R6       EQU   6
R7       EQU   7
R8       EQU   8
R9       EQU   9
R00      EQU   00                      MACRO AND PARAMETER REGISTER
R01      EQU   01                      MACRO AND PARAMETER REGISTER
R02      EQU   02                      WORK REGISTER
R03      EQU   03                      WORK REGISTER
R04      EQU   04
R05      EQU   05                      POINTER TO UCB
R06      EQU   06                      POINTER TO TIOT
R07      EQU   07                      POINTER TO ASCB
R08      EQU   08                      POINTER TO ASVT
R09      EQU   09                      POINTER TO CVT
R10      EQU   10                      BASE OF PARMAREA, COUNT
R11      EQU   11                      BASE OF CSECT ALLOC
R12      EQU   12
R13      EQU   13                      BASE OF WORK AREA
R14      EQU   14                      LINK AND RETURN REGISTER
R15      EQU   15                      LINK AND RETURN REGISTER
         EJECT
***********************************************************************
*                                                                     *
*      CONSTANT DATA.                                                 *
*                                                                     *
***********************************************************************
         SPACE 3
*
*      TRANSLATE TABLE.
*
         SPACE 1
TRTABLE  DC    X'00000000000000000000000000000000'        X'00' - X'0F'
         DC    X'00000000000000000000000000000000'        X'10' - X'1F'
         DC    X'00000000000000000000000000000000'        X'20' - X'2F'
         DC    X'00000000000000000000000000000000'        X'30' - X'3F'
*                BLANK
         DC    X'40000000000000000000000000000000'        X'40' - X'4F'
         DC    X'00000000000000000000000000000000'        X'50' - X'5F'
         DC    X'00000000000000000000000000000000'        X'60' - X'6F'
         DC    X'00000000000000000000000000000000'        X'70' - X'7F'
*                  A B C D E F (LOWER CASE)
         DC    X'00FAFBFCFDFEFF000000000000000000'        X'80' - X'8F'
         DC    X'00000000000000000000000000000000'        X'90' - X'9F'
         DC    X'00000000000000000000000000000000'        X'A0' - X'AF'
         DC    X'00000000000000000000000000000000'        X'B0' - X'BF'
*                  A B C D E F (UPPER CASE)
         DC    X'00FAFBFCFDFEFF000000000000000000'        X'C0' - X'CF'
         DC    X'00000000000000000000000000000000'        X'D0' - X'DF'
         DC    X'00000000000000000000000000000000'        X'E0' - X'EF'
*                0 1 2 3 4 5 6 7 8 9 A B C D E F
         DC    X'F0F1F2F3F4F5F6F7F8F9C1C2C3C4C5C6'        X'F0' - X'FF'
         SPACE 2
*
*
*      CONSTANTS.
*
         SPACE 1
SPLENGTH DC    F'9216'                 LENGTH OF REQUESTED SUBPOOL
         LTORG
         EJECT
*
*      MESSAGE SKELETTONS.
*
         SPACE 1
MSG01    WTO   'XALLOC1 UNIT 123 IS ALLOCATED TO FOLLOWING TASK(S):',  *
               MF=L,MCSFLAG=(REG0)
MSG01LEN EQU   *-MSG01
         SPACE 1
MSG02    WTO   'XALLOC2 TASK 12345678 HAS ALLOCATED FOLLOWING UNIT(S):'*
               ,MF=L,MCSFLAG=(REG0)
MSG02LEN EQU   *-MSG02
         SPACE 1
MSG03    WTO   'XALLOC3                                                *
                    ',                                                 *
               MF=L,MCSFLAG=(REG0)
MSG03LEN EQU   *-MSG03
         SPACE 1
         EJECT
MSG05    WTO   'XALLOC4 UNIT 123 IS NOT ALLOCATED',                    *
               MF=L,MCSFLAG=(REG0)
MSG05LEN EQU   *-MSG05
         SPACE 1
MSG06    WTO   'XALLOC5 UNIT 123 NOT FOUND',                           *
               MF=L,MCSFLAG=(REG0)
MSG06LEN EQU   *-MSG06
         SPACE 1
MSG07    WTO   'XALLOC6 TASK 12345678 HAS NO ALLOCATED UNITS',         *
               MF=L,MCSFLAG=(REG0)
MSG07LEN EQU   *-MSG07
         SPACE 1
MSG08    WTO   'XALLOC7 TASK 12345678 IS NOT ACTIVE',                  *
               MF=L,MCSFLAG=(REG0)
MSG08LEN EQU   *-MSG08
MSG09    WTO   'XALLOC8 X-ALLOC WITH DEVICE-ADDRESS NO LONGER SUPPORTED*
               .',MF=L,MCSFLAG=REG0
MSG09LEN EQU   *-MSG09
MSG10    WTO   'XALLOC9 USE ''D U,,ALLOC,CUU,1'' INSTEAD.',MF=L,       *
               MCSFLAG=REG0
MSG10LEN EQU   *-MSG10
XMVPRM   DS    0F
FRASID   DC    H'0'
TOASID   DC    H'0'
FRADDR   DC    F'0'
TOADDR   DC    F'0'
LENGTH   DC    F'4'
         EJECT
***********************************************************************
*                                                                     *
*      WORK AREA.                                                     *
*                                                                     *
***********************************************************************
         SPACE 2
WORKAREA DSECT
SAVEAREA DC    18F'0'                  SAVE AREA OF GENERAL REGISTERS
UCMID    DC    F'1'                    UCM-ID.
WORKASCT DC    F'0'                    SAVE AREA OF ASCB COUNT
WORKMADR DC    A(0)                    CURRENT ADDRESS IN SUBPOOL
SPLADDR  DC    A(0)                    ADDRESS OF SUBPOOL
UNPKAREA DS    F                       WORK AREA
TASKNAME DS    CL8                     CURRENT TASK NAME
WORKTASK DS    CL8                     SPECIFIED TASK NAME
WORKUNIT DS    CL3                     SPECIFIED UNIT NAME
         SPACE 2
*
*      MULTI CONTROL FLAG BYTE.
*
         SPACE 1
FLAGBYTE DC    X'00'
FLAGTSPC EQU   X'80'                   TASK NAME SPECIFIED
FLAGUSPC EQU   X'40'                   UNIT NAME SPECIFIED
FLAGMOUT EQU   X'20'                   INFORMATION FOUND
FLAGTFND EQU   X'10'                   SPECIFIED TASK FOUND
         SPACE 2
*
*      MESSAGE AREA.
*
         SPACE 1
WTO      DS    0F
         ORG   WTO+17
MSG01UCB DC    CL3' '                  UNIT NAME
         ORG   WTO+17
MSG02TSK DC    CL8' '                  TASK NAME
MSG03MAD EQU   WTO+12
MSG03END EQU   WTO+MSG03LEN
         ORG   WTO+39
MSG04RC  DC    CL4'FFFF'               RETURN-/COMPLETION-CODE
         ORG   WTO+50
MSG04TSK DC    CL8' '                  TASK NAME
         ORG   WTO+MSG03LEN
         EJECT
SVCFPARM DS    0F                      FETCH PARAMETER STRING
SVCFSTRL DC    F'20'                   LENGTH FIELD
SVCFSTRG DC    CL16' '                 DATA FIELD
SVCSPARM DS    0F                      STORE PARAMETER STRING
SVCSSTRL DC    F'12'                   LENGTH FIELD
SVCSSTRG DC    CL12' '                 DATA FIELD
SVCDAREA EQU   *                       AREA WHERE DATA
         ORG   WORKAREA+4095               IS TO BE STORED IN
WORKLEN  EQU   *-WORKAREA              LENGTH OF WORK AREA
         SPACE 3
***********************************************************************
*                                                                     *
*      PARAMETER AREA.                                                *
*                                                                     *
***********************************************************************
         SPACE 3
         XPARM
         EJECT
         IHAPSA
         EJECT
         CVT   DSECT=YES,LIST=YES
         EJECT
         IHAASVT
         EJECT
         IHAASCB
         EJECT
TIOT     DSECT
         IEFTIOT1
         EJECT
UCB      DSECT
         IEFUCBOB LIST=YES
         SPACE 3
         END   XALLOC
//LKED.SYSLMOD DD DSN=LU.LNKLIB(XALLOC),DISP=SHR
./ ADD NAME=ALTR
ALTR     CSECT
         XSAVE R12,,ALTR,WORKL
         REG
         LR    R0,12
         LA    R15,SVCROUT
         SVC   250
         XRETURN 0,R
SVCROUT  EQU   *
         LR    R12,R0
         USING WORK,R13
         LR    R14,R1
         USING PARMAREA,R14
         ST    R14,SAVE14
         L     R2,REG4
         ST    R2,REG4X
         LA    R2,TEXT
         XC    ECB,ECB
         LA    R11,ZWI
AGAIN    EQU   *
         LR    R5,R2
         LA    R5,4(R5)
         LA    R4,0
NEXTCHAR EQU   *
         LA    R5,1(R5)
         CLI   0(R5),C','
         BE    PAREND
         LA    R4,1(R4)
         B     NEXTCHAR
PAREND   EQU   *
         LR    R6,R4
         SRL   R6,1
         SLL   R6,1
         CR    R6,R4
         BE    NOER
         MVC   ZWI,5(R2)
         MVI   5(R2),X'F0'
         MVC   6(80,R2),ZWI
         B     AGAIN
         EJECT
ERROR    EQU   *
         MVC   WTO(LENOFER),ER
         L     R0,REG4X
         LA    R1,WTO
         BAL   R14,WTOROUT
RETURN   EQU   *
         SVC   3
         EJECT
NOER     EQU   *
         LA    R6,4(R2)
         CH    R4,=H'8'
         BH    ERROR
         CH    R4,=H'0'
         BNH   ERROR
         LR    R7,R4
CONTNI   EQU   *
         LA    R6,1(R6)
         NI    0(R6),X'3F'
         BCT   R7,CONTNI
         LA    R6,5(R2)
         BCTR  R4,0
         EX    R4,TREX
         EX    R4,TRTEX
         BNZ   ERROR
         LA    R4,1(R4)
         LA    R7,4
         SLL   R7,4
         OR    R7,R4
         EX    R7,PCKEX
         LA    R5,17
         LA    R7,0
         LA    R6,5(R4,R2)
ZAPLOOP  EQU   *
         LA    R6,1(R6)
         CLI   0(R6),X'40'
         BE    WEITER
         CLI   0(R6),C','
         BE    WEITER
         NI    0(R6),X'3F'
         LA    R7,1(R7)
         BCT   R5,ZAPLOOP
WEITER   EQU   *
         LTR   R7,R7
         BZ    ERROR
         BCTR  R7,0
         LA    R6,6(R4,R2)
         TR    0(16,R6),TRTAB
         EX    R7,TRTEX
         BNZ   ERROR
         PACK  5(5,R11),0(9,R6)
         PACK  9(5,R11),8(9,R6)
         L     R4,0(R11)
         SRL   R7,1
         MVC   WTO(LENOFOLD),OLD
         CL    R4,=XL4'00FFFFFF'
         BNH   NO31MODE
         MODE31
NO31MODE UNPK  WTO+29(9),0(5,R4)
         UNPK  WTO+37(9),4(5,R4)
         MODE24
         MVI   WTO+45,X'40'
         TR    WTO+29(16),CCTAB-240
         L     R0,REG4X
         LA    R1,WTO
         BAL   R14,WTOROUT
         CL    R4,=F'512'
         BH    LAB1
         PROTPSA DISABLE
         MODE31
         EX    R7,MVCEX
         MODE24
         PROTPSA ENABLE
         B     LAB2
LAB1     DS    0H
         MODE31
         EX    R7,MVCEX
         MODE24
LAB2     DS    0H
         B     RETURN
WTOROUT  EQU   *
         ST    R14,SAVE14X
         L     R0,REG4X
         C     R0,=CL4'ROSC'
         BNE   NOROS
         STM   R14,R12,12(R13)                   SAVE ALL REGS IN SA
*
*              NOW WE CAN ADDRESS DUMMYSECTION IN XMON
*
         LH    R0,0(R1)      LOAD LENGTH OF WTO
         SH    R0,=H'4'      DECREMENT BY 4
         STC   R0,3(R1)      INSERT LENGTH TO MESSAGE FOR USE BY ROSCOE
         LA    R0,3(R1)      LOAD MESSAGE ADDRESS
         L     R13,4(R13)    R13 --> SA IN XMON
         ST    R0,76(R13)    STORE IT IN DYN AREA OF XMON = INAREA
         OI    76(R13),X'80' SET HIGHORDER BIT ON
         L     R15,100(R13)  LOAD ROSCOE-CODE <<OUTCODE>>
         LA    R1,76(R13)    LOAD PARAMETER REGISTER
         L     R13,4(R13)    R13 --> SA IN ROSCOE
         L     R14,12(R13)   LOAD RETURNADDRESS
         LM    R2,R12,28(R13)                    LOAD REMAINDER
         BR    R14           RETURN DIRECT TO ROSCOE
NOROS    EQU   *
         C     R0,=CL4'TSO'
         BNE   NOTSO
         LH    R0,0(R1)
         SH    R0,=H'4'
         LA    R1,4(R1)
         SVC   93             TPUT
         L     R14,SAVE14X
         BR    R14
NOTSO    EQU   *
         WTO   MF=(E,(1))
         L     R14,SAVE14X
         BR    R14
SAVE14X  DS    F
         EJECT
TREX     TR    0(1,R6),TRTAB
TRTEX    TRT   0(0,R6),ZEROES
PCKEX    PACK  0(0,R11),0(0,R6)
MVCEX    MVC   0(0,R4),5(R11)
ER       WTO   'XALTR01 ERROR IN PARAMETER',MCSFLAG=(REG0),MF=L
LENOFER  EQU   *-ER
OLD      WTO   'XALTR03 OLD CONTENTS WAS                  ',MF=L,      *
               MCSFLAG=REG0
LENOFOLD EQU   *-OLD
TRTAB    DS    0CL64
         DC    X'FF0A0B0C0D0E0F'
         DC    41XL1'FF'
         DC    X'00010203040506070809'
         DC    6XL1'FF'
         DC    0F'0'
ZEROES   DC    16XL1'0'
CCTAB    DC    C'0123456789ABCDEF'
         LTORG
         EJECT
WORK     DSECT
SVA      DS    18F
WTO      DS    CL80
ZWI      DS    CL80
ECB      DS    F
REPLY    DS    X
REG4X    DS    F
SAVE14   DS    F
WORKL    EQU   *-WORK
         XPARM
         IHAPSA
         END
./ ADD NAME=AMS
         TITLE 'XAMS                            X-COMMAND AMS'
AMS      CSECT
         SPACE 3
***********************************************************************
*                                                                     *
*      PROGRAM-ID. AMS.                                               *
*      AUTHOR. EHNERT.                                                *
*      INSTALLATION. BAYER AG, LEVERKUSEN, RECHENZENTRUM.             *
*      DATE-WRITTEN. 13. 3. 1975.                                     *
*      REMARKS.                                                       *
*                                                                     *
*          DAS X-COMMAND 'AMS' DIENT ALS INTERFACE ZWISCHEN DER       *
*          SYSTEM-TASK 'XCNTRLVS' UND DEM UTILITY 'IDCAMS'. SOMIT     *
*          STEHEN DIE ACCESS METHOD SERVICES ALS X-COMMAND ZUR VER-   *
*          FUEGUNG.                                                   *
*                                                                     *
*          DIE 120-STELLIGE PARAMETERLISTE WIRD ALS SYSIN-DATEI       *
*          AN DAS UTILITY UEBERGEBEN UND MUSS SOMIT DEN DAFUER        *
*          GELTENDEN REGELN GENUEGEN.                                 *
*                                                                     *
*          DIE AUSGABE AUF DEN BILDSCHIRM ERFOLGT IN INTERVALLEN      *
*          MIT JE 10 NACHRICHTENZEILEN.                               *
*                                                                     *
***********************************************************************
         EJECT
***********************************************************************
*                                                                     *
*      BEGINN DER VERARBEITUNG.                                       *
*                                                                     *
***********************************************************************
         SPACE 3
*
*      SICHERN DER REGISTER,
*      SPEICHERPLATZANFORDERUNG FUER ARBEITSBEREICHE,
*      ZUORDNUNG DER BASISREGISTER.
*
         SPACE 1
         XSAVE R12,,AMS,ABERL
         SPACE 1
         LR    R11,R1        BASISREG. FUER DSECT PARMAREA INITIALIS.
         USING EINGABE,R9    BASISREG. FUER DSECT EINGABE ZUORDNEN
         USING AUSGABE,R10   BASISREG. FUER DSECT AUSGABE ZUORDNEN
         USING PARMAREA,R11  BASISREG. FUER DSECT PARMAREA ZUORDNEN
         USING ABER,R13      BASISREG. FUER DSECT ABER ZUORDNEN
         CLC   REG4(4),=CL4'TSO'
         BNE   NOTSO
         TPUT  NOTSOMSG,50
         B     ABSCHLUS
NOTSOMSG DC    CL50'XAMS000 X-AMS NOT SUPPORTED UNDER TSO'
NOTSO    EQU   *
         EJECT
*
*      ABFRAGE DES SYSTEMS.
*
         SPACE 1
         L     R2,16         ADRESSE DER CVT LADEN
         TM    116(R2),X'01' SYSTEM = OS/VS2 (MVS) ?
         BZ    FEHLSYS       NEIN, VERZW. ZUR FEHLERROUTINE
         SPACE 2
*
*      INITIALISIERUNG DER SPEICHER.
*
         SPACE 1
         MVC   EIN(EDCBLEN),EINDCB DCB FUER SYSPRINT UEBERTRAGEN
         MVC   AUS(ADCBLEN),AUSDCB DCB FUER SYSIN UEBERTRAGEN
         LA    R2,EIN        ADRESSEN DER
         LA    R3,AUS            DCB'S LADEN
         STM   R2,R3,EDCBADDR    UND SPEICHERN
         MVI   EDCBADDR,X'80' OPTION BYTE SETZEN
         MVI   ADCBADDR,X'8F' OPTION BYTE SETZEN
         MVI   FLAGBYTE,X'00' FLAG BYTE LOESCHEN
         SPACE 2
*
*      PRUEFUNG DER PARAMETERKETTE.
*
         SPACE 1
         CLC   TEXT,BLANK    TEXT = BLANK ?
         BE    FEHLPARM      JA, VERZW. ZUR FEHLERROUTINE
         EJECT
***********************************************************************
*                                                                     *
*      VERARBEITUNG DER PARAMETERKETTE.                               *
*                                                                     *
***********************************************************************
         SPACE 3
*
*      SYSIN EROEFFNEN.
*
         SPACE 1
         LA    R1,ADCBADDR   ADRESSE DER DCB-ADRESSE LADEN
         SVC   19            VERZW. ZUM EROEFFNEN DER DATEI
         SPACE 2
*
*      PARAMETERKETTE UEBERTRAGEN.
*
         SPACE 1
         LA    R2,TEXT-1     ADRESSE DES PARAMETERTEXTES LADEN
         LR    R3,R2         ADRESSE DES PARAMETERTEXTES LADEN
         LA    R4,PARMENDE   ENDADRESSE DES PARAMETERBEREICHS LADEN
PUTLOOP  EQU   *
         PUT   AUS           AUSGABEBEREICH ZUR VERFUEGUNG STELLEN
         LR    R10,R1        LAUFENDE ADRESSE LADEN
         MVC   AZEILE,BLANK  AUSGABEZEILE LOESCHEN
         LA    R5,ATEXT-1    ADRESSE DES AUSGABETEXTES LADEN
         LR    R6,R5         ADRESSE DES AUSGABETEXTES LADEN
         LA    R7,ATEXT+50   ENDADRESSE DES AUSGABETEXTES LADEN
MVCLOOP  EQU   *
         LA    R2,1(R2)      R2 ERHOEHEN
         CR    R2,R4         PARAMETERBEREICH UEBERSCHRITTEN
         BNL   CLOSYSIN      JA, VERZWEIGEN
         CLC   0(2,R2),=C'  ' MEHRERE LEERZEICHEN HINTEREINANDER ?
         BE    MVCLOOP       JA, VERZWEIGEN
         LA    R5,1(R5)      R5 ERHOEHEN
         CR    R5,R7         AUSGABETEXT UEBERSCHRITTEN ?
         BNL   MVLOOPOK      JA, VERZWEIGEN
         CLI   0(R2),C' '    BLANK AN DIESER STELLE ?
         BE    LOOP1OK       JA, VERZWEIGEN
         CLI   0(R2),C')'    TRENNUNGSZEICHEN ')' AN DIESER STELLE ?
         BE    LOOP1OK       JA, VERZWEIGEN
         CLI   0(R2),C';'    TRENNUNGSZEICHEN, NEUES STATEMENT ?
         BE    LOOP1OK       JA, VERZWEIGEN
MVCBYTE  EQU   *
         MVC   0(1,R5),0(R2) ZEICHEN UEBERTRAGEN
         B     MVCLOOP       VERZWEIGEN
         EJECT
LOOP1OK  EQU   *
         LR    R3,R2         ADRESSE DES TRENNUNGSZEICHENS LADEN
         LR    R6,R5         ADRESSE DES TRENNUNGSZEICHENS LADEN
         CLI   0(R2),C';'    TRENNUNGSZEICHEN  = ';' ?
         BE    PUTLOOP       JA, VERZWEIGEN
         B     MVCBYTE       VERZWEIGEN
         SPACE 1
MVLOOPOK EQU   *
         LR    R2,R3         ADR. DES LETZTEN TRENNUNGSZEICHENS LADEN
         LR    R5,R6         R5 AUF DAS LETZTE GUELTIGE
         LA    R5,1(R5)          ZEICHEN EINSTELLEN
         CR    R5,R7         AUSGABETEXT UEBERSCHRITTEN ?
         BNL   MVICFLAG      JA, VERZWEIGEN
         SR    R7,R5         LAENGE DER ZULETZT UEBERTR. ZEICHEN
         BCTR  R7,0          R7 UM EINS VERMINDERN
         EX    R7,MVCBLANK   VERZW. ZUM LOESCHEN DER LETZTEN ZEICHEN
MVICFLAG EQU   *
         MVI   CONTFLAG,C'-' FORTSETZUNGSZEICHEN SETZEN
         B     PUTLOOP       VERZWEIGEN
         SPACE 1
MVCBLANK EQU   *
         MVC   0(0,R5),BLANK ZULETZT UEBERTRAGENE ZEICHEN LOESCHEN
         SPACE 2
*
*      SYSIN SCHLIESSEN.
*
         SPACE 1
CLOSYSIN EQU   *
         MVI   ADCBADDR,X'80' OPTION BYTE MODIFIZIEREN
         LA    R1,ADCBADDR   ADRESSE DER DCB-ADRESSE LADEN
         SVC   20            VERZW. ZUM SCHLIESSEN DER DATEI
         EJECT
***********************************************************************
*                                                                     *
*      AUFRUF DES UTILITIES 'IDCAMS'.                                 *
*                                                                     *
***********************************************************************
         SPACE 3
         LA    R1,PARMADDR   ADRESSE DER PARAMETERLISTE LADEN
         LINK  EP=IDCAMS
         EJECT
***********************************************************************
*                                                                     *
*      VERARBEITUNG DER IDCAMS-NACHRICHTEN.                           *
*                                                                     *
***********************************************************************
        SPACE 3
*
*      SYSPRINT EROEFFNEN.
*
         SPACE 1
         LA    R1,EDCBADDR   ADRESSE DER DCB-ADRESSE LADEN
         SVC   19            VERZW. ZUM EROEFFNEN DER DATEI
*
*      AUSGABE DER IDCAMS-NACHRICHTEN.
*
         SPACE 1
         MVI   FLAGBYTE,X'00' FLAG BYTE LOESCHEN
         LA    R6,6          R6 INITIALISIEREN
LOOP2OK  EQU   *
         MVC   WTO(LENMESS1),MESS1 NACHRICHTENZEILE UEBERTRAGEN
         LA    R2,10         R2 INITIALISIEREN
         SR    R3,R3         R3 LOESCHEN
LOOP2    EQU   *
         GET   EIN           EINGABEBEREICH ZUR VERFUEGUNG STELLEN
         LR    R9,R1         LAUFENDE ADRESSE LADEN
         MVC   WTOTEXT,BLANK TEXT LOESCHEN
         ICM   R3,3,TEXTLEN  LAENGE DES TEXTES LADEN
         SR    R3,R6         R3 VERMINDERN
         EX    R3,MVCETEXT   VERZW. ZUM UEBERTR. DES TEXTES
         BAL   R14,PRUEFTXT  VERZW. ZUM PRUEFEN DER NACHRICHTEN
         MVI   FLAGBYTE,X'00' FLAG BYTE LOESCHEN
         L     R0,REG4       UCM-ID DES AUFRUFERS LADEN
         WTO   MF=(E,WTO)    NACHRICHTENZEILE AUSGEBEN
         BCT   R2,LOOP2      VERZWEIGEN
         EJECT
NXTWTOR  EQU   *
         XC    ECB,ECB       EVENT CONTROL BLOCK LOESCHEN
         MVI   REPLY,C' '    REPLY LOESCHEN
         L     R0,REG4       UCM-ID DES AUFRUFERS LADEN
         LA    R2,ECB        ADRESSE DES EVENT CONTROL BLOCK LADEN
         LA    R3,REPLY      ADRESSE DES REPLY LADEN
         MVC   WTO(LENMESS4),MESS4 NACHRICHTENZEILE UEBERTRAGEN
         WTOR  ,(R3),1,(R2),MF=(E,WTO)
         SPACE 1
         WAIT  ECB=ECB
         CLI   REPLY,C'Y'    REPLY = YES ?
         BE    LOOP2OK       JA, VERZWEIGEN
         CLI   REPLY,C'N'    REPLY = NO ?
         BE    CLOSPRT       JA, VERZWEIGEN
         B     NXTWTOR       BEI UNGUELTIGEM REPLY VERZWEIGEN
         SPACE 1
MVCETEXT EQU   *
         MVC   WTOTEXT(0),ETEXT EINGABETEXT UEBERTRAGEN
         SPACE 2
*
*      SYSPRINT SCHLIESSEN.
*
         SPACE 1
CLOSPRT  EQU   *
         LA    R1,EDCBADDR   ADRESSE DER DCB-ADRESSE LADEN
         SVC   20            VERZW. ZUM SCHLIESSEN DER DATEI
         EJECT
***********************************************************************
*                                                                     *
*      ABSCHLUSSROUTINEN.                                             *
*                                                                     *
***********************************************************************
         SPACE 3
*
*      SPEICHERPLATZFREIGABE,
*      REINITIALISIERUNG DER REGISTER UND
*      RUECKSPRUNG ZUM AUFRUFENDEN PROGRAMM.
*
         SPACE 1
ABSCHLUS EQU   *
         LA    R1,ABERL      LAENGE DES ARBEITSBEREICHS LADEN UND
         ST    R1,SAVEAREA       IM ERSTEN WORT DER SAVEAREA SPEICHERN
         XRETURN ,R
         EJECT
***********************************************************************
*                                                                     *
*      PRUEFUNG DER IDCAMS-NACHRICHTEN.                               *
*                                                                     *
***********************************************************************
         SPACE 3
PRUEFTXT EQU   *
         CLC   WTOTEXT(23),=C'IDCAMS  SYSTEM SERVICES'
         BE    LOOP2
         CLC   WTOTEXT(3),=C'IDC'
         BE    MVCMSG
         CLC   WTOTEXT+29(20),=C'LISTING FROM CATALOG'
         BE    LOOP2
         CLC   WTOTEXT,BLANK
         BE    LOOP2
         CLC   WTOTEXT+9(10),=C'THE NUMBER'
         BNE   *+8
         MVI   FLAGBYTE,X'FF'
         CLC   WTOTEXT(9),BLANK
         BNER  R14
         CLI   FLAGBYTE,X'FF'
         BE    LOOP2
         BR    R14
         SPACE 1
MVCMSG   EQU   *
         LA    R4,WTOTEXT+119
         LA    R5,WTOTEXT
         SR    R7,R7
LOOP3    EQU   *
         CR    R4,R5
         BLR   R14
         CLC   0(2,R4),=C', '
         BE    LOOP3OK
         CLC   0(2,R4),=C'. '
         BE    LOOP3OK
         LA    R7,1(R7)
         BCT   R4,LOOP3
LOOP3OK  EQU   *
         BCTR  R7,0
         EX    R7,MVCWTOTX
         BR    R14
         SPACE 1
MVCWTOTX EQU   *
         MVC   WTOTEXT+9(0),2(R4)
         EJECT
***********************************************************************
*                                                                     *
*      FEHLERROUTINEN.                                                *
*                                                                     *
***********************************************************************
         SPACE 3
*
*      ROUTINE BEI UNGUELTIGEM SYSTEM.
*
         SPACE 1
FEHLSYS  EQU   *
         L     R0,REG4       UCM-ID DES AUFRUFERS LADEN
         WTO   MF=(E,MESS2)  NACHRICHTENZEILE AUSGEBEN
         B     ABSCHLUS      VERZWEIGEN
         SPACE 2
*
*      ROUTINE BEI FEHLER IN DER PARAMETERKETTE.
*
         SPACE 1
FEHLPARM EQU   *
         L     R0,REG4       UCM-ID DES AUFRUFERS LADEN
         WTO   MF=(E,MESS3)  NACHRICHTENZEILE AUSGEBEN
         B     ABSCHLUS      VERZWEIGEN
         EJECT
***********************************************************************
*                                                                     *
*      REGISTER EQUATES.                                              *
*                                                                     *
***********************************************************************
         SPACE 3
R0       EQU   0             MACRO- UND-PARAMETER REGISTER
R1       EQU   1             MACRO- UND-PARAMETER REGISTER
R2       EQU   2             ARBEITSREGISTER
R3       EQU   3             ARBEITSREGISTER
R4       EQU   4             ARBEITSREGISTER
R5       EQU   5             ARBEITSREGISTER
R6       EQU   6             ARBEITSREGISTER
R7       EQU   7             ARBEITSREGISTER
R8       EQU   8             ARBEITSREGISTER
R9       EQU   9             BASISREG. FUER DSECT EINGABE
R10      EQU   10            BASISREG. FUER DSECT AUSGABE
R11      EQU   11            BASISREG. FUER DSECT PARMAREA
R12      EQU   12            BASISREG. FUER CSECT AMS
R13      EQU   13            BASISREG. FUER DSECT ABER
R14      EQU   14            RUECKSPRUNGADRESSEN
R15      EQU   15            CSECT-ADRESSEN UND RETURN CODES
         EJECT
***********************************************************************
*                                                                     *
*      DEFINITION DER KONSTANTEN-SPEICHER.                            *
*                                                                     *
***********************************************************************
         SPACE 3
ECBX     DC    F'0'
TCBADR   DC    F'0'
         DS    0F
PARMADDR DC    AL1(128)
         DC    AL3(PARMINFO)
PARMINFO DC    H'0'
BLANK    DC    120C' '
         SPACE 2
*
*      DCB FUER SYSPRINT.
*
         SPACE 1
EINDCB   DCB   DDNAME=SYSPRINT,                                        *
               DSORG=PS,                                               *
               MACRF=(GL),                                             *
               EODAD=CLOSPRT
EDCBLEN  EQU   *-EINDCB      LAENGE DES DCB
         SPACE 2
*
*      DCB FUER SYSIN.
*
         SPACE 1
AUSDCB   DCB   DDNAME=SYSIN,                                           *
               DSORG=PS,                                               *
               MACRF=(PL),                                             *
               RECFM=F,                                                *
               LRECL=80,                                               *
               BLKSIZE=80
ADCBLEN  EQU   *-AUSDCB      LAENGE DES DCB
         EJECT
***********************************************************************
*                                                                     *
*      DEFINITION DER AUSGABENACHRICHTEN.                             *
*                                                                     *
***********************************************************************
         SPACE 3
MESS1    WTO   'XAMS001                                                *
                      ',                                               *
               MF=L,MCSFLAG=(REG0)
LENMESS1 EQU   *-MESS1
         SPACE 1
MESS2    WTO   'XAMS002 FUNCTION SUPPORTED FOR OS/VS2 (MVS) ONLY',     *
               MF=L,MCSFLAG=(REG0)
         SPACE 1
MESS3    WTO   'XAMS003 INVALID PARAMETER LIST',                       *
               MF=L,MCSFLAG=(REG0)
         SPACE 1
MESS4    WTOR  'XAMS004 REPLY ''Y'' (YES) OR ''N'' (NO) TO CONTINUE',  *
               MF=L,MCSFLAG=(REG0)
LENMESS4 EQU   *-MESS4
         EJECT
***********************************************************************
*                                                                     *
*      DEFINITION DER ARBEITSBEREICHE.                                *
*                                                                     *
***********************************************************************
         SPACE 3
ABER     DSECT
SAVEAREA DS    18F           SAVEAREA FUER ALLGEMEINE REGISTER
EDCBADDR DS    F             DCB-ADRESSE FUER SYSPRINT
ADCBADDR DS    F             DCB-ADRESSE FUER SYSIN
EIN      DS    0F            DCB FUER SYPRINT
         ORG   *+EDCBLEN
AUS      DS    0F            DCB FUER SYSIN
         ORG   *+ADCBLEN
WTO      DS    0F            BEREICH FUER AUSGABENACHRICHTEN
         DS    CL12
WTOTEXT  DS    CL120         BEREICH FUER AUSGABETEXTE
REPLY    DS    C             BEREICH FUER REPLY
FLAGBYTE DS    C             FLAG BYTE
ECB      DS    F             EVENT CONTROL BLOCK
         SPACE 1
ABERL    EQU   *-ABER        LAENGE DES ARBEITSBEREICHES
         EJECT
*
*      EINGABEBEREICH.
*
         SPACE 1
EINGABE  DSECT
TEXTLEN  DS    CL2           LAENGE DES EINGABETEXTES
         DS    CL2
         DS    C             STEUERZEICHEN
ETEXT    DS    CL120         EINGABETEXT
         SPACE 2
*
*      AUSGABEBEREICH.
*
         SPACE 1
AUSGABE  DSECT
AZEILE   DS    CL80          AUSGABEZEILE
         ORG   AUSGABE+1
ATEXT    DS    CL50          AUSGABETEXT
         DS    C
CONTFLAG DS    C             FORTSETZUNGSZEICHEN (' ' × '-')
         SPACE 2
*
*      PARAMETERBEREICH.
*
         SPACE 1
PARMAREA DSECT
REG4     DS    F             UCM-ID DES AUFRUFERS
         DS    CL4           = 'AMS,'
TEXT     DS    CL119
PARMENDE EQU   *
         END   AMS
./ ADD NAME=ATT
LUXATT   START
         XSAVE R12,,LUXATT,WORKLEN
         USING WORK,R13
         MVI   SWITCH,X'00'
         LR    R11,R1
         USING PARMAREA,R11
         CLC   REG4(4),=CL4'TSO'
         BNE   NOTSO
         TPUT  NOTSOMSG,50
         B     XRETURN
NOTSO    EQU   *
         MODESET KEY=ZERO
         GETMAIN R,LV=EXLEN,SP=253
         LR    R10,R1
         USING EXECPARM,R10
         LA    R2,TEXT+4
         SR    R3,R3
         LA    R4,9
NEXTCHAR EQU   *
         LA    R5,0(R2,R3)
         CLI   0(R5),C','
         BE    ENDNM
         CLI   0(R5),C' '
         BNE   INCR
         OI    SWITCH,NOPRM
         B     ENDNM
INCR     EQU   *
         LA    R3,1(R3)
         BCT   R4,NEXTCHAR
ERROR    EQU   *
         MVC   WTO,MESS4
         L     R0,REG4
         WTO   MF=(E,WTO)
         B     RETURN
ENDNM    EQU   *
         LTR   R3,R3
         BZ    ERROR
         BCTR  R3,0
         MVC   MODULENM,=CL8' '
         EX    R3,MVCEX1
         CLC   MODULENM,=CL8'PRTY'
         BE    RETURN
         TM    SWITCH,NOPRM
         BNO   PARMDA
         SR    R3,R3
         STH   R3,LENGTH
         B     XCTL
PARMDA   EQU   *
         LA    R2,2(R2,R3)
         CLI   0(R2),C''''
         BNE   ERROR
         LA    R2,1(R2)
         SR    R3,R3
         LA    R4,101
NEXTPRM  EQU   *
         LA    R5,0(R2,R3)
         CLI   0(R5),C''''
         BE    ENDPRM
         LA    R3,1(R3)
         BCT   R4,NEXTPRM
         B     ERROR
ENDPRM   EQU   *
         LTR   R3,R3
         BZ    ERROR
         STH   R3,LENGTH
         BCTR  R3,0
         EX    R3,MVCEX2
         OC    PARMVAL,PARMBLNK
XCTL     EQU   *
         ST    R10,PARMR
         OI    PARMR,X'80'
         LA    R1,PARMR
         MVC   ATT,ATTACH
         XC    ECB,ECB
         ATTACH  EPLOC=MODULENM,ECB=ECB,SF=(E,ATT)
         ST    R1,TCBADDR
         MVC   WTO,MESS1
         MVC   WTO+17(8),MODULENM
         L     R0,REG4
         WTO   MF=(E,WTO)
         MVC   REG4W,REG4
         WAIT  ECB=ECB
         DETACH TCBADDR
         MVC   WTO,MESS2
         MVC   WTO+17(8),MODULENM
         L     R0,REG4W
         WTO   MF=(E,WTO)
RETURN   EQU   *
         FREEMAIN R,LV=EXLEN,A=(R10),SP=253
XRETURN  EQU    *
         XRETURN ,R
NOTSOMSG DC    CL50'XATT000 X-ATT NOT SUPPORTED UNDER TSO'
MESS1    WTO   'XATT001 TASK XXXXXXXX STARTED',MF=L,                   *
               MCSFLAG=(REG0)
MESS2    WTO   'XATT002 TASK XXXXXXXX ENDED ',MF=L,                    *
               MCSFLAG=(REG0)
MESS4    WTO   'XATT003 ERROR IN PARAMETER',MCSFLAG=REG0,MF=L
NOPRM    EQU   X'80'
MVCEX1   MVC   MODULENM(0),0(R2)
MVCEX2   MVC   PARMVAL(0),0(R2)
ATTACH   ATTACH SF=L
         REG
PARMBLNK DC    CL100' '
WORK     DSECT
SVA      DS    18F
ECB      DS    F
REG4W    DS    F
ATT      DS    CL60
WTO      DS    CL70
SWITCH   DS    X
MODULENM DS    CL8
TCBADDR  DS    F
PARMR    DS    F
WORKLEN  EQU   *-WORK
         XPARM
EXECPARM DSECT
LENGTH   DS    H
PARMVAL  DS    CL100
EXLEN    EQU   *-EXECPARM
         END
./ ADD NAME=AVR
AVR      CSECT
***********************************************************************
*                                                                     *
* AUTHOR. EBELING.                                                    *
* DATE-WRITTEN. 23.10.72.                                             *
* INSTALLATION. BAYER AG, LEVERKUSEN, RECHENZENTRUM.                  *
* REMARKS.                                                            *
*     DAS PROGRAMM DURCHSUCHT DIE UCB'S UND GIBT NACH BEDARF ZWEI     *
*     LISTEN MIT BANDEINHEITEN ADRESSEN AUS.                          *
*     DIE ERSTE LISTE ENTHAELT ALLE ADRESSEN, DIE ONLINE NOT RAEDY    *
*     SIND. DIE ZWEITE ALLE ADRESSEN, DIE ONLINE ABER NICHT ALLOCATED *
*     SIND UND BEI DENEN DIE VOLUME SERIAL NUMMER NOCH NICHT GELESEN  *
*     WURDE.                                                          *
*     DAS PROGRAMM IST REENTERABLE UND REUSEABLE.                     *
*     BENUTZTE MACROS: WTO FREEMAIN REG XSAVE                         *
*                                                                     *
***********************************************************************
         XSAVE R12,,AVR,WORKL
         USING WORK,R13
         USING PARMAREA,R11
         LR    R11,R1
*        INIT MESSAGES
         MVC   WTO2(MESS2L),MESSAGE2
         MVC   WTO4(MESS4L),MESSAGE4
         LA    R10,WTO2+WTO2DYN
         ST    R10,WTO2D
         MVI   WTOSTAT,WTO2INIT+WTO4INIT
         LA    R10,WTO4+WTO4DYN
         ST    R10,WTO4D
*        UCB ADDRESS LIST IN UCB LOOKUP TABLE
         LA    R1,VEKTOR
         ST    R1,VEKADDR
         MVI   VEKADDR,X'80'
         LA    R1,VEKADDR
         L     R15,=V(GETUCBS)
         BALR  R14,R15
         MVC   VEKEND,=X'FFFF'
         LA    R7,VEKTOR
         SR    R5,R5
LOADUCB  EQU   *
         CLC   0(2,R7),VEKEND
         BE    ENDLIST
         ICM   R5,3,0(R7)
         LA    R7,2(R7)            NEXT LIST ELEMENT
         B     LOADUCB
ENDLIST  EQU   *
         ST    R7,SAVE7
AGAIN    EQU   *
         LA    R3,VEKTOR
         L     R7,SAVE7
         SR    R5,R5
NEXTADDR EQU   *
         BCTR  R7,0
         BCTR  R7,0                LIST ELEMENT BEFOR LAST ONE
         ICM   R5,3,0(R7)
         B     WORKUCB             VALID ADDR
NEXTUCB  EQU   *
         CR    R7,R3               WAS THAT THE FIRST ONE
         BNH   LASTUCB
         B     NEXTADDR
*        TEST THE UCB
WORKUCB  EQU   *
         TM    2(R5),X'FF'
         BNO   BRETURN
         TM    3(R5),X'80'         ONLINE
         BNO   NEXTUCB
         TM    3(R5),X'40'         CHANGE TO OFFLINE
         BO    NEXTUCB
         CLI   18(R5),X'80'        MAGNETIC TAPE
         BNE   NEXTUCB
         TM    3(R5),X'08'         ALLOCATED
         BO    NEXTUCB
         LR    R2,R4
         TM    6(R5),X'40'         NOT READY
         BO    WMESS2
         CLI   28(R5),X'00'        VOLSER
         BE    WMESS4
         B     NEXTUCB
*        INSERT UCB ADDR INTO OUTPUT MESSAGES
WMESS2   EQU   *
         TM    WTOSTAT,WTO4ONLY    SECOND LOOP
         BO    NEXTUCB
         L     R10,WTO2D           LOAD NEXT PLACE
         L     R9,12(R5)           LOAD UCB ADDR
         ST    R9,0(R10)           STORE INTO MESSAGE
         MVI   0(R10),X'40'        INSERT BLANK
         OI    WTOSTAT,WTO2FILL    SET FILLED INDICATOR
         LA    R10,4(R10)          NEXT PLACE
         ST    R10,WTO2D
         LA    R9,WTO2+WTO2L
         CR    R10,R9              MESSAGE FILLED
         BL    NEXTUCB
         BAL   R8,WMESS21
         B     NEXTUCB
WMESS4   EQU   *
         TM    WTOSTAT,WTO4FULL    WTO4 ALLREADY FULL
         BO    WMESS40
         L     R10,WTO4D           LOAD NEXT PLACE
         L     R9,12(R5)           LOAD UCB ADDR
         ST    R9,0(R10)           STORE INTO MESSAGE
         MVI   0(R10),X'40'        INSERT BLANK
         OI    WTOSTAT,WTO4FILL    SET FILLED INDICATOR
         LA    R10,4(R10)          NEXT PLACE
         ST    R10,WTO4D
         LA    R9,WTO4+WTO4L
         CR    R10,R9              MESSAGE FILLED
         BL    NEXTUCB
         BAL   R8,WMESS41
         B     NEXTUCB
WMESS40  EQU   *
         OI    WTOSTAT,WTO4OVFL    TRY IT IN THE NEXT LOOP
         B     NEXTUCB
*        SEND PREPARED MESSAGES
WMESS21  EQU   *
         TM    WTOSTAT,WTO2INIT    FIRST TIME
         BNO   WMESS22
         L     R0,REG4             SET CONSOLE ID
         LA    R1,MESSAGE1
         BAL   R14,WTOROUT
WMESS22  EQU   *
         NI    WTOSTAT,WTOALL-WTO2INIT-WTO2FILL
         L     R0,REG4             INSERT CONSOLE ID
         LA    R1,WTO2
         BAL   R14,WTOROUT
         MVC   WTO2(MESS2L),MESSAGE2
         LA    R10,WTO2+WTO2DYN    FIRST FREE SPACE
         ST    R10,WTO2D
         BR    R8                  RETURN
WMESS41  EQU   *
         TM    WTOSTAT,WTO4ONLY    SECOND LOOP
         BO    WMESS42
         OI    WTOSTAT,WTO4FULL    WTO4 TOTALY FILLED
         BR    R8
WMESS42  EQU   *
         TM    WTOSTAT,WTO4INIT+WTO4FILL MESSAGEE3 NESS
         BNO   WMESS43
         L     R0,REG4             LOAD CONSOLE ID
         LA    R1,MESSAGE3
         BAL   R14,WTOROUT
WMESS43  EQU   *
         NI    WTOSTAT,WTOALL-WTO4INIT-WTO4FILL
         L     R0,REG4             INSERT CONSOLE ID
         LA    R1,WTO4
         BAL   R14,WTOROUT
         MVC   WTO4(MESS4L),MESSAGE4
         LA    R10,WTO4+WTO4DYN    FIRST FREE SPACE
         ST    R10,WTO4D
         BR    R8                  RETURN
*        TEST FOR RETURN
LASTUCB  EQU   *
TEST1    EQU   *
         TM    WTOSTAT,WTO4ONLY    SECONDLOOP
         BO    TEST2
         TM    WTOSTAT,WTO2FILL
         BO    GEF1
         TM    WTOSTAT,WTO2INIT    ONCE FILLED
         BNO   TEST2
         MVC   WTO2+WTO2DYN(5),=C' NONE'
         LA    R10,WTO2+WTO2DYN+5
         ST    R10,WTO2D
GEF1     EQU   *
         BAL   R8,WMESS21
TEST2    EQU   *
         OI    WTOSTAT,WTO4ONLY
         TM    WTOSTAT,WTO4OVFL    NEED SECOND LOOP
         BO    RETRY2
         TM    WTOSTAT,WTO4FILL
         BNO   RETURN
         BAL   R8,WMESS41
         B     RETURN
RETRY2   EQU   *
         MVI   WTOSTAT,X'00'
         OI    WTOSTAT,WTO4ONLY+WTO4INIT
         MVC   WTO4(MESS4L),MESSAGE4
         LA    R10,WTO4+WTO4DYN    RESET ADDRESS
         ST    R10,WTO4D
         B     AGAIN
BRETURN  EQU   *
         MVC   WTO5(MESS5L),MESSAGE5
         LR    R4,R5               UCB ADDR
         LA    R4,0(R4)
         LA    R10,WTO5+WTO5DYN+5
NEXTLETR EQU   *
         SRDL  R4,4
         SRL   R5,28
         IC    R9,TAB1(R5)
         STC   R9,0(R10)
         BCTR  R10,0
         LTR   R4,R4
         BNZ   NEXTLETR
         L     R0,REG4             INSERT CONSOLE ID
         LA    R1,WTO5
         BAL   R14,WTOROUT
RETURN   EQU   *
         XRETURN ,R
WTOROUT  EQU   *
         ST    R14,SAVE14
         C     R0,=CL4'ROSC'
         BNE   NOROS
         STM   R14,R12,12(R13)                   SAVE ALL REGS IN SA
*
*              NOW WE CAN ADDRESS DUMMYSECTION IN XMON
*
         LH    R0,0(R1)      LOAD LENGTH OF WTO
         SH    R0,=H'4'      DECREMENT BY 4
         STC   R0,3(R1)      INSERT LENGTH TO MESSAGE FOR USE BY ROSCOE
         LA    R0,3(R1)      LOAD MESSAGE ADDRESS
         L     R13,4(R13)    R13 --> SA IN XMON
         ST    R0,76(R13)    STORE IT IN DYN AREA OF XMON = INAREA
         OI    76(R13),X'80' SET HIGHORDER BIT ON
         L     R15,100(R13)  LOAD ROSCOE-CODE <<OUTCODE>>
         LA    R1,76(R13)    LOAD PARAMETER REGISTER
         L     R13,4(R13)    R13 --> SA IN ROSCOE
         L     R14,12(R13)   LOAD RETURNADDRESS
         LM    R2,R12,28(R13)                    LOAD REMAINDER
         BR    R14           RETURN DIRECT TO ROSCOE
NOROS    EQU   *
         C     R0,=CL4'TSO'
         BNE   DOWTO
         LH    R0,0(R1)
         SH    R0,=H'4'
         LA    R1,4(R1)
         SVC   93             **** TPUT ***
         L     R14,SAVE14
         BR    R14
DOWTO    EQU   *
         WTO   MF=(E,(1))
         L     R14,SAVE14
         BR    R14
         LTORG
TAB2     DC    X'000A0B0C0D0E0F000000000000000000'
TAB1     DC    C'0123456789ABCDEF'
MESSAGE1 WTO   'XAVR001 TAPE UNIT(S) AVAILABLE FOR AVR MOUNT',         *
               MCSFLAG=(REG0),MF=L
MESSAGE2 WTO   'XAVR002                                                *
                      ',                                               *
               MCSFLAG=(REG0),MF=L
MESS2L   EQU   *-MESSAGE2
MESSAGE3 WTO   'XAVR003 TAPE UNIT(S) ONLINE NO VOLSER',                *
               MCSFLAG=(REG0),MF=L
MESSAGE4 WTO   'XAVR004                                                *
                      ',                                               *
               MCSFLAG=(REG0),MF=L
MESS4L   EQU   *-MESSAGE4
MESSAGE5 WTO   'XAVR005 INVALID UCB FOUND AT ADDRESS 000000 ',         *
               MCSFLAG=(REG0),MF=L
MESS5L   EQU   *-MESSAGE5
WTO2L    EQU   63
WTO4L    EQU   63
WTO2DYN  EQU   11
WTO4DYN  EQU   11
WTO5DYN  EQU   41
         REG
         XPARM
WORK     DSECT
SVA      DS    18F
SAVE14   DS    F
SAVE3    DS    F
SAVE7    DS    F
HEX      DS    F
WTO2D    DS    F
WTO4D    DS    F
WTO2     DS    CL72
WTO4     DS    CL72
WTO5     DS    CL54
WTOSTAT  DS    XL1
WTO2INIT EQU   128                   INIT MESSAGE2
WTO4INIT EQU   64                    INIT MESSAGE4
WTO2FILL EQU   32                  MESSAGE2 FILLED
WTO4FILL EQU   16                  MESSAGE4 FILLED
WTO4FULL EQU   8                   MESSAGE4 FULL
WTO4OVFL EQU   4                   SECOND LOOP
WTO4ONLY EQU   2                   FIRST LOOP DONE
WTOALL   EQU   255
VEKADDR  DS    F
VEKTOR   DS    1024H
VEKEND   DS    H
WORKL    EQU   *-WORK
         END
./ ADD NAME=CATLG
CATLG    START
         REG
         XSAVE R12,,LUXCATLG,WORKL
         LR    R11,R1
         USING WORK,R13
         USING PARMAREA,R11
         MVC   UNCLIST,UNCLISTS
         LA    R2,DSNAME
         ST    R2,UNCLIST+4
         LA    R2,VOLNO
         ST    R2,UNCLIST+12
         MVC   SEQNO,=C'0001'
         MVI   DSNAME,C' '
         MVC   DSNAME+1(43),DSNAME
         MVC   UNIT(6),=CL6' '
         MVC   CVOL,=CL6' '
         XC    VOLNO,VOLNO
         LA    R8,TEXT+6
         LA    R3,100
         LR    R4,R8
         LA    R5,100(R8)
DSN1     EQU   *
         CLC   0(2,R4),=CL2'D='
         BNE   DSN3
         LA    R4,2(R4)
         B     DSN5
DSN3     EQU   *
         LA    R4,1(R4)
         BCT   R3,DSN1
         MVC   WTO,MESS1
GIVEWTO  EQU   *
         L     R0,REG4
         LA    R1,WTO
         LA    R14,RETURN
         C     R0,=CL4'ROSC'
         BNE   NOROS
         STM   R14,R12,12(R13)                   SAVE ALL REGS IN SA
*
*              NOW WE CAN ADDRESS DUMMYSECTION IN XMON
*
         LH    R0,0(R1)      LOAD LENGTH OF WTO
         SH    R0,=H'4'      DECREMENT BY 4
         STC   R0,3(R1)      INSERT LENGTH TO MESSAGE FOR USE BY ROSCOE
         LA    R0,3(R1)      LOAD MESSAGE ADDRESS
         L     R13,4(R13)    R13 --> SA IN XMON
         ST    R0,76(R13)    STORE IT IN DYN AREA OF XMON = INAREA
         OI    76(R13),X'80' SET HIGHORDER BIT ON
         L     R15,100(R13)  LOAD ROSCOE-CODE <<OUTCODE>>
         LA    R1,76(R13)    LOAD PARAMETER REGISTER
         L     R13,4(R13)    R13 --> SA IN ROSCOE
         L     R14,12(R13)   LOAD RETURNADDRESS
         LM    R2,R12,28(R13)                    LOAD REMAINDER
         BR    R14           RETURN DIRECT TO ROSCOE
NOROS    EQU   *
         C     R0,=CL4'TSO'
         BNE   DOWTO
         LH    R0,WTO
         SH    R0,=H'4'
         LA    R1,WTO+4
         SVC   93             *** TPUT ***
         B     RETURN
DOWTO    EQU   *
         WTO   MF=(E,WTO)
         B     RETURN
DSN5     EQU   *
         LR    R7,R5
         SR    R7,R4
         EX    R7,TCOMMA
         BNZ   DSN6
         LA    R1,1(R5)
DSN6     EQU   *
         SR    R1,R4
         BCTR  R1,0
         LTR   R1,R1
         BNM   DSN8
DELERROR EQU   *
         MVC   WTO,MESS2
         B     GIVEWTO
DSN8     EQU   *
         EX    R1,MOVEDSN
         LR    R4,R8
         LA    R3,100
UNIT1    EQU   *
         CLC   0(2,R4),=CL2'U='
         BE    UNIT2
         LA    R4,1(R4)
         BCT   R3,UNIT1
         MVC   WTO,MESS1
         MVC   WTO+40(2),=CL2'U='
         B     GIVEWTO
UNIT2    EQU   *
         LA    R4,2(R4)
         LR    R7,R5
         SR    R7,R4
         EX    R7,TCOMMA
         BNZ   UNIT5
         LA    R1,1(R5)
UNIT5    EQU   *
         SR    R1,R4
         BCTR  R1,0
         LTR   R1,R1
         BM    DELERROR
         EX    R1,MOVEUNT
         CLC   UNIT(2),=CL2'24'
         BE    XXX
         CLC   UNIT(2),=CL2'34'
         BE    XXX
         CLC   UNIT(4),=C'TAPE'
         BNE   SEQ7
XXX      EQU   *
         LR    R4,R8
         LA    R3,100
SEQ1     EQU   *
         CLC   0(2,R4),=CL2'S='
         BE    SEQ2
         LA    R4,1(R4)
         BCT   R3,SEQ1
         B     VOL1
SEQ7     EQU   *
         MVI   SEQNO+3,C'0'
         B     VOL1
SEQ2     EQU   *
         LA    R4,2(R4)
         LR    R7,R5
         SR    R7,R4
         EX    R7,TCOMMA
         BNZ   SEQ5
         LA    R1,1(R5)
SEQ5     EQU   *
         SR    R1,R4
         BCTR  R1,0
         LTR   R1,R1
         BM    DELERROR
         EX    R1,TNUM
         BZ    SEQ6
         MVC   WTO,MESS1
         MVC   WTO+40(2),=CL2'S='
         B     GIVEWTO
SEQ6     EQU   *
         LA    R9,SEQNO+3
         SR    R9,R1
         EX    R1,MOVESEQ
VOL1     EQU   *
         LR    R4,R8
         LA    R3,100
CVOL1    EQU   *
         CLC   0(2,R4),=CL2'C='
         BE    CVOL2
         LA    R4,1(R4)
         BCT   R3,CVOL1
         B     CVOLEND
CVOL2    EQU   *
         L     R15,16
         TM    116(R15),X'01'
         BNO   NOMVS
         MVC   WTO,MESS13
         B     GIVEWTO
NOMVS    EQU   *
         LA    R4,2(R4)
         LR    R7,R5
         SR    R7,R4
         EX    R7,TCOMMA
         BNZ   CVOL3
         LA    R1,1(R5)
CVOL3    EQU   *
         SR    R1,R4
         BCTR  R1,0
         LTR   R1,R1
         BM    DELERROR
         EX    R1,MOVECVOL
CVOLEND  EQU   *
         LR    R4,R8
         LA    R3,100
VOL2     EQU   *
         CLC   0(2,R4),=CL2'V='
         BE    VOL3
         LA    R4,1(R4)
         BCT   R3,VOL2
         MVC   WTO,MESS1
         MVC   WTO+40(2),=CL2'V='
         B     GIVEWTO
VOL3     EQU   *
         LA    R4,2(R4)
         LA    R8,DEVTAB
         LA    R6,11
         LA    R7,DEVEND-11
VOL6     EQU   *
         CLC   4(6,R8),UNIT
         BE    VOL7
         BXLE  R8,R6,VOL6
         MVC   WTO,MESS3
         B     GIVEWTO
VOL7     EQU   *
         LH    R2,VOLNO
         LA    R9,VOLIST
         LA    R3,VOLIST+240
         CLI   0(R4),C'('
         BE    VOL11
         LR    R7,R5
         SR    R7,R4
         ST    R2,ALIST
         EX    R7,TCOMMA
         L     R2,ALIST
         BNZ   VOL8
         LA    R1,1(R5)
VOL8     EQU   *
         SR    R1,R4
         CH    R1,=H'6'
         BNH   VOL9
         MVC   WTO,MESS4
         B     GIVEWTO
VOL9     EQU   *
         MVC   0(4,R9),0(R8)
         BCTR  R1,0
         MVI   4(R9),X'40'
         MVC   5(5,R9),4(R9)
         EX    R1,MOVESER
         PACK  D,SEQNO
         CVB   R1,D
         STH   R1,10(R9)
         LA    R2,1(R2)
VOL10    EQU   *
         STH   R2,VOLNO
         B     ENDRT2
VOL11    EQU   *
         PACK  D,SEQNO
         CVB   R1,D
VOL12    EQU   *
         LA    R4,1(R4)
         STM   R1,R2,WTO
         LR    R7,R5
         SR    R7,R4
         EX    R7,TKLAM
         BZ    DELERROR
         SR    R1,R4
         LR    R6,R1
         LM    R1,R2,WTO
         BCTR  R6,0
         MVI   4(R9),X'40'
         MVC   5(5,R9),4(R9)
         EX    R6,MOVESER
         MVC   0(4,R9),0(R8)
         LA    R4,1(R6,R4)
         STH   R1,10(R9)
         LA    R2,1(R2)
         CLI   0(R4),C')'
         BE    VOL10
         LA    R9,12(R9)
         CR    R9,R3
         BL    VOL12
         MVC   WTO,MESS5
         B     GIVEWTO
ENDRT2   EQU   *
         CLC   CVOL,=CL6' '
         BE    NOCVOL
         LA    R1,CVOL
         ST    R1,UNCLIST+8
         OI    UNCLIST,X'80'
NOCVOL   EQU   *
         CATALOG UNCLIST
         LA    R9,ERRTAB
         AR    R9,R15
         L     R9,0(R9)
         MVC   WTO,0(R9)
         B     GIVEWTO
RETURN   EQU   *
         XRETURN ,R
ERRTAB   DS    0F
         DC    A(MESS6)
         DC    A(MESS7)
         DC    A(MESS8)
         DC    A(0)
         DC    A(MESS9)
         DC    A(MESS10)
         DC    A(MESS11)
         DC    A(MESS12)
UNCLISTS CAMLST CATBX,ERRTAB,,ERRTAB
TKLAM    TRT   0(0,R4),TTAB
TTAB     DC    93X'00',X'FF',13X'00',X'FF',148X'00'
TCOMMA   TRT   0(0,R4),TRTTAB
TRTTAB   DC    64X'00',X'FF',42X'00',X'FF',148X'00'
MOVEDSN  MVC   DSNAME(0),0(R4)
MOVEUNT  MVC   UNIT(0),0(R4)
TNUM     TRT   0(0,R4),NUMTAB
NUMTAB   DC    240X'FF',10X'00',6X'FF'
MOVESEQ  MVC   0(0,R9),0(R4)
MOVESER  MVC   4(0,R9),0(R4)
MOVECVOL MVC   CVOL(0),0(R4)
DEVTAB   DC    X'34008003'
         DC    C'3400-36'
         DC    X'32108003'
         DC    C'TAPE  4'
         DC    X'30502009'
         DC    C'3330  4'
         DC    X'30582009'
         DC    C'3330V 5'
         DC    X'3050200B'
         DC    C'3350  4'
         DC    X'3050200D'
         DC    C'3311  4'
         DC    X'3050200D'
         DC    C'3330-16'
         DC    X'34208003'
         DC    C'3400-46'
         DC    X'30C08003'
         DC    C'3400-26'
         DC    X'32108003'
         DC    C'3400-66'
         DC    X'3010200E'
         DC    C'3380  4'
DEVEND   EQU   *
MESS1    WTO   'XCATLG0 INVALID OR MISSING KEYWORD: D=.',MCSFLAG=REG0, *
               MF=L
MESS2    WTO   'XCATLG1 DELIMITER ERROR',MCSFLAG=REG0,MF=L
MESS3    WTO   'XCATLG2 INVALID UNIT NAME',MCSFLAG=REG0,MF=L
MESS4    WTO   'XCATLG3 INVALID VOLSER',MCSFLAG=REG0,MF=L
MESS5    WTO   'XCATLG4 MORE THAN 20 VOLSERS',MCSFLAG=REG0,MF=L
MESS6    WTO   'XCATLG5 SPECIFIED DSNAME NOW CATALOGED',MCSFLAG=REG0,  *
               MF=L
MESS7    WTO   'XCATLG5 CATALOG VOLUME NOT MOUNTED',MCSFLAG=REG0,MF=L
MESS8    WTO   'XCATLG5 INCONSISTENT INDEX STRUCTURE',MCSFLAG=REG0,    *
               MF=L
MESS9    WTO   'XCATLG5 INDEX STRUCTURE DOES NOT EXIST',MCSFLAG=REG0,  *
               MF=L
MESS10   WTO   'XCATLG5 NO SPACE AVAILABLE IN THE CATALOG DATA SET',   *
               MCSFLAG=REG0,MF=L
MESS11   WTO   'XCATLG5 INPROPERLY NAMED GENERATION DATA GROUP',       *
               MCSFLAG=REG0,MF=L
MESS12   WTO   'XCATLG5 PERM. I/O ERROR',MCSFLAG=REG0,MF=L
MESS13   WTO   'XCATLG5 CVOL SPECIFIC. NOT ALLOWED IN MVS',            *
               MCSFLAG=REG0,MF=L
         DS    CL100
         LTORG
WORK     DSECT
SVA      DS    18F
WTO      DS    CL108
         DS    0F
UNCLIST  DS    CL16
DSNAME   DS    CL44
         CNOP  2,4
VOLNO    DS    H
VOLIST   DS    20CL12
SEQNO    DS    CL4
UNIT     DS    CL6
CVOL     DS    CL6
D        DS    D
ALIST    DS    F
WORKL    EQU   *-WORK
         XPARM
         END
./ ADD NAME=CMD
XCMD     START
         REG
         XSAVE R12,SVA,XCMD
         USING PARMAREA,R11
         LR    R11,R1
         CLC   REG4(4),=CL4'TSO'
         BE    TSO
         CLC   REG4(4),=CL4'ROSC'
         BE    TSO
         L     R0,REG4
         WTO   'XCMD01I X-CMD ALLOWED ONLY FOR TSO/ROSCOE',MCSFLAG=REG0
         B     RETURN
TSO      EQU   *
         L     R1,16
         L     R1,0(R1)
         L     R1,4(R1)
         L     R1,12(R1)
         MVC   CMDID+7(8),0(R1)
         CLC   REG4(4),=C'ROSC'
         BNE   NOROS
         MVC   CMDID+7(11),X'87'(R5)
NOROS    EQU   *
         MVC   BUF(99),TEXT+4
         MVC   WTOBUF+1,BUF
         LA    R1,WTOX
         LA    R15,SVCROUT
         SVC   250
         LA    R1,CMD
         SVC   249
RETURN   EQU   *
         XRETURN 0
SVCROUT  EQU   *
         SVC   35
         BR    R14
CMD      DS    0H
         DC    H'103',X'4000'
BUF      DC    CL99' '
         DS    0F
WTOX     DC    H'080',X'4000'
CMDID    DC    CL20'CMD BY             :'
WTOBUF   DC    CL99' '
         XPARM
         END
./ ADD NAME=XDA
         TITLE 'DISPLAY ACTIVITIES'
XDA      START
         XSAVE R12,,XDA,WORKL
         USING WORK,R13
         USING PARMAREA,R11
         LR    R11,R1                  ESTABLISH ADDRESS OF XPARM
         L     R3,CVTPTR
         MVC   MODE,116(R3)     SAVE THE MODE
         MVC   USERID,=CL8' '
         CLC   TEXT+3(2),=CL2'U='
         BNE   TSTCB
         OI    FUNCIND,DISPALL+DISPTME1
         SR    R1,R1
         LA    R15,TEXT+5
SRCHU    EQU   *
         CLI   0(R15),C' '
         BE    FNDU
         LA    R15,1(R15)
         LA    R1,1(R1)
         B     SRCHU
MVCUID   MVC   USERID(0),TEXT+5
FNDU     EQU   *
         BCTR  R1,0
         STH   R1,USERIDL
         EX    R1,MVCUID
         MVI   CLCUID+1,X'00'
         MVC   XDA1T+(XDA4EXCP-XDA4)(6),=CL6'EXCP''S'    ICR 09.07.83
         B     DAINIT
TSTCB    EQU   *
         CLC   TEXT+3(2),=CL2'CB'
         BE    DSPCBS
         MVI   IOSW,0                  CLEAR IO-SWITCH
         MVI   FUNCIND,0               CLEAR FUNCTION INDICATOR
         LA    R1,TEXT+2               START ADDRESS OF DA OPTIONS
OPTLP    CLI   0(R1),C','              END OF OPTIONS?
         BNE   OPTLPE                  BR IF YES
         LA    R1,1(,R1)               ADDRESS OF NEXT BYTE
         LA    R0,ANZDOPT              LOAD # OF VALID OPTIONS
         LA    R15,DISPOPT             LOAD ADDRESS OF FIRST OPTION
         SR    R14,R14                 CLEAR R14
OPT1LP   IC    R14,0(,R15)             INSERT LENGTH OF CURRENT OPT
         BCTR  R14,0                   DECREMENT BY 1 FOR EX CLC
         EX    R14,CLCOPT              COMPARE
         BE    OPT1LPE                 BR IF EQUAL
         LA    R15,L'DISPOPT(,R15)     ADDRESS OF NEXT OPTION
         BCT   R0,OPT1LP               BCT
         B     OPTLPE
OPT1LPE  OC    FUNCIND,9(R15)          OR
NOIO1    EQU   *
         LA    R1,1(R14,R1)            ADDRESS OF NEXT BYTE
         B     OPTLP                   PROCESS NEXT OPTION
CLCOPT   CLC   0(0,R1),1(R15)          COMPARE OPTIONS
OPTLPE   EQU   *
         MVC   XDA1T+(XDA4EXCP-XDA4)(6),=CL6'EXCP''S'    ICR 09.07.83
NOIO     EQU   *
         TM    FUNCIND,X'F0'           ANY OPTION GIVEN?
         BNZ   DAINIT                  BR IF YES
         TM    FUNCIND,DISPPAGE        PAGING STATISTICS TO BE DISPL.?
         BO    DAINIT                  BR IF YES
         OI    FUNCIND,DISPDFLT        IF NO - ASSUME DEFAULT
*
DAINIT   MVI   HEADSW,C'N'             INDICATE HEADLINE NOT WRITTEN
         L     R4,CVTASVT(R3)          LOAD ADDRESS OF ASVT
         LA    R5,ASVTENTY(R4)         LOAD ADDRESS OF FIRST ENTRY
         TM    FUNCIND,DISPPAGE        FUNCTION INDICATOR = PAGE?
         BO    PAGEPROC                BR IF YES
         TM    FUNCIND,DISPTIME        FUNCTION INDICATOR = TIME?
         BZ    SLOTPROC                BR IF NO
         LA    R7,TIMEBLK-8            LOAD ADDRESS OF TIME WKAREA
         BAL   R9,TIMELP1              SAVE TIMER VALUES
         STCK  TOD1                    SAVE TOD-CLOCK
*
         NI    FUNCIND,255-DISPSUPP    SET BIT TO ZERO
         TM    MODE,XA                 XA-MODE
         BZ    STIMER                  NO, 370
         SPACE
         SPLEVEL SET=2
         STIMER WAIT,BINTVL=ONESECND   WAIT FOR 1 SECOND      XA
         B     STIMEND
*
STIMER   EQU   *
         SPLEVEL SET=1
         STIMER WAIT,BINTVL=ONESECND   WAIT FOR ONE SECOND    370
         SPACE
STIMEND  EQU   *
         LA    R5,ASVTENTY(R4)         LOAD ADDRESS OF FIRST ASVT ENTRY
         LA    R7,TIMEBLK              LOAD ADDRESS OF TIMER WKAREA
         SR    R10,R10                 ZERO TIMER SUM
         BAL   R9,TIMELP1              SAVE TIMER VALUES
         STCK  TOD2                    SAVE TOD-CLOCK
         BAL   R2,BTODDIFF             BUILD TOD DIFFERENCE
         LTR   R10,R10                 SUM OF ALL TIMERS = 0?
         BNZ   *+8                     BR IF NO
         LA    R10,1                   SET SUM TO NONZERO
         ST    R10,TIMESUM             STORE IT
*
SLOTPROC LA    R5,ASVTENTY(R4)         LOAD ADDRESS OF FIRST ASVT ENTRY
         L     R7,ASVTMAXU(R4)
         MH    R7,=H'4'
         AR    R7,R5
         ST    R7,MAXADR
         LA    R10,TIMEBLK             LOAD ADDRESS OF TIMER WKAREA
         SR    R2,R2                   CLEAR R2 (INIT COUNT)
         SR    R3,R3                   CLEAR R3 (TS USER COUNT)
ASVTLOOP TM    0(R5),ASVTAVAL          ASID ASSIGNED?
         BO    NXTENTY                 BR IF NO
         L     R6,0(,R5)               LOAD ADDRESS OF ASCB
         BAL   R9,DAASCB               CALL PROCESSOR OF ASCB
NXTENTY  LA    R5,4(,R5)               ADDRESS OF NEXT ASCB PTR
         LA    R10,L'TIMEBLK(R10)      ADDRESS OF NEXT TIME ELEMENT
         C     R5,MAXADR        LAST ENTRY?
         BL    ASVTLOOP                BR IF NO
DA2      EQU   *
         MODE24
         XRETURN 0,R
         SPACE 4
         EJECT
PAGEPROC EQU   *
         LA    R7,PAGEBLK-12           LOAD ADDRESS OF PAGE WKAREA
         BAL   R9,PAGELP1              SAVE PAGING VALUES
         STCK  TOD1                    SAVE TOD CLOCK VALUE
*
         NI    FUNCIND,255-DISPSUPP    SET BIT TO ZERO
         STIMER WAIT,BINTVL=THREESEC   WAIT FOR 3 SECONDS
*
         LA    R5,ASVTENTY(R4)         LOAD ADDRESS OF FIRST ASVT ENTRY
         LA    R7,PAGEBLK              LOAD ADDRESS OF PAGE WKAREA
         BAL   R9,PAGELP1              SAVE PAGER VALUES
         STCK  TOD2                    SAVE TOD CLOCK VALUE
         TM    FUNCIND,X'F0'           ANY OPTIONS GIVEN?
         BNZ   PAGEOPTD                BR IF YES
         BAL   R2,BTODDIFF             BUILD TOD DIFFERENCE
         L     R0,REG4                 LOAD CONSOLE-ID
         LA    R1,XDA5DS
         BAL   R14,WTOROUT
         L     R15,TODDIFF             LOAD TOD DIFFERENCE
         MVC   XDA6,XDA6DS             MOVE MSG SKELETON
         MVC   XDA6TYPE,=C'DEMAND '    MOVE TYPE
         L     R1,PAGEVAL2+0           PAGE-IN, 2. VALUE
         L     R14,PAGEVAL1+0          PAGE-IN, 1. VALUE
         BAL   R8,BPAGEVAL             BUILD PAGE-IN/SEC
         MVC   XDA6IN,MASKAREA+1       MOVE TO MSG
         ZAP   SPAGEIN,DOPWORT         SAVE VALUE
         ZAP   SPAGEIO,DOPWORT         SAVE VALUE
         L     R1,PAGEVAL2+4           PAGE-OUT, 2. VALUE
         L     R14,PAGEVAL1+4          PAGE-OUT, 1. VALUE
         BAL   R8,BPAGEVAL             BUILD PAGE-OUT/SEC
         MVC   XDA6OUT,MASKAREA+1      MOVE TO MSG
         ZAP   SPAGEOUT,DOPWORT        SAVE VALUE
         AP    SPAGEIO,DOPWORT         SAVE VALUE
         L     R1,PAGEVAL2+28          PAGE-REC, 2. VALUE
         L     R14,PAGEVAL1+28         PAGE-REC, 1. VALUE
         BAL   R8,BPAGEVAL             BUILD PAGE-REC/SEC
         MVC   XDA6REC,MASKAREA+1      MOVE TO MSG
         ZAP   SPAGEREC,DOPWORT        SAVE VALUE
         ZAP   SPAGETOT,DOPWORT        SAVE VALUE
         ZAP   DOPWORT,SPAGEIO         PAGE-IO/SEC VALUE
         BAL   R8,BPAGEVL1             EDIT VALUE
         MVC   XDA6PGIO,MASKAREA+1     MOVE TO MSG
         AP    DOPWORT,SPAGETOT        TOTAL PAGE/SEC VALUE
         BAL   R8,BPAGEVL1             EDIT VALUE
         MVC   XDA6PAGE,MASKAREA+1     MOVE TO MSG
         L     R0,REG4                 LOAD CONSOLE-ID
         LA    R1,XDA6
         BAL   R14,WTOROUT
*
         L     R15,TODDIFF             LOAD TOD DIFFERENCE
         MVC   XDA6TYPE,=C'VIO    '    MOVE TYPE
         L     R1,PAGEVAL2+8           PAGE-IN, 2. VALUE
         L     R14,PAGEVAL1+8          PAGE-IN, 1. VALUE
         BAL   R8,BPAGEVAL             BUILD PAGE-IN/SEC
         MVC   XDA6IN,MASKAREA+1       MOVE TO MSG
         AP    SPAGEIN,DOPWORT         SAVE VALUE
         ZAP   SPAGEIO,DOPWORT         SAVE VALUE
         L     R1,PAGEVAL2+12          PAGE-OUT, 2. VALUE
         L     R14,PAGEVAL1+12         PAGE-OUT, 1. VALUE
         BAL   R8,BPAGEVAL             BUILD PAGE-OUT/SEC
         MVC   XDA6OUT,MASKAREA+1      MOVE TO MSG
         AP    SPAGEOUT,DOPWORT        SAVE VALUE
         AP    SPAGEIO,DOPWORT         SAVE VALUE
         L     R1,PAGEVAL2+16          PAGE-REC, 2. VALUE
         L     R14,PAGEVAL1+16         PAGE-REC, 1. VALUE
         BAL   R8,BPAGEVAL             BUILD PAGE-REC/SEC
         MVC   XDA6REC,MASKAREA+1      MOVE TO MSG
         AP    SPAGEREC,DOPWORT        SAVE VALUE
         ZAP   SPAGETOT,DOPWORT        SAVE VALUE
         ZAP   DOPWORT,SPAGEIO         PAGE-IO/SEC VALUE
         BAL   R8,BPAGEVL1             EDIT VALUE
         MVC   XDA6PGIO,MASKAREA+1     MOVE TO MSG
         AP    DOPWORT,SPAGETOT        TOTAL PAGE/SEC VALUE
         BAL   R8,BPAGEVL1             EDIT VALUE
         MVC   XDA6PAGE,MASKAREA+1     MOVE TO MSG
         L     R0,REG4                 LOAD CONSOLE-ID
         LA    R1,XDA6
         BAL   R14,WTOROUT
*
         L     R15,TODDIFF             LOAD TOD DIFFERENCE
         MVC   XDA6TYPE,=C'SWAP   '    MOVE TYPE
         L     R1,PAGEVAL2+20          PAGE-IN, 2. VALUE
         L     R14,PAGEVAL1+20         PAGE-IN, 1. VALUE
         BAL   R8,BPAGEVAL             BUILD PAGE-IN/SEC
         MVC   XDA6IN,MASKAREA+1       MOVE TO MSG
         AP    SPAGEIN,DOPWORT         SAVE VALUE
         ZAP   SPAGEIO,DOPWORT         SAVE VALUE
         L     R1,PAGEVAL2+24          PAGE-OUT, 2. VALUE
         L     R14,PAGEVAL1+24         PAGE-OUT, 1. VALUE
         BAL   R8,BPAGEVAL             BUILD PAGE-OUT/SEC
         MVC   XDA6OUT,MASKAREA+1      MOVE TO MSG
         AP    SPAGEOUT,DOPWORT        SAVE VALUE
         AP    SPAGEIO,DOPWORT         SAVE VALUE
         SR    R1,R1                   PAGE-REC, 2. VALUE
         SR    R14,R14                 PAGE-REC, 1. VALUE
         BAL   R8,BPAGEVAL             BUILD PAGE-REC/SEC
         MVC   XDA6REC,MASKAREA+1      MOVE TO MSG
         AP    SPAGEREC,DOPWORT        SAVE VALUE
         ZAP   SPAGETOT,DOPWORT        SAVE VALUE
         ZAP   DOPWORT,SPAGEIO         PAGE-IO/SEC VALUE
         BAL   R8,BPAGEVL1             EDIT VALUE
         MVC   XDA6PGIO,MASKAREA+1     MOVE TO MSG
         AP    DOPWORT,SPAGETOT        TOTAL PAGE/SEC VALUE
         BAL   R8,BPAGEVL1             EDIT VALUE
         MVC   XDA6PAGE,MASKAREA+1     MOVE TO MSG
         L     R0,REG4                 LOAD CONSOLE-ID
         LA    R1,XDA6
         BAL   R14,WTOROUT
         MVC   XDA6TYPE,=C'*TOTAL*'    MOVE TYPE
         ZAP   DOPWORT,SPAGEIN         MOVE VALUE
         BAL   R8,BPAGEVL1             BUILD PAGE-IN/SEC
         MVC   XDA6IN,MASKAREA+1       MOVE TO MSG
         ZAP   DOPWORT,SPAGEOUT        MOVE VALUE
         BAL   R8,BPAGEVL1             BUILD PAGE-OUT/SEC
         MVC   XDA6OUT,MASKAREA+1      MOVE TO MSG
         ZAP   DOPWORT,SPAGEREC        MOVE VALUE
         BAL   R8,BPAGEVL1             BUILD PAGE-REC/SEC
         MVC   XDA6REC,MASKAREA+1      MOVE TO MSG
         ZAP   DOPWORT,SPAGEIN         COMPUTE
         AP    DOPWORT,SPAGEOUT          PAGE-IO/SEC VALUE
         BAL   R8,BPAGEVL1             EDIT VALUE
         MVC   XDA6PGIO,MASKAREA+1     MOVE TO MSG
         AP    DOPWORT,SPAGEREC        TOTAL PAGE/SEC VALUE
         BAL   R8,BPAGEVL1             EDIT VALUE
         MVC   XDA6PAGE,MASKAREA+1     MOVE TO MSG
         L     R0,REG4                 LOAD CONSOLE-ID
         LA    R1,XDA6
         BAL   R14,WTOROUT
         B     DA2
*
PAGEOPTD LA    R5,ASVTENTY(R4)         LOAD ADDRESS OF FIRST ASVT ENTRY
         L     R7,ASVTMAXU(R4)
         MH    R7,=H'4'
         AR    R7,R5
         ST    R7,MAXADR
         LA    R10,PAGEBLK             LOAD ADDRESS OF PAGER WKAREA
         SR    R2,R2                   CLEAR R2 (INIT COUNT)
         SR    R3,R3                   CLEAR R3 (TS USER COUNT)
ASVTPGLP TM    0(R5),ASVTAVAL          ASID ASSIGNED?
         BO    NXTPGENT                BR IF NO
         L     R6,0(,R5)               LOAD ADDRESS OF ASCB
         BAL   R9,DAASCB               CALL PROCESSOR OF ASCB
NXTPGENT LA    R5,4(,R5)               ADDRESS OF NEXT ASCB PTR
         LA    R10,L'PAGEBLK(R10)      ADDRESS OF NEXT PAGE ELEMENT
         C     R5,MAXADR        LAST ENTRY?
         BL    ASVTPGLP                BR IF NO
         B     DA2                     RETURN
         EJECT
PAGELP1  EQU   *                       PROCESS PAGER VALUES
         TM    FUNCIND,X'F0'           ANY OPTION GIVEN?
         BNZ   PAGELP1S                BR IF YES
         L     R6,CVTPVTP(,R3)         LOAD PVT ADDRESS
         TM    FUNCIND,DISPSUPP        FIRST ENTRY?
         BO    PAGELP11                BR IF YES
         MVC   PAGEVAL2(32),PVTNPIN(R6) SAVE PAGING COUNTER  ICR 9.7.83
         BR    R9                      RETURN
PAGELP11 EQU   *                                             ICR 9.7.83
         MVC   PAGEVAL1(32),PVTNPIN(R6) SAVE PAGING COUNTER  ICR 9.7.83
         BR    R9                      RETURN
PAGELP1S LA    R8,ANZTBLK-1            LOAD NUMBER OF PAGE ELEMENTS
         C     R8,ASVTMAXU(R4)         > MAX. NUMBER OF ADDRESS SP.?
         BNH   *+8                     BR IF NO
         L     R8,ASVTMAXU(R4)         SET IT TO THIS NUMBER
PAGELP1A TM    0(R5),ASVTAVAL          ASID ASSIGNED?
         BO    PAGELP1E                BR IF NO
         L     R6,0(,R5)               LOAD ASCB ADDRESS
         L     R6,ASCBOUXB(,R6)        LOAD OUXB ADDRESS
         STCK  TODVALUE                STORE TOD CLOCK
         MVC   PAGEVAL1(32),OUXBPIN(R6) SAVE PAGING COUNTERS ICR 9.7.83
         MVC   PAGEVAL1+25(8),OUXBCAPI(R6)   SAVE PAG. CTRS. ICR 9.7.83
         L     R14,PAGEVAL1+00         COMPUTE
         A     R14,PAGEVAL1+12           TOTAL
         A     R14,PAGEVAL1+24             PAGE-IN
         ST    R14,12(,R7)                   OP'S
         L     R15,PAGEVAL1+04         COMPUTE
         A     R15,PAGEVAL1+16           PAGE-OUT
         ST    R15,16(,R7)                 OP'S
         L     R0,PAGEVAL1+08          COMPUTE
         A     R0,PAGEVAL1+20            TOTAL
         A     R0,PAGEVAL1+28              RECLAIM
         ST    R0,20(,R7)                    OP'S
         TM    FUNCIND,DISPSUPP        FIRST ENTRY TO THIS LOOP?
         BZ    PAGELP1T                BR IF NO
         MVC   36(8,R7),TODVALUE       MOVE TOD-VALUE
         B     PAGELP1E
PAGELP1T LM    R0,R1,24(R7)            LOAD FIRST TOD VALUE
         LM    R14,R15,TODVALUE        LOAD SECOND TOD VALUE
         BAL   R2,BTODDIF2             BUILD TOD DIFFERENCE
         ST    R15,24(,R7)             STORE TOD DIFFERENCE
PAGELP1E LA    R7,L'PAGEBLK(,R7)       PROCEED TO NEXT PAGE ELEMENT
         LA    R5,4(,R5)               PROCEED TO NEXT ASCB
         BCT   R8,PAGELP1A             PROCESS NEXT ASVT ENTRY
         BR    R9                      RETURN
         EJECT
TIMELP1  EQU   *                       PROCESS TIMER VALUES
         LA    R8,ANZTBLK-1            LOAD NUMBER OF TIMER AREAS
         C     R8,ASVTMAXU(R4)         > MAX. NUMBER OF ADDRESS SP.?
         BNH   *+8                     BR IF NO
         L     R8,ASVTMAXU(R4)         SET IT TO THIS NUMBER
TIMELP1A TM    0(R5),ASVTAVAL          ASID ASSIGNED?
         BO    TIMELP1Z                BR IF NO
         L     R6,0(,R5)               LOAD ASCB ADDRESS
         LM    R14,R15,ASCBEJST(R6)    LOAD JOB STEP TIME
         LM    R0,R1,ASCBSRBT(R6)      LOAD SRB TIME
         SRDA  R14,22                  R15, BIT 31 = 1024 MICROSEC
         SLDA  R0,10                   R0, BIT 31 = 1024 MICROSEC
         TM    FUNCIND,DISPSUPP        FIRST ENTRY TO THIS LOOP?
         BO    TIMELP1S                BR IF YES
         L     R1,0(,R7)               LOAD PREVIOUS CPU TIMER
         CR    R15,R1                  IS CURRENT < PREVIOUS?
         BL    TIMELP1D                BR IF YES
         SR    R1,R15                  COMPUTE DIFFERENCE (NEG)
         S     R0,4(,R7)               COMPUTE DIFF. OF SRB TIMER
         SR    R0,R1                   COMPUTE TOTAL DIFFERENCE
         AR    R10,R0                  ADD IT TO TIMER SUM
         B     TIMELP1R
TIMELP1Z SR    R15,R15                 SET CPU TIMER TO ZERO
TIMELP1D SR    R0,R0                   SET SRB TIMER TO ZERO
TIMELP1R TM    FUNCIND,DISPSRBT        ARE SRB TIMER TO BE DISPL.?
         BZ    TIMELP1S                BR IF NO
         LM    R14,R15,ASCBSRBT(R6)    LOAD SRB TIMER VALUE
         SRDA  R14,22                  R15, BIT 31 = 1024 MICROSEC
TIMELP1S STM   R15,R0,8(R7)            SAVE CPU & SRB TIMER VALUES
         LA    R7,L'TIMEBLK(,R7)       PROCEED TO NEXT TIME ELEMENT
         LA    R5,4(,R5)               PROCEED TO NEXT ASCB
         BCT   R8,TIMELP1A             PROCESS NEXT ASVT ENTRY
         BR    R9                      RETURN
         EJECT
DAASCB   EQU   *
         SPACE
*      SUBROUTIINE TO PROCESS ASCB'S
*      R2 - INIT COUNT
*      R6 - ASCB ADDRESS
*      R9 - RETURN ADDRESS
         SPACE
         MVC   XDA4,XDA4DS             MOVE HEADER TO E-FIELD
         LM    R7,R8,ASCBJBNI(R6)      LOAD ADDRESSES OF JOBNAMES
         CLC   0(8,R8),=CL8'INIT'      SECOND JOBNAME = 'INIT'?
         BNE   NOTINIT                 BR IF NO
         LA    R2,1(,R2)               INCREMENT INIT COUNT
         LTR   R7,R7                   ADDR OF FIRST = 0?
         BNZ   JOBDISP                 BR IF NO
         TM    FUNCIND,DISPSYS         ARE SYS ENTRIES TO BE DISPL.?
         BO    NOTINIT                 BR IF YES
         BR    R9
JOBDISP  TM    FUNCIND,DISPJOB         ARE JOBS TO BE DISPLAYED?
         BCR   8,R9                    BR IF NO
         MVC   XDA4TYP,=CL1'J'         MOVE TYPE          ICR 09.07.83
         LA    R0,8                    R0 = 8
         SLR   R7,R0                   R7 = ADDR (CSCB)
         MVC   XDA4JOBN,CHKEY(R7)      MOVE JOBNAME
         CLI   REG4,X'00'
         BNE   NOCONS
         CLC   XDA4JOBN(2),=C'XH'
         BER   R9
NOCONS   EQU   *
         MVC   XDA4STPN,CHSTEP(R7)     MOVE STEPNAME
         MVC   XDA4PRCN,CHPROCSN(R7)   MOVE PROCSTEPNAME
         B     DPRTYEDT
NOTINIT  L     R7,ASCBCSCB(R6)         LOAD CSCB ADDR
         CLI   0(R8),C'*'              '*MASTER*' OR '*AUXSTM*'?
         BNE   NOTSYS                  BR IF NO
         TM    FUNCIND,DISPSYS         ARE 'SYS'-ENTRIES TO BE DISPL.?
         BCR   8,R9                    BR IF NO
         MVC   XDA4JOBN,0(R8)          MOVE JOBNAME
         B     DPRTYEDT
NOTSYS   CLI   CHTRKID(R7),CHTSID      TSU ID?
         BE    TSUSAVE                 BR IF YES
         CLI   CHTRKID(R7),CHJOBID     JOB ID?
         BE    STCDISP                 BR IF NO
         CLI   CHTRKID(R7),CHINITID    INIT ID?
         BCR   7,R9                    BR IF NO
         TM    FUNCIND,DISPSYS         ARE 'SYS'-ENTRIES TO BE DISPL.?
         BO    SYSDISP                 BR IF YES
         BR    R9
STCDISP  TM    FUNCIND,DISPSTC         ARE STC'S TO BE DISPLAYED?
         BCR   8,R9                    BR IF NO
         MVC   XDA4TYP,=CL1'S'         MOVE TYPE          ICR 09.07.83
SYSDISP  MVC   XDA4JOBN,CHCLS(R7)      MOVE JOBNAME
         MVC   XDA4STPN,CHKEY(R7)      MOVE STEPNAME
         MVC   XDA4PRCN,CHPROCSN(R7)   MOVE PROCSTEPNAME
DPRTYEDT EQU   *
CLCUID   B     NOUIDCLC
         LH    R1,USERIDL
         EX    R1,CLCUIDEX
         BNER  R9
         B     NOUIDCLC
CLCUIDEX CLC   XDA4JOBN(0),USERID
NOUIDCLC EQU   *
         MODE31
         L     R1,ASCBOUCB(R6)
         LH    R0,180(R1)              GET RESET PERFORMANCE-GR.
         LTR   R0,R0
         BNZ   *+8
         LH    R0,182(R1)
         CVD   R0,DOPWORT              CONVERT TO DEC
         OI    DOPWORT+7,X'0F'         SIGN = F
         UNPK  XDA4DP,DOPWORT          UNPK DISP PRTY
         MODE24
         LH    R0,ASCBFMCT(R6)         LOAD ALLOC. PAGE FRAME COUNT
         SLA   R0,2
         CVD   R0,DOPWORT              CONVERT TO DEC
         MVC   MASKAREA,=X'402020202120'  MOVE MASK
         ED    MASKAREA,DOPWORT+5      ED FRAME COUNT
         MVC   XDA4REAL(4),MASKAREA+2  MOVE FRAME COUNT
         MVI   XDA4REAL+4,C'K'         MOVE 'K'
         TM    ASCBRCTF(R6),ASCBOUT    ADDRESS SPACE CONSIDERED OUT?
         BZ    *+10                    BR IF NO
         MVC   XDA4REAL,=CL5' SWAP'    MOVE TEXT
*
         TM    FUNCIND,DISPPAGE        DISPLAY PAGE?
         BO    PGDISP                  BR IF YES
         TM    FUNCIND,DISPTIME        DISPLAY TIME?
         BZ    SCDISP                  BR IF NO
         L     R1,12(,R10)             LOAD TIMER DIFF.
         M     R0,=F'400'              MULTIPLY WITH 400
         D     R0,TIMESUM              DIVIDE BY TIMER SUM
         LA    R1,2(,R1)               ROUND
         SRA   R1,2                    DIVIDE BY 4
         CVD   R1,DOPWORT              CONVERT TO DECIMAL
         MVC   XDA4CPU-1(4),=X'40202120'  MOVE ED MASK
         ED    XDA4CPU-1(4),DOPWORT+6  ED
         MVI   XDA4P100,C'%'           MOVE '%'
*
***      CLI   IOSW,X'FF'              NO IO'S ?
***      BNE   NOIO3                   NO, BRANCH AROUND IO-PRESENTING
         SPACE
         TM    MODE,XA                  XA-MODE?
         BZ    NOXAMODE                 NO, WE CAN USE OUCB FOR EXCP
         SPACE
         MODE31
         L     R1,148(R6)               A(OUXB)
         L     R1,152(R1)               SMF BASE EXCP COUNT
         MODE24
         B     NORMALPR
NOXAMODE EQU   *
         L     R1,144(R6)    A(OUCB)
         L     R1,108(R1)    EXCP-COUNT
NORMALPR EQU   *
         CVD   R1,DOPWORT
         MVC   MASKAREA-2(8),=X'4020202020202120'       ICR 09.07.83
         ED    MASKAREA-2(8),DOPWORT+4                  ICR 09.07.83
         MVC   XDA4EXCP+1(6),MASKAREA                   ICR 09.07.83
NOIO3    EQU   *
         L     R0,8(,R10)              LOAD TCB CPU TIMER VALUE
         SRDA  R0,22                   VALUE IN MICROSEC
         D     R0,=F'1000000'          VALUE IN SECONDS
         MVI   XDA4SM,C' '         NO MORE  SEC SIGN    ICR 09.07.83
         SR    R0,R0                   CLEAR R0 FOR DIV
         D     R0,=F'60'               VALUE IN CENTIMIN
         MH    R1,=H'100'              SHIFT MINUTES
         AR    R1,R0                   R1 = MIN * 100 + SEC
         CVD   R1,DOPWORT              CONVERT TO DECIMAL
         MVC   MASKAREA-1(7),=X'402020207A2120'  MOVE EDIMASK9.07.83
         ED    MASKAREA-1(7),DOPWORT+5 ED TIMER VALUE
         MVC   XDA4CPUT,MASKAREA       MOVE TO MSG
         B     OUTPUT
*
PGDISP   L     R1,12(,R10)             LOAD 2. PAGE-IN VALUE
         L     R14,0(,R10)             LOAD 1. PAGE-IN VALUE
         L     R15,24(,R10)            LOAD TOD DIFFERENCE
         BAL   R8,BPAGEVAL             BUILD PAGE/SEC VALUE
         MVC   XDA4PIN,MASKAREA+1      MOVE TO MSG
         L     R1,16(,R10)             LOAD 2. PAGE-OUT VALUE
         L     R14,4(,R10)             LOAD 1. PAGE-OUT VALUE
         BAL   R8,BPAGEVAL             BUILD PAGE/SEC VALUE
         MVC   XDA4POUT,MASKAREA+1     MOVE TO MSG
         L     R1,20(,R10)             LOAD 2. PAGE-REC VALUE
         L     R14,8(,R10)             LOAD 1. PAGE-REC VALUE
         BAL   R8,BPAGEVAL             BUILD PAGE/SEC VALUE
         MVC   XDA4PREC,MASKAREA+1     MOVE TO MSG
         B     OUTPUT
*
SCDISP   LH    R0,ASCBNVSC(R6)         LOAD ALLOC. AUX. SLOT COUNT
*                                          (NON-VAM)
         CVD   R0,DOPWORT              CONVERT TO DEC
         OI    DOPWORT+7,X'0F'         SIGN = F
         UNPK  XDA4NVSC,DOPWORT        UNPK SLOT COUNT
         LH    R0,ASCBVSC(R6)          LOAD ALLOC. AUX. SLOT COUNT
*                                          (VAM)
         CVD   R0,DOPWORT              CONVERT TO DEC
         OI    DOPWORT+7,X'0F'         SIGN = F
         UNPK  XDA4VSC,DOPWORT         UNPK SLOT COUNT
         MVI   XDA4SM,C' '
*
OUTPUT   EQU   *
         CLI   HEADSW,C'Y'             HAS HEADLINE BEEN WRITTEN?
         BE    OUTMESS4                BR IF YES
         MVI   HEADSW,C'Y'             SET SWITCH
         L     R0,REG4                 LOAD CONSOLE ID
         TM    FUNCIND,DISPTIME        TIME DISPLAY
         BO    OUTMESS1                BR IF YES
         TM    FUNCIND,DISPPAGE        PAGE DISPLAY
         BO    OUTMESS2                BR IF YES
         LA    R1,XDA1S
         BAL   R14,WTOROUT
         B     OUTMESS4
OUTMESS1 EQU   *
         LA    R1,XDA1T
         BAL   R14,WTOROUT
         B     OUTMESS4
OUTMESS2 EQU   *
         LA    R1,XDA1P
         BAL   R14,WTOROUT
OUTMESS4 EQU   *
         L     R0,REG4                 LOAD CONSOLE ID
         LA    R1,XDA4
         BAL   R14,WTOROUT
         BR    R9
*
TSUSAVE  EQU   *                       SAVE TS USER ID
         LA    R3,1(,R3)               INCREMENT TS USER COUNT
         TM    FUNCIND,DISPTSU         FUNCTION = TSU?
         BCR   14,R9                   BR IF NO
         MVC   XDA4TYP,=CL1'T'         MOVE TYPE          ICR 09.07.83
         MVC   XDA4JOBN,CHKEY(R7)      MOVE JOBNAME
         MVC   XDA4STPN,CHSTEP(R7)     MOVE STEPNAME
         MVC   XDA4PRCN,CHCLS(R7)      MOVE PROCNAME
         B     DPRTYEDT
DSPCBS   EQU   *
         L     R0,REG4
         LA    R1,XDA1CB
         BAL   R14,WTOROUT
         L     R4,CVTASVT(R3)
         LA    R5,ASVTENTY(R4)
         L     R7,ASVTMAXU(R4)
         MH    R7,=H'4'
         AR    R7,R5
         ST    R7,MAXADR
CBASVTL  EQU   *
         TM    0(R5),ASVTAVAL
         BO    CBNXTE
         L     R6,0(R5)
         CLC   ASCBASID(2,R6),=H'0'
         BE    CBNXTE
         MVC   XDA4,XDA4DS
         LM    R7,R8,ASCBJBNI(R6)
         CLC   0(8,R8),=CL8'INIT'
         BNE   CBNOINIT
         LTR   R7,R7
         BZ    CBNXTE
         MVC   XDA4TYP,=CL1'J'                            ICR 09.07.83
         LA    R0,8
         SLR   R7,R0
CBNAME2  EQU   *
         MVC   XDA4PRCN,CHPROCSN(R7)
CBNAME1  EQU   *
         MVC   XDA4STPN,CHSTEP(R7)
         MVC   XDA4JOBN,CHKEY(R7)
         B     CBASID
CBNOINIT EQU   *
         L     R7,ASCBCSCB(R6)
         CLI   CHTRKID(R7),CHTSID
         BNE   CB1
         MVC   XDA4TYP,=CL1'T'                            ICR 09.07.83
         MVC   XDA4PRCN,CHCLS(R7)
         B     CBNAME1
CB1      EQU   *
         CLI   CHTRKID(R7),CHJOBID
         BNE   CB2
         MVC   XDA4TYP,=CL1'S'                            ICR 09.07.83
CB2      EQU   *
         MVC   XDA4JOBN,CHCLS(R7)
         MVC   XDA4STPN,CHKEY(R7)
         MVC   XDA4PRCN,CHPROCSN(R7)
CBASID   EQU   *
         LH    R0,ASCBASID(R6)
         CVD   R0,DOPWORT
         OI    DOPWORT+7,X'0F'
         UNPK  XDA4DP,DOPWORT
         CLC   XDA4DP(3),=CL3'001'
         BNE   NOTMSTR
         MVC   XDA4JOBN,=CL8'*MASTER*'
         MVC   XDA4TYP,=CL3'Y'                            ICR 09.07.83
         MVC   XDA4STPN,=CL8'SCHEDULR'
         MVC   XDA4PRCN,=CL8' '
NOTMSTR  EQU   *
         ST    R6,DOPWORT
         UNPK  XDA4DP+4(9),DOPWORT(5)
         TR    XDA4DP+4(8),HEXTAB-240
         MVI   XDA4DP+12,C' '
         L     R0,REG4
         LA    R1,XDA4
         BAL   R14,WTOROUT
CBNXTE   EQU   *
         LA    R5,4(R5)
         C     R5,MAXADR
         BL    CBASVTL
         B     DA2
         EJECT
BTODDIFF LM    R0,R1,TOD1              LOAD TOD-CLOCK VAL 1
BTODDIF1 LM    R14,R15,TOD2            LOAD TOD-CLOCK VAL 2
BTODDIF2 SLR   R15,R1                  SUBTRACT 2. WORDS
         LA    R1,1                    PREPARE FOR NO CARRY
         BC    3,*+6                   BR IF CARRY
         SLR   R14,R1                  SUB ONE - NO CARRY
         SLR   R14,R0                  SUBTRACT 1. WORDS
         SRDA  R14,22                  R15, BIT 31 = 1024 MICROSEC
         ST    R15,TODDIFF             STORE TOD-CLOCK DIFFERENCE
         BR    R2                      RETURN
*
BPAGEVAL SR    R1,R14                  DIFFERENCE OF PAGE VALUES
         BNM   *+6                     BR IF >= 0
         SR    R1,R1                   SET TO ZERO IF NEGATIVE
         M     R0,=F'10240'            MULTIPLY BY SEC/10 * 1024
         DR    R0,R15                  DIVIDE BY TOD DIFFERENCE
         CVD   R1,DOPWORT              CONVERT TO DECIMAL
BPAGEVL1 MVC   MASKAREA-1(7),=X'40202021204B20' MOVE ED MASK
         ED    MASKAREA-1(7),DOPWORT+5 ED PG/SEC VALUE
         BR    R8
WTOROUT  EQU   *
         ST    R14,SAVE14
         L     R0,REG4
         C     R0,=CL4'ROSC'
         BNE   NOROS
         STM   R14,R12,12(R13)                   SAVE ALL REGS IN SA
*
*              NOW WE CAN ADDRESS DUMMYSECTION IN XMON
*
         LH    R0,0(R1)      LOAD LENGTH OF WTO
         SH    R0,=H'4'      DECREMENT BY 4
         STC   R0,3(R1)      INSERT LENGTH TO MESSAGE FOR USE BY ROSCOE
         LA    R0,3(R1)      LOAD MESSAGE ADDRESS
         L     R13,4(R13)    R13 --> SA IN XMON
         ST    R0,76(R13)    STORE IT IN DYN AREA OF XMON = INAREA
         OI    76(R13),X'80' SET HIGHORDER BIT ON
         L     R15,100(R13)  LOAD ROSCOE-CODE <<OUTCODE>>
         LA    R1,76(R13)    LOAD PARAMETER REGISTER
         L     R13,4(R13)    R13 --> SA IN ROSCOE
         L     R14,12(R13)   LOAD RETURNADDRESS
         LM    R2,R12,28(R13)                    LOAD REMAINDER
         BR    R14           RETURN DIRECT TO ROSCOE
NOROS    EQU   *
         C     R0,=CL4'TSO'
         BNE   NOTSO
         LH    R0,0(R1)
         SH    R0,=H'4'
         LA    R1,4(R1)
         SVC   93             TPUT
         L     R14,SAVE14
         BR    R14
NOTSO    EQU   *
         WTO   MF=(E,(1))
         L     R14,SAVE14
         BR    R14
ONESECND DC    F'100'                  100 CENTISECONDS
THREESEC DC    F'300'                  300 CENTISECONDS
         PRINT DATA                                        ICR 04.08.83
DISPOPT  DS    0CL10
         DC    AL1(3),CL8'JOB',AL1(DISPJOB)
         DC    AL1(3),CL8'STC',AL1(DISPSTC)
         DC    AL1(3),CL8'TSU',AL1(DISPTSU)
         DC    AL1(3),CL8'ALL',AL1(DISPALL)
         DC    AL1(3),CL8'SYS',AL1(DISPSYS)
         DC    AL1(4),CL8'TIME',AL1(DISPTME1)
         DC    AL1(7),CL8'SRBTIME',AL1(DISPSRB1)
         DC    AL1(2),CL8'IO',AL1(DISPTME1)
         DC    AL1(4),CL8'PAGE',AL1(DISPPAG1)
ANZDOPT  EQU   (*-DISPOPT)/L'DISPOPT
         PRINT NODATA                                      ICR 04.08.83
CPUTIL   DC    XL2'0'                                      ICR 23.01.84
HEXTAB   DC    C'0123456789ABCDEF'     HEXADECIMAL TRANSLATE TABLE
MASK     DC    X'402020202120D240404020212040202120'
         SPACE
         SPACE
XDA1CB   WTO   'XDA1 T JOB-NAME STEPNAME PROCNAME ASID A(ASCB)         *
                ',MCSFLAG=REG0,MF=L
XDA1S    WTO   'XDA1 T JOB-NAME STEPNAME PROCNAME  PG  REAL NVSC VIOSC *
                        ',MCSFLAG=REG0,MF=L
         SPACE
XDA1T    WTO   'XDA1 T JOB-NAME STEPNAME PROCNAME  PG  REAL CPU% CPU-M *
                        ',MCSFLAG=REG0,MF=L
XDA1CPU  EQU   XDA1T+29                                    ICR 23.01.84
         SPACE
XDA1P    WTO   'XDA1 T JOB-NAME STEPNAME PROCNAME  PG  REAL  IN OUT REC*
                        ',MCSFLAG=REG0,MF=L
         SPACE
XDA4DS   WTO   'XDA4                                                   *
                        ',MCSFLAG=REG0,MF=L
XDA4L    EQU   *-XDA4DS
         SPACE
XDA5DS   WTO   'XDA5 -TYPE-   -IN- -OUT- -REC-    -I/O- TOTAL',        *
               MCSFLAG=REG0,MF=L
XDA5L    EQU   *-XDA5DS
         SPACE
XDA6DS   WTO   'XDA6 XXXXXXX ZZ9.9 ZZ9.9 ZZ9.9    ZZ9.9 ZZ9.9',        *
               MCSFLAG=REG0,MF=L
XDA6L    EQU   *-XDA6DS
         SPACE
         LTORG
         EJECT
*        EQUATES
         SPACE
*CVT
CVTPTR   EQU   X'10'                   CVT - POINTER
CVTDCB   EQU   X'74'                   ADDRESS OF OPERATING SYSTEM
CVTMVS2  EQU     B'00000001'           MULTIPLE MEMORY OPTION OF
*                                          OS/VS2 IS PRESENT
CVTHEAD  EQU   X'A0'                   ADDRESS OF FIRST TCB IN SYSTEM
CVTPVTP  EQU   X'164'                  ADDRESS OF PVT
*                                        (PAGE VECTOR TABLE)
CVTASVT  EQU   X'22C'                  ADDRESS OF ASVT
*                                        (ADDRESS SPACE VECTOR TABLE)
CVTOPCTP EQU   X'25C'                  ADDRESS OF RMCT     ICR 23.01.83
*                                        (SRM CONTROL TABLE) ICR 23.013
         SPACE
*TCB
TCBR     EQU   4                       TCB IN PROCESS REGISTER
OTCBR    EQU   5                       ORIGINATING TCB REGISTER
TCBRBP   EQU   X'00'                   ADDRESS OF REQUEST BLOCK
TCBTIO   EQU   X'0C'                   ADDRESS OF TASK I/O TABLE
TCBCMP   EQU   X'10'                   TASK COMLPETION CODE
TCBPKF   EQU   X'1C'                   PROTECTION KEY
TCBFLGS  EQU   X'1D'                   TASK END, ... FLAGS
TCBDSP   EQU   X'23'                   DISPATCHING PRIORITY
TCBNTC   EQU   X'80'                   ADDR OF PREVIOUS TCB ON SUBTASK
TCBOTC   EQU   X'84'                   ADDR OF ORIGINATING TCB
TCBLTC   EQU   X'88'                   ADDR OF LAST TCB ON SUBT. QUEUE
TCBPQE   EQU   X'98'                   ADDR OF DUMMY PQE MINUS 8
TCBDAR   EQU   X'AC'                   DAR FLAGS ×× SEC. NONDISP. BUTS
         SPACE
*RB
RBWCF    EQU   X'1C'                   WAIT COUNT FIELD
         SPACE
*PQE
PQEFPQE  EQU   X'08'                   ADDR OF NEXT PQE
PQESIZE  EQU   X'14'                   SIZE OF REG IN 2K MULTIPLES
         SPACE
*PVT
PVTNPIN  EQU   X'F8'                   # PAGE-IN, EXCL. SWAP AND VIO
PVTNPOUT EQU   X'FC'                   # PAGE-OUT, EXCL. SWAP AND VIO
PVTVAMI  EQU   X'100'                  # VIO PAGE-IN, EXCL. SWAP
PVTVAMO  EQU   X'104'                  # VIO PAGE-OUT, EXCL. SWAP
PVTVAMR  EQU   X'108'                  # VIO RECLAIMS
PVTSPIN  EQU   X'10C'                  # PAGES SWAPPED IN
PVTSPOUT EQU   X'110'                  # PAGES SWAPPED OUT
PVTNPREC EQU   X'114'                  # PAGES RECLAIMED
PVTNSWPS EQU   X'118'                  # SWAP-IN
PVTCAIN  EQU   X'11C'                  # CA NON-VIO PAGE-IN
PVTCAOUT EQU   X'120'                  # CA NON-VIO PAGE-OUT
PVTCAREC EQU   X'124'                  # CA NON-VIO RECLAIM
*PVTCAVI  EQU   X'128'                  # CA VIO PAGE-IN
*PVTCAVO  EQU   X'12C'                  # CA VIO PAGE-OUT
*PVTCAVR  EQU   X'130'                  # CA VIO RECLAIM
         SPACE
*OUXB
OUXBPIN  EQU   X'10'                   INTV PAGE-IN ACCU
OUXBPOUT EQU   X'14'                   INTV PAGE-OUT ACCU
OUXBPREC EQU   X'18'                   INTV RECLAIM ACCU
OUXBVAMI EQU   X'1C'                   INTV VIO PAGE-IN ACCU
OUXBVAMO EQU   X'20'                   INTV VIO PAGE-OUT ACCU
OUXBVAMR EQU   X'24'                   INTV VIO RECLAIM ACCU
OUXBCAPI EQU   X'28'                   INTV CA PAGE-IN ACCU
OUXBCAPR EQU   X'2C'                   INTV CA RECLAIM ACCU
         EJECT
*ASVT
ASVTMAXU EQU   X'204'                  MAX. NUMBER OF ADDRESS SPACES
ASVTENTY EQU   X'210'                  ENTRY FOR EACH POSSIBLE ASID
*                                          IF ASSIGNED: A(ASCB)
*                                          IF ^: A(NEXT AV. ASID)
ASVTAVAL EQU   B'10000000'             ASID AVAILABLE BIT
*                                          IF ASSIGNED: 0
*                                          IF ^: 1
         SPACE 2
*ASCB
ASCBASID EQU   X'24'                   ASID (ADDRESS SPACE IDENTIFIER)
ASCBSEQN EQU   X'26'                   SEQUENCE NUMBER
*                                          ASCB'S POSITION ON THE
*                                          DISPATCHING QUEUE
ASCBDP   EQU   X'2B'                   DISPATCHING PRIORITY
ASCBOUCB EQU   X'90'                  ADDRESS OF OUCB
ASCBCSCB EQU   X'38'                   ADDRESS OF CSCB
ASCBEJST EQU   X'40'                   ELAPSED JOB STEP TIMING
ASCBRCTF EQU   X'66'                   FLAGS FOR RCT
ASCBOUT  EQU     B'00000100'               ADDRESS SPACE SWAPPED OUT
ASCBTMLW EQU     B'00000010'               MEMORY IS IN A LONG WAIT
ASCBFLG1 EQU   X'67'                   FLAG FIELD
ASCBSTND EQU     B'00000100'               TCB'S NON-DISPATCHABLE
ASCBVSC  EQU   X'78'                   ALLOC. AUX. SLOT COUNT (VAM)
ASCBNVSC EQU   X'7A'                   ALLOC. AUX. SLOT COUNT (NON-VAM)
ASCBOUXB EQU   X'94'                   SRM USER EXT BLOCK PTR
ASCBFMCT EQU   X'98'                   ALLOCATED PAGE FRAME COUNT
ASCBJBNI EQU   X'AC'                   POINTER TO JOBNAME FIELD FOR
*                                          INITIATED PROGRAMS OR ZERO
ASCBJBNS EQU   X'B0'                   POINTER TO JOBNAME FIELD FOR
*                                          START/MOUNT/LOGON OR ZERO
ASCBSRBT EQU   X'C8'                   ACCUMULATED SRB TIME
         SPACE 2
         SPACE
*RMCT
RMCTCCT  EQU   4                       ADDRESS OF CCT      ICR 23.01.84
*                                        (SRM CPU  MGMT    ICR 23.01.84
*                                          CONTROL TABLE)  ICR 23.01.84
         SPACE
*CCT
CCVUTILP EQU   X'66'                   SYSTEM CPU          ICR 23.01.84
*                                        UTILIZATION       ICR 23.01.84
         SPACE
*CSCB
CHKEY    EQU   X'08'                   1. ID OF A STARTED TASK
*                                  (THIS ID IS THE TASK'S STEPNAME)
*                                      2. JOBNAME OF AN EXECUTED JOB
*
CHCLS    EQU   X'10'                   1. PROCNAME OF A STARTED TASK
*                                  (THE PROCNAME IS THE TASK'S JOBNAME)
*                                      2. JOBNAME OF AN EXECUTED JOB
*                                          (SAME AS CHKEY)
CHUNIT   EQU   X'18'                   UNITNAME (SET FOR STARTED TASKS)
CHTRKID  EQU   X'1C'                   DISPLAY/TRACK IDENTIFIER
CHTSID   EQU     X'01'                     TSU IDENTIFIER
CHJOBID  EQU     X'02'                     JOB IDENTIFIER
CHINITID EQU     X'03'                     INITIATOR IDENTIFIER
CHASID   EQU   X'1E'                   ASID
CHPROCSN EQU   X'20'                   PROCEDURE STEP NAME
CHSTEP   EQU   X'40'                   STEP NAME
         EJECT
         REG
         SPACE 2
         XPARM
         SPACE 2
WORK     DSECT
SAVEAREA DS    18F                     SAVEAREA I
SAVE14   DS    F
DASAVE   DS    9F                      SAVEAREA II
SAVETIO  DS    F                       SAVEAREA FOR TIOT ADDRESS
DOPWORT  DS    D                       D-WORD FOR CVD
MAXADR   DS    F
BYTES    DS    CL5
MASKAREA DS    CL6                     WORKAREA FOR ED-MASK
IOSW     DS    X
MODE     DS    CL1
XA       EQU   128
*
FUNCIND  DS    CL1                     FUNCTION INDICATOR
DISPJOB  EQU     X'80'                     DISPLAY JOBS
DISPSTC  EQU     X'40'                     DISPLAY STC
DISPTSU  EQU     X'20'                     DISPLAY TSU
DISPSYS  EQU     X'10'                     DISPLAY SYS
***PDFLT EQU     X'C0'                     DEFAULT (JOB, STC) ICR 17.7
DISPDFLT EQU     X'80'                     DEFAULT (JOB )  ICR 01.11.83
DISPALL  EQU     X'E0'                     DISPLAY ALL
DISPTIME EQU     X'08'                     DISPLAY TIME
DISPSUPP EQU     X'01'                     FIRST ENTRY INDICATOR
DISPSRBT EQU     X'02'                     DISPLAY SRBTIME
DISPPAGE EQU     X'04'                     DISPLAY PAGING ACTIVITY
DISPPAG1 EQU     X'05'                     DISPLAY PAGING, FIRST ENTRY
DISPSRB1 EQU     X'0B'                     DISPLAY SRBTIME, FIRST ENTRY
DISPTME1 EQU     X'09'                     DISPLAY TIME, FIRST ENTRY
*
USERID   DS    CL8
USERIDL  DS    H
SPAGEIN  DS    PL4                     PAGE-IN/SEC COUNTER
SPAGEOUT DS    PL4                     PAGE-OUT/SEC COUNTER
SPAGEREC DS    PL4                     PAGE-REC/SEC COUNTER
SPAGEIO  DS    PL4                     PAGE-IO/SEC COUNTER
SPAGETOT DS    PL4                     TOTAL PAGING/SEC COUNTER
*
XDA4     DS    0CL(XDA4L)
         DS    CL9                     L OF MSG, FLAGS, 'XDA4 '
****                                                       ICR 09.07.83
**A4TYP  DS    CL3                     TYPE (JOB, STC, TSU)ICR 09.07.83
XDA4TYP  DS    CL1                     TYPE (JOB, STC, TSU)ICR 09.07.83
         DS    CL1
XDA4JOBN DS    CL8                     JOBNAME
         DS    CL1
XDA4STPN DS    CL8                     STEPNAME
         DS    CL1
XDA4PRCN DS    CL8                     PROC STEP NAME
         DS    CL1
XDA4DP   DS    CL3                     DISP PRIORITY
         DS    CL1
XDA4REAL DS    CL5                     ALLOCATED PAGE FRAME COUNT
*                                          (9999K)
         DS    CL1
XDA4NVSC DS    CL4                     ALLOCATED AUX. SLOT COUNT
*                                          (NON-VAM)
         DS    CL1
XDA4VSC  DS    CL5                     ALLOCATED AUX. SLOT COUNT (VAM)
         ORG   XDA4NVSC
XDA4CPU  DS    CL3                     CPU USAGE IN %
XDA4P100 DS    CL1                     '%'
XDA4CPUT DS    CL6                     TCB CPU TIME (ZZZ.99)
XDA4SM   DS    CL1                     " × ' × ' '
         DS    CL1
XDA4EXCP DS    CL8                     NO. OF EXCPS          ICR 9.7.83
         ORG   XDA4NVSC
XDA4PIN  DS    CL3                     PAGE-IN/SEC (ZZ9)
         DS    CL1
XDA4POUT DS    CL3                     PAGE-OUT/SEC (ZZ9)
         DS    CL1
XDA4PREC DS    CL3                     PAGE-REC/SEC (ZZ9)
*
         DS    CL3
         ORG   XDA4
*
XDA6     DS    0CL(XDA6L)
         DS    CL9                     L OF MSG, FLAGS, 'XDA6 '
XDA6TYPE DS    CL7                     TYPE (DEMAND×VIO×SWAP×*TOTAL*)
         DS    CL1
XDA6IN   DS    CL5                     PAGE-IN/SEC (ZZ9.9)
         DS    CL1
XDA6OUT  DS    CL5                     PAGE-OUT/SEC (ZZ9.9)
         DS    CL1
XDA6REC  DS    CL5                     RECLAIM/SEC (ZZ9.9)
         DS    CL4
XDA6PGIO DS    CL5                     PAGE-IO/SEC (ZZ9.9)
         DS    CL1
XDA6PAGE DS    CL5                     TOTAL PAGING RATE (ZZ9.9)
         ORG
*
PAGEVAL1 DS    8F                      PAGING STATISTICS (1. ENTRY)
PAGEVAL2 DS    8F                      PAGING STATISTICS (2. ENTRY)
*
ANZTBLK  EQU   220
         DS    0D
TIMEBLK  DS    0CL16
TIMECPU1 DS    F                       TCB CPU TIMER VALUE 1
TIMESRB1 DS    F                       SRB CPU TIMER VALUE 1
TIMECPU2 DS    F                       TCB CPU TIMER VALUE 2
TIMEDIFF DS    F                       VALUES 2 - VALUES 1
*
         DS    (ANZTBLK-1)CL(L'TIMEBLK) SPACE FOR THE REM. TIMEBLK'S
*
TIMESUM  DS    F                       SUM OF ALL TIME DIFFERENCES
PAGESUM  DS    F                       SUM OF ALL PAGE-IO DIFFERENCES
TOD1     DS    D                       TOD-CLOCK VALUE 1
TOD2     DS    D                       TOD-CLOCK VALUE 2
TODVALUE DS    D                       TOD-CLOCK VALUE
TODDIFF  DS    F                       DIFF OF TOD-CLOCK VALUES
HEADSW   DS    CL1                     "Y" INDICATES "HEADLINE WRITTEN"
         DS    CL3                     RESERVED
*
PAGEBLK  DS    0CL32
PAGEIN1  DS    F                       COUNT OF PAGE-IN 1
PAGEOUT1 DS    F                       COUNT OF PAGE-OUT 1
PAGEREC1 DS    F                       COUNT OF PAGE-REC 1
PAGEIN2  DS    F                       COUNT OF PAGE-IN 2
PAGEOUT2 DS    F                       COUNT OF PAGE-OUT 2
PAGEREC2 DS    F                       COUNT OF PAGE-REC 2
PAGETODD DS    0F                      TOD DIFFERENCE
PAGETOD1 DS    D                       TOD-VALUE 1
*
         DS    (ANZTBLK-1)CL(L'PAGEBLK) SPACE FOR THE REM. PAGEBLK'S
*
         DS    0D
WORKL    EQU   *-WORK                  WORK-AREA LENGTH
         SPACE 2
         END   XDA
./ ADD NAME=DBLDL
DBLDL    START
         REG
         XSAVE R12,,DBLDL,WORKL
         USING WORK,R13
         LR    R11,R1
         USING PARMAREA,R11
         MVI   SWITCH,X'00'
         L     R4,16
         L     R2,32(R4)
         SH    R2,=H'88'     /*  DISPLACEMENT MUST BE CHANGED
PROCSVC  EQU   *
         CLC   TEXT+6(4),=CL4'$OFF'
         BNE   NOTOFF
         LR    R1,R2
         LA    R15,SVCROUT
         SVC   250
         B     NTFND
NOTOFF   EQU   *
         L     R2,0(R2)
         LA    R2,0(R2)
         LTR   R2,R2
         BZ    NTFND
         LH    R3,2(R2)
         LH    R4,0(R2)
         LA    R2,4(R2)
NXTENTRY EQU   *
         CLC   0(8,R2),TEXT+6
         BE    FOUND
         LA    R2,0(R3,R2)
         BCT   R4,NXTENTRY
NTFND    EQU   *
         TM    SWITCH,X'80'
         BO    NOTFNDX
         OI    SWITCH,X'80'
         L     R4,16
         L     R2,32(R4)
         TM    116(R4),X'01'     VS2 REL2.0?
         BNO   NOTMVS2
         SH    R2,=H'88'     /*  DISPLACEMENT MUST BE CHANGED
NOTMVS2  EQU   *                 FOR EVERY RELEASE OF MVS  */
         SH    R2,=H'4'
         B     PROCSVC
NOTFNDX  EQU   *
         CLC   TEXT+6(4),=CL4'$OFF'
         BNE   NOTOFF1
         MVC   WTO(LWTO3),WTO3
         B     RETURN
NOTOFF1  EQU   *
         MVC   WTO(WTO2-WTO1),WTO1
         MVC   WTO+19(8),TEXT+6
RETURN   EQU   *
         L     R0,REG4
         C     R0,=CL4'TSO'
         BNE   DOWTO
         LH    R0,WTO
         SH    R0,=H'4'
         LA    R1,WTO+4
         SVC   93             *** TPUT ***
         B     XRETURN
DOWTO    EQU   *
         WTO   MF=(E,WTO)
XRETURN  EQU   *
         XRETURN 0,R
FOUND    EQU   *
         MVC   WTO(CCTAB-WTO2),WTO2
         MVC   WTO+19(8),TEXT+6
         ST    R2,TEXT
         UNPK  WTO+54(7),TEXT+1(4)
         MVI   WTO+60,X'40'
         TR    WTO+54(6),CCTAB-240
         B     RETURN
SVCROUT  EQU   *
         XC    0(4,R1),0(R1)
         BR    R14
WTO1     WTO   'XDBLDL1 MODULE 12345678 NOT FOUND IN BLDL',            *
               MCSFLAG=REG0,MF=L
WTO2     WTO   'XDBLDL2 MODULE 12345678 FOUND IN BLDL AT LOCATION 12345*
               6 ',MCSFLAG=REG0,MF=L
WTO3     WTO   'XDBLDL3 RESIDENT BLDL-LIST NOW INEFFECTIVE',MF=L,      *
               MCSFLAG=REG0
LWTO3    EQU   *-WTO3
CCTAB    DC    C'0123456789ABCDEF'
         XPARM
WORK     DSECT
SVA      DS    18F
WTO      DS    CL100
SWITCH   DS    X
WORKL    EQU   *-WORK
         END
./ ADD NAME=DEL
***********************************************************************
*                                                                     *
*        INITIAL PROCESSING.                                          *
*                                                                     *
***********************************************************************
         SPACE 2
XDEL     CSECT
         XSAVE R12,,XDEL,WORKLEN
         USING WORK,R13                 ALLOC. BASE REG. OF WORKAREA
         USING PARMAREA,R11             ALLOC. BASE REG. OF PARMAREA
         LR    R11,R01                  INIT. BASE REG. OF PARMAREA
INIT     EQU   *
         XC    TRTTAB(256),TRTTAB       CLEAR TRANSLATE TABLE
         MVI   MEMBER,C' '              INITIALIZE
         MVC   MEMBER+1(7),MEMBER       MEMBER NAME
         MVI   DSNAME,C' '              INITIALIZE
         MVC   DSNAME+1(43),DSNAME      DSNAME
         MVI   VOLSER,C' '              INITIALIZE
         MVC   VOLSER+1(5),VOLSER       VOLSER
         MVI   PO,X'00'                 INIT. FLAG BYTE FOR PO DATAS.
         MVI   VOL,X'00'                INIT. FLAG BYTE FOR VOL. SPEC.
         MVI   PURGE,X'00'              INIT. FLAG BYTE FOR PUR. SPEC.
         MVI   VOLPURGE,X'00'           INIT. FLAG BYTE FOR VOL×PUR SP.
         CLC   REG4(4),=CL4'TSO'
         BNE   NOTSO1
         L     R5,4(R13)
         L     R5,4(R5)
         L     R5,24(R5)
         MVC   UPT(4),4(R5)
         MVC   ECT(4),12(R5)
NOTSO1   EQU   *
*
*   SCAN PARAMETERS
*
         CLI   TEXT+3,C','              LOOK FOR FIRST SEPERATOR
         BNE   ERROR                    BRANCH IF NOT FOUND
         MVI   KOMMA,C','               MOVE SEPARATOR TO TRANSL. TAB.
         TRT   TEXT+4(119),TRTTAB       LOOK FOR NEXT SEPERATOR
         BZ    DSNPO                    IF NONE, ONLY DSN. SPECIFIED
         LR    R5,R1                    LOAD ADRESS FOR SECOND SEPERAT.
         OI    VOLPURGE,X'80'           SET FLAG FOR VOL × PURGE SPEC.
DSNPO    EQU   *
         MVI   KOMMA,X'00'              CLEAR TRANSLATE TABLE AGAIN
         MVI   LPAN,C'('                MOVE LEFT PARENTHESIS TO TABLE
         TRT   TEXT(124),TRTTAB         LOOK FOR LEFT PARENTHESIS
         BZ    NOTPO                    IF NONE,SEQUENTIAL DATASET
         LR    R3,R1                    SAVE ADDRESS OF LEFT PAREN.
         CLI   1(R3),C'+'
         BE    GDG
         CLI   1(R3),C'-'
         BE    GDG
         TM    1(R3),X'F0'
         BO    GDG
         MVI   LPAN,X'00'               CLEAR TRANSLATE TABLE AGAIN
         MVI   RPAN,C')'                MOVE RIGHT PARENTHESIS TO TABLE
         TRT   TEXT(124),TRTTAB         LOOK FOR RIGHT PARENTHESIS
         BZ    ERROR                    IF NONE, SYNTAXERROR
         MVI   RPAN,X'00'               CLEAR TRANSLATE TABLE
         LR    R4,R1                    SAVE ADDRESS OF RIGHT PAREN.
         SR    R1,R3                    MEMBERLENGTH+2
         BM    ERROR                    IF NEGATIVE, BRANCH ERROR
         OI    PO,X'80'                 SET FLAG BYTE FOR PO DATASET
         BCTR  R1,0                     DECREASE BY
         BCTR  R1,0                     TWO
         EX    R1,MOVEMEM               BRANCH TO MOVE MEMBER NAME
         LA    R1,TEXT+4                LOAD ADDRESS OF DSN
         LR    R2,R3                    SAVE ADDRESS OF LEFT PAREN.
         SR    R2,R1                    COMPUT LENGTH OF DSN
         BCTR  R2,0                     DECREASE BY ONE
         EX    R2,MOVEDSN               BRANCH TO MOVE DSN
         TM    VOLPURGE,X'80'           TEST FOR VOL × PURGE SPEC.
         BO    VOLUME                   IF SECIFIED, BRANCH
         B     SCRATCH                  ELSE BRANCH TO ASK FOR SCRATCH
GDG      EQU   *
         MVI   LPAN,X'00'
         MVI   RPAN,C')'
         TRT   TEXT(124),TRTTAB
         BZ    ERROR
         MVI   RPAN,X'00'
         LR    R4,R1
         LA    R1,TEXT+4
         SR    R4,R1
         EX    R4,MOVEDSN
         TM    VOLPURGE,X'80'
         BO    VOLUME
         B     SCRATCH
NOTPO    EQU   *
         TM    VOLPURGE,X'80'           TEST FOR VOL × PURGE SPEC.
         BO    NAME                     IF SPECIFIED, BRANCH
         MVC   DSNAME(44),TEXT+4        ELSE MOVE DSN
         B     SCRATCH                  BRANCH TO ASK FOR SCRATCH
NAME     EQU   *
         LA    R1,TEXT+4                LOAD ADDRESS OF DSN
         LR    R2,R5                    SAVE ADDRESS OF SECOND SEPERAT.
         SR    R2,R1                    COMPUTE LENGTH OF DSN
         BCTR  R2,0                     DECREASE BY ONE
         EX    R2,MOVEDSN               BRANCH TO MOVE DSN
VOLUME   EQU   *
         CLC   1(5,R5),=C'PURGE'        PURGE SPECIFIED ?
         BNE   VOLFIRST                 IF NOT, VOL FIRST SPECIFIED
         OI    PURGE,X'80'              SET FLAG FOR PURGE
         CLI   6(R5),C','               ANOTHER SEPARETOR ?
         BNE   SCRATCH                  IF NOT, BRANCH TO ASK FOR SCR.
         MVC   VOLSER(6),7(R5)          ELSE MOVE VOLSER
         OI    VOL,X'80'                SET FLAG FOR VOLSER
         B     SCRATCH                  BRANCH TO ASK FOR SCRATCH
VOLFIRST EQU   *
         LA    R2,TEXT+123              LOAD ADDRESS OF TEXTEND
         SR    R2,R5                    COMPUTE LENGTH OF REMAINDER
         BCTR  R2,0                     DECRAESE BY ONE
         MVI   KOMMA,C','               MOVE KOMMA TO TRANSLATE TABLE
         EX    R2,TRT                   BRANCH TO LOOK FOR NEXT SEP.
         BZ    VOLONLY                  IF NONE, BRANCH
         LR    R6,R1                    ELSE SAVE ADDRESS OF THIRD SEP.
         MVI   KOMMA,C' '               CLEAR TRANSLATE TABLE
         SR    R1,R5                    COMPUTE LENGTH OF VOLSER
         BCTR  R1,0                     DECREASE BY
         BCTR  R1,0                     TWO
         EX    R1,MOVEVOL               BRANCH TO MOVE VOLSER
         OI    VOL,X'80'                SET FLAG FOR VOLSER
         CLC   1(5,R6),=C'PURGE'        COMPARE REMAINDER WITH PURGE
         BNE   ERROR                    IF NOT, BRANCH ERROR
         OI    PURGE,X'80'              ELSE SET FLAG FOR PURGE
         B     SCRATCH                  BRANCH TO ASK FOR SCRATCH
VOLONLY  EQU   *
         MVC   VOLSER(6),1(R5)          MOVE VOLSER
         OI    VOL,X'80'                SET FLAG FOR VOLUME SPECIF.
         EJECT
**********************************************************************
*                                                                    *
*        ASK FOR SCRATCH.                                            *
*                                                                    *
**********************************************************************
         SPACE 2
SCRATCH  EQU   *
         TM    VOL,X'80'                 ELSE TEST FOR VOLUME SPEC.
         BO    LOOKDEVT                  IF YES, BRANCH TO UCB PROC.
         EJECT
**********************************************************************
*                                                                    *
*        RETRIEVE CATALOG INFORMATION.                               *
*                                                                    *
**********************************************************************
         SPACE 2
         MVC   LOCLIST(16),LOCLISTX      MOVE LOCATELIST SKELETON
         LA    R2,DSNAME                 LOAD ADDRESS OF DSN
         LA    R3,LOCAREA                LOAD ADDRESS OF LOCATE AREA
         ST    R2,LOCLIST+4              STORE ADDRESS OF DSN TO LOCL.
         ST    R3,LOCLIST+12             STORE ADDR. OF LOCAREA TO LOC.
         LOCATE LOCLIST                  RETRIEVE CATALOG INF.
         LTR   R15,R15                   RETURNCODE=0 ?
         BZ    SCRATCHD                  IF YES, BRANCH TO SCRATCH
         CVD   R15,DOPPELW               CONVERT RC TO DECIMAL
         UNPK  RC,DOPPELW                UNPACK RC
         OI    RC+3,X'F0'                MODIFY SIGN
         MVC   WTO(LMSG06),MSG06         MOVE MESSAGE SKELETON
         MVC   WTO+40(2),RC+2            MOVE RC TO MSG
         MVC   WTO+47(44),DSNAME         MOVE DSN TO MSG
         L     R0,REG4                   MOVE UCM-ID.
         LA    R1,WTO
         BAL   R14,WTOROUT
         B     RETURN                    BRANCH RETURN
         EJECT
***********************************************************************
*                                                                     *
*        PROCESSING OF UCB LOOKUP-TABLE.                              *
*                                                                     *
***********************************************************************
         SPACE 2
LOOKDEVT EQU   *
LOOP     EQU   *
         UCBSCAN DEVTYPE=DASD,STATUS=ONLINE
         LTR   R15,R15                   IF YES, NO DEVICE FOUND
         BNZ   NODEV
         LR    R4,R1                     SAVE UCB ADDRESS
         CLC   28(6,R4),VOLSER           COMPARE VOLSER
         BE    MOVEDEV                   IF EQUAL, DEVICE FOUND
         B     LOOP                      BRANCH FOR NEXT UCB
NODEV    EQU   *
         MVC   WTO(LMSG07),MSG07          MOVE MESSAGE SKELETON
         MVC   WTO+19(6),VOLSER           MOVE VOLSER TO MSG
         L     R0,REG4                    MOVE UCM-ID.
         LA    R1,WTO
         BAL   R14,WTOROUT
         B     UNCATLG                    BRANCH TO ASK FOR UNCATLG
MOVEDEV  EQU   *
         XC    LOCAREA(256),LOCAREA      CLEAR LOCATE AREA
         XC    LOCAREA+256(9),LOCAREA+256
         MVC   LOCAREA+6(6),VOLSER        MOVE VOLSER TO LOCATE AREA
         MVC   LOCAREA+2(4),16(R4)        MOVE DEVICETYPE TO LOC. AREA
         LA    R1,1(,0)                   LOAD VOLUME COUNT
         STH   R1,LOCAREA                 STORE VOLUME COUNT TO LOC. A.
         EJECT
**********************************************************************
*                                                                    *
*        SCRATCH PROCESSING FOR SEQUENTIAL DATASETS.                 *
*                                                                    *
**********************************************************************
         SPACE 2
SCRATCHD EQU   *
         TM    PO,X'80'                   DATASET PARTITIONED ?
         BO    SCRATCHM                   IF YES, BRANCH TO SCR. MEM.
         LH    R4,LOCAREA
         LA    R2,LOCAREA+2
MNTLOOP  EQU   *
         MVC   VOLSER,4(R2)
         LA    R6,VOLSER
         CALL  MSSMNT,((R6)),VL
         LA    R2,12(R2)
         BCT   R4,MNTLOOP
         SR    R0,R0                      CLEAR R0
         TM    PURGE,X'80'                PURGE SPECIFIED ?
         BZ    NOPURGE                    IF NOT, SCR. WITHOUT EXPIRAT.
         MVC   DELISTP(16),DELISTXP       MOVE SCRATCHLIST SKELETON
         LA    R6,DSNAME                  LOAD ADDRESS OF DSN
         ST    R6,DELISTP+4               STORE ADDR.OF DSN TO LIST
         LA    R6,LOCAREA                 LOAD ADDRESS OF LOCATE AREA
         ST    R6,DELISTP+12              STORE ADDR. OF LOCAREA
         SCRATCH DELISTP                  SCRATCH DATASET
         LTR   R15,R15                    RETURNCODE=0 ?
         BNZ   SCRERROR                   IF NOT,BRANCH ERROR HANDLING
         B     PUTMSG8                    ELSE PUT MSG
NOPURGE  EQU   *
         MVC   DELIST(16),DELISTX         MOVE SCRATCHLIST SKELETON
         LA    R6,DSNAME                  LOAD ADDRESS OF DSN
         ST    R6,DELIST+4                STORE ADDRESS OF DSN TO LIST
         LA    R6,LOCAREA                 LOAD ADDR. OF LOCATE AREA
         ST    R6,DELIST+12               STORE ADDR. OF LOCATE AREA
         SCRATCH DELIST                   SCRATCH DATASET WITHOUT EXPI.
         LTR   R15,R15                    RETURNCODE=0 ?
         BNZ   SCRERROR                   IF NOT, BRANCH ERROR HANDLING
PUTMSG8  EQU   *
         MVC   WTO(LMSG08),MSG08          MOVE MESSAGE SKELETON
         MVC   WTO+35(44),DSNAME          MOVE DSN TO MSG
         L     R0,REG4                    MOVE UCM-ID.
         LA    R1,WTO
         BAL   R14,WTOROUT
         B     UNCATLG                    BRANCH TO ASK FOR UNCATLG
SCRERROR EQU   *
         MVC   WTO(LMSG09),MSG09          MOVE MESSAGE SKELETON
         CVD   R15,DOPPELW                CONVERT TO DECIMAL
         UNPK  RC,DOPPELW                 UNPACK RETURNCODE
         OI    RC+3,X'F0'                 MODIFY SIGN
         MVC   WTO+23(2),RC+2             MOVE RETURNCODE TO MSG
         MVC   WTO+30(44),DSNAME          MOVE DSN TO MSG
         L     R0,REG4                    MOVE UCM-ID.
         LA    R1,WTO
         BAL   R14,WTOROUT
         SR    R4,R4                      CLEAR R4
         LH    R4,LOCAREA                 LOAD VOLUME COUNT
         LA    R2,LOCAREA+2               LOAD ADDRESS DEVICETYPE
VOLLOOP  EQU   *
         CLC   11(1,R2),=X'00'            SCRATCHCODE=0 ?
         BNE   PUTMSG10                   IF NOT, PUT MESSAGE
         MVC   WTO(LMSG15),MSG15          MOVE  MESSAGE SKELETON
         MVC   WTO+35(6),4(R2)            MOVE VOLSER TO MSG
         MVC   WTO+41(2),=C'  '
         L     R0,REG4                    MOVE UCM-ID.
         LA    R1,WTO
         BAL   R14,WTOROUT
         B     CONTINUE                   BRANCH NEXT VOLUME
PUTMSG10 EQU   *
         MVC   WTO(LMSG10),MSG10          MOVE MESSAGE SKELETON
         SR    R6,R6                      CLEAR R6
         IC    R6,11(R2)                  SAVE SCRATCHCODE
         CVD   R6,DOPPELW                 CONVERT SCRATCHCODE TO DEC.
         UNPK  RC+3(1),DOPPELW            UNPACK SCRATCHCODE
         OI    RC+3,X'F0'                 MODIFY SIGN
         MVC   WTO+25(1),RC+3             MOVE SCRATCHCODE TO MSG
         MVC   WTO+31(6),4(R2)            MOVE VOLSER TO MSG
         L     R0,REG4                    MOVE UCM-ID.
         LA    R1,WTO
         BAL   R14,WTOROUT
CONTINUE EQU   *
         LA    R2,12(R2)                  LOAD ADDR. NEXT LOCAREA ENTRY
         BCT   R4,VOLLOOP                 DECREASE R4, BRANCH IF R4^=0
         B     RETURN          RETURN
         EJECT
**********************************************************************
*                                                                    *
*        SCRATCH PROCESSING FOR MEMBERS.                             *
*                                                                    *
**********************************************************************
         SPACE 2
*        DYNALLOC
SCRATCHM EQU   *
         LA    R1,DYNAREA                 LOAD ADDRESS OF DYNAREA
         LA    R2,S99RB                   LOAD ADDRESS OF REQUEST BLOCK
         ST    R2,S99RBPTR                STORE RB-ADDR. TO RBPTR
         OI    S99RBPTR,X'80'             MODIFY HIGH ORDER BYTE
         XC    S99RB(RBLEN),S99RB         CLEAR REQUEST BLOCK
         MVI   S99RBLN,RBLEN              MOVE LENGTH TO RB
         MVI   S99VERB,X'01'              SET FLAG BYTE
         MVI   S99FLG11,X'00'             SET FLAG BYTE
         MVI   S99FLG12,X'00'             SET FLAG BYTE
         LA    R2,S99TUPT1                LOAD ADDRESS FIRST TXTUNITPTR
         ST    R2,S99TXTPP                STORE ADDRESS TO RB
         MVI   S99FLG21,X'D9'             SET FLAG BYTE
         MVI   S99FLG22,X'00'             SET FLAG BYTE
         MVI   S99FLG23,X'00'             SET FLAG BYTE
         MVI   S99FLG24,X'00'             SET FLAG BYTE
         LA    R3,S99TUKE1                LOAD ADDRESS FIRST TEXTUNIT
         ST    R3,S99TUPT1                STORE ADDRESS TO TXTUNITPTR
         LA    R4,4(,0)                   GET THE STATUS KEY
         STH   R4,S99TUKE1                STORE KEY TO TEXTUNIT
         LA    R4,1(,0)                   GET NUMBER AND LENGTH OF
         STH   R4,S99TUNU1                PARAMETER AND STORE IT TO
         STH   R4,S99TULN1                THE TEXTUNIT
         MVI   S99TUPA1,X'08'             MOVE PARAMETER
         LA    R3,S99TUKE2                LOAD ADDRESS OF NEXT TEXTUNIT
         ST    R3,S99TUPT2                STORE ADDR. TO NEXT TXTUNITPT
         LA    R4,5(,0)                   GET THE KEY FOR NORMAL DISP.
         STH   R4,S99TUKE2                STORE KEY TO TEXTUNIT
         LA    R4,1(,0)                   GET NUMBER AND LENGTH OF
         STH   R4,S99TUNU2                PARAMETER AND STORE IT TO
         STH   R4,S99TULN2                THE TEXTUNIT
         MVI   S99TUPA2,X'08'             MOVE PARAMETER TO TEXTUNIT
         LA    R3,S99TUKE3                LOAD ADDRESS OF NEXT TEXTUNIT
         ST    R3,S99TUPT3                STORE ADDR. TO NEXT TXTUNITPT
         LA    R4,6(,0)                   GET THE KEY FOR COND. DISP.
         STH   R4,S99TUKE3                STORE THE KEY TO TEXTUNIT
         LA    R4,1(,0)                   GET NUMBER AND LENGTH OF
         STH   R4,S99TUNU3                PARAMETER AND STORE IT TO
         STH   R4,S99TULN3                THE TEXTUNIT
         MVI   S99TUPA3,X'08'             MOVE PARAMETER TO TEXTUNIT
         LA    R3,S99TUKE4                LOAD ADDRESS OF NEXT TEXTUNIT
         ST    R3,S99TUPT4                STORE ADDR. TO NEXT TXTUNITPT
         MVC   S99TUKE4,=X'001C'          STORE THE KEY TO TEXTUNIT
         LA    R4,0(,0)                   GET NUMBER OF PARAMETER
         STH   R4,S99TUNU4                AND STORE IT TO TEXTUNIT
         LA    R3,S99TUKE5                LOAD ADDRESS OF NEXT TEXTUNIT
         ST    R3,S99TUPT5                STORE ADDR. TO NEXT TXTUNITPT
         MVC   S99TUKE5,=X'0055'          STORE KEY TO TEXTUNIT
         LA    R4,1(0)                    GET NUMBER OF PARAMETER
         STH   R4,S99TUNU5                AND STORE IT TO TEXTUNIT
         LA    R4,8(0)                    GET LENGTH OF PARAMETER
         STH   R4,S99TULN5                AND STORE IT TO TEXTUNIT
         MVC   S99TUPA5(8),=CL8' '        MOVE PARAMETER TO TEXTUNIT
         LA    R3,S99TUKE6                LOAD ADDRESS OF NEXT TEXTUNIT
         ST    R3,S99TUPT6                STORE ADDR. TO NEXT TXTUNITPT
         LA    R4,2(,0)                   GET KEY FOR DSNAME ALLOCATION
         STH   R4,S99TUKE6                STORE KEY TO TEXTUNIT
         LA    R4,1(,0)                   GET NUMBER OF PARAMETER
         STH   R4,S99TUNU6                AND STORE IT TO TEXTUNIT
         LA    R4,44(,0)                  GET LENGTH OF PARAMETER
         STH   R4,S99TULN6                AND STORE IT TO TEXTUNIT
         MVC   S99TUPA6(44),DSNAME        MOVE PARAMETER TO TEXTUNIT
         LA    R3,S99TUKE7                LOAD ADDRESS OF NEXT TEXTUNIT
         ST    R3,S99TUPT7                STORE ADDR. TO NEXT TXTUNITPT
         MVC   S99TUKE7,=X'0010'          STORE KEY TO TEXTUNIT
         LA    R4,1(,0)                   GET NUMBER OF PARAMETER
         STH   R4,S99TUNU7                AND STORE IT TEXTUNIT
         LA    R4,6(,0)                   GET LENGTH OF PARAMETER
         STH   R4,S99TULN7                STORE IT TO TEXTUNIT
         MVC   S99TUPA7(6),LOCAREA+6      MOVE PARAMETER TO TEXTUNIT
         LA    R3,S99TUKE8                LOAD ADDRESS OF NEXT TEXTUNIT
         ST    R3,S99TUPT8                STORE ADDR. TO NEXT TXTUNITPT
         MVC   S99TUKE8,=X'0015'          STORE KEY TO TEXTUNIT
         LA    R4,1(,0)                   GET NUMBER OF PARAMETER
         STH   R4,S99TUNU8                AND STORE IT TO TEXTUNIT
         LA    R4,8(,0)                   GET LENGTH OF PARAMETER
         STH   R4,S99TULN8                AND STORE IT TO TEXTUNIT
         LA    R5,DEVTAB                  LOAD ADDR. DEV.TABLE(EBCDIC)
DEVLOOP  EQU   *
         CLC   0(2,R5),=X'FFFF'           END OF DEV.TABLE(EBCDIC) ?
         BE    PUTMSG11                   IF YES, BRANCH TO PUT MSG
         CLC   0(2,R5),LOCAREA+4          IF DEV.TYPE IN DEV.TABLE
         BE    MOVUNIDS                   (EBCDIC), BRANCH TO MOVE TYPE
         LA    R5,12(,R5)                 LOAD ADDR. NEXT TABLE ENTRY
         B     DEVLOOP                    BRANCH TO LOOK AGAIN
PUTMSG11 EQU   *
         MVC   WTO(LMSG11),MSG11          MOVE MESSAGE SKELETON
         MVC   WTO+47(44),DSNAME          MOVE DSN TO MSG
         L     R0,REG4                    MOVE UCM-ID.
         LA    R1,WTO
         BAL   R14,WTOROUT
         B     RETURN                     BRANCH TO RETURN
MOVUNIDS EQU   *
         TM    LOCAREA+3,X'08'            VIRTUEL DEVICE ?
         BNO   REAL                       IF NOT, BRANCH TO MOVE REAL D
         MVC   S99TUPA8(10),=C'3330V     '   MOVE VIRTUEL DEVICE TYPE
         OI    S99TUPT8,X'80'             SET IND. FOR LAST TEXTUNITPTR
         B     ALLOC                      BRANCH ALLOCATION
REAL     EQU   *
         MVC   S99TUPA8(10),2(R5)         MOVE REAL DEV.TYPE TO TEXTUN.
         OI    S99TUPT8,X'80'             SET IND. FOR LAST TEXTUNITPTR
ALLOC    EQU   *
         LA    R15,SVCROUT
         SVC   250
         LTR   R15,R15                    RETURNCODE = 0 ?
         BZ    OBTAIN                     IF YES, LOOK FOR DSCB1
PUTMSG12 EQU   *
         CVD   R15,DOPPELW                CONVERT RC TO DECIMAL
         UNPK  RC,DOPPELW                 UNPACK RC
         OI    RC+3,X'F0'                 MODIFY SIGN
         MVC   WTO(LMSG12),MSG12          MOVE MESSAGE SKELETON
         MVC   WTO+24(2),RC+2             MOVE RC TO MSG
         LA    R4,S99RB                   LOAD ADDR. OF REQUEST BLOCK
         UNPK  DOPPELW,4(3,R4)            UNPACK ERROR REASON CODE
         TR    DOPPELW+3(4),TRTAB         TRANSLATE  RIGHT PORTION
         MVC   WTO+40(4),DOPPELW+3        MOVE ERROR REASON CODE TO MSG
         UNPK  DOPPELW,6(3,R4)            UNPACK INFORMATIONAL CODE
         TR    DOPPELW+3(4),TRTAB         TRANSLATE RIGHT PORTION
         MVC   WTO+31(4),DOPPELW+3        MOVE INF. CODE TO MSG
         L     R0,REG4                    MOVE UCM-ID.
         LA    R1,WTO
         BAL   R14,WTOROUT
         B     RETURN                     BRANCH TO RETURN
SVCROUT  EQU   *
         SVC   99
         SVC   3
*
*    LOOK FOR DSCB1
*
OBTAIN   EQU   *
         MVC   DSCB(16),DSCBX             MOVE CAMLIST SKELETON
         LA    R2,DSNAME                  LOAD ADDR. OF DSNAME
         ST    R2,DSCB+4                  STORE ADDR. TO DSCB
         LA    R2,LOCAREA+6               LOAD ADDR. OF VOLSER
         ST    R2,DSCB+8                  STORE ADDR. TO DSCB
         LA    R2,DSCBAREA                LOAD ADDR. OF AREA
         ST    R2,DSCB+12                 STORE ADDR. TO DSCB
         OBTAIN DSCB                      LOOK FOR DSCB1
         LTR   R15,R15                    RETURNCODE = 0 ?
         BZ    OPEN                       IF YES, BRANCH TO OPEN DATAS.
PUTMSG16 EQU   *
         MVC   WTO(LMSG16),MSG16          MOVE MESSAGE SKELETON
         MVC   WTO+29(44),DSNAME          MOVE DSN TO MSG
         CVD   R15,DOPPELW                CONVERT RC TO DECIMAL
         UNPK  RC,DOPPELW                 UNPACK RC
         OI    RC+3,X'F0'                 MODIFY SIGN
         MVC   WTO+22(2),RC+2             MOVE RC TO MSG
         L     R0,REG4                    MOVE UCM-ID.
         LA    R1,WTO
         BAL   R14,WTOROUT
         B     UNCATLG                    BRANCH TO ASK FOR UNCATLG
*
*   OPEN DATASET
*
OPEN     EQU   *
         MVC   DCB(DCBLEN),DCBX           MOVE DCB SKELETON
         MVC   DCB+40(8),S99TUPA5         MOVE DDNAME TO DCB
         LA    R4,DCB                     LOAD ADDRESS OF DCB
         ST    R4,DCBADDR                 STORE ADDRESS
         LA    R1,DCBADDR                 LOAD ADDR. OF DCBADDR.
         MVI   0(R1),X'8F'                SET INDICATOR
         SVC   19                         OPEN
         TM    DCB+48,X'10'               OPEN OK ?
         BO    STOW                       IF YES, BRANCH TO DEL. MEMBER
PUTMSG13 EQU   *
         MVC   WTO(LMSG13),MSG13          MOVE MESSAGE SKELETON
         MVC   WTO+28(44),DSNAME          MOVE DSN TO MSG
         L     R0,REG4                    MOVE UCM-ID.
         LA    R1,WTO
         BAL   R14,WTOROUT
         B     RETURN                     BRANCH TO RETURN
*
*   DELETE THE MEMBER
*
STOW     EQU   *
         LA    R4,DCB                     LOAD ADDRESS OF DCB
         LA    R6,MEMBER                  LOAD ADDRESS OF  MEMBER
         STOW  (R4),(R6),D                STOW
         LTR   R15,R15                    RETURNCODE = 0 ?
         BNZ   PUTMSG14                   IF NOT, BRANCH TO PUT MSG
         MVC   WTO(LMSG15),MSG15          MOVE MESSAGE SKELETON
         MVC   WTO+35(8),MEMBER           MOVE MEMBER TO MSG
         L     R0,REG4                    MOVE UCM-ID.
         LA    R1,WTO
         BAL   R14,WTOROUT
         LA    R1,DCBADDR                 LOAD ADDRESS  OF DCBADDR
         MVI   0(R1),X'80'                SET INDICATOR
         SVC   20                         CLOSE
         B     RETURN                     BRANCH TO RETURN
PUTMSG14 EQU   *
         MVC   WTO(LMSG14),MSG14          MOVE MESSEAGE SKELETON
         ST    R15,RC                     STORE R15 TO RETURNCODE
         UNPK  DOPPELW,RC+3(2)            UNPACK RC
         TR    DOPPELW+5(2),TRTAB         TRANSLATE RIGHT PORTION
         MVC   WTO+27(2),DOPPELW+5        MOVE RC TO MSG
         ST    R0,RC                      ST R0 TO RETURNCODE
         UNPK  DOPPELW,RC+3(2)            UNPACK RC
         TR    DOPPELW+5(2),TRTAB         TRANSLATE RIGHT PORTION
         MVC   WTO+38(2),DOPPELW+5        MOVE RC TO MSG
         MVC   WTO+45(8),MEMBER           MOVE MEMBERNAME TO MSG
         L     R0,REG4                    MOVE UCM-ID. TO MSG
         LA    R1,WTO
         BAL   R14,WTOROUT
         LA    R1,DCBADDR                 LOAD ADDR. OF DCBADDR.
         MVI   0(R1),X'80'                SET INDICATOR
         SVC   20                         CLOSE
         B     RETURN                     BRANCH TO RETURN
         EJECT
***********************************************************************
*                                                                     *
*        ASK FOR UNCATLG.                                             *
*                                                                     *
***********************************************************************
         SPACE 2
UNCATLG  EQU   *
         TM    PO,X'80'                   PO DATASET ?
         BO    RETURN                     IF YES, BRANCH TO RETURN
         TM    VOL,X'80'
         BO    RETURN     DONT UNCATALOG IF VOLSER WAS SPEC.
         EJECT
***********************************************************************
*                                                                     *
*        UNCATLG PROCESSING.                                          *
*                                                                     *
***********************************************************************
         SPACE 2
         MVC   CATLIST(12),UNCATX         MOVE UNCAT LIST
         LA    R2,DSNAME                  LOAD ADDRESS OF DSN
         ST    R2,CATLIST+4               STORE IT TO UNCAT LIST
         CATALOG CATLIST                  UNCATLG
         LTR   R15,R15                    RETURNCODE = 0 ?
         BZ    UNCATOK                    IF YES, BRANCH TO UNCATLG
         MVC   WTO(LMSG03),MSG03          MOVE MESSAGE SKELETON
         MVC   WTO+30(44),DSNAME          MOVE DSN TO MSG
         CVD   R15,DOPPELW                CONVERT RC TO DECIMAL
         UNPK  RC,DOPPELW                 UNPACK RC
         OI    RC+3,X'F0'                 MODIFY SIGN
         MVC   WTO+23(2),RC+2             MOVE RC TO MSG
         L     R0,REG4                    MOVE UCM-ID.
         LA    R1,WTO
         BAL   R14,WTOROUT
         B     RETURN                     BRANCH TO RETURN
UNCATOK  EQU   *
         MVC   WTO(LMSG04),MSG04          MOVE MESSAGE SKELETON
         MVC   WTO+35(44),DSNAME          MOVE DSN TO MSG
         L     R0,REG4                    MOVE UCM-ID.
         LA    R1,WTO
         BAL   R14,WTOROUT
         B     RETURN                     BRANCH TO RETURN
         EJECT
*
*   ERROR PROCESSING.
*
ERROR    EQU   *
         L     R0,REG4
         LA    R1,MSG17
         BAL   R14,WTOROUT
*
*   FREEMAIN WORKAREA AND RETURN
*
RETURN   EQU   *
         XRETURN 0,R
WTOROUT  EQU   *
         ST    R14,SAVER14
         C     R0,=CL4'ROSC'
         BNE   NOROS
         STM   R14,R12,12(R13)                   SAVE ALL REGS IN SA
*
*              NOW WE CAN ADDRESS DUMMYSECTION IN XMON
*
         LH    R0,0(R1)      LOAD LENGTH OF WTO
         SH    R0,=H'4'      DECREMENT BY 4
         STC   R0,3(R1)      INSERT LENGTH TO MESSAGE FOR USE BY ROSCOE
         LA    R0,3(R1)      LOAD MESSAGE ADDRESS
         L     R13,4(R13)    R13 --> SA IN XMON
         ST    R0,76(R13)    STORE IT IN DYN AREA OF XMON = INAREA
         OI    76(R13),X'80' SET HIGHORDER BIT ON
         L     R15,100(R13)  LOAD ROSCOE-CODE <<OUTCODE>>
         LA    R1,76(R13)    LOAD PARAMETER REGISTER
         L     R13,4(R13)    R13 --> SA IN ROSCOE
         L     R14,12(R13)   LOAD RETURNADDRESS
         LM    R2,R12,28(R13)                    LOAD REMAINDER
         BR    R14           RETURN DIRECT TO ROSCOE
NOROS    EQU   *
         CLC   REG4(4),=CL4'TSO'
         BE    TPUT
         WTO   MF=(E,(1))
         L     R14,SAVER14
         BR    R14
TPUT     EQU   *
         MVC   2(2,R1),=H'0'
         STM   R2,R4,SAVPUTL
         L     R2,UPT
         L     R3,ECT
         LR    R4,R1
         PUTLINE PARM=PUTL,UPT=(R2),ECT=(R3),ECB=ECBPUTL,              *
               OUTPUT=((R4),TERM,SINGLE,DATA),MF=(E,IOPL)
         LM    R2,R4,SAVPUTL
         L     R14,SAVER14
         BR    R14
         EJECT
***********************************************************************
*                                                                     *
*        MESSAGE SKELETONS.                                           *
*                                                                     *
***********************************************************************
         SPACE 2
MSG03    WTO   'XDEL003 UNCATLG RC=99 FOR XXXXXXXXXXXXXXXXXXXXXXXXXXXXX*
               XXXXXXXXXXXXXXX',MCSFLAG=(REG0),MF=L
LMSG03   EQU   *-MSG03
MSG04    WTO   'XDEL004 UNCATLG SUCCESSFUL FOR XXXXXXXXXXXXXXXXXXXXXXXX*
               XXXXXXXXXXXXXXXXXXXX',MCSFLAG=(REG0),MF=L
LMSG04   EQU   *-MSG04
MSG06    WTO   'XDEL006 CATALOG FAILURE (LOCATE) RC=99 FOR XXXXXXXXXXXX*
               XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX',MCSFLAG=(REG0),MF=L
LMSG06   EQU   *-MSG06
MSG07    WTO   'XDEL007 VOLUME XXXXXX NOT AVAILABLE',MCSFLAG=(REG0),   *
               MF=L
LMSG07   EQU   *-MSG07
MSG08    WTO   'XDEL008 SCRATCH SUCCESSFUL FOR XXXXXXXXXXXXXXXXXXXXXXXX*
               XXXXXXXXXXXXXXXXXXXX',MCSFLAG=(REG0),MF=L
LMSG08   EQU   *-MSG08
MSG09    WTO   'XDEL009 SCRATCH RC=99 FOR XXXXXXXXXXXXXXXXXXXXXXXXXXXXX*
               XXXXXXXXXXXXXXX',MCSFLAG=(REG0),MF=L
LMSG09   EQU   *-MSG09
MSG10    WTO   'XDEL010 SCRATCH CODE=X FOR VOLSER',                    *
               MCSFLAG=(REG0),MF=L
LMSG10   EQU   *-MSG10
MSG11    WTO   'XDEL011 DEVICETYPE NOT IN PROGRAMTABLE FOR XXXXXXXXXXXX*
               XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX',MCSFLAG=(REG0),MF=L
LMSG11   EQU   *-MSG11
MSG12    WTO   'XDEL012 DYNALLOC RC=99, IC=9999, EC=9999',             *
               MCSFLAG=(REG0),MF=L
LMSG12   EQU   *-MSG12
MSG13    WTO   'XDEL013 OPEN FAILED FOR XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX*
               XXXXXXXXXXXXX',MCSFLAG=(REG0),MF=L
LMSG13   EQU   *-MSG13
MSG14    WTO   'XDEL014 STOW FAILED RC=99, REASON=99 FOR XXXXXXXX',    *
               MCSFLAG=(REG0),MF=L
LMSG14   EQU   *-MSG14
MSG15    WTO   'XDEL015 SCRATCH SUCCESSFUL FOR XXXXXXXX',              *
               MCSFLAG=(REG0),MF=L
LMSG15   EQU   *-MSG15
MSG16    WTO   'XDEL016 OBTAIN RC=99 FOR XXXXXXXXXXXXXXXXXXXXXXXXXXXXXX*
               XXXXXXXXXXXXX',MCSFLAG=(REG0),MF=L
LMSG16   EQU   *-MSG16
MSG17    WTO   'XDEL001 SYNTAX ERROR IN PARMLIST',MF=L,MCSFLAG=REG0
PUTL     PUTLINE MF=L
UPT      DC    F'0'
ECT      DC    F'0'
ECBPUTL  DC    F'0'
IOPL     DC    4F'0'
SAVPUTL  DC    3F'0'
         EJECT
***********************************************************************
*                                                                     *
*        DECLARATIONS.                                                *
*                                                                     *
***********************************************************************
         SPACE 2
DEVTAB   DC    X'2005'
         DC    C'2305-1    '
         DC    X'2007'
         DC    C'2305-2    '
         DC    X'2008'
         DC    C'2314      '
         DC    X'2009'
         DC    C'3330      '
         DC    X'200A'
         DC    C'3340      '
         DC    X'200B'
         DC    C'3350      '
         DC    X'200D'
         DC    C'3330-11   '
         DC    X'200E'
         DC    C'3380      '
         DC    X'FFFF'
         DC    C'XXXXXXXXXX'
TRTAB    DC    240C'?'
         DC    C'0123456789ABCDEF'
DCBX     DCB   DSORG=PO,MACRF=(W),DDNAME=SYSXXXXX
DCBLEN   EQU   *-DCBX
LOCLISTX CAMLST NAME,0,,0
DELISTXP CAMLST SCRATCH,0,,0,,OVRD
DELISTX  CAMLST SCRATCH,0,,0
UNCATX   CAMLST UNCAT,0
DSCBX    CAMLST SEARCH,0,0,0
         EJECT
***********************************************************************
*                                                                     *
*        COMMANDS FOR EXECUTE STATEMENTS.                             *
*                                                                     *
***********************************************************************
         SPACE 2
MOVEMEM  MVC   MEMBER(0),1(R3)
MOVEDSN  MVC   DSNAME(0),0(R1)
TRT      TRT   1(0,R5),TRTTAB
MOVEVOL  MVC   VOLSER(0),1(R5)
         EJECT
***********************************************************************
*                                                                     *
*        EQUATES.                                                     *
*                                                                     *
***********************************************************************
         SPACE 2
R0       EQU   0
R00      EQU   0
R1       EQU   1
R01      EQU   1
R2       EQU   2
R02      EQU   2
R3       EQU   3
R03      EQU   3
R4       EQU   4
R04      EQU   4
R5       EQU   5
R05      EQU   5
R6       EQU   6
R06      EQU   6
R7       EQU   7
R07      EQU   7
R8       EQU   8
R08      EQU   8
R9       EQU   9
R09      EQU   9
R10      EQU   10
R11      EQU   11
R12      EQU   12
R13      EQU   13
R14      EQU   14
R15      EQU   15
RBLEN    EQU   20
         EJECT
***********************************************************************
*                                                                     *
*        PARMAREA.                                                    *
*                                                                     *
***********************************************************************
         SPACE 2
         XPARM
         EJECT
***********************************************************************
*                                                                     *
*        WORKAREA.                                                    *
*                                                                     *
***********************************************************************
         SPACE 2
WORK     DSECT
SAVEAREA DS    18F'0'
SAVER14  DS    F
TRTTAB   DS    77C
LPAN     DS    C
         DS    15C
RPAN     DS    C
         DS    13C
KOMMA    DS    C
         DS    148C
PO       DS    C
         DS    0F
MEMLENG  DS    F
MEMBER   DS    CL8
CATLIST  DS    CL12
DSNAME   DS    CL44
VOLSER   DS    CL6
VOL      DS    C
PURGE    DS    C
VOLPURGE DS    C
WTO      DS    34F
ECB      DS    F
REPLY    DS    CL3
DOPPELW  DS    0D
         DS    2F
RC       DS    F
LOCAREA  DS    0D
         DS    265C
LOCLIST  DS    0F
         DS    CL16
DELISTP  DS    0F
         DS    CL16
DELIST   DS    0F
         DS    CL16
DCB      DS    CL96
DYNAREA  DS    0F
S99RBPTR DS    F
S99RB    DS    0F
S99RBLN  DS    CL1
S99VERB  DS    CL1
S99FLG11 DS    CL1
S99FLG12 DS    CL1
S99ERROR DS    H
S99INFO  DS    H
S99TXTPP DS    F
S99RSV01 DS    F
S99FLG21 DS    CL1
S99FLG22 DS    CL1
S99FLG23 DS    CL1
S99FLG24 DS    CL1
S99TUPT1 DS    F
S99TUPT2 DS    F
S99TUPT3 DS    F
S99TUPT4 DS    F
S99TUPT5 DS    F
S99TUPT6 DS    F
S99TUPT7 DS    F
S99TUPT8 DS    F
S99TUKE1 DS    H
S99TUNU1 DS    H
S99TULN1 DS    H
S99TUPA1 DS    CL1
S99TUKE2 DS    H
S99TUNU2 DS    H
S99TULN2 DS    H
S99TUPA2 DS    CL1
S99TUKE3 DS    H
S99TUNU3 DS    H
S99TULN3 DS    H
S99TUPA3 DS    CL1
S99TUKE4 DS    H
S99TUNU4 DS    H
S99TUKE5 DS    H
S99TUNU5 DS    H
S99TULN5 DS    H
S99TUPA5 DS    CL8
S99TUKE6 DS    H
S99TUNU6 DS    H
S99TULN6 DS    H
S99TUPA6 DS    CL44
S99TUKE7 DS    H
S99TUNU7 DS    H
S99TULN7 DS    H
S99TUPA7 DS    CL6
S99TUKE8 DS    H
S99TUNU8 DS    H
S99TULN8 DS    H
S99TUPA8 DS    CL8
DCBADDR  DS    F
DSCB     DS    CL16
DSCBAREA DS    CL140
WORKLEN  EQU   *-WORK
         SPACE 3
         END   XDEL
./ ADD NAME=DLPA
DLPA     START
DLPA     AMODE 31
DLPA     RMODE 24
         REG
         XSAVE R12,,DLPA,WORKL
         USING WORK,R13
         LR    R11,R1
         USING PARMAREA,R11
         CLI   TEXT+5,C'*'
         BE    GIVENAME
ANFANG   L     R3,16           CVT-PTR
         L     R4,188(R3)      LPA CDE QUEUE
         LA    R4,0(R4)        CLEAR HIGH-ORDER BYTE
NEXTCDE  EQU   *
         CLC   8(8,R4),TEXT+5
         BE    FOUND
         ICM   R4,7,1(R4)      NEXT CDE ON CDE QUEUE
         BNZ   NEXTCDE
         TM    116(R3),X'02'   DAT?
         BZ    NOTFOUND
         ICM   R0,15,TEXT+5    R0 = LEFT HALF OF NAME
         ICM   R1,15,TEXT+9    R1 = RIGHT HALF OF NAME
         L     R15,352(R3)     ADDR OF IEAVVSMR
         LA    R5,LPDEFND      BRANCH ADDR LPDE TYPE
         BALR  R14,R15         SEARCH LPA DIRECTORY
*      RETURN FROM IEAVVSMR:
*          B  0(R14) MODULE FOUND; R0 CONTAINS LPDE ADDR
*          B  4(R14) MODULE NOT FOUND
         B    F               BRANCH IF OK
         B    NOTFOUND
F        EQU  *
         LR    R4,R0           R4 = LPDE ADDR
         SLL   R4,1
         SRL   R4,1
         BR    R5              BRANCH TO LPDEFND
NOTFOUND MVC   WTO,MESS1
         L     R0,REG4
         MVC   WTO+19(8),TEXT+5
         BAL   R14,WTOROUT
         B     RETURN
FOUND    EQU   *
LPDEFND  EQU   *
         MVC   WTO,MESS2
         MVC   WTO+19(8),TEXT+5
         L     R14,16(R4)
         SLL   R14,1
         SRL   R14,1
         ST    R14,TEXT
         UNPK  WTO+42(9),TEXT(5)
         MVI   WTO+50,C'.'
         ST    R4,TEXT
         UNPK  WTO+64(9),TEXT(5)
         MVI   WTO+72,X'40'
         TR    WTO+64(8),CCTAB-240
         TR    WTO+42(8),CCTAB-240
         L     R0,REG4
         BAL   R14,WTOROUT
RETURN   EQU   *
         XRETURN 0,R
WTOROUT  EQU   *
         ST    R14,SAVE14
         C     R0,=CL4'TSO'
         BNE   DOWTO
         LH    R0,WTO
         SH    R0,=H'4'
         LA    R1,WTO+4
         SVC   93             **** TPUT ****
         L     R14,SAVE14
         BR    R14
DOWTO    EQU   *
         WTO   MF=(E,WTO)
         L     R14,SAVE14
         BR    R14
GIVENAME EQU   *
         MVC   BCDADR(6),TEXT+6
         LA    R7,6
         LA    R6,BCDADR
CONTNI   EQU   *
         NI    0(R6),X'3F'
         LA    R6,1(R6)
         BCT   R7,CONTNI
         TR    BCDADR(6),TRTAB
         TRT   BCDADR(6),ZEROES
         BZ    ADDROK
         L     R0,REG4
         MVC   WTO,MESS3
         BAL   R14,WTOROUT
         B     RETURN
ADDROK   EQU   *
         PACK  BINADR(5),BCDADR(7)
         L     R4,16
         L     R4,188(R4)
         L     R4,0(R4)
         SR    R9,R9
ACDECH1  EQU   *
         TM    28(R4),X'04'
         BO    ACDECH2
         L     R6,20(R4)
         L     R7,8(R6)
         LA    R7,0(R7)
         L     R6,12(R6)
         LA    R6,0(R6)
         L     R5,BINADR
         CR    R5,R6
         BL    ACDECH2
         AR    R6,R7
         CR    R5,R6
         BL    NAMEOK
ACDECH2  EQU   *
         L     R4,0(R4)
         LA    R4,0(R4)
         LTR   R4,R4
         BNZ   ACDECH1
         L     R4,16
         L     R4,360(R4)
         LA    R9,4
ALPDECH1 EQU   *
         CLC   8(8,R4),=8X'FF'   ENDE?
         BNE   NLPDEND
         L     R0,REG4
         MVC   WTO,MESS4
         BAL   R14,WTOROUT
         B     RETURN
NLPDEND  EQU   *
         TM    28(R4),X'04'
         BO    ALPDECH2
         L     R6,36(R4)
         LA    R6,0(R6)
         L     R7,32(R4)
         LA    R7,0(R7)
         CR    R5,R6
         BL    ALPDECH2
         AR    R6,R7
         CR    R5,R6
         BL    NAMEOK
ALPDECH2 EQU   *
         LA    R4,40(R4)
         B     ALPDECH1
NAMEOK   EQU   *
         MVC   TEXT+5(10),=CL10' '
         MVC   TEXT+5(8),8(R4)
         B     ANFANG
MESS1    WTO   'XDLPA01 MODULE AAAAAAAA NOT IN LPA',MCSFLAG=REG0,MF=L
MESS2    WTO   'XDLPA02 MODULE AAAAAAAA IN LPA. EP =  XXXXXXXX. LPDE-AD*
               R. = 12345678 ',                                        *
               MCSFLAG=REG0,MF=L
CCTAB    DC    C'0123456789ABCDEF'
BCDADR   DC    6CL1'0'
FILL1    DS    X
BINADR   DC    A(0)
FILL2    DS    X
TRTAB    DS    0CL64
         DC    X'FF0A0B0C0D0E0F'
         DC    41XL1'FF'
         DC    X'00010203040506070809'
         DC    6XL1'FF'
         DC    0F'0'
ZEROES   DC    16XL1'00'
         DC    240XL1'FF'
MESS3    WTO   'XDLPA03 INVALID ADDRESS',MCSFLAG=REG0,MF=L
MESS4    WTO   'XDLPA04 ADDRESS NOT FOUND IN LPA',MCSFLAG=REG0,MF=L
         XPARM
WORK     DSECT
SVA      DS    18F
SAVE14   DS    F
WTO      DS    CL100
WORKL    EQU   *-WORK
         END
./ ADD NAME=DSPL
         TITLE 'XLIST                             X-COMMAND LIST'
LIST     CSECT
         SPACE 3
***********************************************************************
*                                                                     *
*      IDENTIFICATION DIVISION.                                       *
*                                                                     *
*      PROGRAM-ID. LIST.                                              *
*      AUTHOR. EHNERT.                                                *
*      INSTALLATION. BAYER AG, LEVERKUSEN, RECHENZENTRUM.             *
*      DATE-WRITTEN. 23. 4. 1975.                                     *
*      REMARKS.                                                       *
*                                                                     *
*          DAS X-COMMAND 'LIST' GIBT DEN INHALT DER ALS PARAMETER     *
*          SPEZIFIZIERTEN DATEI AUS, DIE SOWOHL SEQUENTIELL ALS       *
*          AUCH MEMBER EINER PO-ORGANISIERTEN DATEI SEIN KANN UND     *
*          DIE FESTE SATZLAENGE 80 HABEN MUSS. ANDERE DATEIEN WER-    *
*          DEN NICHT VERARBEITET.                                     *
*                                                                     *
*          ALS WEITERE PARAMETER KOENNEN ZUSAETZLICH 'L' ODER 'LONG'  *
*          SOWIE EINE VOLUME SERIAL NUMBER ANGEGEBEN WERDEN.          *
*          WIRD 'L' ODER 'LONG' ANGEGEBEN, SO WERDEN ALLE 80 STELLEN  *
*          EINES DATENSATZES, ANDERENFALLS NUR DIE ERSTEN 54 STELLEN  *
*          AUSGEGEBEN. WIRD EINE VOLUME SERIAL NUMBER SPEZIFIZIERT,   *
*          SO WIRD DIE  DATEI AUF DIESER PLATTE, ANDERENFALLS IM      *
*          CATALOG GESUCHT.                                           *
*                                                                     *
*          DURCH DIE NOTWENDIGE DYNAMIC ALLOCATION , DIE IM EXTER-    *
*          NEN UNTERPROGRAMM 'DYNALC' DURCHGEFUEHRT WIRD, KANN DAS    *
*          X-COMMAND 'LIST' NUR IM SYSTEM OS/VS2 (MVS) VERWENDET      *
*          WERDEN.                                                    *
*                                                                     *
***********************************************************************
         EJECT
***********************************************************************
*                                                                     *
*      BEGINN DER VERARBEITUNG.                                       *
*                                                                     *
***********************************************************************
         SPACE 3
*
*      SICHERN DER REGISTER,
*      SPEICHERPLATZANFORDERUNG FUER ARBEITSBEREICHE,
*      ZUORDNUNG DER BASISREGISTER.
*
         SPACE 1
         XSAVE R12,,LIST,ABERL
         SPACE 1
         LR    R11,R1        BASISREG. FUER DSECT PARMAREA INIT.
         USING PARMAREA,R11  BASISREG. FUER DSECT PARMAREA ZUORDNEN
         USING ABER,R13      BASISREG. FUER DSECT ABER ZUORDNEN
         CLC   REG4(4),=CL4'TSO'
         BNE   NOTSO
         TPUT  NOTSOMSG,50
         B     ENDE
NOTSOMSG DC    CL60'XDSPL00 X-DSPL NOT SUPPORTED UNDER TSO'
NOTSO    EQU   *
         EJECT
*
*      ABFRAGE DES SYSTEMS.
*
         SPACE 1
         L     R2,16         ADRESSE DER CVT LADEN
         TM    116(R2),X'01' SYSTEM = OS/VS2 (MVS) ?
         BO    INIT          JA, VERZWEIGEN
         L     R0,REG4       UCM-ID. DES AUFRUFERS LADEN
         WTO   MF=(E,MSG04)  FEHLERNACHRICHT AUSGEBEN
         B     ENDE          VERZW. ZUM ABSCHLUSS DER VERARBEITUNG
         SPACE 2
*
*      INITIALISIERUNG DER SPEICHER.
*
         SPACE 1
INIT     EQU   *
         MVI   DSNAME,C' '   SPEICHER FUER DATA SET NAME, MEMBER NAME
         MVC   DSNAME+1(57),DSNAME UND VOLUME SERIAL NUMBER LOESCHEN
         MVI   LONGBYTE,X'00' FLAG BYTE LOESCHEN
         EJECT
***********************************************************************
*                                                                     *
*      VERARBEITUNG DER EINGABEPARAMETER.                             *
*                                                                     *
***********************************************************************
         SPACE 3
GETPARM  EQU   *
         CLI   TEXT+4,C','   PARAMETER ANGEGEBEN ?
         BNE   FEHLPARM      NEIN, VERZWEIGEN
         SPACE 2
*
*      VERARBEITUNG DES DATA SET NAME.
*
         SPACE 1
         LA    R2,TEXT+4     ADRESSE DES TRENNUNGSZEICHENS LADEN
         SR    R3,R3         LAENGENZAEHLER LOESCHEN
DSNLOOP  EQU   *
         LA    R2,1(R2)      ADRESSE DES NAECHSTEN ZEICHENS LADEN
         CLI   0(R2),C' '    ENDE DER PARAMETERKETTE ERREICHT ?
         BE    ENDDSNLP      JA, VERZWEIGEN
         CLI   0(R2),C','    ENDE DES DATA SET NAME ERREICHT ?
         BE    ENDDSNLP      JA, VERZWEIGEN
         CLI   0(R2),C'('    DATA SET = MEMBER EINER PO-DATEI ?
         BE    ENDDSNLP      JA, VERZWEIGEN
         LA    R3,1(R3)      LAENGENZAEHLER ERHOEHEN
         CH    R3,=H'44'     MAXIMALE LAENGE UEBERSCHRITTEN ?
         BH    FEHLPARM      JA, VERZWEIGEN
         B     DSNLOOP       VERZWEIGEN
         SPACE 1
ENDDSNLP EQU   *
         LTR   R3,R3         LAENGE DES DSNAME = 0 ?
         BZ    FEHLPARM      JA, VERZW. ZUR FEHLERROUTINE
         BCTR  R3,0          R3 UM EINS VERMINDERN
         EX    R3,MVCDSN     VERZW. ZUM UEBERTR. DES DSNAME
         EJECT
*
*      VERARBEITUNG DES MEMBER NAME.
*
         SPACE 1
         CLI   0(R2),C'('    MEMBER SPEZIFIZIERT ?
         BNE   GETNPARM      NEIN, VERZWEIGEN
         LA    R3,2(R3)      LAENGENZAEHLER ERHOEHEN
         SR    R4,R4         LAENGENZAEHLER LOESCHEN
         LR    R5,R2         ADRESSE DES TRENNUNGSZEICHENS LADEN
MBRLOOP  EQU   *
         LA    R2,1(R2)      ADRESSE DES NAECHSTEN ZEICHENS LADEN
         CLI   0(R2),C')'    ENDE DES MEMBER NAME ERREICHT ?
         BE    ENDMBRLP      JA, VERZWEIGEN
         LA    R4,1(R4)      LAENGENZAEHLER ERHOEHEN
         CH    R4,=H'8'      MAXIMALE LAENGE UEBERSCHRITTEN ?
         BH    FEHLPARM      JA, VERZW. ZUR FEHLERROUTINE
         LA    R3,1(R3)      LAENGENZAEHLER ERHOEHEN
         B     MBRLOOP       VERZWEIGEN
         SPACE 1
ENDMBRLP EQU   *
         LTR   R4,R4         LAENGE DES MEMBER NAME = 0 ?
         BZ    FEHLPARM      JA, VERZW. ZUR FEHLERROUTINE
         BCTR  R4,0          R4 UM EINS VERMINDERN
         EX    R4,MVCMBR     VERZW. ZUM UEBERTR. DES MEMBER NAME
         LA    R2,1(R2)      ADRESSE DES NAECHSTEN ZEICHENS LADEN
         EJECT
*
*      VERARBEITUNG DER VOLUME SERIAL NUMBER UND
*      DER PARAMETER 'L' ODER 'LONG'.
*
         SPACE 1
GETNPARM EQU   *
         CLI   0(R2),C','    WEITERE PARAMETER ANGEGEBEN ?
         BNE   ENDPARM       NEIN, VERZWEIGEN
         CLC   1(5,R2),=C'LONG ' PARAMETER = 'LONG' ?
         BE    SET1LB        JA, VERZWEIGEN
         CLC   1(5,R2),=C'LONG,' PARAMETER = 'LONG' ?
         BE    SET1LB        JA, VERZWEIGEN
         CLC   1(2,R2),=C'L ' PARAMETER = 'L' ?
         BE    SET2LB        JA, VERZWEIGEN
         CLC   1(2,R2),=C'L,' PARAMETER = 'L' ?
         BE    SET2LB        JA, VERZWEIGEN
         CLI   VOLSERNO,C' ' VOLSER NUMBER SCHON ANGEGEBEN ?
         BNE   FEHLPARM      JA, VERZW. ZUR FEHLERROUTINE
         MVC   VOLSERNO,1(R2) VOLSER NUMBER UEBERTRAGEN
         LA    R2,7(R2)      ADRESSE DES NAECHSTEN TRENNUNGSZEICHENS
         B     GETNPARM      VERZWEIGEN
         SPACE 1
SET1LB   EQU   *
         LA    R2,3(R2)      R2 ERHOEHEN
SET2LB   EQU   *
         CLI   LONGBYTE,X'FF' PARAMETER SCHON ANGEGEBEN ?
         BE    FEHLPARM      JA, VERZW. ZUR FEHLERROUTINE
         MVI   LONGBYTE,X'FF' FLAG BYTE SETZEN
         LA    R2,2(R2)      ADRESSE DES NAECHSTEN TRENNUNGSZEICHENS
         B     GETNPARM      VERZWEIGEN
         SPACE 2
*
*      ABSCHLUSS DER PARAMETERVERARBEITUNG.
*
         SPACE 1
ENDPARM  EQU   *
         MVC   HEADER(LENMSG01),MSG01 UEBERSCHRIFT UEBERTRAGEN
         EX    R3,MVCDSNLF   VERZW. ZUM UEBERTR. DES DSNAME
         B     GETCAT        VERZWEIGEN
         SPACE 1
MVCDSN   EQU   *
         MVC   DSNAME(0),TEXT+5 DSNAME UEBERTRAGEN
MVCMBR   EQU   *
         MVC   MBRNAME(0),1(R5) MEMBER NAME UEBERTRAGEN
MVCDSNLF EQU   *
         MVC   MS01DSN(0),TEXT+5 DSNAME, MEMBER NAME UEBERTRAGEN
         EJECT
***********************************************************************
*                                                                     *
*      VERARBEITUNG DER CATALOG-INFORMATIONEN.                        *
*                                                                     *
***********************************************************************
         SPACE 3
GETCAT   EQU   *
         CLI   VOLSERNO,C' ' VOLSER NUMBER ANGEGEBEN ?
         BNE   GETDSCB1     JA, VERZW. ZUM LESEN DES DSCB1
         XC    CAMLIST(16),CAMLIST CAMLIST-BEREICH LOESCHEN
         MVI   CAMLIST,X'44' FLAG BYTE SETZEN
         LA    R2,DSNAME     PARAMETER-ADRESSEN
         SR    R3,R3             LADEN
         LA    R4,CAMWKFLD       UND
         STM   R2,R4,CAMLIST+4   SPEICHERN
         LOCATE CAMLIST      CATALOG LESEN
         LTR   R15,R15       RETURN CODE = 0 ?
         BNZ   FEHLLOC       NEIN, VERZW. ZUR FEHLERROUTINE
         MVC   MESSAGE(LENMSG02),MSG02 NACHRICHTENZEILE UEBERTRAGEN
         MVC   MS02CVOL,CAMCVOL CVOL NUMBER UEBERTRAGEN
         MVC   MS02VOLI,CAMVOLI VOLSER NUMBER UEBERTRAGEN
         BAL   R14,WTOOUTP   VERZW. ZUR NACHRICHTENAUSGABE
         MVC   VOLSERNO,CAMVOLI VOLSER NUMBER UEBERTRAGEN
         EJECT
***********************************************************************
*                                                                     *
*      DSCB1 LESEN UND AUSWERTEN.                                     *
*                                                                     *
***********************************************************************
         SPACE 3
GETDSCB1 EQU   *
         XC    CAMLIST(16),CAMLIST CAMLIST-BEREICH LOESCHEN
         MVI   CAMLIST,X'C1' FLAG BYTE SETZEN
         LA    R2,DSNAME     PARAMETER-ADRESSEN
         LA    R3,VOLSERNO       LADEN
         CALL  MSSMNT,((R3)),VL
         LA    R4,CAMWKFLD       UND
         STM   R2,R4,CAMLIST+4   SPEICHERN
         OBTAIN CAMLIST      DSCB1 DES DATA SET AUFSUCHEN
         LTR   R15,R15       RETURN CODE = 0 ?
         BNZ   FEHLOBT       NEIN, VERZW. ZUR FEHLERROUTINE
         CLC   DS1CCHHR,=XL5'0' DUMMY DSCB1 ?
         BE    FEHLOBT       JA, VERZW. ZUR FEHLERROUTINE
         TM    DS1DSORG,X'40' DSORG = PS ?
         BZ    *+16          NEIN, VERZWEIGEN
         CLI   MBRNAME,C' '  MEMBER NAME ANGEGEBEN ?
         BNE   FEHLORG       JA, VERZW. ZUR FEHLERROUTINE
         B     *+20          VERZWEIGEN
         TM    DS1DSORG,X'02' DSORG = PO ?
         BZ    FEHLORG       NEIN, VERZW. ZUR FEHLERROUTINE
         CLI   MBRNAME,C' '  MEMBER NAME ANGEGEBEN ?
         BE    FEHLORG       NEIN, VERZW. ZUR FEHLERROUTINE
         TM    DS1RECFM,X'80' RECFM = F ?
         BZ    FEHLORG       NEIN, VERZW. ZUR FEHLERROUTINE
         CLC   DS1RECL,=H'80' LRECL = 80 ?
         BNE   FEHLORG       NEIN, VERZW. ZUR FEHLERROUTINE
         EJECT
***********************************************************************
*                                                                     *
*      AUFRUF DES UNTERPROGRAMMS 'DYNALC'.                            *
*                                                                     *
***********************************************************************
         SPACE 3
         MVC   DALPWKS(DALPLEN),DALPCON PARAMETERLISTE UEBERTRAGEN
         LA    R2,DALPRC     ADRESSE DER RETURN CODES
         ST    R2,ADDRRC         LADEN UND SPEICHERN
         LA    R2,DALPDDN    ADRESSE DES DDNAME LADEN
         LA    R3,DSNAME     ADRESSE DES DSNAME LADEN
         SR    R4,R4         R4 LOESCHEN
         CLI   MBRNAME,C' '  MEMBER NAME ANGEGEBEN ?
         BE    *+8           NEIN, VERZWEIGEN
         LA    R4,MBRNAME    ADRESSE DES MEMBER NAME LADEN
         STM   R2,R4,ADDRDDN ADRESSEN SPEICHERN
         LA    R2,VOLSERNO   ADRESSE DER VOLSER NUMBER
         STCM  R2,7,ADDRVOLI+1   LADEN UND SPEICHERN
         XC    DALPRC,DALPRC SPEICHER FUER RETURN CODE LOESCHEN
         MVC   DALPDDN,=CL8' ' SPEICHER FUER DDNAME LOESCHEN
         LA    R1,DALPWKS    ADRESSE DER PARAMETERLISTE LADEN
         L     R15,=V(DYNALC) ADRESSE DES UNTERPROGRAMMS LADEN
         BALR  R14,R15       VERZW. INS UNTERPROGRAMM 'DYNALC'
         CLI   DALPRC+3,X'00' RETURN CODE = 0 ?
         BNZ   FEHLDYNA      NEIN, VERZW. ZUR FEHLERROUTINE
         EJECT
***********************************************************************
*                                                                     *
*      DATEI VERARBEITEN.                                             *
*                                                                     *
***********************************************************************
         SPACE 3
*
*      DATEI EROEFFNEN.
*
         SPACE 1
         MVC   EIN(DCBLEN),DCBCONST DCB UEBERTRAGEN
         MVC   DCBDDN,DALPDDN DDNAME UEBERTRAGEN
         LA    R1,EIN        ADRESSE DES DCB LADEN
         ST    R1,DCBADDR        UND SPEICHERN
         MVI   DCBADDR,X'80' OPTION BYTE SETZEN
         LA    R1,DCBADDR    ADRESSE DER DCB-ADRESSE LADEN
         SVC   19            VERZW. ZUM EROEFFNEN DER DATEI
         TM    DCBOFLGS,X'10' DATEI EROEFFNET ?
         BZ    FEHLOPEN      NEIN, VERZW. ZUR FEHLERROUTINE
         SPACE 2
*
*      DATEI LESEN UND DEREN INHALT AUSGEBEN.
*
         SPACE 1
MAINLOOP EQU   *
         L     R0,REG4       UCM-ID. DES AUFRUFERS LADEN
         WTO   MF=(E,HEADER) UEBERSCHRIFT AUSGEBEN
         LA    R2,10         LOOP COUNTER INITIALISIEREN
         MVC   MESSAGE(LENMSG03),MSG03 NACHRICHTENZEILE UEBERTRAGEN
GETLOOP  EQU   *
         GET   EIN           EINEN SATZ LESEN
         LR    R3,R1         ADRESSE DES SATZES LADEN
         MVC   MS03TEXT,0(R3) TEXT UEBERTRAGEN
         L     R0,REG4       UCM-ID. DES AUFRUFERS LADEN
         WTO   MF=(E,MESSAGE) NACHRICHTENZEILE AUSGEBEN
         CLI   LONGBYTE,X'FF' FLAG BYTE GESETZT ?
         BNE   GETLPOK       NEIN, VERZWEIGEN
         MVC   MESSAGE(LENMSG03),MSG03 NACHRICHTENZEILE UEBERTRAGEN
         MVC   MS03TEXT(26),54(R3) TEXT UEBERTRAGEN
         L     R0,REG4       UCM-ID. DES AUFRUFERS LADEN
         WTO   MF=(E,MESSAGE) NACHRICHTENZEILE AUSGEBEN
GETLPOK  EQU   *
         BCT   R2,GETLOOP    VERZWEIGEN
         EJECT
*
*      NACHRICHTENAUSGABE MIT REPLY.
*
         SPACE 1
WTORLOOP EQU   *
         XC    ECB,ECB       EVENT CONTROL BLOCK LOESCHEN
         L     R0,REG4       UCM-ID. DES AUFRUFERS LADEN
         LA    R2,ECB        ADRESSE DES ECB LADEN
         LA    R3,REPLY      ADRESSE DES REPLY LADEN
         MVC   MESSAGE(LENMSG09),MSG09 NACHRICHTENZEILE UEBERTRAGEN
         WTOR  ,(R3),1,(R2),MF=(E,MESSAGE) NACHRICHTENZEILE AUSGEBEN
         SPACE 1
         WAIT  ECB=ECB       WAIT FOR REPLY
         CLI   REPLY,C'Y'    REPLY = YES ?
         BE    MAINLOOP      JA, VERZWEIGEN
         CLI   REPLY,C'N'    REPLY = NO ?
         BNE   WTORLOOP      NEIN, VERZWEIGEN
         SPACE 2
*
*      DATEI SCHLIESSEN.
*
         SPACE 1
CLOSE    EQU   *
         LA    R1,DCBADDR    ADRESSE DER DCB-ADRESSE LADEN
         SVC   20            VERZW. ZUM SCHLIESSEN DER DATEI
         EJECT
***********************************************************************
*                                                                     *
*      ABSCHLUSSROUTINEN.                                             *
*                                                                     *
***********************************************************************
         SPACE 3
*
*     SPEICHERPLATZFREIGABE,
*     REINITIALISIERUNG DER REGISTER,
*     RUECKSPRUNG ZUM AUFRUFENDEN PROGRAMM.
*
         SPACE 1
ENDE     EQU   *
         XRETURN ,R
         EJECT
***********************************************************************
*                                                                     *
*      FEHLERROUTINEN.                                                *
*                                                                     *
***********************************************************************
         SPACE 3
*
*      ROUTINE BEI FEHLER IN DER PARAMETERKETTE.
*
         SPACE 1
FEHLPARM EQU   *
         L     R0,REG4       UCM-ID. DES AUFRUFERS LADEN
         WTO   MF=(E,MSG05)  FEHLERNACHRICHT AUSGEBEN
         B     ENDE          VERZWEIGEN
         SPACE 2
*
*      ROUTINE BEI LOCATE-FEHLER.
*
         SPACE 1
FEHLLOC  EQU   *
         MVC   MESSAGE(LENMSG06),MSG06 NACHRICHTENZEILE UEBERTRAGEN
         BAL   R14,CONVDEC   VERZW. ZUM UMWANDELN IN DEZIMALZAHL
         MVC   MS06RC,ZWFELD+13 RETURN CODE UEBERTRAGEN
         LA    R14,ENDE      RUECKSPRUNGADRESSE LADEN
         B     WTOOUTP       VERZW. ZUR NACHRICHTENAUSGABE
         SPACE 2
*
*      ROUTINE BEI OBTAIN-FEHLER.
*
         SPACE 1
FEHLOBT  EQU   *
         MVC   MESSAGE(LENMSG07),MSG07 NACHRICHTENZEILE UEBERTRAGEN
         BAL   R14,CONVDEC   VERZW. ZUM UMWANDELN IN DEZIMALZAHL
         MVC   MS07RC,ZWFELD+13 RETURN CODE UEBERTRAGEN
         LA    R14,ENDE      RUECKSPRUNGADRESSE LADEN
         B     WTOOUTP       VERZW. ZUR NACHRICHTENAUSGABE
         EJECT
*
*      ROUTINE BEI UNGUELTIGER DATEI.
*
         SPACE 1
FEHLORG  EQU   *
         MVC   MESSAGE(LENMSG08),MSG08 NACHRICHTENZEILE UEBERTRAGEN
         LA    R14,ENDE      RUECKSPRUNGADRESSE LADEN
         B     WTOOUTP       VERZW. ZUR NACHRICHTENAUSGABE
         SPACE 2
*
*      ROUTINE BEI ALLOCATION-FEHLER.
*
         SPACE 1
FEHLDYNA EQU   *
         MVC   MESSAGE(LENMSG10),MSG10 NACHRICHTENZEILE UEBERTRAGEN
         L     R15,DALPRC    RETURN CODE LADEN
         BAL   R14,CONVDEC   VERZW. ZUM UMWANDELN IN DEZIMALZAHL
         MVC   MS10RC,ZWFELD+13 RETURN CODE UEBERTRAGEN
         UNPK  MS10EC(5),DALPEC+2(3) ERROR REASON CODE UEBERTRAGEN
         TR    MS10EC,TABHEXA-240 ERROR REASON CODE AUFBEREITEN
         MVI   MS10EC+4,C',' KOMMA EINTRAGEN
         UNPK  MS10IC(5),DALPIC+2(3) INFO. REASON CODE UEBERTRAGEN
         TR    MS10IC,TABHEXA-240 INFO. REASON CODE AUFBEREITEN
         LA    R14,ENDE      RUECKSPRUNGADRESSE LADEN
         B     WTOOUTP       VERZW. ZUR NACHRICHTENAUSGABE
         SPACE 2
*
*      ROUTINE BEI OPEN-FEHLER.
*
         SPACE 1
FEHLOPEN EQU   *
         MVC   MESSAGE(LENMSG11),MSG11 NACHRICHTENZEILE UEBERTRAGEN
         BAL   R14,WTOOUTP   VERZW. ZUR NACHRICHTENAUSGABE
         LA    R2,=C'UNALLOC ' ADRESSE DES DYNALLOC-TYPS
         ST    R2,ADDRTYPE       LADEN UND SPEICHERN
         OI    ADDRDSN,X'80' ENDE DER PARAMETERKETTE SPEZIFIZIEREN
         LA    R1,DALPWKS    ADRESSE DER PARAMETERLISTE LADEN
         L     R15,=V(DYNALC) ADRESSE DES UNTERPROGRAMMS LADEN
         BALR  R14,R15       VERZW. ZUM UNTERPROGRAMM 'DYNALC'
         CLI   DALPRC,X'00'  RETURN CODE = 0 ?
         BNZ   FEHLDYNA      NEIN, VERZW. ZUR FEHLERROUTINE
         EJECT
***********************************************************************
*                                                                     *
*      NACHRICHTENAUSGABE.                                            *
*                                                                     *
***********************************************************************
         SPACE 3
WTOOUTP  EQU   *
         L     R0,REG4       UCM-ID. DES AUFRUFERS LADEN
         WTO   MF=(E,HEADER) UEBERSCHRIFT AUSGEBEN
         L     R0,REG4       UCM-ID. DES AUFRUFERS LADEN
         WTO   MF=(E,MESSAGE) NACHRICHTENZEILE AUSGEBEN
         BR    R14           VERZWEIGEN
         SPACE 3
***********************************************************************
*                                                                     *
*      UMWANDLUNG VON DUALZAHLEN IN ENTPACKTE DEZIMALZAHLEN.          *
*                                                                     *
***********************************************************************
         SPACE 3
CONVDEC  EQU   *
         CVD   R15,DBWORD    DUALZAHL IN GEP. DEZIMALZAHL UMWANDELN
         UNPK  ZWFELD,DBWORD DEZIMALZAHL ENTPACKEN
         OI    ZWFELD+14,C'0' VORZEICHEN MODIFIZIEREN
         BR    R14           VERZWEIGEN
         EJECT
***********************************************************************
*                                                                     *
*      REGISTER EQUATES.                                              *
*                                                                     *
***********************************************************************
         SPACE 3
R0       EQU   0             MACRO- UND PARAMETER-REGISTER
R1       EQU   1             MACRO- UND PARAMETER-REGISTER
R2       EQU   2             ARBEITSREGISTER
R3       EQU   3             ARBEITSREGISTER
R4       EQU   4             ARBEITSREGISTER
R5       EQU   5             ARBEITSREGISTER
R6       EQU   6             ARBEITSREGISTER
R7       EQU   7             ARBEITSREGISTER
R8       EQU   8             ARBEITSREGISTER
R9       EQU   9             ARBEITSREGISTER
R10      EQU   10            ARBEITSREGISTER
R11      EQU   11            BASIS FUER DSECT PARMAREA
R12      EQU   12            BASIS FUER CSECT LIST
R13      EQU   13            BASIS FUER DSECT ABER
R14      EQU   14            RUECKSPRUNGADRESSEN
R15      EQU   15            CSECT-ADRESSEN UND RETURN CODES
         EJECT
***********************************************************************
*                                                                     *
*      DEFINITIONEN DER KONSTANTEN-SPEICHER.                          *
*                                                                     *
***********************************************************************
         SPACE 3
*
*      PARAMETERLISTE FUER 'DYNALC' (KONSTANTEN).
*
         SPACE 1
DALPCON  DS    0F
         DC    A(0)          ADRESSE DER RETURN CODES
         DC    A(DALPTYPE)   ADRESSE DES DYNALLOC-TYPS
         DC    A(0)          ADRESSE DES DDNAME
         DC    A(0)          ADRESSE DES DATA SET NAME
         DC    A(0)          ADRESSE DES MEMBER NAME
         DC    A(DALPSTAT)   ADRESSE DES DATA SET STATUS
         DC    A(DALPDISP)   ADRESSE DER NORM. DISPOSITION
         DC    A(DALPDISP)   ADRESSE DER COND. DISPOSITION
         DC    7A(0)
         DC    AL1(128)      ENDE DER PARAMETERKETTE
         DC    AL3(0)        ADRESSE DER VOLSER NUMBER
DALPLEN  EQU   *-DALPCON     LAENGE DER PARAMETERKETTE
DALPSTAT DC    C'SHR'        DATA SET STATUS
DALPDISP DC    CL8'KEEP'     DATA SET DISPOSITION
DALPTYPE DC    C'DSALLOC '   DYNALLOC-TYP
         SPACE 2
*
*      TABELLE ZUM AUFBEREITEN VON HEXADEZIMALZAHLEN.
*
         SPACE 1
TABHEXA  DC    C'0123456789ABCDEF'
         EJECT
*
*      DCB DER EINGABEDATEI (KONSTANTEN).
*
         SPACE 1
DCBCONST DCB   DDNAME=EIN00000,                                        *
               DSORG=PS,                                               *
               MACRF=(GL),                                             *
               LRECL=80,                                               *
               EODAD=CLOSE
DCBLEN   EQU   *-DCBCONST    LAENGE DES DCB
         EJECT
***********************************************************************
*                                                                     *
*      DEFINITION DER AUSGABENACHRICHTEN.                             *
*                                                                     *
***********************************************************************
         SPACE 3
MSG01    WTO   'XLIST01 DSN=                                           *
                      ',                                               *
               MF=L,MCSFLAG=(REG0)
LENMSG01 EQU   *-MSG01
         SPACE 1
MSG02    WTO   'XLIST02 CATALOG ON 123456 POINTS TO 123456',           *
               MF=L,MCSFLAG=(REG0)
LENMSG02 EQU   *-MSG02
         SPACE 1
MSG03    WTO   'XLIST03                                                *
                      ',                                               *
               MF=L,MCSFLAG=(REG0)
LENMSG03 EQU   *-MSG03
         SPACE 1
MSG04    WTO   'XLIST04 FUNCTION SUPPORTED FO OS/VS2 (MVS) ONLY',      *
               MF=L,MCSFLAG=(REG0)
         EJECT
MSG05    WTO   'XLIST05 ERROR IN PARAMETER LIST',                      *
               MF=L,MCSFLAG=(REG0)
         SPACE 1
MSG06    WTO   'XLIST06 DATA SET NOT FOUND IN CATALOG, LOCATE RC=99',  *
               MF=L,MCSFLAG=(REG0)
LENMSG06 EQU   *-MSG06
         SPACE 1
MSG07    WTO   'XLIST07 DATA SET NOT FOUND ON VOLUME, OBTAIN RC=99',   *
               MF=L,MCSFLAG=(REG0)
LENMSG07 EQU   *-MSG07
         SPACE 1
MSG08    WTO   'XLIST08 DATA SET INVALID FOR THIS COMMAND',            *
               MF=L,MCSFLAG=(REG0)
LENMSG08 EQU   *-MSG08
         EJECT
MSG09    WTOR  'XLIST09 REPLY ''Y'' (YES) OR ''N'' (NO) TO CONTINUE',  *
               MF=L,MCSFLAG=(REG0)
LENMSG09 EQU   *-MSG09
         SPACE 1
MSG10    WTO   'XLIST10 ALLOCATION FAILURE, RC=99, EC=9999, IC=9999',  *
               MF=L,MCSFLAG=(REG0)
LENMSG10 EQU   *-MSG10
         SPACE 1
MSG11    WTO   'XLIST11 OPEN FAILURE',                                 *
               MF=L,MCSFLAG=(REG0)
LENMSG11 EQU   *-MSG11
         LTORG
         EJECT
***********************************************************************
*                                                                     *
*      DEFINITION DER ARBEITSBEREICHE.                                *
*                                                                     *
***********************************************************************
         SPACE 3
ABER     DSECT
SAVEAREA DS    18F           SAVEAREA FUER ALLGEMEINE REGISTER
DBWORD   DS    D             ZWISCHENSPEICHER FUER DEZIMALZAHLEN
ZWFELD   DS    CL15          ZWISCHENSPEICHER FUER DEZIMALZAHLEN
LONGBYTE DS    C             FLAG BYTE FUER LAENGE DER AUSGABE
REPLY    DS    C             SPEICHER FUER REPLY
ECB      DS    F             EVENT CONTROL BLOCK
DSNAME   DS    CL44          DATA SET NAME
MBRNAME  DS    CL8           MEMBER NAME
VOLSERNO DS    CL6           VOLUME SERIAL NUMBER
         SPACE 2
*
*      DCB DER EINGABEDATEI.
*
         SPACE 1
EIN      DS    0F
         DS    10F
DCBDDN   DS    CL8           DDNAME
DCBOFLGS DS    C             FLAG BYTE
         ORG   EIN+DCBLEN
DCBADDR  DS    F             ADRESSE DES DCB
         EJECT
CAMLIST  DS    4F            BEREICH FUER CAMLIST-MACRO
         DS    0D
CAMWKFLD DS    0CL265        WORK FIELD
         SPACE 2
*
*      DEFINITIONEN DER VOLSER-LISTE.
*
         SPACE 1
         ORG   CAMWKFLD+6
CAMVOLI  DS    CL6           VOLSER NUMBER
         ORG   CAMWKFLD+259
CAMCVOL  DS    CL6           VOLSER NUMBER DES CATALOGS
         SPACE 2
*
*      DSCB1-DEFINITIONEN.
*
         SPACE 1
         ORG   CAMWKFLD
DS1FMTID DS    C             FORMAT IDENTIFIER (= C'1')
         DS    CL37
DS1DSORG DS    CL2           DATA SET ORGANISATION
DS1RECFM DS    C             DATA SET RECORD FORMAT
         DS    C
DS1BLKL  DS    CL2           DATA SET BLOCK LENGTH
DS1RECL  DS    CL2           DATA SET RECORD LENGTH
         DS    CL3
DS1DSIND DS    C             DATA SET INDICATORS
DS1CCHHR DS    CL5           CCHHR-ADRESSE DES DSCB1
         ORG   CAMWKFLD+265
         EJECT
*
*      PARAMETERLISTE FUER 'DYNALC' (ARBEITSBEREICH).
*
         SPACE 1
DALPWKS  DS    0F
ADDRRC   DS    F             ADRESSE VON RETCODE
ADDRTYPE DS    F             ADRESSE DES DYNALLOC-TYPS
ADDRDDN  DS    F             ADRESSE DES DDNAME
ADDRDSN  DS    F             ADRESSE DES DSNAME
ADDRMBRN DS    F             ADRESSE DES MEMBER NAME
         DS    10F
ADDRVOLI DS    F             ADRESSE DER VOLSER NUMBER
         SPACE 1
DALPRC   DS    F             RETURN CODE
DALPEC   DS    F             ERROR REASON CODE
DALPIC   DS    F             INFORMATION REASON CODE
DALPDDN  DS    CL8           DDNAME
         EJECT
*
*      NACHRICHTEN-BEREICHE.
*
         SPACE 1
HEADER   DS    0F            UEBERSCHRIFTENZEILE
         ORG   HEADER+16
MS01DSN  DS    CL54          SPEZIFIZIERTER DSNAME
         SPACE 1
MESSAGE  DS    0F            NACHRICHTENZEILE
         ORG   MESSAGE+12
         DS    CL11
MS02CVOL DS    CL6           CVOL NUMBER
         DS    CL11
MS02VOLI DS    CL6           VOLSER NUMBER
         ORG   MESSAGE+12
MS03TEXT DS    CL54          TEXT DER EINGABEDATEI
         ORG   MESSAGE+12
         DS    CL41
MS06RC   DS    CL2           RETURN CODE
         ORG   MESSAGE+12
         DS    CL40
MS07RC   DS    CL2           RETURN CODE
         ORG   MESSAGE+12
         DS    CL23
MS10RC   DS    CL2           RETURN CODE
         DS    CL5
MS10EC   DS    CL4           ERROR REASON CODE
         DS    CL5
MS10IC   DS    CL4           INFORMATION REASON CODE
         ORG   MESSAGE+66
         SPACE 1
ABERL    EQU   *-ABER        LAENGE DER ARBEITSBEREICHE
         EJECT
***********************************************************************
*                                                                     *
*      PARAMETERBEREICH.                                              *
*                                                                     *
***********************************************************************
         SPACE 3
         XPARM
         SPACE 3
         END   LIST
./ ADD NAME=DUMP
DUMP     CSECT
         XSAVE R12,,DUMP,WORKL
         REG
         LR    R0,R12
         LA    R15,SVCROUT
         SVC   250
         XRETURN 0,R
SVCROUT  EQU   *
         LR    R12,R0
         USING WORKAREA,R13
         LR    R11,R1
         USING PARMAREA,R11
         SPACE 3
* SCAN THE ENTERED COMMAND
         MVI   SCANINF,C'S'        SET 'START OF INPUT SCAN'
         MVI   ADDRTYPE,C'V'       SET ADDRESS TYPE TO 'VIRTUAL'
*
         LA    R2,TEXT+5           SET UP ADDRESS OF FIRST BYTE OF
*                                     EXPECTED ADDRESS
ADDRLPS  LA    R0,8                MAX. NUMBER OF CHARACTERS
         SR    R10,R10             R10 IS TO CONTAIN THE GIVEN ADDRESS
*
ADDRLP   CLI   0(R2),C'A'          EXAMINE EACH CHARACTER
         BL    ADDRLPE             BR IF < 'A'
         SLL   R10,4               SHIFT 4 BITS TO LEFT
         IC    R15,0(,R2)          INSERT THE CURRENT CHARACTER
         N     R15,=F'15'          CLEAR ALL BUT THE LAST FOUR BITS
         CLI   0(R2),C'F'          HEXADEC. CHARACTER?
         BH    ADDRLP1             BR IF > 'F'
         LA    R15,9(,R15)         C'A' -> X'A'
         B     ADDRLP2             GO ON
ADDRLP1  CLI   0(R2),C'0'          HEXADEC. CHARACTER?
         BL    PARMERR             BR IF NO
         CLI   0(R2),C'9'          HEXADEC. CHARACTER?
         BH    PARMERR             BR IF NO
ADDRLP2  OR    R10,R15             INSERT NEXT 4 BITS OF ADDRESS
         LA    R2,1(,R2)           ADDRESS OF NEXT CHARACTER
         BCT   R0,ADDRLP           BCT
*
ADDRLPE  CLI   SCANINF,C'S'        START OF INPUT SCAN?
         BE    DIRADDR             BR IF YES
         CLI   SCANINF,C'+'        ADDRESS TO BE MODIFIED?
         BE    ADDADDR             BR IF YES
         CLI   SCANINF,C'-'        ADDRESS TO BE MODIFIED?
         BE    SUBADDR             BR IF YES
         B     PARMERR             BR
DIRADDR  CLI   0(R2),C','          DELIMITER?
         BE    SAVEADDR            BR IF YES
         CLI   0(R2),C' '          END OF INPUT?
         BNE   TESTINDA            BR IF NO
         MVI   SCANINF,C'E'        SET 'ALL INPUT SCANNED'
         B     SAVEADDR            BR
* TEST FOR INDIRECT ADDRESS
TESTINDA DS    0H
         CLI   0(R2),C'%'          INDIRECT ADDRESS?
         BE    TESTINDB            BR IF NO
         CLI   0(R2),C'?'          INDIRECT ADDRESS?
         BNE   TESTMODA            BR IF NO
TESTINDB LA    R0,3                TEST FOR
         NR    R0,R10                FULLWORD
         BNZ   INDAERR                 BOUNDARY
*
         LR    R4,R10              LOAD ADDRESS TO BE TESTED
         BAL   R6,ADDRTEST         GO TEST ADDRESS AVAILABILITY
         CLI   0(R2),C'?'          31-BIT-MODE
         BE    XA1
         CL    R10,=XL4'00FFFFFF'
         BNH   NO31XA
XA1      MODE31
NO31XA   LA    R10,0(R10)          CLEAR BIT OR BYTE
         L     R10,0(,R10)         LOAD ADDRESS OF ADDRESS
         LA    R10,0(R10)
         MODE24
*
         LA    R2,1(,R2)           ADDRESS OF NEXT BYTE
         B     ADDRLPE             BR
* TEST FOR ADDRESS TO BE MODIFIED
TESTMODA ST    R10,PARMADDR        STORE ADDRESS
         NI    PARMADDR,127        CLEAR MINUS BIT
         CLI   0(R2),C'+'          ADDRESS TO BE MODIFIED?
         BE    ADDRADD             BR IF YES
         CLI   0(R2),C'-'          ADDRESS TO BE MODIFIED?
         BNE   PARMERR             BR IF NO
         MVI   SCANINF,C'-'        SET INDICATOR
         LA    R2,1(,R2)           ADDRESS OF NEXT BYTE
         B     ADDRLPS             BR
ADDRADD  MVI   SCANINF,C'+'        SET INDICATOR
         LA    R2,1(,R2)           ADDRESS OF NEXT BYTE
         B     ADDRLPS             BR
*
ADDADDR  A     R10,PARMADDR        ADD TO GIVEN ADDRESS
         MVI   SCANINF,C'S'        SET INDICATOR
         B     DIRADDR             BR
SUBADDR  L     R15,PARMADDR        SUBTRACT
         SR    R15,R10               FROM
         LR    R10,R15                 GIVEN ADDRESS
         MVI   SCANINF,C'S'        SET INDICATOR
         B     DIRADDR             BR
*
SAVEADDR DS    0H
         CL    R10,=XL4'00FFFFFF'  31-BIT-ADDR
         BNH   NON31A1
         MODE31
NON31A1  DS    0H
         LA    R10,0(R10)          CLEAR BIT OR BYTE
         MODE24
         ST    R10,PARMADDR        SAVE GIVEN ADDRESS,
         SRL   R10,4                 GET THE NEXT LOWER MULTIPLE
         SLL   R10,4                   OF 16
         ST    R10,DUMPADDR        AND SAVE IT
*
         EJECT
* LOOK FOR NUMBER OF FULLWORDS TO BE DUMPED
         LA    R0,4                DEFAULT NUMBER OF BYTES
         ST    R0,PARMNMBR                                *
         CLI   SCANINF,C'E'        ALL INPUT SCANNED?
         BE    TESTNMBR            BR IF YES
SKIPZERO LA    R2,1(,R2)           ADDRESS OF NEXT CHARACTER
         CLI   0(R2),C'0'          SKIP LEADING ZEROES
         BE    SKIPZERO              -
         BL    TESTNMBR            BR IF CHARACTER < '0'
         CLI   1(R2),C','          1 BYTE OF LENGTH INFORMATION?
         BE    PACK1               BR IF YES
         CLI   1(R2),C' '          1 BYTE OF LENGTH INFORMATION?
         BNE   TEST2               BR IF NO
         MVI   SCANINF,C'E'        SET 'ALL INPUT SCANNED'
         B     PACK1
TEST2    CLI   1(R2),C'0'          NUMERIC CHARACTER?
         BL    PARMERR             BR IF NO
         CLI   2(R2),C','          2 BYTES OF LENGTH INFORMATION?
         BE    PACK2               BR IF YES
         CLI   2(R2),C' '          2 BYTES OF LENGTH INFORMATION?
         BNE   PARMERR             BR IF NO
         MVI   SCANINF,C'E'        SET 'ALL INPUT SCANNED'
         B     PACK2
PACK1    PACK  DBLWD,0(1,R2)       PACK ONE DIGIT
         LA    R2,2(,R2)           ADDRESS OF NEXT BYTE
         B     CVBNMBR             GO ON
PACK2    PACK  DBLWD,0(2,R2)       PACK TWO DIGITS
         LA    R2,3(,R2)           ADDRESS OF NEXT BYTE
         B     CVBNMBR             GO ON
*
CVBNMBR  CVB   R0,DBLWD            CONVERT TO BINARY
         LA    R15,40              MAX. VALUE
         CR    R0,R15              COMPARE TO MAX
         BNH   *+6                 IF > MAX :
         LR    R0,R15                SET TO MAX
         SLA   R0,2                MULTIPLY BY 4 -> NUMBER OF BYTES
         ST    R0,PARMNMBR         SAVE THIS NUMBER
*
TESTNMBR TM    PARMADDR+3,X'03'    TEST FOR ALIGNMENT
         BZ    NEXTPARM            FULLWORD - OK
         L     R0,PARMNMBR         LOAD NUMBER OF BYTES TO BE DUMPED
         BO    SUB3NMBR            RIGHTMOST BYTE - SUBTRACT 3
         TM    PARMADDR+3,X'02'    HALFWORD ALIGNMENT?
         BO    SUB2NMBR            YES - SUBTRACT 2
         CLI   PARMNMBR+3,4        IS ONE WORD TO BE DUMPED?
         BNE   SUB1NMBR            BR IF NO
SUB3NMBR BCTR  R0,0                SUBTRACT 1
SUB2NMBR BCTR  R0,0                SUBTRACT 1
SUB1NMBR BCTR  R0,0                SUBTRACT 1
         ST    R0,PARMNMBR         STORE NUMBER OF BYTES TO BE DUMPED
*
         EJECT
* LOOK FOR MORE PARAMETER
NEXTPARM CLI   SCANINF,C'E'        ALL INPUT SCANNED?
         BE    GODUMP              BR IF YES
*
         CLC   0(4,R2),=C'REAL'    ARE REAL ADDRESSES TO BE GIVEN?
         BNE   *+8                 BR IF NO
         MVI   ADDRTYPE,C'R'       SET INDICATOR
*
*
         EJECT
GODUMP   EQU   *
* DUMP THE SPECIFIED ADDRESS RANGE
         L     R4,DUMPADDR         ADDRESS IN MSG
         L     R5,PARMADDR         ADDRESS OF FIRST BYTE TO BE DUMPED
DUMPLP1  MVC   WTODUMP,WTODUMPL    MOVE MSG SKELETON
* PROCESSING FOR AVOIDING A 0C4
         LA    R2,=C' '            FOR INDICATION IN ADDRTEST
         BAL   R6,ADDRTEST         GO TEST ADDRESS AVAILABILITY
*
         LR    R7,R5
         SR    R7,R4
         LA    R8,16
         SR    R8,R7               NUMBER OF CHARACTERS
         L     R0,PARMNMBR         LOAD NUMBER OF BYTES
         CR    R8,R0               COMPARE TO NUMBER OF BYTES
         BNH   *+6                 BR IF ^>
         LR    R8,R0               LOAD NUMBER OF BYTES
         SR    R0,R8               SUBTRACT
         ST    R0,PARMNMBR           AND STORE NUMBER OF BYTES LEFT
         LA    R7,WTOCHAR(R7)      ADDRESS OF FIRST CHARACTER
         LR    R9,R5
         SR    R9,R4
         SLA   R9,1
         ST    R9,HELPWORD
         SRA   R9,3
         A     R9,HELPWORD
         LA    R9,WTOHEX(R9)       ADDRESSE OF FIRST HEXADEC. DIGIT
*
DUMPLP2  DS    0H
         CL    R5,=XL4'00FFFFFF'   31-BIT-ADDR
         BNH   NON31A
         MODE31
NON31A   DS    0H
         LA    R5,0(R5)            CLEAR BIT OR BYTE
         MVC   0(1,R7),0(R5)       MOVE CHARACTER
         UNPK  HELPWORD(3),0(2,R7) UNPK CHARACTER
         MVC   0(2,R9),HELPWORD    MOVE 2 HEX DIGITS
         TR    0(2,R9),CCTAB-240   TRANSLATE
         TR    0(1,R7),TABLE       TRANSLATE
         LA    R5,1(,R5)           ADDR OF NEXT BYTE
         LA    R7,1(,R7)            "
         LA    R9,2(,R9)            "
         ST    R5,DUMPADDR         STORE ADDR OF CURR. BYTE
         TM    DUMPADDR+3,X'03'    WORD BOUNDARY?
         BNZ   *+8                 BR IF NO
         LA    R9,1(,R9)           SKIP ONE BYTE IN MSG
         BCT   R8,DUMPLP2          BCT
*
         LR    R9,R4               LOAD VIRTUAL ADDRESS
         CLI   ADDRTYPE,C'R'       IS REAL ADDRESS TO BE WRITTEN?
         BNE   *+8                 BR IF NO
         LRA   R9,0(,R4)           LOAD REAL ADDRESS
         ST    R9,HELPWORD         STORE THIS ADDRESS
         UNPK  WTOADDR(9),HELPWORD(5)  UNPK THIS ADDRESS
         TR    WTOADDR,CCTAB-240   TRANSLATE TO 0-F
         MVI   WTOSPC1,C' '        MOVE BLANK
         MODE24
*
         L     R0,PARMNMBR         LOAD NUMBER OF BYTES LEFT
         LTR   R0,R0               IS NUMBER = 0?
         BNP   RETURN              BR IF YES
*
         L     R0,REG4             LOAD CONSOLE ID
         LA    R1,WTODUMP
         BAL   R14,WTOROUT         WRITE TO OPERATOR
*
         MODE31
         LA    R4,16(,R4)          INCREMENT DUMP ADDRESS
         MODE24
         B     DUMPLP1               AND PREPARE NEXT LINE
*
ERROR    EQU   *
         MVC   WTOBER,ER
RETURN   EQU   *
         L     R0,REG4
         LA    R1,WTOBER
         BAL   R14,WTOROUT
         SVC   3
         EJECT
* TEST AN ADDRESS FOR DAT-ERROR
ADDRTEST EQU   *
         SR    R1,R1               CLEAR R1 (IS TO CONTAIN THE CC)
         CLI   0(R2),C'?'          31-BIT-MODE ?
         BE    XA
         CL    R4,=XL4'00FFFFFF'
         BNH   NO31
XA       MODE31
NO31     DS    0H
         LA    R4,0(R4)            CLEAR BIT OR BYTE
         LRA   R9,0(,R4)           GET REAL ADDRESS
         BC    4,DATCC1            CC = 1: SEGMENT-TABLE ENTRY INVALID
         BC    2,DATCC2            CC = 2: PAGE-TABLE ENTRY INVALID
         BC    1,DATCC3            CC = 3: SEGMENT- OR PAGE-TABLE
*                                            LENGTH VIOLATION
         MODE24                    CC = 0: OKAY
         BR    R6
*
DATCC3   LA    R1,1(,R1)           ADD 1 TO R1
DATCC2   LA    R1,1(,R1)           ADD 1 TO R1
DATCC1   LA    R1,1(,R1)           ADD 1 TO R1
         MODE24
         STH   R1,DATCC            STORE THE CC
         CLI   DATCC+1,2           CC = 2?
         BNE   DATERROR
* EXAMINE GETMAIN-BIT IN PTE
         L     R1,=A(X'00FFF000')  LOAD BIT MASK
         NR    R1,R9               COMPUTE
         SRL   R1,8                  OFFSET IN PFT
         L     R3,16               CVT POINTER
         TM    X'74'(R3),X'80'     XA ?
         BO    DATERROR
         L     R15,X'164'(,R3)     PVTP
         L     R15,X'0C'(,R15)     PFT ORIGIN
         LA    R15,0(R1,R15)       ADDRESS OF PFTE
         SR    R14,R14             CLEAR R14 FOR ICM
         ICM   R14,6,2(R15)        INSERT VBN
         LA    R0,X'00000FFF'      LOAD BIT MASK
         NR    R9,R0               CLEAR CORR BITS
         OR    R9,R14              GET VIRT ADDRESS OF PTE
         TM    1(R9),X'01'         GETMAIN-BIT ON?
         BZ    DATERROR            BR IF NO
         BR    R6                  OKAY
*
PARMERR  B     ERROR
*
DATERROR EQU   *                   DYNAMIC ADDRESS TRANSLATION ERROR
         MVC   WTOCCMSG,DATCCMSG  MOVE MSG SKELETON
         MVC   WTOCC,DATCC+1      MOVE CC
         OI    WTOCC,X'F0'        SET ZONE
         ST    R4,HELPWORD        STORE VIRTUAL ADDRESS
         UNPK  WTOCCADR(9),HELPWORD(5)  UNPK ADDRESS
         TR    WTOCCADR,CCTAB-240 CONVERT TO 0-F
         MVI   WTOCCADR+8,C' '
         B     RETURN
*
INDAERR  EQU   *                  ADDRESS ERROR ROUTINE
         MVC   INDAMSG,INDAMSGL   MOVE MSG SKELETON
         ST    R10,HELPWORD       STORE ADDRESS
         UNPK  INDAADDR(9),HELPWORD(5)  UNPK ADDRESS
         TR    INDAADDR,CCTAB-240 TRANSLATE TO 0-F
         MVI   INDAADDR+8,C' '    MOVE BLANK
         B     RETURN
WTOROUT  EQU   *
         ST    R14,SAVE14
         L     R0,REG4
         C     R0,=CL4'ROSC'
         BNE   NOROS
         STM   R14,R12,12(R13)                   SAVE ALL REGS IN SA
*
*              NOW WE CAN ADDRESS DUMMYSECTION IN XMON
*
         LH    R0,0(R1)      LOAD LENGTH OF WTO
         SH    R0,=H'4'      DECREMENT BY 4
         STC   R0,3(R1)      INSERT LENGTH TO MESSAGE FOR USE BY ROSCOE
         LA    R0,3(R1)      LOAD MESSAGE ADDRESS
         L     R13,4(R13)    R13 --> SA IN XMON
         ST    R0,76(R13)    STORE IT IN DYN AREA OF XMON = INAREA
         OI    76(R13),X'80' SET HIGHORDER BIT ON
         L     R15,100(R13)  LOAD ROSCOE-CODE <<OUTCODE>>
         LA    R1,76(R13)    LOAD PARAMETER REGISTER
         L     R13,4(R13)    R13 --> SA IN ROSCOE
         L     R14,12(R13)   LOAD RETURNADDRESS
         LM    R2,R12,28(R13)                    LOAD REMAINDER
         BR    R14           RETURN DIRECT TO ROSCOE
NOROS    EQU   *
         C     R0,=CL4'TSO'
         BNE   NOTSO
         LH    R0,0(R1)
         SH    R0,=H'4'
         LA    R1,4(R1)
         SVC   93             TPUT
         L     R14,SAVE14
         BR    R14
NOTSO    EQU   *
         WTO   MF=(E,(1))
         L     R14,SAVE14
         BR    R14
SAVE14   DS    F
         EJECT
ER       WTO   'XDUMP01 ERROR IN PARAMETER',MCSFLAG=REG0,MF=L
WTODUMPL WTO   'ABCDEFGH  ........ ........ ........ ........ *        C
                       *',MCSFLAG=REG0,MF=L
DATCCMSG WTO   'XDUMP04 LRA CC=0,VIRTUAL ADDRESS=         ',           *
               MCSFLAG=REG0,MF=L
INDAMSGL WTO   'XDUMP05 ADDRESS ABCDEFGH DOES NOT CONTAIN AN ADDRESS', *
               MCSFLAG=REG0,MF=L
TRTAB    DS    0CL64
         DC    X'FF0A0B0C0D0E0F'
         DC    41XL1'FF'
         DC    X'00010203040506070809'
         DC    6XL1'FF'
TABLE    DC    0F'0'
         DC    C'................'
         DC    C'................'
         DC    C'................'
         DC    C'................'
         DC    C' .........Ö.<(+×'
         DC    C'&&.........!$*);^'
         DC    C'-/.........,%_>?'
         DC    C'..........:#@''="'
         DC    C'................'
         DC    C'................'
         DC    C'................'
         DC    C'................'
         DC    C'.ABCDEFGHI......'
         DC    C'.JKLMNOPQR......'
         DC    C'..STUVWXYZ......'
         DC    C'0123456789......'
CCTAB    DC    C'0123456789ABCDEF'
         LTORG
         EJECT
WORKAREA DSECT
SVA      DS    18F
DBLWD    DS    D
PARMADDR DS    F                   DUMP ADDRESS
DUMPADDR DS    F                   NEXT LOWER MULTIPLE OF 16
PARMNMBR DS    F                   NUMBER OF BYTES TO BE DUMPED
HELPWORD DS    F                   RESERVED
DATCC    DS    H                   CONDITION CODE AFTER LRA
ADDRTYPE DS    CL1                 ADDRESS TYPE INFORMATION
SCANINF  DS    CL1                 'INPUT SCAN' INFORMATION
WTOBER   DS    CL126
         ORG   WTOBER
WTODUMP  DS    0CL68               DUMP AREA
         DS    F                   RDW
WTOADDR  DS    CL8
WTOSPC1  DS    CL2
WTOHEX   DS    4CL9
         DS    CL1
WTOCHAR  DS    CL16
         DS    CL1
         ORG   WTOBER
WTOCCMSG DS    0CL46               DAT ERROR MSG AREA
         DS    F
         DS    CL15                'XDUMP04 LRA CC='
WTOCC    DS    CL1                 LRA CC
         DS    CL17                ',VIRTUAL ADDRESS='
WTOCCADR DS    CL8                 VIRTUAL ADDRESS
         DS    CL1
         ORG   WTOBER
INDAMSG  DS    0CL56               IND ADDR ERROR MSG AREA
         DS    F
         DS    CL16                'XDUMP05 ADDRESS '
INDAADDR DS    CL8                 ADDRESS
         DS    CL28                ' DOES NOT CONTAIN AN ADDRESS'
         ORG
WORKL    EQU   *-WORKAREA
         XPARM
         END   DUMP
./ ADD NAME=DVOL
         TITLE 'XDVOL                             X-COMMAND DVOL'
DVOL     CSECT
         SPACE 3
***********************************************************************
*                                                                     *
*      PROGRAM-ID. DVOL.                                              *
*      AUTHOR. EHNERT.                                                *
*      INSTALLATION. BAYER AG, LEVERKUSEN, RECHENZENTRUM.             *
*      DATE-WRITTEN. 7. 10. 1975.                                     *
*      REMARKS.                                                       *
*                                                                     *
*          DAS X-COMMAND 'DVOL' GIBT INFORMATIONEN UEBER DEN          *
*          STATUS DER ALS PARAMETER SPEZIFIZIERTEN VOLUMES AUS.       *
*                                                                     *
*          ALS PARAMETER KOENNEN BIS ZU ZEHN VOLSER- ODER ADRESS-     *
*          MASKEN ANGEGEBEN WERDEN, MIT DEREN HILFE EINE AUSWAHL      *
*          GETROFFEN WIRD. DABEI STEHT '*' FUER JEDES ZEICHEN AN      *
*          DIESER STELLE.                                             *
*          ALS WEITERE AUSWAHL-PARAMETER KOENNEN DEVICE-TYPEN (DASD,  *
*          MSS, TAPE, UR, TP, GRAPHIC) UND DEVICE-STATUS (ONLINE,     *
*          OFFLINE, READY) ANGEGEBEN WERDEN.                          *
*                                                                     *
*          WIRD DAS PROGRAMM UNTER DEM NAMEN 'DVOL' AUFGERUFEN,       *
*          SO GELTEN DIE SPEZIFIZIERTEN PARAMETER ALS VOLSER-         *
*          MASKEN, WIRD ES UNTER DEM NAMEN 'UNIT' AUFGERUFEN,         *
*          SO GELTEN DIE SPEZIFIZIERTEN PARAMETER ALS ADRESS-         *
*          MASKEN.                                                    *
*                                                                     *
***********************************************************************
         EJECT
***********************************************************************
*                                                                     *
*      BEGINN DER VERARBEITUNG.                                       *
*                                                                     *
***********************************************************************
         SPACE 3
*
*      SICHERN DER REGISTER,
*      SPEICHERPLATZANFORDERUNG FUER ARBEITSBEREICHE,
*      ZUORDNUNG DER BASISREGISTER.
*
         SPACE 1
         XSAVE R12,,DVOL,ABERL
         SPACE 1
         LR    R11,R1        BASISREG. FUER DSECT PARMAREA INITIALIS.
         USING UCB,R3        BASISREG. FUER DSECT UCB ZUORDNEN
         USING MESSAGE,R10   BASISREG. FUER DSECT MESSAGE ZUORDNEN
         USING PARMAREA,R11  BASISREG. FUER DSECT PARMAREA ZUORDNEN
         USING ABER,R13      BASISREG. FUER DSECT ABER ZUORDNEN
         EJECT
*
*      INITIALISIERUNG DER SPEICHER.
*
         SPACE 1
         MVI   VOLBYTE,X'00' SCHALTER LOESCHEN
         MVI   WTORBYTE,X'FF' SCHALTER SETZEN
         LA    R2,ENDTAB1    ENDADRESSEN DER
         LA    R3,ENDTPVOL       TABELLEN LADEN
         STM   R2,R3,ADDRETB1    UND SPEICHERN
         MVC   UCMID,REG4    UCM-ID. DES AUFRUFERS UEBERTRAGEN
         MVC   PNAME,TEXT    PROGRAMM-NAME UEBERTRAGEN
         MVC   HEADER(LENMSG01),MSG01 UEBERSCHRIFT UEBERTRAGEN
         LA    R10,HEADER    BASISREG. FUER DSECT MESSAGE INIT.
         MVC   WTOR(LENMSG06),MSG06 WTOR-NACHRICHT UEBERTAGEN
         LA    R10,WTOR      BASISREG. FUER DSECT MESSAGE INIT.
         MVI   CPUBYTE,X'00' FLAG BYTE LOESCHEN
         MVI   PRMFLAGS,X'00'
         MVC   PRMFLAGS+1(PFLAGLEN-1),PRMFLAGS
         MVI   WTOBYTE,X'00' FLAG BYTE LOESCHEN
         SPACE 2
*
*      FLAG BYTS IN NACHRICHTENBEREICHEN SETZEN.
*
         SPACE 1
         LA    R10,MSGTAB    ADRESSE DER TABELLE LADEN
         ST    R10,SAVE1R10      UND SPEICHERN
         L     R3,ADDRETB1   ENDADRESSE DER TABELLEN LADEN
CLEARMSS EQU   *
         MVC   MSGFLAG,=X'FFFF' FLAG BYTES SETZEN
         LA    R10,72(R10)   R10 ERHOEHEN
         CR    R10,R3        ENDE DER TABELLEN ERREICHT ?
         BL    CLEARMSS      NEIN, VERZWEIGEN
         SPACE 1
         L     R2,16         ADRESSE DER CVT LADEN
         MVC   MODE,116(R2)  SAVE MODE
         TM    116(R2),X'01' SYSTEM = MVS ?
         BZ    GETPARM       NEIN, VERZWEIGEN
         L     R2,764(R2)    ADRESSE DER PCCAVT LADEN
         LTR   R2,R2         PCCAVT VERFUEGBAR ?
         BZ    GETPARM       NEIN, VERZWEIGEN
         CLC   0(4,R2),=XL6'0' CPU 0 VERFUEGBAR ?
         BE    *+8           NEIN, VERZWEIGEN
         OI    CPUBYTE,X'F0' FLAG BITS SETZEN
         CLC   4(4,R2),=XL6'0' CPU 1 VERFUEGBAR ?
         BE    GETPARM       NEIN, VERZWEIGEN
         OI    CPUBYTE,X'0F' FLAG BITS SETZEN
         EJECT
***********************************************************************
*                                                                     *
*      VERARBEITUNG DER EINGABEPARAMETER.                             *
*                                                                     *
***********************************************************************
         SPACE 3
GETPARM  EQU   *
         CLC   TEXT(4),=C'DVOL' VOLSER-MASKEN ANGEGEBEN ?
         BNE   *+8           NEIN, VERZWEIGEN
         MVI   VOLBYTE,X'FF' SCHALTER SETZEN
         LA    R4,TEXT+4     R4 INITIALISIEREN
         LA    R8,PARMENDE   ENDADRESSE DES PARAMETERBEREICHS LADEN
         CLI   0(R4),C','    PARAMETER ANGEGEBEN ?
         BNE   FEHLPARM      NEIN, VERZW. ZUR FEHLERROUTINE
         LA    R6,TABPVOL1   ADRESSE DER VOLSER-TABELLE LADEN
NEXTPARM EQU   *
         SR    R5,R5         R5 LOESCHEN
         LR    R7,R4         ADRESSE DES TRENNUNGSZEICHENS LADEN
NXTBYTE  EQU   *
         LA    R4,1(R4)      R4 ERHOEHEN
         CR    R4,R8         PARAMETERBEREICH UEBERSCHRITTEN ?
         BNL   FEHLPARM      JA, VERZW. ZUR FEHLERROUTINE
         CLI   0(R4),C','    ENDE DES PARAMETERS ERREICHT ?
         BE    NEXTPVOL      JA, VERZWEIGEN
         CLI   0(R4),X'00'   ENDE DER PARAMETERKETTE ERREICHT ?
         BE    NEXTPVOL      JA, VERZWEIGEN
         CLI   0(R4),C' '    ENDE DER PARAMETERKETTE ERREICHT ?
         BE    NEXTPVOL      JA, VERZWEIGEN
         LA    R5,1(R5)      R5 ERHOEHEN
         CLI   0(R4),C'*'    BELIEBIGES ZEICHEN AN DIESER STELLE ?
         BNE   NXTBYTE       NEIN, VERZWEIGEN
         MVI   0(R4),X'FF'   ZEICHEN UMSETZEN
         B     NXTBYTE       VERZWEIGEN
         EJECT
NEXTPVOL EQU   *
         BAL   R14,SETFLAGS  VERZW. ZUM SETZEN DER PARAMETER-FLAGS
         C     R6,ADDRETPV   TABELLENENDE UEBERSCHRITTEN ?
         BNL   FEHLPARM      JA, VERZWEIGEN
         C     R5,=F'6'      LAENGE DER VOLID GUELTIG ?
         BH    FEHLPARM      NEIN, VERZW. ZUR FEHLERROUTINE
         LTR   R5,R5         VOLID ANGEGEBEN ?
         BZ    FEHLPARM      NEIN, VERZW. ZUR FEHLERROUTINE
         BCTR  R5,0          R5 UM EINS VERMINDERN
         EX    R5,MOVEPVOL   VERZW. ZUR UEBERTR. DER VOLSER NUMBER
         STC   R5,0(R6)      LAENGENANGABE IN TABELLE EINTRAGEN
         LA    R6,7(R6)      R6 ERHOEHEN
         CLI   0(R4),C','    FOLGEN WEITERE PARAMETER ?
         BE    NEXTPARM      JA, VERZWEIGEN
         SPACE 2
*
*      ABSCHLUSS DER PARAMETERVERARBEITUNG.
*
         SPACE 1
ENDPARM  EQU   *
         MVI   0(R6),X'80'   TABELLENENDE SPEZIFIZIEREN
         MVC   TABPVOL2,TABPVOL1 VOLSER-TABELLE KOPIEREN
         LA    R6,TABPVOL2-1 ADRESSE DER TABELLE LADEN
NEXTFF   EQU   *
         LA    R6,1(R6)      R6 ERHOEHEN
         CLI   0(R6),X'80'   TABELLENENDE ERREICHT ?
         BE    GETUCB        JA, VERZWEIGEN
         CLI   0(R6),X'FF'   TABELLENZEICHEN = X'FF' ?
         BNE   NEXTFF        NEIN, VERZWEIGEN
         MVI   0(R6),X'00'   TABELLENZEICHEN UMSETZEN
         B     NEXTFF        VERZWEIGEN
         EJECT
***********************************************************************
*                                                                     *
*      PARAMETER-FLAGS SETZEN.                                        *
*                                                                     *
***********************************************************************
         SPACE 3
SETFLAGS EQU   *
         LA    R1,PRMTABLE-10 ADRESSE DER PARAMETER-TABELLE LADEN
         LA    R2,PRMFLAGS   ADRESSE DER FLAG-BYTES LADEN
         SR    R3,R3         R3 FUER IC LOESCHEN
SETFLGLP EQU   *
         LA    R1,10(R1)     ADRESSE DES NAECHSTEN TABELLEN-ELEMENTS
         LA    R2,1(R2)      ADRESSE DES NAECHSTEN FLAG-BYTES
         CLI   0(R1),X'FF'   TABELLEN-ENDE ?
         BER   R14           JA, VERZWEIGEN
         IC    R3,0(R1)      LAENGENANGABE LADEN
         EX    R3,CLCPARM    VERZW. ZUM VERGLEICH MIT SPEZ. PARAMETER
         BNE   SETFLGLP      VERZW. BEI UNGLEICH
         MVI   PARMFLAG,X'FF' FLAG BYTE SETZEN
         MVI   0(R2),X'FF'   FLAG BYTE SETZEN
         CLI   0(R4),C','    FOLGEN WEITERE PARAMETER ?
         BE    NEXTPARM      JA, VERZWEIGEN
         B     ENDPARM       VERZWEIGEN
         EJECT
***********************************************************************
*                                                                     *
*      VERARBEITUNG DER UCB-INFORMATIONEN.                            *
*                                                                     *
***********************************************************************
         SPACE 3
GETUCB   EQU   *
         DROP  R11           R11 FREIGEBEN
NEXTUCB  EQU   *
         UCBSCAN
         LTR   R15,R15
         BNZ   ABSCHLUS
         LR    R3,R1
         SPACE 1
         MVI   FNDBYTE,X'FF' FLAG BYTE SETZEN
         TM    PARMFLAG,X'FF' AUSWAHL-PARAMETER ANGEGEBEN ?
         BZ    *+8           NEIN, VERZWEIGEN
         BAL   R14,TSTFLAGS  VERZW. ZUR PRUEFUNG
         TM    FNDBYTE,X'FF' PRUEFUNG OK ?
         BZ    NEXTUCB       NEIN, VERZWEIGEN
         EJECT
*
*      VERGLEICH MIT SPEZIFIZIERTEN ADRESSEN ODER VOLSER NUMBERS.
*
         SPACE 1
         SR    R5,R5         R5 LOESCHEN
         LA    R6,TABPVOL1-7 ADRESSE DER VOLSER-TABELLE LADEN
         LA    R7,TABPVOL2-7 ADRESSE DER VOLSER-TABELLE LADEN
NXTVOLID EQU   *
         LA    R6,7(R6)      R6 ERHOEHEN
         LA    R7,7(R7)      R7 ERHOEHEN
         TM    0(R6),X'80'   TABELLENENDE ERREICHT ?
         BO    TESTADDR      JA, VERZWEIGEN
         IC    R5,0(R6)      LAENGENANGABE LADEN
         CLI   VOLBYTE,X'FF' VOLSER-MASKEN ANGEGEBEN ?
         BNE   NEXTADR       NEIN, VERZWEIGEN
         TM    UCBDVCLS,X'A0' VOLUME ?
         BZ    NEXTUCB       NEIN, VERZWEIGEN
         MVC   ZWVOLID1,UCBVOLI VOLSER NUMBER UEBERTRAGEN
         MVC   ZWVOLID2,UCBVOLI VOLSER NUMBER UEBERTRAGEN
EXMVC    EQU   *
         EX    R5,NCVOLID1   VERZW. ZUR UEBERLAGERUNG DER VOLID
         EX    R5,OCVOLID2   VERZW. ZUR UEBERLAGERUNG DER VOLID
         CLC   ZWVOLID1,ZWVOLID2 VOLID = AUSGEW. VOLID ?
         BNE   NXTVOLID      VERZW., WENN VOLID ^= AUSGEW. VOLID
         MVC   VOLSERNO,UCBVOLI VOLSER NUMBER UEBERTRAGEN
         B     MVCMSG        VERZWEIGEN
         SPACE 1
NEXTADR  EQU   *
         MVC   ZWVOLID1,UCBNAME UNIT ADRESSE UEBERTRAGEN
         MVC   ZWVOLID2,UCBNAME UNIT ADRESSE UEBERTRAGEN
         B     EXMVC         VERZWEIGEN
         SPACE 1
TESTADDR EQU   *
         TM    TABPVOL1,X'80' ADRESSEN ODER VOLUMES ANGEGEBEN ?
         BZ    NEXTUCB       JA, VERZWEIGEN
         TM    VOLBYTE,X'FF' VOLSER-MASKEN ANGEGEBEN ?
         BZ    MVCMSG        NEIN, VERZWEIGEN
         TM    UCBDVCLS,X'A0' VOLUME ?
         BZ    NEXTUCB       NEIN, VERZWEIGEN
         EJECT
***********************************************************************
*                                                                     *
*      AUFBEREITUNG DER NACHRICHTENZEILEN.                            *
*                                                                     *
***********************************************************************
         SPACE 3
MVCMSG   EQU   *
         MVI   WTOBYTE,X'FF' FLAG BYTE SETZEN
         L     R10,SAVE1R10  R10 INITIALISIEREN
         MVC   MESSAGE(LENMSG02),MSG02 NACHRICHTENZEILE UEBERTRAGEN
         MVC   MSGADR,UCBNAME UNIT NAME UEBERTRAGEN
         STCM  R3,15,MSGUCBAD UCB-ADRESSE SPEICHERN
         UNPK  MSGUCBAD(9),MSGUCBAD(5) ADRESSE ENTPACKEN
         MVI   MSGUCBAD+8,C' '
         TR    MSGUCBAD,TABHEXA-240 ADRESSE AUFBEREITEN
         SPACE 1
         TM    UCBSTAT,X'80' DEVICE ONLINE ?
         BO    TESTALOC      JA, VERZWEIGEN
         MVC   MSGLINE,=C'OFF' OFFLINE SPEZIFIZIEREN
TESTALOC EQU   *
         TM    UCBSTAT,X'08' DEVICE ALLOCATED ?
         BZ    TESTRDY       NEIN, VERZWEIGEN
         MVI   MSGALLOC,C'Y' ALLOCATED SPEZIFIZIEREN
         EJECT
TESTRDY  EQU   *
         TM    UCBSFLS,X'40' DEVICE READY ?
         BO    TESTVOLI      NEIN, VERZWEIGEN
         MVI   MSGREADY,C'Y' READY SPEZIFIZIEREN
TESTVOLI EQU   *
         TM    UCBDVCLS,X'A0' VOLUME ?
         BZ    MSGOK         NEIN, VERZWEIGEN
         CLC   UCBVOLI,=XL6'0' VOLID VORHANDEN ?
         BE    TESTMNT       NEIN, VERZWEIGEN
         MVC   MSGVOLID,UCBVOLI VOLSER NUMBER UEBERTRAGEN
TESTMNT  EQU   *
         TM    UCBDMCT,X'80' VOLUME MOUNTED ?
         BZ    NOTMOUNT      NEIN, VERZWEIGEN
         MVI   MSGMOUNT,C'Y' MOUNTED SPEZIFIZIEREN
         B     TESTSTOR      VERZWEIGEN
NOTMOUNT EQU   *
         MVI   MSGMOUNT,C'N' NOT MOUNTED SPEZIFIZIEREN
TESTSTOR EQU   *
         TM    UCBSTAB,X'04' STORAGE VOLUME ?
         BZ    TESTPUB       NEIN, VERZWEIGEN
         MVC   MSGATTR1,=C'STG/RMV' STORAGE SPEZIFIZIEREN
TESTPUB  EQU   *
         TM    UCBSTAB,X'08' PUBLIC VOLUME ?
         BZ    TESTPRV       NEIN, VERZWEIGEN
         MVC   MSGATTR1,=C'PUB/RMV' PUBLIC SPEZIFIZIEREN
TESTPRV  EQU   *
         TM    UCBSTAB,X'10' PRIVATE VOLUME ?
         BZ    TESTRES       NEIN, VERZWEIGEN
         MVC   MSGATTR1,=C'PRV/RMV' PRIVATE SPEZIFIZIEREN
TESTRES  EQU   *
         TM    UCBSTAT,X'04' VOLUME RESIDENT ?
         BZ    TESTRSV       NEIN, VERZWEIGEN
         MVC   MSGATTR2,=C'RES' RESIDENT SPEZIFIZIEREN
TESTRSV  EQU   *
         TM    UCBSTAT,X'20' VOLUME RESERVED ?
         BZ    TESTCPA       NEIN, VERZWEIGEN
         MVC   MSGATTR2,=C'RSV' RESERVED SPEZIFIZIEREN
TESTCPA  EQU   *
         TM    UCBSFLS,X'02'
         BNO   TESTBSY
         MVC   MSGCPA,=C'YES'
TESTBSY  EQU   *
         TM    UCBSFLS,X'80'
         BNO   TESTR
         MVC   MSGBSY,=C'YES'
TESTR    EQU   *
         TM    MODE,SXA      MVS-XA
         BNO   TESTR2        NO
         LR    R14,R3        UCB-ADDR
         SH    R14,=H'15'    UCBIOSF1
         TM    0(R14),X'80'    VOLUME RESERVED?
         BNO   TESTDASD
         B     TESTR3
TESTR2   EQU   *
         TM    UCBSFLS+1,X'10'
         BNO   TESTDASD
TESTR3   EQU   *
         MVC   MSGRSV,=C'YES'
TESTDASD EQU   *
         CLI   UCBDVCLS,X'20'
         BNE   MSGOK
         SR    R14,R14
         IC    R14,35(R3)
         SLL   R14,25
         SRL   R14,25
         CVD   R14,DBLWD
         UNPK  MSGND,DBLWD
         OI    MSGND+1,X'F0'
         IC    R14,36(R3)
         CVD   R14,DBLWD
         UNPK  MSGNR,DBLWD
         OI    MSGNR+1,X'F0'
         TM    MODE,SXA                   MVS-XA?
         BNO   TESTD1
         XR    R14,R14
         IC    R14,39(R3)     LAST OF TWO BYTES (NO OF CURRENT USER)
         B     TESTD2
TESTD1   EQU   *
         IC    R14,38(R3)      ONLY ONE BYTE IN 370
TESTD2   EQU   *
         CVD   R14,DBLWD
         UNPK  MSGCNT,DBLWD
         OI    MSGCNT+2,X'F0'
MSGOK    EQU   *
         LA    R14,NEXTUCB   RUECKSPRUNGADRESSE LADEN
         MVC   MSGFLAG,=XL6'0' FLAG BYTES LOESCHEN
         LA    R10,72(R10)   R10 ERHOEHEN
         C     R10,ADDRETB1  ENDE DER TABELLE UEBERSCHRITTEN ?
         BNL   AUSMSGM       JA, VERZWEIGEN
         ST    R10,SAVE1R10  LAUFENDE ADRESSE SPEICHERN
         BR    R14           VERZWEIGEN
         EJECT
***********************************************************************
*                                                                     *
*      ABSCHLUSSROUTINEN.                                             *
*                                                                     *
***********************************************************************
         SPACE 3
ABSCHLUS EQU   *
         FREEMAIN R,SP=125    SPEICHERPLATZ FREIGEBEN
         MVI   WTORBYTE,X'00' FLAG BYTE LOESCHEN
         TM    WTOBYTE,X'FF' NACHRICHTEN AUSGEGEBEN ?
         BNZ   AUSRMSGN      JA, VERZWEIGEN
         LA    R10,MSGTAB    ADRESSE DER NACHRICHTENTABELLE LADEN
         CLI   VOLBYTE,X'FF' PROGRAMM = 'DVOL' ?
         BNE   *+14          NEIN, VERZWEIGEN
         MVC   MESSAGE(LENMSG03),MSG03 NACHRICHTENZEILE UEBERTRAGEN
         B     *+10          VERZWEIGEN
         MVC   MESSAGE(LENMSG04),MSG04 NACHRICHTENZEILE UEBERTRAGEN
         L     R0,UCMID      UCM-ID. DES AUFRUFERS LADEN
         BAL   R14,WTOROUT
         B     ENDE          VERZWEIGEN
         SPACE 2
*
*      AUSGABE NOCH OFFENER INFO-NACHRICHTEN.
*
         SPACE 1
AUSRMSGN EQU   *
         LA    R10,MSGTAB    ADRESSE DER TABELLE LADEN
         CLC   MSGFLAG,=XL6'0' SIND NOCH NACHRICHTEN OFFEN ?
         BNE   ENDE          NEIN, VERZWEIGEN
         BAL   R14,AUSMSGM   JA, VERZW. ZUR NACHRICHTENAUSGABE
         EJECT
*
*      SPEICHERPLATZFREIGABE,
*      REINITIALISIERUNG DER REGISTER UND
*      RUECKSPRUNG ZUM AUFRUFENDEN PROGRAMM.
*
         SPACE 1
ENDE     EQU   *
         XRETURN ,R
         SPACE 3
***********************************************************************
*                                                                     *
*      ROUTINE BEI FEHLER IN DER PARAMETERKETTE.                      *
*                                                                     *
***********************************************************************
         SPACE 3
FEHLPARM EQU   *
         LA    R10,MSGTAB    ADRESSE DER NACHRICHTENTABELLE LADEN
         MVC   MESSAGE(LENMSG05),MSG05 NACHRICHTENZEILE UEBERTRAGEN
         L     R0,UCMID      UCM-ID. DES AUFRUFERS LADEN
         BAL   R14,WTOROUT
         B     ENDE          VERZWEIGEN
         EJECT
***********************************************************************
*                                                                     *
*      AUSWAHL-PRUEFUNG DER DEVICES.                                  *
*                                                                     *
***********************************************************************
         SPACE 3
TSTFLAGS EQU   *
         CLC   TAPEFLAG(5),=XL6'0' DEVICE CLASS AUSGEWAEHLT ?
         BE    TSTMSS        NEIN, VERZWEIGEN
         LA    R4,PRMTABLE-10 ADRESSE DER PARAMETER-TABELLE LADEN
         LA    R5,PRMFLAGS   ADRESSE DER FLAG BYTES LADEN
TSTDEVLP EQU   *
         LA    R4,10(R4)     ADRESSE DES NAECHSTEN TABELLEN-ELEMENTS
         CLI   1(R4),X'FF'   TABELLEN-ENDE ?
         BE    CLEARFLG      JA, VERZWEIGEN
         LA    R5,1(R5)      ADRESSE DES NAECHSTEN FLAG BYTES
         TM    0(R5),X'FF'   FLAG BYTE GESETZT ?
         BZ    TSTDEVLP      NEIN, VERZWEIGEN
         CLC   UCBDVCLS,1(R4) GESUCHTE DEVICE ?
         BNE   TSTDEVLP      NEIN, VERZWEIGEN
         SPACE 1
TSTMSS   EQU *
         TM    MSSFLAG,X'FF' VIRTUAL DEVICE ANGEFORDERT ?
         BZ    TSTNOMSS      NEIN, VERZWEIGEN
         TM    UCBDVCLS,X'20' DASD ?
         BZ    CLEARFLG      NEIN, VERZWEIGEN
         TM    UCBTBYT2,X'08' VIRTUAL DEVICE ?
         BZ    CLEARFLG      NEIN, VERZWEIGEN
         B     TSTPLINE      VERZWEIGEN
TSTNOMSS EQU   *
         TM    UCBDVCLS,X'20' DASD ?
         BZ    TSTPLINE      NEIN, VERZWEIGEN
         TM    UCBTBYT2,X'08' VIRTUAL DEVICE ?
         BO    CLEARFLG      JA, VERZWEIGEN
         EJECT
TSTPLINE EQU   *
         CLC   ONLFLAG(2),=XL6'0' ON-/OFF-LINE AUSGEWAEHLT ?
         BE    TSTREADY      NEIN, VERZWEIGEN
         TM    UCBSTAT,X'80' DEVICE ONLINE ?
         BZ    TSTPOFFL      NEIN, VERZWEIGEN
         TM    ONLFLAG,X'FF' ONLINE DEVICES GESUCHT ?
         BZ    CLEARFLG      NEIN, VERZWEIGEN
         B     TSTREADY      VERZWEIGEN
TSTPOFFL EQU   *
         TM    OFFLFLAG,X'FF' OFFLINE DEVICES GESUCHT ?
         BZ    CLEARFLG      NEIN, VERZWEIGEN
         SPACE 1
TSTREADY EQU   *
         TM    RDYFLAG,X'FF' READY DEVICES GESUCHT ?
         BZ    TSTSTG        NEIN, VERZWEIGEN
         TM    UCBSFLS,X'40' DEVICE READY ?
         BO    CLEARFLG      NEIN, VERZWEIGEN
         CLI   UCBDVCLS,X'80'
         BNE   TSTSTG
         CLC   UCBVOLI,=C'=STAM='
         BE    CLEARFLG
TSTSTG   EQU   *
         TM    STGFLG,X'FF'
         BZ    TSTPRV
         CLI   UCBDVCLS,X'20'
         BNE   CLEARFLG
         TM    UCBTBYT2,X'08'
         BO    CLEARFLG
         TM    UCBSTAT,X'80'
         BNO   CLEARFLG
         TM    34(R3),X'10'
         BNO   CLEARFLG
         B     TSTFLGOK
TSTPRV   EQU   *
         TM    PRVFLG,X'FF'
         BZ    TSTALLOC
         CLI   UCBDVCLS,X'20'
         BNE   CLEARFLG
         TM    UCBTBYT2,X'08'
         BO    CLEARFLG
         TM    UCBSTAT,X'80'
         BNO   CLEARFLG
         TM    34(R3),X'10'
         BO    CLEARFLG
         B     TSTFLGOK
TSTALLOC EQU   *
         TM    ALLOCFLG,X'FF'
         BZ    TSTFLGOK
         TM    UCBSTAT,X'08'
         BNO   CLEARFLG
         CLI   UCBDVCLS,X'80'
         BNE   TSTFLGOK
         CLC   UCBVOLI,=C'=STAM='
         BE    CLEARFLG
         SPACE 1
TSTFLGOK EQU   *
         BR    R14           VERZWEIGEN
         SPACE 2
CLEARFLG EQU   *
         MVI   FNDBYTE,X'00' FLAG BYTE LOESCHEN
         BR    R14           VERZWEIGEN
         EJECT
***********************************************************************
*                                                                     *
*      AUSGABE DER NACHRICHTEN.                                       *
*                                                                     *
***********************************************************************
         SPACE 3
AUSMSGM  EQU   *
         ST    R14,SAVE1R14  RUECKSPRUNGADRESSE SICHERN
         L     R0,UCMID      UCM-ID. DES AUFRUFERS LADEN
         MVC   MSGSAVE(LENMSG01),MESSAGE
         MVC   MESSAGE(LENMSG01),MSG01
         BAL   R14,WTOROUT
         MVC   MESSAGE(LENMSG01),MSGSAVE
         LA    R10,MSGTAB-72 ADRESSE DER TABELLE LADEN
         L     R9,ADDRETB1   ENDADRESSE DER TABELLE LADEN
         BAL   R14,AUSGABE   VERZW. ZUR AUSGABE WEITERER ZEILEN
         LA    R10,MSGTAB    ADRESSE DER TABELLE LADEN
         ST    R10,SAVE1R10      UND SPEICHERN
         L     R14,SAVE1R14  RUECKSPRUNGADRESSE LADEN
         CLC   UCMID(3),=CL3'TSO'
         BER   R14
         CLC   UCMID(4),=CL4'ROSC'
         BER   R14
         CLI   WTORBYTE,X'FF' FLAG BYTE GESETZT ?
         BNER  R14           NEIN, VERZWEIGEN
NXTREPLY EQU   *
         XC    ECB,ECB       EVENT CONTROL BLOCK LOESCHEN
         L     R0,UCMID      UCM-ID. DES AUFRUFERS LADEN
         LA    R4,ECB        ADRESSE DES ECB LADEN
         LA    R5,REPLY      ADRESSE DES REPLY LADEN
         WTOR  ,(R5),1,(R4),MF=(E,WTOR)
         SPACE 1
         WAIT  ECB=ECB       AUF REPLY WARTEN
         CLI   REPLY,C'N'    REPLY = NO ?
         BE    ENDE          JA, VERZWEIGEN
         CLI   REPLY,C'Y'    REPLY = YES ?
         BNE   NXTREPLY      NEIN, VERZWEIGEN
         L     R14,SAVE1R14  RUECKSPRUNGADRESSE LADEN
         BR    R14           VERZWEIGEN
         EJECT
*
*      AUSGABE EINZELNER NACHRICHTENZEILEN.
*
         SPACE 1
AUSGABE  EQU   *
         ST    R14,SAVE2R14  RUECKSPRUNGADRESSE SICHERN
NEXTMSG  EQU   *
         LA    R10,72(R10)   R10 ERHOEHEN
         CR    R10,R9        ENDE DER TABELLE ERREICHT ?
         BNL   ENDMSG        JA, VERZWEIGEN
         CLC   MSGFLAG,=X'FFFF' FLAG BYTES GESETZT ?
         BE    ENDMSG        JA, VERZWEIGEN
         MVC   MSGFLAG,=X'FFFF' FLAG BYTES SETZEN
         L     R0,UCMID      UCM-ID. DES AUFRUFERS LADEN
         BAL   R14,WTOROUT
         B     NEXTMSG       VERZWEIGEN
ENDMSG   EQU   *
         L     R14,SAVE2R14  RUECKSPRUNGADRESSE LADEN
         BR    R14
WTOROUT  EQU   *
         ST    R14,SAVE14
         LA    R1,MESSAGE
         C     R0,=CL4'ROSC'
         BNE   NOROS
         STM   R14,R12,12(R13)                   SAVE ALL REGS IN SA
*
*              NOW WE CAN ADDRESS DUMMYSECTION IN XMON
*
         LH    R0,0(R1)      LOAD LENGTH OF WTO
         SH    R0,=H'4'      DECREMENT BY 4
         STC   R0,3(R1)      INSERT LENGTH TO MESSAGE FOR USE BY ROSCOE
         LA    R0,3(R1)      LOAD MESSAGE ADDRESS
         L     R13,4(R13)    R13 --> SA IN XMON
         ST    R0,76(R13)    STORE IT IN DYN AREA OF XMON = INAREA
         OI    76(R13),X'80' SET HIGHORDER BIT ON
         L     R15,100(R13)  LOAD ROSCOE-CODE <<OUTCODE>>
         LA    R1,76(R13)    LOAD PARAMETER REGISTER
         L     R13,4(R13)    R13 --> SA IN ROSCOE
         L     R14,12(R13)   LOAD RETURNADDRESS
         LM    R2,R12,28(R13)                    LOAD REMAINDER
         BR    R14           RETURN DIRECT TO ROSCOE
NOROS    EQU   *
         C     R0,=CL4'TSO'
         BNE   DOWTO
         LH    R0,MESSAGE
         SH    R0,=H'4'
         LA    R1,MESSAGE+4
         SVC   93             TPUT
         L     R14,SAVE14
         BR    R14
DOWTO    EQU   *
         WTO   MF=(E,MESSAGE)
         L     R14,SAVE14
         BR    R14
***********************************************************************
*                                                                     *
*      BEFEHLE, DIE MIT HILFE DES EXECUTE-BEFEHLS AUSGEFUEHRT WERDEN. *
*                                                                     *
***********************************************************************
         SPACE 3
MOVEPVOL EQU   *
         MVC   1(0,R6),1(R7) VOLID IN TABELLE UEBERTRAGEN
NCVOLID1 EQU   *
         NC    ZWVOLID1(0),1(R6) VOLID UEBERLAGERN
OCVOLID2 EQU   *
         OC    ZWVOLID2(0),1(R7) VOLID UEBERLAGERN
CLCPARM  EQU   *
         CLC   2(0,R1),1(R7) PARAMETER = TABELLEN-ELEMENT ?
         EJECT
***********************************************************************
*                                                                     *
*      REGISTER EQUATES.                                              *
*                                                                     *
***********************************************************************
         SPACE 3
R0       EQU   0             MACRO- UND-PARAMETER REGISTER
R1       EQU   1             MACRO- UND-PARAMETER REGISTER
R2       EQU   2             POINTER IN CVT / UCB LOOKUP TABLE
R3       EQU   3             POINTER FUER UCB
R4       EQU   4             ARBEITSREGISTER
R5       EQU   5             ARBEITSREGISTER
R6       EQU   6             ARBEITSREGISTER
R7       EQU   7             ARBEITSREGISTER
R8       EQU   8             ARBEITSREGISTER
R9       EQU   9             ARBEITSREGISTER
R10      EQU   10            POINTER IN NACHRICHTEN-TABELLEN
R11      EQU   11            BASISREG. FUER DSECT PARMAREA / VEKTOR
R12      EQU   12            BASISREG. FUER CSECT DVOL
R13      EQU   13            BASISREG. FUER DSECT ABER
R14      EQU   14            RUECKSPRUNGADRESSEN
R15      EQU   15            CSECT-ADRESSEN UND RETURN CODES
         EJECT
***********************************************************************
*                                                                     *
*      TABELLE FUER AUFBEREITUNG VON HEXADEZIMALZAHLEN.               *
*                                                                     *
***********************************************************************
         SPACE 2
TABHEXA  DC    C'0123456789ABCDEF'
         SPACE 3
***********************************************************************
*                                                                     *
*      TABELLE FUER PARAMETER-ANGABEN.                                *
*                                                                     *
***********************************************************************
         SPACE 2
PRMTABLE EQU   *
         DC    X'03',X'80',CL8'TAPE'
         DC    X'03',X'20',CL8'DASD'
         DC    X'01',X'08',CL8'UR'
         DC    X'01',X'40',CL8'TP'
         DC    X'06',X'10',CL8'GRAPHIC'
         DC    X'02',X'FF',CL8'MSS'
         DC    X'05',X'FF',CL8'ONLINE'
         DC    X'06',X'FF',CL8'OFFLINE'
         DC    X'04',X'FF',CL8'READY'
         DC    X'04',X'FF',CL8'ALLOC'
         DC    X'06',X'FF',CL8'NONPRIV'
         DC    X'06',X'FF',CL8'PRIVATE'
         DC    X'FF',X'FF',CL8' ' TABELLENENDE
         SPACE 3
MODE     DC    X'00'             SAVE SYSTEM MODE
SXA      EQU   X'80'             MVS XA
         SPACE 3
         LTORG
         EJECT
***********************************************************************
*                                                                     *
*      DEFINITION DER AUSGABENACHRICHTEN.                             *
*                                                                     *
***********************************************************************
         SPACE 3
MSG01    WTO   'VOLSER ADR LNE M A R ATTRIB    UCB    NU ND NR CPA BSY *
               RSV CNT',                                               *
               MF=L,MCSFLAG=(REG0)
LENMSG01 EQU   *-MSG01
         SPACE 1
MSG02    WTO   '       ADR ON  N N N N/A     99999999 00 00 00 NO  NO  *
               NO  000',                                               *
               MF=L,MCSFLAG=(REG0)
LENMSG02 EQU   *-MSG02
         SPACE 1
MSG03    WTO   'SPECIFIED VOLUME(S) NOT FOUND',MF=L,MCSFLAG=REG0
LENMSG03 EQU   *-MSG03
         SPACE 1
MSG04    WTO   'SPECIFIED ADDRESS(ES) NOT FOUND',MF=L,MCSFLAG=REG0
LENMSG04 EQU   *-MSG04
         SPACE 1
MSG05    WTO   'INVALID PARAMETER LIST',MF=L,MCSFLAG=REG0
LENMSG05 EQU   *-MSG05
         SPACE 1
MSG06    WTOR  'XDVOL06 REPLY ''Y'' (YES) OR ''N'' (NO) TO CONTINUE',  *
               MF=L,MCSFLAG=(REG0)
LENMSG06 EQU   *-MSG06
         EJECT
***********************************************************************
*                                                                     *
*      DEFINITION DER ARBEITSBEREICHE.                                *
*                                                                     *
***********************************************************************
         SPACE 3
ABER     DSECT
SAVEAREA DS    18F           SAVEAREA FUER ALLGEMEINE REGISTER
DBLWD    DS    D
         SPACE 2
*
*      ADRESSEN-SPEICHER.
*
         SPACE 1
ADDRETB1 DS    F             ENDADRESSE DER MSG-NACHRICHTEN-TABELLE
ADDRETPV DS    F             ENDADRESSE DER VOLSER-TABELLE
SAVE1R10 DS    F             SAVEAREA1 FUER R10
SAVE1R14 DS    F             SAVEAREA1 FUER R14
SAVE2R14 DS    F             SAVEAREA2 FUER R14
UCMID    DS    F             UCM-ID. DES AUFRUFERS

SAVE14   DS    F
MSGSAVE  DS    CL80
         SPACE 2
*
*      ARBEITSSPEICHER.
*
         SPACE 1
ECB      DS    F             EVENT CONTROL BLOCK
FNDBYTE  DS    C             SCHALTER
VOLBYTE  DS    C             SCHALTER FUER GESUCHTE VOLUMES
CPUBYTE  DS    C             FLAG BYTE FUER CPU'S
WTOBYTE  DS    C             SCHALTER FUER WTO
WTORBYTE DS    C             SCHALTER FUER WTOR
REPLY    DS    C             SPEICHER FUER REPLY
VOLSERNO DS    CL6           ZWISCHENSPEICHER FUER VOLSER NUMBER
ZWVOLID1 DS    CL6           ZWISCHENSPEICHER FUER VOLSER NUMBER
ZWVOLID2 DS    CL6           ZWISCHENSPEICHER FUER VOLSER NUMBER
PNAME    DS    CL4           PROGRAMM-NAME
         EJECT
*
*      PARAMETER-FLAGS.
*
         SPACE 1
PRMFLAGS DS    0CL8
PARMFLAG DS    C             FLAG BYTE FUER PARAMETER-ANGABEN
TAPEFLAG DS    C             FLAG BYTE FUER TAPE-AUSWAHL
DASDFLAG DS    C             FLAG BYTE FUER DASD-AUSWAHL
URFLAG   DS    C             FLAG BYTE FUER UR-AUSWAHL
TPFLAG   DS    C             FLAG BYTE FUER TP-AUSWAHL
GRAPFLAG DS    C             FLAG BYTE FUER GRAPHIC-AUSWAHL
MSSFLAG  DS    C             FLAG BYTE FUER MSS-AUSWAHL
ONLFLAG  DS    C             FLAG BYTE FUER ONLINE-AUSWAHL
OFFLFLAG DS    C             FLAG BYTE FUER OFFLINE-AUSWAHL
RDYFLAG  DS    C             FLAG BYTE FUER READY-AUSWAHL
ALLOCFLG DS    C             FLAG BYTE FUER ALLOC-AUSWAHL
PRVFLG   DS    C
STGFLG   DS    C
PFLAGLEN EQU   *-PRMFLAGS    LAENGE DER PARAMETER-FLAGS
         SPACE 2
*
*      MASKEN-TABELLEN FUER ADRESSEN ODER VOLSER NUMBERS AUS
*      DEM PARAMETERBEREICH.
*
*      AUFBAU DER TABELLE:
*      BYTE1 - LAENGE DES ANGEGEBENEN PARAMETERS ODER X'80' BEI
*          TABELLENENDE
*      BYTES2-7 - ANFANGSZEICHEN DES PARAMETERS UND MASKENZEICHEN
*
         SPACE 1
TABPVOL1 DS    10CL7         TABELLE MIT MASKENZEICHEN X'FF'
ENDTPVOL EQU   *
         DS    CL7
TABPVOL2 DS    CL77          TABELLE MIT MASKENZEICHEN X'00'
         SPACE 2
*
*      NACHRICHTEN-BEREICHE.
*
*      AUFBAU:
*      BYTE1-66: WTO-NACHRICHTENZEILE
*      BYTE67-68: X'0000', WENN NACHRICHTENZEILE VERFUEGBAR
*
         SPACE 1
         DS    0F
MSGTAB   DS    10CL68        TABELLE FUER NACHRICHTEN
ENDTAB1  EQU   *
HEADER   DS    CL68          UEBERSCHRIFTEN-ZEILE
WTOR     DS    15F           BEREICH FUER WTOR-NACHRICHT
         SPACE 1
ABERL    EQU   *-ABER        LAENGE DER ARBEITSBEREICHE
         EJECT
***********************************************************************
*                                                                     *
*      DEFINITIONEN FUER EINE NACHRICHTENZEILE.                       *
*                                                                     *
***********************************************************************
         SPACE 3
MESSAGE  DSECT
         ORG   MESSAGE+4
MSGVOLID DS    CL6           VOLUME SERIAL NUMBER
         DS    CL1
MSGADR   DS    CL3           UNIT ADDRESS
         DS    CL1
MSGLINE  DS    CL3           ON-/OFF-LINE
         DS    CL1
MSGMOUNT DS    CL1           UNIT MOUNTED
         DS    CL1
MSGALLOC DS    CL1           UNIT ALLOC
         DS    CL1
MSGREADY DS    CL1           UNIT READY
         DS    CL1
MSGATTR1 DS    CL7           ATTRIBUTES
         ORG   *-3
MSGATTR2 DS    CL3           ATTRIBUTES
         DS    CL1
MSGUCBAD DS    CL8           UCB ADDRESS
         DS    CL1
MSGNU    DS    CL2       NO OF USERS
         DS    CL1
MSGND    DS    CL2       NO OF OPEN DCBS
         DS    CL1
MSGNR    DS    CL2       NO OF RESERVE-MACROS
         DS    CL1
MSGCPA   DS    CL3       CHANNEL PROGRAMM ACTIVE
         DS    CL1
MSGBSY   DS    CL3      UNIT BUSY
         DS    CL1
MSGRSV   DS    CL3      UNIT RESERVED
         DS    CL1
MSGCNT   DS    CL3      NO OF QUEUED REQUESTS
         DS    CL2
MSGFLAG  DS    CL2           FLAG BYTES
         EJECT
***********************************************************************
*                                                                     *
*      UCB-DEFINITIONEN.                                              *
*                                                                     *
***********************************************************************
         SPACE 2
UCB      DSECT
UCBJBNR  DS    CL1           FLAG BYTE
UCBFL5   DS    CL1           FLAG BYTE
         DS    CL1
UCBSTAT  DS    CL1           DEVICE STATUS
         DS    CL2
UCBSFLS  DS    CL2           DEVICE STATUS FLAGS
UCBCHM   DS    CL1           PATH STATUS MASK
         DS    CL4
UCBNAME  DS    CL3           UNIT NAME
         DS    CL1
UCBTBYT2 DS    CL1           OPTION FLAGS
UCBDVCLS DS    CL1           DEVICE CLASS
         DS    CL9
UCBVOLI  DS    CL6           VOLUME SERIAL NUMBER
UCBSTAB  DS    C             VOLUME STATUS
UCBDMCT  DS    C             VOLUME USE BYTE
         SPACE 3
***********************************************************************
*                                                                     *
*      PARAMETERBEREICH.                                              *
*                                                                     *
***********************************************************************
         SPACE 2
         XPARM
PARMENDE EQU   *
         END   DVOL
./ ADD NAME=DYNALC
         TITLE 'DYNALC                           DYNAMIC ALLOCATION'
DYNALC   CSECT
         SPACE 3
***********************************************************************
*                                                                     *
*      IDENTIFICATION DIVISION.                                       *
*                                                                     *
*      PROGRAM-ID. DYNALC.                                            *
*      AUTHOR. EHNERT.                                                *
*      INSTALLATION. BAYER AG, LEVERKUSEN, RECHENZENTRUM.             *
*      DATE-WRITTEN. 17. 12. 1974.                                    *
*      REMARKS.                                                       *
*          DAS PROGRAMM 'DYNALC' DIENT ALS ALLGEMEINES UNTERPROGRAMM  *
*          DER DYNAMIC ALLOCATION.                                    *
*                                                                     *
*          IN REGISTER 1 WIRD DIE ADRESSE EINES PARAMETERBEREICHS MIT *
*          FOLGENDEM AUFBAU ERWARTET:                                 *
*                                                                     *
*          01) ADRESSE EINES DREI-VOLLWORT-BEREICHS, IN DEN           *
*              A)  DER RUECKKEHRCODE DES DYNALLOC-MACROS,             *
*              B)  DER ERROR REASON CODE UND                          *
*              C)  DER INFORMATION REASON CODE DES DYNALLOC-MACROS    *
*              GESPEICHERT WERDEN                                     *
*              (BEDEUTUNG DER CODES: SIEHE 'OS/VS2 SYSTEM PROGRAMMING *
*              LIBRARY: JOB MANAGEMENT, SUPERVISOR, AND TSO',         *
*              APPENDIX A),                                           *
*          02) ADRESSE EINES 8-BYTE-FELDES FUER DEN DYNALLOC-TYP,     *
*              A)  'DSALLOC': DATA SET NAME ALLOCATION,               *
*              B)  'UNALLOC': DYNAMIC UNALLOCATION,                   *
*              C)  'CONCAT': DYNAMIC CONCATENATION,                   *
*              D)  'DECONCAT': DYNAMIC DECONCATENATION,               *
*              E)  'REMOVE': REMOVAL OF THE IN-USE ATTRIBUTE,         *
*              F)  'DDALLOC': DDNAME ALLOCATION,                      *
*              G)  'RETRIEVE': DYNAMIC INFORMATION RETRIEVAL,         *
*          03) ADRESSE EINES 8-BTYE-FELDES FUER DEN DDNAME,           *
*          04) ADRESSE EINES 44-BYTE-FELDES FUER DEN DSNAME,          *
*          05) ADRESSE EINES 8-BYTE-FELDES FUER DEN MEMBERNAMEN       *
*              EINER PO-ORGANISIERTEN DATEI,                          *
*          06) ADRESSE EINES DREI-BYTE-FELDES FUER DEN STATUS DER     *
*              DATEI (SHR, NEW, MOD, OLD, DEFAULT: NEW),              *
*          07) ADRESSE EINES 7-BYTE-FELDES FUER DIE NORM. DISPOSITION *
*              (KEEP, DELETE, CATLG, UNCATLG, DEFAULT: DELETE),       *
*          08) ADRESSE EINES 7-BYTE-FELDES FUER DIE COND. DISPOSITION *
*              (KEEP, DELETE, CATLG, UNCATLG, DEFAULT: DELETE),       *
*          09) ADRESSE EINES DREI-BYTE-FELDES FUER DEN SPACE TYPE     *
*              ('CYL', 'TRK' ODER BLOCKGROESSE (BINAER GESPEICHERT)), *
*          10) ADRESSE EINES DREI-BYTE-FELDES FUER DIE PRIMARY SPACE  *
*              QUANTITY (BINAER GESPEICHERT),                         *
*          11) ADRESSE EINES 3-BYTE-FELDES FUER DIE SECONDARY SPACE   *
*              QUANTITY (BINAER GESPEICHERT),                         *
*          12) ADRESSE EINES 3-BYTE-FELDES FUER DIE DIRECTORY BLOCK   *
*              QUANTITY (BINAER GESPEICHERT),                         *
         EJECT
*          13) ADRESSE EINES 4-BYTE-FELDES, DAS 'RLSE' ENTHAELT, WENN *
*              UNGENUTZTER SPEICHERPLATZ FREIGEGEBEN WERDEN SOLL,     *
*          14) ADRESSE EINES 6-BYTE-FELDES FUER DAS FORMAT DES ALLO-  *
*              KIERTEN SPEICHERPLATZES (CONTIG, MXIG, ALX),           *
*          15) ADRESSE EINES 5-BYTE-FELDES, DAS 'ROUND' ENTHAELT,     *
*              FALLS GANZE ZYLINDER ALLOKIERT WERDEN SOLLEN,          *
*          16) ADRESSE EINES 6-BYTE-FELDES FUER DIE VOLSER NUMBER,    *
*          17) ADRESSE EINES 7-BYTE-FELDES, DAS 'PRIVATE' ENTHAELT,   *
*              FALLS DER DATENTRAEGER PRIVAT IST,                     *
*          18) ADRESSE EINES 2-BYTE-FELDES FUER DIE VOLUME SEQUENCE   *
*              NUMBER (BINAER GESPEICHERT),                           *
*          19) ADRESSE EINES EIN-BYTE-FELDES FUER DEN VOLUME COUNT    *
*              (BINAER GESPEICHERT),                                  *
*          20) ADRESSE EINES 8-BYTE-FELDES FUER DIE VOLUME REFERENCE, *
*          21) ADRESSE EINES 8-BYTE-FELDES FUER DEN DEVICE TYPE,      *
*          22) ADRESSE EINES EIN-BYTE-FELDES FUER DEN UNIT COUNT      *
*              (BINAER GESPEICHERT).                                  *
*                                                                     *
*          SOLLEN PARAMETER AUSGELASSEN ODER DEFAULT-WERTE ANGENOMMEN *
*          WERDEN, SO IST DIE ENTSPRECHENDE ADRESSE AUF NULL ZU       *
*          SETZEN. DIE ADRESSE DES LETZTEN PARAMETERS MUSS DURCH      *
*          SETZEN DES ERSTEN BITS ALS LEZTE PARAMETERADRESSE SPEZIFI- *
*          ZIERT WERDEN.                                              *
*                                                                     *
*          DIE DYNAMIC UNALLOCATION AT CLOSE WIRD STANDARDMAESSIG     *
*          BEI DER DATA SET NAME ALLOCATION IMMER DURCHGEFUEHRT.      *
*                                                                     *
***********************************************************************
         EJECT
***********************************************************************
*                                                                     *
*      BEGINN DER VERARBEITUNG.                                       *
*                                                                     *
***********************************************************************
         SPACE 3
*
*      SICHERN DER REGISTER,
*      SPEICHERPLATZANFORDERUNG FUER DEN ARBEITSBEREICH UND
*      ZUORDNUNG DER BASISREGISTER.
*
         SPACE 1
         XSAVE R12,,DYNALC,ABERL
         SPACE 1
         USING DYNALC,R12    BASISREG. FUER CSECT DYNALC ZUORDNEN
         USING ABER,R13      BASISREG. FUER DSECT ABER ZUORDNEN
         LR    R11,R1        ADRESSE DES PARAMETERBEREICHS SICHERN
         EJECT
*
*      INITIALISIERUNG DES PARAMETERBEREICHS FUER DYNALLOC-MACRO.
*
         SPACE 1
         MVC   RQBLK(20),S99RB   REQUEST BLOCK UEBERTRAGEN
         LA    R2,RQBLK      ADRESSE DES REQUEST BLOCKS LADEN
         ST    R2,RQBLKPTR       UND SICHERN
         OI    RQBLKPTR,X'80' LETZTEN PARAMETER SPEZIFIZIEREN
         LA    R2,TEXTPTR    ADRESSE DER TEXT POINTER LADEN
         ST    R2,RQTXTPTR       UND SICHERN
         LA    R4,TEXTUNIT   ADRESSEN DER
         LA    R6,S99TUNIT       TEXT UNITS LADEN
         LA    R5,S99TULEN   LAENGE DER TEXT UNITS LADEN
         LR    R7,R5         LAENGE DER TEXT UNITS LADEN
         MVCL  R4,R6         TEXT UNITS UEBERTRAGEN
         EJECT
***********************************************************************
*                                                                     *
*      VERARBEITUNG DER EINGABEPARAMETER.                             *
*                                                                     *
***********************************************************************
         SPACE 3
         LA    R4,0          R4 LOESCHEN
         LR    R2,R1         ADRESSE DES PARAMETERBEREICHS UMLADEN
         LA    R3,TEXTPTR-4  ADRESSE DER TEXT POINTER LADEN
         SPACE 2
*
*      GET DYNALLOC TYPE.
*
         SPACE 1
         TM    0(R2),X'80'   LETZTER PARAMETER ERREICHT ?
         BO    ENDPARM       JA, VERZWEIGEN
         LA    R2,4(R2)      R2 ERHOEHEN
         ICM   R4,7,1(R2)    ADRESSE DES DYNALLOC-TYPS LADEN
         BZ    GETDDNAM      VERZW., WENN ADRESSE = 0
         BAL   R14,CLCTYPE   VERZW. ZUR TYPPRUEFUNG
         MVC   RQVERB,0(R9)  VERB CODE UEBERTRAGEN
         EJECT
*
*      GET DDNAME.
*
         SPACE 1
GETDDNAM EQU   *
         LA    R10,ENDPARM   RUECKSPRUNGADRESSE LADEN
         LA    R15,NXTPTR    RUECKSPRUNGADRESSE LADEN
         LA    R5,WKTU0001   ADRESSE DER TEXT UNIT LADEN
         BAL   R14,GETPARM   VERZW. ZUR PARAMETERPRUEFUNG
         LTR   R4,R4         PARAMETERADRESSE = 0 ?
         BZ    RETDDNAM      JA, VERZWEIGEN
         MVC   DDNAME,0(R4)  NEIN, DDNAME UEBERTRAGEN
         CLI   DDNAME,C' '   DDNAME ANGEGEBEN ?
         BE    RETDDNAM      NEIN, VERZWEIGEN
         B     GETDSNAM      JA, VERZWEIGEN
         SPACE 2
*
*      RETURN DDNAME.
*
         SPACE 1
RETDDNAM EQU   *
         LA    R5,WKTU0055   ADRESSE DER TEXT UNIT LADEN
         ST    R5,0(R3)          UND ALS TEXT POINTER SPEICHERN
         SPACE 2
*
*      GET DATA SET NAME.
*
         SPACE 1
GETDSNAM EQU   *
         LA    R15,GETMEMBN  RUECKSPRUNGADRESSE LADEN
         LA    R5,WKTU0002   ADRESSE DER TEXT UNIT LADEN
         BAL   R14,GETPARM   VERZW. ZUR PARAMETERPRUEFUNG
         MVC   DSNAME,0(R4)  DSNAME UEBERTRAGEN
         SPACE 2
*
*      GET MEMBER NAME.
*
         SPACE 1
GETMEMBN EQU   *
         LA    R15,GETSTAT   RUECKSPRUNGADRESSE LADEN
         LA    R5,WKTU0003   ADRESSE DER TEXT UNIT LADEN
         BAL   R14,GETPARM   VERZW. ZUR PARAMETERPRUEFUNG
         MVC   MEMBNAME,0(R4) MEMBERAME UEBERTRAGEN
         EJECT
*
*      GET DATA SET STATUS.
*
         SPACE 1
GETSTAT  EQU   *
         LA    R15,NXTPTR    RUECKSPRUNGADRESSE LADEN
         LA    R5,WKTU0004   ADRESSE DER TEXT UNIT LADEN
         BAL   R14,GETPARM   VERZW. ZUR PARAMETERPRUEFUNG
         LTR   R4,R4         PARAMETERADRESSE = 0 ?
         BZ    GETNDISP      JA, VERZWEIGEN
         BAL   R14,CLCSTAT   VERZW. ZUR STATUSPRUEFUNG
         MVC   STATUS,0(R9)  STATUS BYTE SETZEN
         SPACE 2
*
*      GET DATA SET NORMAL DISPOSITION
*
         SPACE 1
GETNDISP EQU   *
         LA    R5,WKTU0005   ADRESSE DER TEXT UNIT LADEN
         BAL   R14,GETPARM   VERZW. ZUR PARAMETERPRUEFUNG
         LTR   R4,R4         PARAMETERADRESSE = 0 ?
         BZ    GETCDISP      JA, VERZWEIGEN
         BAL   R14,CLCDISP   VERZW.ZUR DISPOSITIONPRUEFUNG
         MVC   NDISP,0(R9)   NORM. DISP. BYTE SETZEN
         SPACE 2
*
*      GET DATA SET CONDITIONAL DISPOSITION.
*
         SPACE 1
GETCDISP EQU   *
         LA    R5,WKTU0006   ADRESSE DER TEXT UNIT LADEN
         BAL   R14,GETPARM   VERZW. ZUR PARAMETERPRUEFUNG
         LTR   R4,R4         PARAMETERADRESSE = 0 ?
         BZ    GETSPTYP      JA, VERZWEIGEN
         BAL   R14,CLCDISP   VERZW.ZUR DISPOSITIONPRUEFUNG
         MVC   CDISP,0(R9)   COND. DISP. BYTE SETZEN
         EJECT
*
*      GET SPACE TYPE.
*
         SPACE 1
GETSPTYP EQU   *
         LA    R15,GETPRMSP  RUECKSPRUNGADRESSE LADEN
         LA    R5,WKTU0009   ADRESSE DER TEXT UNIT LADEN
         BAL   R14,GETPARM   VERZW. ZUR PARAMETERPRUEFUNG
         CLC   0(3,R4),=C'TRK' SPACE TYPE = TRK ?
         BNE   *+16          NEIN, VERZWEIGEN
         LA    R5,WKTU0007   ADRESSE DER TEXT UNIT LADEN
         ST    R5,0(R3)      TEXT POINTER SPEICHERN
         B     GETPRMSP      VERZWEIGEN
         CLC   0(3,R4),=C'CYL' SPACE TYPE = CYL ?
         BNE   *+16          NEIN, VERZWEIGEN
         LA    R5,WKTU0008   ADRESSE DER TEXT UNIT LADEN
         ST    R5,0(R3)      TEXT POINTER SPEICHERN
         B     GETPRMSP      VERZWEIGEN
         MVC   BLKSPACE,0(R4) BLOCKGROESSE UEBERTRAGEN
         SPACE 2
*
*      GET PRIMARY SPACE QUANTITY.
*
         SPACE 1
GETPRMSP EQU   *
         LA    R15,GETSECSP  RUECKSPRUNGADRESSE LADEN
         LA    R5,WKTU000A   ADRESSE DER TEXT UNIT LADEN
         BAL   R14,GETPARM   VERZW. ZUR PARAMETERPRUEFUNG
         MVC   PRMSPACE,0(R4) PRIMARY SPACE QUANTITY UEBERTRAGEN
         SPACE 2
*
*      GET SECONDARY SPACE QUANTITY.
*
         SPACE 1
GETSECSP EQU   *
         LA    R15,GETDIBLK  RUECKSPRUNGADRESSE LADEN
         LA    R5,WKTU000B   ADRESSE DER TEXT UNIT LADEN
         BAL   R14,GETPARM   VERZW. ZUR PARAMETERPRUEFUNG
         MVC   SECSPACE,0(R4) SECONDARY SPACE QUANTITY UEBERTRAGEN
         SPACE 2
*                                                                     *
*      GET DIRECTORY BLOCK QUANTITY.
*
         SPACE 1
GETDIBLK EQU   *
         LA    R15,GETRLSE   RUECKSPRUNGADRESSE LADEN
         LA    R5,WKTU000C   ADRESSE DER TEXT UNIT LADEN
         BAL   R14,GETPARM   VERZW. ZUR PARAMETERPRUEFUNG
         MVC   DIRBLOCK,0(R4) DIRECTORY BLOCK QUANTITY UEBERTRAGEN
         EJECT
*
*      GET UNUSED SPACE RELEASE SPECIFICATION.
*
         SPACE 1
GETRLSE  EQU   *
         LA    R15,GETFALSP  RUECKSPRUNGADRESSE LADEN
         LA    R5,WKTU000D   ADRESSE DER TEXT UNIT LADEN
         BAL   R14,GETPARM   VERZW. ZUR PARAMETERPRUEFUNG
         CLC   0(4,R4),=C'RLSE' PARAMETER GUELTIG ?
         BER   R15           JA, VERZWEIGEN
         MVI   3(R5),X'FF'   NEIN, TEXT UNIT UNGUELTIG SETZEN
         SPACE 2
*
*      GET FORMAT OF ALLOCATED SPACE.
*
         SPACE 1
GETFALSP EQU   *
         LA    R15,GETROUND  RUECKSPRUNGADRESSE LADEN
         LA    R5,WKTU000E   ADRESSE DER TEXT UNIT LADEN
         BAL   R14,GETPARM   VERZW. ZUR PARAMETERPRUEFUNG
         BAL   R14,CLCFALSP  VERZW. ZUR FORMATPRUEFUNG
         MVC   FORMALSP,0(R9) FORMAT OF ALLOCATED SPACE BYTE SETZEN
         SPACE 2
*
*      GET WHOLE CYLINDER ALLOCATION SPECIFICATION.
*
         SPACE 1
GETROUND EQU   *
         LA    R15,GETVOLI   RUECKSPRUNGADRESSE LADEN
         LA    R5,WKTU000F   ADRESSE DER TEXT UNIT LADEN
         BAL   R14,GETPARM   VERZW. ZUR PARAMETERPRUEFUNG
         CLC   0(5,R4),=C'ROUND' PARAMETER GUELTIG ?
         BER   R15           JA, VERZWEIGEN
         MVI   3(R5),X'FF'   NEIN, TEXT UNIT UNGUELTIG SETZEN
         EJECT
*
*      GET VOLUME SERIAL NUMBER.
*
         SPACE 1
GETVOLI  EQU   *
         LA    R15,GETPVSP   RUECKSPRUNGADRESSE LADEN
         LA    R5,WKTU0010   ADRESSE DER TEXT UNIT LADEN
         BAL   R14,GETPARM   VERZW. ZUR PARAMETERPRUEFUNG
         MVC   VOLSERNO,0(R4) VOLSER NUMBER UEBERTRAGEN
         SPACE 2
*
*      GET PRIVATE VOLUME SPECIFICATION.
*
         SPACE 1
GETPVSP  EQU   *
         LA    R15,GETVOLSQ  RUECKSPRUNGADRESSE LADEN
         LA    R5,WKTU0011   ADRESSE DER TEXT UNIT LADEN
         BAL   R14,GETPARM   VERZW. ZUR PARAMETERPRUEFUNG
         CLC   0(7,R4),=C'PRIVATE' PARAMETER GUELTIG ?
         BER   R15           JA, VERZWEIGEN
         MVI   3(R5),X'FF'   NEIN, TEXT UNIT UNGUELTIG SETZEN
         SPACE 2
*
*      GET VOLUME SEQUENCE NUMBER.
*
         SPACE 1
GETVOLSQ EQU   *
         LA    R15,GETVOLCT  RUECKSPRUNGADRESSE LADEN
         LA    R5,WKTU0012   ADRESSE DER TEXT UNIT LADEN
         BAL   R14,GETPARM   VERZW. ZUR PARAMETERPRUEFUNG
         MVC   VOLSEQNO,0(R4) VOLUME SEQUENCE NUMBER UEBERTRAGEN
         SPACE 2
*
*      GET VOLUME COUNT.
*
         SPACE 1
GETVOLCT EQU   *
         LA    R15,GETVOLRF  RUECKSPRUNGADRESSE LADEN
         LA    R5,WKTU0013   ADRESSE DER TEXT UNIT LADEN
         BAL   R14,GETPARM   VERZW. ZUR PARAMETERPRUEFUNG
         MVC   VOLCOUNT,0(R4) VOLUME COUNT UEBERTRAGEN
         EJECT
*
*      GET VOLUME REFERENCE TO A DATA SET NAME.
*
         SPACE 1
GETVOLRF EQU   *
         LA    R15,GETUNDCP  RUECKSPRUNGADRESSE LADEN
         LA    R5,WKTU0014   ADRESSE DER TEXT UNIT LADEN
         BAL   R14,GETPARM   VERZW. ZUR PARAMETERPRUEFUNG
         MVC   VOLREF,0(R4)  VOLUME REFERENCE UEBERTRAGEN
         SPACE 2
*
*      GET UNIT DESCRIPTION.
*
         SPACE 1
GETUNDCP EQU   *
         LA    R15,GETUNCT   RUECKSPRUNGADRESSE LADEN
         LA    R5,WKTU0015   ADRESSE DER TEXT UNIT LADEN
         BAL   R14,GETPARM   VERZW. ZUR PARAMETERPRUEFUNG
         MVC   UNIT,0(R4)    UNIT DESCRIPTION UEBERTRAGEN
         SPACE 2
*
*      GET UNIT COUNT.
*
         SPACE 1
GETUNCT  EQU   *
         LA    R15,GETPLMNT  RUECKSPRUNGADRESSE LADEN
         LA    R5,WKTU0016   ADRESSE DER TEXT UNIT LADEN
         BAL   R14,GETPARM   VERZW. ZUR PARAMETERPRUEFUNG
         MVC   UNITCNT,0(R4) UNIT COUNT UEBERTRAGEN
         SPACE 2
GETPLMNT EQU   *
         B     ENDPARM       VERZW. ZUM ENDE DER PARAMETERVERARBEITUNG
         EJECT
***********************************************************************
*                                                                     *
*      ENDE DER PARAMETERVERARBEITUNG.                                *
*                                                                     *
***********************************************************************
         SPACE 3
ENDPARM  EQU   *
         LA    R3,4(R3)      R3 ERHOEHEN
         LA    R5,0          R5 LOESCHEN
         ST    R5,0(R3)      TEXT POINTER SPEICHERN
         OI    0(R3),X'80'   ENDE DER TEXT POINTER SPEZIFIZIEREN
         CLI   RQVERB,X'01' DATA SET NAME ALLOCATION ?
         BNE   DYNALLOC      NEIN, VERZWEIGEN
         LA    R5,WKTU001C   ADRESSE DER TEXT UNIT (UNALLOCATION AT
         ST    R5,0(R3)          CLOSE) LADEN UND SPEICHERN
         OI    0(R3),X'80'   ENDE DER TEXT POINTER SPEZIFIZIEREN
         EJECT
***********************************************************************
*                                                                     *
*      DYNAMIC ALLOCATION.                                            *
*                                                                     *
***********************************************************************
         SPACE 3
DYNALLOC EQU   *
         LA    R1,RQBLKPTR   ADRESSE DES RQBLK POINTERS LADEN
         DYNALLOC
         SPACE 1
         L     R2,8(R11)     ADRESSE DES DDNAME LADEN
         LA    R2,0(R2)      ERSTES BYTE IN R2 LOESCHEN
         LTR   R2,R2         ADRESSE DES DDNAME SPEZIFIZIERT ?
         BZ    MVCDDNAM+6    NEIN, VERZWEIGEN
         L     R3,TEXTPTR    TEXT POINTER LADEN
         LA    R4,WKTU0055   ADRESSE DER TEXT UNIT LADEN
         CR    R3,R4         TEXT POINTER = ADR.DER TEXT UNIT WKTU0055?
         BNE   LHRC          NEIN, VERZWEIGEN
         IC    R3,DDNLRET    LAENGE LADEN
         S     R3,=F'1'      R3 VERMINDERN
         EX    R3,MVCDDNAM   VERZW. ZUR UEBERGABE DES DDNAME
LHRC     EQU   *
         LH    R0,RQEC       ERROR REASON CODE LADEN
         LH    R1,RQIC       INFORMATION REASON CODE LADEN
         LA    R10,0         R10 LOESCHEN
         ICM   R10,7,1(R11)  ADRESSE DES RC-BEREICHS LADEN
         BZ    ABSCHLUS      VERZW., WENN ADRESSE = 0
         STM   R15,R1,0(R10) RETURN CODES SPEICHERN
         EJECT
***********************************************************************
*                                                                     *
*      ABSCHLUSSROUTINE.                                              *
*                                                                     *
***********************************************************************
         SPACE 3
ABSCHLUS EQU   *
         XRETURN ,R
         EJECT
***********************************************************************
*                                                                     *
*      PRUEFUNG DER EINZELPARAMETER.                                  *
*                                                                     *
***********************************************************************
         SPACE 3
GETPARM  EQU   *
         TM    0(R2),X'80'   LETZTER PARAMETER ERREICHT ?
         BOR   R10           JA, VERZWEIGEN
         LA    R2,4(R2)      R2 ERHOEHEN
         ICM   R4,7,1(R2)    ADRESSE DES NAECHSTEN PARAMETERS LADEN
         BZR   R15           VERZW., WENN ADRESSE = 0
NXTPTR   EQU   *
         LA    R3,4(R3)      R3 ERHOEHEN
         ST    R5,0(R3)      TEXT POINTER SPEICHERN
         BR    R14           VERZWEIGEN
         EJECT
***********************************************************************
*                                                                     *
*      DURCHLAUFEN DER TABELLEN.                                      *
*                                                                     *
***********************************************************************
         SPACE 3
*
*      DURCHLAUFEN DER STATUS-TABELLE.
*
         SPACE 1
CLCSTAT  EQU   *
         LA    R9,TABSTAT-4  ADRESSE DER STATUS-TABELLE LADEN
NXTSTAT  EQU   *
         LA    R9,4(R9)      R9 ERHOEHEN
         CLI   0(R9),X'FF'   TABELLENENDE ERREICHT ?
         BER   R14           JA, VERZWEIGEN
         CLC   1(3,R9),0(R4) VORGEGEBENER STATUS GEFUNDEN ?
         BNE   NXTSTAT       NEIN, VERZWEIGEN
         BR    R14           JA, VERZWEIGEN
         SPACE 2
*
*      DURCHLAUFEN DER DISPOSITION-TABELLE.
*
         SPACE 1
CLCDISP  EQU   *
         LA    R9,TABDISP-8  ADRESSE DER DISPOSITION-TABELLE LADEN
NXTDISP  EQU   *
         LA    R9,8(R9)      R9 ERHOEHEN
         CLI   0(R9),X'FF'   TABELLENENDE ERREICHT ?
         BER   R14           JA, VERZWEIGEN
         CLC   1(7,R9),0(R4) VORGEGEBENE DISPOSITION GEFUNDEN ?
         BNE   NXTDISP       NEIN, VERZWEIGEN
         BR    R14           JA, VERZWEIGEN
         SPACE 2
*
*      DURCHLAUFEN DER FORMAT-TABELLE.
*
         SPACE 1
CLCFALSP EQU   *
         LA    R9,TABFALSP-7 ADRESSE DER FORMAT-TABELLE LADEN
NXTFALSP EQU   *
         LA    R9,7(R9)      R9 ERHOEHEN
         CLI   0(R9),X'FF'   TABELLENENDE ERREICHT ?
         BER   R14           JA, VERZWEIGEN
         CLC   1(6,R9),0(R4) VORGEGEBENES FORMAT GEFUNDEN ?
         BNE   NXTFALSP      NEIN, VERZWEIGEN
         BR    R14           JA, VERZWEIGEN
         EJECT
*
*      DURCHLAUFEN DER TYP-TABELLE FUER DYNALLOC-TYP.
*
         SPACE 1
CLCTYPE  EQU   *
         LA    R9,TABTYPE-9  ADRESSE DER TYP-TABELLE LADEN
NXTTYPE  EQU   *
         LA    R9,9(R9)      R9 ERHOEHEN
         CLI   0(R9),X'FF'   TABELLENENDE ERREICHT ?
         BER   R14           JA, VERZWEIGEN
         CLC   1(8,R9),0(R4) VORGEGEBENER DYNALLOC-TYP GEFUNDEN ?
         BNE   NXTTYPE       NEIN, VERZWEIGEN
         BR    R14           JA, VERZWEIGEN
         EJECT
***********************************************************************
*                                                                     *
*      BEFEHLE, DIE MIT HILFE DES EXECUTE-BEFEHLS AUSGEFUEHRT WERDEN. *
*                                                                     *
***********************************************************************
         SPACE 3
MVCDDNAM EQU   *
         MVC   0(0,R2),DDNAMRET DDNAME UEBERGEBEN
         SPACE 3
***********************************************************************
*                                                                     *
*      REGISTER EQUATES.                                              *
*                                                                     *
***********************************************************************
         SPACE 3
R0       EQU   0             MACRO- UND PARAMETER-REGISTER
R1       EQU   1             MACRO- UND PARAMETER-REGISTER
R2       EQU   2             POINTER AUF ADRESSE DES LFD. PARAMETERS
R3       EQU   3             POINTER AUF TEXT POINTER
R4       EQU   4             POINTER AUF LAUFENDEN PARAMETER
R5       EQU   5             POINTER AUF TEXT UNIT
R6       EQU   6
R7       EQU   7
R8       EQU   8
R9       EQU   9             POINTER IN TABELLEN
R10      EQU   10            RUECKSPRUNGADRESSE BEI LETZTEM PARAMETER
R11      EQU   11            POINTER AUF PARAMETER-BEREICH
R12      EQU   12            BASISREG. FUER CSECT DYNALC
R13      EQU   13            BASISREG. FUER DSECT ABER
R14      EQU   14            RUECKSPRUNGADRESSEN
R15      EQU   15            RUECKSPRUNGADRESSE BEI PARAMETERADRESSE =0
         EJECT
***********************************************************************
*                                                                     *
*      DEFINITION DER KONSTANTEN-SPEICHER.                            *
*                                                                     *
***********************************************************************
         SPACE 3
*
*      STATUS-TABELLE.
*
         SPACE 1
TABSTAT  EQU   *
         DC    X'08',C'SHR'
         DC    X'04',C'NEW'
         DC    X'02',C'MOD'
         DC    X'01',C'OLD'
         DC    X'FF',CL3' '  TABELLENENDE
         SPACE 2
*
*      DISPOSITION-TABELLE.
*
         SPACE 1
TABDISP  EQU   *
         DC    X'08',CL7'KEEP'
         DC    X'04',CL7'DELETE'
         DC    X'02',CL7'CATLG'
         DC    X'01',CL7'UNCATLG'
         DC    X'FF',CL7' '  TABELLENENDE
         SPACE 2
*
*      FORMAT-TABELLE (FUER ALLOCATED SPACE).
*
         SPACE 1
TABFALSP EQU   *
         DC    X'08',CL6'CONTIG'
         DC    X'04',CL6'MXIG'
         DC    X'02',CL6'ALX'
         DC    X'FF',CL6' '  TABELLENENDE
         EJECT
*
*      TYP-TABELLE FUER DYNALLOC-TYP.
*
         SPACE 1
TABTYPE  EQU   *
         DC    X'01',C'DSALLOC ' DATA SET NAME ALLOCATION
         DC    X'02',C'UNALLOC ' DYNAMIC UNALLOCATION
         DC    X'03',C'CONCAT  ' DYNAMIC CONCATENATION
         DC    X'04',C'DECONCAT' DYNAMIC DECONCATENATION
         DC    X'05',C'REMOVE  ' REMOVAL OF THE IN-USE ATTRIBUTE
         DC    X'06',C'DDALLOC ' DDNAME ALLOCATION
         DC    X'07',C'RETRIEVE' DYNAMIC INFORMATION RETRIEVAL
         DC    X'FF',CL8' '  TABELLENENDE
         SPACE 2
*
*      PARAMETERSTRUKTUR FUER DYNALLOC-MACRO (KONSTANTEN).
*
         SPACE 1
*S99RBPTR DC   X'80'         REQUEST BLOCK POINTER
*        DC    AL3(S99RB)    ADRESSE DES REQUEST BLOCK
         SPACE 1
S99RB    DS    5F            REQUEST BLOCK
         ORG   S99RB
S99RBLN  DC    AL1(20)       LAENGE DES REQUEST BLOCK
S99VERB  DC    X'01'         VERB CODE
S99FLAG1 DC    H'0'          FLAGS 1
S99ERROR DC    H'0'          ERROR REASON CODE
S99INFO  DC    H'0'          INFORMATION REASON CODE
S99TXTPP DC    A(0)          ADRESSE DER TEXT POINTER
         DC    F'0'          RESERVED
S99FLAG2 DC    F'0'          FLAGS 2
         EJECT
*
*      DATA SET NAME ALLOCATION TEXT UNITS (KONSTANTEN).
*
         SPACE 1
S99TUNIT EQU   *
TU0001   DC    X'00010001'   DDNAME SPECIFICATION
         DC    X'0008'
         DC    CL8' '
TU0002   DC    X'00020001'   DATA SET NAME SPECIFICATION
         DC    AL2(44)
         DC    CL44' '
TU0003   DC    X'00030001'   MEMBER NAME SPECIFICATION
         DC    X'0008'
         DC    CL8' '
TU0004   DC    X'00040001'   DATA SET STATUS SPECIFICATION
         DC    X'0001'
         DC    X'04'         DEFAULT: NEW
TU0005   DC    X'00050001'   DS NORMAL DISPOSITION SPECIFICATION
         DC    X'0001'
         DC    X'04'         DEFAULT: DELETE
TU0006   DC    X'00060001'   DS CONDITIONAL DISPOSITION SPECIFICATION
         DC    X'0001'
         DC    X'04'         DEFAULT: DELETE
TU0007   DC    X'00070000'   TRACK SPACE TYPE (TRK) SPECIFICATION
TU0008   DC    X'00080000'   CYLINDER SPACE TYPE (CYL) SPECIFICATION
TU0009   DC    X'00090001'   BLOCK SPACE TYPE SPECIFICATION
         DC    X'0003'
         DC    XL3'0'
TU000A   DC    X'000A0001'   PRIMARY SPACE QUANTITY SPECIFICATION
         DC    X'0003'
         DC    XL3'0'
TU000B   DC    X'000B0001'   SECONDARY SPACE QUANTITY SPECIFICATION
         DC    X'0003'
         DC    XL3'0'
TU000C   DC    X'000C0001'   DIRECTORY BLOCK SPECIFICATION
         DC    X'0003'
         DC    XL3'0'
TU000D   DC    X'000D0000'   UNUSED SPACE RELEASE (RLSE) SPECIFICATION
TU000E   DC    X'000E0001'   FORMAT OF ALLOCATED SPACE SPECIFICATION
         DC    X'0001'
         DC    X'00'
TU000F   DC    X'000F0000'   WHOLE CYLINDER ALLOCATION (ROUND) SPEC.
TU0010   DC    X'00100001'   VOLUME SERIAL SPECIFICATION
         DC    X'0006'
         DC    CL6' '
TU0011   DC    X'00110000'   PRIVATE VOLUME SPECIFICATION
TU0012   DC    X'00120001'   VOLUME SEQUENCE NUMBER SPECIFICATION
         DC    X'0002'
         DC    X'0000'
TU0013   DC    X'00130001'   VOLUME COUNT SPECIFICATION
         DC    X'0001'
         DC    X'00'
         EJECT
TU0014   DC    X'00140001'   VOLUME REFERENCE TO A DSNAME SPECIFICATION
         DC    X'0008'
         DC    CL8' '
TU0015   DC    X'00150001'   UNIT DESCRIPTION SPECIFICATION
         DC    X'0008'
         DC    CL8' '
TU0016   DC    X'00160001'   UNIT COUNT SPECIFICATION
         DC    X'0001'
         DC    X'00'
TU0017   DC    X'00170000'   PARALLEL MOUNT SPECIFICATION
TU0018   DC    X'00180001'   SYSOUT SPECIFICATION
         DC    X'0001'
         DC    X'00'
TU0019   DC    X'00190001'   SYSOUT PROGRAM NAME SPECIFICATION
         DC    X'0008'
         DC    CL8' '
TU001A   DC    X'001A0001'   SYSOUT FORM NUMBER SPECIFICATION
         DC    X'0004'
         DC    CL4' '
TU001B   DC    X'001B0001'   SYSOUT OUTPUT LIMIT SPECIFICATION
         DC    X'0003'
         DC    XL3'0'
TU001C   DC    X'001C0000'   UNALLOCATION AT CLOSE SPECIFICATION
TU001D   DC    X'001D0001'   SYSOUT COPIES SPECIFICATION
         DC    X'0001'
         DC    X'00'
TU0055   DC    X'00550001'   DDNAME RETURN SPECIFICATION
         DC    X'0008'
         DC    CL8' '
         SPACE 1
S99TULEN EQU   *-S99TUNIT    GESAMTLAENGE DER TEXT UNITS
         EJECT
***********************************************************************
*                                                                     *
*      DEFINITION DER ARBEITSBEREICHE.                                *
*                                                                     *
***********************************************************************
         SPACE 3
ABER     DSECT
SAVEAREA DS    18F           SAVEAREA FUER ALLGEMEINE REGISTER
TEXTPTR  DS    100F          TEXT POINTERS
         SPACE 2
*
*      PARAMETERSTRUKTUR FUER DYNALLOC-MACRO (ARBEITSBEREICH).
*
         SPACE 1
RQBLKPTR DS    F             REQUEST BLOCK POINTER
         SPACE 1
RQBLK    DS    5F            REQUEST BLOCK
         ORG   RQBLK
         DS    C
RQVERB   DS    CL1           VERB CODE
         DS    CL2
RQEC     DS    H             ERROR REASON CODE
RQIC     DS    H             INFORMATION REASON CODE
RQTXTPTR DS    F             ADRESSE DER TEXT POINTER
         DS    2F
         EJECT
*
*      DATA SET NAME ALLOCATION TEXT UNITS (ARBEITSBEREICH).
*
         SPACE 1
TEXTUNIT EQU   *
WKTU0001 DS    CL6           DDNAME SPECIFICATION
DDNAME   DS    CL8
WKTU0002 DS    CL6           DATA SET NAME SPECIFICATION
DSNAME   DS    CL44
WKTU0003 DS    CL6           MEMBER NAME SPECIFICATION
MEMBNAME DS    CL8
WKTU0004 DS    CL6           DATA SET STATUS SPECIFICATION
STATUS   DS    C
WKTU0005 DS    CL6           DS NORMAL DISPOSITION SPECIFICATION
NDISP    DS    C
WKTU0006 DS    CL6           DS CONDITIONAL DISPOSITION SPECIFICATION
CDISP    DS    C
WKTU0007 DS    CL4           TRACK SPACE TYPE (TRK) SPECIFICATION
WKTU0008 DS    CL4           CYLINDER SPACE TYPE (CYL) SPECIFICATION
WKTU0009 DS    CL6           BLOCK SPACE TYPE SPECIFICATION
BLKSPACE DS    CL3
WKTU000A DS    CL6           PRIMARY SPACE QUANTITY SPECIFICATION
PRMSPACE DS    CL3
WKTU000B DS    CL6           SECONDARY SPACE QUANTITY SPECIFICATION
SECSPACE DS    CL3
WKTU000C DS    CL6           DIRECTORY BLOCK SPECIFICATION
DIRBLOCK DS    CL3
WKTU000D DS    CL4           UNUSED SPACE RELEASE (RLSE) SPECIFICATION
WKTU000E DS    CL6           FORMAT OF ALLOCATED SPACE SPECIFICATION
FORMALSP DS    C
WKTU000F DS    CL4           WHOLE CYLINDER ALLOCATION (ROUND) SPEC.
WKTU0010 DS    CL6           VOLUME SERIAL SPECIFICATION
VOLSERNO DS    CL6
WKTU0011 DS    CL4           PRIVATE VOLUME SPECIFICATION
WKTU0012 DS    CL6           VOLUME SEQUENCE NUMBER SPECIFICATION
VOLSEQNO DS    CL2
WKTU0013 DS    CL6           VOLUME COUNT SPECIFICATION
VOLCOUNT DS    C
WKTU0014 DS    CL6           VOLUME REFERENCE TO A DSNAME SPECIFICATION
VOLREF   DS    CL8
         EJECT
WKTU0015 DS    CL6           UNIT DESCRIPTION SPECIFICATION
UNIT     DS    CL8
WKTU0016 DS    CL6           UNIT COUNT SPECIFICATION
UNITCNT  DS    C
WKTU0017 DS    CL4           PARALLEL MOUNT SPECIFICATION
WKTU0018 DS    CL6           SYSOUT SPECIFICATION
SOUTCLS  DS    C
WKTU0019 DS    CL6           SYSOUT PROGRAM NAME SPECIFICATION
SOUTNAME DS    CL8
WKTU001A DS    CL6           SYSOUT FORM NUMBER SPECIFICATION
SOUTFORM DS    CL4
WKTU001B DS    CL6           SYSOUT OUTPUT LIMIT SPECIFICATION
SOUTLIM  DS    CL3
WKTU001C DS    CL4           UNALLOCATION AT CLOSE SPECIFICATION
WKTU001D DS    CL6           SYSOUT COPIES SPECIFICATION
COPIES   DS    C
WKTU0055 DS    CL5           DDNAME RETURN SPECIFICATION
DDNLRET  DS    C             LAENGE DES DDNAME
DDNAMRET DS    CL8           DDNAME
         SPACE 1
ABERL    EQU   *-ABER        LAENGE DER ARBEITSBEREICHE
         EJECT
         END   DYNALC
./ ADD NAME=FIND
         TITLE 'XFIND                            X-COMMAND FIND'
FIND     CSECT
         SPACE 3
***********************************************************************
*                                                                     *
*      IDENTIFICATION DIVISION.                                       *
*                                                                     *
*      PROGRAM-ID. FIND.                                              *
*      AUTHOR. EHNERT.                                                *
*      INSTALLATION. BAYER AG, LEVERKUSEN, RECHENZENTRUM.             *
*      DATE-WRITTEN. 11. 12. 1974.                                    *
*      REMARKS.                                                       *
*                                                                     *
*          DAS X-COMMAND 'FIND' GIBT INFORMATIONEN UEBER DAS ALS      *
*          PARAMETER SPEZIFIZIERTE MITGLIED PO-ORGANISIERTER DATEIEN  *
*          AUS.                                                       *
*                                                                     *
*          ZUSAETZLICH KOENNEN BIS ZU ZEHN VOLUME-MASKEN ANGE-        *
*          GEBEN WERDEN, MIT DEREN HILFE EINE AUSWAHL DER VOLUMES GE- *
*          TROFFEN WIRD, DIE DAS X-COMMAND NACH DEM SPEZIFIZIERTEN    *
*          MEMBER DURCHSUCHT. DABEI STEHT '*' FUER JEDES ZEICHEN AN   *
*          DIESER STELLE. SIND KEINE MASKEN ANGEGEBEN, SO WERDEN      *
*          STANDARDMAESSIG ALLE ONLINE LIBRARYS DURCHSUCHT.           *
*                                                                     *
*          WIRD ZUDEM DER PARAMETER 'TEST' ANGEGEBEN, SO WERDEN ALLE  *
*          FEHLERNACHRICHTEN AUSGEGEBEN, DIE BEIM FEHLEN DES PARAME-  *
*          TERS STANDARDMAESSIG UNTERDRUECKT WERDEN.                  *
*                                                                     *
*          DURCH DIE ZUM AUFSUCHEN DES MEMBERS NOTWENDIGE DYNAMIC     *
*          ALLOCATION, DIE IM EXTERNEN UNTERPROGRAMM 'DYNALC' DURCH-  *
*          GEFUEHRT WIRD, KANN DAS X-COMMAND 'FIND' NUR IM SYSTEM     *
*          OS/VS2 (MVS) VERWNDET WERDEN.                              *
*                                                                     *
***********************************************************************
         EJECT
***********************************************************************
*                                                                     *
*      BEGINN DER VERARBEITUNG.                                       *
*                                                                     *
***********************************************************************
         SPACE 3
*
*      SICHERN DER REGISTER,
*      SPEICHERPLATZANFORDERUNG FUER ARBEITSBEREICHE,
*      ZUORDNUNG DER BASISREGISTER.
*
         SPACE 1
         XSAVE R12,,FIND,ABERL
         SPACE 1
         LR    R11,R1        BASISREG. FUER DSECT PARMAREA INITIALIS.
         USING UCB,R3        BASISREG. FUER DSECT UCB ZUORDNEN
         USING MESSAGE,R10   BASISREG. FUER DSECT MESSAGE ZUORDNEN
         USING PARMAREA,R11  BASISREG. FUER DSECT PARMAREA ZUORDNEN
         USING ABER,R13      BASISREG. FUER DSECT ABER ZUORDNEN
         EJECT
*
*      ABFRAGE DES SYSTEMS.
*
         SPACE 1
         MVC   UCMID,REG4
         L     R2,16         ADRESSE DER CVT LADEN
         TM    116(R2),X'01' SYSTEM = OS/VS2 (MVS) ?
         BZ    FEHLSYS       NEIN, VERZWEIGEN ZUR FEHLERROUTINE
*
*      INITIALISIERUNG DER SPEICHER.
*
         SPACE 1
         MVC   BLDLFF,=H'1'  ANZ. DER MEMBER ENTRIES FUER BLDL EINTR.
         MVC   BLDLLL,=H'14' ENTRY-LAENGE FUER BLDL EINTRAGEN
         MVI   FOUNDBIT,X'00' SCHALTER FUER GEFUNDENE MEMBER LOESCHEN
         MVI   TESTBYTE,X'00' SCHALTER FUER TEST LOESCHEN
         MVC   CAMOBT(CAMLEN),CAMCON CAMLIST-MACRO UEBERTRAGEN
         LA    R4,CCHHR      ADRESSE VON CCHHR LADEN
         ST    R4,CADRCCHH       UND SPEICHERN
         LA    R4,CAMWKFLD   ADRESSE VON CAMWKFLD LADEN
         ST    R4,CADRCAMW       UND SPEICHERN
         LA    R4,EIN        ADRESSE DES DCB LADEN
         ST    R4,DCBADDR        UND SPEICHERN
         MVI   DCBADDR,X'80' ENDE DER PARAMETERLISTE SPEZIFIZIEREN
         SPACE 2
*
*      PARAMETERLISTE FUER 'DYNALC' UEBERTRAGEN.
*
         SPACE 1
         LA    R4,DALPCON    ADRESSEN DER
         LA    R6,DALPWKS        PARAMETERLISTEN LADEN
         LA    R5,DALPLEN    LAENGE DER
         LR    R7,R5             PARAMETERLISTEN LADEN
         MVCL  R6,R4         PARAMETERLISTE UEBERTRAGEN
         LA    R4,RETCODE    ADRESSE DER RETURNCODE-BEREICHE LADEN
         LA    R5,DALTYPE    ADRESSE DES DYNALLOC-TYPS LADEN
         STM   R4,R5,ADDRRC  ADRESSEN IN DER PARAMETERLISTE SPEICHERN
         LA    R4,DALDDNAM   ADRESSE DES DDNAME LADEN
         ST    R4,ADDRDDN        UND SPEICHERN
         LA    R4,DALUNIT    ADRESSE DES EINHEITENTYPS LADEN
         STCM  R4,7,ADDRUNIT+1   UND SPEICHERN
         MVC   DALDDNAM,DCBDDNAM
         MVC   DALTYPE,=CL8'DSALLOC' DYNALLOC-TYP SPEZIFIZIEREN
         EJECT
*
*      ADRESSEN-SPEICHER INITIALISIEREN.
*
         SPACE 1
         LA    R3,ENDTAB1    ADRESSE DES TABELLENENDES LADEN
         LA    R4,ENDTPVOL   ADRESSE DES TABELLENENDES LADEN
         LA    R5,PARMENDE   ADRESSE DES ENDES DES PARAMETERBER. LADEN
         STM   R3,R5,ADDRETB1 ADRESSEN SPEICHERN
         SPACE 2
*
*      FLAG BYTS IN NACHRICHTENBEREICHEN SETZEN.
*
         SPACE 1
         LA    R10,TABNACHR  ADRESSE DER INFORMATIONSNACHRICHTEN-
         ST    R10,SAVE1R10      TABELLE LADEN UND SPEICHERN
         LA    R10,TABNACHR-72 ADRESSE DER NACHRICHTEN-TABELLEN LADEN
CLEARMSS EQU   *
         LA    R10,72(R10)   R10 ERHOEHEN
         C     R10,ADDRETB1  TABELLENENDE ERREICHT ?
         BNL   GETPARM       JA, VERZW. ZUR ABFRAGE DES SYSTEMS
         MVC   MESSFLAG,=X'FFFF' FLAG BYTES SETZEN
         B     CLEARMSS      VERZWEIGEN
         SPACE 2
         EJECT
***********************************************************************
*                                                                     *
*      VERARBEITUNG DER EINGABEPARAMETER.                             *
*                                                                     *
***********************************************************************
         SPACE 3
*
*      VERARBEITUNG DES MEMBER NAME.
*
         SPACE 1
GETPARM  EQU   *
         LA    R4,TEXT+4     R4 INITIALISIEREN
         SR    R5,R5         R5 LOESCHEN
         MVC   MEMBNAME,=CL8' ' ZWISCHENSPEICHER LOESCHEN
         CLI   0(R4),C','    PARAMETER ANGEGEBEN ?
         BNE   FEHLPARM      NEIN, VERZW. ZUR FEHLERROUTINE
NXTPNAM  EQU   *
         LA    R4,1(R4)      R4 ERHOEHEN
         C     R4,ADDREPRM   PARAMETERBEREICH UEBERSCHRITTEN ?
         BNL   FEHLPARM      JA, VERZW. ZUR FEHLERROUTINE
         CLI   0(R4),C'*'    1. PARAMETER = MEMBER NAME ?
         BE    FEHLPARM      NEIN, VERZW. ZUR FEHLERROUTINE
         CLI   0(R4),C','    ENDE DES MEMBER NAME ERREICHT ?
         BE    ENDPNAM       JA, VERZWEIGEN
         CLI   0(R4),X'00'   ENDE DER PARAMETERKETTE ERREICHT ?
         BE    ENDPNAM       JA, VERZWEIGEN
         CLI   0(R4),C' '    ENDE DER PARAMETERKETTE ERREICHT ?
         BE    ENDPNAM       JA, VERZWEIGEN
         LA    R5,1(R5)      R5 ERHOEHEN
         B     NXTPNAM       VERZWEIGEN
ENDPNAM  EQU   *
         C     R5,=F'8'      LAENGE DES MEMBER NAME GUELTIG ?
         BH    FEHLPARM      NEIN, VERZW. ZUR FEHLERROUTINE
         LTR   R5,R5         MEMBER NAME ANGEGEBEN ?
         BZ    FEHLPARM      NEIN, VERZW. ZUR FEHLERROUTINE
         BCTR  R5,0          R5 UM EINS VERMINDERN
         EX    R5,MOVEPNAM   VERZW. ZUR UEBERTR. DES MEMBER NAME
         CLI   MEMBNAME,C' ' MEMBER NAME GUELTIG ?
         BE    FEHLPARM      NEIN, VERZW. ZUR FEHLERROUTINE
         EJECT
*
*      VERARBEITUNG DER VOLUME SERIAL NUMBERS.
*
         SPACE 1
         LA    R6,TABPVOL1   ADRESSE DER VOLSER-TABELLE LADEN
NXTPVOLI EQU   *
         CLI   0(R4),X'00'   ENDE DER PARAMETERKETTE ERREICHT ?
         BE    ENDPARM       JA, VERZWEIGEN
         CLI   0(R4),C' '    ENDE DER PARAMETERKETTE ERREICHT ?
         BE    ENDPARM       JA, VERZWEIGEN
         SR    R5,R5         R5 LOESCHEN
         LR    R7,R4         ADRESSE UMLADEN
NXTPVOL  EQU   *
         LA    R4,1(R4)      R4 ERHOEHEN
         C     R4,ADDREPRM   PARAMETERBEREICH UEBERSCHRITTEN ?
         BNL   FEHLPARM      JA, VERZW. ZUR FEHLERROUTINE
         CLI   0(R4),C','    ENDE DER VOLID ERREICHT ?
         BE    ENDPVOL       JA, VERZWEIGEN
         CLI   0(R4),X'00'   ENDE DER PARAMETERKETTE ERREICHT ?
         BE    ENDPVOL       JA, VERZWEIGEN
         CLI   0(R4),C' '    ENDE DER PARAMETERKETTE ERREICHT ?
         BE    ENDPVOL       JA, VERZWEIGEN
         CLI   0(R4),C'*'    BELIEBIGES ZEICHEN AN DIESER STELLE ?
         BNE   *+8           NEIN, VERZWEIGEN
         MVI   0(R4),X'FF'   ZEICHEN UMSETZEN
         LA    R5,1(R5)      R5 ERHOEHEN
         B     NXTPVOL       VERZWEIGEN
ENDPVOL  EQU   *
         C     R5,=F'4'      LAENGE DES PARAMETERS = 4 ?
         BNE   *+22          NEIN, VERZWEIGEN
         CLC   1(4,R7),=C'TEST' PARAMETER = TEST ?
         BNE   *+12          NEIN, VERZWEIGEN
         MVI   TESTBYTE,X'FF' FLAG BYTE SETZEN
         B     NXTPVOLI      VERZWEIGEN
         C     R5,=F'6'      LAENGE DER VOLID GUELTIG ?
         BH    FEHLPARM      NEIN, VERZW. ZUR FEHLERROUTINE
         LTR   R5,R5         VOLID ANGEGEBEN ?
         BZ    ALLVOL        NEIN, VERZWEIGEN
         BCTR  R5,0          R5 UM EINS VERMINDERN
         EX    R5,MOVEPVOL   VERZW. ZUR UEBERTR. DER VOLSER NUMBER
         CH    R5,=H'5'
         BNE   NOMNT
         LA    R1,1(R6)
         CALL  MSSMNT,((R1)),VL
NOMNT    EQU   *
         STC   R5,0(R6)      LAENGENANGABE IN TABELLE EINTRAGEN
         LA    R6,7(R6)      R6 ERHOEHEN
         C     R6,ADDRETPV   ENDE DER VOLSER-TABELLE ERREICHT ?
         BNL   ENDPARM       JA, VERZWEIGEN
         B     NXTPVOLI      VERZWEIGEN
ALLVOL   EQU   *
         LA    R6,TABPVOL1   ADRESSE DER VOLSER-TABELLE LADEN
         EJECT
ENDPARM  EQU   *
         MVI   0(R6),X'80'   TABELLENENDE SPEZIFIZIEREN
         MVC   TABPVOL2,TABPVOL1 VOLSER-TABELLE KOPIEREN
         LA    R6,TABPVOL2-1 ADRESSE DER VOLSER-TABELLE LADEN
NXTBYTE  EQU   *
         LA    R6,1(R6)      R6 ERHOEHEN
         CLI   0(R6),X'80'   ENDE DER TABELLE ERREICHT ?
         BE    GETUCB        JA, VERZWEIGEN
         CLI   0(R6),X'FF'   ZEICHEN IN DER TABELLE = X'FF' ?
         BNE   NXTBYTE       NEIN, VERZWEIGEN
         MVI   0(R6),X'00'   ZEICHEN UMSETZEN
         B     NXTBYTE       VERZWEIGEN
         EJECT
***********************************************************************
*                                                                     *
*      VERARBEITUNG DES UCB-VEKTORS.                                  *
*                                                                     *
***********************************************************************
         SPACE 3
GETUCB   EQU   *
         DROP  R11           R11 FREIGEBEN
NEXTUCB  EQU   *
         UCBSCAN DEVTYPE=DASD,STATUS=ONLINE
         LTR   R15,R15
         BNZ   ABSCHLUS
         LR    R3,R1
         TM    DEVSTAT,X'10' EINHEIT IM UNLOAD ?
         BO    NEXTUCB       JA, VERZWEIGEN
         CLC   UCBVOLI,=XL6'0' VOLID VORHANDEN ?
         BE    NEXTUCB       NEIN, VERZWEIGEN
         TM    17(R3),X'08'
         BNO   NOVIRT
         TM    TABPVOL1,X'80'
         BO    NEXTUCB
NOVIRT   EQU   *
         SR    R5,R5         R5 LOESCHEN
         MVI   CLCBYTE,X'00' FLAG BYTE LOESCHEN
         LA    R6,TABPVOL1-7 ADRESSE DER VOLSER-TABELLE LADEN
         LA    R7,TABPVOL2-7 ADRESSE DER VOLSER-TABELLE LADEN
NXTVOLID EQU   *
         LA    R6,7(R6)      R6 ERHOEHEN
         LA    R7,7(R7)      R7 ERHOEHEN
         TM    0(R6),X'80'   TABELLENENDE ERREICHT ?
         BO    MVCVOLID      JA, VERZWEIGEN
         IC    R5,0(R6)      LAENGENANGABE LADEN
         MVC   ZWVOLID1,UCBVOLI VOLSER NUMBER UEBERTRAGEN
         MVC   ZWVOLID2,UCBVOLI VOLSER NUMBER UEBERTRAGEN
         EX    R5,NCVOLID1   VERZW. ZUR UEBERLAGERUNG DER VOLID
         EX    R5,OCVOLID2   VERZW. ZUR UEBERLAGERUNG DER VOLID
         CLC   ZWVOLID1,ZWVOLID2 VOLID = AUSGEW. VOLID ?
         BNE   NXTVOLID      VERZW., WENN VOLID ^= AUSGEW. VOLID
         MVI   CLCBYTE,X'FF' FLAG BYTE SETZEN
         B     NXTVOLID      VERZW. ZUR NAECHSTEN ABFRAGE
MVCVOLID EQU   *
         TM    TABPVOL1,X'80' VOLSER NUMBERS SPEZIFIZIERT ?
         BO    *+12          NEIN, VERZWEIGEN
         CLI   CLCBYTE,X'FF' FLAG BYTE GESETZT ?
         BNE   NEXTUCB       NEIN, VERZW. ZUR VERARB. DES NAECHSTEN UCB
         LA    R4,UCBVOLI    ADRESSE DER
         ST    R4,ADDRVOLS       VOLSER NUMBER LADEN UND
         ST    R4,CADRUCBV       SPEICHERN
         EJECT
***********************************************************************
*                                                                     *
*      CCHHR DER VTOC BERECHNEN.                                      *
*                                                                     *
***********************************************************************
         SPACE 3
         SR    R4,R4         R4 LOESCHEN
         IC    R4,DEVCODE    DEVICE CODE LADEN
         SLA   R4,2          DEVICE CODE * 4
         LA    R5,TABTCAP    ADRESSE DER TABTCAP-TABELLE LADEN
         AR    R5,R4         ADRESSE DES TABELLENELEMENTS
         CLI   0(R5),X'80'   DEVICE RESERVED ?
         BE    FEHLDEVC      JA, VERZW. ZUR FEHLERROUTINE
         LH    R6,UCBVTOC    REL. ADRESSE DER VTOC LADEN
         SRDA  R6,32         R6 --> R7
         D     R6,0(R5)      DIV. TT / SPECIFIC TRACKS/CYLINDER
         STH   R7,CCHHR      CC-ADRESSE DER VTOC SPEICHERN
         STH   R6,CCHHR+2    HH-ADRESSE DER VTOC SPEICHERN
         MVI   CCHHR+4,X'01' R-ADRESSE DER VTOC
         SR    R5,R5         R5 LOESCHEN
         IC    R5,UCBVTOC+2  R-ADRESSE DER VTOC LADEN
         STH   R5,LFDRECNO   LAUFENDE SATZNUMMER SPEICHERN
         STH   R6,LFDTRKNO   LAUFENDE SPURNUMMER SPEICHERN
         STH   R7,LFDCYLNO   LAUFENDE ZYLINDERNUMMER SPEICHERN
         LA    R5,TABUNIT    ADRESSE DER EINHEITENTYPEN-TABELLE LADEN
         AR    R5,R4
         MVC   DALUNIT,=CL8' ' ZWISCHENSPEICHER LOESCHEN
         MVC   DALUNIT(4),0(R5) EINHEITENTYP UEBERTRAGEN
         EJECT
***********************************************************************
*                                                                     *
*      DSCB4 LESEN UND AUSWERTEN.                                     *
*                                                                     *
***********************************************************************
         SPACE 3
         OBTAIN CAMOBT       DSCB LESEN
         LTR   R15,R15       RC = 0 ?
         BNZ   FEHLOBT       NEIN, VERZW. ZUR FEHLERROUTINE
         CLI   DS4FMTID,X'F4' 1. DSCB = DSCB4 ?
         BNE   FEHLDSCB      NEIN, VERZW. ZUR FEHLERROUTINE
         MVC   MTRKNO,DS4DEVSZ+2 MAX.SPURADRESSE SPEICHERN
         MVI   MRECNO,X'00'
         MVC   MRECNO+1(1),DS4DEVT MAX. SATZADRESSE SPEICHERN
         MVC   MDS1ADDR(4),DS4HPCR HOECHSTE ADRESSE
         MVI   MDS1R,X'00'             VON DSCB1
         MVC   MDS1R+1(1),DS4HPCR+4    SPEICHERN
         EJECT
***********************************************************************
*                                                                     *
*      DSCB1 LESEN UND AUSWERTEN,                                     *
*      AUFRUF DES UNTERPROGRAMMS 'DYNALC'.                            *
*                                                                     *
***********************************************************************
         SPACE 3
NXTDSCB  EQU   *
         LH    R4,LFDRECNO   LAUFENDE SATZNUMMER LADEN
         LA    R4,1(R4)      R4 ERHOEHEN
         CH    R4,MRECNO     SPUR UEBERSCHRITTEN ?
         BNH   NXTREC        NEIN, VERZWEIGEN
         LH    R4,LFDTRKNO   LAUFENDE SPURNUMMER LADEN
         LA    R4,1(R4)      R4 ERHOEHEN
         CH    R4,MTRKNO     ZYLINDER UEBERSCHRITTEN ?
         BL    NXTTRK        NEIN, VERZWEIGEN
         LH    R4,LFDCYLNO   LAUFENDE ZYLINDERNUMMER LADEN
         LA    R4,1(R4)      R4 ERHOEHEN
         STH   R4,LFDCYLNO   NEUE ZYLINDERNUMMER
         STH   R4,CCHHR      SPEICHERN
         SR    R4,R4         R4 LOESCHEN
NXTTRK   EQU   *
         STH   R4,LFDTRKNO   NEUE SPURADRESSE
         STH   R4,CCHHR+2        SPEICHERN
         LA    R4,1          R4 = 1
NXTREC   EQU   *
         STH   R4,LFDRECNO   NEUE SATZADRESSE
         STC   R4,CCHHR+4        SPEICHERN
         CLC   LFDADDR(6),MDS1ADDR ENDE DER DSCB1 ERREICHT ?
         BH    NEXTUCB       JA, VERZW. ZUM LESEN DES NAECHSTEN UCB
         OBTAIN CAMOBT       NAECHSTEN DSCB LESEN
         LTR   R15,R15       RC = 0 ?
         BNZ   FEHLOBT       NEIN, VERZW. ZUR FEHLERROUTINE
         CLI   DS1FMTID,C'1' DSCB = DSCB1 ?
         BNE   NXTDSCB       NEIN, VERZW. ZUM LESEN DES NAECHSTEN DSCB
         TM    DS1DSORG,X'02' DATA SET PARTITIONED ?
         BZ    NXTDSCB       NEIN, VERZW. ZUM LESEN DES NAECHSTEN DSCB
         LA    R5,DS1DSNAM   ADRESSE DES DSNAME LADEN
         ST    R5,ADDRDSN        UND SPEICHERN
DYNALLOC EQU   *
         MVC   DALDDNAM,=CL8' ' DDNAME LOESCHEN
         LA    R1,DALPWKS    ADR. DER PARAMETERLISTE F. 'DYNALC' LADEN
         L     R15,=V(DYNALC) ADRESSE DES UNTERPROGRAMMS 'DYNALC' LADEN
         BALR  R14,R15       VERZW. ZUM UNTERPROGRAMM 'DYNALC'
*                            (DATA SET NAME ALLOCATION)
         L     R15,SAVE1R15  RC LADEN
         LTR   R15,R15       RC = 0 ?
         BNZ   FEHLDYNA      NEIN, VERZW. ZUR FEHLERROUTINE
         MVC   EIN(DCBLEN),EINCONST DCB UEBERTRAGEN
         MVC   DCBDDNAM,DALDDNAM DDNAME UEBERTRAGEN
         EJECT
***********************************************************************
*                                                                     *
*      MEMBER NAME IN DER DIRECTORY AUFSUCHEN.                        *
*                                                                     *
***********************************************************************
         SPACE 3
         LA    R1,DCBADDR    ADRESSE DER PARAMETERLISTE LADEN
         SVC   19            DATEI EROEFFNEN
         TM    DCBOFLGS,X'10' DATEI EROEFFNET ?
         BZ    FEHLOPEN      NEIN, VERZW. ZUR FEHLERROUTINE
         SPACE 1
         BLDL  EIN,BLDLLIST  ENTRY LIST FUELLEN
         ST    R15,SAVE1R15  RC SPEICHERN
         SPACE 1
         LA    R1,DCBADDR    ADRESSE DER PARAMETERLISTE LADEN
         SVC   20            DATEI SCHLIESSEN
         SPACE 1
         L     R15,SAVE1R15  BLDL-RC LADEN
         LTR   R15,R15       RC = 0 ?
         BZ    NXTMESS       JA, VERZW. ZUR NACHRICHTENROUTINE
         C     R15,=F'8'     RC = 8 ?
         BE    FEHLBLDL      JA, VERZW. ZUR FEHLERROUTINE
         B     NXTDSCB       VERZW. ZUM LESEN DES NAECHSTEN DSCB
         EJECT
***********************************************************************
*                                                                     *
*      AUFBEREITEN DER INFORMATIONSNACHRICHT.                         *
*                                                                     *
***********************************************************************
         SPACE 3
NXTMESS  EQU   *
         L     R10,SAVE1R10  R10 INITIALISIEREN
         MVC   MESSFLAG,=XL6'0' FLAG BYTES LOESCHEN
         MVC   MESSAGE(LENMSG03),MSG03 NACHRICHTENZEILE UEBERTRAGEN
         MVC   MS3DSN,DS1DSNAM DSNAME UEBERTRAGEN
         MVC   MS3VOLS,UCBVOLI VOLSER NUMBER UEBERTRAGEN
         MVC   MS3UNIT,UCBNAME UNIT NAME UEBERTRAGEN
         UNPK  MS3TTR(7),BLDLTTR(4) TTR DES MEMBER UEBERTRAGEN
         TR    MS3TTR,TABHEXA-240 TTR AUFBEREITEN
         LA    R9,MS3INFO    ADRESSE DES INFORMATIONS-FELDES LADEN
         TM    DS1RECFM,X'C0' RECFM = U ?
         BNO   *+12          NEIN, VERZWEIGEN
         MVI   0(R9),C'U'    RECFM = U SPEZIFIZIEREN
         B     RECFMBLK      VERZWEIGEN
         TM    DS1RECFM,X'80' RECFM = F ?
         BNO   *+12          NEIN, VERZWEIGEN
         MVI   0(R9),C'F'    RECFM = F SPEZIFIZIEREN
         B     RECFMBLK      VERZWEIGEN
         MVI   0(R9),C'V'    RECFM = V SPEZIFIZIEREN
RECFMBLK EQU   *
         LA    R9,1(R9)      R9 ERHOEHEN
         TM    DS1RECFM,X'10' RECFM = BLOCKED ?
         BZ    *+12          NEIN, VERZWEIGEN
         MVI   0(R9),C'B'    RECFM = BLOCKED SPEZIFIZIEREN
         LA    R9,1(R9)      R9 ERHOEHEN
         TM    DS1RECFM,X'08' SPANNED, STANDARD ?
         BZ    *+12          NEIN, VERZWEIGEN
         MVI   0(R9),C'S'    SPANNED, STANDARD SPEZIFIZIEREN
         LA    R9,1(R9)      R9 ERHOEHEN
         TM    DS1RECFM,X'06' CONTROL CARACTER ?
         BZ    NOCONTC       NEIN, VERZWEIGEN
         TM    DS1RECFM,X'04' CONTROL CARACTER = A ?
         BZ    *+12          NEIN, VERZWEIGEN
         MVI   0(R9),C'A'    CONTROL CARACTER = A SPEZIFIZIEREN
         B     *+8           VERZWEIGEN
         MVI   0(R9),C'M'    CONTROL CARACTER = M SPEZIFIZIEREN
         LA    R9,1(R9)      R9 ERHOEHEN
         EJECT
NOCONTC  EQU   *
         MVI   0(R9),C','    KOMMA EINTRAGEN
         SR    R8,R8         R8 LOESCHEN
         ICM   R8,3,DS1BLKL  BLOCKLAENGE LADEN
         BAL   R14,CONVLEN   VERZW. ZUR UMWANDLUNG DER BLOCKLAENGE
         MVI   0(R9),C','    KOMMA EINTRAGEN
         CLI   MS3INFO,C'U'  RECFM = U ?
         BNE   *+12          NEIN, VERZWEIGEN
         MVI   1(R9),C'*'    RECL = 0 SPEZIFIZIEREN
         B     *+12          VERZWEIGEN
         ICM   R8,3,DS1RECL  SATZLAENGE LADEN
         BAL   R14,CONVLEN   VERZW. ZUR UMWANDLUNG DER SATZLAENGE
         LA    R14,NXTDSCB   RUECKSPRUNGADRESSE LADEN
         LA    R10,72(R10)   R10 ERHOEHEN
         C     R10,ADDRETB1  TABELLENENDE ERREICHT ?
         BNL   WTONACHR      JA, VERZW. ZUR AUSGABE DER NACHRICHTEN
         ST    R10,SAVE1R10  LAUFENDE ADRESSE SPEICHERN
         B     NXTDSCB       VERZW. ZUR VERARB. DES NAECHSTEN DSCB
         SPACE 2
*
*      BLOCK- UND SATZLAENGEN IN DEZIMALZAHLEN UMWANDELN.
*
         SPACE 1
CONVLEN  EQU   *
         CVD   R8,DBWORD     LAENGE UMWANDELD
         UNPK  ZWFELD,DBWORD DEZIMALZAHL ENTPACKEN
         OI    ZWFELD+14,C'0' VORZEICHEN MODIFIZIEREN
         LA    R6,ZWFELD-1   ADRESSE VON ZWFELD LADEN
         LA    R7,ZWFELD+14  ADRESSE DES LETZTEN BYTES LADEN
CONVSCHL EQU   *
         LA    R6,1(R6)      R6 ERHOEHEN
         CR    R6,R7         ZWFELD UEBERSCHRITTEN ?
         BNL   LENOK         JA, VERZWEIGEN
         CLI   0(R6),C'0'    FUEHRENDE NULL ?
         BE    CONVSCHL      JA, VERZWEIGEN
LENOK    EQU   *
         SR    R7,R6         NEIN, LAENGE DER ZAHL FESTSTELLEN
         EX    R7,MOVELEN    VERZW. ZUR UEBERTR. DER LAENGE
         AR    R9,R7         R9 ERHOEHEN
         LA    R9,2(R9)      R9 ERHOEHEN
         BR    R14           VERZWEIGEN
         EJECT
***********************************************************************
*                                                                     *
*      ABSCHLUSSROUTINEN.                                             *
*                                                                     *
***********************************************************************
         SPACE 3
ABSCHLUS EQU   *
         FREEMAIN R,SP=125   SPEICHERPLATZ FREIGEBEN
         LA    R10,TABNACHR  ADRESSE DER NACHRICHTEN-TABELLE LADEN
         CLC   MESSFLAG,=XL6'0' SIND NOCH NACHRICHTEN OFFEN ?
         BNE   *+8           NEIN, VERZWEIGEN
         BAL   R14,WTONACHR  VERZW. ZUR AUSGABE DER NACHRICHTEN
         TM    FOUNDBIT,X'80' MEMBER GEFUNDEN ?
         BO    ENDE          JA, VERZWEIGEN
         MVC   MESSAGE(LENMSG04),MSG04 MSG04 UEBERTRAGEN
         MVC   MS1NAME,MEMBNAME MEMBER NAME UEBERTRAGEN
         L     R0,UCMID      UCM-ID. DES AUFRUFERS LADEN
         LA    R1,MESSAGE
         BAL   R14,WTOROUT
         SPACE 1
ENDE     EQU   *
         XRETURN ,R
         EJECT
***********************************************************************
*                                                                     *
*      NACHRICHTENAUSGABE.                                            *
*                                                                     *
***********************************************************************
         SPACE 3
WTONACHR EQU   *
         ST    R14,SAVE1R14  RUECKSPRUNGADRESSE SPEICHERN
         LA    R10,MSG01ZW   ADRESSE DER NACHRICHTENZEILE SPEICHERN
         MVC   MSG01ZW(LENMSG01),MSG01 NACHRICHTENZEILE UEBERTRAGEN
         MVC   MS1NAME,MEMBNAME MEMBER NAME UEBERTRAGEN
         L     R0,UCMID      UCM-ID. DES AUFRUFERS LADEN
         LA    R1,MSG01ZW
         BAL   R14,WTOROUT
         L     R0,UCMID      UCM-ID. DES AUFRUFERS LADEN
         LA    R1,MSG02
         BAL   R14,WTOROUT
         LA    R10,TABNACHR-72 ADRESSE DER NACHRICHTEN-TAB. LADEN
NXTINMSS EQU   *
         LA    R10,72(R10)   R10 ERHOEHEN
         C     R10,ADDRETB1  TABELLENENDE ERREICHT ?
         BNL   RETINMSS      JA, VERZWEIGEN
         CLC   MESSFLAG,=X'FFFF' FLAG BYTES GESETZT ?
         BE    RETINMSS      JA, VERZWEIGEN
         MVC   MESSFLAG,=X'FFFF' FLAG BYTES SETZEN
         L     R0,UCMID      UCM-ID. DES AUFRUFERS LADEN
         LA    R1,MESSAGE
         BAL   R14,WTOROUT
         B     NXTINMSS      VERZWEIGEN
RETINMSS EQU   *
         LA    R10,TABNACHR  ADRESSE DER NACHRICHTEN-TAB. LADEN
         ST    R10,SAVE1R10      UND SPEICHERN
         MVI   FOUNDBIT,X'80' BIT FUER GEFUNDENES MEMBER SETZEN
         L     R14,SAVE1R14  RUECKSPRUNGADRESSE LADEN
         BR    R14           VERZWEIGEN
         EJECT
***********************************************************************
*                                                                     *
*      FEHLERROUTINEN.                                                *
*                                                                     *
***********************************************************************
         SPACE 3
*
*      ROUTINE BEI UNGUELTIGEM SYSTEM.
*
         SPACE 1
FEHLSYS  EQU   *
         L     R0,UCMID      UCM-ID. DES AUFRUFERS LADEN
         LA    R1,MSG05
         BAL   R14,WTOROUT
         B     ENDE          VERZWEIGEN
         SPACE 2
*
*      ROUTINE BEI FEHLER IN DER PARAMETERKETTE.
*
         SPACE 1
FEHLPARM EQU   *
         L     R0,UCMID      UCM-ID. DES AUFRUFERS LADEN
         LA    R1,MSG06
         BAL   R14,WTOROUT
         B     ENDE          VERZWEIGEN
         SPACE 2
*
*      ROUTINE BEI DYNALC-FEHLER (RC ^= 0).
*
         SPACE 1
FEHLDYNA EQU   *
         LA    R10,TABFNACH  R10 INITIALISIEREN
         MVC   MESSAGE(LENMSG07),MSG07 MSG07 UEBERTRAGEN
         MVC   MS7VOLS,UCBVOLI VOLSER NUMBER UEBERTRAGEN
         MVC   MS7DSN,DS1DSNAM DSNAME UEBERTRAGEN
         LA    R14,NXTDSCB   RUECKSPRUNGADRESSE LADEN
         B     RETFEHL       VERZW. ZUM AUSGANG DER FEHLERROUTINEN
         EJECT
*
*      ROUTINE BEI BLDL-FEHLER (RC = 8).
*
         SPACE 1
FEHLBLDL EQU   *
         LA    R10,TABFNACH  R10 INITIALISIEREN
         MVC   MESSAGE(LENMSG08),MSG08 MSG08 UEBERTRAGEN
         MVC   MS8DSN,DS1DSNAM DSNAME UEBERTRAGEN
         MVC   MS8VOLS,UCBVOLI VOLSER NUMBER UEBERTRAGEN
         LA    R14,NXTDSCB   RUECKSPRUNGADRESSE LADEN
         B     RETFEHL       VERZW. ZUM AUSGANG DER FEHLERROUTINEN
         SPACE 2
*
*      ROUTINE BEI OBTAIN-FEHLER (RC ^= 0).
*
         SPACE 1
FEHLOBT  EQU   *
         LA    R10,TABFNACH  R10 INITIALISIEREN
         MVC   MESSAGE(LENMSG09),MSG09 MSG09 UEBERTRAGEN
         MVC   MS9VOLS,UCBVOLI VOLSER NUMBER UEBERTRAGEN
         ST    R15,SAVE1R15  RC SPEICHERN
         UNPK  MS9RC(3),SAVE1R15+3(2) RC UEBERTRAGEN
         MVI   MS9RC+2,C','
         TR    MS9RC,TABHEXA-240 RC AUFBEREITEN
         LA    R14,NXTDSCB   RUECKSPRUNGADRESSE LADEN
         B     RETFEHL       VERZW. ZUM AUSGANG DER FEHLERROUTINEN
         EJECT
*
*      ROUTINE BEI DSCB-FEHLER (1. DSCB NICHT FORMAT 4).
*
         SPACE 1
FEHLDSCB EQU   *
         LA    R10,TABFNACH  R10 INITIALISIEREN
         MVC   MESSAGE(LENMSG10),MSG010 NACHRICHTENZEILE UEBERTRAGEN
         MVC   MS10VOLS,UCBVOLI VOLSER NUMBER UEBERTRAGEN
         LA    R14,NEXTUCB   RUECKSPRUNGADRESSE LADEN
         B     RETFEHL       VERZWEIGEN
         SPACE 2
*
*      ROUTINE BEI RESERVED DEVICES.
*
         SPACE 1
FEHLDEVC EQU   *
         LA    R10,TABFNACH  R10 INITIALISIEREN
         MVC   MESSAGE(LENMSG11),MSG011 NACHRICHTENZEILE UEBERTRAGEN
         UNPK  MS11DEVC(3),DEVCODE(2) DEVICE CODE UEBERTRAGEN
         TR    MS11DEVC,TABHEXA-240 DEVICE CODE AUFBEREITEN
         LA    R14,NEXTUCB   RUECKSPRUNGADRESSE LADEN
         B     RETFEHL       VERZWEIGEN
         EJECT
*
*      ROUTINE BEI OPEN-FEHLER.
*
         SPACE 1
FEHLOPEN EQU   *
         LA    R10,TABFNACH  R10 INITIALISIEREN
         MVC   MESSAGE(LENMSG12),MSG012 NACHRICHTENZEILE UEBERTRAGEN
         MVC   MS8DSN,DS1DSNAM DSNAME UEBERTRAGEN
         MVC   MS8VOLS,UCBVOLI VOLSER NUMBER UEBERTRAGEN
         LA    R14,RETFOPEN  RUECKSPRUNGADRESSE LADEN
         LA    R10,72(R10)   R10 ERHOEHEN
         B     RETFEHL       VERZWEIGEN
RETFOPEN EQU   *
         MVC   DALTYPE,=CL8'UNALLOC' DYNALLOC-TYP SPEZIFIZIEREN
         OI    ADDRDSN,X'80' ENDE DER PARAMETERKETTE SPEZIFIZIEREN
         LA    R1,DALPWKS    ADR. DER PARAMETERKETTE F. 'DYNALC' LADEN
         L     R15,=V(DYNALC) ADRESSE DES UNTERPROGRAMMS 'DYNALC' LADEN
         BALR  R14,R15       VERZW. ZUM UNTERPROGRAMM 'DYNALC'
*                            (DYNAMIC UNALLOCATION)
         NI    ADDRDSN,X'7F' ENDE DER PARAMETERKETTE ZURUECKSETZEN
         MVC   DALTYPE,=CL8'DSALLOC' DYNALLOC-TYP NEU SPEZIFIZIEREN
         L     R15,SAVE1R15  RC LADEN
         LTR   R15,R15       RC = 0 ?
         BNZ   FEHLDYNA      NEIN, VERZW. ZUR FEHLERROUTINE
         SPACE 2
*
*      AUSGANG DER FEHLERROUTINEN.
*
         SPACE 1
RETFEHL  EQU   *
         CLI   TESTBYTE,X'FF' FLAG BYTE GESETZT ?
         BNER  R14           NEIN, VERZWEIGEN
         L     R0,UCMID      UCM-ID. DES AUFRUFERS LADEN
         LA    R1,MESSAGE
         BAL   R14,WTOROUT
         BR    R14           VERZWEIGEN
WTOROUT  EQU   *
         ST    R14,SAVE14
         C     R0,=CL4'TSO'
         BNE   DOWTO
         LH    R0,0(R1)
         SH    R0,=H'4'
         LA    R1,4(R1)
         SVC   93                   **** TPUT ****
         L     R14,SAVE14
         BR    R14
DOWTO    EQU   *
         WTO   MF=(E,(1))
         L     R14,SAVE14
         BR    R14
         EJECT
***********************************************************************
*                                                                     *
*      BEFEHLE, DIE MIT HILFE DES EXECUTE-BEFEHLS AUSGEFUEHRT WERDEN. *
*                                                                     *
***********************************************************************
         SPACE 3
MOVEPNAM EQU   *
         MVC   MEMBNAME(0),9(R11) MEMBER NAME UEBERTRAGEN
MOVEPVOL EQU   *
         MVC   1(0,R6),1(R7) VOLID IN TABELLE UEBERTRAGEN
NCVOLID1 EQU   *
         NC    ZWVOLID1(0),1(R6) VOLID UEBERLAGERN
OCVOLID2 EQU   *
         OC    ZWVOLID2(0),1(R7) VOLID UEBERLAGERN
MOVELEN  EQU   *
         MVC   1(0,R9),0(R6) LAENGE UEBERTRAGEN
         SPACE 3
***********************************************************************
*                                                                     *
*      REGISTER EQUATES.                                              *
*                                                                     *
***********************************************************************
         SPACE 3
R0       EQU   0             MACRO- UND-PARAMETER REGISTER
R1       EQU   1             MACRO- UND-PARAMETER REGISTER
R2       EQU   2             POINTER IN CVT / UCB LOOKUP TABLE
R3       EQU   3             POINTER FUER UCB
R4       EQU   4             ARBEITSREGISTER
R5       EQU   5             ARBEITSREGISTER
R6       EQU   6             ARBEITSREGISTER
R7       EQU   7             ARBEITSREGISTER
R8       EQU   8             ARBEITSREGISTER
R9       EQU   9             ARBEITSREGISTER
R10      EQU   10            POINTER IN NACHRICHTEN-TABELLEN
R11      EQU   11            BASISREG. FUER DSECT PARMAREA / VEKTOR
R12      EQU   12            BASISREG. FUER CSECT FIND
R13      EQU   13            BASISREG. FUER DSECT ABER
R14      EQU   14            RUECKSPRUNGADRESSEN
R15      EQU   15            CSECT-ADRESSEN UND RETURN CODES
         EJECT
***********************************************************************
*                                                                     *
*      DEFINITION DER KONSTANTEN-SPEICHER.                            *
*                                                                     *
***********************************************************************
         SPACE 3
*
*      PARAMETERLISTE FUER 'DYNALC' (KONSTANTEN).
*
         SPACE 1
DALPCON  DS    0F
         DC    A(0)          ADRESSE VON RETCODE
         DC    A(0)          ADRESSE DES DYNALLOC-TYPS
         DC    A(0)          ADRESSE DES DDNAME
         DC    A(0)          ADRESSE DES DSNAME
         DC    A(0)
         DC    A(DALSTATS)   ADRESSE DES DS STATUS
         DC    A(DALNDISP)   ADRESSE DER DS NORM. DISPOSITION
         DC    A(DALCDISP)   ADRESSE DER DS COND. DISPOSITION
         DC    7A(0)
         DC    A(0)          ADRESSE DER VOLSER NUMBER
         DC    4A(0)
         DC    X'80'         ENDE DER PARAMETERKETTE
         DC    AL3(0)        ADRESSE DER UNIT SPECIFICATION
DALPLEN  EQU   *-DALPCON     LAENGE DER PARAMETERLISTE
DALSTATS DC    C'SHR'        DATA SET STATUS
DALNDISP DC    CL7'KEEP'     DATA SET NORMAL DISPOSITION
DALCDISP DC    CL7'KEEP'     DATA SET CONDITIONAL DISPOSITION
         SPACE 2
*
*      CAMLIST-MACRO (KONSTANTEN).
*
         SPACE 1
CAMCON   CAMLST SEEK,0,0,0
CAMLEN   EQU   *-CAMCON      LAENGE DES CAMLIST-MACROS
         EJECT
*
*      TABELLE FUER AUFBEREITUNG VON HEXADEZIMALZAHLEN.
*
         SPACE 1
TABHEXA  DC    C'0123456789ABCDEF'
         SPACE 2
*
*      DCB-DEFINITION FUER DIE EINGABEDATEI.
*
         SPACE 1
EINCONST DCB   DDNAME=EIN00000,DSORG=PO,MACRF=(R)
DCBLEN   EQU   *-EINCONST    LAENGE DES DCB
         EJECT
***********************************************************************
*                                                                     *
*      TABELLEN FUER EINHEITENTYPEN UND KAPAZITAETEN.                 *
*                                                                     *
*      DEVICE CODES:                                                  *
*      01 - 2311    DISK STORAGE DEVICE                               *
*      02 - 2301    PARALLEL DRUM                                     *
*      03 - 2303    SERIAL DRUM                                       *
*      04 - 2302    DISK STORAGE                                      *
*      05 - 2321    DATA CELL DRIVE                                   *
*      06 - 2305/1  FIXED HEAD STORAGE / MODEL 1                      *
*      07 - 2305/2  FIXED HEAD STORAGE / MODEL 2                      *
*      08 - 2314    DISK STORAGE FACILITY                             *
*      09 - 3330/1  DISK STORAGE / MODEL 1                            *
*      0A - 3340    DISK STORAGE                                      *
*      0B - RESERVED                                                  *
*      0C - RESERVED                                                  *
*      0D - 3330/11 DISK STORAGE / MODEL 11                           *
*      0E - RESERVED                                                  *
*      0F - RESERVED                                                  *
*                                                                     *
***********************************************************************
         SPACE 3
*
*      EINHEITENTYPEN.
*
         SPACE 1
TABUNIT  EQU   *
         DC    C'    '
         DC    C'2311'       01
         DC    C'2301'       02
         DC    C'2303'       03
         DC    C'2302'       04
         DC    C'2321'       05
         DC    C'2305'       06
         DC    C'2305'       07
         DC    C'2314'       08
         DC    C'3330'       09
         DC    C'3340'       0A
         DC    C'3350'       0B
         DC    C'    '       0C
         DC    C'3311'       0D
         DC    C'3380'       0E
         DC    C'    '       0F
         EJECT
*
*      TRACKS / CYLINDER.
*
         SPACE 1
TABTCAP  DS    0F
         DC    X'80',XL3'0'  00
         DC    F'10'         01
         DC    F'08'         02
         DC    F'10'         03
         DC    F'46'         04
         DC    F'20'         05
         DC    F'08'         06
         DC    F'08'         07
         DC    F'20'         08
         DC    F'19'         09
         DC    F'12'         0A
         DC    F'30'         0B
         DC    X'80',XL3'0'  0C
         DC    F'19'         0D
         DC    F'15'         0E
         DC    X'80',XL3'0'  0F
         EJECT
***********************************************************************
*                                                                     *
*      DEFINITION DER AUSGABENACHRICHTEN.                             *
*                                                                     *
***********************************************************************
         SPACE 3
MSG01    WTO   'XFIND01 MEMBER 12345678 FOUND IN:',                    *
               MF=L,MCSFLAG=(REG0)
LENMSG01 EQU   *-MSG01
         SPACE 1
MSG02    WTO   'XFIND02 -----DSNAME------ VOLSER UNIT DSCB1-INFORMATION*
                -TTR--',                                               *
               MF=L,MCSFLAG=(REG0)
LENMSG02 EQU   *-MSG02
         SPACE 1
MSG03    WTO   'XFIND03                   123456 123                   *
                123456',                                               *
               MF=L,MCSFLAG=(REG0)
LENMSG03 EQU   *-MSG03
         SPACE 1
MSG04    WTO   'XFIND04 MEMBER 12345678 NOT FOUND',                    *
               MF=L,MCSFLAG=(REG0)
LENMSG04 EQU   *-MSG04
         EJECT
MSG05    WTO   'XFIND05 FUNCTION SUPPORTED FOR OS/VS2 (MVS) ONLY',     *
               MF=L,MCSFLAG=(REG0)
LENMSG05 EQU   *-MSG05
         SPACE 1
MSG06    WTO   'XFIND06 ERROR IN PARAMETER LIST',                      *
               MF=L,MCSFLAG=(REG0)
LENMSG06 EQU   *-MSG06
         SPACE 1
MSG07    WTO   'XFIND07 VOLSER=123456,DSN=12345678901234567 ALLOCATION *
               FAILURE',                                               *
               MF=L,MCSFLAG=(REG0)
LENMSG07 EQU   *-MSG07
         SPACE 1
MSG08    WTO   'XFIND08 VOLSER=123456,DSN=12345678901234567890123 BLDL *
               FAILURE',                                               *
               MF=L,MCSFLAG=(REG0)
LENMSG08 EQU   *-MSG08
         EJECT
MSG09    WTO   'XFIND09 ERROR DURING EXECUTING OBTAIN, RC=99, VOLSER=12*
               3456',                                                  *
               MF=L,MCSFLAG=(REG0)
LENMSG09 EQU   *-MSG09
         SPACE 1
MSG010   WTO   'XFIND10 1. DSCB NOT FORMAT 4, VOLSER=123456',          *
               MF=L,MCSFLAG=(REG0)
LENMSG10 EQU   *-MSG010
         SPACE 1
MSG011   WTO   'XFIND11 NO INFORMATION ABOUT DEVICE AVAILABLE, DEVCODE=*
               99',                                                    *
               MF=L,MCSFLAG=(REG0)
LENMSG11 EQU   *-MSG011
         SPACE 1
MSG012   WTO   'XFIND12 VOLSER=123456,DSN=12345678901234567890123 OPEN *
               FAILURE',                                               *
               MF=L,MCSFLAG=(REG0)
LENMSG12 EQU   *-MSG012
         EJECT
***********************************************************************
*                                                                     *
*      DEFINITION DER ARBEITSBEREICHE.                                *
*                                                                     *
***********************************************************************
         SPACE 3
ABER     DSECT
SAVEAREA DS    18F           SAVEAREA FUER ALLGEMEINE REGISTER
SAVE14   DS    F
DBWORD   DS    D             ZWISCHENSPEICHER FUER DEZIMALZAHLEN
ZWFELD   DS    CL15          ZWISCHENSPEICHER FUER DEZIMALZAHLEN
ZWVOLID1 DS    CL6           ZWISCHENSPEICHER FUER VOLID
ZWVOLID2 DS    CL6           ZWISCHENSPEICHER FUER VOLID
FOUNDBIT DS    C             SCHALTER FUER GEFUNDENE MEMBER
TESTBYTE DS    C             SCHALTER FUER TEST
CLCBYTE  DS    C             SCHALTER ZUR ABFRAGE DER VOLSER NUMBER
ADDRETB1 DS    F             ADRESSE DES ENDES VON TABNACHR
ADDRETPV DS    F             ADRESSE DES ENDES VON TABPVOL
ADDREPRM DS    F             ADRESSE DES ENDES DES PARAMETERBEREICHS
UCMID    DS    F             UCM-ID. DES AUFRUFERS
MDS1ADDR DS    3H            HOECHSTE ADRESSE VON DSCB1
         ORG   MDS1ADDR
MDS1CC   DS    H             MAX. ZYLINDERNUMMER (DS4HPCR)
MDS1HH   DS    H             MAX. SPURNUMMER (DS4HPCR+2)
MDS1R    DS    H             MAX. SATZNUMMER (DS4HPCR+4)
MLFDADDR DS    2H            HOECHSTE LFD. ADRESSE
         ORG   MLFDADDR
MTRKNO   DS    H             MAX. SPURNUMMER (DS4DEVSZ+2)
MRECNO   DS    H             MAX. SATZNUMMER (DS4DEVT)
LFDADDR  DS    3H            LAUFENDE ADRESSE
         ORG   LFDADDR
LFDCYLNO DS    H             LAUFENDE ZYLINDERNUMMER
LFDTRKNO DS    H             LAUFENDE SPURNUMMER
LFDRECNO DS    H             LAUFENDE SATZNUMMER
SAVE1R10 DS    F             SAVEAREA FUER R10
SAVE1R14 DS    F             SAVEAREA FUER R14
         SPACE 2
EIN      DS    10F           DCB DER EINGABEDATEI
DCBDDNAM DS    CL8           DDNAME
DCBOFLGS DS    C             FLAG BYTE
         ORG   EIN+DCBLEN
DCBADDR  DS    F             ADRESSE DES DCB
         EJECT
*
*      CAMLIST-MACRO.
*
         SPACE 1
CAMOBT   DS    0F
         DS    C             AL1(192)
         DS    C             AL1(128)
         DS    C             AL1(0)
         DS    C             AL1(0)
CADRCCHH DS    F             A(CCHHR)
CADRUCBV DS    F             A(UCBVOLI)
CADRCAMW DS    F             A(CAMWKFLD)
         DS    0H
CCHHR    DS    CL5           CCHHR-ADRESSE DES NAECHSTEN DSCB
         DS    0D
CAMWKFLD DS    CL148         WORK FIELD
         SPACE 2
*
*      DSCB-DEFINITIONEN.
*
         SPACE 1
         ORG   CAMWKFLD
DSCB1    DS    0CL140        DATA SET CONTROL BLOCK FORMAT 1
DS1DSNAM DS    CL44          DATA SET NAME
DS1FMTID DS    C             FORMAT IDENTIFIER (= C'1')
         DS    CL37
DS1DSORG DS    CL2           DATA SET ORGANISATION
DS1RECFM DS    C             DATA SET RECORD FORMAT
         DS    C
DS1BLKL  DS    CL2           DATA SET BLOCK LENGTH
DS1RECL  DS    CL2           DATA SET RECORD LENGTH
         DS    CL3
DS1DSIND DS    C             DATA SET INDICATORS
         ORG   CAMWKFLD
DSCB4    DS    0CL140        DATA SET CONTROL BLOCK FORMAT 4
         DS    CL44
DS4FMTID DS    C             FORMAT IDENTIFIER (= X'F4')
DS4HPCR  DS    CL5           HIGHEST DISK ADDRESS OF DSCB1 (CCHHR)
         DS    CL12
DS4DEVSZ DS    CL4           DEVICE SIZE
         DS    CL8
DS4DEVT  DS    C             NO.OF DSCB'S ON A TRACK
         ORG   CAMWKFLD+148
         EJECT
*
*      DIRECTORY ENTRY LIST FUER BLDL.
*
         SPACE 1
BLDLLIST DS    0F
BLDLFF   DS    H             ANZAHL DER MEMBER ENTRIES
BLDLLL   DS    H             LAENGE DER ENTRIES
MEMBNAME DS    CL8           MEMBER NAME (PARMNAME)
BLDLTTR  DS    CL3           REL. ADRESSE DES MEMBERS (TTR)
         DS    CL2
BLDLC    DS    C             MEMBER TYPE (X'80' - ALIAS)
         SPACE 2
*
*      PARAMETERLISTE FUER 'DYNALC' (ARBEITSBEREICH).
*
         SPACE 1
DALPWKS  DS    0F
ADDRRC   DS    F             ADRESSE VON RETCODE
ADDRTYPE DS    F             ADRESSE DES DYNALLOC-TYPS
ADDRDDN  DS    F             ADRESSE DES DDNAME
ADDRDSN  DS    F             ADRESSE DES DSNAME
         DS    11F
ADDRVOLS DS    F             ADRESSE DER VOLSER NUMBER
         DS    4F
ADDRUNIT DS    F             ADRESSE DER UNIT SPECIFICATION
         ORG   DALPWKS+DALPLEN
RETCODE  DS    0F            RETURN CODES VON 'DYNALC'
SAVE1R15 DS    F             RETURN CODE
SAVE1R0  DS    F             ERROR REASON CODE
SAVE1R1  DS    F             INFORMATION REASON CODE
DALDDNAM DS    CL8           DDNAME
DALUNIT  DS    CL8           UNIT SPECIFICATION
DALTYPE  DS    CL8           DYNALLOC-TYP
         EJECT
*
*      MASKEN-TABELLEN FUER VOLSER NUMBERS AUS DEM PARAMETERBEREICH.
*
*      AUFBAU DER TABELLE:
*      BYTE1 - LAENGE DES ANGEGEBENEN VOLSER-PARAMETERS ODER
*          X'80' BEI TABELLENENDE
*      BYTES2-7 - ANFANGSZEICHEN DER VOLSER NUMBER UND MASKENZEICHEN
*
         SPACE 1
TABPVOL1 DS    10CL7
ENDTPVOL EQU   *
         DS    CL7
TABPVOL2 DS    CL77
         SPACE 2
*
*      NACHRICHTEN-BEREICHE.
*
         SPACE 1
         DS    0F
TABNACHR DS    10CL72        TABELLE FUER NACHRICHTEN
ENDTAB1  EQU   *
TABFNACH DS    CL72          TABELLE FUER FEHLERNACHRICHTEN
MSG01ZW  DS    CL70          NACHRICHEN-ZEILE
ABERL    EQU   *-ABER        LAENGE DER ARBEITSBEREICHE
         EJECT
***********************************************************************
*                                                                     *
*      DEFINITIONEN FUER EINE NACHRICHTENZEILE.                       *
*                                                                     *
***********************************************************************
         SPACE 3
MESSAGE  DSECT
         DS    CL4
         SPACE 2
*
*      DEFINITIONEN FUER MSG01, MSG04.
*
         SPACE 1
         DS    CL15
MS1NAME  DS    CL8           MEMBER NAME
         SPACE 2
*
*      DEFINITIONEN FUER MSG03.
*
         SPACE 1
         ORG   MESSAGE+4
         DS    CL8
MS3DSN   DS    CL17          DATA SET NAME
         DS    C
MS3VOLS  DS    CL6           VOLSER NUMBER
         DS    C
MS3UNIT  DS    CL3           UNIT NAME
         DS    CL2
MS3INFO  DS    CL17          DSCB1-INFORMATION
         DS    C
MS3TTR   DS    CL6           REL. ADRESSE DES MEMBERS (TTR)
         SPACE 2
*
*      DEFINITIONEN FUER MSG07.
*
         SPACE 1
         ORG   MESSAGE+4
         DS    CL15
MS7VOLS  DS    CL6           VOLUME SERIAL NUMBER
         DS    CL5
MS7DSN   DS    CL17          DATA SET NAME
         EJECT
*
*      DEFINITIONEN FUER MSG08, MSG012.
*
         SPACE 1
         ORG   MESSAGE+4
         DS    CL15
MS8VOLS  DS    CL6           VOLUME SERIAL NUMBER
         DS    CL5
MS8DSN   DS    CL23
         SPACE 2
*
*      DEFINITIONEN FUER MSG09.
*
         SPACE 1
         ORG   MESSAGE+4
         DS    CL42
MS9RC    DS    CL2           RETURN CODE
         DS    CL9
MS9VOLS  DS    CL6           VOLSER NUMBER
         SPACE 2
*
*      DEFINITIONEN FUER MSG010.
*
         SPACE 1
         ORG   MESSAGE+4
         DS    CL37
MS10VOLS DS    CL6           VOLSER NUMBER
         SPACE 2
*
*      DEFINITIONEN FUER MSG011.
*
         SPACE 1
         ORG   MESSAGE+4
         DS    CL55
MS11DEVC DS    CL2           DEVICE CODE
         SPACE 2
         ORG   MESSAGE+70
MESSFLAG DS    CL2           FLAG BYTES
         EJECT
***********************************************************************
*                                                                     *
*      UCB-DEFINITIONEN.                                              *
*                                                                     *
***********************************************************************
         SPACE 3
UCB      DSECT
         DS    CL3
DEVSTAT  DS    C             DEVICE STATUS
         DS    CL9
UCBNAME  DS    CL3           UNIT NAME
UCBTYPE  DS    CL2           DEVICE TYPE
UCBDVCLS DS    C             DEVICE CLASS
DEVCODE  DS    C             DEVICE CODE
         DS    CL4
UCBVTOC  DS    CL4           REL. ADDR. OF VTOC FOR THIS VOL. (TTR0)
UCBVOLI  DS    CL6           VOLUME SERIAL NUMBER
UCBSTAB  DS    C             VOLUME STATUS
         SPACE 3
***********************************************************************
*                                                                     *
*      PARAMETERBEREICH.                                              *
*                                                                     *
***********************************************************************
         SPACE 3
         XPARM
PARMENDE EQU   *
         END   FIND
./ ADD NAME=FIXLPA
FIXLPA   START
         REG
         XSAVE R12,SVA,FIXLPA
         USING PARMAREA,R11
         LR    R11,R1
         CLC   REG4(4),=CL4'TSO'
         BNE   NOTSO
         TPUT  NOTSOMSG,70
         B     RETURN
NOTSOMSG DC    CL70'TO BE EFFECTIVE, FIXLPA MUST RUN UNDER THE NON-SWAP*
               PABLE XCNTRL'
NOTSO    EQU   *
         LA    R2,TEXT+7
         SR    R4,R4
         LA    R5,8
NEXTCHAR EQU   *
         CLI   0(R2),C' '
         BE    END
         LA    R2,1(R2)
         LA    R4,1(R4)
         BCT   R5,NEXTCHAR
ERROR    EQU   *
         L     R0,REG4
         WTO   'XFIXLPA ERROR IN PARAMETER',MCSFLAG=REG0
RETURN   EQU   *
         XRETURN 0
END      EQU   *
         MVC   ZWI,TEXT+7
         LTR   R4,R4
         BNP   ERROR
         BCTR  R4,0
         EX    R4,TREX
         EX    R4,TRTEX
         BNZ   ERROR
         LA    R5,7
         LR    R6,R4
         LA    R6,1(R6)
         SLL   R5,4
         OR    R5,R6
         EX    R5,PACKEX
         ICM   R7,15,DBLWD+3
         XC    ECB,ECB
         PGFIX R,A=(R7),ECB=ECB,RELATED=NO
         WAIT  ECB=ECB
         XC    ECB,ECB
         MVC   WTOR+59(8),TEXT+7
         WTOR  ,ANSW,1,ECB,MF=(E,WTOR)
         WAIT  ECB=ECB
         XC    ECB,ECB
         PGFREE R,A=(R7),ECB=ECB,RELATED=NO
         WAIT  ECB=ECB
         B     RETURN
TREX     TR    ZWI(0),TRTAB
TRTEX    TRT   ZWI(0),ZEROES
PACKEX   PACK  DBLWD(0),ZWI(0)
ECB      DC    F'0'
ANSW     DC    C' '
ZWI      DC    CL8' '
ZEROES   DC    16XL1'00'
DBLWD    DC    D'0'
WTOR     WTOR  'XFIXLPA ENTER ANY CHARACTER TO REMOVE PGFIX OF 12345678*
               ',MF=L,ROUTCDE=2
TRTAB    DC    256XL1'00'
         ORG   TRTAB+X'C1'
         DC    X'0A0B0C0D0E0F'
         ORG   TRTAB+X'F0'
         DC    X'00010203040506070809'
         ORG
         XPARM
         END
./ ADD NAME=XDSNMSG
         TITLE 'XDSNMSG                          X-COMMAND DSNMSG'
DSNMSG   START
         XSAVE R12,,DSNMSG
         REG
         LR    R11,R1
         USING PARMAREA,R11
         USING RIB,R7
         USING RIBVAR,R8
         USING RIBE,R10
         ST    R11,SAVER11
         MVC   DSNAME,TEXT+7
         GETMAIN R,LV=102400
         ST    R1,TABAD
         GQSCAN AREA=((R1),102400),REQLIM=MAX,SCOPE=ALL,               *
               RESNAME=SYSDSN,WAITCNT=1
         LTR   R15,R15
         BNZ   CHKCODE
         ST    R0,FULLWD
         LH    R2,FULLWD    LENGTH OF FIXED RIB
         LH    R3,FULLWD+2  LENGTH OF EACH RIBE
         LR    R4,R1        NUBER OF RIB'S RETURNED
         L     R7,TABAD     A(1. RIB)
RIBLP    EQU   *
         L     R5,RIBNRIBE  NO. OF RIBE'S FOR THIS RIB
         LH    R10,RIBVLEN
         LA    R8,0(R2,R7)     ADDR. OF RIBVAR
         LA    R10,0(R10,R8)   ADDR. OF 1. RIBE
RIBELP   EQU   *
         SR    R15,R15
         IC    R15,RIBRNMLN
         BCTR  R15,0
         EX    R15,CLCEXRIB
         BNE   NOSEND
         MVC   WTO(LENMSG1X),MSG01X
         MVC   WTO+36(44),DSNAME
         MVC   WTO+12(8),RIBEJBNM
         TM    RIBESFLG,RIBESTAT
         BNO   TXTOK
         MVC   WTO+22(9),=CL9'OWNS'
TXTOK    EQU   *
         LA    R1,WTO
         BAL   R14,WTOROUT
         TM    RIBESFLG,RIBESTAT
         BNO   NOSEND
         BAL   R14,CHKASCB
NOSEND   LA    R10,0(R3,R10)   GET ADDR. OF NEXT RIBE
         BCT   R5,RIBELP
NXTRIB   EQU   *
         LR    R7,R10
         BCT   R4,RIBLP
MSGSW    B     NOFMSG
         B     RETURN
CHKASCB  EQU   *
         ST    R14,SAVE14
         L     R1,16
         L     R1,X'22C'(R1)  ADDR. OF ASVT
         LA    R9,X'210'(R1)  ADDR. OF 1. ENTRY
         L     R11,X'204'(R1)  NUMBER OF ASCB'S
NXTASCB  TM    0(R9),X'80'     ASID ASSIGNED?
         BO    INCRASCB
         L     R1,0(R9)      GET ASCB-ADDR.
         L     R6,X'3C'(R1)   GET ADDR. OF TSB
         LTR   R6,R6     TSO?
         BZ    INCRASCB
         L     R6,X'B0'(R1)   GET ASCBJBNI
         LTR   R6,R6
         BZ    INCRASCB
         CLC   0(8,R6),WTO+12
         BNE   INCRASCB
         MVC   S1USER(7),WTO+12
         MVC   S2USER(7),WTO+12
         MVC   SENDCMD,SEND1
         LA    R1,SENDCMD
         SVC   249
         STIMER WAIT,BINTVL=BINTVL
         MVC   SENDCMD,SEND2
         LA    R1,SENDCMD
         SVC   249
RETASCB  L     R14,SAVE14
         BR    R14
INCRASCB EQU   *
         LA    R9,4(R9)   ADDR. OF NEXT ENTRY
         BCT   R11,NXTASCB
         B     RETASCB
         EJECT
***********************************************************************
*                                                                     *
*      WTO-NACHRICHTENAUSGABE.                                        *
*                                                                     *
***********************************************************************
         SPACE 3
WTOROUT  EQU   *
         L     R11,SAVER11
         ST    R14,SAVE14
         MVI   MSGSW+1,X'00'
         L     R0,REG4
         C     R0,=CL4'ROSC'
         BNE   NOROS
         STM   R14,R12,12(R13)                   SAVE ALL REGS IN SA
*
*              NOW WE CAN ADDRESS DUMMYSECTION IN XMON
*
         LH    R0,0(R1)      LOAD LENGTH OF WTO
         SH    R0,=H'4'      DECREMENT BY 4
         STC   R0,3(R1)      INSERT LENGTH TO MESSAGE FOR USE BY ROSCOE
         LA    R0,3(R1)      LOAD MESSAGE ADDRESS
         L     R13,4(R13)    R13 --> SA IN XMON
         ST    R0,76(R13)    STORE IT IN DYN AREA OF XMON = INAREA
         OI    76(R13),X'80' SET HIGHORDER BIT ON
         L     R15,100(R13)  LOAD ROSCOE-CODE <<OUTCODE>>
         LA    R1,76(R13)    LOAD PARAMETER REGISTER
         L     R13,4(R13)    R13 --> SA IN ROSCOE
         L     R14,12(R13)   LOAD RETURNADDRESS
         LM    R2,R12,28(R13)                    LOAD REMAINDER
         BR    R14           RETURN DIRECT TO ROSCOE
NOROS    EQU   *
         C     R0,=CL4'TSO'
         BNE   DOWTO
         LH    R0,0(R1)
         SH    R0,=H'4'
         LA    R1,4(R1)
         SVC   93             TPUT
         L     R14,SAVE14
         BR    R14
DOWTO    EQU   *
         WTO   MF=(E,(1))
         L     R14,SAVE14
         BR    R14
RETURN   EQU   *
         L     R3,TABAD
         FREEMAIN R,LV=102400,A=(R3)
         XRETURN ,R
CHKCODE  EQU   *
         CH    R15,=H'4'
         BNE   CHK8
NOFMSG   MVC   WTO(LENMSG02),MSG02
ERRMSG   LA    R1,WTO
         BAL   R14,WTOROUT
         B     RETURN
CHK8     EQU   *
         CH    R15,=H'8'
         BNE   ERROR
         MVC   WTO(LENMSG11),MSG11
         B     ERRMSG
ERROR    EQU   *
         MVC   WTO(LSCANMSG),SCANMSG
         B     ERRMSG
MSG01X   WTO   'DSNMSG1           WAITS FOR DSN 01234567890123456789012*
               345678901234567890123',                                 *
               MF=L,MCSFLAG=(REG0)
LENMSG1X EQU   *-MSG01X
SCANMSG  WTO   'DSNMSG2 ERROR ENCOUNTERED IN GQSCAN-FUNCTION',         *
               MF=L,MCSFLAG=(REG0)
LSCANMSG EQU   *-SCANMSG
MSG02    WTO   'DSNMSG3 NO CONFLICTS ON SPECIFIED DSNAME',             *
               MF=L,MCSFLAG=(REG0)
LENMSG02 EQU   *-MSG02
MSG11    WTO   'XQCB011 TABLE OVERFLOW FOR GQSCAN-FUNCTION',           *
               MF=L,MCSFLAG=(REG0)
LENMSG11 EQU   *-MSG11
CLCEXRIB CLC   DSNAME(0),RIBRNAME
SYSDSN   DC    CL8'SYSDSN'
         DS    0F
SEND1    DC    H'100,0'
         DC    C' SE ''SIE BLOCKIEREN DIE DATEI '
DSNAME   DC    CL44' '
         DC    C''',USER=('
S1USER   DC    CL7' '
         DC    CL30'),NOW'
         DS    0F
SEND2    DC    H'100,0'
         DC    C' SE ''BITTE GEBEN SIE SIE FREI ODER MACHEN SIE LOGOFF'*
               ',USER=('
S2USER   DC    CL7' '
         DC    CL50'),NOW'
BINTVL   DC    F'100'
SAVE14   DS    F
SAVER11  DS    F
TABAD    DS    F
WTO      DS    CL120         BEREICH FUER NACHRICHTEN
FULLWD   DS    F
SENDCMD  DS    CL100
         XPARM
         ISGRIB
         END   DSNMSG
./ ADD NAME=FX
FX       START
         REG
         XSAVE R12,SVA1,FX
         SR    R10,R10
         CLC   4(4,R1),=XL4'00'
         BNE   NOEDIT
         L     R3,X'28'(R1)  POINT TO CPPL
         L     R8,16
         L     R8,0(R8)
         L     R8,4(R8)
         L     R8,X'B4'(R8)
         L     R8,X'108'(R8)
         SPACE
         MVC   PTRBUF,X'28'(R1)   MOVE PTR TO COMMAND BUFFER
         MVC   PTRUPT,X'210'(R1)  MOVE PTR TO CPPLUPT
         ST    R8,PTRPSCB         MOVE PTR TO PSCB
         MVC   PTRECT,X'214'(R1)  MOVE PTR TO CPPLECT
         LA    R9,PTRBUF
         SPACE
         B     EDIT
NOEDIT   EQU   *
         LR    R9,R1
         L     R3,0(R1)   POINT TO CPPL
         L     R8,8(R1)
EDIT     EQU   *
         LH    R4,0(R3)    LENGTH
         SH    R4,=H'5'   REDUCE FOR OC
         LA    R5,4(R3)    SKIP LENGTH FIELD
         EX    R4,OCEX1
         LH    R4,2(R3)   LOAD OFFSET
         LA    R4,4(R4,R3)   POINT TO PROGR.-NAME
         LR    R7,R4
         SR    R5,R5
         LA    R6,8    SET MAX. LENGTH
SCAN     EQU   *
         CLI   0(R4),C','
         BE    ENDSCAN
         CLI   0(R4),C' '
         BE    ENDSCAN
         CLI   0(R4),X'00'
         BE    ENDSCAN
         LA    R4,1(R4)
         LA    R5,1(R5)
         BCT   R6,SCAN
SYNERR   EQU   *
         TPUT  MSG1,70
         LA    R10,16
RETURN   EQU   *
         XRETURN (R10)
ENDSCAN  EQU   *
         LTR   R5,R5
         BZ    SYNERR
         BCTR  R5,0
         EX    R5,MVCEX1
         LH    R4,0(R3)
         LH    R5,2(R3)
         SR    R4,R5
         SH    R4,=H'5'
         CH    R4,=H'123'
         BH    TOOLONG
         EX    R4,MVCEX2
         BLDL  0,BLDLIST
         LTR   R15,R15
         BZ    LINK
         MVC   NTFND+15(8),EPLOC
         TPUT  NTFND,70
         LA    R10,16
         B     RETURN
TOOLONG  EQU   *
         TPUT  LENERR,50
         LA    R10,16
         B     RETURN
LINK     EQU   *
         CLC   EPLOC(8),=CL8'XCMD'
         BE    TSTOPER
         CLC   EPLOC(8),=CL8'XALTR'
         BE    TSTOPER
         CLC   EPLOC(8),=CL8'XOPER'
         BNE   GOLINK
TSTOPER  EQU   *
         TM    16(R8),X'80'
         BO    GOLINK
         TPUT  NAUTH,70
         LA    R10,16
         B     RETURN
NAUTH    DC    CL70'FX00002 COMMAND NOT AUTHORIZED FOR THIS USER'
GOLINK   EQU   *
         LA    R1,PARMAREA
         LINK  EPLOC=EPLOC
         LR    R10,R15
         B     RETURN
MVCEX1   MVC   EPLOC+1(0),0(R7)
MVCEX2   MVC   TEXT(0),0(R7)
OCEX1    OC    0(0,R5),TEXT
PARMAREA DS    0CL128
REG4     DC    CL4'TSO'
TEXT     DC    CL124' '
BLDLIST  DS    0CL62
         DC    X'00010058'
EPLOC    DC    CL8'X'
         DS    CL50
MSG1     DC    CL70'XCNTRL1 SYNTAX ERROR'
NTFND    DC    CL70'XCNTRL3 MODULE 12345678 NOT FOUND'
LENERR   DC    CL50'FX00001 ERROR - LENGTH EXCEEDS 124 CHARACTERS'
         SPACE
PTRBUF   DS    F
PTRUPT   DS    F
PTRPSCB  DS    F
PTRECT   DS    F
         END
./ ADD NAME=HELP
         TITLE 'XHELP                            X-COMMAND HELP'
HELP     CSECT
         SPACE 3
***********************************************************************
*                                                                     *
*      PROGRAM-ID. HELP.                                              *
*      AUTHOR. EHNERT.                                                *
*      INSTALLATION. BAYER AG, LEVERKUSEN, RECHENZENTRUM.             *
*      DATE-WRITTEN. 3. 4. 1975.                                      *
*      REMARKS.                                                       *
*                                                                     *
*          DAS X-COMMAND 'HELP' GIBT INFORMATIONEN UEBER DAS ALS      *
*          PARAMETER SPEZIFIZIERTE X-COMMAND AUS.                     *
*                                                                     *
*          ZUSAETZLICH KOENNEN FOLGENDE PARAMETER SPEZIFIZIERT        *
*          WERDEN:                                                    *
*          A) 'HISTORY' / 'H': ES WERDEN INFORMATIONEN UEBER DIE      *
*          HISTORY,                                                   *
*          B) 'SYNTAX' / 'S': INFORMATIONEN UEBER DIE SYNTAX,         *
*          C) 'FUNCTION' / 'F': INFORMATIONEN UEBER DIE FUNCTION,     *
*          D) 'ALL' / 'A': INFORMATIONEN UEBER DIE HISTORY, SYNTAX    *
*          UND FUNCTION DES X-COMMANDS AUSGEGEBEN.                    *
*          NEBEN DER ANGABE DER PARAMETER IN KURZFORM KOENNEN         *
*          DIE PARAMETER IN FOLGENDER ART SPEZIFIZIERT WERDEN:        *
*          WIRD KEINE DER ANGABEN A) - D) GETROFFEN, SO WIRD B)       *
*          STANDARDMAESSIG ANGENOMMEN.                                *
*                                                                     *
*          WIRD KEIN COMMAND NAME ANGEGEBEN, SO WIRD EINE LISTE       *
*          ALLER VERFUEGBAREN COMMANDS AUSGEGEBEN.                    *
*                                                                     *
***********************************************************************
         EJECT
***********************************************************************
*                                                                     *
*      BEGINN DER VERARBEITUNG.                                       *
*                                                                     *
***********************************************************************
         SPACE 3
*
*      SICHERN DER REGISTER,
*      SPEICHERPLATZANFORDERUNG FUER ARBEITSBEREICHE,
*      ZUORDNUNG DER BASISREGISTER.
*
         SPACE 1
         XSAVE R12,,HELP,ABERL
         SPACE 1
         LR    R11,R1        BASISREG. FUER DSECT PARMAREA INITIALIS.
         USING PARMAREA,R11  BASISREG. FUER DSECT PARMAREA ZUORDNEN
         USING ABER,R13      BASISREG. FUER DSECT ABER ZUORDNEN
         EJECT
*
*      INITIALISIERUNG DER SPEICHER.
*
         SPACE 1
         MVC   DIRECTRY(DCBLEN),DCBDIRHL DCB FUER DIRECTORY UEBERT.
         MVC   INFO(DCBLEN1),DCBHELPL DCB FUER INFO-DATEI UEBERT.
         LA    R3,DIRECTRY   ADRESSEN DER
         LA    R2,INFO           DCBS LADEN
         STM   R2,R3,DCBADDR1    UND SPEICHERN
         MVI   DCBADDR1,X'80' OPTION BYTES
         MVI   DCBADDR2,X'80'    SETZEN
         MVC   HBYTE(3),=XL3'0' FLAG BYTES LOESCHEN
         MVC   CMDNAME,=CL8' ' COMMAND NAME LOESCHEN
         EJECT
***********************************************************************
*                                                                     *
*      VERARBEITUNG DER EINGABEPARAMETER.                             *
*                                                                     *
***********************************************************************
         SPACE 3
         CALL  LUALLOC,(JCL,JCLLL,JCLMSG),VL
         CLI   TEXT+4,C' '   PARAMETER ANGEGEBEN ?
         BE    OPENDRKT      NEIN, VERZWEIGEN
         LA    R4,TEXT+4     ANFANGSADRESSE LADEN
         SR    R5,R5         LAENGENZAEHLER LOESCHEN
         LA    R8,PARMENDE   ENDADRESSE DES PARAMETERBEREICHS LADEN
         SPACE 2
*
*      VERARBEITUNG DES COMMAND NAME.
*
         SPACE 1
NXTCMDN  EQU   *
         LA    R4,1(R4)      ADRESSE DES NAECHSTEN BYTE LADEN
         CR    R4,R8         PARAMETERBEREICH UEBERSCHRITTEN ?
         BNL   FEHLPARM      JA, VERZWEIGEN
         CLI   0(R4),C','    ENDE DES COMMAND NAME ERREICHT ?
         BE    ENDCMDN       JA, VERZWEIGEN
         CLI   0(R4),C' '    ENDE DER PARAMETERKETTE ERREICHT ?
         BE    ENDCMDN       JA, VERZWEIGEN
         LA    R5,1(R5)      LAENGENZAEHLER ERHOEHEN
         B     NXTCMDN       VERZWEIGEN
         SPACE 1
ENDCMDN  EQU   *
         C     R5,=F'8'      LAENGE > 8 ?
         BH    FEHLPARM      JA, VERZW. ZUR FEHLERROUTINE
         LTR   R5,R5         LAENGE = 0 ?
         BZ    FEHLPARM      JA, VERZW. ZUR FEHLERROUTINE
         BCTR  R5,0          R5 UM EINS VERMINDERN
         EX    R5,MOVECMDN   VERZ. ZUM UEBERTR. DES COMMAND NAME
         CLI   0(R4),C','    NOCH WEITERE PARAMETER ANGEGEBEN ?
         BE    INFOPARM      JA, VERZWEIGEN
         B     ENDPARM       VERZW. ZUM ABSCHLUSS DER PARAM.-VERARB.
         SPACE 1
MOVECMDN EQU   *
         MVC   CMDNAME(0),TEXT+5 COMMAND NAME UEBERTRAGEN
         EJECT
*
*      VERARBEITUNG DER INFORMATION-PARAMETER.
*
         SPACE 1
INFOPARM EQU   *
         SR    R8,R8         LAENGE FUER MVCPARM
         CLI   1(R4),C'A'    PARAMETER = ALL ?
         BE    TESTA         JA, VERZWEIGEN
         CLI   1(R4),C'H'    PARAMETER = HISTORY ?
         BE    TESTH         JA, VERZWEIGEN
         CLI   1(R4),C'S'    PARAMETER = SYNTAX ?
         BE    TESTS         JA, VERZWEIGEN
         CLI   1(R4),C'F'    PARAMETER = FUNCTION ?
         BNE   FEHLPARM      NEIN, VERZW. ZUR FEHLERROUTINE
         SPACE 2
*
*      PRUEFUNG AUF GUELTIGKEIT.
*
         SPACE 1
TESTF    EQU   *
         LA    R5,FBYTE      ADRESSE DES FLAG BYTES LADEN
         LA    R6,CONFUNC1   ADRESSE DER KONSTANTEN LADEN
         LA    R7,7          LAENGE FUER CLCPARM
         B     TESTPARM      VERZWEIGEN
         SPACE 1
TESTS    EQU   *
         LA    R5,SBYTE      ADRESSE DES FLAG BYTES LADEN
         LA    R6,CONSYNT1   ADRESSE DER KONSTANTEN LADEN
         LA    R7,5          LAENGE FUER CLCPARM
         B     TESTPARM      VERZWEIGEN
         SPACE 1
TESTH    EQU   *
         LA    R5,HBYTE      ADRESSE DES FLAG BYTES LADEN
         LA    R6,CONHIST1   ADRESSE DER KONSTANTEN LADEN
         LA    R7,6          LAENGE FUER CLCPARM
         B     TESTPARM      VERZWEIGEN
         SPACE 1
TESTA    EQU   *
         LA    R5,HBYTE      ADRESSE DER FLAG BYTES LADEN
         LA    R6,CONALL     ADRESSE DER KONSTANTEN LADEN
         LA    R7,2          LAENGE FUER CLCPARM
         LR    R8,R7         LAENGE FUER MVCPARM
         EJECT
TESTPARM EQU   *
         CLI   2(R4),C' '    PARAMERTER GUELTIG ?
         BE    SETBYTE       JA, VERZWEIGEN
         CLI   2(R4),C','    PARAMERTER GUELTIG ?
         BE    SETBYTE       JA, VERZWEIGEN
         EX    R7,CLCPARM    VERZW. ZUM PRUEFEN DES PARAMETERS
         BNE   FEHLPARM      VERZW., WENN PARAMETER UNGUELTIG
SETBYTE  EQU   *
         EX    R8,MVCPARM    VERZW. ZUM SETZEN DER FLAG BYTES
         LA    R4,2(R4)      ADRESSE DES NAECHSTEN BYTE LADEN
PARMLOOP EQU   *
         CLI   0(R4),C' '    ENDE DER PARAMETERKETTE ?
         BE    OPENINFO      JA, VERZWEIGEN
         CLI   0(R4),C','    ENDE DES PARAMETERS ?
         BE    INFOPARM      JA, VERZWEIGEN
         LA    R4,1(R4)      ADRESSE DES NAECHSTEN BYTE LADEN
         B     PARMLOOP      VERZWEIGEN
         SPACE 2
*
*      ABSCHLUSS DER PARAMETERVERARBEITUNG.
*
         SPACE 1
ENDPARM  EQU   *
         MVI   SBYTE,X'FF'   DEFAULT (SYNTAX) SPEZIFIZIEREN
         B     OPENINFO      VERZWEIGEN
         SPACE 2
CLCPARM  EQU   *
         CLC   1(0,R4),0(R6) LANGER PARAMETER GUELTIG ?
MVCPARM  EQU   *
         MVC   0(0,R5),=X'FFFFFF' FLAG BYTE(S) SETZEN
         EJECT
***********************************************************************
*                                                                     *
*      AUSGABE DER INFORMATIONEN.                                     *
*                                                                     *
***********************************************************************
         SPACE 3
*
*      INFO-DATEI EROEFFNEN.
*
         SPACE 1
OPENINFO EQU   *
         LA    R1,DCBADDR1   ADRESSE DER DCB-ADRESSE LADEN
         SVC   19            VERZW. ZUM EROEFFNEN DER DATEI
         SPACE 2
*
*      MEMBER ENTRY AUFSUCHEN.
*
         SPACE 1
         LA    R1,INFO       ADRESSE DES DCB LADEN
         TM    48(R1),X'10'
         BNO   NOHELPAV
         LA    R0,CMDNAME    ADRESSE DES COMMAND NAME LADEN
         FIND  (R1),(R0),D   AUFSUCHEN DES ENTRY
         LTR   R15,R15       RETURN CODE = 0 ?
         BNZ   NOHELPAV      NEIN, VERZWEIGEN
         EJECT
*
*      ROUTINE BEI ANGEFORDERTER FUCTION INFORMATION.
*
         SPACE 1
FUNCINFO EQU   *
         CLI   FBYTE,X'FF'   FLAG BYTE GESETZT ?
         BNE   SYNTINFO      NEIN, VERZWEIGEN
         MVI   FBYTE,X'00'   FLAG BYTE LOESCHEN
         LA    R4,CONFUNC1   ADRESSEN DER
         LA    R5,CONFUNC2       KONSTANTEN LADEN
         B     GETWTOLP      VERZW. ZUR NACHRICHTENAUSGABE
         SPACE 2
*
*      ROUTINE BEI ANGEFORDERTER SYNTAX-INFORMATION.
*
         SPACE 1
SYNTINFO EQU   *
         CLI   SBYTE,X'FF'   FLAG BYTE GESETZT ?
         BNE   HISTINFO      NEIN, VERZWEIGEN
         MVI   SBYTE,X'00'   FLAG BYTE LOESCHEN
         LA    R4,CONSYNT1   ADRESSEN DER
         LA    R5,CONSYNT2       KONSTANTEN LADEN
         B     GETWTOLP      VERZW. ZUR NACHRICHTENAUSGABE
         SPACE 2
*
*      ROUTINE BEI ANGEFORDERTER HISTORY-INFORMATION.
*
         SPACE 1
HISTINFO EQU   *
         MVI   HBYTE,X'00'   FLAG BYTE LOESCHEN
         LA    R4,CONHIST1   ADRESSEN DER
         LA    R5,CONHIST2       KONSTANTEN LADEN
         EJECT
*
*      AUFBEREITEN DER UEBERSCHRIFT.
*
         SPACE 1
GETWTOLP EQU   *
         MVC   WTO(LENMSG03),MSG03 NACHRICHTENZEILE UEBERTRAGEN
         MVC   WTO+12(8),0(R4) KONSTANTE 1 UEBERTRAGEN
         MVC   WTO+24(8),CMDNAME COMMAND NAME UEBERTRAGEN
         MVI   FNDBYTE,X'00' FLAG BYTE LOESCHENN
         SPACE 2
*
*      AUFSUCHEN DES INFO-ENTRY.
*
         SPACE 1
SRCHINFO EQU   *
         BAL   R14,READINFO  VERZW. ZUM LESEN EINES BLOCKS
SRCHLOOP EQU   *
         CLI   0(R2),X'FF'   ENDE DER DATEI ERREICHT ?
         BE    CLOSINFO      JA, VERZWEIGEN
         CLC   0(11,R2),0(R5) INFORMATION-ENTRY GEFUNDEN ?
         BE    GETLPOK       JA, VERZWEIGEN
         LA    R2,80(R2)     ADRESSE DES NAECHSTEN SATZES LADEN
         BCT   R3,SRCHLOOP   VERZWEIGEN
         B     SRCHINFO      VERZWEIGEN
         EJECT
*
*      AUSGABE EINZELNER NACHRICHTENZEILEN.
*
         SPACE 1
GETINFO  EQU   *
         BAL   R14,READINFO  VERZW. ZUM LESEN EINES BLOCKS
GETLOOP  EQU   *
         CLI   0(R2),X'FF'   ENDE DER DATEI ERREICHT ?
         BE    CLOSINFO      JA, VERZWEIGEN
         CLC   0(2,R2),=C'%%' ENDE DER INFORMATION ?
         BE    CLOSINFO      JA, VERZWEIGEN
         MVC   WTO+12(64),0(R2) ZEILE UEBERTRAGEN
         MVI   FNDBYTE,X'FF' FLAG BYTE SETZEN
GETLPOK  EQU   *
         L     R0,REG4       UCM-ID DES AUFRUFERS LADEN
         BAL   R14,WTOROUT
         LA    R2,80(R2)     ADRESSE DES NAECHSTEN SATZES LADEN
         MVC   WTO(LENMSG04),MSG04 NACHRICHTENZEILE UEBERTRAGEN
         BCT   R3,GETLOOP    VERZWEIGEN
         B     GETINFO       VERZWEIGEN
         SPACE 2
*
*      SCHLIESSEN DER INFO-DATEI.
*
         SPACE 1
CLOSINFO EQU   *
         CLI   FNDBYTE,X'FF' INFORMATION GEFUNDEN ?
         BE    *+22          JA, VERZWEIGEN
         MVC   WTO(LENMSG06),MSG06 NACHRICHTENZEILE UEBERTRAGEN
         MVC   WTO+23(8),0(R4) KONSTANTE 1 UEBERTRAGEN
         MVC   WTO+35(8),CMDNAME COMMAND NAME UEBERTRAGEN
         CLC   WTO(LENMSG04),MSG04 LEERZEILE ?
         BE    CLOSE         JA, VERZWEIGEN
         L     R0,REG4       UCM-ID DES AUFRUFERS LADEN
         BAL   R14,WTOROUT
CLOSE    EQU   *
         LA    R1,DCBADDR1   ADRESSE DER DCB-ADRESSE LADEN
         SVC   20            VERZW. ZUM SCHLIESSEN DER DATEI
         SPACE 1
         CLC   HBYTE(3),=XL3'0' WEITERE INFORMATION ANGEFORDERT ?
         BE    ENDE          NEIN, VERZWEIGEN
         EJECT
*
*      AUSGABE DER NACHRICHTEN MIT REPLY.
*
         SPACE 1
WTORLOOP EQU   *
         L     R0,REG4       UCM-ID DES AUFRUFERS LADEN
         C     R0,=CL4'TSO'
         BE    OPENINFO
         XC    ECB,ECB       EVENT CONTROL BLOCK LOESCHEN
         LA    R2,ECB        ADRESSE DES ECB LADEN
         LA    R3,REPLY      ADRESSE DES REPLY LADEN
         MVC   WTO(LENMSG08),MSG08 NACHRICHTENZEILE UEBERTRAGEN
         WTOR  ,(R3),1,(R2),                                           *
               MF=(E,WTO)
         SPACE 1
         WAIT  ECB=ECB
         CLI   REPLY,C'Y'    REPLY = YES ?
         BE    OPENINFO      JA, VERZWEIGEN
         CLI   REPLY,C'N'    REPLY = NO ?
         BE    ENDE          JA, VERZWEIGEN
         B     WTORLOOP      VERZWEIGEN
         EJECT
***********************************************************************
*                                                                     *
*      EINEN BLOCK LESEN.                                             *
*                                                                     *
***********************************************************************
         SPACE 3
READINFO EQU   *
         ST    R14,SAVE1R14  RUECKSPRUNGADRESSE SPEICHERN
         MVI   INFOBLK1,X'FF'          BEREICH FUER
         MVC   INFOBLK1+1,INFOBLK1         EINGABEBLOCK
         MVC   INFOBLK2+1(199),INFOBLK2    INITIALISIEREN
         XC    DECB,DECB     DATA EVENT CONTROL BLOCK LOESCHEN
         LA    R2,DECB       ADRESSE DES DECB LADEN
         LA    R3,INFO       ADRESSE DES DCB LADEN
         LA    R6,INFOBLK1   ADRESSE DES EINGABEBEREICHS LADEN
         READ  (R2),SF,(R3),(R6),                                      *
               'S',,,,MF=E
         SPACE 1
         LA    R1,DECB       ADRESSE DES DECB LADEN
         CHECK (R1)          CHECK FOR COMPLETION
         SPACE 1
         LA    R2,INFOBLK1   ADRESSE DES EINGABEBEREICHS LADEN
         LA    R3,5          LOOP COUNTER INITIALISIEREN
         L     R14,SAVE1R14  RUECKSPRUNGADRESSE LADEN
         BR    R14           VERZWEIGEN
         EJECT
***********************************************************************
*                                                                     *
*      ABSCHLUSSROUTINEN.                                             *
*                                                                     *
***********************************************************************
         SPACE 3
*
*      SPEICHERPLATZFREIGABE,
*      REINITIALISIERUNG DER REGISTER UND
*      RUECKSPRUNG ZUM AUFRUFENDEN PROGRAMM.
*
         SPACE 1
ENDE     EQU   *
         XRETURN ,R
         EJECT
***********************************************************************
*                                                                     *
*      FEHLERROUTINEN.                                                *
*                                                                     *
***********************************************************************
         SPACE 3
*
*      ROUTINE BEI FEHLER IN DER PARAMETERKETTE.
*
         SPACE 1
FEHLPARM EQU   *
         MVC   WTO,MSG07
         L     R0,REG4       UCM-ID DES AUFRUFERS LADEN
         BAL   R14,WTOROUT
         B     ENDE          VERZWEIGEN
         SPACE 2
*
*      ROUTINE BEI FIND- UND READ-FEHLER.
*
         SPACE 1
NOHELPAV EQU   *
         MVC   HBYTE(3),=XL3'0' FLAG BYTES LOESCHEN
         MVI   FNDBYTE,X'FF' FLAG BYTE SETZEN
         MVC   WTO(LENMSG05),MSG05 NACHRICHTENZEILE UEBERTRAGEN
         MVC   WTO+31(8),CMDNAME COMMAND NAME UEBERTRAGEN
         B     CLOSINFO      VERZWEIGEN
         EJECT
***********************************************************************
*                                                                     *
*      AUSGABE DER COMMAND-NAMEN.                                     *
*                                                                     *
***********************************************************************
         SPACE 3
*
*      DIRECTORY EROEFFNEN.
*
         SPACE 1
OPENDRKT EQU   *
         LA    R1,DCBADDR2   ADRESSE DER DCB-ADRESE LADEN
         SVC   19            VERZW. ZUM EROEFFNEN DER DATEI
         TM    DIRECTRY+48,X'10'
         BNO   NOHELPAV
         SPACE 1
         LA    R14,GETBLKOK  VERZWEIGADRESSE LADEN
         ST    R14,SAVE1R14      UND SPEICHERN
         MVC   WTO,MSG01
         L     R0,REG4       UCM-ID DES AUFRUFERS LADEN
         BAL   R14,WTOROUT
         SPACE 2
*
*      DIRECTORY LESEN UND NACHRICHTEN AUSGEBEN.
*
         SPACE 1
GETDRKBL EQU   *
         GET   DIRECTRY      EINEN BLOCK LESEN
         LR    R10,R1        ADRESSE DES DIRECTORY-BLOCKS LADEN
         LH    R9,0(R10)     LAENGE DES DIRECTORY-BLOCKS LADEN
         AR    R9,R10        ENDADRESSE DES DIRECTORY-BLOCKS
         LA    R10,2(R10)    ADRESSE DES ERSTEN ENTRY LADEN
         L     R14,SAVE1R14  VERZWEIGADRESSE LADEN
         BR    R14               UND VERZWEIGEN
GETBLKOK EQU   *
         MVC   WTO(LENMSG01),MSG01 NACHRICHTENZEILE UEBERTRAGEN
         LA    R14,MVCLPOK   NEUE VERZWEIGADRESSE LADEN
         ST    R14,SAVE1R14      UND SPEICHERN
WTOLOOP  EQU   *
         MVC   WTO+12(54),WTO+11 NACHRICHTENZEILE LOESCHEN
         LA    R8,WTO+12     UEBERTRAGUNGSADRESSE LADEN
         LA    R7,6          LOOP COUNTER INITIALISIEREN
         EJECT
MVCLOOP  EQU   *
         CLI   0(R10),X'FF'  ENDE DER DIRECTORY ERREICHT ?
         BE    CLOSDRKT      JA, VERZWEIGEN
         MVC   0(8,R8),0(R10) MEMBER NAME UEBERTRAGEN
         LA    R8,9(R8)      NEUE UEBERTRAGUNGSADRESSE LADEN
         NI    11(R10),X'1F' LAENGENFELD MODIFIZIEREN
         SR    R6,R6         R6 LOESCHEN
         IC    R6,11(R10)    LAENGENFELD LADEN
         SLA   R6,1          LAENGE IN BYTES UMRECHNEN
         LA    R6,12(R6)     LAENGE DES ENTRY BERECHNEN
         AR    R10,R6        ADRESSE DES NAECHSTEN MEMBER NAME
         CR    R10,R9        ENDE DES DIRECTORY-BLOCKS ERREICHT ?
         BE    GETDRKBL      JA, VERZWEIGEN
MVCLPOK  EQU   *
         BCT   R7,MVCLOOP    VERZWEIGEN
         SPACE 1
         L     R0,REG4       UCM-ID DES AUFRUFERS LADEN
         BAL   R14,WTOROUT
         B     WTOLOOP       VERZWEIGEN
         SPACE 2
*
*      DIRECTORY SCHLIESSEN.
*
         SPACE 1
CLOSDRKT EQU   *
         LA    R1,DCBADDR2   ADRESSE DER DCB-ADRESSE LADEN
         SVC   20            VERZW. ZUM SCHLIESSEN DER DATEI
         SPACE 1
         LA    R9,WTO+12     UEBERTRAGUNGSADRESSE LADEN
         CR    R8,R9         IST NOCH EINE ZEILE AUSZUGEBEN ?
         BE    DIRENDE       NEIN, VERZWEIGEN
         L     R0,REG4       UCM-ID DES AUFRUFERS LADEN
         BAL   R14,WTOROUT
DIRENDE  EQU   *
         MVC   WTO,MSG02
         L     R0,REG4       UCM-ID DES AUFRUFERS LADEN
         BAL   R14,WTOROUT
         B     ENDE          VERZWEIGEN
         SPACE 3
WTOROUT  EQU   *
         ST    R14,SAVE14
         C     R0,=CL4'ROSC'
         BNE   NOROS
         STM   R14,R12,12(R13)                   SAVE ALL REGS IN SA
*
*              NOW WE CAN ADDRESS DUMMYSECTION IN XMON
*
         LA    R1,WTO
         LH    R0,0(R1)      LOAD LENGTH OF WTO
         SH    R0,=H'4'      DECREMENT BY 4
         STC   R0,3(R1)      INSERT LENGTH TO MESSAGE FOR USE BY ROSCOE
         LA    R0,3(R1)      LOAD MESSAGE ADDRESS
         L     R13,4(R13)    R13 --> SA IN XMON
         ST    R0,76(R13)    STORE IT IN DYN AREA OF XMON = INAREA
         OI    76(R13),X'80' SET HIGHORDER BIT ON
         L     R15,100(R13)  LOAD ROSCOE-CODE <<OUTCODE>>
         LA    R1,76(R13)    LOAD PARAMETER REGISTER
         L     R13,4(R13)    R13 --> SA IN ROSCOE
         L     R14,12(R13)   LOAD RETURNADDRESS
         LM    R2,R12,28(R13)                    LOAD REMAINDER
         BR    R14           RETURN DIRECT TO ROSCOE
NOROS    EQU   *
         C     R0,=CL4'TSO'
         BNE   DOWTO
         LH    R0,WTO
         SH    R0,=H'4'
         LA    R1,WTO+4
         SVC   93    TPUT
         L     R14,SAVE14
         BR    R14
DOWTO    EQU   *
         WTO   MF=(E,WTO)
         L     R14,SAVE14
         BR    R14
         EJECT
***********************************************************************
*                                                                     *
*      REGISTER EQUATES.                                              *
*                                                                     *
***********************************************************************
         SPACE 3
R0       EQU   0             MACRO- UND-PARAMETER REGISTER
R1       EQU   1             MACRO- UND-PARAMETER REGISTER
R2       EQU   2             ARBEITSREGISTER
R3       EQU   3             ARBEITSREGISTER
R4       EQU   4             ARBEITSREGISTER
R5       EQU   5             ARBEITSREGISTER
R6       EQU   6             ARBEITSREGISTER
R7       EQU   7             ARBEITSREGISTER
R8       EQU   8             ARBEITSREGISTER
R9       EQU   9             ARBEITSREGISTER
R10      EQU   10            ARBEITSREGISTER
R11      EQU   11            BASISREG. FUER DSECT PARMAREA
R12      EQU   12            BASISREG. FUER CSECT HELP
R13      EQU   13            BASISREG. FUER DSECT ABER
R14      EQU   14            RUECKSPRUNGADRESSEN
R15      EQU   15            CSECT-ADRESSEN UND RETURN CODES
         EJECT
***********************************************************************
*                                                                     *
*      DEFINITION DER KONSTANTEN-SPEICHER.                            *
*                                                                     *
***********************************************************************
         SPACE 3
CONHIST1 DC    C'HISTORY '
CONSYNT1 DC    C'SYNTAX  '
CONFUNC1 DC    C'FUNCTION'
CONALL   DC    C'ALL'
CONHIST2 DC    C'%%HISTORY. '
CONSYNT2 DC    C'%%SYNTAX.  '
CONFUNC2 DC    C'%%FUNCTION.'
         SPACE 3
*
*      DCB FUER DIE DIRECTORY DER DATEI 'HELPLIB'.
*
         SPACE 1
DCBDIRHL DCB   DDNAME=XHELP,                                           *
               DSORG=PS,                                               *
               MACRF=(GL),                                             *
               RECFM=F,                                                *
               LRECL=256,                                              *
               BLKSIZE=256
DCBLEN   EQU   *-DCBDIRHL    LAENGE DES DCB
JCL      DC    CL80'DDNAME=XHELP,DSN=SYS1.XHELP,DISP=SHR'
JCLLL    DC    H'80'
JCLMSG   DS    CL240
         SPACE 3
*
*      DCB FUER DIE DATEI 'HELPLIB'.
*
         SPACE 1
DCBHELPL DCB   DDNAME=XHELP,                                           *
               DSORG=PO,                                               *
               MACRF=(R),                                              *
               RECFM=FB,                                               *
               LRECL=80,                                               *
               SYNAD=NOHELPAV,                                         *
               EODAD=CLOSINFO
DCBLEN1  EQU   *-DCBHELPL    LAENGE DES DCB
         EJECT
***********************************************************************
*                                                                     *
*      DEFINITION DER AUSGABENACHRICHTEN.                             *
*                                                                     *
***********************************************************************
         SPACE 3
MSG01    WTO   'XHELP01 THE FOLLOWING COMMANDS ARE AVAILABLE:          *
                      ',                                               *
               MF=L,MCSFLAG=(REG0)
LENMSG01 EQU   *-MSG01
         SPACE 1
MSG02    WTO   'XHELP02 FOR MORE HELP ENTER ''F X,HELP,HELP''',        *
               MF=L,MCSFLAG=(REG0)
         SPACE 1
MSG03    WTO   'XHELP03 FUNCTION OF ABCDEFGH',                         *
               MF=L,MCSFLAG=(REG0)
LENMSG03 EQU   *-MSG03
         SPACE 1
MSG04    WTO   'XHELP04                                                *
                                ',                                     *
               MF=L,MCSFLAG=(REG0)
LENMSG04 EQU   *-MSG04
         EJECT
MSG05    WTO   'XHELP05 HELP ABOUT COMMAND ABCDEFGH NOT AVAILABLE',    *
               MF=L,MCSFLAG=(REG0)
LENMSG05 EQU   *-MSG05
         SPACE 1
MSG06    WTO   'XHELP06 HELP ABOUT FUNCTION OF ABCDEFGH NOT AVAILABLE',*
               MF=L,MCSFLAG=(REG0)
LENMSG06 EQU   *-MSG06
         SPACE 1
MSG07    WTO   'XHELP07 INVALID PARAMETER LIST',                       *
               MF=L,MCSFLAG=(REG0)
         SPACE 1
MSG08    WTOR  'XHELP08 REPLY ''Y'' (YES) OR ''N'' (NO) TO CONTINUE',  *
               MF=L,MCSFLAG=(REG0)
LENMSG08 EQU   *-MSG08
         EJECT
***********************************************************************
*                                                                     *
*      DEFINITION DER ARBEITSBEREICHE.                                *
*                                                                     *
***********************************************************************
         SPACE 3
ABER     DSECT
         SPACE 2
*
*      ADRESSEN-SPEICHER.
*
         SPACE 1
SAVEAREA DS    18F           SAVEAREA FUER ALLGEMEINE REGISTER
SAVE1R14 DS    F             SPEICHER FUER RUECKSPRUNGADRESSEN
DCBADDR1 DS    F             ADRESSE DES DCB FUER INFO-DATEI
DCBADDR2 DS    F             ADRESSE DES DCB FUER DIRECTORY
         SPACE 2
*
*      ARBEITSSPEICHER.
*
         SPACE 1
INFO     DS    0F            DCB FUER DIE INFO-DATEI
         ORG   *+DCBLEN1
DIRECTRY DS    0F            DCB FUER DIE DIRECTORY
         ORG   *+DCBLEN
CMDNAME  DS    D             SPEICHER FUER COMMAND NAME
HBYTE    DS    C             FLAG BYTE FUER HISTORY
SBYTE    DS    C             FLAG BYTE FUER SYNTAX
FBYTE    DS    C             FLAG BYTE FUER FUNCTION
REPLY    DS    C             SPEICHER FUER REPLY
FNDBYTE  DS    C             FLAG BYTE FUER GEF. INFO.
ECB      DS    F             EVENT CONTROL BLOCK
         DS    0F            DATA EVENT
DECB     DS    CL20              CONTROL BLOCK
INFOBLK1 DS    CL200         SPEICHER FUER
INFOBLK2 DS    CL200             EINGABEBLOCK
         SPACE 2
*
*      NACHRICHTEN-BEREICHE.
*
         SPACE 1
WTO      DS    CL108
SAVE14   DS    F
         SPACE 1
ABERL    EQU   *-ABER        LAENGE DER ARBEITSBEREICHE
         EJECT
***********************************************************************
*                                                                     *
*      PARAMETERBEREICH.                                              *
*                                                                     *
***********************************************************************
         SPACE 3
         XPARM
PARMENDE EQU   *
         SPACE 3
         END   HELP
./ ADD NAME=IGC0023G
//Z223359S JOB (6685,359,1),CLASS=1,MSGCLASS=T,NOTIFY=Z223359
//        EXEC ASMFCL
//ASM.SYSLIB DD DSN=SYS1.MACLIB,UNIT=DISK,VOL=SER=DSR00T
//           DD DSN=SYS1.AMODGEN,DISP=SHR
//ASM.SYSIN DD *
         TITLE '*** SVC 237 - CROSS/MEMORY DATA XFER SVC'
*
*  THIS SVC IS USED TO SCHEDULE AN SRB THAT WILL TRANSFER THE
*  REQUESTED DATA (FROM 1 TO 4K BYTES) FROM ONE ADDRESS SPACE
*  TO ANOTHER.
*
*  INPUT TO THIS SVC IS REGISTER 1 POINTING TO A PARAMETER
*  LIST. THE FORMAT OF THE LIST IS AS FOLLOWS:
*
*        +0 (2) FROM ASID         (0 IF CURRENT)
*        +2 (2) TO ASID           (0 IF CURRENT)
*        +4 (4) FROM ADDRESS
*        +8 (4) TO ADDRESS
*        +12(4) LENGTH (MUST BE 4K OR LESS)
*
*        ON FINISHING REGISTER 15 WILL CONTAIN:
*          0  GOOD COMPLETION
*          4  UNASSIGNED ASID PARAMETER PASSED BY USER
*        GREATER THAN 4 -- SRB FAILED EXECUTION.  COMPLETION CODE
*          IS IN REGISTER 15.  COMPLETION CODE OF X'0000FFFF'
*          INDICATES PROBLEM UNKNOWN.  (CHECK LOGREC.)
         EJECT
IGC0023G CSECT
         REG
         LR    R9,R7   SAVE CURENT ASCB ADDRESS
         LR    R8,R14             SAVE RETURN ADDRESS
         LR    R10,R4    SAVE USER TCB ADDRESS
         USING IGC0023G,R6        ESTABLISH BASE REG
         LH    R2,0(R1)           LOAD FROM ASID
         LH    R3,2(R1)           LOAD TO ASID
         L     R4,4(R1)           LOAD FROM ADDRESS
         L     R5,8(R1)           LOAD TO ADDRESS
         L     R7,12(R1)          LOAD LENGTH
         BAL   R12,CKPRMS         GO VALIDATE PARMS
         LTR   R15,R15            ARE PARMS VALID
         BNZ   INVPRM             NO, REJECT
*
*
*  MUST NOW ACQUIRE MEMORY IN SQA TO MOVE DATA INTO.
*
         LA    R12,WASZ(R7)       LENGTH + SIZE OF WORK AREA
         GETMAIN R,LV=(R12),SP=245
         LR    R11,R1             LOAD BUFFER ADDRESS
         USING WA,R11
         STM   R2,R5,WAPRMS       SAVE PARMS
         ST    R7,WASIZE          SAVE DATA LENGTH
         SPACE
         L     R12,CVTPTR(0,0)    A(CVT)
         MVC   MODE,116(R12)      SAVE  MODE
*
*
*       GETMAIN FROM SQA FOR SRB
*
         LA    R12,SRBSIZE
GET1     GETMAIN R,LV=(R12),SP=245,RELATED=(FREE1)
         LR    R10,R1          SRB BUFFER AREA
         USING SRBSECT,R10  SRB ADDRESSABILITY
*
         MVI   SRB,X'00'   INITIALIZE SRB TO ZERO'S
         MVC   SRB+1(SRBSIZE-1),SRB
*
         MVC   SRBID,SRBIDENT
         LA    R1,SRBRTN    SRB ROUTINE THAT WILL BE SCHEDULED
         ST    R1,SRBEP     STORE IN SRB
         LA    R1,SRBCLEAN  CLEAN UP ROUTINE IF ADDRESS SPACES TRMNATE
         ST    R1,SRBRMTR
*
         L     R1,WAFRASID  USER SUPPLIED ASID FOR SRB TO BE RUN UNDER
         BAL   R14,FINDASCB  GO LOCATE TO ASCB
         ST    R1,SRBASCB   STORE IN ASCB
         ST    R1,WAFRASCB  STORE IN PARAMETER LIST
*
         L     R1,WATOASID  USER ASID
         BAL   R14,FINDASCB  GO LOCATE FROM ASCB
         ST    R1,WATOASCB  STORE USER ASCB ADDR IN PARAMETER LIST
         L     R1,WAFRASID
         LTR   R1,R1   ARE WE MOVING TO AN OTHER ASID?
         BNZ   BASF2   NO, NO CHANGE REQ.
         MVC   SRBASCB(4),WATOASCB  SCHEDULE SRB IN TO-ASCB
         L     R2,WAFRADDR
         L     R3,WASIZE
         LR    R15,R3
         LA    R14,WABFR
         MVCL  R14,R2 MOVE DATA TO SQA-BUFFER
         L     R1,WATOADDR
         L     R14,WAFRADDR
         ST    R1,WAFRADDR
         ST    R14,WATOADDR  EXCHANGE FROM/TO-ADDR.
BASF2    EQU   *
*
         SR    R1,R1
         ST    R1,WAECB       ZERO ECB.
         ST    R1,WACC   ZERO CONDITION CODE FIELD.
*
         ST    R11,SRBPARM   PARAMETER LIST PASSED TO SERVICE ROUTINE
*
*     ISSUE ESTAE FOR CLEANUP PROCESSING IF (?).
*     NOTE: AT THIS TIME THIS ROUTINE AND EXITS ARE UNTESTED
*     IT DOES NOT APPEAR THESE EXITS WOULD BE USED AS THE SRB'S
*     ARE RUNNING IN TASK INDEPENDENT MODE. BUT THE CODE IS BEING
*     LEFT IN UNTIL FURTHER INFORMATION IS RECEIVED.
*
         LA    R2,EXIT    ESTAE EXIT ROUTINE
         SPACE
         TM    MODE,X'80'
         BZ    NOXA1
         SPLEVEL SET=2
*        INVOKE THE MVS/XA VERSION
*        OF THE ESTAE MACRO INSTRUCTION
         MVC   ESTAXAD(L'ESTAXAL),ESTAXA
STARSTA  ESTAE (2),TERM=YES,RELATED=(CANSTA),MF=(E,ESTAXAD)
*
         SPACE
         SCHEDULE SRB=(R10),SCOPE=LOCAL
*
         WAIT  ECB=WAECB
*
*
         LA    R2,0   ZERO EXIT ADDRESS CANCELS ESTAE
         MVC   ESTAXAD(L'ESTAXAL),ESTAXA
CANSTA   ESTAE (2),TERM=NO,RELATED=(STARSTA,'ISSUE'),MF=(E,ESTAXAD)
         B     CONTINUE
*
NOXA1    EQU   *
         SPLEVEL SET=1
*        INVOKE THE MVS/370 VERSION
*        OF THE ESTAE MACRO INSTRUCTION
*
         MVC   ESTA370D(L'ESTA370L),ESTA370
STARSTAE ESTAE (2),TERM=YES,RELATED=(CANSTAE),MF=(E,ESTA370D)
         SPACE
         SCHEDULE SRB=(R10),SCOPE=LOCAL
*
         WAIT  ECB=WAECB
*
*
         LA    R2,0   ZERO EXIT ADDRESS CANCELS ESTAE
         MVC   ESTA370D(L'ESTA370L),ESTA370
CANSTAE  ESTAE (2),TERM=NO,RELATED=(STARSTAE,'ISSUE'),MF=(E,ESTA370D)
*
CONTINUE EQU   *
         CLC   WACC,CON0
         BE    GOON
         SR    R15,R15   ZERO REG 15
         LH    R15,WACC  LOAD 15 WITH CONDITION CODE
         B     SVCDONE
*
CON0     DC    F'0'
*
GOON     EQU   *
         SR    R15,R15
         L     R2,WAFRASID
         LTR   R2,R2
         BZ    SVCDONE
         L     R2,WATOADDR        LOAD TO ADDRESS
         L     R3,WASIZE          LOAD ELNGTH
         LR    R15,R3             SAVE IT
         LA    R14,WABFR          LOAD BUFFER ADDRESS
         MVCL  R2,R14             MOVE DATA TO DESTINATION
         SR    R15,R15
         B     SVCDONE            ALL DONE
         EJECT
*
*  THIS IS THE VALIDITY CHECK ROUTINE
*
CKPRMS   EQU   *
         LR    R1,R2              LOAD FROM ASID
         BAL   R14,FINDASCB       GO LOCATE THIS ASCB
         LTR   R15,R15            WAS IT FOUND
         BNZ   BADPRM             REJECT IS NOT
         LR    R1,R3              LOAD TO ASID
         BAL   R14,FINDASCB       GO LOCATE TO ASCB
         LTR   R15,R15            WAS IT FOUND
         BNZ   BADPRM             REJECT IF NOT
*
*  ANY VALUE IS VALID FOR THE FROM AND TO ADDRESS
*
         LTR   R14,R7             LOAD LENGTH
         BZ    BADPRM             REJECT IF LENGTH IS ZERO
         S     R14,FOURK          SUBTRACT 4 K
         BP    BADPRM             REJECT IF GREATER THAN 4K
         SR    R15,R15            SET RETURN CODE
         B     PRMEX
*
*
*
BADPRM   EQU   *
         LA    R15,4              SET RETURN CODE
*
PRMEX    EQU   *
         BR    R12                RETURN TO CALLER
         EJECT
*
*  THIS ROUTINE IS USED TO LOCATE AN ASCB HAVING THE SAME
*  ASID AS CONTAINED IN REG 1.
*
FINDASCB EQU   *
         LTR   R1,R1              IS REQUEST FOR CURRENT ASCB
         BZ    USECRNT            BRANCH IF YES
         L     R15,16             LOAD CVT ADDRESS
         L     R15,556(R15)       POINT TO ASVT
         C     R1,516(R15)        GREATER THAN MAX
         BH    BADASID            REJECT IF YES
         SLL   R1,2               MULT ASID BY 4
         LA    R1,524(R1,R15)     POINT TO ASCB ADDRESS
         TM    0(R1),X'80'        IS ASCB ASSIGNED
         BO    BADASID            REJECT IF YES
         L     R1,0(R1)           LOAD ASCB ADDRESS
         SR    R15,R15            SET RETURN CODE
         B     ASCBEX             RETURN
*
*
USECRNT  EQU   *
         LR    R1,R9              LOAD CURRENT ASCB ADDRESS
         SR    R15,R15            RETURN CODE
         B     ASCBEX             RETURN
*
*
BADASID  EQU   *
         LA    R15,4              SET ERROR RETURN CODE
*
ASCBEX   EQU   *
         BR    R14                RETURN TO CALLER
         EJECT
*
*
INVPRM   EQU   *
         LA    R15,4              SET ERROR RETURN CODE
         B     SVCEXIT
*
SVCDONE  EQU   *
         LR    R2,R15             SAVE RETURN CODE
*
*
*
         L     R3,WASIZE          LOAD LENGTH OF MOVE
         LA    R3,WASZ(R3)        ADD WORK AREA SIZE
         FREEMAIN R,LV=(R3),A=(R11),SP=245  FREE WORK AREA
*
         LA    R3,SRBSIZE
FREE1    FREEMAIN R,LV=(R3),A=(R10),SP=245,RELATED=(GET1)
         LR    R15,R2             SAVE RETURN CODE
SVCEXIT  EQU   *
         BR    R8                 RETURN TO SVC ISSUER
*
*  PROGRAM CONSTANTS
*
FOURK    DC    A(4096)
SRBIDENT DC    C'SRB '
         DROP  R10,R11
         EJECT
*        FROM THIS POINT ON THE CODE IS NOT PART OF THE SVC.
*        THE CODE IS A SERIES OF INDEPENDENT ROUTINES. THE
*        SRB ROUTINES, THE FRR ROUTINES, THE ESTAE EXIT ROUTINE
*        AND THE RESOURCE TERMINATION MODULE FOR THE SRB'S.
*
         EJECT
*
*        THIS ROUTINE EXECUTES IN SRB MODE UNDER THE
*        USER SPECIFIED ASCB ADDRESS.
*         THIS ALLOWS CONTROL BLOCK INFORMATION TO BE PASSED
*         BACK TO USER FOR DISPLAY OR USE.
*
*        ERROR RECOVERY IS ESTABLISHED FOR THIS ROUTINE THRU FRR
*        PROCESSING.   IT IS POSSIBLE FOR THE USER TO REQUEST
*        DATA FROM AN ADDRESS THAT IS NOT VALID FOR THIS ASCB,
*        WHICH WOULD CAUSE AN  0C4 IN THIS SRB LEAVING SVC 235
*        HUNG IN A WAIT.                SO IF
*        THIS SRB ABNORMALLY TERMINATES, AN FRR ROUTINE WILL
*        INDICATE A BAD COMPLETION AND SCHEDULE A POST, SO
*        THE WAITING REQUEST DOES NOT HANG.
*
         USING SRBRTN,R10
SRBRTN   EQU   *
         LR    R10,R15
         LR    R9,R0           SRB ADDRESS
         LR    R8,R14          SAVE RETURN REG
         USING SRBSECT,R9
*
         L     R2,SRBPARM      ADDR WORK AREA IN SQA
         USING WA,R2
*
*
         LA    R3,FRRTN   FRR ROUTINE ADDRESS
*
         SETFRR A,FRRAD=(3),WRKREGS=(4,5),PARMAD=(6)
*
         ST    R6,WAFRRPRM   24 BYTE WORK AREA ADDRESS
         ST    R2,0(R6)   WA ADDRESS
         ST    R9,4(R6)  SAVE SRB ADDRESS
*
         L     R4,WAFRADDR  MOVE REQUESTED DATA TO SQA AREA
         L     R5,WASIZE
         LR    R15,R5
         LA    R14,WABFR
         L     R1,WAFRASID
         LTR   R1,R1
         BNZ   BASF3
         MVCL  R4,R14
         MVC   SRBASCB(4),WAFRASCB
         B     BASF4
BASF3    EQU   *
         MVCL  R14,R4
*
         MVC   SRBASCB,WATOASCB
BASF4    LA    R1,SRBRETRN
         ST    R1,SRBEP
         LR    R1,R9
*
*        SCHEDULE AN SRB TO EXECUTE IN RECEIVING ASCB
*        TO POST THE ECB COMPLETE.
*
         SCHEDULE SRB=(1),SCOPE=LOCAL
*
         SETFRR D,WRKREGS=(4,5)  DELETE FRR FROM STACK.
*
         BR    R8
         DROP  R10,R9,R2
         EJECT
*        THIS ROUTINE IS ENTERED IF SRB ABNORMALLY TERMINATES FOR ANY
*        OF THE FOLLOWING REASONS:
*           1. PROGRAM CHECK IN SRB
*           2. MACHINE CHECK DURING SRB PROCESSING.
*           3. CONSOLE RESTART KEY DEPRESSED
*                (USUALLY BECAUSE SRB LOOPING)
*           4. UNRECOVERABLE TRANSLATION FAILURE WHILE SRB IN CONTROL.
*                (BECAUSE OF BAD ADDRESS PASSED BY USER (0C4))
*           5. UNRECOVERABLE I/0 ERROR ON PAGE DATA SET
*                SRB TRYING TO ACCESS.
*
*        WHATEVER CAUSES THIS ROUTINE TO BE ENTERED THE ONLY THING
*        IT NEEDS TO ACCOMPLISH IS TO SET THE CONDITION CODE IN THE
*        CONDITION CODE FIELD
*        AND POST THE RECEIVING ECB COMPLETE SO REQUESTING TASK
*        CAN CONTINUE PROCESSING.  THE FRR ROUTINE WILL INSTRUCT THE
*        SYSTEM TO CONTINUE TERMINATION PROCESSING AFTER IT IS THROUGH.
*        THIS WILL CAUSE A RECORD TO BE WRITTEN TO LOGREC FOR THE SRB
*        FAILURE, BUT PROGRAM RUNNING UNDER THIS ASCB IS NOT EFFECTED.
*
*              R1=SDWA ADDRESS
*              R15=ENTRY POINT ADDRESS
*              R14=RETURN ADDRESS.
*
         USING *,R12
         USING SRBSECT,R9
         USING WA,R3
FRRTN    EQU   *
         LR    R12,R15  ESTABLISH ADDRESSABILITY
         L     R2,0(R1)        FRR 24 BYTE PARM ADDRESS.
         L     R3,0(R2)        SVC 235 WORK AREA (WA) ADDRESS
         L     R9,4(R2)        SRB ADDRESS.
*
         L     R4,4(R1)        COMPLETION CODE SET IN SDWA.
         SLL   R4,8            SHIFT OFF FLAG'S
         SRL   R4,20           SHIFT SYSTEM CC TO RIGHTMOST 2 BYTES
         STH   R4,WACC STORE IN COND CODE FLD FOR RECEIVING PROGRAM.
*
         CLI   WACC,X'00'      CHECK FOR ZEROS
         BNE   OK
         CLI   WACC+1,X'00'
         BNE   OK
         MVC   WACC(2),UNKN2      BE SURE COND CODE NOT ZERO
*
OK       LA    R5,SRBRETRN  SRB ROUTINE TO BE SCHEDULED
         ST    R5,SRBEP
*
         MVC   SRBASCB,WATOASCB  REQUESTING ASCB ADDRESS
         L     R6,WAFRASID
         LTR   R6,R6
         BNZ   BASF5
         MVC   SRBASCB(4),WAFRASCB
BASF5    EQU   *
         LR    R6,R1  SAVE SDWA ADDR
         SCHEDULE SRB=(9),SCOPE=LOCAL
*
         LR    R1,R6   RESTORE SDWA ADDR
         SETRP DUMP=YES,RC=0,RECORD=YES
*
*    ABOVE TO INSURE ERROR WRITTEN TO LOGREC AND INSTRUCTS
*    SYSTEM TO CONTINUE WITH TERMINATION.
*
         BR    R14   RETURN
UNKN2    DC    X'FFFF'
         DROP  R9,R3
         EJECT
         USING SRBRETRN,R6
SRBRETRN EQU   *
         LR    R6,R15    ESTABLISH ADDRESSABILITY
         LR    R9,R0           SRB ADDRESS
         LR    R8,R14  RETURN ADDRESS
         USING SRBSECT,R9
         L     R2,SRBPARM    BUFFER AND PARAMETER AREA
*
         USING WA,R2
*
         LA    R3,FRRTN2   ADDRESS OF FRR ROUTINE .
         SETFRR A,FRRAD=(3),WRKREGS=(4,5)
*
*********************************************************
*
*        CHECK ECB FOR WAIT BIT ON
*        IF NOT ON USE CS TO BYPASS POST ROUTINE
*
*        BRANCH ENTRY TO POST
*              R10=COMPLETION CODE
*              R11=ECB ADDRESS
*              R14=RETURN ADDRESS
*              R15=ENTRY ADDRESS
*              REG'S 0-9 AREA PRESERVED BY POST
*
*        BRANCH ENTRY OF POST REQUIRES THE LOCAL LOCK TO BE HELD
*
*        THE LOCK ROUTINE DESTROYS REGISTERS 11 THRU 14
*
****************************************
*
*
GETL2    SETLOCK OBTAIN,TYPE=LOCAL,MODE=UNCOND,RELATED=(FREEL2)
         L     R3,WAECB     CONTENTS OF ECB
         L     R4,CON40     IMAGE OF POSTED ECB
         TM    WAECB,X'80'   HAS WAIT BEEN ISSUED?
         BO    DOPOST   IF SO,   ISSUE POST
         CS    R3,R4,WAECB  IF NOT, COMPARE AND SWAP
         BZ    POSTDONE  COMPARE AND SWAP WAS SUCCESSFUL.
*
DOPOST   EQU   *
*
         LA    R11,WAECB
         LA    R10,0
         L     R15,16   CVT ADDRESS
         L     R15,152(R15)   POST ENTRY POINT ADDRESS
         BALR  R14,R15   BRANCH TO POST ROUTINE
POSTDONE EQU *
*
FREEL2   SETLOCK RELEASE,TYPE=LOCAL,RELATED=(GETL2)
*
         SETFRR D,WRKREGS=(4,5)
*
         BR    R8   RETURN
         DS    0F
CON40    DC    X'40000000'
         DS    0F
         DROP  R6,R9,R2
         EJECT
*        THIS ROUTINE IS ENTERED IF 'SRBRETRN' SRB ROUTINE FAILS
*        HOWEVER, IF THIS ROUTINE FAILS THERE ISN'T ANYTHING CAN BE
*        DONE ABOUT IT.   SO THE FRR ROUTINE WILL INSURE THERE
*        IS A LOGREC RECORD WRITTEN FOR DEBUGGING PURPOSES.
*
         USING *,R12
FRRTN2   LR    R12,R15
         SETRP DUMP=YES,RC=0,RECORD=YES
         BR    R14
         EJECT
         USING *,R11
EXIT     EQU   *
*******************************************************************
*
*  ****NOTE:   AT THIS TIME THIS ROUTINE AND COMMENTS
*              DO NOT APPEAR TO BE VALID.  THE CODE IS
*              BEING LEFT IN UNTIL FURTHER INFORMATION
*              IS OBTAINED.
*
*    ESTAE EXIT ROUTINE GETS CONTROL IF AN ABNORMAL TERMINATION OCCURS
*    IN THE SERVICE REQUEST PROCESSING OR IN THE CURRENT ADDRESS SPACE
*    THE PURPOSE OF THE ESTAE ROUTINE IS TO ISSUE A 'PURGEDQ' TO
*    DEQUE ANY SRB'S THAT MIGHT BE WAITING TO BE DISPATCHED.
*
*    IF AN SRB IS PURGED, CONTROL WILL BE GIVEN TO THE RESOURCE
*    TERMINATION MODULE (RMTR) WHOSE ADDRESS IS IN THE SRB PURGED.
*    THIS MODULE ('SRBCLEAN' WITHIN THIS LISTING) WILL
*    SET THE COMPLETION CODE IN THE COND. CODE FLD AND POST THE ECB
*     COMPLETE TO KEEP THAT ADDRESS SPACE PROCESSING.
*
******************************************************************
*
*         PURGEDQ
*           WILL MATCH SRB RMTR PARAMETER TO
*           THE RMTR ADDRESS SUPPLIED WITH THE PURGEDQ
*           MACRO FOR UNIQUE IDENTIFICATION OF
*           SRB'S TO BE PURGED.
*
***********************************************************
*
         LR    R11,R15   BASE ADDRESSABILITY
         LR    R10,R14   SAVE RETURN ADDRESS
*
         LR    R2,R0   CODE INDICATING WHETHER SWDA OBTAINED
         L     R0,UNKN  SET UP WITH UNKNOWN CODE.
         SLL   R2,24  CLEAR HIGH ORDER BITS
         SRL   R2,24
         CL    R2,F12  CHECK FOR 12 COMPLETION CODE.
         BE    CONT  IF 12 LEAVE UNKN CODE IN REG.
         L     R0,4(R1)  OTHERWISE LOAD COMPLETION CODE FROM SDWA.
         SLL   R0,8  CLEAR HIGH ORDER BITS
         SRL   R0,20  SHIFT SYS COMP CODE TO RIGHT TWO BYTES.
*
CONT     LR    R3,R0   SAVE REGISTER WITH CODE.
         LTR   R3,R3  TEST FOR CC = ZERO
         BNZ   PURGEQ  IF NOT OK.
         L     R3,UNKN     INSURE ZERO CONDITION CODE NOT RETURNED
*
*
*
PURGEQ   LA    R2,SRBCLEAN   RESOURCE TERMINATION MODULE
         PURGEDQ RMTR=(R2)
*
         LR    R0,R3   LOAD RETURN CODE INTO REG FOR RMTR.
         LR    R14,R10   RETURN ADDRESS
         SR    R15,R15  INDICATEDS CONTINUE TERMINATION
         BR    R14   RETURN
*
F12      DC    F'12'
UNKN     DC    X'0000FFFF'
*
         DROP  R11
         EJECT
*********************************************************************
*
*     CONTROL RECEIVED IF ESTAE EXIT INVOKED (WHICH ISSUES PURGEDQ FOR
*        QUEUED SRB'S)  ISSUES POST TO MINIMIZE CHANCES OF SVC HANGING
*           IN WAIT.
*           R0=CONTENTS OF R0 OF CALLER CONTAINS COMP CODE.
*           R1=SRB ADDRESS
*        R2=CONTENTS OF SRB PARM (ADDRESS OF SQA AREA USED IN DATA XFER
*           R14=RETURN ADDRESS
*           R15=ENTRY POINT
*
***********************************************************************
         USING WA,R6    ADDRESSABILITY FOR PARAMETER LIST
         USING SRBSECT,R9   SRB ADDRESSABILITY
         USING *,R8         BASE ADDRESSABILITY
SRBCLEAN  EQU   *
*
         LR    R8,R15     LOAD BASE REG
         LR    R10,R14    SAVE RETURN ADDRESS
         LR    R9,R1    SAVE SRB ADDRESS
         L     R6,SRBPARM   PARAMETER LIST ADDRESS
*
         LR    R7,R0   SAVE CONDITION CODE
*
*
*         REGS 11-14 ARE DESTROYED BY SETLOCK
*             MUST HAVE THE LOCAL LOCK FOR BRANCH ENTRY TO POST
*
GETLOCK  SETLOCK OBTAIN,TYPE=LOCAL,MODE=UNCOND,RELATED=(FREELOCK)
         L     R3,WAECB  CONTENTS OF ECB
         L     R4,CNC40  IMAGE OF POSTED ECB
         TM    WAECB,X'80'  HAS WAIT BEEN ISSUED?
         BO    EXPOST  IF SO, ISSUE POST.
         CS    R3,R4,WAECB  IF NOT, COMPARE AND SWAP
         BZ    POSTFINI
*
EXPOST   EQU   *
         LA    R11,WAECB  ECB ADDRESS
         LA    R10,0    ZERO R10
         L     R15,16  CVT ADDRESS
         L     R15,152(R15)    BRANCH TO POST ROUTINE.
         BALR  R14,R15   DO POST
*
POSTFINI EQU   *
         STH   R7,WACC     SET COMPLETION CODE IN COND. CODE FLD.
*
FREELOCK SETLOCK RELEASE,TYPE=LOCAL,RELATED=(GETLOCK)
*
         LR    R14,R10   RESTORE RETURN ADDR
         BR    R14    RETURN
         DS    0F
CNC40    DC    X'40000000'
         DROP  R6,R8,R9
         EJECT
*
         SPLEVEL SET=2
ESTAXA   ESTAE 0,CT,XCTL=NO,PURGE=NONE,ASYNCH=YES,MF=L
ESTAXAL  EQU   *-ESTAXA
*
         SPLEVEL SET=1
ESTA370  ESTAE 0,CT,XCTL=NO,PURGE=NONE,ASYNCH=YES,MF=L
ESTA370L EQU   *-ESTA370
*
*  WORK AREA DSECT
*
*
WA       DSECT
WAPRMS   DS    0F
WAFRASID DS    A                  REQUESTED ASID
WATOASID DS    A                  USER ASID
WAFRADDR DS    A                  FROM ADDRESS
WATOADDR DS    A                  TO ADDRESS
WATOASCB DS    A                  FROM ASCB
WAFRASCB DS    A                  TO ASCB
WASIZE   DS    A                  MOVE LENGTH
WAECB    DS    A               ECB TO BE POSTED FOR SYNCH
WAFRRPRM DS    A  WILL CONTAIN THE ADDR OF 24 BYTE PARM AREA FOR FRR
WACC     DS    A   COMPLETION CODE.
MODE     DS    C                   MODE
         SPACE
         SPLEVEL SET=2
ESTAXAD  ESTAE 0,MF=L
         SPACE
         SPLEVEL SET=1
ESTA370D ESTAE 0,MF=L
         SPACE
WASZ     EQU   *-WA    PARM SECTION SIZE
WABFR    EQU   *       DATA AREA
         EJECT
         IHASRB
         EJECT
         CVT
         EJECT
         IHAPSA
         EJECT
         IHASDWA
         EJECT
         IHAFRRS
         END
//LKED.SYSLMOD DD DSN=SYS1.LPABASF(IGC0023G),DISP=SHR
./ ADD NAME=IOS
IOS      TITLE 'X-CMD IOS'
WMMCCABE CSECT ,       CSECT NAME SET TO 'WMMCCABE' BECAUSE OF IOSGEN
*                      CSECT AUTHORIZATION CHECKING
*
         REG   ,                   PROVIDE REGISTER ADDRESSABILITY
         XSAVE R12,,DUMP,WORKL     SAVE REGS AND PROVIDE WORKAREA
         USING WORKAREA,R13        ESTABLISH ADRESSABIILITY OF WKAREA
         LR    R11,R1              ESTABLISH
         USING PARMAREA,R11         ADDRESSABILITY
* SCAN THE ENTERED COMMAND
         CLC   REG4(4),=CL4'TSO'
         BNE   NOTSO
         TPUT  NOTSOMSG,70
         XRETURN 0,R
NOTSOMSG DC    CL70'XIOS000 X-IOS NOT SUPPORTED UNDER TSO'
NOTSO    EQU   *
         CLC   TEXT+4(7),=C'SIMINT,' SIMULATE INTERRUPT COMMAND?
         LA    R4,XSIMINT          SET
         LA    R3,TEXT+11           ADDRESSES
         BE    SCANUCB               IF YES
         L     R0,REG4             LOAD UCM-ID
         WTO   'XIOS001 FUNCTION NOT (YET?) PROVIDED',MCSFLAG=REG0
XRETURN  XRETURN ,R                RETURN TO CALLER
         EJECT
SCANUCB  EQU   *                   EXTRACT UCB INFORMATION
         MVC   UCBADR(3),TEXT+11
         MVI   SWITCH,C'1'         INITIALIZE SWITCH
         LA    R10,XIOSPRM1        INITIALIZE ADDRESS
         XC    0(2*L'XIOSPRM1,R10),0(R10) CLEAR AREAS
SCANUCB0 CLI   3(R3),C' '          DELIMITER BLANK?
         BE    SCANUCB2            BR IF YES
PARMERR  L     R0,REG4             LOAD UCM-ID
         WTO   'XIOS002 ERROR IN PARAMETER',MCSFLAG=REG0
         B     XRETURN             RETURN TO CALLER
*
SCANUCB2 LA    R0,3                SET BCT COUNT 1
         SR    R6,R6               REG 6 IS TO CONTAIN THE DEVICE ADDR
SCANUCB3 LA    R1,16               SET BCT COUNT 2
         SR    R7,R7               SET COUNT REG TO ZERO
SCANUCB4 IC    R5,HEXCHAR(R7)      INSERT CURRENT HEX CHARACTER
         EX    R5,SCANUCBE         COMPARE TO CURRENT DEV ADDR CHAR
         BE    SCANUCB5            BR IF EQUAL
         LA    R7,1(,R7)           ELSE
         BCT   R1,SCANUCB4          CONTINUE SEARCH
         B     PARMERR             ERROR IF NOT FOUND
SCANUCB5 SLL   R7,28               SHIFT AND
         SLDL  R6,4                LOAD HEX VALUE
         LA    R3,1(,R3)           ADDRESS OF NEXT CHARACTER
         BCT   R0,SCANUCB3         CONTINUE SEARCH
*
         EJECT
         STH   R6,XIOSCUA-XIOSPRM1(,R10) SAVE HEX ADDR
UCBREG   EQU   7
         USING UCBOB,UCBREG
         BAL   R14,XUCBLOOK        VALIDATE UCB ADDRESS
SUPSTATE MODESET MODE=SUP          ENTER SUPERVISOR STATE
         MODESET SAVEKEY=(2)       GET CURRENT PSW KEY
         STC   R2,TCBPKF           STORE CURRENT PSW KEY
         BR    R4                  GO TO DESIRED FUNCTION
UCBERROR L     R0,REG4             LOAD UCM-ID
         WTO   'XIOS003 UCB NOT FOUND',MCSFLAG=REG0
         B     XRETURN             RETURN TO CALLER
*
         EJECT
***********************************************************************
*                                                                     *
*        INVOKE "IOSGEN,SIMINT,UCB=(.),REG=(.)"                       *
*                                                                     *
***********************************************************************
         SPACE 1
XSIMINT  EQU   *
         MODESET EXTKEY=ZERO       SET ZERO KEY
         LA    R13,12(R13)
         IOSINTRP UCB=(R7)          INVOKE IOSGEN PROCEDURE
         SH    R13,=H'12'
         MODESET EXTKEY=TCB,WORKREG=1  RETURN TO NZERO PROTECT KEY
         SPACE 1
         L     R0,REG4             LOAD UCM-ID
         WTO   'XIOS007 SIMINT HAS BEEN ISSUED',MCSFLAG=REG0
         B     XRETURN             EXIT
*
         EJECT
XUCBLOOK EQU *
         ST    R14,SAVE14
UCBLOOK1 UCBSCAN STATUS=ONLINE
         LTR   R15,R15
         BNZ   UCBERROR
         CLC   13(3,R1),UCBADR
         BNE   UCBLOOK1
         LR    UCBREG,R1
         MVC   XIOSNAME-XIOSPRM1(3,R10),UCBNAME
         L     R14,SAVE14
         BR    R14
         EJECT
HEXCHAR  DC    C'0123456789ABCDEF' HEXCHAR TAB
SCANUCBE CLI   0(R3),*-*           *** EXECUTE ONLY ***
WORKAREA DSECT
SAVEAREA DS    18F                 18 WORD SAVEAREA
DWORD    DS    D                   WORK
FWORD    DS    F                   WORK
HWORD    DS    H                   WORK
SWITCH   DS    X                   WORK
TCBPKF   DS    X                   SAVE AREA FOR TCB PROTECT KEY
WTOAREA  DS    CL76                WTO AREA
SP245WA  DS    A                   ADDRESS OF STARTIO SRB-IOSB
SAVE14   DS    F
UCBADR   DS    CL3
XIOSPRM1 DS    0D                  UCB-1 PARAMETERS
XIOSCUA  DS    H                   CHANNEL-UNIT ADDRESS OF DEVICE
XIOSID   DS    X                   FUNCTION ID
XIOSCPU  DS    X                   ADDRESS OF CPU
XIOSRES  DS    X                   RESERVED
XIOSNAME DS    CL3                 UCB ADDRESS IN EBCDIC
XIOSPRM2 DS    D                   UCB-2 PARAMETERS
*
WORKL    EQU   *-WORKAREA
         XPARM
*
         PRINT NOGEN
         CVT   DSECT=YES
         IEFUCBOB
         IECDIOCM
         IECDIOCX
         IECDIOSB
         IHAPSA
         IHASRB
         END
./ ADD NAME=LPDS
         TITLE 'XLPDS                             X-COMMAND LPDS'
LPDS     CSECT
         SPACE 3
***********************************************************************
*                                                                     *
*      PROGRAM-ID. XLPDS.                                             *
*      AUTHOR. EHNERT.                                                *
*      PROGRAM-ID. LPDS.                                              *
*      DATE-WRITTEN. 14. 5. 1975.                                     *
*      REMARKS.                                                       *
*                                                                     *
*          DAS X-COMMAND 'LPDS' GIBT INFORMATIONEN UEBER DIE DIREC-   *
*          TORY DER DATEI AUS, DEREN NAME ALS ERSTER PARAMETER SPE-   *
*          ZIFIZIERT WERDEN MUSS.                                     *
*                                                                     *
*          FOLGENDE PARAMETER, DIE ZUSAETZLICH ANGEGEBEN WERDEN       *
*          KOENNEN, MUESSEN IN DER AUFGEFUEHRTEN REIHENFOLGE SPEZI-   *
*          FIZIERT WERDEN:                                            *
*          A)  DIE SERIAL NUMBER DER VOLUME, AUF DER DIE DATEI STEHT. *
*              WIRD SIE NICHT ANGEGEBEN, SO GILT DIE INFORMATION      *
*              DES CATALOGS.                                          *
*          B)  ANGABEN ZUR AUSWAHL DER MEMBER NAMEN: <VON>-<BIS>.     *
*              ES WERDEN NUR INFORMATIONEN UEBER DIE MEMBER AUSGE-    *
*              GEBEN, DEREN NAME IN DER SORTIERFOLGE ZWISCHEN DER     *
*              <VON>- UND DER <BIS>-ANGABE LIEGEN.                    *
*              Z. B.: A-ZZ     => <VON>='A       ', <BIS>='ZZ999999', *
*                     I        => <VON>='I       ', <BIS>='I9999999', *
*                     TEMP-    => <VON>='TEMP    ', <BIS>='99999999', *
*                     -TEMP    => <VON>='        ', <BIS>='TEMP9999', *
*                     TEMPNAME => <VON>='TEMPNAME', <BIS>='TEMPNAME'. *
*              WERDEN KEINE ANGABEN ZUR AUSWAHL GETROFFEN, SO GILT:   *
*              <VON>='        ', <BIS>='99999999'.                    *
*          C)  WIRD DER PARAMETER 'TEST' ANGEGEBEN, SO WIRD ZUSAETZ-  *
*              LICH EINE STATISTIK UEBER DIE ANZAHL DER ANGELEGTEN    *
*              UND UEBER DIE ANZAHL DER BENUTZTEN DIRECTORY BLOCKS    *
*              ERSTELLT.                                              *
*                                                                     *
*          DURCH DIE NOTWENDIGE DYNAMIC ALLOCATION , DIE IM EXTER-    *
*          NEN UNTERPROGRAMM 'DYNALC' DURCHGEFUEHRT WIRD, KANN DAS    *
*          X-COMMAND 'LPDS' NUR IM SYSTEM OS/VS2 (MVS) VERWENDET      *
*          WERDEN.                                                    *
*                                                                     *
***********************************************************************
         EJECT
***********************************************************************
*                                                                     *
*      BEGINN DER VERARBEITUNG.                                       *
*                                                                     *
***********************************************************************
         SPACE 3
*
*      SICHERN DER REGISTER,
*      SPEICHERPLATZANFORDERUNG FUER ARBEITSBEREICHE,
*      ZUORDNUNG DER BASISREGISTER.
*
         SPACE 1
         XSAVE R12,,LPDS,ABERL
         SPACE 1
         LR    R11,R1        BASISREG. FUER DSECT PARMAREA INIT.
         USING PDS,R10       BASISREG. FUER DSECT PDS ZUORDNEN
         USING PARMAREA,R11  BASISREG. FUER DSECT PARMAREA ZUORDNEN
         USING ABER,R13      BASISREG. FUER DSECT ABER ZUORDNEN
         EJECT
*
*      ABFRAGE DES SYSTEMS.
*
         SPACE 1
         L     R2,16         ADRESSE DER CVT LADEN
         TM    116(R2),X'01' SYSTEM = OS/VS2 (MVS) ?
         BO    INIT          JA, VERZW. ZUR INIT. DER SPEICHER
         L     R0,REG4       MCS-ID DER CONSOLE LADEN
         LA    R1,MSG04
         BAL   R14,WTOROUT
         B     ENDE          VERZW. ZUM ABSCHLUSS DER VERARBEITUNG
         SPACE 2
*
*      INITIALISIERUNG DER SPEICHER.
*
         SPACE 1
INIT     EQU   *
         MVC   HEADER(LENMSG01),MSG01 UEBERSCHRIFT UEBERTRAGEN
         MVC   VOLSERNO,BLANK SPEICHER FUER VOLSER NUMBER LOESCHEN
         MVC   FROMNAME,BLANK SPEICHER FUER VON-PARAMETER LOESCHEN
         MVC   TONAME,=8C'9' SPEICHER FUER BIS-PARAMETER INIT.
         MVI   TESTBYTE,X'00' FLAG BYTE FUER STATISTIK-INFORMATION
         EJECT
***********************************************************************
*                                                                     *
*      VERARBEITUNG DER EINGABEPARAMETER.                             *
*                                                                     *
***********************************************************************
         SPACE 3
         CLI   TEXT+4,C','   PARAMETER ANGEGEBEN ?
         BNE   FEHLPARM      NEIN, VERZW. ZUR FEHLERROUTINE
         SPACE 2
*
*      VERARBEITUNG DES DATA SET NAME.
*
         SPACE 1
         LA    R2,TEXT+4     ADRESSE DES TRENNUNGSZEICHENS LADEN
         SR    R3,R3         LAENGENZAEHLER LOESCHEN
DSNLOOP  EQU   *
         LA    R2,1(R2)      ADRESSE DES NAECHSTEN ZEICHENS LADEN
         CLI   0(R2),C' '    ENDE DER PARAMETERKETTE ERREICHT ?
         BE    ENDDSNLP      JA, VERZW. ZUM ENDE DER SCHLEIFE
         CLI   0(R2),C','    ENDE DES DATA SET NAME ERREICHT ?
         BE    ENDDSNLP      JA, VERZW. ZUM ENDE DER SCHLEIFE
         LA    R3,1(R3)      LAENGENZAEHLER ERHOEHEN
         CH    R3,=H'44'     MAXIMALE LAENGE UEBERSCHRITTEN ?
         BH    FEHLPARM      JA, VERZW. ZUR FEHLERROUTINE
         B     DSNLOOP       VERZWEIGEN ZUR SCHLEIFE
         SPACE 1
ENDDSNLP EQU   *
         LTR   R3,R3         DATA SET NAME ANGEGEBEN ?
         BZ    FEHLPARM      NEIN, VERZW. ZUR FEHLERROUTINE
         BCTR  R3,0          R3 FUER EXECUTE UM EINS VERMINDERN
         EX    R3,MVCDSN     VERZW. ZUM UEBERTR. DES DSNAME
         CLI   0(R2),C','    WEITERE PARAMETER ANGEGEBEN ?
         BNE   GETCAT        NEIN, VERZW. ZUR VERARB. DER CATALOG-INFO.
         EJECT
*
*      VERARBEITUNG DER VOLUME SERIAL NUMBER.
*
         SPACE 1
         LA    R2,1(R2)      ADRESSE DES NAECHSTEN TRENNUNGSZEICHENS
         CLI   0(R2),C','    VOLSER NUMBER ANGEGEBEN ?
         BE    GETVB         NEIN, VERZW. Z. VERARB. WEITERER PARAMETER
         MVC   VOLSERNO,0(R2) VOLSER NUMBER UEBERTRAGEN
         LA    R2,6(R2)      ADRESSE DES NAECHSTEN TRENNUNGSZEICHENS
         CLI   0(R2),C','    WEITERE PARAMETER ANGEGEBEN ?
         BNE   GETDSCB1      NEIN, VERZW. ZUM LESEN DES DSCB1
         SPACE 2
*
*      VERARBEITUNG DER AUSWAHL-PARAMETER.
*
         SPACE 1
GETVB    EQU   *
         LR    R4,R2         ADRESSE DES TRENNUNGSZEICHENS SICHERN
         SR    R3,R3         LAENGENZAEHLER LOESCHEN
FROMLOOP EQU   *
         LA    R2,1(R2)      ADRESSE DES NAECHSTEN ZEICHENS LADEN
         CLI   0(R2),C' '    ENDE DER PARAMETERKETTE ERREICHT ?
         BE    ENDFRMLP      JA, VERZW. ZUM ENDE DER SCHLEIFE
         CLI   0(R2),C','    ENDE DER AUSWAHL-PARAMETER ERREICHT ?
         BE    ENDFRMLP      JA, VERZW. ZUM ENDE DER SCHLEIFE
         CLI   0(R2),C'-'    ENDE DES VON-PARAMETERS ERREICHT ?
         BE    ENDFRMLP      JA, VERZW. ZUM ENDE DER SCHLEIFE
         LA    R3,1(R3)      LAENGENZAEHLER UM EINS ERHOEHEN
         CH    R3,=H'8'      MAXIMALE LAENGE UEBERSCHRITTEN ?
         BH    FEHLPARM      JA, VERZW. ZUR FEHLERROUTINE
         B     FROMLOOP      VERZWEIGEN ZUR SCHLEIFE
         SPACE 1
ENDFRMLP EQU   *
         LTR   R3,R3         VON-PARAMETER ANGEGEBEN ?
         BZ    NOFNAME       NEIN, VERZW. ZUR ALTERNATIV-ROUTINE
         BCTR  R3,0          R3 FUER EXECUTE UM EINS VERMINDERN
         EX    R3,MVCFNAME   VERZW. ZUM UEBERTR. DES VON-PARAMETERS
         CLI   0(R2),C'-'    BIS-PARAMETER ANGEGEBEN ?
         BE    GETTNAME      JA, VERZW. Z. VERARB. DES BIS-PARAMETERS
         EX    R3,MVCTNAME   VERZW. ZUM UEBERTR. DES BIS-PARAMETERS
         B     ASKNEXT       VERZW. ZUR NAECHSTEN ABFRAGE
NOFNAME  EQU   *
         CLI   0(R2),C'-'    BIS-PARAMETER ANGEGEBEN ?
         BE    GETTNAME      JA, VERZW. Z. VERARB. DES BIS-PARAMETERS
         B     ASKNEXT       VERZW. ZUR NAECHSTEN ABFRAGE
         EJECT
GETTNAME EQU   *
         LR    R4,R2         ADRESSE DES TRENNUNGSZEICHENS SICHERN
         SR    R3,R3         LAENGENZAEHLER LOESCHEN
TOLOOP   EQU   *
         LA    R2,1(R2)      ADRESSE DES NAECHSTEN ZEICHENS LADEN
         CLI   0(R2),C' '    ENDE DER PARAMETERKETTE ERREICHT ?
         BE    ENDTOLP       JA, VERZW. ZUM ENDE DER SCHLEIFE
         CLI   0(R2),C','    ENDE DES BIS-PARAMETERS ERREICHT ?
         BE    ENDTOLP       JA, VERZW. ZUM ENDE DER SCHLEIFE
         LA    R3,1(R3)      LAENGENZAEHLER UM EINS ERHOEHEN
         CH    R3,=H'8'      MAXIMALE LAENGE UEBERSCHRITTEN ?
         BH    FEHLPARM      JA, VERZW. ZUR FEHLERROUTINE
         B     TOLOOP        VERZWEIGEN ZUR SCHLEIFE
         SPACE 1
ENDTOLP  EQU   *
         LTR   R3,R3         BIS-PARAMETER ANGEGEBEN ?
         BZ    ASKNEXT       NEIN, VERZW. ZU WEITEREN ABFRAGEN
         BCTR  R3,0          R3 FUER EXECUTE UM EINS VERMINDERN
         EX    R3,MVCTNAME   VERZW. ZUM UEBERTR. DES BIS-PARAMETERS
ASKNEXT  EQU   *
         CLI   0(R2),C','    WEITERE PARAMETER ANGEGEBEN ?
         BNE   GETCAT        NEIN, VERZW. ZUR VERARB. DER CATALOG-INFO.
         SPACE 2
*
*      VERARBEITUNG DES PARAMETERS 'TEST'.
*
         SPACE 1
         CLC   1(5,R2),=C'TEST ' PARAMETER = 'TEST' ?
         BNE   TSTNEXEC      NEIN, VERZW. ZUR FEHLERROUTINE
         MVI   TESTBYTE,X'FF' FLAG BYTE SETZEN
         B     GETCAT        VERZW. ZUR VERARB. DER CATALOG-INFO.
TSTNEXEC EQU   *
         CLC   1(2,R2),=C'NE'
         BNE   FEHLPARM
         MVC   NE,=C'NE'
         B     GETCAT
         SPACE 1
MVCDSN   MVC   DSNAME(0),TEXT+5 DSNAME UEBERTRAGEN
MVCFNAME MVC   FROMNAME(0),1(R4) VON-PARAMETER UEBERTRAGEN
MVCTNAME MVC   TONAME(0),1(R4) BIS-PARAMETER UEBERTRAGEN
         EJECT
***********************************************************************
*                                                                     *
*      VERARBEITUNG DER CATALOG-INFORMATIONEN.                        *
*                                                                     *
***********************************************************************
         SPACE 3
GETCAT   EQU   *
         CLI   VOLSERNO,C' ' VOLSER NUMBER ANGEGEBEN ?
         BNE   GETDSCB1     JA, VERZW. ZUM LESEN DES DSCB1
         XC    CAMLIST(16),CAMLIST CAMLIST-BEREICH LOESCHEN
         MVI   CAMLIST,X'44' FLAG BYTE SETZEN
         LA    R2,DSNAME     PARAMETER-ADRESSEN
         SR    R3,R3             LADEN
         LA    R4,CAMWKFLD       UND
         STM   R2,R4,CAMLIST+4   SPEICHERN
         LOCATE CAMLIST      CATALOG LESEN
         LTR   R15,R15       RETURN CODE = 0 ?
         BNZ   FEHLLOC       NEIN, VERZW. ZUR FEHLERROUTINE
         MVC   MESSAGE(LENMSG02),MSG02 NACHRICHTENZEILE UEBERTRAGEN
         MVC   MS02CVOL,CAMCVOL CVOL NUMBER UEBERTRAGEN
         MVC   MS02VOLI,CAMVOLI VOLSER NUMBER UEBERTRAGEN
         BAL   R14,WTOOUTP   VERZW. ZUR NACHRICHTENAUSGABE
         MVC   VOLSERNO,CAMVOLI VOLSER NUMBER UEBERTRAGEN
         EJECT
***********************************************************************
*                                                                     *
*      DSCB1 LESEN UND AUSWERTEN.                                     *
*                                                                     *
***********************************************************************
         SPACE 3
GETDSCB1 EQU   *
         XC    CAMLIST(16),CAMLIST CAMLIST-BEREICH LOESCHEN
         MVI   CAMLIST,X'C1' FLAG BYTE SETZEN
         LA    R2,DSNAME     PARAMETER-ADRESSEN
         LA    R3,VOLSERNO       LADEN
         CALL  MSSMNT,((R3)),VL
         LA    R4,CAMWKFLD       UND
         STM   R2,R4,CAMLIST+4   SPEICHERN
         OBTAIN CAMLIST      DSCB1 DES DATA SET AUFSUCHEN
         LTR   R15,R15       RETURN CODE = 0 ?
         BNZ   FEHLOBT       NEIN, VERZW. ZUR FEHLERROUTINE
         CLC   DS1CCHHR,=XL5'0' DUMMY DSCB1 ?
         BE    FEHLOBT       JA, VERZW. ZUR FEHLERROUTINE
         TM    DS1DSORG,X'02' DSORG = PO ?
         BZ    FEHLORG       NEIN, VERZW. ZUR FEHLERROUTINE
         EJECT
***********************************************************************
*                                                                     *
*      AUFRUF DES UNTERPROGRAMMS 'DYNALC'.                            *
*                                                                     *
***********************************************************************
         SPACE 3
         MVC   DALPWKS(DALPLEN),DALPCON PARAMETERLISTE UEBERTRAGEN
         LA    R2,DALPRC     ADRESSE DER RETURN CODES
         ST    R2,ADDRRC         LADEN UND SPEICHERN
         LA    R2,DALPDDN    ADRESSE DES DDNAME LADEN
         LA    R3,DSNAME     ADRESSE DES DSNAME LADEN
         STM   R2,R3,ADDRDDN ADRESSEN SPEICHERN
         LA    R2,VOLSERNO   ADRESSE DER VOLSER NUMBER
         STCM  R2,7,ADDRVOLI+1   LADEN UND SPEICHERN
         XC    DALPRC,DALPRC SPEICHER FUER RETURN CODE LOESCHEN
         MVC   DALPDDN,BLANK SPEICHER FUER DDNAME LOESCHEN
         LA    R1,DALPWKS    ADRESSE DER PARAMETERLISTE LADEN
         L     R15,=V(DYNALC) ADRESSE DES UNTERPROGRAMMS LADEN
         BALR  R14,R15       VERZW. INS UNTERPROGRAMM 'DYNALC'
         CLI   DALPRC+3,X'00' RETURN CODE = 0 ?
         BNZ   FEHLDYNA      NEIN, VERZW. ZUR FEHLERROUTINE
         EJECT
***********************************************************************
*                                                                     *
*      VERARBEITUNG DER DIRECTORY-INFORMATIONEN.                      *
*                                                                     *
***********************************************************************
         SPACE 3
*
*      DATEI EROEFFNEN.
*
         SPACE 1
         MVC   EIN(DCBLEN),DCBCONST DCB UEBERTRAGEN
         MVC   DCBDDN,DALPDDN DDNAME UEBERTRAGEN
         LA    R1,EIN        ADRESSE DES DCB LADEN
         ST    R1,DCBADDR        UND SPEICHERN
         MVI   DCBADDR,X'80' OPTION BYTE SETZEN
         LA    R1,DCBADDR    ADRESSE DER DCB-ADRESSE LADEN
         SVC   19            VERZW. ZUM EROEFFNEN DER DATEI
         TM    DCBOFLGS,X'10' DATEI EROEFFNET ?
         BZ    FEHLOPEN      NEIN, VERZW. ZUR FEHLERROUTINE
         SPACE 1
         SR    R2,R2         BLOCK-ZAEHLER LOESCHEN
         MVI   ENDBYTE,X'00' FLAG BYTE FUER ENTRY-ENDE LOESCHEN
         BAL   R14,HEADLOOP  VERZW. ZUR AUSGABE DER UEBERSCHRIFTEN
         EJECT
*
*      LESEN DER DATEI.
*
         SPACE 1
GETLOOP  EQU   *
         GET   EIN           EINEN BLOCK LESEN
         LA    R2,1(R2)      BLOCK-ZAEHLER UM EINS ERHOEHEN
         CLI   ENDBYTE,X'FF' ENDE DER ENTRIES UEBERSCHRITTEN ?
         BE    GETLOOP       JA, VERZW. ZUM LESEN DES NAECHSTEN BLOCKS
         LH    R9,0(R1)      LAENGE DES BLOCKS LADEN
         AR    R9,R1         ENDADRESSE DES BLOCKS LADEN
         LA    R10,2(R1)     ADRESSE DES ERSTEN ENTRY LADEN
ENTRYLP  EQU   *
         CLI   PDS2NAME,X'FF' ENDE DER ENTRIES ERREICHT ?
         BE    ENTRYEND      JA, VERZWEIGEN ZUR END-ROUTINE
         MVI   PRFBYTE,X'00' FLAG BYTE ZUR AUSWAHL-PRUEFUNG LOESCHEN
         BAL   R14,GETLEN    VERZW. ZUM BERECHNEN DER ENTRY-LAENGE,
*                            BERECHNEN DER NAECHSTEN ENTRY-ADRESSE
         CLC   NE,=C'NE'
         BNE   NONE1
         TM    PDS2ATTR,X'02'
         BO    NXTENT
NONE1    EQU   *
*                            UND ZUR PRUEFUNG,  OB ALIAS
         BAL   R14,MVCTEXT   VERZW. ZUM PRUEFEN DES MEMBER NAME,
*                            UEBERTR. DER INFORMATIONEN UND ZUR
*                            NACHRICHTENAUSGABE
NXTENT   L     R10,ADDRNENT  ADRESSE DES NAECHSTEN ENTRY LADEN
         CR    R10,R9        ENDE DES BLOCKS ERREICHT ?
         BE    GETLOOP       JA, VERZW. ZUM LESEN DES NAECHSTEN BLOCKS
         CLI   PRFBYTE,X'FF' MEMBER NAME AUSGEWAEHLT ?
         BNE   ENTRYLP       NEIN, VERZWEIGEN ZUR SCHLEIFE
         BCT   R3,ENTRYLP    VERZWEIGEN ZUR SCHLEIFE
         BAL   R14,WTORLOOP  VERZW. ZUR WTOR-NACHRICHTENAUSGABE
         BAL   R14,HEADLOOP  VERZW. ZUR AUSGABE DER UEBERSCHRIFTEN
         B     ENTRYLP       VERZWEIGEN ZUR SCHLEIFE
         EJECT
*
*      ROUTINE BEI ENDE DER ENTRIES.
*
         SPACE 1
ENTRYEND EQU   *
         CLI   TESTBYTE,X'FF' STATISTIK ANGEFORDERT ?
         BNE   CLOSE         NEIN, VERZW. ZUM SCHLIESSEN DER DATEI
         MVI   ENDBYTE,X'FF' ENDE DER ENTRIES ANZEIGEN
         ST    R2,USEDBLKS   ANZ. DER BENUTZTEN BLOECKE SPEICHERN
         B     GETLOOP       VERZW. ZUM LESEN WEITERER BLOECKE
         SPACE 2
*
*      DATEI SCHLIESSEN.
*
         SPACE 1
CLOSE    EQU   *
         LA    R1,DCBADDR    ADRESSE DER DCB-ADRESSE LADEN
         SVC   20            VERZW. ZUM SCHLIESSEN DER DATEI
         B     ENDE          VERZW. ZUM ABSCHLUSS DER VERARBEITUNG
         EJECT
***********************************************************************
*                                                                     *
*      NACHRICHTENAUSGABE MIT REPLY.                                  *
*                                                                     *
***********************************************************************
         SPACE 3
WTORLOOP EQU   *
         CLC   REG4(4),=CL4'TSO'
         BER   R14
         XC    ECB,ECB       EVENT CONTROL BLOCK LOESCHEN
         L     R0,REG4       MCS-ID DER CONSOLE LADEN
         LA    R4,ECB        ADRESSE DES ECB LADEN
         LA    R3,REPLY      ADRESSE DES REPLY LADEN
         MVC   MESSAGE(LENMSG09),MSG09 NACHRICHTENZEILE UEBERTRAGEN
         WTOR  ,(R3),1,(R4),MF=(E,MESSAGE) NACHRICHTENZEILE AUSGEBEN
         SPACE 1
         WAIT  ECB=ECB       WAIT FOR REPLY
         CLI   REPLY,C'Y'    REPLY = YES ?
         BER   R14           JA, VERZW. ZUR WEITEREN VERARBEITUNG
         CLI   REPLY,C'N'    REPLY = NO ?
         BE    CLOSE         JA, VERZW. ZUM SCHLIESSEN DER DATEI
         B     WTORLOOP      VERZW. ZUR WTOR-NACHRICHTENAUSGABE
         EJECT
***********************************************************************
*                                                                     *
*      PRUEFEN DER MEMBER,                                            *
*      AUFBEREITEN DER INFORMATIONEN,                                 *
*      AUSGABE DER NACHRICHTEN.                                       *
*                                                                     *
***********************************************************************
         SPACE 3
MVCTEXT  EQU   *
         ST    R14,SAVE1R14  RUECKSPRUNGADRESSE SPEICHERN
         SPACE 2
*
*      MEMBER NAME PRUEFEN.
*
         SPACE 1
         CLC   PDS2NAME,FROMNAME MEMBER NAME >= VON-PARAMETER ?
         BLR   R14           NEIN, VERZW. ZUR WEITEREN VERARBEITUNG
         CLC   PDS2NAME,TONAME MEMBER NAME <= VON-PARAMETER ?
         BHR   R14           NEIN, VERZW. ZUR WEITEREN VERARBEITUNG
         SPACE 2
*
*      MEMBER NAME UND TTR UEBERTRAGEN.
*
         SPACE 1
         MVI   PRFBYTE,X'FF' MEMBER NAME ALS GUELTIG KENNNZEICHNEN
         MVC   MESSAGE(LENMSG03),MSG03 NACHRICHTENZEILE UEBERTRAGEN
         MVC   MESSAGE+12(54),MESSAGE+11 NACHRICHTENZEILE LOESCHEN
         MVC   MS03MBRN,PDS2NAME MEMBER NAME UEBERTRAGEN
         UNPK  MS03TTR(7),PDS2TTRP(4) TTR UEBERTRAGEN
         MVI   MS03TTR+6,C' ' LEERZEICHEN EINTRAGEN
         TR    MS03TTR,TABHEXA-240 TTR AUFBEREITEN
         B     TESTSSI       NEIN, VERZW. ZUM AUFBER. DER SSI
         SPACE 2
*
*      NACHRICHT AUSGEBEN.
*
         SPACE 1
WTOTEXT  EQU   *
         L     R0,REG4       MCS-ID. DER CONSOLE LADEN
         LA    R1,MESSAGE
         BAL   R14,WTOROUT
         L     R14,SAVE1R14  RUECKSPRUNGADRESSE LADEN
         BR    R14           VERZW. ZUR WEITEREN VERARBEITUNG
         EJECT
*
*      LINKAGE-INFORMATIONEN AUFBEREITEN.
*
         SPACE 1
GETLKEDI EQU   *
         TM    DS1RECFM,X'C0' RECFM = U (AS BUILT BY LINKAGE EDITOR) ?
         BNO   TESTALI       NEIN, VERZWEIGEN
         L     R4,ENTLEN     LAENGE DES ENTRY LADEN
         CH    R4,=H'34'     LAENGE DES ENTRY < 34 ?
         BL    TESTALI       NEIN, VERZWEIGEN
         OI    PDSBYTE,X'80' BLOCK SPEZIFIZIEREN
         SR    R15,R15       R15 LOESCHEN
         ICM   R15,7,PDS2STOR LAENGE DES MEMBERS LADEN
         C     R15,=F'999999' LAENGE > 999999 ?
         BH    HIGHLEN       JA, VERZWEIGEN
         BAL   R14,CONVDEC   VERZW. ZUM UMWANDELN IN DEZIMALZAHL
         MVC   MS03LEN,ZWFELD+9 LAENGE UEBERTRAGEN
         B     TESTATTR      VERZW. ZUR WEITEREN VERARBEITUNG
HIGHLEN  EQU   *
         MVC   MS03LEN,=C'******'
TESTATTR EQU   *
         BAL   R14,PRFATTR   VERZW. ZUM PRUEFEN DER ATTRIBUTE
         TM    PDS2FTB0,X'08' APF-INFORMATIONEN ANGEGEBEN ?
         BZ    MVCATTR       NEIN, VERZWEIGEN
         MVC   0(3,R5),=C'AC=' TEXT FUER AC EINTRAGEN
         L     R4,ADDRNENT   ADRESSE DES NAECHSTEN ENTRY LADEN
         TM    PDS2FTB0,X'10' SSI VORHANDEN ?
         BO    GETAC         JA, VERZWEIGEN
         TM    PDSBYTE,X'20' MEMBER = ALIAS ?
         BO    GETAC         JA, VERZWEIGEN
         BCTR  R4,0          END-ADRESSE DES ENTRY
GETAC    EQU   *
         BCTR  R4,0          ADRESSE DES AC LADEN
         MVC   3(1,R5),0(R4) AC UEBERTRAGEN
         OI    3(R5),C'0'    AC AUFBEREITEN
         MVC   4(4,R5),ATRTBEND ENDE DES VEKTORS
         EJECT
*
*      ATTRIBUT-TEXTE UEBERTRAGEN.
*
         SPACE 1
MVCATTR  EQU   *
         LA    R5,ATTRVEK    ADRESSE DES ATTRIBUT-VEKTORS LADEN
ATTRMNLP EQU   *
         LA    R4,MS03ATTR   ADRESSE DES TEXTBEREICHS LADEN
         LA    R6,4          SCHLEIFENZAEHLER INITIALISIEREN
ATTRLOOP EQU   *
         CLC   0(4,R5),ATRTBEND ENDE DES ATTRIBUT-VEKTORS ERREICHT ?
         BE    TESTALI       JA, VERZW. ZUR NACHRICHTENAUSGABE
         MVC   0(4,R4),0(R5) ATTRIBUT-TEXT UEBERTRAGEN
         LA    R4,5(R4)      R4 UM ANZAHL UEBERTR. ZEICHEN ERHOEHEN
         LA    R5,4(R5)      R5 UM ANZAHL UEBERTR. ZEICHEN ERHOEHEN
         BCT   R6,ATTRLOOP   VERZWEIGEN ZUR SCHLEIFE
         CLC   0(4,R5),ATRTBEND ENDE DES ATTRIBUT-VEKTORS ERREICHT ?
         BE    TESTALI       JA, VERZW. ZUR NACHRICHTENAUSGABE
         L     R0,REG4       MCS-ID DER CONSOLE LADEN
         LA    R1,MESSAGE
         BAL   R14,WTOROUT
         MVC   MESSAGE+12(54),MESSAGE+11 NACHRICHTENZEILE LOESCHEN
         BCT   R3,ATTRLOOP   VERZWEIGEN ZUR SCHLEIFE
         BAL   R14,WTORLOOP  VERZW. ZUR WTOR-NACHRICHTENAUSGABE
         BAL   R14,HEADLOOP  VERZW. ZUR AUSGABE DER UEBERSCHRIFTEN
         MVC   MESSAGE(LENMSG03),MSG03 NACHRICHTENZEILE UEBERTRAGEN
         MVC   MESSAGE+12(54),MESSAGE+11 NACHRICHTENZEILE LOESCHEN
         B     ATTRMNLP      VERZWEIGEN ZUR SCHLEIFE
         EJECT
*
*      ROUTINE FUER MEMBER = ALIAS.
*
         SPACE 1
TESTALI  EQU   *
         TM    PDSBYTE,X'20' ALIAS SPEZIFIZIERT ?
         BZ    WTOTEXT       NEIN, VERZW. ZUR NACHRICHTEN-AUSGABE
         L     R4,ENTLEN     LAENGE DES ENTRY LADEN
         CH    R4,=H'44'     LAENGE < 44 ?
         BNL   MVCALINM      NEIN, VERZWEIGEN
         CLC   MS03ATTR+15(5),BLANK ATTRIBUTE EINGETRAGEN ?
         BE    MVCALIAS      NEIN, VERZWEIGEN
         L     R0,REG4       MCS-ID DER CONSOLE LADEN
         LA    R1,MESSAGE
         BAL   R14,WTOROUT
         MVC   MESSAGE+12(54),MESSAGE+11 NACHRICHTENZEILE LOESCHEN
MVCALIAS EQU   *
         L     R4,4          LOOP COUNT INITIALISIEREN
         LA    R5,MS03ATTR-5 ADRESSE DES ATTRIBUT-TEXTES LADEN
         LA    R5,5(R5)      R5 ERHOEHEN
         CLC   0(5,R5),BLANK BLANK AN DIESER STELLE ?
         BE    *+8           JA, VERZWEIGEN
         BCT   R4,*-14       VERZWEIGEN
         MVC   0(5,R5),ALIASTXT+1 ALIAS SPEZIFIZIEREN
         B     WTOTEXT       VERZW. ZUR NACHRICHTEN-AUSGABE
MVCALINM EQU   *
         CLC   MS03ATTR(5),BLANK ATTRIBUTE EINGETRAGEN ?
         BE    MVCATEXT      NEIN, VERZWEIGEN
         L     R0,REG4       MCS-ID DER CONSOLE LADEN
         LA    R1,MESSAGE
         BAL   R14,WTOROUT
         MVC   MESSAGE+12(54),MESSAGE+11 NACHRICHTENZEILE LOESCHEN
MVCATEXT EQU   *
         MVC   MS03ATTR(19),ALIASTXT TEXT UEBERTRAGEN
         L     R4,ADDRNENT   ADRESSE DES NAECHSTEN ENTRY LADEN
         TM    PDS2FTB0,X'08' APF-INFORMATIONEN ANGEGEBEN ?
         BZ    *+8           NEIN, VERZWEIGEN
         BCTR  R4,0          R4 UM LAENGE DER APF-INFO.
         BCTR  R4,0              VERMINDERN
         TM    PDS2FTB0,X'10' SSI VORHANDEN ?
         BZ    *+8           NEIN, VERZWEIGEN
         SH    R4,=H'4'      R4 UM LAENGE DER SSI VERMINDERN
         SH    R4,=H'8'      ADRESSE DES MEMBER NAME
         MVC   MS03ATTR+10(8),0(R4) MEMBER NAME UEBERTRAGEN
         B     WTOTEXT       VERZW. ZUR NACHRICHTEN-AUSGABE
         EJECT
*
*      PRUEFUNG DER ATTRIBUTE.
*
         SPACE 1
PRFATTR  EQU   *
         LA    R4,ATTRTAB1-5 ADRESSE DER ATTRIBUT-TABELLE LADEN
         LA    R5,ATTRVEK    ADRESSE DES ATTRIBUT-VEKTORS LADEN
         LA    R6,PDS2ATTR   ADRESSE DES ATTRIBUT-FELDES LADEN
         MVI   PRFBYTE,X'00' FLAG BYTE LOESCHEN
         SR    R7,R7         R7 FUER EXECUTE LOESCHEN
PRFLOOP  EQU   *
         LA    R4,5(R4)      ADRESSE DER NAECHSTEN TABELLEN-ZEILE
         CLI   0(R4),X'00'   ENDE  DER TABELLE ERREICHT ?
         BE    PRFLPEND      JA, VERZW. ZUM ENDE DER SCHLEIFE
         IC    R7,0(R4)      ATTRIBUT-BYTE LADEN
         EX    R7,TMATTR     VERZW. ZUM PRUEFEN DES ATTRIBUTS
         BZ    NOATTR        VERZW., WENN ATTRIBUT NICHT VORHANDEN
         CLC   0(5,R4),ATTREXEC MODULE EXECUTABLE ?
         BE    PRFLOOP       JA, VERZW. ZUR SCHLEIFE
         CLC   0(5,R4),ATTRNODC
         BE    PRFLOOP       JA, VERZW. ZUR SCHLEIFE
         MVC   0(4,R5),1(R4) ATTRIBUT-TEXT UEBERTRAGEN
         LA    R5,4(R5)      ADRESSE DES NAECHSTEN VEKTOR-ELEMENTS
         B     PRFLOOP       VERZWEIGEN ZUR SCHLEIFE
PRFLPEND EQU   *
         CLI   PRFBYTE,X'FF' ZWEITES ATTRIBUT-FELD SCHON VERARBEITET ?
         BE    PRFLPOK       JA, VERZW. ZUM ABSCHLUSS DER PRUEFUNGEN
         MVI   PRFBYTE,X'FF' FLAG BYTE SETZEN
         LA    R4,ATTRTAB2-5 ADRESSE DER ATTRIBUT-TABELLE LADEN
         LA    R6,1(R6)      ADRESSE DES ATTRIBUT-FELDES LADEN
         B     PRFLOOP       VERZWEIGEN ZUR SCHLEIFE
PRFLPOK  EQU   *
         MVC   0(4,R5),ATRTBEND ENDE DES VEKTORS ANZEIGEN
         CLC   ATTRVEK+4(4),ATTRREUS+1 RENTERABLE AND REUASABLE ?
         BNER  R14           NEIN, VERZW. ZUM UEBERTR. DER ATTRIBUTE
         MVC   ATTRVEK+4(71),ATTRVEK+8  ATTRIBUT 'REUS' LOESCHEN
         SH    R5,=H'4'      ADRESSE DES VEKTOR-ENDES LADEN
         BR    R14           VERZW. ZUM UEBERTR. DER ATTRIBUTE
         SPACE 1
NOATTR   EQU   *
         CLC   0(5,R4),ATTREXEC MODULE EXECUTABLE ?
         BNE   TSTDC         NEIN, VERZWEIGEN
         MVC   0(4,R5),=C'NE  ' ATTRIBUT = 'NOT EXECUTABLE'
         B     *+20          VERZWEIGEN
TSTDC    CLC   0(5,R4),ATTRNODC
         BNE   PRFLOOP       NEIN, VERZWEIGEN
         MVC   0(4,R5),=C'DC  '
         LA    R5,4(R5)      ADRESSE DES NAECHSTEN VEKTOR-ELEMENTS
         B     PRFLOOP       VERZWEIGEN ZUR SCHLEIFE
         SPACE 2
TMATTR   TM    0(R6),X'00'   ATTRIBUT VORHANDEN ?
         EJECT
***********************************************************************
*                                                                     *
*      ROUTINE FUER DIRECTORY-STATISTIK.                              *
*                                                                     *
***********************************************************************
         SPACE 3
GETSTAT  EQU   *
         MVC   MESSAGE(LENMSG12),MSG12 NACHRICHTENZEILE UEBERTRAGEN
         LR    R15,R2        ANZAHL DER BLOECKE LADEN
         CH    R15,=H'9999'  ANZAHL DER BLOECKE > 9999 ?
         BH    *+14          JA, VERZW. ZUR NACHRICHTENAUSGABE
         BAL   R14,CONVDEC   VERZW. ZUM UMWANDELN IN DEZIMALZAHL
         MVC   MS12BLKS,ZWFELD+11 ANZAHL DER BLOECKE UEBERTRAGEN
         BAL   R14,WTOOUTP   VERZW. ZUR NACHRICHTENAUSGABE
         MVC   MESSAGE(LENMSG13),MSG13 NACHRICHTENZEILE UEBERTRAGEN
         L     R15,USEDBLKS  ANZAHL DER BENUTZTEN BLOECKE LADEN
         CH    R15,=H'9999'  ANZAHL DER BLOECKE > 9999 ?
         BH    *+14          JA, VERZW. ZUR NACHRICHTENAUSGABE
         BAL   R14,CONVDEC   VERZW. ZUM UMWANDELN IN DEZIMALZAHL
         MVC   MS12BLKS,ZWFELD+11 ANZ. DER BLOECKE UEEBERTRAGEN
         L     R0,REG4       MCS-ID DER CONSOLE LADEN
         LA    R1,MESSAGE
         BAL   R14,WTOROUT
         B     CLOSE         VERZW. ZUM SCHLIESSEN DER DATEI
         EJECT
***********************************************************************
*                                                                     *
*      ABSCHLUSSROUTINEN.                                             *
*                                                                     *
***********************************************************************
         SPACE 3
*
*     SPEICHERPLATZFREIGABE,
*     REINITIALISIERUNG DER REGISTER,
*     RUECKSPRUNG ZUM AUFRUFENDEN PROGRAMM.
*
         SPACE 1
ENDE     EQU   *
         XRETURN ,R
         EJECT
***********************************************************************
*                                                                     *
*      FEHLERROUTINEN.                                                *
*                                                                     *
***********************************************************************
         SPACE 3
*
*      ROUTINE BEI FEHLER IN DER PARAMETERKETTE.
*
         SPACE 1
FEHLPARM EQU   *
         L     R0,REG4       MCS-ID DER CONSOLE LADEN
         LA    R1,MSG05
         BAL   R14,WTOROUT
         B     ENDE          VERZWEIGEN
         SPACE 2
*
*      ROUTINE BEI LOCATE-FEHLER.
*
         SPACE 1
FEHLLOC  EQU   *
         MVC   MESSAGE(LENMSG06),MSG06 NACHRICHTENZEILE UEBERTRAGEN
         BAL   R14,CONVDEC   VERZW. ZUM UMWANDELN IN DEZIMALZAHL
         MVC   MS06RC,ZWFELD+13 RETURN CODE UEBERTRAGEN
         LA    R14,ENDE      RUECKSPRUNGADRESSE LADEN
         B     WTOOUTP       VERZW. ZUR NACHRICHTENAUSGABE
         SPACE 2
*
*      ROUTINE BEI OBTAIN-FEHLER.
*
         SPACE 1
FEHLOBT  EQU   *
         MVC   MESSAGE(LENMSG07),MSG07 NACHRICHTENZEILE UEBERTRAGEN
         BAL   R14,CONVDEC   VERZW. ZUM UMWANDELN IN DEZIMALZAHL
         MVC   MS07RC,ZWFELD+13 RETURN CODE UEBERTRAGEN
         LA    R14,ENDE      RUECKSPRUNGADRESSE LADEN
         B     WTOOUTP       VERZW. ZUR NACHRICHTENAUSGABE
         EJECT
*
*      ROUTINE BEI UNGUELTIGER DATEI.
*
         SPACE 1
FEHLORG  EQU   *
         MVC   MESSAGE(LENMSG08),MSG08 NACHRICHTENZEILE UEBERTRAGEN
         LA    R14,ENDE      RUECKSPRUNGADRESSE LADEN
         B     WTOOUTP       VERZW. ZUR NACHRICHTENAUSGABE
         SPACE 2
*
*      ROUTINE BEI ALLOCATION-FEHLER.
*
         SPACE 1
FEHLDYNA EQU   *
         MVC   MESSAGE(LENMSG10),MSG10 NACHRICHTENZEILE UEBERTRAGEN
         L     R15,DALPRC    RETURN CODE LADEN
         BAL   R14,CONVDEC   VERZW. ZUM UMWANDELN IN DEZIMALZAHL
         MVC   MS10RC,ZWFELD+13 RETURN CODE UEBERTRAGEN
         UNPK  MS10EC(5),DALPEC+2(3) ERROR REASON CODE UEBERTRAGEN
         TR    MS10EC,TABHEXA-240 ERROR REASON CODE AUFBEREITEN
         MVI   MS10EC+4,C',' KOMMA EINTRAGEN
         UNPK  MS10IC(5),DALPIC+2(3) INFO. REASON CODE UEBERTRAGEN
         TR    MS10IC,TABHEXA-240 INFO. REASON CODE AUFBEREITEN
         LA    R14,ENDE      RUECKSPRUNGADRESSE LADEN
         B     WTOOUTP       VERZW. ZUR NACHRICHTENAUSGABE
         SPACE 2
*
*      ROUTINE BEI OPEN-FEHLER.
*
         SPACE 1
FEHLOPEN EQU   *
         MVC   MESSAGE(LENMSG11),MSG11 NACHRICHTENZEILE UEBERTRAGEN
         BAL   R14,WTOOUTP   VERZW. ZUR NACHRICHTENAUSGABE
         LA    R2,=C'UNALLOC ' ADRESSE DES DYNALLOC-TYPS
         ST    R2,ADDRTYPE       LADEN UND SPEICHERN
         OI    ADDRDSN,X'80' ENDE DER PARAMETERKETTE SPEZIFIZIEREN
         LA    R1,DALPWKS    ADRESSE DER PARAMETERLISTE LADEN
         L     R15,=V(DYNALC) ADRESSE DES UNTERPROGRAMMS LADEN
         BALR  R14,R15       VERZW. ZUM UNTERPROGRAMM 'DYNALC'
         CLI   DALPRC,X'00'  RETURN CODE = 0 ?
         BNZ   FEHLDYNA      NEIN, VERZW. ZUR FEHLERROUTINE
         EJECT
***********************************************************************
*                                                                     *
*      AUSGABE DER UEBERSCHRIFTEN.                                    *
*                                                                     *
***********************************************************************
         SPACE 2
HEADLOOP EQU   *
         ST    R14,SAVE1R14  RUECKSPRUNGADRESSE SPEICHERN
         MVC   MESSAGE(LENMSG03),MSG03 NACHRICHTENZEILE UEBERTRAGEN
         BAL   R14,WTOOUTP   VERZW. ZUR NACHRICHTENAUSGABE
         LA    R3,10         SCHLEIFEN-ZAEHLER INITIALISIEREN
         L     R14,SAVE1R14  RUECKSPRUNGADRESSE LADEN
         BR    R14           VERZW. ZUR WEITEREN VERARBEITUNG
         SPACE 3
***********************************************************************
*                                                                     *
*      AUSGABE DER NACHRICHTEN MIT UEBERSCHRIFT.                      *
*                                                                     *
***********************************************************************
         SPACE 2
WTOOUTP  EQU   *
         ST    R14,SAVE2R14
         L     R0,REG4       MCS-ID DER CONSOLE LADEN
         LA    R1,HEADER
         BAL   R14,WTOROUT
         L     R0,REG4       MCS-ID DER CONSOLE LADEN
         LA    R1,MESSAGE
         BAL   R14,WTOROUT
         L     R14,SAVE2R14
         BR    R14           VERZWEIGEN
         SPACE 3
***********************************************************************
*                                                                     *
*      UMWANDLUNG VON DUALZAHLEN IN ENTPACKTE DEZIMALZAHLEN.          *
*                                                                     *
***********************************************************************
         SPACE 2
CONVDEC  EQU   *
         CVD   R15,DBWORD    DUALZAHL IN GEP. DEZIMALZAHL UMWANDELN
         UNPK  ZWFELD,DBWORD DEZIMALZAHL ENTPACKEN
         OI    ZWFELD+14,C'0' VORZEICHEN MODIFIZIEREN
         BR    R14           VERZWEIGEN
         EJECT
***********************************************************************
*                                                                     *
*      BERECHNUNG DER ENTRY-LAENGEN.                                  *
*                                                                     *
***********************************************************************
         SPACE 2
GETLEN   EQU   *
         MVI   PDSBYTE,X'00' FLAG BYTE LOESCHEN
         TM    PDS2INDC,X'80' MEMBER = ALIAS ?
         BZ    *+8           NEIN, VERZWEIGEN
         OI    PDSBYTE,X'20' ALIAS SPEZIFIZIEREN
         SR    R4,R4         R4 LOESCHEN
         NI    PDS2INDC,X'1F' LAENGE DER USER DATA FIELDS BESTIMMEN
         IC    R4,PDS2INDC   LAENGE LADEN
         SLA   R4,1          LAENGE IN BYTES BERECHNEN
         LA    R4,12(R4)     LAENGE DES ENTRY LADEN
         ST    R4,ENTLEN         UND SPEICHERN
         AR    R4,R10        ADRESSE DES NAECHSTEN ENTRY
         ST    R4,ADDRNENT       LADEN UND SPEICHERN
         BR    R14           VERZW. ZUR WEITEREN VERARBEITUNG
         SPACE 3
***********************************************************************
*                                                                     *
*      UEBERTREGUNG DER SSI.                                          *
*                                                                     *
***********************************************************************
         SPACE 2
TESTSSI  EQU   *
         L     R5,ADDRNENT   ADRESSE DES NAECHSTEN ENTRY LADEN
         L     R4,ENTLEN     LAENGE DES ENTRY LADEN
         CH    R4,=H'12'     LAENGE = 12 ?
         BE    TESTALI       JA, VERZWEIGEN
         CH    R4,=H'34'     LAENGE < 34 ?
         BL    GETSSI        JA, VERZWEIGEN
         CH    R4,=H'38'     LAENGE = 38 ?
         BE    GETSSI        JA, VERZWEIGEN
         TM    PDS2FTB0,X'10' SSI VORHANDEN ?
         BZ    GETLKEDI      NEIN, VERZWEIGEN
         TM    PDS2FTB0,X'08' APF-INFO. VORHANDEN ?
         BZ    GETSSI        NEIN, VERZWEIGEN
         BCTR  R5,0          R5 UM LAENGE DER APF-INFO.
         BCTR  R5,0              VERMINDERN
GETSSI   EQU   *
         SH    R5,=H'4'      ADRESSE DER SSI LADEN
         UNPK  MS03SSI(9),0(5,R5) SSI UEBERTRAGEN
         MVI   MS03SSI+8,C' ' BLANK EINTRAGEN
         TR    MS03SSI,TABHEXA-240 SSI AUFBEREITEN
         B     GETLKEDI      VERZW. ZUR WEITEREN VERARBEITUNG
         SPACE 3
WTOROUT  EQU   *
         ST    R14,SAVE3R14
         C     R0,=CL4'TSO '
         BNE   DOWTO
         LH    R0,0(R1)
         SH    R0,=H'4'
         LA    R1,4(R1)
         SVC   93
         L     R14,SAVE3R14
         BR    R14
DOWTO    EQU   *
         WTO   MF=(E,(1))
         L     R14,SAVE3R14
         BR    R14
         EJECT
***********************************************************************
*                                                                     *
*      REGISTER EQUATES.                                              *
*                                                                     *
***********************************************************************
         SPACE 3
R0       EQU   0             MACRO- UND PARAMETER-REGISTER
R1       EQU   1             MACRO- UND PARAMETER-REGISTER
R2       EQU   2             ARBEITSREGISTER
R3       EQU   3             ARBEITSREGISTER
R4       EQU   4             ARBEITSREGISTER
R5       EQU   5             ARBEITSREGISTER
R6       EQU   6             ARBEITSREGISTER
R7       EQU   7             ARBEITSREGISTER
R8       EQU   8             ARBEITSREGISTER
R9       EQU   9             ARBEITSREGISTER
R10      EQU   10            BASIS FUER DSECT PDS
R11      EQU   11            BASIS FUER DSECT PARMAREA
R12      EQU   12            BASIS FUER CSECT LPDS
R13      EQU   13            BASIS FUER DSECT ABER
R14      EQU   14            RUECKSPRUNGADRESSEN
R15      EQU   15            CSECT-ADRESSEN UND RETURN CODES
         EJECT
***********************************************************************
*                                                                     *
*      DEFINITIONEN DER KONSTANTEN-SPEICHER.                          *
*                                                                     *
***********************************************************************
         SPACE 3
*
*      PARAMETERLISTE FUER 'DYNALC' (KONSTANTEN).
*
         SPACE 1
DALPCON  DS    0F
         DC    A(0)          ADRESSE DER RETURN CODES
         DC    A(DALPTYPE)   ADRESSE DES DYNALLOC-TYPS
         DC    A(0)          ADRESSE DES DDNAME
         DC    A(0)          ADRESSE DES DATA SET NAME
         DC    A(0)
         DC    A(DALPSTAT)   ADRESSE DES DATA SET STATUS
         DC    A(DALPDISP)   ADRESSE DER NORM. DISPOSITION
         DC    A(DALPDISP)   ADRESSE DER COND. DISPOSITION
         DC    7A(0)
         DC    AL1(128)      ENDE DER PARAMETERKETTE
         DC    AL3(0)        ADRESSE DER VOLSER NUMBER
DALPLEN  EQU   *-DALPCON     LAENGE DER PARAMETERKETTE
DALPSTAT DC    C'SHR'        DATA SET STATUS
DALPDISP DC    CL8'KEEP'     DATA SET DISPOSITION
DALPTYPE DC    C'DSALLOC '   DYNALLOC-TYP
         SPACE 2
*
*      TABELLE ZUM AUFBEREITEN VON HEXADEZIMALZAHLEN.
*
         SPACE 1
TABHEXA  DC    C'0123456789ABCDEF'
         SPACE 1
ALIASTXT DC    C'(ALIAS OF 12345678)'
NE       DC    CL2' '
         EJECT
*
*      ATTRIBUT-TABELLEN.
*
         SPACE 1
ATTRTAB1 EQU   *
         DC    X'80',C'RENT' REENTERABLE
ATTRREUS DC    X'40',C'REUS' REUSABLE
         DC    X'20',C'OVLY' IN OVERLAY STRUCTURE
         DC    X'10',C'TEST' UNDER TEST
         DC    X'08',C'OL  ' ONLY LOADABLE
         DC    X'04',C'SCTR' SCATTER FORMAT
ATTREXEC DC    X'02',C'EXEC' EXECUTABLE
         DC    X'00',C'XXXX' TABELLENENDE
         SPACE 1
ATTRTAB2 EQU   *
ATTRNODC DC    X'80',C'NODC'
         DC    X'10',C'NRLD' NO RLD ITEMS
         DC    X'08',C'NREP' NO REPROCESSABLE
         DC    X'04',C'SYMS'
         DC    X'01',C'REFR' REFRESHABLE
         DC    X'00'         TABELLEN-
ATRTBEND DC    C'XXXX'           ENDE
         EJECT
*
*      DCB DER EINGABEDATEI (KONSTANTEN).
*
         SPACE 1
DCBCONST DCB   DDNAME=EIN00000,                                        *
               DSORG=PS,                                               *
               MACRF=(GL),                                             *
               RECFM=F,                                                *
               LRECL=256,                                              *
               BLKSIZE=256,                                            *
               EODAD=GETSTAT
DCBLEN   EQU   *-DCBCONST    LAENGE DES DCB
         EJECT
***********************************************************************
*                                                                     *
*      DEFINITION DER AUSGABENACHRICHTEN.                             *
*                                                                     *
***********************************************************************
         SPACE 3
MSG01    WTO   'XLPDS01 DSN=                                           *
                      ',                                               *
               MF=L,MCSFLAG=(REG0)
LENMSG01 EQU   *-MSG01
BLANK    EQU   MSG01+16
         SPACE 1
MSG02    WTO   'XLPDS02 CATALOG ON 123456 POINTS TO 123456',           *
               MF=L,MCSFLAG=(REG0)
LENMSG02 EQU   *-MSG02
         SPACE 1
MSG03    WTO   'XLPDS03 --NAME-- -TTR-- LENGTH --SSI--- -----ATTRIBUTES*
               -----',                                                 *
               MF=L,MCSFLAG=(REG0)
LENMSG03 EQU   *-MSG03
         SPACE 1
MSG04    WTO   'XLPDS04 FUNCTION SUPPORTED FO OS/VS2 (MVS) ONLY',      *
               MF=L,MCSFLAG=(REG0)
         EJECT
MSG05    WTO   'XLPDS05 ERROR IN PARAMETER LIST',                      *
               MF=L,MCSFLAG=(REG0)
         SPACE 1
MSG06    WTO   'XLPDS06 DATA SET NOT FOUND IN CATALOG, LOCATE RC=99',  *
               MF=L,MCSFLAG=(REG0)
LENMSG06 EQU   *-MSG06
         SPACE 1
MSG07    WTO   'XLPDS07 DATA SET NOT FOUND ON VOLUME, OBTAIN RC=99',   *
               MF=L,MCSFLAG=(REG0)
LENMSG07 EQU   *-MSG07
         SPACE 1
MSG08    WTO   'XLPDS08 DATA SET IS NOT PARTITIONED',                  *
               MF=L,MCSFLAG=(REG0)
LENMSG08 EQU   *-MSG08
         EJECT
MSG09    WTOR  'XLPDS09 REPLY ''Y'' (YES) OR ''N'' (NO) TO CONTINUE',  *
               MF=L,MCSFLAG=(REG0)
LENMSG09 EQU   *-MSG09
         SPACE 1
MSG10    WTO   'XLPDS10 ALLOCATION FAILURE, RC=99, EC=9999, IC=9999',  *
               MF=L,MCSFLAG=(REG0)
LENMSG10 EQU   *-MSG10
         SPACE 1
MSG11    WTO   'XLPDS11 OPEN FAILURE',                                 *
               MF=L,MCSFLAG=(REG0)
LENMSG11 EQU   *-MSG11
         SPACE 1
MSG12    WTO   'XLPDS12 **** DIRECTORY BLOCKS TOTAL',                  *
               MF=L,MCSFLAG=(REG0)
LENMSG12 EQU   *-MSG12
         SPACE 1
MSG13    WTO   'XLPDS13 **** DIRECTORY BLOCKS USED',                   *
               MF=L,MCSFLAG=(REG0)
LENMSG13 EQU   *-MSG13
         EJECT
***********************************************************************
*                                                                     *
*      DEFINITION DER ARBEITSBEREICHE.                                *
*                                                                     *
***********************************************************************
         SPACE 3
ABER     DSECT
SAVEAREA DS    18F           SAVEAREA FUER ALLGEMEINE REGISTER
DBWORD   DS    D             ZWISCHENSPEICHER FUER DEZIMALZAHLEN
ZWFELD   DS    CL15          ZWISCHENSPEICHER FUER DEZIMALZAHLEN
TESTBYTE DS    C             FLAG BYTE FUER STATISTIK-INFORMATION
ENDBYTE  DS    C             FLAG BYTE FUER ENTRY-ENDE
PRFBYTE  DS    C             FLAG BYTE FUER AUSWAHL-PRUEFUNG
PDSBYTE  DS    C             FLAG BYTE FUER PDS-SATZ
REPLY    DS    C             SPEICHER FUER REPLY
VOLSERNO DS    CL6           VOLUME SERIAL NUMBER
ECB      DS    F             EVENT CONTROL BLOCK
FROMNAME DS    CL8           VON-PARAMETER
TONAME   DS    CL8           BIS-PARAMETER
USEDBLKS DS    F             SPEICHER FUER ANZAHL DER BENUTZTEN BLOECKE
SAVE1R14 DS    F             SAVEAREA FUER RETURN-ADDRESSEN
SAVE2R14 DS    F             SAVEAREA FUER RETURN-ADDRESSEN
SAVE3R14 DS    F             SAVEAREA FUER RETURN-ADDRESSEN
ENTLEN   DS    F             LAENGE DES ENTRY
ADDRNENT DS    F             ADRESSE DES NAECHSTEN ENTRY
ATTRVEK  DS    CL80          ATTRIBUT-VEKTOR
         SPACE 2
*
*      DCB DER EINGABEDATEI.
*
         SPACE 1
EIN      DS    0F
         DS    10F
DCBDDN   DS    CL8           DDNAME
DCBOFLGS DS    C             FLAG BYTE
         ORG   EIN+DCBLEN
DCBADDR  DS    F             ADRESSE DES DCB
         SPACE 2
CAMLIST  DS    4F            BEREICH FUER CAMLIST-MACRO
         DS    0D
CAMWKFLD DS    0CL265        WORK FIELD
         SPACE 2
*
*      DEFINITIONEN DER VOLSER-LISTE.
*
         SPACE 1
         ORG   CAMWKFLD+6
CAMVOLI  DS    CL6           VOLSER NUMBER
         ORG   CAMWKFLD+259
CAMCVOL  DS    CL6           VOLSER NUMBER DES CATALOGS
         EJECT
*
*      DSCB1-DEFINITIONEN.
*
         SPACE 1
         ORG   CAMWKFLD
DS1FMTID DS    C             FORMAT IDENTIFIER (= C'1')
         DS    CL37
DS1DSORG DS    CL2           DATA SET ORGANISATION
DS1RECFM DS    C             DATA SET RECORD FORMAT
         DS    C
DS1BLKL  DS    CL2           DATA SET BLOCK LENGTH
DS1RECL  DS    CL2           DATA SET RECORD LENGTH
         DS    CL3
DS1DSIND DS    C             DATA SET INDICATORS
DS1CCHHR DS    CL5           CCHHR-ADRESSE DES DSCB1
         ORG   CAMWKFLD+265
         SPACE 2
*
*      PARAMETERLISTE FUER 'DYNALC' (ARBEITSBEREICH).
*
         SPACE 1
DALPWKS  DS    0F
ADDRRC   DS    F             ADRESSE VON RETCODE
ADDRTYPE DS    F             ADRESSE DES DYNALLOC-TYPS
ADDRDDN  DS    F             ADRESSE DES DDNAME
ADDRDSN  DS    F             ADRESSE DES DSNAME
         DS    11F
ADDRVOLI DS    F             ADRESSE DER VOLSER NUMBER
         SPACE 1
DALPRC   DS    F             RETURN CODE
DALPEC   DS    F             ERROR REASON CODE
DALPIC   DS    F             INFORMATION REASON CODE
DALPDDN  DS    CL8           DDNAME
         EJECT
*
*      NACHRICHTEN-BEREICHE.
*
         SPACE 1
HEADER   DS    0F            UEBERSCHRIFTENZEILE
         ORG   HEADER+16
DSNAME   DS    CL44          DATA SET NAME
         ORG   HEADER+LENMSG01
         SPACE 1
MESSAGE  DS    0F            NACHRICHTENZEILE
         ORG   MESSAGE+12
         DS    CL11
MS02CVOL DS    CL6           CVOL NUMBER
         DS    CL11
MS02VOLI DS    CL6           VOLSER NUMBER
         ORG   MESSAGE+12
MS03MBRN DS    CL8           MEMBER NAME
         DS    C
MS03TTR  DS    CL6           ADRESSE DES MEMBERS (TTR)
         DS    C
MS03LEN  DS    CL6           LAENGE DES MEMBERS
         DS    C
MS03SSI  DS    CL8           SSI-INFORMATIONEN
         DS    C
MS03ATTR DS    CL22          MODULE ATTRIBUTES
         ORG   MESSAGE+12
         DS    CL41
MS06RC   DS    CL2           RETURN CODE
         ORG   MESSAGE+12
         DS    CL40
MS07RC   DS    CL2           RETURN CODE
         ORG   MESSAGE+12
         DS    CL23
MS10RC   DS    CL2           RETURN CODE
         DS    CL5
MS10EC   DS    CL4           ERROR REASON CODE
         DS    CL5
MS10IC   DS    CL4           INFORMATION REASON CODE
         ORG   MESSAGE+12
MS12BLKS DS    CL4           NUMBER OF BLOCKS
         ORG   MESSAGE+66
         SPACE 1
ABERL    EQU   *-ABER        LAENGE DER ARBEITSBEREICHE
         EJECT
***********************************************************************
*                                                                     *
*      PARAMETERBEREICH.                                              *
*                                                                     *
***********************************************************************
         SPACE 3
         XPARM
         SPACE 3
***********************************************************************
*                                                                     *
*      PARTITIONED DATA SET ENTRY.                                    *
*                                                                     *
***********************************************************************
         SPACE 3
PDS      DSECT
PDS2NAME DS    CL8           MEMBER NAME
PDS2TTRP DS    CL3           TTR OF FIRST BLOCK
PDS2INDC DS    C             INDICATORS
PDS2TTRT DS    CL3
PDS2ZERO DS    C
PDS2TTRN DS    CL3
PDS2NL   DS    C
PDS2ATTR DS    CL2           ATTRIBUTE FIELD
PDS2STOR DS    CL3           TOTAL LENGTH OF MEMBER
PDS2FTBL DS    CL2
PDS2EPA  DS    CL3
PDS2FTB0 DS    CL3           FLAG BYTES
         EJECT
         END   LPDS
./ ADD NAME=MEMTERM
         TITLE 'MEMTERM,  FORCE MEMORY TERMINATION BY JOBNAME OR ASID'
MEMTERM  CSECT
         SPACE 3
*              REGISTER USAGE AND EQUATES
         SPACE 3
R0       EQU   0
R1       EQU   1                        WORK REGISTER
R2       EQU   2                        JOBNAME LENGTH
R3       EQU   3                        ASVT, CURRENT ASCB
R4       EQU   4                        ASCB ADDRESS
R5       EQU   5                        JBNI FIELD ADDRESS
R6       EQU   6                        WORK REGISTER
R7       EQU   7                        CURRENT ASID
R8       EQU   8                        MAXU
R9       EQU   9
R10      EQU   10                       BRANCH REGISTER
R11      EQU   11                       ADDRESS OF PARMAREA
R12      EQU   12                       BASE REGISTER
R13      EQU   13                       SAVE AREA, WORK AREA
R14      EQU   14                       RETURN REGISTER
R15      EQU   15                       ENTRY POINT
         EJECT
         XSAVE R12,,MEMTERM,LENGTH
         USING PARMAREA,R11
         USING WORK,R13
         B     GO
VERSION  DC    CL8'V01-M03'
         CNOP  0,4
GO       EQU   *
         CLC       REG4(4),=CL4'TSO'
         BNE       NOTSO
         TPUT      TSOMSG,70
         B         RETURN
NOTSO    EQU       *
         LR    R11,1
         LA    R4,WORK+72
         L     R5,ALENGTH
         LA    R6,WORK+72
         SR    R7,R7
         MVCL  R4,R6
         MVC   DUMPSAVE(4),=CL4'SAVE'
         MVI   ASIDSW,X'00'
         MVC   CNID,REG4                SAVE CONSOLE ID
         L     R6,16                    GET CVT ADDRESS
         TM    116(R6),X'01'            TEST FOR MVS SYSTEM
         BZ    NONMVS
       MODESET KEY=ZERO
         TS    LOCK
         BNZ   INUSE
ASVT     EQU   *
         L     R3,556(R6)               GET ASVT ADDRESS
         L     R8,516(R3)               LOAD MAXU
         LA    R3,528(R3)               POINT TO FIRST ASCB ENTRY
MISS     EQU   *
         CLI   11(R11),C','             TEST JOBNAME MISSING
         BNE   NOJOBN
         CLI   12(R11),C' '             TEST JOBNAME MISSING
         BE    NOJOBN
         CLC   12(5,R11),=C'ASID='      TEST FOR ASID KEYWORD
         BE    BYASID
         B     BYJBNM
BYASID   EQU   *                        MEMORY TERMINATION BY ASID
         MVI   ASIDSW,X'F0'             SET ASID SWITCH ON
         XC    JOBWK,JOBWK
         MVC   JOBWK(4),17(R11)         MOVE ZONED ASID TO WORK AREA
         BAL   R10,DGTST                TEST AND CONVERT INPUT
         ST    R7,ASID1                 SAVE ASID
         CR    R7,R8                    ASID GT MAX USER ?
         BH    NOASID                   YES, I CAN DO NOTHING FOR YOU
         B     FOUND                    DO NOT SEARCH ASID ACTIVE
BYJBNM   EQU   *                        MEMORY TERMINATION BY JOBNAME
         MVC   JOBN1,BLANK
         MVC   JOBWK,12(R11)            MOVE JOBNAME TO WORKAREA
         BAL   R10,JBNTST               GOTO TEST LENGTH OF JOBNAME
         ST    R2,JOBN1L                SAVE JOBNAME LENGTH
         BCTR  R2,0                     SUBTRACT ONE
         EX    R2,JBN1MVC               MOVE NOW JOBNAME
LDASCB   EQU   *
         L     R4,0(R3)                 LOAD ASCB ADDRESS
         TM    0(R3),X'80'              TEST FOR AVAILABLE ENTRY
         BO    NASGN                    ENTRY IS NOT ASSIGNED
         SR    R7,R7                    CLEAR REGISTER
         LH    R7,36(R4)                LOAD ASID
JBNI     L     R5,172(R4)               LOAD JOBNI ADDRESS
         LTR   R5,R5                    TEST FOR ZERO ADDRESS
         BZ    JBNS                     TRY JBNS FIELD
         CLC   0(8,R5),JOBN1            COMPARE JOBNAME
         BNE   JBNS                     NOT FOUND
         MVI   JBNID,C'I'               SET IDENTIEFIER
         B     FOUND
JBNS     L     R5,176(R4)               LOAD JOBNS ADDRESS
         LTR   R5,R5                    TEST FOR ZERO ADDRESS
         BZ    NASGN                    GO TO TRY NEXT ASCB
         CLC   0(8,R5),JOBN1            COMPARE JOBNAME
         BNE   NASGN                    NO SUCCESS
         MVI   JBNID,C'S'               SET IDENTIEFIER
         B     FOUND
NASGN    LA    R3,4(R3)                 INCREMENT ASID ENTRY
         BCT   R8,LDASCB                LOOP UP TO MAXU
         B     NOEXEC                   JOBNAME IS NOT EXECUTING
FOUND    EQU   *                        BE HAPPY, JOBNAME IS FOUND
JOBNWTOR XC    CNECB,CNECB
         XC    CNINP,CNINP
         MVC   CNTXT,MSG3               PREPARE WTOR FOR JOBNAME
         L     R0,CNID
         WTOR  ,CNINP,9,CNECB,MF=(E,CNTXT)
         WAIT  ECB=CNECB                WAIT FOR SLOWEST OPERATOR
         OC    CNINP,BLANK              CONVERT INPUT
         TM    ASIDSW,X'F0'             ASID SWITCH ON ?
         BO    ASIDON                   MEMORY TERMINATION BY ASID
         MVC   JOBN2(8),CNINP           SAVE JOBNAME
         CLC   JOBN1,JOBN2              COMPARE WITH JOBNAME FROM
         BNE   JBNNEQU                  . MODIFY COMMAND
EQUAL    EQU   *
         ST    R7,ASIDC                 SAVE CURRENT ASID
         C     R7,SYSTSK                CHECK FOR ASID USED FOR SYSTEM
         BH    KILLNOW                  IT WAS A USER ASID
MVSWTOR  EQU   *                        ASID IS USED FOR MVS ITSELF
         XC    CNECB,CNECB              SETUP FOR WTOR XMTERM7
         MVC   CNINP,BLANK
         MVC   CNTXT,MSG7
         L     R0,CNID
         WTOR  ,CNINP,8,CNECB,MF=(E,CNTXT)
         WAIT  ECB=CNECB                WAIT FOR OPERATOR'S CHOICE
         OC    CNINP,BLANK
         CLC   YES,CNINP                IS REPLY 'YES' ???
         BNE   RETURN                   VERY NICE, I CAN RETURN NOW
OVRKILL  L     R0,CNID                  SEND HORRIBLE MESSAGE
         WTO   MF=(E,MSG$)
         B     KILLNOW                  KILL MVS
KILLNOW  EQU   *
       MODESET KEY=ZERO,MODE=SUP
         LR    R6,R13                   SAVE R13 BECAUSE RTM NEEDS ITS
         LA    R13,SAVE2                OWN SAVE AREA
         BC    0,SKIPRTM                FOR SZAP TO DEACTIVATE RTM
*      CALLRTM TYPE=MEMTERM,COMPCOD=255,ASID=(R7)
         LA    R1,255 ***************** LOAD PARAMETER REG1
         SLL   1,12(0) **************** COMPCODE IN POSITION
         LA    0,136(,0) ************** DUMP/STEP/DUMPOPTS/ASID
         SLL   0,24(0) **************** SHIFT TO HIGTH ORDER BYTE
         OR    1,0 ******************** OR IN WITH COMPCODE
         LR    2,R7 ******************* GET REG2 WITH ASID
         L     15,X'10'(,0) *********** GET CVT ADDRESS
         L     15,52(,15) ************* ADDR OF CVTBTERM TABLE
         L     15,32(,15) ************* ADDRESS OF ENTRY POINT
         BALR  14,15 ******************
SKIPRTM  EQU   *
         LR    R13,R6                   RESTORE SAVE AREA
END0     EQU   *
         UNPK  CASID(9),ASIDC(5)        PREPARE FOR MSG 8
         TR    CASID(8),ZTAB
         XC    CNTXT,CNTXT
         MVC   CNTXT,MSG8               SET UP MSG 8
         MVC   CNTXT+32(4),CASID+4      STORE ASID IN MESSAGE
         MVC   CNTXT+41(1),JBNID        MOVE JOBNAME FOUND ID
         L     R0,CNID
         WTO   MF=(E,CNTXT)             SEND FINAL MESSAGE
RETURN   EQU   *
       MODESET KEY=NZERO,MODE=PROB
       XRETURN 0,R
         EJECT
JBNTST   EQU   *                        JOBNAME TEST ROUTINE
         MVI   JOBEND,C'*'              MOVE END INDICATOR
         OC    JOBWK,BLANK
         LA    R2,JOBWK                 LOAD POINTER
         LR    R1,R2
JBNTST1  CLI   0(R2),C'A'
         BL    JBNTST8                  PROBABLE LENGTH FOUND
JBNTST2  LA    R2,1(R2)                 INCREMENT BY ONE
         B     JBNTST1
JBNTST8  CLI   0(R2),C'#'               VALID
         BE    JBNTST2
         CLI   0(R2),C'$'                    ANS
         BE    JBNTST2
         CLI   0(R2),C'@'                         CHARACTER
         BE    JBNTST2
         SR    R2,R1                    CALCULATE LENGTH FOR MOVE
         BR    R10                      RETURN TO CALLER
DGTST    EQU   *                        DIGITAL TEST AND CONVERTION
         LA    R1,4                     LOOP 4 TIMES
         LA    R6,JOBWK                 LOAD POINTER
DGTST2   TM    0(R6),X'F0'              TEST FOR X'F0' TO X'F9'
         BNO   NOASID                   INVALID INPUT
         LA    R6,1(R6)                 INCREMENT
         BCT   R1,DGTST2                LOOP
         PACK  DWORD,JOBWK(4)           PREPARE FOR CVB
         CVB   R7,DWORD                 AND DO IT NOW
DGTST9   BR    R10                      RETURN TO CALLER
ASIDON   EQU   *
         CLC   CNINP(5),=C'ASID='       TEST FOR ASID KEYWORD
         BNE   NOJOBN
         OI    ASIDSW,X'FF'             SET 2ND ASIDSW ON
         XC    JOBWK,JOBWK
         MVC   JOBWK(4),CNINP+5         MOVE ZONED ASID TO WORK AREA
         BAL   R10,DGTST                TEST AND CONVERT INPUT
         ST    R7,ASID2                 SAVE ASID
         CLC   ASID1,ASID2              TEST FOR EQUAL ASID'S
         BNE   JBNNEQU
         B     EQUAL
NOASID   EQU   *
         MVC   CNTXT,MSG9               MOVE MESSAGE SKELETON
         L     R0,CNID
         MVC   CNTXT+18(4),JOBWK        MOVE INVALID ASID TO MESSAGE
         WTO   ,MF=(E,CNTXT)
DUMP     EQU   *                        FOR FUTURE EXPANSION
         STM   R0,R15,DUMPSAVE+4        SAVE REGISTERS
         DC    F'0'                     FORCE ABEND 0C1
NONMVS   EQU   *
         L     R0,CNID
         WTO   MF=(E,MSG6)
         B     RETURN
INUSE    EQU   *
         L     R0,CNID
         WTO   MF=(E,MSG1)
         B     RETURN
NOJOBN   EQU   *
         L     R0,CNID
         WTO   MF=(E,MSG2)
         B     RETURN
NOEXEC   EQU   *
         L     R0,CNID
         MVC   CNTXT,MSG5
         MVC   CNTXT+13(8),JOBN1        MOVE JOBNAME INTI MESSAGE
         WTO   ,MF=(E,CNTXT)
         B     RETURN
JBNNEQU  EQU   *
         L     R0,CNID
         WTO   MF=(E,MSG4)
         B     RETURN
         EJECT
MSG0     WTO   'XMTERM0',                                              *
               MCSFLAG=REG0,MF=L
MSG1     WTO   'XMTERM1  MEMORY TERMINATION ALLREADY IN USE',          *
               MCSFLAG=REG0,MF=L
MSG2     WTO   'XMTERM2  JOBNAME OR ASID MISSING BUT REQUIRED',        *
               MCSFLAG=REG0,MF=L
MSG3     WTOR  'XMTERM3  SPECIFY JOBNAME OR ASID FOR MEMORY TO BE TERMI*
               NATED',                                                 *
               MCSFLAG=REG0,MF=L
MSG4     WTO   'XMTERM4  JOBNAME OR ASID JUST GIVEN IS NOT EQUAL TO JOB*
               NAME IN MODIFY COMMAND',                                *
               MCSFLAG=REG0,MF=L
MSG5     WTO   'XMTERM5  JJJJJJJJ IS NOT EXECUTING',                   *
               MCSFLAG=REG0,MF=L
MSG6     WTO   'XMTERM6  NO MVS SYSTEM, MEMTERM MUST TERMINATE',       *
               MCSFLAG=REG0,MF=L
MSG7     WTOR  'XMTERM7  YOU WOULD LIKE TO KILL A MEMORY USED BY MVS IT*
               SELF ???',                                              *
               MCSFLAG=REG0,MF=L
MSG8     WTO   'XMTERM8  MEMORY WITH ASID=X''HHHH''(JBNX) HAS BEEN INIT*
               IALIZED FOR TERMINATION',                               *
               MCSFLAG=REG0,MF=L
MSG9     WTO   'XMTERM9  ASID=XXXX IS NOT VALID',                      *
               MCSFLAG=REG0,MF=L
MSG$     WTO   'XMTERM*  *** MEMTERM''S MVS OVERKILL NOW ACTIVE ***',  *
               MCSFLAG=REG0,MF=L
TSOMSG   DC    CL70'XMTERM0 X-MEMTERM NOT SUPPORTED UNDER TSO'
         EJECT
SYSTSK   DC    F'3'                     HIGHEST ASID FOR MVS ITSELF
ALENGTH  DC    A(LENGTH-72)             LENGTH OF WORK AREA MINUS SAVE
LOCK     DC    X'00'                    LOCK BYTE
YES      DC    CL8'YES'
NO       DC    CL8'NO'
BLANK    DC    CL8' '
         DC    A(16777215)
JBN1MVC  MVC   JOBN1(0),JOBWK
JBN2MVC  MVC   JOBN2(0),JOBWK
         ORG   *-240                    TRANSLATE TABLE
ZTAB     EQU   *
         ORG   *+240
         DC    CL16'0123456789ABCDEF'
         SPACE 6
         LTORG
         EJECT
         XPARM
         SPACE 6
WORK     DSECT
SAVE     DS    18F                      STANDARD SAVE AREA
SAVE2    DS    18F                      SAVE AREA FOR CALLRTM BECAUSE
RSVD0    DS    0F                       RTM WILL DO 'STM 0,15,8(13)'
DUMPSAVE DS    18F                      SAVE AREA IN CASE OF ABEND 0C1
CNID     DS    F                        CONSOLE ID
CNECB    DS    F                        WTOR ECB
CNINP    DS    2D                       WTOR REPLY AREA
JOBN1    DS    D                        JOBNAME FROM MODIFY COMMAND
JOBN2    DS    D                        JOBNAME FROM WTOR MSG XMTERM3
JOBN1L   DS    F                        LENGTH OF JOBNAME 1
JOBN2L   DS    F                        LENGTH OF JOBNAME 2
ASIDC    DS    F                        CURRENT ASID
ASID1    DS    F                        ASID 1 SAVE AREA
ASID2    DS    F                        ASID 2 SAVE AREA
RSVD1    DS    F
CASID    DS    CL8                      HEX ASID IN UNPACKED FORMAT
RSVD2    DS    CL8
         DS    0F
CNTXT    DS    CL80                     WORK AREA FOR WTOR'S
RSVD3    DS    F
DWORD    DS    D                        WORK AREA FOR CVB INSTR
JOBWK    DS    CL8                      WORK AREA FOR JOBNAME TESTING
JOBEND   DS    CL1                      END OF JOBWK
ASIDSW   DS    CL1                      ASID SWITCH
JBNID    DS    CL1                      JOBNAME FOUND IDENTIFIER
LENGTH   EQU   *-WORK
         EJECT
*CVTMAP   CVT   DSECT=YES
         EJECT
         PRINT NOGEN
*         IHAPSA  DSECT=YES
         PRINT GEN
         SPACE 6
         END   MEMTERM
./ ADD NAME=MONITOR
//Z223478M JOB (6685,478,1),
//   TIME=1,CLASS=1,MSGCLASS=T,NOTIFY=Z223478
//ASM  EXEC ASMFCL,LEPRM=',AC=1,NCAL'
//ASM.SYSLIB  DD DSN=SYS1.MACLIB,DISP=SHR,UNIT=DISK,VOL=SER=DSR00T
//            DD DSN=LU.MACLIB,DISP=SHR
//ASM.SYSIN DD *
MONITOR  START
MONITOR  AMODE 31
MONITOR  RMODE 24
         REG
         XSAVE (R12,R11),,MONITOR,WORKL
         USING WORK,R13
         USING DMNDSCT,R5
         LA    R2,CLEAR
         LR    R4,R2
         LA    R3,CLEARLL
         SR    R5,R5
         MVCL  R2,R4
         L     R2,16
         MVC   MODE,116(R2)     SAVE MODE
         L     R2,X'C4'(R2)     SMCA
         L     R2,X'80'(R2)     SMCA-USER
         MVC   IMSAFF,20(R2)
         MVC   TSOAFF,24(R2)
         MVI   HEAD3,C'*'
         MVC   HEAD3+1(77),HEAD3
         MVI   HEAD4,C'-'
         MVC   HEAD4+1(77),HEAD4
         L     R1,0(R1)
         LH    R2,2(R1)
         LA    R1,2(R2,R1)
         OC    0(8,R1),=CL8' '
         CLC   2(4,R1),=CL4'AUTO'
         BNE   NOAUTO
         MVI   AUTO,X'FF'
NOAUTO   EQU   *
*        L     R2,16               CVT
*        L     R2,0(R2)
*        L     R2,12(R2)           ASCB
*        L     R2,108(R2)          ASXB
*        L     R1,4(R2)            FIRST TCB
*        LA    R15,TCBSVC1
*        SVC   250
         L     R2,16
         L     R2,0(R2)
         L     R2,4(R2)           CURRENT TCB
         L     R2,12(R2)          TIOT
         CLC   0(5,R2),=CL5'Z134M'
         BNE   TIMELOOP
         MVC   RESETCMD+12(1),5(R2)
         LA    R1,RESETCMD
         SVC   249
         LA    R15,DSWPSVC
         SVC   250
TIMELOOP EQU   *
         XC    LINECT(4),LINECT
         OI    FUNCIND,DISPSUPP
         CALL  SDIMSMON,(TEST,TEST),VL
         LTR   R15,R15
         BNZ   NOIMS
         MVC   MAXLIN(4),=F'14'
         MVI   IMS+1,X'00'
         B     IMSACT
NOIMS    EQU   *
         MVC   MAXLIN(4),=F'17'
         MVI   IMS+1,X'F0'
IMSACT   EQU   *
         TIME  DEC
         ST    R0,FULLWD
         UNPK  DBLWD,FULLWD
         MVC   HEAD1(2),DBLWD+1
         MVC   HEAD1+3(2),DBLWD+3
         MVC   HEAD1+6(2),DBLWD+5
         L     R2,16
         L     R3,604(R2)               RMCT
         L     R3,24(R3)                WMST
         MVC   HEAD1+22(2),4(R3)        IPS VALUE
         MVC   IPS,4(R3)
         SPACE
         TM    MODE,X'80'                XA?
         BNO   APVT                      NO, 370, GET PVT
         L     R3,X'490'(R2)             RCE
         MVC   P2IN,X'44'(R3)            PAGE IN
         MVC   P2OUT,X'58'(R3)           PAGE OUT
         MVC   P2VIN,X'54'(R3)           VIO IN
         MVC   P2VOUT,X'64'(R3)          VIO OUT
         MVC   P2VREC,X'30'(R3)          VIO RECLAIM
         MVC   P2SIN,X'50'(R3)           SWAP IN
         MVC   P2SOUT,X'60'(R3)          SWAP OUT
         MVC   P2REC,X'34'(R3)           RECLAIM
         SPACE
         L     R2,X'25C'(R2)             RMCT
         L     R2,8(R2)                  ICT
         L     R3,X'3C'(R2)              I/O INTERRUPTS VIA TPI
         A     R3,X'40'(R2)              I/O INTERRUPTS VIA SLIH
         ST    R3,XAICT2                 SAVE # OF INTERRUPTS
         B     ECAT                      SKIP 370-MODE
         SPACE
APVT     EQU   *
         L     R3,X'164'(R2)     A(PVT)
         MVC   PAGEVAL2,X'F8'(R3)
         LR    R3,R2
         SH    R3,=H'4'
         CLC   0(3,R3),=CL3'038'
         BNE   ECAT
         L     R2,X'41C'(R2)   ADDRESS OF CST (CHANNEL SET TABLE)
         LA    R9,6    MAX NO. OF SCT'S
         LA    R14,CATS2
NXTSCT   EQU   *
         TM    20(R2),X'80'
         BNO   CAT0
         L     R3,0(R2)
         LTR   R3,R3
         BNZ   SCAT0
CAT0     XC    0(256,R14),0(R14)
         B     INCRCST
SCAT0    EQU   *
         MVC   0(256,R14),0(R3)
INCRCST  EQU   *
         LA    R2,32(R2)   GET NEXT CST-ENTRY
         LA    R14,256(R14)    GET NEXT CAT-ENTRY
         BCT   R9,NXTSCT
ECAT     EQU   *
         STCK  TOD2
FIRST    NOP   COMP
         MVI   FIRST+1,X'F0'
         B     PUTHEAD1
COMP     EQU   *
         BAL   R9,BTODDIFF
         LA    R3,WAIT2
         BAL   R9,GETWAIT
         L     R1,16
         L     R1,604(R1)    A(RMCT)
         L     R1,4(R1)      A(CCT)
         LH    R1,104(R1)    LONG-TERM CPU-UTILISATION
         SRL   R1,8
         CVD   R1,DBLWD
         UNPK  HEAD1+36(2),DBLWD
         OI    HEAD1+37,X'F0'
         CH    R1,=H'99'
         BNH   WEITER
ASTX     MVC   HEAD1+36(2),=C'99'
WEITER   EQU   *
         L     R1,PAGEVAL2+0    PAGE-IN
         S     R1,PAGEVAL1+0
         L     R2,PAGEVAL2+4    PAGE-OUT
         S     R2,PAGEVAL1+4
         AR    R1,R2
         L     R2,PAGEVAL2+8    VIO-IN
         S     R2,PAGEVAL1+8
         AR    R1,R2
         L     R2,PAGEVAL2+12   VIO-OUT
         S     R2,PAGEVAL1+12
         AR    R1,R2
         L     R2,PAGEVAL2+20   SWAP-IN
         S     R2,PAGEVAL1+20
         AR    R1,R2
         L     R2,PAGEVAL2+24   SWAP-OUT
         S     R2,PAGEVAL1+24
         AR    R1,R2
         LTR   R1,R1
         BNM   *+6
         SR    R1,R1
         M     R0,=F'1024'
         D     R0,TODDIFF
         CVD   R1,DBLWD
         UNPK  HEAD1+45(3),DBLWD
         OI    HEAD1+47,X'F0'
         CH    R1,=H'999'
         BNH   GETIOS
         MVC   HEAD1+45(3),=C'***'
GETIOS   EQU   *
         TM    MODE,X'80'         XA?
         BNO   IOS370             NO
         SPACE
         XR    R4,R4
         XR    R5,R5
         L     R3,XAICT1
         L     R5,XAICT2          GET NO OF INTERRUPTS
         CR    R3,R5
         BH    IOSSTAR
         BE    IOSDIF
         SR    R5,R3
         B     IOSDIF
         SPACE
IOS370   EQU   *
         LA    R1,CATS1
         LA    R2,CATS2
         BAL   R9,IOSUM
IOSDIF   EQU   *
         M     R4,=F'1024'
         D     R4,TODDIFF
         CVD   R5,DBLWD
         UNPK  HEAD1+56(3),DBLWD
         OI    HEAD1+58,X'F0'
         CH    R5,=H'999'
         BNH   PUTHEAD1
IOSSTAR  EQU   *
         MVC   HEAD1+56(3),=C'***'
PUTHEAD1 EQU   *
         SR    R15,R15
         SR    R14,R14
         L     R4,16            LOAD ADDR. OF CVT
         L     R4,X'22C'(R4)  LOAD ADDR. OF ASVT
         L     R8,X'204'(R4)    LOAD MAX. NO. OF ASCBS
         LA    R5,X'210'(R4)    A(FIRST ENTRY)
NXTTSU   EQU   *
         TM    0(R5),X'80'   ASSIGNED?
         BO    NOTASS
         L     R9,0(R5)
         L     R7,X'90'(R9)   A(OUCB)
         TM    18(R7),X'20'
         BO    COUNTTSU
         L     R4,X'B0'(R9)
         CLC   0(4,R4),=CL4'INIT'
         BNE   NOTASS
         L     R4,X'AC'(R9)
         LTR   R4,R4
         BZ    NOTASS
         LA    R14,1(R14)
         B     NOTASS
COUNTTSU LA    R15,1(R15)
NOTASS   EQU   *
         LA    R5,4(R5)
         BCT   R8,NXTTSU
         CVD   R15,DBLWD
         UNPK  HEAD1+67(3),DBLWD
         OI    HEAD1+69,X'F0'
         CVD   R14,DBLWD
         UNPK  HEAD1+29(2),DBLWD
         OI    HEAD1+30,X'F0'
         SR    R14,R14
         SR    R15,R15
         L     R4,16
         L     R4,X'25C'(R4)   A(RMCT)
         L     R4,X'E4'(R4)    A(RCT)
         XR    R15,R15
         TM    MODE,X'80'      XA?
         BNO   UIC370          NO
         ICM   R15,3,X'36'(R4)  AVERAGE UIC XA
         B     UICCVD
UIC370   EQU   *
         ICM   R15,3,X'3E'(R4)    AVERAGE UIC IN SYSTEM
UICCVD   EQU   *
         CVD   R15,DBLWD
         UNPK  HEAD1+75(3),DBLWD
         OI    HEAD1+77,X'F0'
         CH    R15,=H'999'
         BNH   UICOK
         MVC   HEAD1+75(3),=C'***'
UICOK    EQU   *
         L     R4,16
         L     R4,604(R4)           RMCT
         L     R5,88(R4)            WAMT
         LA    R1,2         = TSO PERFORMANCE GROUP
         SLL   R1,2
         L     R6,80(R1,R5)
NOSE1    EQU   *
         AR    R5,R6
         SR    R14,R14
         L     R15,0(R5)
         LTR   R15,R15
         BZ    NO0C9
         L     R15,12(R5)
         D     R14,0(R5)
         SR    R14,R14
         D     R14,=F'1000'
         C     R15,=F'9'
         BH    RTEX
NO0C9    EQU   *
         CVD   R15,DBLWD
         SRDL  R14,32
         D     R14,=F'10'
         CVD   R15,DOUBLEX
         UNPK  HEAD1+13(1),DBLWD
         OI    HEAD1+13,X'F0'
         UNPK  HEAD1+15(2),DOUBLEX
         OI    HEAD1+16,X'F0'
         B     RTOK
RTEX     EQU   *
         MVC   HEAD1+13(4),=C'9.99'
RTOK     EQU   *
         L     R5,=V(DMNCSCT)
         L     R4,16
         L     R4,0(R4)
         L     R4,4(R4)
         L     R4,12(R4)
         CLC   0(4,R4),=CL4'Z134'
         BNE   NODMN
         MVC   DMNTXT,IPSBCMD
         L     R4,16
         L     R4,196(R4)           SMCA
         TIME  DEC
         SRL   R0,24
         ST    R0,TIME
         CH    R0,=H'23'
         BH    SETIPSB
         CH    R0,=H'6'
         BH    NOIPSB
SETIPSB  CLI   IPS,C'B'
         BE    NOIPSB1
         MVC   DMNTXT+8(1),17(R4)    SYSID
         LA    R1,DMNCMD
         SVC   249
         B     NOIPSB1
NOIPSB   EQU   *
         CLC   16(4,R4),IMSAFF
         BNE   NOIPSB1
         L     R0,TIME
         CH    R0,=H'22'
         BH    NOIPSB1
         CLI   IPS,C'A'
         BE    NOIPSB1
         MVC   DMNTXT+7(2),=C'A5'
         LA    R1,DMNCMD
         SVC   249
NOIPSB1  EQU   *
         CLC   16(4,R4),TSOAFF
         BNE   NODMN
         L     R4,16
         L     R4,0(R4)
         L     R4,4(R4)
         L     R4,12(R4)
         CLC   0(4,R4),=CL4'Z134'
         BNE   NODMN
         L     R4,COUNT
         SH    R4,=H'1'
         ST    R4,COUNT
         LTR   R4,R4
         BNZ   NODMN
         LA    R4,10
         ST    R4,COUNT
         L     R0,TIME
         CH    R0,=H'24'  = 18 UHR
         BNL   NODMN
         CH    R0,=H'7'
         BL    NODMN
         L     R5,=V(DMNCSCT)
         CLI   HEAD1+13,C'2'
         BL    SETA
         CLC   IPS,=C'O2'
         BE    NOTIPS
         MVC   DMNTXT,TIPS
         LA    R1,DMNCMD
         SVC   249
         B     NODMN
NOTIPS   EQU   *
         BAL   R4,SDMNO
         B     NODMN
SETA     EQU   *
         BAL   R4,SDMNA
NODMN    EQU   *
         L     R4,16
         L     R4,X'22C'(R4)    A(ASVT)
         LA    R5,X'210'(R4)    1. ENTRY
         LA    R7,TIMEBLK-8
         BAL   R9,TIMELP1
         STCK  TOD1
         NI    FUNCIND,255-DISPSUPP
         SPACE
         TM    MODE,X'80'
         BO    NODMNXA             MODE=XA
         STIMER WAIT,BINTVL=ONESECND
         B     CLOCK
         SPACE
NODMNXA  EQU   *
         SPLEVEL SET=2
         STIMER WAIT,BINTVL=ONESECND
         SPLEVEL SET=1
         SPACE
CLOCK    EQU   *
         STCK  TOD2
         TPUT  BUFF,12,FULLSCR
*        L     R1,16
*        L     R1,0(R1)
*        L     R1,12(R1)      CURRENT ASCB
*        L     R1,108(R1)     ASXB
*        L     R1,4(R1)       FIRST TCB
*        TM    168(R1),X'80'  CHCK TCB USER FIELD
*        BNO   RETURN
         TPUT  HEAD1,78,EDIT,WAIT,NOHOLD
         LA    R5,HEAD3
         TPUT  (R5),78,EDIT,WAIT,NOHOLD
         TPUT  HEAD2,78,EDIT,WAIT,NOHOLD
         LA    R5,HEAD4
         TPUT  (R5),78,EDIT,WAIT,NOHOLD
         MVI   LINE,X'00'
         MVI   LINE+40,X'00'
         LA    R5,X'210'(R4)
         LA    R7,TIMEBLK
         SR    R10,R10
         BAL   R9,TIMELP1
         BAL   R9,BTODDIFF
         LTR   R10,R10
         BNZ   *+8
         LA    R10,1
         ST    R10,TIMESUM
         LA    R5,X'210'(R4)
         L     R7,X'204'(R4)
         MH    R7,=H'4'
         AR    R7,R5
         ST    R7,MAXADR
         LA    R10,TIMEBLK
ASVTLOOP EQU   *
         TM    0(R5),X'80'
         BO    NXTENTY
         L     R6,0(R5)
         BAL   R9,DAASCB
NXTENTY  EQU   *
         LA    R5,4(R5)
         LA    R10,16(R10)
         C     R5,MAXADR
         BL    ASVTLOOP
         CLI   LINE,X'00'
         BE    NOPUTL
         MVI   LINE+40,C' '
         LA    R3,LINE
         TPUT  (R3),78,EDIT,WAIT,NOHOLD
NOPUTL   EQU   *
IMS      B     OVER1
         LA    R3,17
         S     R3,LINECT
         CALL  SDIMSMON,(SDEXIT,(R3)),VL
OVER1    EQU   *
         L     R2,16
         SPACE
         TM    MODE,X'80'                XA?
         BNO   APVT1                     NO, 370, GET PVT
         L     R3,X'490'(R2)             RCE
         MVC   P1IN,X'44'(R3)            PAGE IN
         MVC   P1OUT,X'58'(R3)           PAGE OUT
         MVC   P1VIN,X'54'(R3)           VIO IN
         MVC   P1VOUT,X'64'(R3)          VIO OUT
         MVC   P1VREC,X'30'(R3)          VIO RECLAIM
         MVC   P1SIN,X'50'(R3)           SWAP IN
         MVC   P1SOUT,X'60'(R3)          SWAP OUT
         MVC   P1REC,X'34'(R3)           RECLAIM
         SPACE
         L     R2,X'25C'(R2)             RMCT
         L     R2,8(R2)                  ICT
         L     R3,X'3C'(R2)              I/O INTERRUPTS VIA TPI
         A     R3,X'40'(R2)              I/O INTERRUPTS VIA SLIH
         ST    R3,XAICT1                 SAVE # OF INTERRUPTS
         B     EECAT                     SKIP 370-MODE
         SPACE
APVT1    EQU   *
         L     R3,X'164'(R2)             PVT
         MVC   PAGEVAL1,X'F8'(R3)
         LR    R3,R2
         SH    R3,=H'4'
         CLC   0(3,R3),=CL3'038'
         BNE   EECAT
         L     R2,X'41C'(R2)    ADDRESS OF CST (CHANNEL SET TABLE)
         LA    R9,6
         LA    R14,CATS1
NXTSCT1  EQU   *
         TM    20(R2),X'80'  VALID DATA IN THIS CST?
         BNO   CAT1
         L     R3,0(R2)   ADRESS OF CAT
         LTR   R3,R3
         BNZ   SCAT00
CAT1     XC    0(256,R14),0(R14)
         B     INCRCST1
SCAT00   EQU   *
         MVC   0(256,R14),0(R3)
INCRCST1 EQU   *
         LA    R2,32(R2)
         LA    R14,256(R14)
         BCT   R9,NXTSCT1
EECAT    EQU   *
         LA    R3,WAIT1
         BAL   R9,GETWAIT
         STCK  TOD1
         CLI   AUTO,X'FF'
         BE    AUTO1
         TGET  BUFFER,4
         OC    BUFFER,=CL4' '
         CLC   BUFFER,=CL4'EXIT'
         BNE   TIMELOOP
         XRETURN 0,R
AUTO1    EQU   *
         TM    MODE,X'80'
         BO    AUTO1XA             MODE=XA
         STIMER WAIT,BINTVL=BINTVL
         B     TIMELOOP
         SPACE
AUTO1XA  EQU   *
         SPLEVEL SET=2
         STIMER WAIT,BINTVL=BINTVL
         SPLEVEL SET=1
         B     TIMELOOP
         SPACE
BTODDIFF EQU   *
         LM    R0,R1,TOD1
         LM    R14,R15,TOD2
         SLR   R15,R1
         LA    R1,1
         BC    3,*+6
         SLR   R14,R1
         SLR   R14,R0
         SRDA  R14,22
         ST    R15,TODDIFF
         BR    R9
IOSUM    EQU   *
         SR    R5,R5
         XC    FULLWD(4),FULLWD
         LA    R14,96
NEXTCH   EQU   *
         TM    0(R2),X'70'
         BNZ   INCRCH
         MVC   FULLWD+2(2),2(R2)     CHANNEL SIO COUNT
         L     R4,FULLWD
         TM    0(R1),X'70'
         BNZ   DIFFOK
         MVC   FULLWD+2(2),2(R1)
         L     R3,FULLWD
         CR    R3,R4
         BE    INCRCH
         BNH   SUB
         A     R4,=X'0000FFFF'
SUB      EQU   *
         SR    R4,R3
DIFFOK   EQU   *
         AR    R5,R4
INCRCH   EQU   *
         LA    R1,16(R1)
         LA    R2,16(R2)
         BCT   R14,NEXTCH
         BR    R9
TIMELP1  EQU   *
         LA    R8,ANZTBLK
         C     R8,X'204'(R4)     MAX NO OF ADDR SPACES
         BNH   *+8
         L     R8,X'204'(R4)
TIMELP1A EQU   *
         TM    0(R5),X'80'    ASCB ASSIGNED?
         BO    TIMELP1Z
         L     R6,0(R5)       ASCB
         LM    R14,R15,64(R6)     ELAPSES JOB STEP TIMING
         LM    R0,R1,X'C8'(R6)    ACCUMULATED SRB TIME
         SRDA  R14,22
         SLDA  R0,10
         TM    FUNCIND,DISPSUPP
         BO    TIMELP1S
         L     R1,0(R7)
         CR    R15,R1
         BL    TIMELP1D
         SR    R1,R15
         S     R0,4(R7)
         SR    R0,R1
         AR    R10,R0
         B     TIMELP1R
TIMELP1Z SR    R15,R15
TIMELP1D SR    R0,R0
TIMELP1R EQU   *
TIMELP1S STM   R15,R0,8(R7)
         LA    R7,16(R7)
         LA    R5,4(R5)
         BCT   R8,TIMELP1A
         BR    R9
DAASCB   EQU   *
         LA    R14,LINE
         CLI   LINE,X'00'
         BE    NOINCR
         LA    R14,LINE+40
NOINCR   EQU   *
         LM    R7,R8,X'AC'(R6)
         CLC   0(4,R8),=CL4'INIT'
         BNE   NOINIT
         LTR   R7,R7
         BZR   R9
         LA    R0,8
         SLR   R7,R0
         MVC   0(8,R14),8(R7)
         MVC   9(8,R14),64(R7)
         B     DPRTYEDT
NOINIT   EQU   *
         L     R7,X'38'(R6)
         CLI   0(R8),C'*'
         BER   R9
         CLI   X'1C'(R7),X'02'
         BNER  R9
         MVC   0(8,R14),16(R7)
         MVC   9(8,R14),8(R7)
DPRTYEDT EQU   *
         CLC   0(3,R14),=CL3'JES'
         BE    XX1
         CLC   0(3,R14),=CL3'JPF'
         BE    XX1
         CLC   0(6,R14),=CL6'XCNTRL'
         BE    XX1
         CLC   0(3,R14),=CL3'LLA'
         BE    XX1
         CLC   0(4,R14),=CL4'MEMO'
         BE    XX1
         CLC   0(8,R14),=CL8'Z223RMF'
         BNE   TSTMON
         B     XX1
TSTMON   EQU   *
         CLC   0(8,R14),=CL8'ADMPRINT'
         BE    XX1
         CLC   0(4,R14),=CL4'GDDM'
         BE    XX1
         CLC   0(8,R14),=CL8'SASWTR'
         BE    XX1
         CLC   0(8,R14),=CL8'Z227PHO'
         BE    XX1
         CLC   0(8,R14),=CL8'XH905HCF'
         BE    XX1
         CLC   0(8,R14),=CL8'XH608ITS'
         BE    XX1
         CLC   0(8,R14),=CL8'APWTR'
         BE    XX1
         CLC   0(8,R14),=CL8'Z223WTR'
         BE    XX1
         CLC   0(4,R14),=CL4'UCC7'
         BE    XX1
         CLC   0(3,R14),=CL3'VCI'
         BE    XX1
         CLC   0(6,R14),=CL6'Z240NP'
         BE    XX1
         CLC   0(7,R14),=CL7'Z240COD'
         BE    XX1
         CLC   0(8,R14),=CL8'XROSCOE'
         BE    XX1
         CLC   0(8,R14),=CL8'Z227PRT'
         BE    XX1
         CLC   0(8,R14),=CL8'Z227COM'
         BE    XX1
         CLC   0(8,R14),=CL8'Z325TWR'
         BE    XX1
         CLC   0(4,R14),=CL4'TCAS'
         BE    XX1
         CLC   0(4,R14),=CL4'TCAM'
         BE    XX1
         CLC   0(3,R14),=CL3'NET'
         BE    XX1
         CLC   0(8,R14),=CL8'TOP'
         BE    XX1
         CLC   0(3,R14),=CL3'IMS'
         BE    XX1
         CLC   0(4,R14),=CL4'NCCF'
         BE    XX1
         CLC   0(4,R14),=CL4'NPDA'
         BE    XX1
         CLC   0(3,R14),=CL3'RMF'
         BE    XX1
         CLC   0(4,R14),=CL4'STAM'
         BNE   XX2
         MVI   STAMSW,X'FF'
XX1      EQU   *
         MVI   0(R14),X'00'
         MVI   1(R14),C' '
         MVC   2(29,R14),1(R14)
         BR    R9
XX2      EQU   *
         SR    R0,R0
         L     R7,144(R6)    GET ADDR OF OUCB
         IC    R0,24(R7)   GET PERFORMANCE-GROUP
         L     R1,16
         TM    196(R1),X'80'
         BNO   NOSE2
         IC    R0,181(R7)     PERFORMANCE GROUP
         LTR   R0,R0
         BNZ   NOSE2
         IC    R0,183(R7)
NOSE2    EQU   *
         CVD   R0,DBLWD
         OI    DBLWD+7,X'0F'
         UNPK  18(3,R14),DBLWD
         LH    R0,X'98'(R6)    ALLOCATED PAGE FRAME COUNT
         SLA   R0,2
         CVD   R0,DBLWD
         MVC   MASKAREA,=X'402020202120'
         ED    MASKAREA,DBLWD+5
         MVC   22(4,R14),MASKAREA+2
         MVI   26(R14),C'K'
         TM    X'66'(R6),X'04'
         BZ    *+10
         MVC   22(5,R14),=C' SWAP'
         L     R1,12(R10)
         M     R0,=F'400'
         D     R0,TIMESUM
         LA    R1,2(R1)
         SRA   R1,2
         CVD   R1,DBLWD
         MVC   MASKAREA(4),=X'40202120'
         ED    MASKAREA(4),DBLWD+6
         MVC   28(2,R14),MASKAREA+2
         MVI   30(R14),C'%'
         L     R0,8(R10)
         SRDA  R0,22
         D     R0,=F'1000000'
         SR    R0,R0
         D     R0,=F'60'
         MH    R1,=H'100'
         AR    R1,R0
         CVD   R1,DBLWD
         C     R1,=F'9959'
         BH    NOVAL
         MVC   MASKAREA-1(7),=X'402020207D2120'
         ED    MASKAREA-1(7),DBLWD+5
         MVC   32(5,R14),MASKAREA+1
         B     OUTPUT
NOVAL    EQU   *
         MVC   32(5,R14),=C'**''**'
OUTPUT   EQU   *
         CLI   LINE+40,X'00'
         BER   R9
         MVI   LINE+38,C'×'
         CLC   LINECT,MAXLIN
         BNE   TPUT
         MVI   LINE+38,C'+'
TPUT     EQU   *
         LA    R14,LINE
         TPUT  (R14),78,EDIT,WAIT,NOHOLD
         MVI   LINE,X'40'
         MVC   LINE+1(77),LINE
         MVI   LINE,X'00'
         MVI   LINE+40,X'00'
         L     R14,LINECT
         LA    R14,1(R14)
         C     R14,MAXLIN
         BH    NOPUTL
         ST    R14,LINECT
         BR    R9
GETWAIT  EQU   *
         SETAUTH ON
         MODESET KEY=ZERO,MODE=SUP
         L     R15,16
         L     R15,768(R15)   A(LCCAVT)
         SR    R0,R0
         SR    R1,R1
         L     R15,0(R15)    A(CPU0 LCCA)
         LTR   R15,R15
         BZ    GETCPU2
         AL    R1,620(R15)
         BC    12,*+8
         AL    R0,=F'1'
         AL    R0,616(R15)
GETCPU2  EQU   *
         L     R15,16
         L     R15,768(R15)
         L     R15,8(R15)
         LTR   R15,R15
         BZ    ENDCPU
         AL    R1,620(R15)
         BC    12,*+8
         AL    R0,=F'1'
         AL    R0,616(R15)
ENDCPU   EQU   *
         STM   R0,R1,0(R3)
         MODESET KEY=NZERO,MODE=PROB
         SETAUTH OFF
         BR    R9
DSWPSVC  EQU   *
         SR    R1,R1
         LA    R0,14
         SVC   95
         BR    R14
*  TCBSVC1  EQU   *
*           OI    168(R1),X'80'      CHANGE TCBUSER
*           BR    R14
RETURN   EQU   *
         XRETURN 0,R
SDMNO    EQU   *
         CLI   DMNACT,C'O'
         BR    R4    DONT CHANGE DOMAINS - DELETE STMT IF YOU WILL
         BER   R4
         MVC   DMNTXT,DMNO1
         LA    R1,DMNCMD
         SVC   249
         MVC   DMNTXT,DMNO2
         LA    R1,DMNCMD
         SVC   249
         MVC   DMNTXT,DMNO3
         LA    R1,DMNCMD
         SVC   249
         MVC   DMNTXT,DMNO4
         LA    R1,DMNCMD
         SVC   249
         MVC   DMNTXT,DMNO5
         LA    R1,DMNCMD
         SVC   249
         MVC   DMNTXT,DMNO6
         LA    R1,DMNCMD
         SVC   249
         MVC   DMNTXT,DMNO7
         LA    R1,DMNCMD
         SVC   249
         MVC   DMNTXT,DMNO8
         LA    R1,DMNCMD
         SVC   249
         MVC   DMNTXT,DMNO9
         LA    R1,DMNCMD
         SVC   249
         MVI   DMNACT,C'O'
         BR    R4
SDMNA    EQU   *
         CLI   DMNACT,C'A'
         BR    R4      DONT CHANGE DOMAINS - DELETE STMTS IF YOU WILL
         BER   R4
         MVC   DMNTXT,DMNA1
         LA    R1,DMNCMD
         SVC   249
         MVC   DMNTXT,DMNA2
         LA    R1,DMNCMD
         SVC   249
         MVC   DMNTXT,DMNA3
         LA    R1,DMNCMD
         SVC   249
         MVC   DMNTXT,DMNA4
         LA    R1,DMNCMD
         SVC   249
         MVC   DMNTXT,DMNA5
         LA    R1,DMNCMD
         SVC   249
         MVC   DMNTXT,DMNA6
         LA    R1,DMNCMD
         SVC   249
         MVC   DMNTXT,DMNA7
         LA    R1,DMNCMD
         SVC   249
         MVC   DMNTXT,DMNA8
         LA    R1,DMNCMD
         SVC   249
         MVC   DMNTXT,DMNA9
         LA    R1,DMNCMD
         SVC   249
         MVI   DMNACT,C'A'
         BR    R4
         EJECT
*     KONSTANTEN
*
RESETCMD DS    0H
         DC    H'26,0'
         DC    CL22' E Z134MXX,PERFORM=255 '
HEAD1    DC    CL78'HH:MM:SS- RT=X.XX,IPS=XX,JOB=XX,CPU=XX%,PAGE=XXX/SE*
               C,IO=XXX/SEC,TS=XXX,UIC=XXX'
HEAD2    DC    CL78'JOBNAME  STEPNAME PRF  REAL CPU ACC-T × JOBNAME  STE
               EPNAME PRF  REAL CPU ACC-T'
WAIT1    DC    D'0'
WAIT2    DC    D'0'
WAIT     DC    F'0'
CPUNO    DC    F'0'
DBLWD    DC    D'0'
DOUBLEX  DC    D'0'
MAXLIN   DC    F'19'
TEST     DC    CL4'TEST'
BINTVL   DC    F'2900'
BUFF     DC    X'C1115D7E114040133C404000'
TOD1     DC    D'0'
TOD2     DC    D'0'
         SPACE
PAGEVAL1 DS    0XL32
P1IN     DC    XL4'00'             PAGE IN
P1OUT    DC    XL4'00'             PAGE OUT
P1VIN    DC    XL4'00'             VIO IN
P1VOUT   DC    XL4'00'             VIO OUT
P1VREC   DC    XL4'00'             # OF VIO RECLAIMS
P1SIN    DC    XL4'00'             SWAP IN
P1SOUT   DC    XL4'00'             SWAP OUT
P1REC    DC    XL4'00'             # OF PAGES RECL, EXCL SWAP RECLAIMS
         SPACE
PAGEVAL2 DS    0XL32
P2IN     DC    XL4'00'             PAGE IN
P2OUT    DC    XL4'00'             PAGE OUT
P2VIN    DC    XL4'00'             VIO IN
P2VOUT   DC    XL4'00'             VIO OUT
P2VREC   DC    XL4'00'             # OF VIO RECLAIMS
P2SIN    DC    XL4'00'             SWAP IN
P2SOUT   DC    XL4'00'             SWAP OUT
P2REC    DC    XL4'00'             # OF PAGES RECL, EXCL SWAP RECLAIMS
         SPACE
FULLWD   DC    F'0'
TODDIFF  DC    F'0'
FUNCIND  DC    X'00'
STAMSW   DC    X'00'
RMFSW    DC    X'00'
DISPSUPP EQU   X'01'
AUTO     DC    X'00'
BUFFER   DC    CL4' '
ONESECND DC    F'100'
ANZTBLK  EQU   512
TIMESUM  DS    F
LINECT   DC    F'0'
COUNT    DC    F'1'
DMNCMD   DC    H'40,0'
DMNTXT   DC    CL36' '
DMNACT   DC    C' '
MODE     DC    X'00'          SAVE MODE
MAXADR   DC    F'0'
         DS    X
MASKAREA DS    CL6
SDEXIT   DS    0H
         XSAVE R12,SDEXITSV,IMSMONEX
         LR    R2,R1
SDNXTLN  EQU   *
         L     R3,0(R2)
         TPUT  (R3),78
         TM    0(R2),128
         BO    SDXRET
         LA    R2,4(R2)
         B     SDNXTLN
SDXRET   XRETURN 0
         LTORG
TIMEBLK  DS    0CL16
TIMECPU1 DS    F
TIMESRB1 DS    F
TIMECPU2 DS    F
TIMEDIFF DS    F
         DS    (ANZTBLK-1)CL(L'TIMEBLK)
WORK     DSECT
SVA      DS    18F
TIME     DS    F
IPS      DS    CL2
LINE     DC    CL78' '
HEAD3    DC    78CL1'*'
HEAD4    DC    78CL1'-'
CLEAR    EQU   *
XAICT1   DS    F
XAICT2   DS    F
CATS1    DS    6XL256
CATS2    DS    6XL256
IMSAFF   DS    CL4
TSOAFF   DS    CL4
CLEARLL  EQU   *-CLEAR
WORKL    EQU   *-WORK
DMNDSCT  DSECT
DMNO1    DS    CL36
DMNO2    DS    CL36
DMNO3    DS    CL36
DMNO4    DS    CL36
DMNO5    DS    CL36
DMNO6    DS    CL36
DMNO7    DS    CL36
DMNO8    DS    CL36
DMNO9    DS    CL36
DMNA1    DS    CL36
DMNA2    DS    CL36
DMNA3    DS    CL36
DMNA4    DS    CL36
DMNA5    DS    CL36
DMNA6    DS    CL36
DMNA7    DS    CL36
DMNA8    DS    CL36
DMNA9    DS    CL36
TIPS     DS    CL36
IPSBCMD  DS    CL36
DMNCSCT  CSECT
DMNO1X   DC    CL36' SD 1,MIN=255,MAX=255,DOBJ=1'
DMNO2X   DC    CL36' SD 2,MIN=30,MAX=255,DOBJ=2'
DMNO3X   DC    CL36' SD 3,MIN=10,MAX=35,DOBJ=3'
DMNO4X   DC    CL36' SD 4,MIN=6,MAX=12,DOBJ=6'
DMNO5X   DC    CL36' SD 5,MIN=4,MAX=8,DOBJ=6'
DMNO6X   DC    CL36' SD 6,MIN=2,MAX=6,DOBJ=6'
DMNO7X   DC    CL36' SD 7,MIN=6,MAX=12,DOBJ=5'
DMNO8X   DC    CL36' SD 8,MIN=4,MAX=8,DOBJ=5'
DMNO9X   DC    CL36' SD 9,MIN=2,MAX=4,DOBJ=6'
DMNA1X   DC    CL36' SD 1,MIN=255,MAX=255,DOBJ=1'
DMNA2X   DC    CL36' SD 2,MIN=30,MAX=255,DOBJ=2'
DMNA3X   DC    CL36' SD 3,MIN=10,MAX=35,DOBJ=3'
DMNA4X   DC    CL36' SD 4,MIN=6,MAX=20,DOBJ=4'
DMNA5X   DC    CL36' SD 5,MIN=4,MAX=15,DOBJ=5'
DMNA6X   DC    CL36' SD 6,MIN=2,MAX=10,DOBJ=6'
DMNA7X   DC    CL36' SD 7,MIN=6,MAX=20,DOBJ=4'
DMNA8X   DC    CL36' SD 8,MIN=4,MAX=15,DOBJ=4'
DMNA9X   DC    CL36' SD 9,MIN=2,MAX=10,DOBJ=5'
TIPSCMD  DC    CL36' T IPS=O2'
IPSB     DC    CL36' T IPS=BX'
         END
//LKED.SYSLMOD DD DSN=Z223478.PGMS.LOAD(MONITOR),DISP=SHR
//    EXEC LKED
//LKED.SYSLMOD DD DSN=Z223478.PGMS.LOAD,DISP=SHR
//LKED.SYSIN   DD *
  INCLUDE SYSLMOD(MONITOR)
  INCLUDE LNKLIB(MONITOR)
  ENTRY MONITOR
  NAME MONITOR(R)
//LKED.LNKLIB DD DSN=LU.LNKLIB,DISP=SHR
//*    SDIMSMON OBJECT-CODE AUF SD.HHHH.OBJECT(SD932MN)
//
./ ADD NAME=SDIMSMON
         TITLE 'SD932MN   * MONITOR IMS-ACTIVITIES                   *'
*$LVL$11/02/81-14:30      MSGQ-% = (DCBLBW*100)/DCBRBASN
*$LVL$08/10/80-12:30
*---------------------------------------------------------------------*
* SD932MN      MONITOR IMS-ACTIVITIES (SHORT MONITOR)                 *
*                                                                     *
*                                                                     *
*                                                                     *
*                                                                     *
*                                                                     *
*                                                                     *
*                                                                     *
*                                                                     *
*                                                                     *
*                                                                     *
*---------------------------------------------------------------------*
         SDREGS ,
R14      EQU   14
R15      EQU   15
SD932MN  CSECT ,
         ENTRY SDIMSMON
SDIMSMON DS    0Y
         XSAVE BASE,SVA,SDIMSMON.HUEGLY.
         ST    1,EPPARM
         L     15,0(1)        LOAD EXIT ROUTINE ADDRESS
         ST    15,MONEXI      AND SAVE IT
         L     15,4(1)    LOAD MAXLINES
         LA    R15,0(R15)
         ST    15,ANZLIN
         MVC   LINECT(4),=F'3'
         SPACE 1
         TM    SWA,WASLOAD    CHECK DFSVC000 LOADED ???
         BO    LOADED         YES, SKIP LOAD
         LOAD  EP=DFSVC000    LOAD SECONDARY SCD
         ST    0,MYSCD        AND SAVE EP-ADDRESS
         LR    F,0            LOAD FOR LATER USE
         USING SCD,F          ********USE SCD********
         OI    SWA,WASLOAD    SET LOAD-BIT ON
         SR    15,15          CLEAR REG
         ICM   15,7,EPPARM+1  SDIMSMON-PARM-POINTER
         TM    4(15),X'80'    LAST
         BO    LOADED
         ICM   15,7,8+1(15)   GET  MONITOR-PARM (HHPARM)
         BZ    LOADED
         ICM   15,7,1(15)     R1-CONTENT
         BZ    LOADED
         ICM   15,7,1(15)     PTR TO PARM-STRING
         BZ    LOADED
         LH    14,0(15)       LL  OF PARM-STRING
         LTR   14,14
         BZ    LOADED
         CH    14,=Y(4)       MAX OF PARM-STRING
         BH    LOADED
         MVC   SSCDIMID(4),=X'40404040'
         BCTR  14,0           REDUCE FOR EX
         EX    14,MOVEID
LOADED   EQU   *
         L     F,MYSCD        GET SSCD-ADDRESS
         SPACE 4
         L     15,X'10'       GET CVT-ADDRESS
         L     15,CVTJESCT(15)  GET POINTER TO JESCT
CVTJESCT EQU   X'128'
         LTR   15,15
         BZ    NOTFOUND
         L     15,JESSSCT-JESCT(15)    GET POINTER TO SSCVT
LOOP     DS    0Y
         LTR   15,15
         BZ    NOTFOUND
         CLC   SSCDIMID(4),SSCTSNAM-SSCT(15)     COMPARE 4-BYTES
         BE    FOUND
         CLC   =CL4'IMSA',SSCTSNAM-SSCT(15)      COMPARE 4-BYTES
         BE    FOUND
         CLC   =CL4'IMST',SSCTSNAM-SSCT(15)      COMPARE 4-BYTES
         BE    FOUND
         L     15,SSCTSCTA-SSCT(15)       STEP TO NEXT SSCVT
         B     LOOP
MOVEID   MVC   SSCDIMID(0),2(15)
FOUND    DS    0Y
         CLC   SSCTSSVT-SSCT(4,15),=X'00000000'
         BE    NOTFOUND
         L     15,SSCTSUSE-SSCT(15)
         LTR   15,15
         BZ    NOTFOUND
         L     15,4(15)       NOW WE HAVE THE SSCT-ADDRESS
         MVC   SVCFASID(2),SSCTSNAM-SSCT(15)   CONTAINS  ASID,'DC'
         L     15,SSCTSIZE+SSCDTCTN-SSCDORG(15)
         LTR   15,15
         BZ    NOTFOUND
         ST    15,ORGINSCD
*****
         SPACE 2
         L     1,MONEXI
         CLC   0(4,1),=CL4'TEST'
         BE    XRRC00
         L     15,MONEXI
         CALL  (15),(HEAD4),VL
         STM   0,15,SUPSAV    SAVE ALL REGS
         LA    1,SUPSAV       LOAD REG 1
         LA    15,SUPER       LOAD EP-ADDRESS OF SUPERVISOR RTN
         SVC   250            AND CALL IT
         LM    0,15,SUPSAV    RELO ALL REGS
         B     *+4(15)        RC(15)
         B     RC00           +0  INDICATES NORMAL RETURN
         B     NOTFOUND       +4  NO CHKPT WRITTEN
         SPACE 4
***
RC00     DS    0Y
         TM    SWA,WASACT     SECOND ENTRY
         BZ    NOCALC         NO CALC POSSI
***
         LR    A,F            LOAD SCD-ADDRESS FOR PRINTING
         SLL   A,8            SHIFT LEFT
         IC    A,15           INSERT AN X'0F'
         ST    A,XSCDPCK      STORE AS PACKED
         UNPK  XSCDUNPK(7),XSCDPCK(4)   BUILD FXFXFXFXFXFXF0
         TR    XSCDUNPK(6),TRC-240   TRANSLATE FA->C1
***
         MVC   TXT02(XL02-TXT02CON),TXT02CON   MOVE TXT02 MASK
***
         MVC   TXT02+TXT02SCD-TXT02CON(6),XSCDUNPK  MOVE SCD-ADDRESS
***
         L     14,SECRQCT     GET RQE. COUNT
         S     14,PRMRQCT     OLD VALUE
         BNP   COMPRS         NO ACTION
         SR    0,0            FOR DIVIDE
         L     1,SECINPL      FOUND IN POOL
         S     1,PRMINPL      OLD VALUE
         BNP   COMPRS         SHOULD BE POS.
         M     0,=F'100'      FOR %
         DR    0,14           BUILD %
         CVD   1,DW           CONVERT
         MVC   TXT02+TXT02RR-TXT02CON(4),MASK3  MOVE ED MASK
         ED    TXT02+TXT02RR-TXT02CON(4),DW+6
***
COMPRS   EQU   *
         LM    0,1,PRMTIME    OLD TIMESTAMP
         SRDL  0,12
         LM    14,15,SECTIME  NEW TIMESTAMP
         SRDL  14,12
         SLR   15,1
         LA    1,1
         BC    3,*+6
         SLR   14,1
         SLR   14,0
         D     14,=F'10000'    IN SEC*(10E-2)
         STM   14,15,TIMEDIFF
*
         L     14,TIMEDIFF+4  GET DIFF IN  SEC*(10E-2)
         LTR   14,14
         BNP   COMPQCT        BYPASS
         SR    0,0            FOR DIVIDE
         L     1,SECRDCT      GET READ COUNT
         S     1,PRMRDCT      OLD READ COUNT
         BNP   NORS
         M     0,=F'100'
**
         DR    0,14           BUILD READ/SEC
         CVD   1,DW           CONVERT
         MVC   TXT02+TXT02RS-TXT02CON(4),MASK3
         ED    TXT02+TXT02RS-TXT02CON(4),DW+6
**
NORS     EQU   *
         SR    0,0            FOR DIVIDE
         L     1,SECBKWT      WRITES
         S     1,PRMBKWT      OLD VALUE
         BNP   NOWS
         M     0,=F'100'
         DR    0,14           BUILD WRITES/SEC
         CVD   1,DW
         MVC   TXT02+TXT02WS-TXT02CON(4),MASK3
         ED    TXT02+TXT02WS-TXT02CON(4),DW+6
**
NOWS     EQU   *
         SR    0,0            FOR DIVIDE
         L     1,SECDEQCT     DEQ-COUNT
         S     1,PRMDEQCT     OLD
         M     0,=F'10000'
         DR    0,14           BUILD DEQ/SEC
         CVD   1,DW
         MVC   TXT02+TXT02TCS-TXT02CON(7),MASK1
         ED    TXT02+TXT02TCS-TXT02CON(7),DW+5
**
         SR    0,0            FOR DIVIDE
         L     1,SECDEQCN     LINE-DEQ-COUNT
         S     1,PRMDEQCN     OLD
         M     0,=F'10000'
         DR    0,14           BUILD DEQ/SEC
         CVD   1,DW
         MVC   TXT02+TXT02LCS-TXT02CON(7),MASK1
         ED    TXT02+TXT02LCS-TXT02CON(7),DW+5
**
         SR    0,0            FOR DIVIDE
         L     1,SECLAT       LATCHES
         S     1,PRMLAT       OLD
         M     0,=F'10000'
         DR    0,14           BUILD LATCHES/SEC
         CVD   1,DW
         MVC   TXT02+TXT02LAS-TXT02CON(7),MASK1
         ED    TXT02+TXT02LAS-TXT02CON(7),DW+5
**
COMPQCT  L     1,SECQCT       GET ACTUAL QCT
         CVD   1,DW
         MVC   TXT02+TXT02QCT-TXT02CON(6),MASK2
         ED    TXT02+TXT02QCT-TXT02CON(6),DW+5
         MVC   TXT05+13*6(5),TXT02+1+TXT02QCT-TXT02CON
         MVC   TXT05(13*6),TXT05+6
***
         L     1,SECQCN       GET ACTUAL LINE-QCT
         CVD   1,DW
         MVC   TXT02+TXT02LCT-TXT02CON(6),MASK2
         ED    TXT02+TXT02LCT-TXT02CON(6),DW+5
***
         L     1,SMPROZ
         CVD   1,DW
         MVC   TXT02+TXT02SHP-TXT02CON(4),MASK3  MOVE MASK
         ED    TXT02+TXT02SHP-TXT02CON(4),DW+6   AND EDIT
         L     1,LMPROZ
         CVD   1,DW
         MVC   TXT02+TXT02LGP-TXT02CON(4),MASK3  MOVE MASK
         ED    TXT02+TXT02LGP-TXT02CON(4),DW+6   AND EDIT
         MVC   TXT06MON(4),=C'    '
         MVC   TXT02+TXT02MON-TXT02CON(4),=C'    '
         CLI   MONFLG,0
         BE    NOMON
         UNPK  DW(5),MONFLG(3)
         TR    DW(4),TRC-240
         MVC   TXT06MON(4),=C'MNTR'
         MVC   TXT02+TXT02MON-TXT02CON(4),DW
NOMON    DS    0Y
         SR    0,0            FOR DIVIDE
         L     1,SECITASK     ITASK-COUNT
         S     1,PRMITASK     OLD
         M     0,=F'10000'
         DR    0,14           BUILD ITASK/SEC
         CVD   1,DW
         MVC   TXT02+TXT02TSK-TXT02CON(7),MASK1
         ED    TXT02+TXT02TSK-TXT02CON(7),DW+5
         SPACE ,
         SR    0,0            FOR DIVIDE
         L     1,SECIDSPT     DISPATCHING-COUNT
         S     1,PRMIDSPT     OLD
         M     0,=F'10000'
         DR    0,14           BUILD DISP/SEC
         CVD   1,DW
         MVC   TXT02+TXT02DSP-TXT02CON(7),MASK1
         ED    TXT02+TXT02DSP-TXT02CON(7),DW+5
         SPACE ,
         L     15,MONEXI
         CALL  (15),(TXT06,TXT02),VL
         EJECT ,
***BUILD SUBPOOL STATS
         SR    D,D            INDEX VALUE
         LH    E,MAXPOOL      NUMBER OF SUBPOOLS
         SPACE 2
         LA    A,TXT03
         LA    G,2            2 ENTRIES PER LINE
         SPACE 2
NXTTXT03 DS    0Y
         MVC   TXT03+XL03DAT(3),=C' × '  MOVE SEPARATOR
         MVC   0(XL03-TXT03CON,A),TXT03CON  MOVE DUMMY MASK
         LH    1,SECNBUFS(D)  NUMBER OF BUFFERS
         CVD   1,DW
         MVC   TXT03NBU-XL03VAR(4,A),MASK3
         ED    TXT03NBU-XL03VAR(4,A),DW+6
**
         LH    1,SECBSIZE(D)  SIZE OF EACH BUFFER
         SRL   1,10           DIVIDE BY 1024
         CVD   1,DW
         MVC   TXT03BSI-XL03VAR(4,A),MASK3
         ED    TXT03BSI-XL03VAR(4,A),DW+6
**
         L     1,SECSRCH(D)   SEARCH BUFFER INDICATOR
         SR    0,0
         L     14,SECINP(D)   FOUND IN POOL
         LTR   14,14
         BNP   STATREAD
         M     0,=F'10'
         DR    0,14
         CVD   1,DW
         MVC   TXT03BFL-XL03VAR(5,A),MASK4
         ED    TXT03BFL-XL03VAR(5,A),DW+6
**
STATREAD EQU   *
         SR    0,0
         L     1,SECREADS(D)  READ I/O
         L     14,SECRDCT     TOTAL READ FOR ALL SUBPOOLS
         LTR   14,14
         BNP   STATWRIT
         M     0,=F'1000'
         DR    0,14
         CVD   1,DW
         MVC   TXT03RPR-XL03VAR(5,A),MASK4
         ED    TXT03RPR-XL03VAR(5,A),DW+6
**
STATWRIT EQU   *
         SR    0,0
         L     1,SECWRIT(D)
         L     14,SECBKWT     TOTAL BLOCKS WRITTEN
         LTR   14,14          PREVENT 0C7
         BNP   ENDTXT03
         M     0,=F'1000'
         DR    0,14
         CVD   1,DW
         MVC   TXT03WPR-XL03VAR(5,A),MASK4
         ED    TXT03WPR-XL03VAR(5,A),DW+6
**
ENDTXT03 EQU   *
         LA    A,XL03DAT+3(A) STEP TO NEXT ELEMENT IN SAME PRINT-LINE
         BCT   G,NOPUT        2 ELEMENTS IN LINE ?
         LA    A,TXT03        SET POINTER TO START
         LA    G,2            SET COUNT
         CLC   ANZLIN(4),LINECT
         BE    SAVENEW
         L     15,MONEXI
         CALL  (15),(TXT03),VL
         MVI   TXT03,X'40'    CLEAR LINE
         MVC   TXT03+1(78-1),TXT03
         L     R14,LINECT
         LA    R14,1(R14)
         ST    R14,LINECT
NOPUT    EQU   *
NOINCR   EQU   *
         LA    D,SECSPLSV(D)  POINTS TO NEXT ENTRY
         BCT   E,NXTTXT03
         CH    G,=Y(2)
         BE    NPRNT
         CLC   ANZLIN(4),LINECT
         BE    SAVENEW
         L     15,MONEXI
         CALL  (15),(TXT03),VL
         L     R14,LINECT
         LA    R14,1(R14)
         ST    R14,LINECT
NPRNT    DS    0Y
         CLC   ANZLIN(4),LINECT
         BE    SAVENEW
         L     15,MONEXI
         CALL  (15),(TXT05),VL
         B     SAVENEW
         SPACE 4
NOCALC   EQU   *
         L     15,MONEXI
         CALL  (15),(TXT04),VL
SAVENEW  EQU   *
         MVC   PRM(DATLN),SEC
         OI    SWA,WASACT
XRRC00   DS    0Y
         SR    15,15
XRETURN  DS    0Y
         XRETURN (15)
*
NOTFOUND DS    0Y
         NI    SWA,X'FF'-WASACT  RESET ACTIVE INDICATOR
         LA    15,4
         B     XRETURN
         SPACE 4
SUPER    DS    0H
         LM    0,15,0(1)
         L     F,ORGINSCD     LOAD ORIGIN SCD-ADDRESS
         LA    15,4
         CLC   SCDCPNO(2),=X'0000'        ANY CHKPT WRITTEN ?
         BE    SUPEREX
         CLC   SSCDIMSR(2),=X'0115'
         BNE   SUPEREX
         SPACE 2
         STCK  SECTIME
         SPACE 2
         L     A,SCDDBFPL     LOAD ADDRESS OF ISAM/OSAM BUFFER POOL
         USING IBPOOL,A       ********USE IBPOOL********
         L     B,BFPLRQCT     LOAD REQ. COUNT
         ST    B,SECRQCT      SAVE IT
**
         L     B,BFPLINPL     FOUND IN POOL
         ST    B,SECINPL
**
         L     B,BFPLRDCT     READ REQ.
         ST    B,SECRDCT
**
         L     B,BFPLBKWT     WRITE REQ.
         ST    B,SECBKWT
         SPACE 3
*****PROCESS SUBPOOLS
         L     B,IBPSPL1      ADDRESS OF FIRST SUBPOOL
         L     C,IBPNSP       NUMBER OF SUBPOOLS
         CH    C,=H'6'        CHECK MAX 6 SUBPOOLS
         BNH   *+8
         LA    C,6
         STH   C,MAXPOOL
         SPACE 1
         SR    D,D
         USING ISUBPL,B      ********USE ISUBPL********
SPLOOP   EQU   *
         L     E,ISPFINP     FOUND IN POOL
         ST    E,SECINP(D)    SAVE IT
**
         LH    E,ISPNBUFS     NUMER OF BUFFERS
         STH   E,SECNBUFS(D)
**
         LH    E,ISPBSIZE     SIZE OF EACH BUFFER
         STH   E,SECBSIZE(D)
**
         L     E,ISPSRCH      BUFFER COMPARES
         ST    E,SECSRCH(D)
**
         L     E,ISPREADS     READ I/O
         ST    E,SECREADS(D)
**
         L     E,ISPWRITS     WRITES
         A     E,ISPWRPRG     ADD PURGE
         ST    E,SECWRIT(D)
**
         LA    D,SECSPLSV(D)  STEP TO NEXT ENTRY IN TABLE
         TM    ISPNXSF,ISPNXEND  CHECK LAST BUFFER ?
         BO    CHKTP
         L     B,ISPNXSP      POINTS TO NEXT SUBPOOL
         BCT   C,SPLOOP         PROCESS NEXT SUBPOOL
         SPACE 4
CHKTP    EQU   *
         L     B,SCDSLXAD     LATCH STATISTIK
         LH    C,SCDSLXNO     NUMBER OF ENTRIES
         SR    D,D            CLEAR ACCU
STATLOOP A     D,L'SLXLHDR+SLXCONT-SLXLSTAT(B)         ADD
         AH    B,SCDSLXLL     NEXT
         BCT   C,STATLOOP     AND LOOP
         ST    D,SECLAT       SAVE CONTENTION LATCHES
         L     B,SCDSMBEP     LOAD EP OF SMB LIST
         USING SMB,B          ********USE SMB********
         LH    C,SCDSMBN      NUMBER OF SMB'S
         SR    D,D            CLEAR DEQ
         SR    E,E            CLEAR ENQ
QCTLOOP  AH    D,SMBDEQCT     ADD DEQ CNT
         AH    E,SMBENQCT     ADD ENQ CNT
         AH    B,SCDSMBL      ADD LENGTH OF EACH SMB
         BCT   C,QCTLOOP
         ST    D,SECDEQCT     SAVE DEQ CNT
         ST    E,SECENQCT     SAVE ENQ CNT
         SR    E,D            ACTUAL QCT
         ST    E,SECQCT
         DROP  B
*
         TM    SWA,WASGM      GETMAIN PERFORMED ??
         BO    ONLMOVE
*
         LH    0,SCDCNTN      GET NUMBER OF CNT'S
         MH    0,SCDCNTL      LENGTH OF CNT-TABLE
         ST    0,LOCLNG       LENGTH OF GETMAIN-AREA
         GETMAIN R,LV=(0)     GET STORAGE FOR SVC
         ST    1,LOCCNT       TO-ADDRESS FOR SVC
         OI    SWA,WASGM      SET BIT
ONLMOVE  DS    0Y
         L     A,SCDCNT
         L     B,LOCLNG
         L     C,LOCCNT
*
SVCLOOP  DS    0Y
         ST    A,SVCFADDR
         ST    C,SVCTADDR
         MVC   SVCLNGTH(4),=A(4096)
         C     B,=A(4096)
         BH    *+8
         ST    B,SVCLNGTH
         LA    1,SVCPARM
         SVC   237
         LTR   15,15
         LA    15,4
         BNZ   SUPEREX
         A     A,=A(4096)
         A     C,=A(4096)
         S     B,=A(4096)
         BP    SVCLOOP
*
         L     B,LOCCNT       LOAD EP OF CNT LIST
         USING CNT,B          ********USE CNT********
         LH    C,SCDCNTN      NUMBER OF CNT'S
         SR    D,D            CLEAR DEQ
         SR    E,E            CLEAR ENQ
CNTLOOP  AH    D,CNTDEQCT     ADD DEQ CNT
         AH    E,CNTENQCT     ADD ENQ CNT
         AH    B,SCDCNTL      ADD LENGTH OF EACH CNT
         BCT   C,CNTLOOP
         ST    D,SECDEQCN     SAVE DEQ CNT
         ST    E,SECENQCN     SAVE ENQ CNT
         SR    E,D            ACTUAL QCT
         ST    E,SECQCN
         DROP  B
SVCERR   DS    0Y
*
         XC    SMPROZ(4),SMPROZ
         L     A,SCDSMDCB     GET DCB OF SHORT
         SR    0,0
         L     1,DCBLBW-IHADCB(A)  LOAD HI BLOCK USED
         LA    1,0(1)
         M     0,=F'100'
         L     14,DCBRBASN-IHADCB(A)   DIVIDE BY LAST BLOCK WRITTEN
         LA    14,0(14)
         LTR   14,14
         BNP   SKSMDIV
         DR    0,14
         ST    1,SMPROZ
SKSMDIV  EQU   *
*
         XC    LMPROZ(4),LMPROZ
         L     A,SCDLMDCB     GET DCB OF LONG
         SR    0,0
         L     1,DCBLBW-IHADCB(A)  LOAD HI BLOCK USED
         LA    1,0(1)
         M     0,=F'100'
         L     14,DCBRBASN-IHADCB(A)   DIVIDE BY LAST BLOCK WRITTEN
         LA    14,0(14)
         LTR   14,14
         BNP   SKLMDIV
         DR    0,14
         ST    1,LMPROZ
SKLMDIV  EQU   *
         MVC   TXT06ID(4),SSCDIMID
         MVC   MONFLG(2),SCDSTMN1
         MVC   SECITASK(4),SCDITCNT
         MVC   SECIDSPT(4),SCDDPCNT
         SR    15,15        INDICATES NORMAL RETURN
SUPEREX  DS    0Y
         STM   0,15,SUPSAV
         SVC   3
         SPACE 3
         LTORG *
         EJECT ,
         DS    0D
SVA      DC    18A(0)
TIMEDIFF DC    D'0'
*---------------------------------------------------------------------*
SVCPARM  DS    0A
SVCFASID DC    Y(0)
SVCTASID DC    Y(0)
SVCFADDR DC    A(0)
SVCTADDR DC    A(0)
SVCLNGTH DC    A(0)
*---------------------------------------------------------------------*
LOCLNG   DC    A(0)
LOCCNT   DC    A(0)
EPPARM   DC    A(0)
ANZLIN   DC    F'0'
LINECT   DC    F'3'
HEAD4    DC    78CL1'-'
SMPROZ   DC    A(0)
LMPROZ   DC    A(0)
*
DW       DC    D'0'
MONEXI   DC    A(0)
MONFLG   DC    X'000000'
SWA      DC    X'0'
WASLOAD  EQU   B'00000001'
WASACT   EQU   B'00000010'
WASOFFLI EQU   B'00000100'
WASGM    EQU   B'00001000'
MASK1    DC    X'402021204B2020'
MASK2    DC    X'402020202120'
MASK3    DC    X'40202120'
MASK4    DC    X'4021204B20'
MYSCD    DC    A(0)
         SPACE 2
SUPSAV   DC    16A(0)
ORGINSCD DC    A(0)
MAXPOOL  DC    Y(0)
XSCDPCK  DC    A(0)
XSCDUNPK DC    CL8' '
TRC      DC    C'0123456789ABCDEF'
         SPACE 4
SEC      DS    0D
SECTIME  DC    D'0'
SECRQCT  DC    A(0)
SECINPL  DC    A(0)
SECRDCT  DC    A(0)
SECBKWT  DC    A(0)
SECLAT   DC    A(0)
SECDEQCT DC    A(0)
SECENQCT DC    A(0)
SECQCT   DC    A(0)
SECDEQCN DC    A(0)
SECENQCN DC    A(0)
SECQCN   DC    A(0)
SECITASK DC    A(0)
SECIDSPT DC    A(0)
***
SECSPOOL EQU   *
SECNBUFS DC    Y(0)
SECBSIZE DC    Y(0)
SECINP   DC    A(0)
SECSRCH  DC    A(0)
SECREADS DC    A(0)
SECWRIT  DC    A(0)
SECSPLSV EQU   *-SECSPOOL
         DC    5XL(SECSPLSV)'00'
****
PRM      DS    0D
PRMTIME  DC    D'0'
PRMRQCT  DC    A(0)
PRMINPL  DC    A(0)
PRMRDCT  DC    A(0)
PRMBKWT  DC    A(0)
PRMLAT   DC    A(0)
PRMDEQCT DC    A(0)
PRMENQCT DC    A(0)
PRMQCT   DC    A(0)
PRMDEQCN DC    A(0)
PRMENQCN DC    A(0)
PRMQCN   DC    A(0)
PRMITASK DC    A(0)
PRMIDSPT DC    A(0)
***
PRMSPOOL EQU   *
PRMNBUFS DC    Y(0)
PRMBSIZE DC    Y(0)
PRMINP   DC    A(0)
PRMSRCH  DC    A(0)
PRMREADS DC    A(0)
PRMWRIT  DC    A(0)
PRMSPLSV EQU   *-PRMSPOOL
         DC    5XL(PRMSPLSV)'00'
DATLN    EQU   *-PRM
*---------------------------------------------------------------------*
TXT02CON DS    0C
TXT02SCD DC    C'XXXXXX'
TXT02RR  DC    CL4' ***'
TXT02RS  DC    CL4' ***'
TXT02WS  DC    CL4' ***'
TXT02TCS DC    CL7' ***.**'
TXT02LAS DC    CL7' ***.**'
TXT02QCT DC    CL6' *****'
TXT02SHP DC    CL4' ***'
TXT02LGP DC    CL4' ***'
TXT02LCT DC    CL6' *****'
TXT02LCS DC    CL7' ***.**'
         DC    C' '
TXT02MON DC    CL4'    '
TXT02TSK DC    CL7' ***.**'
TXT02DSP DC    CL7' ***.**'
XL02     EQU   *
*---------------------------------------------------------------------*
TXT02    DS    CL(XL02-TXT02CON)
         ORG   TXT02
         DC    CL78' '
         ORG   ,
*---------------------------------------------------------------------*
TXT03CON DS    0C
XL03VAR  DC    C'SP'
TXT03NBU DC    C'****'
         DC    C'X'
TXT03BSI DC    C'****'
         DC    C' B/L'
TXT03BFL DC    C' **.*'
         DC    C' R%'
TXT03RPR DC    C' **.*'
         DC    C' W%'
TXT03WPR DC    C' **.*'
         DC    C' '
XL03DAT  EQU   *-XL03VAR
XL03     EQU   *
*---------------------------------------------------------------------*
TXT03    DC    CL78' '
*---------------------------------------------------------------------*
TXT04    DC    CL78' '
         ORG   TXT04
         DC    C'  SD932--SDIMSMON  NO  CALC.  POSSI.  WAITING  FOR  NEX
               XT  INTERRUPT.....'
XL04     EQU   *
         ORG   ,
*---------------------------------------------------------------------*
TXT05    DC    14CL6' '
*---------------------------------------------------------------------*
TXT06    DC    CL78' '
         ORG   *-78
         DC    C'('
TXT06ID  DC    C'XXXX'
         DC    C')'
         DC    C' F/R'
         DC    C' R/S'
         DC    C' W/S'
         DC    C'  TRC/S'
         DC    C'  LCO/S'
         DC    C'  TQCT'
         DC    C' SHM'
         DC    C' LGM'
         DC    C'  LQCT'
         DC    C'  XMT/S'
         DC    C' '
TXT06MON DC    C'    '
         DC    C' ITSK/S'
         DC    C' IDSP/S'
         ORG   ,
*---------------------------------------------------------------------*
         PRINT NOGEN
         ISCD  SCDBASE=0
*---------------------------------------------------------------------*
         IBPOOL ,
*---------------------------------------------------------------------*
         ISUBPL ,
*---------------------------------------------------------------------*
         IAPS  SMBBASE=0
*---------------------------------------------------------------------*
         ICLI  CNTBASE=0
*---------------------------------------------------------------------*
         IDCBOSD
*---------------------------------------------------------------------*
         DFSSLX ,
*---------------------------------------------------------------------*
         DFSSSOB  (IEFJESCT,IEFJSCVT)
*---------------------------------------------------------------------*
         END   ,
./ ADD NAME=SDIMSFUL
         TITLE 'SD932XS     * MONITOR IMS-ACTIVITIES                 *'
*$LVL$02/03/81-12:00      MODIFICATION FOR IMS116
*$LVL$11/02/81-14:30      MSGQ-% = (DCBLBW*100)/DCBRBASN
*$LVL$08/10/80-12:30
*---------------------------------------------------------------------*
* SD932XS      MONITOR IMS-ACTIVITIES                                 *
*                                                                     *
*                                                                     *
*                                                                     *
*                                                                     *
*                                                                     *
*                                                                     *
*                                                                     *
*                                                                     *
*                                                                     *
*---------------------------------------------------------------------*
         SDREGS ,
         SPACE 5
SD932XS  CSECT ,
         ENTRY SDIMSMON
SDIMSMON DS    0Y
         XSAVE (BASE,J),SVA,SDIMSMON.HUEGLY.
         USING SVA,S
*
         ST    1,EPPARM
         L     15,0(1)        LOAD EXIT ROUTINE ADDRESS
         ST    15,MONEXI      AND SAVE IT
         CLC   0(4,15),=C'FREE'    FREE AND STOP RUN
         BNE   NORMAL
         TM    SWA,WASLOAD
         BZ    FRNLD
         DELETE EP=DFSVC000
FRNLD    DS    0Y
         TM    SWA,WASGM
         BZ    FRNFR
         LA    15,SVCFREE
         SVC   250
FRNFR    DS    0Y
         MVI   SWA,0
         B     XRRC00
         SPACE ,
SVCFREE  DS    0Y
         L     0,LOCLNG
         L     1,LOCCNT
         FREEMAIN R,LV=(0),A=(1)
         SVC   3
         SPACE ,
NORMAL   DS    0Y
         L     15,4(1)    LOAD MAXLINES
         LA    15,0(15)
         ST    15,ANZLIN
         MVC   LINECT(4),=F'3'
         SPACE 1
         TM    SWA,WASLOAD    CHECK DFSVC000 LOADED ???
         BO    LOADED         YES, SKIP LOAD
         LOAD  EP=DFSVC000    LOAD SECONDARY SCD
         ST    0,MYSCD        AND SAVE EP-ADDRESS
         LR    F,0            LOAD FOR LATER USE
         USING SCD,F          ********USE SCD********
         OI    SWA,WASLOAD    SET LOAD-BIT ON
         SR    15,15          CLEAR REG
         ICM   15,7,EPPARM+1  SDIMSMON-PARM-POINTER
         TM    4(15),X'80'    LAST
         BO    LOADED
         ICM   15,7,8+1(15)   GET  MONITOR-PARM (HHPARM)
         BZ    LOADED
         ICM   15,7,1(15)     R1-CONTENT
         BZ    LOADED
         ICM   15,7,1(15)     PTR TO PARM-STRING
         BZ    LOADED
         LH    14,0(15)       LL  OF PARM-STRING
         LTR   14,14
         BZ    LOADED
         CH    14,=Y(4)       MAX OF PARM-STRING
         BH    LOADED
         MVC   SSCDIMID(4),=X'40404040'
         BCTR  14,0           REDUCE FOR EX
         EX    14,MOVEID
LOADED   EQU   *
         L     F,MYSCD        GET SSCD-ADDRESS
         SPACE 4
         L     15,X'10'       GET CVT-ADDRESS
         L     15,CVTJESCT(15)  GET POINTER TO JESCT
CVTJESCT EQU   X'128'
         LTR   15,15
         BZ    NOTFOUND
         L     15,JESSSCT-JESCT(15)    GET POINTER TO SSCVT
LOOP     DS    0Y
         LTR   15,15
         BZ    NOTFOUND
         CLC   SSCDIMID(4),SSCTSNAM-SSCT(15)     4-BYTE IMS-ID
         BE    FOUND
         CLC   =CL4'IMSA',SSCTSNAM-SSCT(15)      4-BYTE IMS-ID
         BE    FOUND
         CLC   =CL4'IMST',SSCTSNAM-SSCT(15)      4-BYTE IMS-ID
         BE    FOUND
         L     15,SSCTSCTA-SSCT(15)       STEP TO NEXT SSCVT
         B     LOOP
MOVEID   MVC   SSCDIMID(0),2(15)
FOUND    DS    0Y
         CLC   SSCTSSVT-SSCT(4,15),=X'00000000'
         BE    NOTFOUND
         L     15,SSCTSUSE-SSCT(15)
         LTR   15,15
         BZ    NOTFOUND
         L     15,4(15)       NOW WE HAVE THE SSCT-ADDRESS
         MVC   SVCFASID(2),SSCTSNAM-SSCT(15)   CONTAINS  ASID,'DC'
         L     15,SSCTSIZE+SSCDTCTN-SSCDORG(15)
         LTR   15,15
         BZ    NOTFOUND
*---------------------------------------------------------------------*
         ST    15,ORGINSCD
*****
         SPACE 2
         L     1,MONEXI
         CLC   0(4,1),=CL4'TEST'
         BE    XRRC00
         STM   0,15,SUPSAV    SAVE ALL REGS
         LA    1,SUPSAV       LOAD REG 1
         LA    15,SUPER       LOAD EP-ADDRESS OF SUPERVISOR RTN
         SVC   250            AND CALL IT
         LM    0,15,SUPSAV    RELO ALL REGS
         B     *+4(15)        RC(15)
         B     RC00           +0  INDICATES NORMAL RETURN
         B     RC04           +4  NO CHKPT WRITTEN
         SPACE 4
***
RC00     DS    0Y
         TM    SWA,WASACT     SECOND ENTRY
         BZ    NOCALC         NO CALC POSSI
***
         LR    A,F            LOAD SCD-ADDRESS FOR PRINTING
         SLL   A,8            SHIFT LEFT
         IC    A,15           INSERT AN X'0F'
         ST    A,XSCDPCK      STORE AS PACKED
         UNPK  XSCDUNPK(7),XSCDPCK(4)   BUILD FXFXFXFXFXFXF0
         TR    XSCDUNPK(6),TRC-240   TRANSLATE FA->C1
         TIME  DEC
         STM   0,1,TEMP
         UNPK  DW(5),TEMP+4+1(3)
         MVC   TXT01YY(2),DW
         MVC   TXT01DD(3),DW+2
         UNPK  DW(7),TEMP(4)
         MVC   TXT01HH(2),DW
         MVC   TXT01MM(2),DW+2
         MVC   TXT01SS(2),DW+4
         MVC   TXT01SCD(6),XSCDUNPK  MOVE SCD-ADDRESS
***
         LM    0,1,PRMTIME    OLD TIMESTAMP
         SRDL  0,12
         LM    14,15,SECTIME  NEW TIMESTAMP
         SRDL  14,12
         SLR   15,1
         LA    1,1
         BC    3,*+6
         SLR   14,1
         SLR   14,0
         D     14,=F'10000'    IN SEC*(10E-2)
         STM   14,15,TIMEDIFF
*                                  IBPCALLS + BFPLNWBK
*        I/O POOL REQ.       =     -------------------      ( /SEC )
*                                          TIME
         SR    0,0
         L     1,SECIBPC     GET RQE. COUNT
         A     1,SECNWBK
         S     1,PRMIBPC
         S     1,PRMNWBK
         M     0,=F'10000'
         MVC   TXT11REQ(7),DMMY1
         NC    TIMEDIFF+4(4),TIMEDIFF+4
         BZ    SKP001
         D     0,TIMEDIFF+4
         CVD   1,DW
         MVC   TXT11REQ(7),MASK1
         ED    TXT11REQ(7),DW+5
SKP001   DS    0Y
*                                         BFPLINPL
*        IN POOL             = 100 * -------------------      ( % )
*                                    IBPCALLS + BFPLNWBK
         SR    0,0
         L     1,SECINPL      FOR DIVIDE
         M     0,=F'10000'
         L     14,SECIBPC
         A     14,SECNWBK
         MVC   TXT11INP(7),DMMY1
         LTR   14,14
         BZ    SKP002
         DR    0,14
         CVD   1,DW
         MVC   TXT11INP(7),MASK1
         ED    TXT11INP(7),DW+5
SKP002   DS    0Y
*                               BFPLRDCT + BFPLOSWT + BFPLCHWT +
*                                     BFPLGTBF + BFPLTCLP
*        I/O-RATE            =  -------------------------------- (/SEC)
*                                            TIME
         SR    0,0
         L     1,SECRDCT
         A     1,SECOSWT
         A     1,SECCHWT
         A     1,SECGTBF
         A     1,SECTLCP
         LR    14,1
         S     1,PRMRDCT
         S     1,PRMOSWT
         S     1,PRMCHWT
         S     1,PRMGTBF
         S     1,PRMTLCP
         M     0,=F'100'
         MVC   TXT11IOS(7),DMMY1
         NC    TIMEDIFF+4(4),TIMEDIFF+4
         BZ    SKP003
         D     0,TIMEDIFF+4
         CVD   1,DW
         MVC   TXT11IOS(7),MASK1
         ED    TXT11IOS(7),DW+5
SKP003   DS    0Y
*        LCYL                =  BFPLTLCP
         L     1,SECTLCP
         CVD   1,DW
         MVC   TXT11CYL(4),MASK3
         ED    TXT11CYL(4),DW+6
*                                     BFPLRDCT
*        READS               =  100 * --------        ( % )
*                                     IOCOUNT
         SR    0,0
         L     1,SECRDCT
         M     0,=F'10000'
         MVC   TXT12RD(7),DMMY1
         LTR   14,14
         BZ    SKP004
         DR    0,14
         CVD   1,DW
         MVC   TXT12RD(7),MASK1
         ED    TXT12RD(7),DW+5
SKP004   DS    0Y
*                                     BFPLOSWT
*        F-WRITES            =  100 * --------        ( % )
*                                     IOCOUNT
*
         SR    0,0
         L     1,SECOSWT
         M     0,=F'10000'
         MVC   TXT12FW(7),DMMY1
         LTR   14,14
         BZ    SKP005
         DR    0,14
         CVD   1,DW
         MVC   TXT12FW(7),MASK1
         ED    TXT12FW(7),DW+5
SKP005   DS    0Y
*
*                                     BFPLCHWT
*        C-WRITES            =  100 * --------        ( % )
*                                     IOCOUNT
         SR    0,0
         L     1,SECCHWT
         M     0,=F'10000'
         MVC   TXT12CW(7),DMMY1
         LTR   14,14
         BZ    SKP006
         DR    0,14
         CVD   1,DW
         MVC   TXT12CW(7),MASK1
         ED    TXT12CW(7),DW+5
SKP006   DS    0Y
*
*                                     BFPLGTBF
*        ISAM                =  100 * --------        ( % )
*                                     IOCOUNT
         SR    0,0
         L     1,SECGTBF
         M     0,=F'10000'
         MVC   TXT12IS(7),DMMY1
         LTR   14,14
         BZ    SKP007
         DR    0,14
         CVD   1,DW
         MVC   TXT12IS(7),MASK1
         ED    TXT12IS(7),DW+5
SKP007   DS    0Y
*        TC-QCT               = SUM(SMBENQCT) - SUM(SMBDEQCT)
         L     1,SECQCT       GET ACTUAL QCT
         CVD   1,DW
         MVC   TXT02QCT(6),MASK2
         ED    TXT02QCT(6),DW+5
         MVC   TXT10+4+13*6(5),TXT02QCT+1
         MVC   TXT10+4(13*6),TXT10+4+6
*        LINE-QCT            = SUM(CNTENQCT) - SUM(CNTDEQCT)
         L     1,SECQCN       GET ACTUAL LINE-QCT
         CVD   1,DW
         MVC   TXT02LCT(6),MASK2
         ED    TXT02LCT(6),DW+5
*        TC-RATE             =  (SECDEQCT - PRMDEQCT) / TIME   ( /SEC)
         SR    0,0            FOR DIVIDE
         L     1,SECDEQCT     DEQ-COUNT
         S     1,PRMDEQCT     OLD
         M     0,=F'10000'
         MVC   TXT02TCS(7),DMMY1
         NC    TIMEDIFF+4(4),TIMEDIFF+4
         BZ    SKP008
         D     0,TIMEDIFF+4   BUILD DEQ/SEC
         CVD   1,DW
         MVC   TXT02TCS(7),MASK1
         ED    TXT02TCS(7),DW+5
SKP008   DS    0Y
**
*        XMT-RATE            =  (SECDEQCN - PRMDEQCN) / TIME   ( /SEC)
         SR    0,0            FOR DIVIDE
         L     1,SECDEQCN     LINE-DEQ-COUNT
         S     1,PRMDEQCN     OLD
         M     0,=F'10000'
         MVC   TXT02LCS(7),DMMY1
         NC    TIMEDIFF+4(4),TIMEDIFF+4
         BZ    SKP009
         D     0,TIMEDIFF+4   BUILD DEQ/SEC
         CVD   1,DW
         MVC   TXT02LCS(7),MASK1
         ED    TXT02LCS(7),DW+5
SKP009   DS    0Y
* LATCHES
*        LOG                 =  ( SECLOG - PRMLOG ) / TIME   (/SEC)
         SR    0,0
         L     1,SECLOG
         S     1,PRMLOG
         M     0,=F'10000'
         MVC   TXT04LOG(7),DMMY1
         NC    TIMEDIFF+4(4),TIMEDIFF+4
         BZ    SKP010
         D     0,TIMEDIFF+4
         CVD   1,DW
         MVC   TXT04LOG(7),MASK1
         ED    TXT04LOG(7),DW+5
SKP010   DS    0Y
*
*        STO                 =  ( SECSTO - PRMSTO ) / TIME   (/SEC)
         SR    0,0
         L     1,SECSTO
         S     1,PRMSTO
         M     0,=F'10000'
         MVC   TXT05STO(7),DMMY1
         NC    TIMEDIFF+4(4),TIMEDIFF+4
         BZ    SKP011
         D     0,TIMEDIFF+4
         CVD   1,DW
         MVC   TXT05STO(7),MASK1
         ED    TXT05STO(7),DW+5
SKP011   DS    0Y
*
*        EXC                 =  ( SECEXC - PRMEXC ) / TIME   (/SEC)
         SR    0,0
         L     1,SECEXC
         S     1,PRMEXC
         M     0,=F'10000'
         MVC   TXT06EXC(7),DMMY1
         NC    TIMEDIFF+4(4),TIMEDIFF+4
         BZ    SKP012
         D     0,TIMEDIFF+4
         CVD   1,DW
         MVC   TXT06EXC(7),MASK1
         ED    TXT06EXC(7),DW+5
SKP012   DS    0Y
*
*        DYN                 =  ( SECDYN - PRMDYN ) / TIME   (/SEC)
         SR    0,0
         L     1,SECDYN
         S     1,PRMDYN
         M     0,=F'10000'
         MVC   TXT07DYN(7),DMMY1
         NC    TIMEDIFF+4(4),TIMEDIFF+4
         BZ    SKP013
         D     0,TIMEDIFF+4
         CVD   1,DW
         MVC   TXT07DYN(7),MASK1
         ED    TXT07DYN(7),DW+5
SKP013   DS    0Y
*
*        MON                 =  ( SECMON - PRMMON ) / TIME   (/SEC)
         SR    0,0
         L     1,SECMON
         S     1,PRMMON
         M     0,=F'10000'
         MVC   TXT08MON(7),DMMY1
         NC    TIMEDIFF+4(4),TIMEDIFF+4
         BZ    SKP014
         D     0,TIMEDIFF+4
         CVD   1,DW
         MVC   TXT08MON(7),MASK1
         ED    TXT08MON(7),DW+5
SKP014   DS    0Y
*
*        GEN                 =  ( SECGEN - PRMGEN ) / TIME   (/SEC)
         SR    0,0
         L     1,SECGEN
         S     1,PRMGEN
         M     0,=F'10000'
         MVC   TXT09GEN(7),DMMY1
         NC    TIMEDIFF+4(4),TIMEDIFF+4
         BZ    SKP015
         D     0,TIMEDIFF+4
         CVD   1,DW
         MVC   TXT09GEN(7),MASK1
         ED    TXT09GEN(7),DW+5
SKP015   DS    0Y
* DISPATCHES
*        ITASKS
         SR    0,0            FOR DIVIDE
         L     1,SECITASK     ITASK-COUNT
         S     1,PRMITASK     OLD
         M     0,=F'10000'
         MVC   TXT04TSK(7),DMMY1
         NC    TIMEDIFF+4(4),TIMEDIFF+4
         BZ    SKP016
         D     0,TIMEDIFF+4   BUILD ITASK/SEC
         CVD   1,DW
         MVC   TXT04TSK(7),MASK1
         ED    TXT04TSK(7),DW+5
SKP016   DS    0Y
*        DISPATCHES
         SR    0,0
         L     1,SECIDSPT     DISPATCHING-COUNT
         S     1,PRMIDSPT     OLD
         M     0,=F'10000'
         MVC   TXT05DSP(7),DMMY1
         NC    TIMEDIFF+4(4),TIMEDIFF+4
         BZ    SKP017
         D     0,TIMEDIFF+4   BUILD DISP/SEC
         CVD   1,DW
         MVC   TXT05DSP(7),MASK1
         ED    TXT05DSP(7),DW+5
SKP017   DS    0Y
*        IPOSTS
         SR    0,0
         L     1,SECIPOST
         S     1,PRMIPOST
         M     0,=F'10000'
         MVC   TXT06POS(7),DMMY1
         NC    TIMEDIFF+4(4),TIMEDIFF+4
         BZ    SKP018
         D     0,TIMEDIFF+4
         CVD   1,DW
         MVC   TXT06POS(7),MASK1
         ED    TXT06POS(7),DW+5
SKP018   DS    0Y
*        ISWITCHES
         SR    0,0            FOR DIVIDE
         L     1,SECISWIT     DISPATCHING-COUNT
         S     1,PRMISWIT     OLD
         M     0,=F'10000'
         MVC   TXT07SWT(7),DMMY1
         NC    TIMEDIFF+4(4),TIMEDIFF+4
         BZ    SKP019
         D     0,TIMEDIFF+4   BUILD DISP/SEC
         CVD   1,DW
         MVC   TXT07SWT(7),MASK1
         ED    TXT07SWT(7),DW+5
SKP019   DS    0Y
*        NO FREE SAPS
         SR    0,0
         L     1,SECNSAP
         CVD   1,DW
         MVC   TXT08NSA(6),MASK2
         ED    TXT08NSA(6),DW+5
SKP020   DS    0Y
*        NO FREE SRB
         SR    0,0            FOR DIVIDE
         L     1,SECNSRB      DISPATCHING-COUNT
         CVD   1,DW
         MVC   TXT09NSR(6),MASK2
         ED    TXT09NSR(6),DW+5
SKP021   DS    0Y
* SCHEDULING
*        ATTEMPTS
         SR    0,0
         L     1,SECNSCHD
         S     1,PRMNSCHD
         M     0,=F'10000'
         MVC   TXT04ATT(7),DMMY1
         NC    TIMEDIFF+4(4),TIMEDIFF+4
         BZ    SKP022
         D     0,TIMEDIFF+4
         CVD   1,DW
         MVC   TXT04ATT(7),MASK1
         ED    TXT04ATT(7),DW+5
SKP022   DS    0Y
*        CONFLICTS           = SCDNSPGM + SCDNSCUT + SCDNSDB + SCDNMISC
         SR    0,0
         L     1,SECNSPGM
         A     1,SECNSCUT
         A     1,SECNSDB
         A     1,SECNMISC
         LR    14,1
         M     0,=F'10000'
         MVC   TXT05CON(7),DMMY1
         L     15,SECNSCHD
         LTR   15,15
         BZ    SKP023
         DR    0,15
         CVD   1,DW
         MVC   TXT05CON(7),MASK1
         ED    TXT05CON(7),DW+5
SKP023   DS    0Y
*        PROGRAM CONFLICT
         SR    0,0
         L     1,SECNSPGM
         M     0,=F'10000'
         MVC   TXT06PGM(7),DMMY1
         LTR   14,14
         BZ    SKP024
         DR    0,14
         CVD   1,DW
         MVC   TXT06PGM(7),MASK1
         ED    TXT06PGM(7),DW+5
SKP024   DS    0Y
*        PRIORITY CUTOFF
         SR    0,0
         L     1,SECNSCUT
         M     0,=F'10000'
         MVC   TXT07CUT(7),DMMY1
         LTR   14,14
         BZ    SKP025
         DR    0,14
         CVD   1,DW
         MVC   TXT07CUT(7),MASK1
         ED    TXT07CUT(7),DW+5
SKP025   DS    0Y
*        DB INTENT
         SR    0,0
         L     1,SECNSDB
         M     0,=F'10000'
         MVC   TXT08NDB(7),DMMY1
         LTR   14,14
         BZ    SKP026
         DR    0,14
         CVD   1,DW
         MVC   TXT08NDB(7),MASK1
         ED    TXT08NDB(7),DW+5
SKP026   DS    0Y
*        OTHER
         SR    0,0
         L     1,SECNMISC
         M     0,=F'10000'
         MVC   TXT09MIS(7),DMMY1
         LTR   14,14
         BZ    SKP027
         DR    0,14
         CVD   1,DW
         MVC   TXT09MIS(7),MASK1
         ED    TXT09MIS(7),DW+5
SKP027   DS    0Y
* PROGRAM ISOLATION
*        CURRENT STORAGE USED
         L     1,SECUSED
         CVD   1,DW
         MVC   TXT04STO(8),MASK5
         ED    TXT04STO(8),DW+4
*        REQUESTS
         SR    0,0
         L     1,SECQCBF
         S     1,PRMQCBF
         M     0,=F'10000'
         MVC   TXT05REQ(7),DMMY1
         NC    TIMEDIFF+4(4),TIMEDIFF+4
         BZ    SKP028
         D     0,TIMEDIFF+4
         CVD   1,DW
         MVC   TXT05REQ(7),MASK1
         ED    TXT05REQ(7),DW+5
SKP028   DS    0Y
*        AVG LENGTH OF SEARCH
         SR    0,0
         L     1,SECQCBT
         M     0,=F'100'
         MVC   TXT06SRC(7),DMMY1
         NC    SECQCBF(4),SECQCBF
         BZ    SKP029
         D     0,SECQCBF
         CVD   1,DW
         MVC   TXT06SRC(7),MASK1
         ED    TXT06SRC(7),DW+5
SKP029   DS    0Y
* DYNAMIC LOG
*        ENTRY RATE
         SR    0,0
         L     1,SECENTRS
         S     1,PRMENTRS
         M     0,=F'10000'
         MVC   TXT04ENT(7),DMMY1
         NC    TIMEDIFF+4(4),TIMEDIFF+4
         BZ    SKP030
         D     0,TIMEDIFF+4
         CVD   1,DW
         MVC   TXT04ENT(7),MASK1
         ED    TXT04ENT(7),DW+5
SKP030   DS    0Y
*        WAITS
         SR    0,0
         L     1,SECWAITS
         S     1,PRMWAITS
         M     0,=F'10000'
         MVC   TXT05WAI(7),DMMY1
         NC    TIMEDIFF+4(4),TIMEDIFF+4
         BZ    SKP031
         D     0,TIMEDIFF+4
         CVD   1,DW
         MVC   TXT05WAI(7),MASK1
         ED    TXT05WAI(7),DW+5
SKP031   DS    0Y
*        I/O RATE
         SR    0,0
         L     1,SECWRTES
         S     1,PRMWRTES
         M     0,=F'10000'
         MVC   TXT06IOS(7),DMMY1
         NC    TIMEDIFF+4(4),TIMEDIFF+4
         BZ    SKP032
         D     0,TIMEDIFF+4
         CVD   1,DW
         MVC   TXT06IOS(7),MASK1
         ED    TXT06IOS(7),DW+5
SKP032   DS    0Y
* MESSAGE-QUEUE
         L     1,SMPROZ
         CVD   1,DW
         MVC   TXT08SHP(7),MASK1  MOVE MASK
         ED    TXT08SHP(7),DW+5   AND EDIT
*
         L     1,LMPROZ
         CVD   1,DW
         MVC   TXT08LGP(7),MASK1  MOVE MASK
         ED    TXT08LGP(7),DW+5   AND EDIT
*
         MVC   TXT09MON(4),=C'    '
         CLI   MONFLG,0
         BE    NOMON
         UNPK  DW(5),MONFLG(3)
         TR    DW(4),TRC-240
         MVC   TXT09MON(4),DW
NOMON    DS    0Y
         SPACE ,
***BUILD SUBPOOL STATS
         SR    D,D            INDEX VALUE
         LH    E,MAXPOOL      NUMBER OF SUBPOOLS
         LA    G,8+4          OFFSET IN TEXT
NXTSPLIO DS    0Y
**
         LH    1,SECBSIZE(D)  SIZE OF EACH BUFFER
         SRL   1,10
         CVD   1,DX
         LH    1,SECNBUFS(D)  NUMBER OF BUFFERS
         CVD   1,DW
         LA    A,TXT14(G)
         MVC   0(7,A),MASK4
         ED    0(4,A),DW+6
         ED    4(2,A),DX+7
*
**
         SR    0,0
         L     1,SECSRCH(D)   SEARCH BUFFER INDICATOR
         L     14,SECINP(D)   FOUND IN POOL
         M     0,=F'100'
         LA    A,TXT16(G)
         MVC   0(7,A),DMMY1
         LTR   14,14
         BNP   SKP033
         DR    0,14
         CVD   1,DW
         MVC   0(7,A),MASK1
         ED    0(7,A),DW+5
SKP033   DS    0Y
*                               ISPWSTW + ISPWSTR + ISPWOWN
*        AVG WAITS           =  ---------------------------
*                                  ISPREADS + ISPWRITS
         SR    0,0
         L     1,SECWSTW(D)
         A     1,SECWSTR(D)
         A     1,SECWOWN(D)
         M     0,=F'100'
         L     14,SECREADS(D)
         A     14,SECWRITS(D)
         LA    A,TXT17(G)
         MVC   0(7,A),DMMY1
         LTR   14,14
         BZ    SKP034
         DR    0,14
         CVD   1,DW
         MVC   0(7,A),MASK1
         ED    0(7,A),DW+5
SKP034   DS    0Y
*        STOLEN              = ISPWSPL + SUM(ISPSTLV#.)   (0-8)
         SR    0,0
         L     1,SECWSPL(D)
         A     1,SECTLV0(D)
         A     1,SECTLV1(D)
         A     1,SECTLV2(D)
         A     1,SECTLV3(D)
         A     1,SECTLV4(D)
         A     1,SECTLV5(D)
         A     1,SECTLV6(D)
         A     1,SECTLV7(D)
         A     1,SECTLV8(D)
         ST    1,SECSTOL(D)
         S     1,PRMWSPL(D)
         S     1,PRMTLV0(D)
         S     1,PRMTLV1(D)
         S     1,PRMTLV2(D)
         S     1,PRMTLV3(D)
         S     1,PRMTLV4(D)
         S     1,PRMTLV5(D)
         S     1,PRMTLV6(D)
         S     1,PRMTLV7(D)
         S     1,PRMTLV8(D)
*
         M     0,=F'10000'
         LA    A,TXT18(G)
         MVC   0(7,A),DMMY1
         NC    TIMEDIFF+4(4),TIMEDIFF+4
         BZ    SKP035
         D     0,TIMEDIFF+4
         CVD   1,DW
         MVC   0(7,A),MASK1
         ED    0(7,A),DW+5
SKP035   DS    0Y
*                                        ISPSTLV0 + ISPSTLV2
*                                      + ISPSTLV2 + ISPSTLV3
*        STEALS WITHOUT WRITES = 100 * ---------------------
*                                           STOLEN
         SR    0,0
         L     1,SECTLV0(D)
         A     1,SECTLV1(D)
         A     1,SECTLV2(D)
         A     1,SECTLV3(D)
         M     0,=F'10000'
         LA    A,TXT19(G)
         MVC   0(7,A),DMMY1
         L     14,SECSTOL(D)
         LTR   14,14
         BZ    SKP036
         DR    0,14
         CVD   1,DW
         MVC   0(7,A),MASK1
         ED    0(7,A),DW+5
SKP036   DS    0Y
*                                         ISPSTLV4
*        STOLE OWN ALTERED BUFFER = 100 * --------
*                                          STOLEN
         SR    0,0
         L     1,SECTLV4(D)
         M     0,=F'10000'
         LA    A,TXT20(G)
         MVC   0(7,A),DMMY1
         L     14,SECSTOL(D)
         LTR   14,14
         BZ    SKP037
         DR    0,14
         CVD   1,DW
         MVC   0(7,A),MASK1
         ED    0(7,A),DW+5
SKP037   DS    0Y
*
*                                           ISPSTLV5
*        STOLE OTHER ALTERED BUFFER = 100 * --------
*                                            STOLEN
         SR    0,0
         L     1,SECTLV5(D)
         M     0,=F'10000'
         LA    A,TXT21(G)
         MVC   0(7,A),DMMY1
         L     14,SECSTOL(D)
         LTR   14,14
         BZ    SKP038
         DR    0,14
         CVD   1,DW
         MVC   0(7,A),MASK1
         ED    0(7,A),DW+5
SKP038   DS    0Y
*
*                                       ISPSTLV6 + ISPSTLV7 + ISPSTLV8
*        STEAL WITH FULL SEARCH = 100 * ------------------------------
*                                                   STOLEN
         SR    0,0
         L     1,SECTLV6(D)
         A     1,SECTLV7(D)
         A     1,SECTLV8(D)
         M     0,=F'10000'
         LA    A,TXT22(G)
         MVC   0(7,A),DMMY1
         L     14,SECSTOL(D)
         LTR   14,14
         BZ    SKP039
         DR    0,14
         CVD   1,DW
         MVC   0(7,A),MASK1
         ED    0(7,A),DW+5
SKP039   DS    0Y
*                                        ISPWSPL
*        STEAL WITH WAIT FOR BFR = 100 * -------
*                                        STOLEN
         SR    0,0
         L     1,SECWSPL(D)
         M     0,=F'10000'
         LA    A,TXT23(G)
         MVC   0(7,A),DMMY1
         L     14,SECSTOL(D)
         LTR   14,14
         BZ    SKP040
         DR    0,14
         CVD   1,DW
         MVC   0(7,A),MASK1
         ED    0(7,A),DW+5
SKP040   DS    0Y
*
*
         LA    G,7(G)
         LA    D,SECSPLSV(D)
         BCT   E,NXTSPLIO
* VSAM SUBPOOLS
         SR    D,D
         LA    G,44+4         OFFSET IN TEXT
         LH    E,MAXVSAM
NXTVSAM  DS    0Y
         L     1,SECBSIZ(D)
         SRL   1,10
         CVD   1,DX
         L     1,SECBFNO(D)
         CVD   1,DW
         LA    A,TXT14(G)
         MVC   0(7,A),MASK4
         ED    0(4,A),DW+6
         ED    4(2,A),DX+7
*
*        BUFFER HANDLER REQUESTS  =  (BFUSRRBA + BFUSRKEY) / TIME
         SR    0,0
         L     1,SECRRBA(D)
         A     1,SECRKEY(D)
         LR    14,1
         S     1,PRMRRBA(D)
         S     1,PRMRKEY(D)
         M     0,=F'10000'
         LA    A,TXT16(G)
         MVC   0(7,A),DMMY1
         NC    TIMEDIFF+4(4),TIMEDIFF+4
         BZ    SKP041
         D     0,TIMEDIFF+4
         CVD   1,DW
         MVC   0(7,A),MASK1
         ED    0(7,A),DW+5
SKP041   DS    0Y
*                                         BFUSRKEY
*        RETRIEVE BY KEY     = 100 * -------------------
*                                    BFUSRRBA + BFUSRKEY
         SR    0,0
         L     1,SECRKEY(D)
         M     0,=F'10000'
         LA    A,TXT17(G)
         MVC   0(7,A),DMMY1
         LTR   14,14
         BZ    SKP042
         DR    0,14
         CVD   1,DW
         MVC   0(7,A),MASK1
         ED    0(7,A),DW+5
SKP042   DS    0Y
*        RATE OF UPDATE    = ( BFUSISES + BFUSISKS + BFUSALT ) / TIME
         SR    0,0
         L     1,SECISES(D)
         A     1,SECISKS(D)
         A     1,SECBALT(D)
         LR    14,1
         S     1,PRMISES(D)
         S     1,PRMISKS(D)
         S     1,PRMBALT(D)
         M     0,=F'10000'
         LA    A,TXT18(G)
         MVC   0(7,A),DMMY1
         NC    TIMEDIFF+4(4),TIMEDIFF+4
         BZ    SKP043
         D     0,TIMEDIFF+4
         CVD   1,DW
         MVC   0(7,A),MASK1
         ED    0(7,A),DW+5
SKP043   DS    0Y
*                                          BFUSBALT
*        UPDATE INPLACE = 100 * -----------------------------
*                               BFUSISES + BFUSISKS + BFUSALT
         SR    0,0
         L     1,SECBALT(D)
         M     0,=F'10000'
         LA    A,TXT19(G)
         MVC   0(7,A),DMMY1
         LTR   14,14
         BZ    SKP044
         DR    0,14
         CVD   1,DW
         MVC   0(7,A),MASK1
         ED    0(7,A),DW+5
SKP044   DS    0Y
*
*                          BFUSRDS + BFUSUIW + BFUSNUIW
*        I/O RATE       =  ----------------------------
*                                      TIME
         SR    0,0
         L     1,SECRDS(D)
         A     1,SECUIW(D)
         A     1,SECNUIW(D)
         LR    14,1
         S     1,PRMRDS(D)
         S     1,PRMUIW(D)
         S     1,PRMNUIW(D)
         M     0,=F'10000'
         LA    A,TXT20(G)
         MVC   0(7,A),DMMY1
         NC    TIMEDIFF+4(4),TIMEDIFF+4
         BZ    SKP045
         D     0,TIMEDIFF+4
         CVD   1,DW
         MVC   0(7,A),MASK1
         ED    0(7,A),DW+5
SKP045   DS    0Y
*                                              BFUSRDS
*        READS               = 100 * ----------------------------
*                                    BFUSRDS + BFUSUIW + BFUSNUIW
         SR    0,0
         L     1,SECRDS(D)
         M     0,=F'10000'
         LA    A,TXT21(G)
         MVC   0(7,A),DMMY1
         LTR   14,14
         BZ    SKP046
         DR    0,14
         CVD   1,DW
         MVC   0(7,A),MASK1
         ED    0(7,A),DW+5
SKP046   DS    0Y
*
*                                              BFUSUIW
*        IMS WRITES          = 100 * ----------------------------
*                                    BFUSRDS + BFUSUIW + BFUSNUIW
         SR    0,0
         L     1,SECUIW(D)
         M     0,=F'10000'
         LA    A,TXT22(G)
         MVC   0(7,A),DMMY1
         LTR   14,14
         BZ    SKP047
         DR    0,14
         CVD   1,DW
         MVC   0(7,A),MASK1
         ED    0(7,A),DW+5
SKP047   DS    0Y
*
*                                              BFUSNUIW
*        VSAM FORCES WRITES  = 100 * ----------------------------
*                                    BFUSRDS + BFUSUIW + BFUSNUIW
         SR    0,0
         L     1,SECNUIW(D)
         M     0,=F'10000'
         LA    A,TXT23(G)
         MVC   0(7,A),DMMY1
         LTR   14,14
         BZ    SKP048
         DR    0,14
         CVD   1,DW
         MVC   0(7,A),MASK1
         ED    0(7,A),DW+5
SKP048   DS    0Y
*
         LA    D,SECVSAML(D)
         LA    G,7(G)
         BCT   E,NXTVSAM
*
         L     15,MONEXI
         CALL  (15),(TXT01,TXT02,TXT03,TXT04,TXT05,TXT06,TXT07,TXT08,  X
               TXT09,TXT10,TXT11,TXT12,TXT13,TXT14,TXT16,TXT17,        X
               TXT18,TXT19,TXT20,TXT21,TXT22,TXT23),VL
         B     SAVENEW
         SPACE ,
NOCALC   EQU   *
         L     15,MONEXI
         MVI   TXT24+4,X'40'
         MVC   TXT24+5(80-1),TXT24+4
         MVC   TXT24+4(TXT2401L),TXT2401
         CALL  (15),(TXT24),VL
SAVENEW  EQU   *
*
         LA    0,PRM
         LA    1,DATLN
         LA    14,SEC
         LR    15,1
         MVCL  0,14
*
         OI    SWA,WASACT
XRRC00   DS    0Y
         SR    15,15
XRETURN  DS    0Y
         XRETURN (15)
*
RC04     DS    0Y
         MVI   TXT24+4,X'40'
         MVC   TXT24+5(80-1),TXT24+4
         MVC   TXT24+4(TXT2402L),TXT2402
         L     15,MONEXI
         CALL  (15),(TXT24),VL
NOTFOUND DS    0Y
         NI    SWA,X'FF'-WASACT  RESET ACTIVE INDICATOR
         LA    15,4
         B     XRETURN
         SPACE 4
SUPER    DS    0H
         LM    0,15,0(1)
         L     F,ORGINSCD     LOAD ORIGIN SCD-ADDRESS
         LA    15,4
         CLC   SCDCPNO(2),=X'0000'        ANY CHKPT WRITTEN ?
         BE    SUPEREX
         CLC   SSCDIMSR(2),=X'0116'
         BNE   SUPEREX
         SPACE 2
         STCK  SECTIME
         SPACE 2
         L     A,SCDDBFPL     LOAD ADDRESS OF ISAM/OSAM BUFFER POOL
         USING IBPOOL,A       ********USE IBPOOL********
         MVC   SECIBPC(4),IBPCALLS
         MVC   SECNWBK(4),BFPLNWBK
         MVC   SECINPL(4),BFPLINPL
         MVC   SECRDCT(4),BFPLRDCT
         MVC   SECOSWT(4),BFPLOSWT
         MVC   SECCHWT(4),BFPLCHWT
         MVC   SECGTBF(4),BFPLGTBF
         MVC   SECTLCP(4),BFPLTLCP
*
*****PROCESS SUBPOOLS
         L     B,IBPSPL1      ADDRESS OF FIRST SUBPOOL
         L     C,IBPNSP       NUMBER OF SUBPOOLS
         CH    C,=H'4'        CHECK MAX 4 SUBPOOLS
         BNH   *+8
         LA    C,4
         STH   C,MAXPOOL
         SPACE 1
         SR    D,D
         USING ISUBPL,B      ********USE ISUBPL********
SPLOOP   EQU   *
**
         LH    E,ISPBSIZE     SIZE OF EACH BUFFER
         STH   E,SECBSIZE(D)
**
         LH    E,ISPNBUFS     NUMER OF BUFFERS
         STH   E,SECNBUFS(D)
**
         L     E,ISPSRCH      BUFFER COMPARES
         ST    E,SECSRCH(D)
*
         L     E,ISPFINP     FOUND IN POOL
         ST    E,SECINP(D)    SAVE IT
**
         L     E,ISPWSTW
         ST    E,SECWSTW(D)
*
         L     E,ISPWSTR
         ST    E,SECWSTR(D)
*
         L     E,ISPWOWN
         ST    E,SECWOWN(D)
*
         L     E,ISPREADS
         ST    E,SECREADS(D)
*
         L     E,ISPWRITS
         ST    E,SECWRITS(D)
*
         L     E,ISPWSPL
         ST    E,SECWSPL(D)
*
         L     E,ISPSTLV0
         ST    E,SECTLV0(D)
         L     E,ISPSTLV1
         ST    E,SECTLV1(D)
         L     E,ISPSTLV2
         ST    E,SECTLV2(D)
         L     E,ISPSTLV3
         ST    E,SECTLV3(D)
         L     E,ISPSTLV4
         ST    E,SECTLV4(D)
         L     E,ISPSTLV5
         ST    E,SECTLV5(D)
         L     E,ISPSTLV6
         ST    E,SECTLV6(D)
         L     E,ISPSTLV7
         ST    E,SECTLV7(D)
         L     E,ISPSTLV8
         ST    E,SECTLV8(D)
**
         LA    D,SECSPLSV(D)  STEP TO NEXT ENTRY IN TABLE
         TM    ISPNXSF,ISPNXEND  CHECK LAST BUFFER ?
         BO    CHKTP
         L     B,ISPNXSP      POINTS TO NEXT SUBPOOL
         BCT   C,SPLOOP         PROCESS NEXT SUBPOOL
         SPACE 4
CHKTP    DS    0Y
         L     A,SCDDBFSP     POINTER TO VSAM BUFFER HANDLER POOL
         L     A,BFSPBFUS-BFSP(A)  STEP TO FIRST SUBPOOL
         SR    D,D
         LA    C,5            MAX 5 VSAM-SUBPOOLS
VSAMLOOP DS    0Y
         LA    A,0(A)
         LTR   A,A
         BZ    ENDVSAM
         LH    E,BFUSBSIZ-BFUS(A)
         ST    E,SECBSIZ(D)
         SR    E,E
         IC    E,BFUSBFNO-BFUS(A)
         ST    E,SECBFNO(D)
         L     E,BFUSRRBA-BFUS(A)
         ST    E,SECRRBA(D)
         L     E,BFUSRKEY-BFUS(A)
         ST    E,SECRKEY(D)
         L     E,BFUSFND-BFUS(A)
         ST    E,SECFND(D)
         L     E,BFUSISES-BFUS(A)
         ST    E,SECISES(D)
         L     E,BFUSISKS-BFUS(A)
         ST    E,SECISKS(D)
         L     E,BFUSBALT-BFUS(A)
         ST    E,SECBALT(D)
         L     E,BFUSRDS-BFUS(A)
         ST    E,SECRDS(D)
         L     E,BFUSUIW-BFUS(A)
         ST    E,SECUIW(D)
         L     E,BFUSNUIW-BFUS(A)
         ST    E,SECNUIW(D)
         L     A,BFUSNBFU-BFUS(A)   NEXT BUFFER
         LA    D,SECVSAML(D)
         BCT   C,VSAMLOOP
*
ENDVSAM  DS    0Y
         SH    C,=Y(5)
         LCR   C,C
         STH   C,MAXVSAM
*
         L     B,SCDSLXAD     LATCH STATISTIK
OLOG     EQU   2
         MVC   SECLOG(4),L'SLXLHDR+SLXCONT-SLXLSTAT+OLOG*SLXLEN(B)
OSTO     EQU   3
         MVC   SECSTO(4),L'SLXLHDR+SLXCONT-SLXLSTAT+OSTO*SLXLEN(B)
OEXC     EQU   4
         MVC   SECEXC(4),L'SLXLHDR+SLXCONT-SLXLSTAT+OEXC*SLXLEN(B)
ODYN     EQU   7
         MVC   SECDYN(4),L'SLXLHDR+SLXCONT-SLXLSTAT+ODYN*SLXLEN(B)
OMON     EQU   8
         MVC   SECMON(4),L'SLXLHDR+SLXCONT-SLXLSTAT+OMON*SLXLEN(B)
OGEN     EQU   10
         MVC   SECGEN(4),L'SLXLHDR+SLXCONT-SLXLSTAT+OGEN*SLXLEN(B)
*
         L     B,SCDSMBEP     LOAD EP OF SMB LIST
         USING SMB,B          ********USE SMB********
         LH    C,SCDSMBN      NUMBER OF SMB'S
         SR    D,D            CLEAR DEQ
         SR    E,E            CLEAR ENQ
QCTLOOP  AH    D,SMBDEQCT     ADD DEQ CNT
         AH    E,SMBENQCT     ADD ENQ CNT
         AH    B,SCDSMBL      ADD LENGTH OF EACH SMB
         BCT   C,QCTLOOP
         ST    D,SECDEQCT     SAVE DEQ CNT
         ST    E,SECENQCT     SAVE ENQ CNT
         SR    E,D            ACTUAL QCT
         ST    E,SECQCT
         DROP  B
*
         TM    SWA,WASGM      GETMAIN PERFORMED ??
         BO    ONLMOVE
*
         LH    0,SCDCNTN      GET NUMBER OF CNT'S
         MH    0,SCDCNTL      LENGTH OF CNT-TABLE
         ST    0,LOCLNG       LENGTH OF GETMAIN-AREA
         GETMAIN R,LV=(0)     GET STORAGE FOR SVC
         ST    1,LOCCNT       TO-ADDRESS FOR SVC
         OI    SWA,WASGM      SET BIT
ONLMOVE  DS    0Y
         L     A,SCDCNT
         L     B,LOCLNG
         L     C,LOCCNT
*
SVCLOOP  DS    0Y
         ST    A,SVCFADDR
         ST    C,SVCTADDR
         MVC   SVCLNGTH(4),=A(4096)
         C     B,=A(4096)
         BH    *+8
         ST    B,SVCLNGTH
         LA    1,SVCPARM
         SVC   237
         LTR   15,15
         LA    15,4
         BNZ   SUPEREX
         A     A,=A(4096)
         A     C,=A(4096)
         S     B,=A(4096)
         BP    SVCLOOP
*
         L     B,LOCCNT       LOAD EP OF CNT LIST
         USING CNT,B          ********USE CNT********
         LH    C,SCDCNTN      NUMBER OF CNT'S
         SR    D,D            CLEAR DEQ
         SR    E,E            CLEAR ENQ
CNTLOOP  AH    D,CNTDEQCT     ADD DEQ CNT
         AH    E,CNTENQCT     ADD ENQ CNT
         AH    B,SCDCNTL      ADD LENGTH OF EACH CNT
         BCT   C,CNTLOOP
         ST    D,SECDEQCN     SAVE DEQ CNT
         ST    E,SECENQCN     SAVE ENQ CNT
         SR    E,D            ACTUAL QCT
         ST    E,SECQCN
         DROP  B
SVCERR   DS    0Y
*
         XC    SMPROZ(4),SMPROZ
         L     A,SCDSMDCB     GET DCB OF SHORT
         SR    0,0
         L     1,DCBLBW-IHADCB(A)  LOAD HI BLOCK USED
         LA    1,0(1)
         M     0,=F'10000'
         L     14,DCBRBASN-IHADCB(A)   DIVIDE BY LAST BLOCK WRITTEN
         LA    14,0(14)
         LTR   14,14
         BNP   SKSMDIV
         DR    0,14
         ST    1,SMPROZ
SKSMDIV  EQU   *
*
         XC    LMPROZ(4),LMPROZ
         L     A,SCDLMDCB     GET DCB OF LONG
         SR    0,0
         L     1,DCBLBW-IHADCB(A)  LOAD HI BLOCK USED
         LA    1,0(1)
         M     0,=F'10000'
         L     14,DCBRBASN-IHADCB(A)   DIVIDE BY LAST BLOCK WRITTEN
         LA    14,0(14)
         LTR   14,14
         BNP   SKLMDIV
         DR    0,14
         ST    1,LMPROZ
SKLMDIV  EQU   *
         MVC   TXT01ID(4),SSCDIMID
         MVC   MONFLG(2),SCDSTMN1
         MVC   SECITASK(4),SCDITCNT
         MVC   SECIDSPT(4),SCDDPCNT
         MVC   SECIPOST(4),SCDIPSTT
         MVC   SECISWIT(4),SCDISWTN
*
         LH    A,SCDKDSWH         HIGH NO PRIV SAP WAITERS
         AH    A,SCDKPSWH         HIGH    PRIV SAP WAITERS
         ST    A,SECNSAP
         MVC   SECNSRB(4),SCDINOSB
*
         MVC   SECNSCHD(4),SCDNSCHD
         MVC   SECNSPGM+2(2),SCDNSPGM
         MVC   SECNSCUT+2(2),SCDNSCUT
         MVC   SECNSDB+2(2),SCDNSDB
         MVC   SECNMISC+2(2),SCDNMISC
*
         L     A,SCDXC0EP     EP OF DFSFXC00
         MVC   SECUSED(4),CUSED-DFSFXC00(A)
         MVC   SECQCBF(4),NRQCBF-DFSFXC00(A)
         MVC   SECQCBT(4),NRQCBT-DFSFXC00(A)
         MVC   SECQCBA(4),NRQCBA-DFSFXC00(A)
*
         L     A,SCDDBDCB
         MVC   SECENTRS(4),DLGENTRS-IHADCB(A)
         MVC   SECWAITS(4),DLGWAITS-IHADCB(A)
         MVC   SECWRTES(4),DLGWRTES-IHADCB(A)
*
         SR    15,15        INDICATES NORMAL RETURN
SUPEREX  DS    0Y
         STM   0,15,SUPSAV
         SVC   3
         SPACE 3
         LTORG *
         EJECT ,
         DS    0D
SVA      DC    18A(0)
TIMEDIFF DC    D'0'
TEMP     DC    2A(0)
*---------------------------------------------------------------------*
SVCPARM  DS    0A
SVCFASID DC    Y(0)
SVCTASID DC    Y(0)
SVCFADDR DC    A(0)
SVCTADDR DC    A(0)
SVCLNGTH DC    A(0)
*---------------------------------------------------------------------*
LOCLNG   DC    A(0)
LOCCNT   DC    A(0)
EPPARM   DC    A(0)
ANZLIN   DC    F'0'
LINECT   DC    F'3'
SMPROZ   DC    A(0)
LMPROZ   DC    A(0)
*
DW       DC    D'0'
DX       DC    D'0'
MONEXI   DC    A(0)
MONFLG   DC    X'000000'
*---------------------------------------------------------------------*
SWA      DC    X'0'
WASLOAD  EQU   B'00000001'
WASACT   EQU   B'00000010'
*        EQU   B'00000100'
WASGM    EQU   B'00001000'
*---------------------------------------------------------------------*
MASK1    DC    X'402021204B2020'
DMMY1    DC    C' N/A   '
MASK2    DC    X'402020202120'
MASK3    DC    X'40202120'
MASK4    DC    X'402020204020D2'
MASK5    DC    X'4020202020202120'
MYSCD    DC    A(0)
SUPSAV   DC    16A(0)
ORGINSCD DC    A(0)
MAXPOOL  DC    Y(0)
MAXVSAM  DC    Y(0)
XSCDPCK  DC    A(0)
XSCDUNPK DC    CL8' '
TRC      DC    C'0123456789ABCDEF'
         SPACE ,
SEC      DS    0D
SECTIME  DC    D'0'
SECLOG   DC    A(0)
SECSTO   DC    A(0)
SECEXC   DC    A(0)
SECDYN   DC    A(0)
SECMON   DC    A(0)
SECGEN   DC    A(0)
SECIBPC  DC    A(0)
SECNWBK  DC    A(0)
SECINPL  DC    A(0)
SECRDCT  DC    A(0)
SECOSWT  DC    A(0)
SECCHWT  DC    A(0)
SECGTBF  DC    A(0)
SECTLCP  DC    A(0)
SECDEQCT DC    A(0)
SECENQCT DC    A(0)
SECQCT   DC    A(0)
SECDEQCN DC    A(0)
SECENQCN DC    A(0)
SECQCN   DC    A(0)
SECITASK DC    A(0)
SECIDSPT DC    A(0)
SECIPOST DC    A(0)
SECISWIT DC    A(0)
SECNSAP  DC    A(0)
SECNSRB  DC    A(0)
SECNSCHD DC    A(0)
SECNSPGM DC    A(0)
SECNSCUT DC    A(0)
SECNSDB  DC    A(0)
SECNMISC DC    A(0)
SECUSED  DC    A(0)
SECQCBF  DC    A(0)
SECQCBT  DC    A(0)
SECQCBA  DC    A(0)
SECENTRS DC    A(0)
SECWAITS DC    A(0)
SECWRTES DC    A(0)
*
SECSPOOL EQU   *
SECBSIZE DC    Y(0)
SECNBUFS DC    Y(0)
SECSRCH  DC    A(0)
SECINP   DC    A(0)
SECWSTW  DC    A(0)
SECWSTR  DC    A(0)
SECWOWN  DC    A(0)
SECREADS DC    A(0)
SECWRITS DC    A(0)
SECWSPL  DC    A(0)
SECTLV0  DC    A(0)
SECTLV1  DC    A(0)
SECTLV2  DC    A(0)
SECTLV3  DC    A(0)
SECTLV4  DC    A(0)
SECTLV5  DC    A(0)
SECTLV6  DC    A(0)
SECTLV7  DC    A(0)
SECTLV8  DC    A(0)
SECSTOL  DC    A(0)
SECSPLSV EQU   *-SECSPOOL
         DC    3XL(SECSPLSV)'00'
SECVSAM  EQU   *
SECBSIZ  DC    A(0)
SECBFNO  DC    A(0)
SECRRBA  DC    A(0)
SECRKEY  DC    A(0)
SECFND   DC    A(0)
SECISES  DC    A(0)
SECISKS  DC    A(0)
SECBALT  DC    A(0)
SECRDS   DC    A(0)
SECUIW   DC    A(0)
SECNUIW  DC    A(0)
SECVSAML EQU   *-SECVSAM
         DC    4XL(SECVSAML)'00'
DATLN    EQU   *-SEC
***
PRM      DS    0D
PRMTIME  DC    D'0'
PRMLOG   DC    A(0)
PRMSTO   DC    A(0)
PRMEXC   DC    A(0)
PRMDYN   DC    A(0)
PRMMON   DC    A(0)
PRMGEN   DC    A(0)
PRMIBPC  DC    A(0)
PRMNWBK  DC    A(0)
PRMINPL  DC    A(0)
PRMRDCT  DC    A(0)
PRMOSWT  DC    A(0)
PRMCHWT  DC    A(0)
PRMGTBF  DC    A(0)
PRMTLCP  DC    A(0)
PRMDEQCT DC    A(0)
PRMENQCT DC    A(0)
PRMQCT   DC    A(0)
PRMDEQCN DC    A(0)
PRMENQCN DC    A(0)
PRMQCN   DC    A(0)
PRMITASK DC    A(0)
PRMIDSPT DC    A(0)
PRMIPOST DC    A(0)
PRMISWIT DC    A(0)
PRMNSAP  DC    A(0)
PRMNSRB  DC    A(0)
PRMNSCHD DC    A(0)
PRMNSPGM DC    A(0)
PRMNSCUT DC    A(0)
PRMNSDB  DC    A(0)
PRMNMISC DC    A(0)
PRMUSED  DC    A(0)
PRMQCBF  DC    A(0)
PRMQCBT  DC    A(0)
PRMQCBA  DC    A(0)
PRMENTRS DC    A(0)
PRMWAITS DC    A(0)
PRMWRTES DC    A(0)
*
PRMSPOOL EQU   *
PRMBSIZE DC    Y(0)
PRMNBUFS DC    Y(0)
PRMSRCH  DC    A(0)
PRMINP   DC    A(0)
PRMWSTW  DC    A(0)
PRMWSTR  DC    A(0)
PRMWOWN  DC    A(0)
PRMREADS DC    A(0)
PRMWRITS DC    A(0)
PRMWSPL  DC    A(0)
PRMTLV0  DC    A(0)
PRMTLV1  DC    A(0)
PRMTLV2  DC    A(0)
PRMTLV3  DC    A(0)
PRMTLV4  DC    A(0)
PRMTLV5  DC    A(0)
PRMTLV6  DC    A(0)
PRMTLV7  DC    A(0)
PRMTLV8  DC    A(0)
PRMSTOL  DC    A(0)
PRMSPLSV EQU   *-PRMSPOOL
         DC    3XL(PRMSPLSV)'00'
PRMVSAM  EQU   *
PRMBSIZ  DC    A(0)
PRMBFNO  DC    A(0)
PRMRRBA  DC    A(0)
PRMRKEY  DC    A(0)
PRMFND   DC    A(0)
PRMISES  DC    A(0)
PRMISKS  DC    A(0)
PRMBALT  DC    A(0)
PRMRDS   DC    A(0)
PRMUIW   DC    A(0)
PRMNUIW  DC    A(0)
PRMVSAML EQU   *-PRMVSAM
         DC    4XL(PRMVSAML)'00'
DATLNALT EQU   *-PRM
***
*---------------------------------------------------------------------*
TXT01    DC    Y(XL01-*,0)
         DC    C'   '
TXT01YY  DC    C'YY'
         DC    C'.'
TXT01DD  DC    C'DDD'
         DC    C'  '
TXT01HH  DC    C'HH'
         DC    C':'
TXT01MM  DC    C'MM'
         DC    C':'
TXT01SS  DC    C'SS'
         DC    C'  *  IMS/VS  1.1.6  MONITOR  *  SCD AT '
TXT01SCD DC    C'XXXXXX'
         DC    C'  IMSID '
TXT01ID  DC    C'XXXX'
         DC    C'    '
XL01     EQU   *
*---------------------------------------------------------------------*
TXT02    DC    Y(XL02-*,0)
         DC    C'   TC-QCT'
TXT02QCT DC    C'XXXXXX'
         DC    C'  TC-RATE'
TXT02TCS DC    C'XXXXXXX'
         DC    C'/S  LINE-QCT'
TXT02LCT DC    C'XXXXXX'
         DC    C'  XMT-RATE'
TXT02LCS DC    C'XXXXXXX'
         DC    C'/S            '
XL02     EQU   *
*---------------------------------------------------------------------*
TXT03    DC    Y(XL03-*,0)
         DC    C' LATCH-CONFL.  DISPATCHER       SCHEDULING      PROGRAX
               M-ISOL.   DYNAMIC LOG     '
XL03     EQU   *
*---------------------------------------------------------------------*
TXT04    DC    Y(XL04-*,0)
         DC    C'  LOG'
TXT04LOG DC    C' XXX.XX'
         DC    C'/S  ITASKS'
TXT04TSK DC    C' XXX.XX'
         DC    C'/S  ATTEM'
TXT04ATT DC    C' XXX.XX'
         DC    C'/S  STOR'
TXT04STO DC    C' XXXXXXX'
         DC    C'BY  ENTR.'
TXT04ENT DC    C' XXX.XX'
         DC    C'/S '
XL04     EQU   *
*---------------------------------------------------------------------*
TXT05    DC    Y(XL05-*,0)
         DC    C'  STO'
TXT05STO DC    C' XXX.XX'
         DC    C'/S  DISP. '
TXT05DSP DC    C' XXX.XX'
         DC    C'/S  CONFL'
TXT05CON DC    C' XXX.XX'
         DC    C' %  REQU.'
TXT05REQ DC    C' XXX.XX'
         DC    C'/S  WAITS'
TXT05WAI DC    C' XXX.XX'
         DC    C'/S '
XL05     EQU   *
*---------------------------------------------------------------------*
TXT06    DC    Y(XL06-*,0)
         DC    C'  EXC'
TXT06EXC DC    C' XXX.XX'
         DC    C'/S  IPOSTS'
TXT06POS DC    C' XXX.XX'
         DC    C'/S  PGM--'
TXT06PGM DC    C' XXX.XX'
         DC    C' %  AVGLN'
TXT06SRC DC    C' XXX.XX'
         DC    C'/R  I/O  '
TXT06IOS DC    C' XXX.XX'
         DC    C'/S '
XL06     EQU   *
*---------------------------------------------------------------------*
TXT07    DC    Y(XL07-*,0)
         DC    C'  DYN'
TXT07DYN DC    C' XXX.XX'
         DC    C'/S  ISWIT.'
TXT07SWT DC    C' XXX.XX'
         DC    C'/S  PRTY-'
TXT07CUT DC    C' XXX.XX'
         DC    C' %                                 '
XL07     EQU   *
*---------------------------------------------------------------------*
TXT08    DC    Y(XL08-*,0)
         DC    C'  MON'
TXT08MON DC    C' XXX.XX'
         DC    C'/S  SAP-WTR'
TXT08NSA DC    C' XXXXX'
         DC    C'    DBINT'
TXT08NDB DC    C' XXX.XX'
         DC    C' %  SHMSG'
TXT08SHP DC    C' XXX.XX'
         DC    C' %  LGMSG'
TXT08LGP DC    C' XXX.XX'
         DC    C' % '
XL08     EQU   *
*---------------------------------------------------------------------*
TXT09    DC    Y(XL09-*,0)
         DC    C'  GEN'
TXT09GEN DC    C' XXX.XX'
         DC    C'/S  NA SRB '
TXT09NSR DC    C' XXXXX'
         DC    C'    OTHER'
TXT09MIS DC    C' XXX.XX'
         DC    C' %  MNTR    '
TXT09MON DC    C'XXXX'
         DC    C'                   '
XL09     EQU   *
*---------------------------------------------------------------------*
TXT10    DC    Y(XL10-*,0)
         DC    CL80' '
XL10     EQU   *
         DC    CL6' '
*---------------------------------------------------------------------*
TXT11    DC    Y(XL11-*,0)
         DC    C' I/O POOL REQ.'
TXT11REQ DC    C' XXX.XX'
         DC    C'/S  IN POOL'
TXT11INP DC    C' XXX.XX'
         DC    C'%  I/O-RATE'
TXT11IOS DC    C' XXX.XX'
         DC    C'/S LCYL   '
TXT11CYL DC    C' XXX'
         DC    C'         '
XL11     EQU   *
*---------------------------------------------------------------------*
TXT12    DC    Y(XL12-*,0)
         DC    C'         READS'
TXT12RD  DC    C' XXX.XX'
         DC    C' %  F-WRITE'
TXT12FW  DC    C' XXX.XX'
         DC    C'%  C-WRITE '
TXT12CW  DC    C' XXX.XX'
         DC    C' % ISAM'
TXT12IS  DC    C' XXX.XX'
         DC    C'%        '
XL12     EQU   *
*---------------------------------------------------------------------*
TXT13    DC    Y(XL13-*,0)
         DC    C' .------ISAM/OSAM SUBPOOLS---------..-------------VSAMX
                  SUBPOOLS-------------. '
XL13     EQU   *
*---------------------------------------------------------------------*
TXT14    DC    Y(XL14-*,0)
         DC    C' NBR/SZE',4CL7' '
         DC    C' NBR/SZE',5CL7' '
         DC    C' '
XL14     EQU   *
*---------------------------------------------------------------------*
TXT16    DC    Y(XL16-*,0)
         DC    C' SEAR/LO',4CL7' '
         DC    C' DBREQ/S',5CL7' '
         DC    C' '
XL16     EQU   *
*---------------------------------------------------------------------*
TXT17    DC    Y(XL17-*,0)
         DC    C' WAIT/IO',4CL7' '
         DC    C' BY KEY%',5CL7' '
         DC    C' '
XL17     EQU   *
*---------------------------------------------------------------------*
TXT18    DC    Y(XL18-*,0)
         DC    C' STEAL/S',4CL7' '
         DC    C' UPDT/S ',5CL7' '
         DC    C' '
XL18     EQU   *
*---------------------------------------------------------------------*
TXT19    DC    Y(XL19-*,0)
         DC    C' NO WRT%',4CL7' '
         DC    C' INPLAC%',5CL7' '
         DC    C' '
XL19     EQU   *
*---------------------------------------------------------------------*
TXT20    DC    Y(XL20-*,0)
         DC    C' OWNALT%',4CL7' '
         DC    C' I/O  /S',5CL7' '
         DC    C' '
XL20     EQU   *
*---------------------------------------------------------------------*
TXT21    DC    Y(XL21-*,0)
         DC    C' OTHALT%',4CL7' '
         DC    C' READ  %',5CL7' '
         DC    C' '
XL21     EQU   *
*---------------------------------------------------------------------*
TXT22    DC    Y(XL22-*,0)
         DC    C' SRC+IO%',4CL7' '
         DC    C' IWRTS %',5CL7' '
         DC    C' '
XL22     EQU   *
*---------------------------------------------------------------------*
TXT23    DC    Y(XL23-*,0)
         DC    C' WW F B%',4CL7' '
         DC    C' FORCED%',5CL7' '
         DC    C' '
XL23     EQU   *
*---------------------------------------------------------------------*
TXT24    DC    Y(XL24-*,0)
         DC    CL80' '
XL24     EQU   *
TXT2401  DC    C'  SD932  :  IMS-R116 ACTIVE, AWAITING NEXT INTERRUPT.'
TXT2401L EQU   *-TXT2401
TXT2402  DC    C'  SD932  :  IMS-R116 NOT ACTIVE OR NO CHKPT WRITTEN.'
TXT2402L EQU   *-TXT2402
*---------------------------------------------------------------------*
         ISCD  SCDBASE=0
*---------------------------------------------------------------------*
         IBPOOL  ,
*---------------------------------------------------------------------*
         ISUBPL  ,
*---------------------------------------------------------------------*
         IAPS  SMBBASE=0
*---------------------------------------------------------------------*
         ICLI  CNTBASE=0
*---------------------------------------------------------------------*
         DFSSLX ,
*---------------------------------------------------------------------*
         DFSSSOB (IEFJESCT,IEFJSCVT)
*---------------------------------------------------------------------*
         XC00   ,
*---------------------------------------------------------------------*
         DLGWORK TYPE=DSECT,FMLIST=NO
*---------------------------------------------------------------------*
         IDLIVSAM BFSP
*---------------------------------------------------------------------*
         END    ,
./ ADD NAME=SD932
         TITLE 'SD932     IMS-MONITOR-DISPLAYER  (TSO, WITH SD932XS)  '
*$LVL$12/02/80-11:45
*---------------------------------------------------------------------*
* SD932        DISPLAY IMS ACTIVITIES                                 *
*                                                                     *
*                                                                     *
*                                                                     *
*                                                                     *
*                                                                     *
*                                                                     *
*                                                                     *
*                                                                     *
*                                                                     *
*---------------------------------------------------------------------*
         REG
         SDREGS ,
SD932    CSECT ,
         ENTRY SDENTRY
SDENTRY  DS    0Y
         XSAVE R12,SVA,SD932.HUEGLY..
         USING SVA,S
         ST    R1,HHPARM
RUNSTRT  EQU   *
         TPUT  BUFF,12,FULLSCR
         LA    R2,HHPARM
         CALL  SDIMSMON,(TEST,TEST,(R2)),VL
         LTR   R15,R15
         BZ    IMSACT
         TPUT  NOIMSTXT,78,EDIT,WAIT,NOHOLD
         B     TESTREQ
IMSACT   EQU   *
         LA    R2,HHPARM
         LA    R3,17
         CALL  SDIMSMON,(SDEXIT,(R3),(R2)),VL
TESTREQ  DS    0Y
         TGET  SDINPT,78
         CH    15,=H'4'
         BE    TIMELOOP
         TRT   SDINPT(78),TRTAB
         BZ    TIMELOOP
         TPUT  SDEND,78,EDIT,WAIT,NOHOLD
         CALL  SDIMSMON,(FREE),VL
         XRETURN 0
TIMELOOP DS    0Y
         STIMER WAIT,BINTVL=BINTVL
         B     RUNSTRT
NOIMSTXT DC    CL78'  SD932 : THE IMS SYSTEM IS NOT ACTIVE .'
SDEND    DC    CL78'  SD932 : TRACE STOPPED, AREAS FREED   .'
SDINPT   DC    CL78' '
TRTAB    DC    256X'0'
         ORG   TRTAB+C'?'
         DC    C'?'
         ORG   TRTAB+C'#'
         DC    C'#'
         ORG   TRTAB+256
         DS    0H
*
         SPACE 5
SDEXIT   DS    0H
         XSAVE R12,SDEXITSV,IMSMONEX
         LR    R2,R1
SDNXTLN  EQU   *
         L     R3,0(R2)
         LA    3,5(3)
         TPUT  (3),78,EDIT,WAIT,NOHOLD
         TM    0(R2),128
         BO    SDXRET
         LA    R2,4(R2)
         B     SDNXTLN
SDXRET   XRETURN 0
         LTORG
         DS    0D
SVA      DS    18F
TEST     DC    C'TEST'
FREE     DC    C'FREE'
BINTVL   DC    F'0500'
BUFF     DC    X'C1115D7E114040133C404000'
HHPARM   DS    A
MYLINE   DC    CL80' '
         END
./ ADD NAME=MSG
LUXMSG   START
         XSAVE R12,,LUXMSG,WORKL
         LR    R14,R1
         USING PARMAREA,R14
         USING WORK,R13
         CLC   REG4(4),=CL4'TSO'
         BNE   NOTSO
         TPUT  NOTSOMSG,50
         B     RETURN
NOTSOMSG DC    CL50'XMSG000 X-MSG NOT SUPPORTED UNDER TSO'
NOTSO    EQU   *
         XC    SWITCH,SWITCH
         LA    R4,TEXT+4
         L     R10,REG4
         L     R5,16                   CVT - ADRESSE
         L     R5,100(R5)              CONSOLE UCB-LISTE
         L     R6,72(R5)
         L     R7,76(R5)    LENGTH OF EACH UCM
         L     R5,80(R5)    ADDRESS OF LAST UCM
         CLI   0(R4),C''''
         BNE   NEXTNTRY
         OI    SWITCH,X'80'
         B     ACTALL
NEXTNTRY EQU   *
         L     R8,12(R6)     ADDRESS OF UCB
         CLC   13(3,R8),0(R4)    CUU'S MATCHING?
         BE    FOUND     YES, BRANCH
         CR    R6,R5    LAST UCM REACHED?
         BNE   NOER
         LA    2,NOTFOUND
         B     GETKSP
NOER     EQU   *
         LA    R6,0(R7,R6)   INCREASE POINTERLE TO NEXT UCM
         B     NEXTNTRY
FOUND    EQU   *
         SR    R0,R0
         IC    R0,26(R6)
         ST    R0,R0SAVE
         LR    R11,R4   R11 = CUU IN MSG-COMMAND
         TM    25(R6),X'10'            CONSOLE ACTIVE ?
         BO    ACTIVE
         LA    2,NOTACTIV
         B     GETKSP
ACTIVE   EQU   *
         LA    R4,4(R4)
ACTALL   EQU   *
         CLI   0(R4),C''''
         BE    PRMOK
ERROR    EQU   *
         LA    2,ERRPRM
         B     GETKSP
PRMOK    EQU   *
         LA    R5,1(R4)
         LR    R4,R5
         LA    R6,0
NEXTCHAR EQU   *
         LA    R4,0(R6,R5)
         CLI   0(R4),C''''             SEARCH ENDING APOSTROPH
         BE    ENDMSG
         LA    R6,1(R6)
         CH    R6,=H'101'
         BNL   ERROR
         B     NEXTCHAR
ENDMSG   EQU   *
         LA    R1,MESSAGE
         LR    R9,R1
         LA    R6,16(R6)
         STH   R6,0(R1)
         MVC   2(2,R1),=X'E000'
         MVC   11(3,R1),0(R11)   MOVE CUU FROM MSG-COMMAND
         TM    SWITCH,X'80'
         BNO   NOTALL
         MVI   2(R1),X'84'
         MVC   11(3,R1),=CL3'ALL'
NOTALL   EQU   *
         MVC   7(4,R1),=C' TO '
         MVC   16(100,R1),0(R5)
         LA    R7,0(R6,R1)
         MVC   0(2,R7),=X'0000'
         MVC   2(2,R7),=X'0000'
         SR    R11,R11     CLEAR REGISTER FOR IC
         L     R5,16      CVT
         L     R5,100(R5)     POINTER TO CONLOLE UCB'S  (UCM-PREFIX)
         L     R6,72(R5)    ADDR. OF 1. UCM
         L     R7,76(R5)    LENGTH OF EACH UCM
         L     R5,80(R5)    ADDR. OF LAST UCM
NXTNTRY  EQU   *
         IC    R11,26(R6)    INSERT UCM-ID FROM CURRENT UCM
         CR    R11,R10   COMPARE WITH PASSED ID
         BE    CONSOK      THE ISSUING CONSOLE EXISTS - BRANCH
         CR    R6,R5  IF END OF LIST OF UCM'S,CHECK MEMORY OF COMPUTER
         BE    ERROR
         LA    R6,0(R7,R6)  THERE IS A HOPE TO FIND UCM, INCR. PTR.
         B     NXTNTRY    AND BRANCH
CONSOK   EQU   *
         L     R5,12(R6)   UCB-ADDR.
         MVC   4(3,R1),13(R5)
         MVC   14(2,R1),=C': '
         L     R0,R0SAVE
         WTO   MF=(E,MESSAGE)
RETURN   EQU   *
         XRETURN ,R
GETKSP   EQU   *
         MVC   MESSAGE,0(R2)
         L     R0,REG4
         WTO   MF=(E,MESSAGE)
         B     RETURN
NOTFOUND WTO   'XMSG001 SPECIFIED CONSOLE NOT FOUND',MF=L,             *
               MCSFLAG=(REG0)
NOTACTIV WTO   'XMSG002 CONSOLE NOT ACTIVE',MCSFLAG=(REG0),MF=L
ERRPRM   WTO   'XMSG003 ERROR IN PARAMETER',MCSFLAG=(REG0),MF=L
         DS    CL100
         REG
WORK     DSECT
SVA      DS    18F
R0SAVE   DS    F
MESSAGE  DS    CL120
SWITCH   DS    X
WORKL    EQU   *-WORK
         XPARM
         END
./ ADD NAME=MSSDEM
MSSDEM   START
         XSAVE R12,SVA,MSSDEM
         REG
         L     R2,16
         L     R2,40(R2)    A(UCB-LOOKUP-TABLE)
         SR    R15,R15
LOOKUCB  EQU   *
         CLC   0(2,R2),=H'-1'
         BE    RETURN
         SR    R8,R8
         ICM   R8,3,0(R2)
         LTR   R8,R8
         BZ    NEXTUCB
         CLI   18(R8),X'20'    DASD-UCB
         BNE   NEXTUCB
         CLC   VOLSER,28(R8)
         BE    FOUND
NEXTUCB  EQU   *
         LA    R2,2(R2)
         B     LOOKUCB
SORTLOOK EQU   *
         TM    3(R8),X'20'    RESERVED ATTRIBUTE ?
         BZ    UNLOADIT       NO, WE CAN UNLOAD
         TM    34(R8),X'10'   MOUNTED PRIVATE ?
         BZ    UNLOADIT       NO, WE CAN UNLOAD
         B     NEXTUCB        IF PRIVATE/RESERVED LET VOLUME MOUNTED
FOUND    EQU   *
         TM    3(R8),X'08'    ALLOCATED ?
         BO    NEXTUCB        OK, LET IT
         CLI   30(R8),C'S'    VOLSER = 'VVS...' ?
         BE    SORTLOOK       LOOK IF MOUNTED PRIVATE
UNLOADIT EQU   *
         LA    R5,ALREADY
NXTDEV   EQU   *
         CLC   0(3,R5),=CL3' '
         BE    COMMAND
         CLC   0(3,R5),13(R8)
         BE    NEXTUCB
         LA    R5,3(R5)
         B     NXTDEV
COMMAND  EQU   *
         MVC   0(3,R5),13(R8)
         MVC   UNLCMD+2(3),13(R8)
         LA    R1,SVCAREA
         SVC   249              GIVE UNLOAD COMMAND
         STIMER WAIT,BINTVL=BINTVL
         B     NEXTUCB
RETURN   XRETURN 0
         DS    0F
BINTVL   DC    F'6000'
VOLSER   DC    C'VV'
SVCAREA  DC    H'9,0'
UNLCMD   DC    CL20'U'
ALREADY  DC    512CL3' '
         END
./ ADD NAME=XMSSMNT
//Z227128M JOB (6685,128,1),FRANZ,MSGCLASS=T,
//     CLASS=R,NOTIFY=Z227128
//MSSMNT EXEC ASMFCL
//ASM.SYSIN DD *
XMSSMNT  CSECT
         XSAVE R12,SVA,XMSSMNT
         REG
         LR    R11,R1
         USING PARMAREA,R11
         MVC   VOLSER,TEXT+7
         SPACE 2
         CLC   =CL4'TSO',REG4   IS THIS A TSO CALL
         BNE   ALLOC            NO, ASSUME CONSOLE COMMAND
         SPACE
         L     R1,16            A(CVT)
         L     R1,0(R1)         A(TCBPTR)
         L     R1,4(R1)         A(CURRENT = OWN TCB)
         L     R1,12(R1)        A(TIOT)
         CLC   0(4,R1),=CL4'Z227' JOBNAME
         BE    ALLOC            AUTHORIZE UIDS STARTING WITH Z227
         SPACE
         CLC   =CL3'VV0',VOLSER
         BE    ALLOC
         CLC   =CL3'VVM',VOLSER
         BE    ALLOC
         CLC   =CL3'VVN',VOLSER
         BNE   TPUT3
         SPACE 2
ALLOC    EQU   *
         CALL  LUALLOC,(ALCSTR,ALCLEN,ALCMSG,ALCMDEF),VL
         LTR   R15,R15
         BNZ   PUTALERR
         SPACE 2
         TIOTSCAN DDNAME
         LTR   R15,R15
         BZ    NOTFND
         SR    R8,R8        SAVE POINTER
         ICM   R8,3,18(R15) TO UCB
         SPACE 2
         CALL  LUFREE,(ALCSTR,ALCLEN,ALCMSG,ALCMDEF),VL
         LTR   R15,R15
         BNZ   PUTALERR
         SPACE 2
         CLC   REG4(4),=CL4'TSO'
         BE    TPUT
         L     R0,REG4
         MVC   WTO+41(3),13(R15)
         MVC   WTO+23(6),VOLSER
         MVC   WTO+41(3),13(R8)     MOVE UNIT ADDRESS
WTO      WTO   'MSSMNT1 VOLUME 123456 MOUNTED ON CUU',MCSFLAG=REG0
         B     RETURN
TPUT     EQU   *
         MVC   TSOMSG+33(3),13(R8)  MOVE UNIT ADDRESS
         MVC   TSOMSG+15(6),VOLSER  AND VOLSER TO MESSAGE
         TPUT  TSOMSG,50            TELL TSO-USER MOUNT COMPLETE
RETURN   EQU   *
         XRETURN 0
NOTFND   EQU   *
         CLC   REG4(4),=CL4'TSO'
         BE    TPUT1
         MVC   WTO1+23(6),VOLSER
         L     R0,REG4
WTO1     WTO   'MSSMNT2 VOLUME 123456 NOT MOUNTED',MCSFLAG=REG0
         B     RETURN
TPUT1    EQU   *
         MVC   TSOMSG1+15(6),VOLSER
         TPUT  TSOMSG1,50
TPUT3    EQU   *
         TPUT  TSOMSG2,79
         B     RETURN
PUTALERR EQU   *
         CLC   =CL4'TSO',REG4
         BE    TPUTERR
         MVC   WTOLIST+14(80),ALCMSG+80
         L     R0,REG4
         WTO   MF=(E,WTOLIST)
         MVC   WTOLIST+14(80),ALCMSG+160
         L     R0,REG4
         WTO   MF=(E,WTOLIST)
         B     RETURN
         SPACE 2
TPUTERR  EQU   *
         TPUT  ALCMSG+80,79
         TPUT  ALCMSG+160,79
         B     RETURN
         SPACE
WTOLIST  WTO   'MSSNTALC 0....5...20....5...30....5...40....5...50....5*
               ...60....5...70....5...80....5...90    ',MCSFLAG=REG0,  *
               MF=L
ALCSTR   DC    C'DDNAME='
DDNAME   DC    CL8'MSSMNT',C',DSN=MSSMNT,'
         DC    C',UNIT=3330V,VOL=SER='
VOLSER   DC    CL6' '
         DC    C',DISP=SHR'
ALCEND   EQU   *
         DS    0H
ALCLEN   DC    AL2(ALCEND-ALCSTR)
ALCMSG   DC    CL240' '
ALCMDEF  DC    CL16'WTP=NO,LMSG=YES'
TSOMSG   DC    CL50'MSSMNT1 VOLUME 123456 MOUNTED ON CUU'
TSOMSG1  DC    CL50'MSSMNT2 VOLUME 123456 NOT MOUNTED'
TSOMSG2  DC    CL80'MSSMNT3 VIA TSO ONLY VOLS STARTING WITH VV0, VVM UN*
               D VVN CAN BE MOUNTED'
         LTORG
         XPARM
         END
//LKED.SYSLMOD DD DSN=LU.LNKLIB(XMSSMNT),DISP=SHR
//
./ ADD NAME=MSSMNT
//Z223478M JOB (6685,478,1),
//   TIME=1,CLASS=1,MSGCLASS=T,NOTIFY=Z223478
//ASM EXEC ASMFCL
//ASM.SYSIN DD *
MSSMNT   CSECT
         REG
         XSAVE R12,SVA,MSSMNT
         SPACE
A00007C  L     R1,0(R1)
         MVC   VOLSER,0(R1)
         CLC   VOLSER(2),A000188
         BE    A0000A0
         CLC   VOLSER(2),A00018A
         BE    A0000A0
         SR    R15,R15
         B     XRET
A0000A0  LA    R1,A0000FC
         SVC   99                          DDDYNAM
         LA    R1,A000100
         SVC   99                          DDDYNAM
         SPACE
         LA    R2,VOLSER
         UCBSCAN DEVTYPE=DASD,VOLSER=(R2),STATUS=ONLINE
         LTR   R15,R15
         BNZ   ERRRET
         SPACE
         LR    R15,R1                   GET UCB ADDR
         SPACE
XRET     EQU   *
         XRETURN (R15)
         SPACE
ERRRET   EQU   *
         XR    R15,R15
         B     XRET
         EJECT
A0000FC  EQU   *
         DC    X'80'
         DC    AL3(A000104)
A000100  DC    X'80'
         DC    AL3(A000118)
A000104  EQU   *
         DC    X'14010000'
         DC    F'0'
         DC    A(A00012C)
         DC    F'0'
         DC    F'0'
A000118  EQU   *
         DC    X'14020000'
         DC    F'0'
         DC    A(A000140)
         DC    F'0'
         DC    F'0'
A00012C  EQU   *
         DC    A(A00014C)
         DC    A(A00015C)
         DC    A(A000168)
         DC    A(A00016F)
         DC    X'80'
         DC    AL3(A00017A)
A000140  EQU   *
         DC    A(A00014C)
         DC    A(A00015C)
         DC    X'80'
         DC    AL3(A000158)
A00014C  EQU   *
         DC    F'65537'
         DC    H'0006'
         DC    C'MSSMNT'
A000158  EQU   *
         DC    X'00070000'
A00015C  EQU   *
         DC    X'00020001'
         DC    H'0006'
         DC    C'MSSMNT'
A000168  EQU   *
         DC    X'00040001'
         DC    X'000108'
A00016F  EQU   *
         DC    X'00'
         DC    X'15000100'
         DC    X'05'
         DC    C'3330V'
A00017A  EQU   *
         DC    H'0016'
         DC    F'65542'
VOLSER   DC    CL6' '
         DC    H'0'
A000188  DC    C'VV'
A00018A  DC    C'DL'
A00018C  DC    X'FFFF'
         END
//LKED.SYSLMOD DD DSN=LU.SBRLIB(MSSMNT),DISP=SHR
//
./ ADD NAME=XOPER
         TITLE 'EXTENDED OPER COMMAND FOR TSO'
SP3OPER  CSECT
***********************************************************************
*                                                                     *
*              P R O L O G                                            *
*                                                                     *
***********************************************************************
*                                                                     *
*              PROGRAMMER              STOEHLER / DATEV EG. NUERNBERG *
*                                                                     *
*---------------------------------------------------------------------*
*                                                                     *
*              DESCRIPTION                                            *
*                                                                     *
*              THIS PROGRAM WILL DO CONSOLE SIMULATION FOR A TSO      *
*              TERMINAL. IT GOES OUT AND FINDS A GRAPHICS (3277)      *
*              ACTIVE CONSOLE AND USES THAT CONSOLE SCREEN IMAGE      *
*              FOR OUTPUT AND THEIR UCM-ID FOR SVC 34.                *
*              THIS PROGRAM REQUIRES AUTHORIZATION TO USE THE SVC 34  *
*              INTERFACE.                                             *
*              TO USE IT SIMPLY SAY   ''XOPER <CUU>''                 *
*              A NULL INPUT CAUSES THE SCREEN TO BE UPDATED. (SO YOU  *
*              CAN USE IT UN-AUTHORIZED AS LONG AS YOU DON'T TYPE     *
*              ANYTHING IN.)                                          *
*              COMMANDS ARE BROADCAST TO THE CONSOLE BEING USED.      *
*                                                                     *
*---------------------------------------------------------------------*
*              MODIFICATIONS:   A.HUST / ICR NEUSTADT  01/84          *
*                                                                     *
*              FULL PF-KEY-SUPPORT:                                   *
*              DYNAMIC ALLOCATION TO "SYS1.XHELP", WHERE              *
*              PF-KEYS ARE STORED IN MEMBERS NAMED '@USERID'.         *
*              (ICR)                                                  *
*---------------------------------------------------------------------*
*                                                                     *
*              PARAMETER               ADDRESS OF A SPECIFIC CONSOLE  *
*                                      CUU (NOT REQUIRED)             *
*                                                                     *
*              I/O                     ONLY TGET/TPUT                 *
*                                                                     *
*              EXIT                    NORMAL RETURN (AFTER YOU TYPE  *
*                                      'END')                         *
*                                                                     *
*              ERROR MESSAGES          NO ACCEPTABLE (3277) CONSOLES  *
*                                      FOUND                          *
*                                                                     *
***********************************************************************
         XSAVE (R12,R2),,XOPER,WORKL
         REG
         USING WORK,R13
         BAL   R14,APFK001            ASSIGN PFKEY VALUES
         STM   R1,R2,SVCSAVE
         LR    R0,R13
         LR    R1,R12
         LA    R15,SVCROUT
         SVC   250
         XRETURN 0,R
SVCROUT  EQU   *
         LR    R13,R0
         LR    R12,R1
         LM    R1,R2,SVCSAVE
         L     R3,16
         L     R3,0(R3)
         L     R3,4(R3)
         L     R3,12(R3)
         MVC   CMDID+11(8),0(R3)   TSO-USER NAME
         L     R3,PSAAOLD-PSA(0)   ASCB
         L     R3,ASCBCSCB-ASCBEGIN(R3)
         LTR   R3,R3
         BZ    END3
         CLI   X'1C'(R3),1         TSO ?
         BNE   END3                NO --> TERM.
         CLC   4(4,R1),=C'OPER'    CALLED FROM XC COMMAND ?
         BNE   END3                NO - INVALID REQUEST
         CLI   8(R1),C','          IS A SPECIFIC UNIT GIVEN ?
         BNE   GOON1               NO
         MVC   UNITXXX(3),9(R1)    SAVE IT
GOON1    EQU   *
         SPACE 2
         STFSMODE ON,INITIAL=YES
         SPACE 2
         MODESET KEY=ZERO,MODE=SUP
   SPACE
         L     R14,=A(ESRB-SRBSECT)  GET LENGTH
         GETMAIN R,LV=(14),SP=245
   SPACE
         LR    R7,R1
         USING SRBSECT,R7
         LA    R0,LSCREEN
         GETMAIN R,LV=(0)
         LR    R9,R1
SCHEDUL  XC    SRBSECT(SRBSIZ),SRBSECT
         MVC   CMDBUF,BLANKS
         LA    R1,44 ***********   NUMBER OF LINES WAS   24 !!!!!
         LA    R14,BUFF
GOTONE2  MVC   0(2,R14),=X'1D60'    NORMAL INTENSITY
         MVI   2(R14),64
         MVC   3(78,R14),2(R14)     CLEAR
         LA    R14,81(R14)           NEXT LINE
         BCT   R1,GOTONE2          REPEAT
         MVC   SRBID,=C'SRB '
         L     R1,16
         L     R1,X'22C'(R1)
         LA    R15,528(R1)
TM15     TM    0(R15),X'80'
         BO    NEXTAS
         ICM   R1,7,1(R15)
         BZ    0
         ICM   R14,7,1+ASCBJBNS-ASCBEGIN(R1)
         BNZ   NEXT1
         ICM   R14,7,1+ASCBJBNI-ASCBEGIN(R1)
NEXT1    CLC   0(8,R14),=CL8'CONSOLE'
         BE    FOUND
NEXTAS   LA    R15,4(R15)
         B     TM15
FOUND    EQU   *
         ST    R1,SRBASCB
         L     R1,PSAAOLD-PSA(0)
         ST    R1,SRBMYAS
         MVC   SRBPASID,X'24'(R1)
         MVC   SRBCPAFF,X'64'(R1)
         L     R1,ASCBTSB-ASCBEGIN(R1)
         MVC   SRBLINE,40(R1)
         L     R0,PSATOLD-PSA(0)
         ST    R0,SRBPTCB
         LA    R0,ABND
         ST    R0,SRBRMTR
         LA    R0,SRBCODE
         ST    R0,SRBEP
         LA    R0,SRBECB
         ST    R0,SRBPARM
         LA    R0,SAVESRB
         ST    R0,SRBSAVE
         OI    SRBPRIOR,SRBPNONQ
         MVC   SRBCONAD(3),UNITXXX
         OC    SRBCONAD(3),BLANKS
          SPACE 2
         LA    R0,SRBCODE
         LA    R14,CODEA
         LA    R1,CODEE-CODEA
         LR    R15,R1
         MVCL  R0,R14
   SPACE 2
         SCHEDULE SRB=(R7)
     SPACE
         WAIT  1,ECB=SRBECB
         MVC   XUCMID,SRBCONID
         CLI   SRBECB,X'41'       ERROR ?
         BE    ERRMSG
         CLI   SRBECB,X'42'       ERROR ?                  ****16.12.81
         BE    ERRMSG2                                     ****16.12.81
         MVI   SRBECB,0
         LA    R1,CLEAR
         MVC   0(11,R9),=X'C71140403C404000114040'
         LA    R0,11(R9)
         LA    R1,LSCREEN-11
         LA    R14,BUFF
         LR    R15,R1
         MVCL  R0,R14
         L     R14,SRBBUFL
         LR    R1,R9
         TPUT  (1),(R14),FULLSCR
         SPACE 2
TGET     EQU   *
         MVC   CMDBUF,BLANKS
         TGET  CMDBUFP,83,ASIS
         ST    R1,TGETLENG         LENGTH OF GOTTEN DATA
         SPACE 2
         BAL   R14,PPFK001         RECOGNICES PFKEY OR ENTER KEY
         B     *+4(R15)            TEST RETURN CODE
         B     ENTER               RC = 0 - EXECUTE COMMAND IN BUFFER
         B     TGET                RC = 4 - LAST EXECUTED COMMAND WAS
*                                  DISPLAYED, NOW TGET AGAIN
         B     SCHEDUL             RC = 8 - PFKEY DEFINITIONS WERE
*                                  DISPLAYED, RETURN TO NORMAL MODE
         SPACE 2
ENTER    EQU   *
         LA    R1,44
         LA    R14,BUFF
MOVEBLK  MVC   2(79,R14),BLANKS
         LA    R14,81(R14)
         BCT   R1,MOVEBLK
    SPACE 2
         OC    CMDBUF(4),BLANKS
         CLC   CMDBUF(4),=C'END '
         BE    END2
         B     OSOK
MVCBLK   EQU   *
         MVC   CMDBUF,BLANKS
         B     SCHEDUL
OSOK     EQU   *
         MVC   CMNDBUF,CMDBUF
         OC    CMNDBUF,BLANKS
         CLC   CMNDBUF(3),=C'K  '    CLEAR NOT ALLOWED
         BE    MVCBLK
         CLC   CMNDBUF(5),BLANKS
         BE    SCHEDUL
         CLC   CMNDBUF(4),=C'END '
         BE    END2
         MVC   WTOBUF,CMNDBUF
         LA    R1,WTOX
         SR    R0,R0
         SVC   35
         LA    R1,CMND
         SR    R0,R0
         IC    R0,XUCMID
         SVC   34
         STIMER WAIT,DINTVL=TIME
         B     SCHEDUL
         SPACE 2
ERRMSG2  EQU   *                                           ****16.12.81
         MVI SRBECB,0                                      ****16.12.81
         STFSMODE OFF                                      ****16.12.81
         TPUT  ERRMSG11,LERRMG11                           ****16.12.81
         B     END4                                        ****16.12.81
ERRMSG   EQU   *
         MVI   SRBECB,0
         STFSMODE OFF
         MVC   ERRMSG1+1(3),SRBCONAD
         TPUT  ERRMSG1,LERRMSG1
         B     END4
   SPACE 2
END2     STFSMODE OFF
END4     EQU   *
         SPACE 2
         LA    R0,LSCREEN
         FREEMAIN R,LV=(0),A=(R9)
         SPACE 2
         L     R14,=A(ESRB-SRBSECT)
         FREEMAIN R,LV=(R14),A=(R7),SP=245
      SPACE 2
END3     EQU   *
         SVC   3
         SPACE 2
ABND     EQU   *
         WTO   'AMTFF01 XMPOST ERROR'
         B     END2
         EJECT
*-- --- --- --- --- --- --- --- --- --- --- --- --- --- --- --- --- --*
*                                                                     *
*        SUBROUTINE TO PROCESS INPUT KEYS FROM TERMINAL               *
*                                                                     *
*        THE AID-BYTE FROM TGET-INPUT IS TRANSLATED TO A NUMERIC VALUE*
*        WHICH CORRESPONDS TO THE PF-KEY-NUMBER (WHERE THE ENTER-KEY  *
*        HAS A VALUE OF 0).                                           *
*                                                                     *
*        SPECIAL PROCESSING IS DONE FOR FOLLOWING PF-KEYS :           *
*        PF1 OR PF13 : DISPLAY LAST ISSUED COMMAND IN INPUT-LINE, SO  *
*            THAT THE USER CAN CHANGE THIS COMMAND                    *
*        PF2 OR PF14 : DISPLAYS PFK-USAGE AND ENABLES THE USER TO     *
*            CHANGE THE ASSIGNED VALUE(S).                            *
*        PF3 OR PF15 : STOPS PROCESSING (SAME AS 'END' COMMAND')      *
*        PF4 OR PF16 : THE LAST COMMAND, THAT WAS ENTERED, IS ISSUED  *
*            AGAIN                                                    *
*        ANY OTHER PF-KEY : ISSUE COMMAND, THAT WAS PREVIOUSLY ASSIGNED
*            TO THAT PF-KEY                                           *
*                                                                     *
*                                                                     *
*        REGISTER USAGE :                                             *
*                                                                     *
*        <R14>   BAL-REGISTER                                         *
*        <R15>   CONTAINS RETURN CODE AT RETURN                       *
*                0  -  EXCUTE COMMAND IN 'CMDBUF'                     *
*                4  -  ISSUE TGET AGAIN                               *
*                8  -  ISSUE SCHEDULE AGAIN TO REFRESH SCREEN         *
*                                                                     *
*                                                                     *
*-- --- --- --- --- --- --- --- --- --- --- --- --- --- --- --- --- --*
         SPACE 2
         DS    16F                   REGISTER SAVE AREA
PPFK001  EQU   *
         STM   R0,R15,PPFK001-64     SAVE REGISTER
         IC    R15,CMDBUFP           INSERT AID-BYTE FROM TERMINAL INP
         N     R15,=F'63'            DELETE ALL BITS EXCEPT LAST 6
         IC    R15,TABAID(R15)       LOAD NUMERIC VALUE, WHICH
*                                     REPRESENTS THE PFK-VALUE
         STC   R15,NPFK              SAVE PFK-VALUE
         SPACE 2
*-- --- --- --- --- --- --- --- --- --- --- --- --- --- --- --- --- --*
*        PROCESS SPECIAL PF KEYS                                      *
*-- --- --- --- --- --- --- --- --- --- --- --- --- --- --- --- --- --*
         CLI   NPFK,0                Q. ENTER KEY PRESSED ?
         BE    PPFK005               A. YES
         CLI   NPFK,3                Q. END KEY PRESSED ?
         BE    END2                  A. YES
         CLI   NPFK,15               Q. END KEY PRESSED ?
         BE    END2                  A. YES
         CLI   NPFK,4                Q. REPEAT KEY PRESSED ?
         BE    PPFK010               A. YES
         CLI   NPFK,16               Q. REPEAT KEY PRESSED ?
         BE    PPFK010               A. YES
         CLI   NPFK,1                Q. DISPLAY-COMMAND KEY PRESSED ?
         BE    PPFK020               A. YES
         CLI   NPFK,13               Q. DISPLAY-COMMAND KEY PRESSED ?
         BE    PPFK020               A. YES
         CLI   NPFK,2                Q. DISPLAY PFKEY ASSIGNEMENT ?
         BE    PPFK040               A. YES
         CLI   NPFK,14               Q. DISPLAY PFKEY ASSIGNEMENT ?
         BE    PPFK040               A. YES
         SPACE 2
*-- --- --- --- --- --- --- --- --- --- --- --- --- --- --- --- --- --*
*        PROCESS OTHER PF KEYS                                        *
*-- --- --- --- --- --- --- --- --- --- --- --- --- --- --- --- --- --*
         XR    R15,R15
         IC    R15,NPFK              PFKEY VALUE
         BCTR  R15,R0                CORRECT TABLE ENTRY NUMBER
         M     R14,=F'80'            MULTIPLY BY LENGTH OF 1 TABLEENTRY
         A     R15,PFKDPTR           ADD PTR TO BEGINNING OF TABLE
         TRT   0(72,R15),TRTTAB1     SEARCH FOR CHARACTER C'_' = X'6D'
         BNZ   PPFK002               A. FOUND
         MVC   CMDBUF,0(R15)         MOVES COMMAND INTO BUFFER
         XR    R15,R15               RETURN CODE 0
         LM    R0,R14,PPFK001-64     RESTORE REGISTER
         BR    R14
         SPACE 2
*-- --- --- --- --- --- --- --- --- --- --- --- --- --- --- --- --- --*
*        DISPLAY COMMAND ON INPUT LINE FOR MODIFICATIONS              *
*-- --- --- --- --- --- --- --- --- --- --- --- --- --- --- --- --- --*
PPFK002  EQU   *
         MVI   TPUTBUFF,X'27'        ESCAPE CHARACTER
         MVI   TPUTBUFF+1,X'F1'      COMMAND CODE WRITE
         MVI   TPUTBUFF+2,X'C5'      NO ALARM, KEYBOARD RESTORE
         MVI   TPUTBUFF+3,X'11'      ORDER SBA
         LA    R3,22*80+2            RELATIVE SCREEN POSITION
         STC   R3,TPUTBUFF+5         COMPUTE CURSOR POSITION
         SRL   R3,6
         STC   R3,TPUTBUFF+4
         NI    TPUTBUFF+5,X'3F'
         TR    TPUTBUFF+4(2),TABSBA  TRANSLATE TO SCREEN-ADDRESS
         MVI   TPUTBUFF+6,X'1D'      ORDER SF
         MVI   TPUTBUFF+7,X'C1'      ATTRIBUTES
         MVC   TPUTBUFF+8(72),0(R15) MOVE COMMAND TEXT
         MVI   TPUTBUFF+80,X'11'     SBA
         SR    R1,R15
         LA    R1,22*80+3(R1)        RELATIVE SCREEN POSITION
         STC   R1,TPUTBUFF+82        COMPUTE CURSOR POSITION
         SRL   R1,6
         STC   R1,TPUTBUFF+81
         NI    TPUTBUFF+82,X'3F'
         TR    TPUTBUFF+81(2),TABSBA TRANSLATE TO SCREEN-ADDRESS
         MVI   TPUTBUFF+83,X'13'     INSERT CURSOR
         TPUT  TPUTBUFF,84,FULLSCR
         LA    R15,4                 RETURN CODE 4
         LM    R0,R14,PPFK001-64     RESTORE REGISTER
         BR    R14
         SPACE 2
*-- --- --- --- --- --- --- --- --- --- --- --- --- --- --- --- --- --*
*        PROCESS ENTER KEY                                            *
*-- --- --- --- --- --- --- --- --- --- --- --- --- --- --- --- --- --*
PPFK005  EQU   *
         CLC   CMDBUF,BLANKS         Q. COMMAND ENTERED ?
         BE    PPFK006               A. NO
         MVC   BPFKSAVE,CMDBUFP      A. YES - SAVE LAST COMMAND ENTERED
PPFK006  EQU   *
         XR    R15,R15               RETURN CODE 0
         BR    R14                   RETURN
         SPACE 2
*-- --- --- --- --- --- --- --- --- --- --- --- --- --- --- --- --- --*
*        PROCESS REPEAT KEY (PF4 OR PF16)                             *
*-- --- --- --- --- --- --- --- --- --- --- --- --- --- --- --- --- --*
PPFK010  EQU   *
         MVC   CMDBUF,BPFKSAVE+6     RESTORE LAST COMMAND ENTERED
         XR    R15,R15               RETURN CODE 0
         BR    R14                   RETURN
         SPACE 2
*-- --- --- --- --- --- --- --- --- --- --- --- --- --- --- --- --- --*
*        PROCESS DISPLAY-LAST-COMMAND KEY (PF1 OR PF13)               *
*-- --- --- --- --- --- --- --- --- --- --- --- --- --- --- --- --- --*
PPFK020  EQU   *
         MVI   TPUTBUFF,X'27'        ESCAPE CHARACTER
         MVI   TPUTBUFF+1,X'F1'      COMMAND CODE : WRITE
         MVI   TPUTBUFF+2,X'C5'      WCC : NO ALARM, KEYBOARD RESTORE
         MVI   TPUTBUFF+3,X'11'      ORDER : SBA
         MVC   TPUTBUFF+4(2),BPFKSAVE+4      TEXT POSITION
         MVI   TPUTBUFF+6,X'1D'      ORDER : SF
         MVI   TPUTBUFF+7,X'C1'      ATTRIBUTE : NON-PROTECT, NON-HIGH-
*                                       LIGHT, MODIFIED
         MVI   TPUTBUFF+8,C' '
         LA    R14,9                 LENGTH FOR TPUT IF NO DATA
         LA    R3,TPUTBUFF+9         PTR TO NEXT SBA-ORDER FOR SET CURS
         L     R15,TGETLENG          LENGTH OF PREVIOUS TGET
         S     R15,=F'7'             Q. LENGTH OF DATA ENTERED - 1= 0?
         BM    PPFK025               A. YES
         EX    R15,MVCDATA           A. NO - MOVE DATA
         LA    R14,0(R14,R15)        NEW LENGTH FOR TPUT
         LA    R3,0(R3,R15)
         SPACE 2
PPFK025  EQU   *
         MVI   0(R3),X'11'           ORDER : SBA
         MVC   1(2,R3),BPFKSAVE+1    CURSOR POSITION
         MVI   3(R3),X'13'           ORDER : IC
         LA    R14,4(R14)            NEW LENGTH OR TPUT
         TPUT  TPUTBUFF,(14),FULLSCR WRITE LAST COMMAND ONTO SCREEN
         LA    R15,4                 RETURN CODE 4
         L     R14,PPFK001-8         RESTORE RETURN REGISTER
         BR    R14                   RETURN
         SPACE 2
MVCDATA  MVC   TPUTBUFF+8(1),BPFKSAVE+6
         SPACE 2
*-- --- --- --- --- --- --- --- --- --- --- --- --- --- --- --- --- --*
*        PROCESS DISPLAY PFKEY ASSIGNEMENT (PF2 OR PF14)              *
*-- --- --- --- --- --- --- --- --- --- --- --- --- --- --- --- --- --*
PPFK040  EQU   *
         LA    R3,2                  2 * 8 KEYS TO BE PROCESSED
         LA    R5,PFKBUFF1           PTR TO PLACE FIRST PFKEY DEF IN
         L     R6,PFKDPTR            PTR TO PFK VALUES
         SPACE 2
PPFK045  EQU   *
         LA    R6,4*80(R6)           PFKEYS 1-4 AND 13-16 SPECIAL USE
         LA    R4,8                  PROCESS 8 PFKEYS
         SPACE 2
PPFK050  EQU   *
         MVC   0(72,R5),0(R6)        MOVE TEXT INTO OUTPUT-BUFFER
         LA    R6,80(R6)             PTR TO NEXT PFKEY DEFINITION
         LA    R5,82(R5)             PTR TO NEXT FIELD IN OUTPUT-BUFFER
         BCT   R4,PPFK050            PROCESS NEXT PFKEY
         BCT   R3,PPFK045            PROCESS NEXT SERIES OF PFKEYS
         SPACE 2
         TPUT  PFKBUFF,PFKBUFFL,FULLSCR
         TGET  CMDBUFP,83,ASIS
         SPACE 2
         LA    R15,8                 RETURN CODE 8
         LM    R0,R14,PPFK001-64     RESTORE REGISTER
         BR    R14                   RETURN
         EJECT
*-- --- --- --- --- --- --- --- --- --- --- --- --- --- --- --- --- --*
*                                                                     *
*        SUBROUTINE TO ASSIGN COMMANDS TO PF-KEYS                     *
*                                                                     *
*        THIS ROUTINE DYNALLOCS A MEMBER OF A PARTITIONED DATASET     *
*        (THE DSNAME IS CONTAINED IN 'DYNDSN'). THE MEMBER NAME IS THE*
*        TSO-USERS JOBNAME. 24 LINES ARE READ FORM THIS MEMBER, EACH  *
*        LINE MAY CONTAIN A SPECIFIC COMMAND IN COLUMNS 1 - 72.       *
*        THE COMMAND TEXT IS ASSIGNED TO THE CORRESPONDING PF-KEY     *
*        EXCEPT PFKEYS 1,2,3,4,13,14,15 AND 16, WHICH HAVE SPECIAL    *
*        FUNCTIONS ASSIGNED.                                          *
*        LINE 5 IS ASSIGNED TO PF-KEY 5, LINE 6 IS ASSIGNED TO PF-KEY *
*        6, AND SO ON.                                                *
*        THE ASSIGNED COMMANDS ARE EXECUTED THROUGH PRESSING THE      *
*        CORRESPONDING PF-KEY.                                        *
*        IF AN ERROR IS DETECTED, NO PF-KEYS ARE ASSIGNED, AND NO     *
*        PF-KEYS MAY BE USED.                                         *
*                                                                     *
*                                                                     *
*        REGISTER USAGE :                                             *
*                                                                     *
*        <R14>   BAL-REGISTER                                         *
*                                                                     *
*                                                                     *
*-- --- --- --- --- --- --- --- --- --- --- --- --- --- --- --- --- --*
         SPACE 2
         DS    16F                   REGISTER SAVE AREA
APFK001  EQU   *
         STM   R0,R15,APFK001-64     SAVE REGISTER
         SPACE 2
*-- --- --- --- --- --- --- --- --- --- --- --- --- --- --- --- --- --*
*        GETMAIN FOR INTERNAL PF-KEY-DEFINITION-BUFFER                *
*-- --- --- --- --- --- --- --- --- --- --- --- --- --- --- --- --- --*
         GETMAIN R,LV=24*80
         ST    R1,PFKDPTR
         LR    R0,R1
         LA    R1,24*80
         XR    R14,R14
         LA    R15,1
         SLL   R15,30                SHIFT TO X'40' IN HIGH-ORDER-BYTE
         MVCL  R0,R14                CLEAR BUFFER
         SPACE 2
*-- --- --- --- --- --- --- --- --- --- --- --- --- --- --- --- --- --*
*        DYNALLOC PARTITIONED DATASET                                 *
*-- --- --- --- --- --- --- --- --- --- --- --- --- --- --- --- --- --*
         L     R3,CVTPTR             PTR TO CVT
         USING CVT,R3
         L     R3,CVTTCBP            PTR TO TCBWORDS
         DROP  R3
         L     R3,4(R3)              PTR TO TCB
         L     R3,12(R3)             PTR TO TIOT
         MVC   DYNMEMB+1(7),0(R3)    TSO USER'S JOBNAME
         LA    R1,PDYNRB             PTR TO PTR TO RB
         DYNALLOC
         LTR   R15,R15               Q. DYNALLOC DONE ?
         BNZ   APFK950               A. NO
         SPACE 2
*-- --- --- --- --- --- --- --- --- --- --- --- --- --- --- --- --- --*
*        BUILD BPAM-DCB AND OPEN IT                                   *
*-- --- --- --- --- --- --- --- --- --- --- --- --- --- --- --- --- --*
         LA    R3,PFKDCBPO
         USING IHADCB,R3
         MVC   DCBDDNAM,DYNDDN       MOVE RETRIEVED DDNAM
         OPEN  ((3),INPUT)
         TM    DCBOFLGS,DCBOFOPN     Q. SUCCESSFULL OPENED ?
         BZ    APFK950               A. NO
         SPACE 2
*-- --- --- --- --- --- --- --- --- --- --- --- --- --- --- --- --- --*
*        SEARCH  MEMBERNAME                                           *
*-- --- --- --- --- --- --- --- --- --- --- --- --- --- --- --- --- --*
         FIND  PFKDCBPO,DYNMEMB,D
         LTR   R15,R15               Q. MEMBER FOUND ?
         BNZ   APFK900               A. NO
         SPACE 2
*-- --- --- --- --- --- --- --- --- --- --- --- --- --- --- --- --- --*
*        DYNALLOC MEMBER OF PARTITIONED DATASET                       *
*-- --- --- --- --- --- --- --- --- --- --- --- --- --- --- --- --- --*
         NI    DYNTXTP3,X'FF'-128    RESET END-OF-LIST INDICATOR
         LA    R1,PDYNRB             PTR TO PTR TO RB
         DYNALLOC
         LTR   R15,R15               Q. DYNALLOC DONE ?
         BNZ   APFK900               A. NO
*-- --- --- --- --- --- --- --- --- --- --- --- --- --- --- --- --- --*
*        BUILD DCB AND OPEN IT                                        *
*-- --- --- --- --- --- --- --- --- --- --- --- --- --- --- --- --- --*
         LA    R3,PFKDCBPS
         USING IHADCB,R3
         MVC   DCBDDNAM,DYNDDN        MOVE RETRIEVED DDNAME
         OPEN  ((3),INPUT)
         TM    DCBOFLGS,DCBOFOPN      Q. SUCCESSFULL OPENED ?
         BZ    APFK900                A. NO
         DROP  R3
         SPACE 2
*-- --- --- --- --- --- --- --- --- --- --- --- --- --- --- --- --- --*
*        READ 24 RECORDS AND PUT INTO PFKEY-DEFINITION-BUFFER         *
*-- --- --- --- --- --- --- --- --- --- --- --- --- --- --- --- --- --*
         L     R3,PFKDPTR             PTR TO PFKEY-DEFINITION-BUFFER
         LA    R4,24
APFK010  EQU   *
         GET   PFKDCBPS
         OI    IPFK,X'80'             INDICATE PFKEYS ASSIGNED
         MVC   0(72,R3),0(R1)         MOVE COMMAND TEXT
         LA    R3,80(R3)              PTR TO NEXT ENTRY
         BCT   R4,APFK010             LOOP AGAIN
         SPACE 2
*-- --- --- --- --- --- --- --- --- --- --- --- --- --- --- --- --- --*
*        CLOSE DATASET AND FREE IT AFTER 24 RECORDS OR AT EOF         *
*-- --- --- --- --- --- --- --- --- --- --- --- --- --- --- --- --- --*
APFK020  EQU   *
         CLOSE PFKDCBPS
         FREEPOOL PFKDCBPS
         SPACE 2
*-- --- --- --- --- --- --- --- --- --- --- --- --- --- --- --- --- --*
*        CLOSE BPAM DCB                                               *
*-- --- --- --- --- --- --- --- --- --- --- --- --- --- --- --- --- --*
APFK900  EQU   *
         CLOSE (PFKDCBPO,)
         SPACE 2
*-- --- --- --- --- --- --- --- --- --- --- --- --- --- --- --- --- --*
*        RETURN                                                       *
*-- --- --- --- --- --- --- --- --- --- --- --- --- --- --- --- --- --*
APFK950  EQU   *
         LM    R0,R15,APFK001-64      RESTORE REGISTER
         BR    R14
         EJECT
*-- --- --- --- --- --- --- --- --- --- --- --- --- --- --- --- --- --*
*        DYNALLOC REQUEST BLOCK                                       *
*-- --- --- --- --- --- --- --- --- --- --- --- --- --- --- --- --- --*
         SPACE
PDYNRB   DC    AL1(128),AL3(DYNRB)
DYNRB    DC    AL1(20,1),AL2(0,0,0)
         DC    A(DYNTXTP0)
         DC    A(0,0)
DYNTXTP0 DC    A(DYNRTDDN)
         DC    A(DYNDSN)
         DC    A(DYNDISP)
DYNTXTP3 DC    AL1(128),AL3(DYNFREE)
         DC    AL1(128),AL3(DYNMEMBR)
DYNRTDDN DC    AL2(DALRTDDN,1,8)
DYNDDN   DC    CL8' '
DYNDSN   DC    AL2(DALDSNAM,1,44)
         DC    CL44'SYS1.XHELP'
DYNMEMBR DC    AL2(DALMEMBR,1,8)
DYNMEMB  DC    CL8'@'
DYNDISP  DC    AL2(DALSTATS,1,1),X'08'
DYNFREE  DC    AL2(DALCLOSE,0)
         EJECT
*-- --- --- --- --- --- --- --- --- --- --- --- --- --- --- --- --- --*
*        DCB                                                          *
*-- --- --- --- --- --- --- --- --- --- --- --- --- --- --- --- --- --*
PFKDCBPS DCB   DSORG=PS,MACRF=GL,EODAD=APFK020
         EJECT
PFKDCBPO DCB   DSORG=PO,MACRF=R
         EJECT
         DS    0D
TGETLENG DS    F
TPUTBUFF DS    CL92
TIME     DC    C'00000200'
XUCMID   DC    X'00'
BLANKS   DC    CL80' '
CMND     DC    H'84',X'4000'
CMNDBUF  DC    CL80' '
CMDBUFP  DC    CL6' '
CMDBUF   DC    CL80' '
         DC    F'0'
WTOX     DS    0F
         DC    H'105',X'4000'
CMDID    DC    CL21'COMMAND BY 12345678: '
WTOBUF   DC    CL80' '
ERRMSG1  DC    C' XXX IS NOT AN ACTIV CONSOLE'
LERRMSG1 EQU   *-ERRMSG1
ERRMSG11 DC    C' INVALID SCREEN SIZE'                     ****16.12.81
LERRMG11 EQU   *-ERRMSG11                                  ****16.12.81
BPFKSAVE DS    CL86              SAVED LAST ISSUED COMMAND
NPFK     DS    AL1               SAVED PFKEY # OF LAST INPUT
IPFK     DS    XL1               X'80' INDICATES PFKEYS ASSIGNED
TABAID   DC    AL1(0,13,14,15,16,17,18,19,20,21,22,23,24,0,0,0)
         DC    16AL1(0)
         DC    14AL1(0),AL1(26,0)
         DC    AL1(0,1,2,3,4,5,6,7,8,9,10,11,12,0,0,0)
PFKDPTR  DS    A                 PTR TO INTERNAL PFKEY DEFINITION TABLE
TRTTAB1  DC    256XL1'00'
         ORG   TRTTAB1+C'_'
         DC    XL1'FF'
         ORG
TABSBA   DC    CL16' ABCDEFGHIÖ.<(+×'
         DC    CL16'&&JKLMNOPQR!$*);^'
         DC    CL16'-/STUVWXYZ|,%_>?'
         DC    CL16'0123456789:#@''="'
PFKBUFF  DC    X'C51140403C40400011404013'
         DC    X'1DE8',19CL1'-',C'  OPERATOR COMMANDS ASSIGNED TO PFKEY*
               S  ',20CL1'-'
         DC    X'1DE8',CL79' '
         DC    X'1DE8',C' PF5  ',X'1D60'
PFKBUFF1 DC    CL72' '
         DC    X'1DE8',C' PF6  ',X'1D60',CL72' '
         DC    X'1DE8',C' PF7  ',X'1D60',CL72' '
         DC    X'1DE8',C' PF8  ',X'1D60',CL72' '
         DC    X'1DE8',C' PF9  ',X'1D60',CL72' '
         DC    X'1DE8',C' PF10 ',X'1D60',CL72' '
         DC    X'1DE8',C' PF11 ',X'1D60',CL72' '
         DC    X'1DE8',C' PF12 ',X'1D60',CL72' '
         DC    X'1DE8',C' PF17 ',X'1D60',CL72' '
         DC    X'1DE8',C' PF18 ',X'1D60',CL72' '
         DC    X'1DE8',C' PF19 ',X'1D60',CL72' '
         DC    X'1DE8',C' PF20 ',X'1D60',CL72' '
         DC    X'1DE8',C' PF21 ',X'1D60',CL72' '
         DC    X'1DE8',C' PF22 ',X'1D60',CL72' '
         DC    X'1DE8',C' PF23 ',X'1D60',CL72' '
         DC    X'1DE8',C' PF24 ',X'1D60',CL72' '
         DC    X'1DE8',CL79' '
         DC    X'1DE8',CL79' SPECIAL FUNCTIONS ARE ASSIGNED TO '
         DC    X'1DE8',CL79'    PF1 / PF13    RESHOW LAST COMMAND ISSUE*
               D'
         DC    X'1DE8',CL79'    PF2 / PF14    DISPLAY PF-KEY USAGE'
         DC    X'1DE8',CL79'    PF3 / PF15    TERMINATE'
         DC    X'1DE8',CL79'    PF4 / PF16    REPEAT EXECUTION OF LAST *
               COMMAND ENTERED'
PFKBUFFL EQU   *-PFKBUFF
         LTORG
         TITLE  'SRB ROUTINE'
         DS    0D
CODEA    EQU   *
         DROP  R12,R2,R7
         USING *,R15
         USING SRBSECT,R1
         LR    R1,R0
         STM   R0,R15,SAVESRB
         DROP  R1,R15
         LR    R2,R1
         USING CODEA,R12
         USING SRBSECT,R2
         LR    R12,R15
         SPACE 2
         L     R1,16
         L     R1,100(R1)
         USING UCM,R1
         LM    R3,R5,UCMVEA
DID0     EQU   *
         USING UCMLIST,R3
         L     R1,UCMUCB           DEBUGGING
         CLI   SRBCONAD,64             IF SPECIFIC REQUEST
         BNE   SPEC
         TM    UCMDISP1,UCMDISPA   MASTER-CONSOLE?
         BNO   DID1    NO,CHECK NEXT
         B     DID00
SPEC     CLC   SRBCONAD,13(R1)   IS IT THE REQUESTED CONSOLE ?
         BNE   DID1                NO - SEARCH FOR NEXT
DID00    EQU   *
         MVC   SRBCONAD,13(R1)   MOVE UNITADDRESS
         MVC   UNITXXX(3),SRBCONAD MOVE UNITADDRESS
         TM    UCMATR,UCMUF        IS IT ACTIVE ?
         BZ    DID1                NO - UNUSEABLE
         L     R10,UCMXB           IS IT GRAPHICS ?
         LTR   R10,R10
         BZ    DID1                NO - USELESS
         L     R6,0(R10)           FIND  THE PAGEABLE DCM (TDCM)
         LTR   R6,R6               DOES IT EXIST ?
         BZ    DID1                NO - UNUSEABLE
         CLI   X'131'(R6),X'10'    IS IS A 3277 ?
         MVC   SRBCONID,UCMID        SAVE THIS
         BE    GOTONE              OKAY GO ON
DID1     EQU   *
         BXLE  R3,R4,DID0          GET THE NEXT ENTRY
         LA    R10,1
         SLL   R10,24
         B     ERRPOST
   SPACE 2
*
* A CONSOLE HAS BEEN FOUND COPY THE SCREEN AND DISPLAY IT FOR THE USER
*        R3 ->  UCME
*        R10 -> RDCM
*        R6 ->  TDCM
*
GOTONE   EQU   *
         LH    R1,X'FE'(R6)        NUMBER  OF LINES IN MSG AREA
         LR    R14,R1
         CLM   R1,1,SRBLINE        SMALLER SCREEN ?
         BNH   OKSCR
         SR    R1,R1
         IC    R1,SRBLINE          GET MAX NO LINES
         LR    R14,R1 MAX NO. OF LINES
         BCTR  R1,0
         BCTR  R1,0
         BCTR  R1,0
         LTR   R1,R1                                       ****16.12.81
         BNP   ERRPOST1                                    ****16.12.81
OKSCR    EQU   *
         L     R7,X'30'(R6)        POINT TO  THE  FIRST INPUT LINE
         LA    R8,BUFF             OUTPUT LINE
GOT1     EQU   *
         MVC   2(79,R8),0(R7)      MOVE A LINE
         TR    2(79,R8),BLANKTAB   GET IT READABLE
         CLI   5(R8),C'*'    ************* MVS-SE2 SUPPORT ************
         BE    NOSTAR1
         CLI   5(R8),C'@'    ************* MVS-SE2 SUPPORT ************
         BNE   NOSTAR
NOSTAR1  MVC   0(2,R8),=X'1DE8'    HIGH INTENSITY
NOSTAR   EQU   *
         LA    R8,81(,R8)          OUR SIZE
         LA    R7,84(,R7)          THEIRS
         BCT   R1,GOT1             GET EM ALL
         L     R1,X'3C'(R6)
         CLC   X'FE'(2,R6),=X'0014'
         BE    NOPFK
         LA    R8,81(,R8)          SKIP PFK LINE
NOPFK    MVC   0(2,R8),=X'1D60'
         MVC   3(L'ENTRMSG,R8),ENTRMSG
         LA    R8,(1*81)(,R8)      SKIP INPUT LINE
         MVC   0(2,R8),=X'1DE8'    HIGH INTENSITY
         MVC   3(MODELEN,R8),MODEMSG
         LA    R8,(1*81)(,R8)      SKIP INPUT LINE
         MVC   0(2,R8),=X'1DE8'    HIGH INTENSITY
         MVC   2(4,R8),=X'401DC113' CURSOR POSITION
         LA    R8,85(R8)
         MVC   0(LLMSG,R8),LMSG
         LA    R14,87(R8)
         LA    R1,BUFF
         SR    R14,R1
         ST    R14,SRBBUFL         TPUT AND TGET
         SPACE 2
         SR    R10,R10
ERRPOST  EQU   *
         SETLOCK OBTAIN,TYPE=LOCAL,MODE=UNCOND,REGS=USE,RELATED=(X)
         LA    R11,SRBECB
         LA    R0,128
         SLL   R0,24
         OR    R11,R0
         LR    R8,R2
         L     R13,SRBMYAS
         L     R15,16
         L     R15,X'98'(R15)
         BALR  R14,R15
         LR    R2,R8
         SPACE 2
    SETLOCK RELEASE,TYPE=LOCAL,REGS=USE,RELATED=(X)
         LM    R0,R15,SAVESRB
         BR    R14
ERRPOST1 EQU   *                                           ****16.12.81
         LA    R10,2                                       ****16.12.81
         SLL   R10,24                                      ****16.12.81
         B     ERRPOST                                     ****16.12.81
         LTORG
         DROP  R2,R12
BLANKTAB DC    CL256' '
         ORG   BLANKTAB+C'Ö'
         DC    C'Ö.<(+×',X'50'
         ORG   BLANKTAB+C'!'
         DC    C'!$*);^-/'
         ORG   BLANKTAB+C','
         DC    C',%_>?'
         ORG   BLANKTAB+C':'
         DC    C':#@''="'
         ORG   BLANKTAB+X'81'      TRANSLATE LOWER CASE TO UPPER
         DC    C'ABCDEFGHI'
         ORG   BLANKTAB+X'91'      ...
         DC    C'JKLMNOPQR'
         ORG   BLANKTAB+X'A2'      ...
         DC    C'STUVWXYZ '
         ORG   BLANKTAB+C'A'
         DC    C'ABCDEFGHI'
         ORG   BLANKTAB+C'J'
         DC    C'JKLMNOPQR'
         ORG   BLANKTAB+C'S'
         DC    C'STUVWXYZ '
         ORG   BLANKTAB+C'0'
         DC    C'0123456789'
         ORG
MODEMSG  DC    C'IEE163I MODE= TSO ('
UNITXXX  DC    CL5'   ) '
MODELEN  EQU   *-MODEMSG
ENTRMSG  DC    C'IEE152I     ENTER     CANCEL     D C,K         '
LMSG     DC    X'1DE8'
         DC    C'PF1/13 RESHOW, PF2/14 DISPLAY PFK USAGE, PF3/15 END, P*
               F4/16 REPEAT COMMAND'
LLMSG    EQU   *-LMSG
CODEE    EQU   *
         TITLE  'DUMMY SECTIONS'
         IHASRB
SAVESRB  DC    16F'0'
SRBECB   DC    F'0'
SRBMYAS  DC    F'0'
SRBCONID DC    X'00'
SRBCONAD DC    AL3(0)
SRBBUFL  DC    F'0'
SRBLINE  DC    X'00'
SRBSIZ   EQU   *-SRBSECT
         DC    XL23'00'
         DS    0D
SRBCODE  DS    CL(CODEE-CODEA)
CLEAR    DS    CL11
BUFF     DS    44CL81' '
ENTR     EQU   BUFF+(81*42)
LSCREEN  EQU   *-CLEAR
ENTRICR  EQU   BUFF+(81*23+4)                                    ICR1
ESRB     EQU   *
         SPACE 5
WORK     DSECT
SAVE     DS    18F
SVCSAVE  DS    2F
WORKL    EQU   *-WORK
         EJECT
         IHAPSA
         EJECT
         IHAASCB
         EJECT
         CVT   DSECT=YES
         EJECT
         IEECUCM FORMAT=NEW
         EJECT
         IEFZB4D2
         EJECT
         PRINT NOGEN
         DCBD  DSORG=PS
         EJECT
         END
./ ADD NAME=PDS
PDS      TITLE 'P D S      --        PDS COMMAND PROCESSOR  (10/25/82)'
*   DATA SET PDS AT LEVEL 5 AS OF  7/08/82  (ABL -- MEMBER GROUPS)    *
*   DATA SET PDS AT LEVEL 4 AS OF  9/30/80  (ABL -- MVS ONLY VERSION) *
*   DATA SET PDS AT LEVEL 3 AS OF  1/28/80  (ABL -- MVS VERSION)      *
*   DATA SET PDS AT LEVEL 2 AS OF 11/14/77  (ABL -- MVT VERSION)      *
*   DATA SET PDS AT LEVEL 1 AS OF  6/12/75  (UCLA VERSION)            *
*   DATA SET PDS AT LEVEL 0 AS OF  3/20/72  (FIREMAN FUND VERSION)    *
*                                                                     *
*                                                                     *
***                                                                   *
*** BEFORE ASSEMBLING, READ THE FOLLOWING TWO NOTES EXPLAINING THE    *
*** VALUES WHICH MAY BE CODED FOR THE SYSPARM VALUE (XXXX,YYY BELOW). *
***                                                                   *
*** TO ASSEMBLE:  ASM  PDS RENT LIB('SYS1.AMODGEN') SYSPARM(XXXX,YYY) *
***                                                                   *
*** TO LINK:      LINK PDS RENT REUS REFR LOAD(LIBNAME(PDS)) PR(*)    *
*                                                                     *
*                                                                     *
* NOTE 1: PDS'S DEFAULT ALLOCATION FOR PARTITIONED DATA SETS IS       *
*         DISP=SHR.  SINCE THIS PROGRAM CAN ALTER THE DIRECTORY WITH  *
*         SEVERAL OF ITS SUBCOMMANDS (ATTRIB WITH ATTRIBUTE UPDATES,  *
*         ALIAS, DELETE, RENAME AND RESTORE), THIS COULD POTENTIALLY  *
*         CAUSE INTEGRITY PROBLEMS; CONSEQUENTLY, A MODIFICATION TO   *
*         AUTOMATICALLY REALLOCATE THIS PROGRAM'S DATA SETS WITH      *
*         DISP=OLD AFTER ONE OF THE ABOVE SUBCOMMANDS HAS BEEN ADDED. *
*                                                                     *
*   A SYSPARM ASSEMBLY OPTION CONTROLS THIS FEATURE:                  *
*                                                                     *
*           A.  FOR SYSPARM(SHR), THE DATA SET WILL NOT BE            *
*               AUTOMATICALLY REALLOCATED WITH DISP=OLD FOR ANY USER. *
*                                                                     *
*           B.  FOR SYSPARM(OPER) OR IF NO SYSPARM OPERAND IS CODED,  *
*               THE DATA SET WILL BE AUTOMATICALLY REALLOCATED WITH   *
*               DISP=OLD AFTER ONE OF THE ABOVE SUBCOMMANDS FOR USERS *
*               WHO DO NOT HAVE "OPER" CAPABILITY.                    *
*                                                                     *
*           C.  FOR SYSPARM(OLD), THE DATA SET WILL BE AUTOMATICALLY  *
*               REALLOCATED WITH DISP=OLD AFTER ONE OF THE ABOVE      *
*               SUBCOMMANDS FOR ALL USERS.                            *
*                                                                     *
*                                                                     *
*                                                                     *
* NOTE 2: THE PDS COMMAND HAS AN OPTIONAL INTERFACE TO SPF EDIT AND   *
*         BROWSE WHICH IS ALSO CONTROLLED BY SYSPARM AS FOLLOWS:      *
*                                                                     *
*           A.  FOR SYSPARM(XXXX,SPF) OR SYSPARM(XXXX) WHERE XXXX     *
*               IS SHR, OPER OR OLD AS DESCRIBED ABOVE, THE PDS       *
*               INTERFACE TO SPF WILL BE GENERATED.                   *
*                                                                     *
*           B.  FOR SYSPARM(XXXX,NOSPF) WHERE XXXX IS SHR, OPER OR    *
*               OLD AS DESCRIBED ABOVE, THE PDS INTERFACE TO SPF      *
*               WILL NOT BE GENERATED.                                *
*                                                                     *
* NOTE 3: ADDITIONAL INSTALLATION CONSIDERATIONS ARE ON THE NEXT PAGE.*
         EJECT
*  THE SPF INTERFACE CONSISTS OF TWO PDS SUBCOMMANDS, SPFEDIT AND     *
*  BROWSE, WHICH REQUEST SPF EDIT AND BROWSE SERVICE FROM THE PDS     *
*  COMMAND.  ON THE FIRST SPFEDIT OR BROWSE SUBCOMMAND, SPF IS        *
*  INVOKED AND SPF RECURSIVELY CALLS THE PDS COMMAND AS A DIALOG.     *
*                                                                     *
*  SUBSEQUENT USES OF SPFEDIT OR BROWSE SUBCOMMANDS ENTER SPF EDIT    *
*  OR BROWSE SERVICE DIRECTLY.  THE INTERFACE TO SPF REMAINS ACTIVE   *
*  UNTIL THE PDS COMMAND IS TERMINATED.                               *
*                                                                     *
*  NOTE THAT SPFEDIT AND BROWSE SUBCOMMANDS CAN NOT BE USED WHILE     *
*  PROCESSING UNDER SPF OPTION 6 SINCE SPF IS LINKED TO FROM THE      *
*  PDS COMMAND AS A TSO COMMAND PROCESSOR.                            *
*                                                                     *
*  THE INTERFACE CODE HAS BEEN SUCCESSFULLY USED AT INSTALLATIONS     *
*  WITH SPF VERSION 01 MOD 00 (5668-009) AND ISPF (5668-960).         *
*                                                                     *
*                                                                     *
*  WHEN THE SPF INTERFACE IS ACTIVE, THE FOLLOWING SHOULD BE NOTED:   *
*                                                                     *
*    A.  ABEND DEBUGGING IN PDS OR AN EXTERNAL SUBCOMMAND IS MORE     *
*        DIFFICULT BECAUSE OF THE STAE PROCESSING PERFORMED BY SPF.   *
*                                                                     *
*    B.  WHEN AN SPFEDIT OR BROWSE SUBCOMMAND IS ENTERED, THREE       *
*        ASTERISKS USUALLY APPEAR JUST BELOW THE ENTERED SUBCOMMAND;  *
*        THIS IS VTAM'S PAGE PROTECTION -- A NULL LINE MUST BE        *
*        ENTERED TO GET THE FIRST BROWSE OR EDIT SCREEN DISPLAYED.    *
*                                                                     *
*    C.  IF ANY SPF EDIT OR BROWSE SUBCOMMAND IS TERMINATED BY ANY    *
*        OPTION REQUEST (=1, =2, ...) AND THE RETURN KEY, THE PDS END *
*        SUBCOMMAND WILL RESULT IN A GARBAGE OUTPUT LOOP.  NOTE THAT  *
*        AN ATTENTION WILL TERMINATE THIS LOOP AND THE PDS COMMAND.   *
*        THIS IS NOT A PROBLEM WITH THE NEW ISPF VERSION OF SPF;      *
*        PTF UZ55246 ON 8206 FIXES THIS BUT IT ALSO HAS ERRORS (P.E.).*
*                                                                     *
*    D.  WHEN IN SPF EDIT OR BROWSE, A SPLIT SCREEN REQUEST MAY FAIL  *
*        WITH MESSAGE ISPD204 ("INVALID PARAMETER") AND AN ABEND 0000.*
*        IF THIS OCCURS IT MAY BE NECESSARY TO LOGOFF BEFORE SPLIT    *
*        SCREEN REQUESTS FROM SPF (REACHED THROUGH PDS) WILL WORK     *
*        AGAIN.  NO KNOWN FIXES EXIST FOR THIS PROBLEM YET; IT HAS    *
*        OCCURRED WITH THE PDS COMMAND EXECUTED FROM THE LINK PACK    *
*        AREA AND THE PDS COMMAND EXECUTED UNDER THE TEST COMMAND.    *
*                                                                     *
*                                                                     *
*** *** *** *** *** *** *** *** *** *** *** *** *** *** *** *** *** ***
*                                                                     *
* PLEASE REPORT ANY PROBLEMS, ENHANCEMENTS, SUGGESTIONS OR COMMENTS   *
* CONCERNING THE PDS COMMAND TO:                                      *
*                                                                     *
*     A. BRUCE LELAND           OR         A. BRUCE LELAND            *
*     HITACHI AMERICA, LTD.                6084 CRIMSON DRIVE         *
*     1800 BERING DRIVE                    SAN JOSE, CALIF 95120      *
*     SAN JOSE, CALIF. 95112                                          *
*     (408) 292-6404                       (408) 997-2366             *
*                                                                     *
*** *** *** *** *** *** *** *** *** *** *** *** *** *** *** *** *** ***
         EJECT
* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
*                                                                     *
* TITLE -      P D S    ----   TSO PDS COMMAND PROCESSOR              *
*                                                                     *
* FUNCTION -   PROVIDE A TSO USER WITH THE CAPABILITY                 *
*              TO MANIPULATE A PARTITIONED DATA SET                   *
*                                                                     *
* OPERATION -  ACCEPT FROM THE TSO USER THE NAME OF A                 *
*              PARTITIONED DATA SET NAME. AFTER ALLOCATING            *
*              THE DATA SET, PERFORM ANY OF THE SUBCOMMANDS:          *
*                                                                     *
*        ATTRIB   - DISPLAY (OR MODIFY) LOAD MODULE ATTRIBUTES        *
*        ALIAS    - ASSIGN AN ALIAS TO A MEMBER                       *
*        BROWSE   - BROWSE A MEMBER WITH SPF (SPF DIALOG)             *
*        CHANGE   - CHANGE TO A DIFFERENT PARTITIONED DATA SET        *
*        DISPLAY  - DISPLAY ALL OR PART OF THE DIRECTORY              *
*        DIRENTRY - DUMP A MEMBER'S DIRECTORY ENTRY                   *
*        DELETE   - DELETE A MEMBER                                   *
*        EDIT     - EDIT A MEMBER                                     *
*        END      - TERMINATE THE PDS COMMAND                         *
*        EXEC     - EXECUTE PDS SUBCOMMANDS FROM A CLIST SOURCE       *
*        FIND     - LIST LINES OF A MEMBER CONTAINING A SEARCH STRING *
*        HELP     - DISPLAY SUBCOMMAND HELP FOR PDS                   *
*        HISTORY  - LIST HISTORY OF A LOAD MODULE                     *
*        LIST     - LIST CONTENTS OF A MEMBER                         *
*        MAP      - MAP A LOAD MODULE                                 *
*        MEMBERS  - DISPLAY MEMBERS IN A GROUP                        *
*        OPTIONS  - DISPLAY THE SUBCOMMAND MENU                       *
*        PATTERN  - DISPLAY DIRECTORY BASED ON MEMBER NAME SEGMENTS   *
*        PDS      - CHANGE TO A DIFFERENT PARTITIONED DATA SET        *
*        PRINTOFF - PRINT A MEMBER WITH THE TSO PRINTOFF COMMAND      *
*        RENAME   - RENAME A MEMBER                                   *
*        RESTORE  - RESURRECT A PREVIOUSLY DELETED MEMBER             *
*        SMAP     - MAP A LOAD MODULE IN SHORT FORM                   *
*        SPFEDIT  - EDIT A MEMBER WITH SPF (SPF DIALOG)               *
*        SUBMIT   - SUBMIT A JCL MEMBER                               *
*        TSOLIST  - LIST A MEMBER WITH THE TSO LIST COMMAND           *
*        USAGE    - LIST DATA SET STATISTICS                          *
*                                                                     *
*                                                                     *
* INPUT      - STANDARD COMMAND PROCESSOR PARAMETER LIST              *
*                                                                     *
* OUTPUT     - NOT APPLICABLE.                                        *
*                                                                     *
* ATTRIBUTES - REENTRANT, REUSEABLE, REFRESHABLE.                     *
*                                                                     *
* WRITTEN    - IN 1972 AT FIREMAN'S FUND AMERICAN INSURANCE.          *
*                                                                     *
*                                                                     *
* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
         EJECT
* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
*                                                                     *
*  CHANGE SECTION:                                                    *
*                                                                     *
*    1.  VER 2: ADDED FORMATTING OPTIONS FOR LIST; ADDED SUBCOMMANDS  *
*        EDIT, FIND AND SUBMIT; AND REORGANIZED THE PDS PROGRAM.      *
*                                                                     *
*    2.  VER 2.2: CORRECTED AN ERROR IN LIST AND FIND FOR DATA SETS   *
*        WITH ASA OR MACHINE CARRIAGE CONTROLS AND ALLOWED THE USE    *
*        OF ALL SUBCOMMANDS BY ALL USERS.                             *
*                                                                     *
*    3.  VER 2.3: MADE SEVERAL IMPROVEMENTS AS SUGGESTED BY DINESH    *
*        DATTANI FROM PRUDENTIAL INSURANCE CO. OF AMERICA, TORONTO    *
*        A.  OUTPUT THE PROGRAM OPTION LIST IN SORTED ORDER.          *
*        B.  ADDED SEVERAL EDIT DESCRIPTIVE QUALIFIERS (BASIC, IPLI   *
*            AND VSBASIC) AS WELL AS INSTRUCTIONS FOR ADDING OTHERS.  *
*        C.  ADDED A LOCKING MECHANISM FOR ATTRIB (WITH CHANGED ATT-  *
*            RIBUTES), ALIAS, DELETE, RENAME AND RESTORE SUBCOMMANDS. *
*            WHEN ANY OF THE ABOVE SUBCOMMANDS ARE USED FOR THE FIRST *
*            TIME BY A USER WITHOUT "OPER" CAPABILITY, THE PDS IN USE *
*            IS CLOSED AND REALLOCATED WITH DISP=OLD.  NOTE THAT THE  *
*            REALLOCATION WILL FAIL IF ANOTHER USER HAS THE DATA SET  *
*            ALLOCATED.  THIS ALSO PROVIDES A SECURITY ENHANCEMENT    *
*            FOR INSTALLATIONS WITH PCF IN THAT USERS WHO HAVE ONLY   *
*            SHARED ACCESS TO DATA SETS CANNOT MODIFY THEM WITH THE   *
*            PDS COMMAND.                                             *
*                                                                     *
*                                                                     *
*    4.  VER 3: UPDATED THE PDS COMMAND FOR MVS USE -- GENERALLY TO   *
*        THE LEVEL OF THE MVS CBT VERSION (FILE 182 DATED 9/76)       *
*        A.  ADDED EXEC (EXPLICIT AND IMPLIED) AND HELP SUBCOMMANDS.  *
*        B.  A SINGLE SUBCOMMAND CHARACTER NAME CAN NO LONGER BE      *
*            CONSIDERED AMBIGUOUS (THE FIRST COMMAND TABLE MATCH      *
*            IS USED RATHER THAN OUTPUTTING A ERROR MESSAGE).         *
*        C.  SUPPORT WAS ADDED IN THE FOLLOWING AREAS:                *
*            -- SSI INFORMATION DISPLAY                               *
*            -- APF DATA CAN BE LISTED AND MODIFIED                   *
*            -- HEXADECIMAL MEMBER NAMES ALLOWED AS INPUT             *
*            -- HEXADECIMAL OUTPUT ADDED FOR DISPLAY AND PATTERN      *
*            -- $PUTGET, $PUTLINE AND MESSAGE MACROES WERE ADDED      *
*            -- ATTRIB LISTS ALL ALIASES FOR A GIVEN MODULE           *
*        D.  SEVERAL SOURCES OF 0C7'S WERE CORRECTED IN THE HANDLING  *
*            OF IDR DATA.                                             *
*        E.  THE CSECT STRUCTURE OF THIS PDS COMMAND WAS RETAINED     *
*            (NOT SEPARATE CSECTS AS IN THE CBT VERSION).             *
*        F.  THE MEMBER NAME VALIDITY CHECK ROUTINE HAD TWO BUGS:     *
*            --  THE MEMBER NAME LENGTH USED WAS THE INPUT NAME       *
*                LENGTH (INCORRECT FOR HEXADECIMAL NAMES).            *
*            --  IF A MEMBER NAME WAS CONSIDERED INVALID, THE NEXT    *
*                MEMBER NAME PASSED TO THE ROUTINE WAS NOT CONSIDERED *
*                A REPLACEMENT OF THE PREVIOUS INCORRECT MEMBER NAME. *
*        G.  THE ATTRIB SUBCOMMAND SOMETIMES LISTED SSI INFORMATION   *
*            FOR NON-LOAD MODULES WHICH DID NOT HAVE ANY SSI DATA.    *
*                                                                     *
*                                                                     *
         EJECT
*    5.  VER 3.1: SEVERAL GENERAL CHANGES WERE MADE                   *
*        A.  PDS HELP DATA SET REWORKED TO CURRENT PROGRAM LEVEL.     *
*        B.  SMAP AND PATTERN SUBCOMMANDS WERE ADDED.                 *
*        C.  DEFAULT MEMBER NAMES ARE ALLOWED FOR ATTRIB, BROWSE, MAP,*
*            DELETE, DIRENTRY, EDIT, FIND, HISTORY, LIST, MEMBERS,    *
*            PRINTOFF, SMAP, SPFEDIT, SUBMIT AND TSOLIST SUBCOMMANDS. *
*        D.  PDS WAS ADDED AS AN ALIAS FOR THE CHANGE SUBCOMMAND.     *
*        E.  LOAD AND DELETE LOGIC FOR TSO MODULES NOW REMOVED.       *
*        F.  ALIAS SUBCOMMAND IS NOT PREVENTED FROM WORKING IF THE    *
*            APF DATA LENGTH IS INVALID (APF=0 IS USED).              *
*                                                                     *
*    6.  DATA SET REALLOCATION CAN OCCUR FOR ANY OF THE FOLLOWING     *
*        REASONS:                                                     *
*        1.  CHANGE OR PDS SUBCOMMAND ENTERED BY THE USER.            *
*        2.  UPDATE LOCK FOR ALIAS, ATTRIB, DELETE, RENAME OR RESTORE *
*            AS IN ITEM 3.C, ABOVE).                                  *
*        3.  DISP=OLD ALLOCATION FAILURE -- REALLOCATION IS MADE      *
*            WITH DISP=SHR AGAIN AND THE SUBCOMMAND IS IGNORED.       *
*                                                                     *
*    7.  EDIT SUBCOMMAND WITH DEFAULT MEMBER NAME USED THE PREVIOUS   *
*        PDL.  NOW, THE PDL IS CLEARED BEFORE COMMAND SCAN.           *
*                                                                     *
*    8.  UNPRINTABLE MEMBER NAMES (FOR SUBCOMMANDS DISPLAY AND        *
*        PATTERN) NOW HAVE THEIR UNPRINTABLE CHARACTERS TRANSLATED    *
*        TO PERIODS (.) SO THAT THE REMAINDER OF THE NAME MAY BE      *
*        DISPLAYED.  NOTE THAT A HEXADECIMAL/CHARACTER DISPLAY OF     *
*        A MEMBER NAME IS FORCED (FOR THE DISPLAY AND PATTERN SUB-    *
*        COMMANDS) IF ANY UNPRINTABLE OR LOWER-CASE LETTERS ARE IN A  *
*        MEMBER NAME; ALSO, A 3270-TYPE DISPLAY TERMINAL IS ASSUMED.  *
*                                                                     *
*    9.  DISP=OLD REALLOCATION OF DATA SETS (AS IN 3.C ABOVE) HAS     *
*        BEEN MADE A PROGRAM GENERATION OPTION AS SUGGESTED BY        *
*        ARNIE CASINGHINO FROM CONNECTICUT BANK AND TRUST (CBT).      *
*                                                                     *
*   10.  VER 4: MADE SEVERAL IMPROVEMENTS AS SUGGESTED BY SEYMOUR     *
*        METZ FROM COMNET IN WASHINGTON, D.C.:                        *
*        1.  REPLACED IBM/360 INSTRUCTIONS WITH THEIR IBM/370         *
*            EQUIVALENTS (ICM, STCM, MVCL, ...)                       *
*        2.  REPLACED BCR INSTRUCTIONS WITH EQUIVALENT MNEMONICS.     *
*        3.  TSO SERVICE ROUTINE ADDRESSES ARE NOW OBTAINED FROM      *
*            THE CVT INSTEAD OF VIA LOAD/DELETE CODE.                 *
*                                                                     *
*   11.  VER 4.1: SEVERAL ADDITIONAL CHANGES WERE MADE TO TAKE        *
*        ADVANTAGE OF MVS PROGRAM LOGIC AND SERVICE ROUTINES:         *
*        1.  USED THE DAIRFAIL MESSAGE ROUTINE INSTEAD OF INTERNALLY  *
*            GENERATING MESSAGES (FIRST SUGGESTED BY S. METZ)         *
*        2.  USED THE GENERAL FAIL MESSAGE ROUTINE FOR PARSE ERRORS.  *
*        3.  USED THE TSO DEFAULT ROUTINE TO FULLY QUALIFY DSNAMES.   *
*        4.  CHANGED THE ALLOCATION STRATEGY TO "PERMANENTLY"         *
*            ALLOCATE DATA SETS.  THEN, WHEN AN EDIT IS PERFORMED     *
*            FOR A MEMBER BY THE PDS COMMAND, THE ALLOCATED DATA      *
*            SET WILL BE USED FOR EDIT.  THUS, AN UNCATALOGED DATA    *
*            SET MAY BE USED FOR EDIT (ONCE IT IS ALLOCATED BY THE    *
*            PDS COMMAND).  THIS CHANGE WAS FIRST SUGGESTED BY JOE    *
*            RAREY FROM MARTIN-MARRIETA IN FLORIDA.                   *
         EJECT
*   12.  VER 4.2:  AFTER THE DAIRFAIL CHANGES INDICATED ABOVE, THE    *
*            VOLUME PARAMETER FOR UNCATALOGED DATA SETS DID NOT WORK. *
*                                                                     *
*   13.  VER 4.3:  CORRECTED ONE SOURCE OF 0C4'S IN LISTING HISTORY   *
*            DATA AS REPORTED BY ARNIE CASINGHINO FROM CBT.           *
*                                                                     *
*   14.  VER 4.4:  ADDED THE RESTORE SUBCOMMAND AND CLEANED UP SOME   *
*            PDS CODE AS SUGGESTED BY S. METZ OF COMNET IN WASH D.C.  *
*            IN ADDITION, A SYSPARM ASSEMBLY PARAMETER WAS ADDED TO   *
*            PROVIDE MORE EASE IN GENERATING PDS.                     *
*                                                                     *
*   15.  VER 4.5:  ADDED THE FOLLOWING SUBCOMMANDS                    *
*                                                                     *
*            TSOLIST: A SUBCOMMAND TO LINK TO THE TSO LIST COMMAND    *
*            FOR A MEMBER SUGGESTED BY SEYMOUR METZ.                  *
*                                                                     *
*            PRINTOFF: A SUBCOMMAND TO LINK TO THE PRINTOFF COMMAND   *
*            FOR A MEMBER SUGGESTED BY DAVID FILSINGER OF FACSO (CB). *
*                                                                     *
*            DELETE:  NEW, PREFERRED ALIAS FOR THE SCRATCH SUBCOMMAND *
*                                                                     *
*   16.  VER 5.0:  ADDED ANOTHER BASE REGISTER AND MADE SEVERAL       *
*        SUBCOMMAND CHANGES:                                          *
*                                                                     *
*        ATTRIB, BROWSE, DELETE, DIRENTRY, EDIT, FIND, HISTORY, LIST, *
*        MAP, MEMBERS, PRINTOFF, SMAP, SPFEDIT, SUBMIT AND TSOLIST:   *
*          1.  ADDED THE * NOTATION (MEANS USE PREVIOUS MEMBER NAME)  *
*          2.  ADDED MEMBER NAME RANGES                               *
*          3.  ADDED MEMBER NAME PATTERNS                             *
*                                                                     *
*        BROWSE AND SPFEDIT: ADDED SUBCOMMANDS WHICH MAKE PDS A SPF   *
*        DIALOG SO IT CAN USE BROWSE AND EDIT SERVICE FOR A MEMBER.   *
*        HELP ON FULL SCREEN, SPF AND ISPF INTERFACES WAS PROVIDED    *
*        BY MIKE LOOS WITH DELUXE CHECK PRINTERS IN MINNESOTA.        *
*                                                                     *
*        ATTRIB:                                                      *
*          1.  FORMAT AND DISPLAY ANY SPF STATISTICS IN SPF FORMAT.   *
*          2.  DISPLAY ENTRY POINT ADDRESS, MODULE SIZE AND THE LAST  *
*              LINKAGE-EDIT DATE FOR LOAD MODULES.                    *
*          3.  FIXED A BUG: IF A MEMBER HAD MANY ALIASES, DATA        *
*              STORAGE WAS OVERLAID.                                  *
*          4.  ADDED PAGE ALIGNMENT DISPLAY AND CHANGE CAPABILITY.    *
*                                                                     *
*        ALIAS:                                                       *
*          1.  NOW WORKS FOR SCATTER LOADED MEMBERS                   *
*          2.  IF A MODULE IS CREATED BY THE OS/VS LINKAGE EDITOR     *
*              AND HAS SSI INFORMATION, THE ALIAS WILL ALSO.          *
*          3.  AN ALIAS CAN NOW BE ASSIGNED TO AN ALIAS MEMBER.       *
*          4.  FIXED A BUG: AN ASSIGNED ENTRY POINT OF ZERO           *
*              SOMETIMES DID NOT GET THE ENTRY POINT ZERO FLAG SET.   *
*                                                                     *
*        EDIT: ALLOWS EDITING OF NEW MEMBERS.                         *
*                                                                     *
*        RESTORE: NOW OPERATES ON LOAD MODULES;  ALSO, THE            *
*        RESURRECTED MEMBER IS NO LONGER ADDED AS AN ALIAS.           *
         EJECT
*        ATTRIB AND MAP: IF NO REAL MEMBER NAME CAN BE FOUND FOR AN   *
*        ALIAS IN A LOAD LIBRARY, THE NAME STORED IN THE DIRECTORY    *
*        ENTRY AS THE REAL ENTRY IS DISPLAYED.                        *
*                                                                     *
*        FIND: ADDED FIRST/NOFIRST KEYWORDS AND HEXADECIMAL STRINGS.  *
*                                                                     *
*        FIND AND LIST:                                               *
*          1.  ADDED SUPPORT FOR RECORD FORMAT U DATA SETS.           *
*          2.  ADDED SUPPORT FOR NON-PARTITIONED DATA SETS.           *
*          3.  ADDED MULTILINE, LINEDUMP, BLOCK AND DUMP FORMATS.     *
*          4.  ADDED SKIPREC, MAXIN, MAXOUT, SKIPCOL AND MAXLEN.      *
*          5.  NUM FORMAT CHECKS FOR DATA SAVED BY SPF EDIT.          *
*          6.  NUM FORMAT CHECKS FOR NUMERIC LINE NUMBERS AND         *
*              SWITCHES TO NONUM MODE FOR THE REMAINDER OF A          *
*              MEMBER IF AN INVALID LINE NUMBER IS ENCOUNTERED.       *
*                                                                     *
*        PATTERN AND DISPLAY:  UNPRINTABLE LETTERS ARE DISPLAYED AS   *
*        PERIODS (.) INSTEAD OF CENT SIGNS (Ö).  ALSO, HEXADECIMAL/   *
*        CHARACTER DISPLAYS ARE FORCED FOR ANY MEMBER NAME WHICH IS   *
*        NOT VALID.  NOTE: VALID MEMBER NAMES CONTAIN UPPER-CASE      *
*        ALPHANUMERIC CHARACTERS (WHICH INCLUDES #, $ AND @) AND THE  *
*        FIRST CHARACTER OF THE MEMBER NAME IS UPPER-CASE ALPHABETIC. *
*                                                                     *
*        CHANGE AND PDS:                                              *
*          1.  IF A DSNAME IS NOT ENTERED WITH THE SUBCOMMAND,        *
*              THE PREVIOUSLY USED DATA SET IS ASSUMED.               *
*          2.  ADDED THE SHR/OLD DATA SET DISPOSITION.                *
*                                                                     *
*        DIRENTRY: SUBCOMMAND WAS ADDED TO DUMP A DIRECTORY ENTRY.    *
*                                                                     *
*        MEMBERS: SUBCOMMAND WAS ADDED TO DISPLAY A MEMBER GROUP.     *
*                                                                     *
*        RESTORE, LIST, MAP, HISTORY AND ALIAS: FIXED A BUG; THE      *
*        NEWEXTENT SUBROUTINE ALLOWED THE USE OF ONE TOO MANY EXTENTS.*
*                                                                     *
*        UNDOCUMENTED SUBCOMMANDS:                                    *
*          1. ABEND (CAUSES PDS TO ABEND -- FOR DEBUGGING)            *
*          2. DSNAME (ALLOCATION STATUS OF THE CURRENT DATA SET)      *
*          3. KLEAR (OR K -- CLEARS 3270 DISPLAY SCREENS)             *
*          4. X (PCF EXIT CAPABILITY FOR INSTALLATIONS WITHOUT PCF)   *
*             SYNTAX: X TSOCOMMAND ANYOPERANDS MOREOPERANDS ...       *
*          5. W (DUMMY SUBCOMMAND FOR EXECUTING PDS UNDER TEST)       *
*                                                                     *
*   17.  VER 5.1:  MADE SOME CODE CLEANUP CHANGES;                    *
*                                                                     *
*        DELETED THE READ OF THE JFCB FOR THE INPUT DATA SET.         *
*                                                                     *
*        ALSO DELETED PDS STAE PROCESSING SINCE IT WAS NOT USED.      *
*                                                                     *
*        AN OBTAIN IS ALWAYS PERFORMED ONCE FOR EACH INPUT DATA       *
*        SET (NOT WHEN NEEDED AS BEFORE IN RESTORE AND USAGE).        *
*                                                                     *
*        EXCP'S ARE NOW ALL IN AN EXCP SUBROUTINE; SET AND READ       *
*        SECTORS ARE PERFORMED FOR ALL DISK DRIVES EXCEPT 2314'S.     *
*        THE EXCP SUBROUTINE REALLOCATES ITS INPUT BUFFER IF NEEDED.  *
         EJECT
*        ALL PDS BLDL'S ARE PERFORMED BEFORE INVOKING THE PROCESSING  *
*        SUBROUTINE.  IN ADDITION, PDS MAINTAINS THE STATUS OF THE    *
*        CURRENT BLDL SO THAT UNNECESSARY BLDL'S CAN BE AVOIDED.      *
*                                                                     *
*        ADDED A RESTORE SUBCOMMAND TEST FACILITY:  AN EXISTING       *
*        MEMBER MAY BE "RESTORED" IF THE RESTORE MEMBER NAME BEGINS   *
*        WITH "TEMP".  USE THE DIRENTRY SUBCOMMAND TO COMPARE THEIR   *
*        DIRECTORY ENTRIES -- REMEMBER TO DELETE THE TEMP MEMBER      *
*        SINCE YOU HAVE ALIASES WITH NO ALIAS BIT SET.                *
*                                                                     *
*        NOTE:  ATTRIB (WITH ATTRIBUTE UPDATES) AND RESTORE SUB-      *
*        COMMANDS CAUSE A NULL FILE TO BE WRITTEN TO THE END OF THE   *
*        DATA SET.  EVEN THOUGH THIS DOES NOT CAUSE ANY PARTICULAR    *
*        PROBLEMS (A COMPRESS WILL DELETE THESE FILES), EACH ONE DOES *
*        OCCUPY THE RECORD OVERHEAD LENGTH (135 BYTES ON A 3330).     *
*                                                                     *
*   18.  VER 5.2:  ADDED SUPPORT FOR TRACK OVERFLOW RECORDS AS WELL   *
*        AS THE FOLLOWING OTHER CHANGES:                              *
*                                                                     *
*        CHANGE AND PDS: IF A VOLUME NAME IS SUPPLIED, SYSALLDA IS    *
*        USED AS THE UNIT NAME; OTHERWISE, THE UNIT NAME FROM THE     *
*        PSCB WOULD BE USED (WHICH MIGHT NOT COVER THE VOLUME TO BE   *
*        ALLOCATED).  REPORTED BY BILL COWAN WITH THE COCA-COLA       *
*        COMPANY IN ATLANTA, GEORGIA.                                 *
*                                                                     *
*        DELETE: ALLOWS MEMBER GROUPS AND DEFAULT MEMBER NAMES AS     *
*        REQUESTED BY ARNIE CASINGHINO FROM CBT.                      *
*                                                                     *
*        ATTENTION HANDLING IMPROVEMENTS -- TWO ATTENTIONS IN A ROW   *
*        ARE GENERALLY REQUIRED TO TERMINATE PDS AND ALL SUBCOMMANDS  *
*        NOW RECOGNIZE ATTENTION INTERRUPTS TO SOME DEGREE:           *
*        A.  EXTERNAL PDS SUBCOMMANDS (BROWSE, EDIT, EXEC, HELP,      *
*            PRINTOFF, SPFEDIT, SUBMIT, TSOLIST AND X):               *
*            1.  THE FIRST ATTENTION IN THESE SUBCOMMANDS (EXCEPT     *
*                EDIT) WILL TERMINATE ANY MEMBER GROUP IN PROGRESS.   *
*            2.  ANOTHER ATTENTION IN THESE SUBCOMMANDS (EXCEPT BROWSE*
*                OR SPFEDIT) WILL TERMINATE PDS AND THE SUBCOMMAND.   *
*        B.  INTERNAL PDS SUBCOMMANDS:                                *
*            1.  AN ATTENTION AT A PROMPT FOR A DATA SET NAME WILL    *
*                TERMINATE PDS.                                       *
*            2.  ANY OTHER ATTENTION SHOULD RESULT IN THE "ENTER      *
*                OPTION" PROMPT WHERE A NEW SUBCOMMAND IS SOLICITED.  *
*        C.  PDS ATTENTION HANDLING IS DOCUMENTED (ENTER "HELP ATTN").*
*        D.  FIXED A BUG: A NULL RESPONSE TO "ENTER OPTION" AFTER AN  *
*            ATTENTION INTERRUPT ALLOWS THE SUBCOMMAND TO CONTINUE.   *
*        E.  THE INPUT ROUTINE NOW ALSO CHECKS FOR ATTENTION -- THIS  *
*            ELIMINATES WAITING UNTIL A MESSAGE IS OUTPUT AS BEFORE.  *
*                                                                     *
*        OPEN: FIXED ABEND 013-D0 FOR RECFM=FS OR FBS.  THIS PROBLEM  *
*        WAS REPORTED BY JAMES BERRY FROM WESTLAKE VILLAGE, CALIF.    *
*                                                                     *
*        ALIAS, RENAME AND RESTORE: CHANGE THE DEFAULT MEMBER NAME AS *
*        SUGGESTED BY JOHN SULLIVAN AT LOMA LINDA UNIVERSITY, CALIF.  *
*                                                                     *
* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
         EJECT
         MACRO
&NAME    CLEAR &FIELD
         LCLC  &L
&L       SETC  'L'''
&NAME    MVI   &FIELD,C' '
         MVC   &FIELD+1(&L&FIELD-1),&FIELD
         MEND
         SPACE 1
         MACRO
&NAME    ENTER &TYPE
         LCLC  &LABEL
&LABEL   SETC  'IHB'.'&SYSNDX'
         AIF   ('&TYPE' EQ 'VALCHECK').VALCK
         AIF   ('&TYPE' EQ 'ATTNEXIT').ATTN
         AIF   ('&TYPE' EQ '').MAIN
         MNOTE 8,'INVALID TYPE ''&TYPE'''
         MEXIT
.MAIN    ANOP
&NAME    CSECT
         SAVE  (14,12),,*
         LCLA  &R
&R       SETA  0
.EQU     ANOP
R&R      EQU   &R
&R       SETA  &R+1
         AIF   (&R LT 16).EQU
         LR    R8,R15
         USING &NAME,R8,R9,R10,R11,R12
         LA    R12,2048
         LA    R9,2048(R8,R12)
         LA    R10,2048(R9,R12)
         LA    R11,2048(R10,R12)
         LA    R12,2048(R11,R12)
         MEXIT
.VALCK   ANOP
&NAME    SAVE  (14,12)
         L     R7,4(,R1)          WORK AREA ADDRESS
         LM    R8,R12,BASES       RESTORE BASE REGISTERS
         L     R6,0(R1)           PDE ADDRESS
         LA    R15,VALSAVE
         AGO   .CHAIN
.ATTN    ANOP
&NAME    SAVE  (14,12)
         L     R7,8(,R1)
         LM    R8,R12,BASES
         LA    R15,ATTNSAVE
.CHAIN   ST    R13,4(,R15)
         ST    R15,8(,R13)
         LR    R13,R15
         SPACE 2
         MEND
         SPACE 6
         MACRO
&NAME    EXIT  &LV=
         AIF   ('&LV' EQ '').A0
&NAME    LR    R2,R13                         ADDR OF THIS SAVE AREA
         L     R13,4(,R13)
         AGO   .A1
.A0      ANOP
&NAME    L     R13,4(,R13)
.A1      STM   R15,R1,16(R13)                 RETURN REGS 15, 0, 1
         AIF   ('&LV' EQ '').A2 NOT DYNAMIC STORAGE
         FREEMAIN R,LV=&LV,A=(R2)
.A2      SPACE
         RETURN (14,12),T
         MEND
         SPACE 2
         MACRO
&NAME    MSG   &TEXT,&SHORT
         LCLA  &A
&A       SETA  K'&TEXT-2+4
         AIF   ('&SHORT' EQ 'S').SHORT
&NAME    DC    AL2(&A,0),C&TEXT              NORMAL MESSAGE
         MEXIT
.SHORT   ANOP
&NAME    DC    C'S',AL2(&A,0),C&TEXT         MESSAGE (NOT PARTITIONED)
         MEND
         SPACE 3
         MACRO $PUTGET -  OUTPUT A DATA LINE AND GET RESPONSE
&NAME   $PUTGET  &LINE,&ATTN=
         AIF   ('&LINE' EQ '(1)' OR '&LINE' EQ '(R1)').CALL
         AIF   ('&LINE'(1,1) EQ '(').R
&NAME    LA    R1,&LINE
         BAL   R14,$PUTGET
         AGO   .ATTN
.R       ANOP
&NAME    LR    R1,&LINE(1)
         BAL   R14,$PUTGET
         AGO   .ATTN
.CALL    ANOP
&NAME    BAL   R14,$PUTGET
.ATTN    ANOP
         AIF   ('&ATTN' EQ '').NOATTN
         B     &ATTN                         EXIT IF ATTENTION OCCURRED
         AGO   .END
.NOATTN  NOP   0                             IGNORE ATTENTIONS
.END     MEND
         SPACE 15
         MACRO $PUTLINE -  OUTPUT A DATA LINE
&NAME   $PUTLINE &LINE,&ATTN=
         AIF   ('&LINE' EQ '(1)' OR '&LINE' EQ '(R1)').CALL
         AIF   ('&LINE'(1,1) EQ '(').R
&NAME    LA    R1,&LINE                      ADDRESS OF DATA LINE
         BAL   R14,$PUTLINE                  INVOKE PUTLINE INTERFACE
         AGO   .ATTN
.R       ANOP
&NAME    LR    R1,&LINE(1)                   ADDRESS OF DATA LINE
         BAL   R14,$PUTLINE                  INVOKE PUTLINE INTERFACE
         AGO   .ATTN
.CALL    ANOP
&NAME    BAL   R14,$PUTLINE                  INVOKE PUTLINE INTERFACE
.ATTN    ANOP
         AIF   ('&ATTN' EQ '').NOATTN
         B     &ATTN                         EXIT IF ATTENTION OCCURRED
         AGO   .END
.NOATTN  NOP   0                             IGNORE ATTENTIONS
.END     MEND
         SPACE 2
         MACRO MESSAGE - OUTPUT AN ERROR/STATUS MESSAGE
&NAME    MESSAGE &MSG1,&MSG2
         AIF   ('&MSG1' EQ '(1)' OR '&MSG1' EQ '(R1)').MSGDS
         AIF   ('&MSG1'(1,1) EQ '(').RMSG1
         AIF   ('&MSG1' EQ 'MSGTEXT1' AND '&MSG2' EQ '').NOR1
&NAME    LA    R1,&MSG1
         AGO   .MSG2
.NOR1    ANOP
&NAME    BAL   R14,MESSTXT1
         MEXIT
.RMSG1   ANOP
&NAME    LR    R1,&MSG1(1)
         AGO   .MSG2
.MSGDS   ANOP
         AIF   ('&MSG2' NE '').SECOND
&NAME    BAL   R14,MESSAGE0
         MEXIT
.SECOND  ANOP
&NAME    DS    0H
.MSG2    ANOP
         AIF   ('&MSG2' EQ '').NOMSG2 NO SECONDARY MESSAGE
         AIF   ('&MSG2' EQ '(0)' OR '&MSG2' EQ '(R0)').CALL
         AIF   ('&MSG2'(1,1) EQ '(').RMSG2
         LA    R0,&MSG2
         AGO   .CALL
.RMSG2   ANOP
         LR    R0,&MSG2(1)
.CALL    ANOP
         BAL   R14,MESSAGE
         AGO   .END
.NOMSG2  ANOP
         BAL   R14,MESSAGE0
.END     MEND
         EJECT
*
*        SET PROGRAM GENERATION OPTIONS
*
         GBLB  &SPFGEN
         GBLC  &GENDISP,&ONE,&TWO,&TSYS
&SPFGEN  SETB  1         ***  ASSUME THE SPF INTERFACE IS DESIRED
&GENDISP SETC  'OPER'    ***  ASSUME OPER DISPOSITION HANDLING
         AIF   ('&SYSPARM' EQ '').DONE
&TSYS    SETC  '&SYSPARM'.',       '     ADD A COMMA AND 7 BLANKS
         GBLA  &CNT
&CNT     SETA  0
.ADDCNT  ANOP
&CNT     SETA  &CNT+1
         AIF   ('&TSYS'(&CNT,1) NE ',').ADDCNT
&ONE     SETC  '&TSYS'(1,&CNT-1)
&TWO     SETC  '&TSYS'(&CNT+1,7)
         SPACE 1
         AIF   ('&ONE' EQ 'SHR').SHR
         AIF   ('&ONE' EQ 'OPER').OPER
         AIF   ('&ONE' EQ 'OLD').OLD
         AIF   ('&TWO' EQ 'SHR,   ').SHR
         AIF   ('&TWO' EQ 'OPER,  ').OPER
         AIF   ('&TWO' EQ 'OLD,   ').OLD
         AIF   ('&TWO' EQ '       ').SPFCHK
         AIF   ('&ONE' EQ '').SPFCHK
         AGO   .ERRSKIP
.OLD     ANOP
&GENDISP SETC  'OLD'
         AGO   .SPFCHK
.SHR     ANOP
&GENDISP SETC  'SHR'
.OPER    ANOP
.SPFCHK  AIF   ('&SYSPARM' EQ '&GENDISP').DONE
         AIF   ('&SYSPARM' EQ '&GENDISP'.',').DONE
         AIF   ('&SYSPARM' EQ ','.'&GENDISP').DONE
         AIF   ('&ONE' EQ 'SPF').DONE
         AIF   ('&TWO' EQ 'SPF,   ').DONE
         AIF   ('&ONE' EQ 'NOSPF').DELSPF
         AIF   ('&TWO' NE 'NOSPF, ').ERRSKIP
.DELSPF  ANOP
&SPFGEN  SETB  0
         SPACE 2
         MNOTE *,'&GENDISP DISPOSITION PROCESSING WILL BE PERFORMED'
         MNOTE *,'SPF INTERFACE CODE WILL NOT BE GENERATED'
         SPACE 1
         AGO   .NOERR
.DONE    ANOP
         SPACE 2
         MNOTE *,'&GENDISP DISPOSITION PROCESSING WILL BE PERFORMED'
         MNOTE *,'SPF INTERFACE CODE WILL BE GENERATED'
         SPACE 1
         AGO   .NOERR
.ERRSKIP ANOP
         SPACE 3
         MNOTE 12,'SYSPARM(&SYSPARM.) IS INVALID'
         SPACE 1
         AGO   .NOGEN
.NOERR   ANOP
         EJECT
PDS      ENTER
&SPFGEN  SETB  0
         SPACE
         LR    R6,R1                SAVE ADDR OF CPPL
         USING WORKAREA,R7          WORK AREA DSECT
         AIF (NOT &SPFGEN).NOSPFX1
         L     R1,0(,R1)            POINT TO PASSED PARAMETER LIST
         CLC   0(3,R1),=X'000497'   SPF ADDRESS MARKER FROM PDS?
         BNE   GETMAIN              NO, NOT AN ENTRY FROM SPF
         ICM   R7,15,2(R1)          WORK AREA POINTER
         LA    R15,SPFMAIN          SPF REGISTER SAVE AREA
         ST    R15,8(,R13)
         ST    R13,4(,R15)          CHAIN TO SECONDARY SAVEAREA
         LR    R13,R15
         B     RESTART              REALLOCATE THE DATA FILES
.NOSPFX1 ANOP
         EJECT
GETMAIN  L     R5,WORKSIZE
         GETMAIN R,LV=(R5)
         LR    R7,R1                    WORK AREA ADDRESS
         ICM   R7,8,=X'97'              PDS WORK AREA IDENTIFIER
         LR    R4,R1                    CLEAR WORK AREA
         SR    R1,R1                    NULL SOURCE
         MVCL  R4,R0                    FILL WITH PAD 0 FROM R1(0:7)
         SPACE 1
         LM    R2,R4,CPPLUPT-CPPL(R6)   INITIALIZE ADDRUPT,
         L     R5,CPPLCBUF-CPPL(R6)       ADDRPSCB, ADDRECT,
         STM   R2,R6,ADDRUPT              ADDRCBUF AND ADDRCPPL
         MVC   PDSNAME,ECTPCMD-ECT(R4)  SAVE THE PDS COMMAND NAME
         SPACE 1
         STM   R8,R12,BASES             SAVE BASE REGISTERS
         MVC   BLDLLIST,BLDLPARM        BLDL NUMBER OF MEMBERS & LENGTH
         ST    R7,8(,R13)               CHAIN
         ST    R13,4(,R7)                    SAVE
         LR    R13,R7                            AREAS
         SPACE 1
         GTSIZE ,                       TERMINAL PAGESIZE/LINESIZE
         STM   R0,R1,PAGESIZE           LINES/SCREEN
*        ST    R1,LINESIZE              CHARACTERS/LINE
***      STAE  STAEEXIT,CT,PARAM=(R7),MF=(E,STAEPARM)  ***.NOSTAE
         SPACE 1
         MVC   PARMLIST(4),ENQMFL       SET OPTION BITS FOR ENQ
         ENQ   (SPFUSER,PSCBUSER-PSCB(R3),E,7,STEP),RET=TEST,          X
               MF=(E,PARMLIST)          CHECK FOR SPF ENQ
         SPACE 1
         LTR   R15,R15                  UNDER SPF OPTION 6?
         BZ    TSOSERVE                 NO, BRANCH
         OI    FLAGSFF,FSPFOPT6         YES, SET A FLAG
         BAL   R2,CLEAR                      CLEAR THE SCREEN
         EJECT
*
*    LOCATE TSO SERVICE ROUTINES AND TTR CONVERT ROUTINE
*
TSOSERVE L     R6,CVTPTR
         USING CVTMAP,R6
         L     R6,CVTPCNVT     TTR CONVERT     ROUTINE
         ST    R6,ADDRCNVT     TTR --> MBBCCHHR CONVERT ROUTINE
         LOAD  EP=IKJPUTL
         ST    R0,ADDRPUTL
         LOAD  EP=IKJPARS
         ST    R0,ADDRPARS     ADDRESS OF IKJPARS
         LOAD  EP=IKJPTGT
         ST    R0,ADDRPTGT     ADDRESS OF IKJPTGT
         LOAD  EP=IKJSCAN
         ST    R0,ADDRSCAN     ADDRESS OF IKJSCAN
         LOAD  EP=IKJDAIR
         ST    R0,ADDRDAIR     ADDRESS OF IKJDAIR
         LOAD  EP=IKJSTCK
         ST    R0,ADDRSTCK     ADDRESS OF IKJSTCK
         LOAD  EP=IKJEHDEF
         ST    R0,ADDRDEFT     ADDRESS OF IKJEHDEF
         LOAD  EP=IKJEFF02
         ST    R0,ADDRFF02     ADDRESS OF IKJEFF02
         DROP  R6
         SPACE 3
*
*        GET THE DATA SET NAME
*
         SPACE 1
         MVC   ADDRPCL(4),MAINPCL+12 PCL ADDRESS FOR DATA SET NAME
         BAL   R14,GOPARSE    GET THE DATA SET NAME
         B     EXIT12         ERROR EXIT
         XC    ADDRCBUF,ADDRCBUF
         EJECT
RESTART  DS    0H                  ** ALLOCATE OR REALLOCATE DATA SET
         SPACE 1
         MVC   DSPALLOC,DSPREQST   SET INITIAL DISPOSITION SHR/OLD
         SPACE 2
RESTART2 DS    0H                  ** REALLOCATE THE DATA SET AS OLD **
         SPACE 1
         BAL   R14,ALLOCATE        ALLOCATE THE DATA SET
         B     EXIT12              ALLOCATION UNSUCCESSFUL
         SPACE 1
         MVC   INDCB(LEXCPDCB),EXCPDCB MOVE PATTERN DCB
         MVC   STOWDCB(LSAMDCB),SAMDCB ALSO FOR STOW OPERATIONS
         MVC   DCBDDNAM-IHADCB+INDCB,DDNAME
         MVC   DCBDDNAM-IHADCB+STOWDCB,DDNAME
         MVC   DCBDSORG-IHADCB+STOWDCB(1),DSORG
         TM    DSORG,DS1DSGPO                    DSORG=PO?
         BO    *+8                               YES, BRANCH
         MVI   DCBDSORG-IHADCB+STOWDCB,DS1DSGPS  NO, USE DSORG=PS
         SPACE 2
RESTART4 MVI   OPENLIST,X'00'      ** REOPEN THE DATA SET FOR EDIT **
         MVI   OPENLIST+4,X'80'
         OPEN  (STOWDCB,INPUT,INDCB,INPUT),MF=(E,OPENLIST)
         SPACE
         MVI   OPENLIST,X'80'
         CLOSE (STOWDCB),MF=(E,OPENLIST)       OPENED FOR DCB EXIT ONLY
         SPACE
         TM    DCBOFLGS-IHADCB+INDCB,DCBOFOPN  DCB OPEN?
         BNO   NOOPEN                          NO, BRANCH
         EJECT
         L     R1,DCBDEBAD-IHADCB+INDCB        DEB ADDRESS
         MVC   NUMEXT+1(1),DEBNMEXT(R1)        NUMBER OF D.A. EXTENTS
         L     R4,DEBUCBAD(,R1)                ADDRESS OF FIRST UCB
         MVC   VOLALLOC,UCBVOLI(R4)            SAVE VOLUME NAME USED
         L     R14,OBTAIN                      OBTAIN FLAGS
         LA    R15,DSNAME                      ADDRESS OF DSNAME
         LA    R0,VOLALLOC                     VOLUME SERIAL
         LA    R1,DS1FMTID                     OUTPUT START ADDRESS
         STM   R14,R1,CAMLST                   SAVE CAMLIST PARAMETERS
         OBTAIN CAMLST                         GET THE FORMAT 1 DSCB
         LTR   R15,R15                         SUCCESSFUL?
         BNZ   NODSCB                          NO, BRANCH
         SPACE 2
         STM   R14,R12,12(R13)                 SAVE REGISTERS
         ICM   R0,7,DS1LSTAR                   DS1LSTAR --> MBBCCHHR
         SLL   R0,8                            MOVE TO HIGH POSTION
         L     R1,DCBDEBAD-IHADCB+INDCB        DEB ADDRESS
         LA    R2,LSTARMBB                     RETURN ADDRESS
         L     R15,ADDRCNVT                    CONVERSION ROUTINE
         LR    R3,R13                          SAVE R13
         BALR  R14,R15
         LR    R13,R3                          RESTORE R13
         LM    R14,R12,12(R13)                 RESTORE REGISTERS
         SPACE 3
         LA    R0,IOECB                        ECB ADDRESS
         ST    R0,IOBECB                       SET INTO IOB
         LA    R0,INDCB                        DCB ADDRESSS
         ST    R0,IOBDCB                       SET INTO DCB
         MVI   IOB,X'C2'                       SET IOB FLAGS
         SPACE 2
         MVC   CCWS(LCCWINIT),CCWINIT          INITIALIZE CCWS
         SPACE
         LA    R0,IOBSEEK+3
         LA    R1,CCW1A
         STCM  R0,7,CCW1A+1                    ***
         STCM  R1,7,CCW2A+1                    *** -- INIT. CCW'S
         STCM  R0,7,CCW3A+1                    ***
         SPACE
         LA    R1,SNO
         LA    R2,CCW1
         L     R3,BUFFADDR
         STCM  R1,7,CCW0+1                     ***
         STCM  R0,7,CCW1+1                     ***
         STCM  R2,7,CCW2+1                     ***
         STCM  R3,7,CCW3+1                     ***  -- READ CCW'S
         STCM  R0,7,CCW4+1                     ***
         STCM  R1,7,CCW5+1                     ***
         SPACE 8
         LA    R1,CCW0                         FIRST CCW (SET SECTOR)
         ST    R1,EXCPCCWI                     SAVE FOR EXCP ROUTINE
         SPACE 2
         CLI   UCBTYP+3(R4),X'08'              2314 DISK?
         BNE   NOT2314                         NO, BRANCH
         ST    R2,EXCPCCWI                     YES, DO NOT READ SECTOR
         XI    CCW4+4,X'40'                    DO NOT CHAIN CCW4
         SPACE 3
NOT2314  MVI   DSORG+1,0                       CLEAR SECOND DSORG BYTE
         TM    DSORG,DS1DSGIS+DS1DSGPS+DS1DSGDA+DS1DSGPO  DSORG KNOWN?
         BM    NEWSTAX                                    YES, BRANCH
         MVC   DSORG(2),DS1DSORG                          NO, USE LABEL
         B     NEWSTAX
         SPACE 2
NODSCB   MESSAGE MSGNDSCB        FORMAT 1 DSCB NOT FOUND
         B     EXIT12
         SPACE 2
NOOPEN   MESSAGE MSGNOPEN        DID NOT OPEN CORRECTLY
         B     EXIT12
         EJECT
***********************************************************************
***      OPTIONS SUBCOMMAND                                         ***
***********************************************************************
*
         SPACE 2
OPTIONS  MESSAGE MSGAVAIL             AVAILABLE OPTIONS HEADER
         LA    R2,OPTNTBL             START OF OPTIONS TABLE
         SPACE
OPTIONS2 CLI   0(R2),C'S'             SHORT OPTIONS TABLE MESSAGE?
         BE    OPTIONS4               YES, BRANCH
         TM    DSORG,DS1DSGPO         DSORG=PO?
         BNO   OPTIONS6               NO, BRANCH
         BCTR  R2,0                   YES, PREPARE FOR NEXT LA
OPTIONS4 LA    R2,1(,R2)              NEXT OPTION
         MESSAGE (R2)
OPTIONS6 LH    R1,0(,R2)              NEXT OPTION
         AR    R2,R1                  NEXT OPTION
         CLI   0(R2),X'FF'            DONE?
         BNE   OPTIONS2               NO, BRANCH
         EJECT
*
*        ISSUE A REPLACEMENT STAX MACRO; GET THE NEXT COMMAND
*
         SPACE 1
NEWSTAX  L     R14,ADDRECT
         MVC   ECTPCMD-ECT(8,R14),PDSNAME   RESET PDS COMMAND NAME
         STAX  ATTNEXIT,USADDR=(R7),REPLACE=YES,IBUF=0,OBUF=0,         X
               MF=(E,STAXPARM)
         SPACE 2
         ICM   R15,15,ADDRCMD         RECURSIVE OR REALLOCATE CALL?
         MVI   ADDRCMD,0              TURN OFF CALL FLAG
         BMR   R15                    YES, BRANCH
         SPACE 3
NEWCMD   TM    FLAGSAA,FMEM#MEM       MEMBER GROUP IN PROGRESS?
         BO    MEMSGET                YES, BRANCH
         SPACE 1
         NI    FLAGSAA,FF-FMEMBER1-FMEMBER2-FATTR-FMEMRANG-FOPTIONS-FMEX
               M#MEM-FATTN-FIND1       CLEAR MAJOR CONTROL FLAGS
         TM    FLAGSBB,FCMD            COMMAND BUFFER AVAILABLE?
         BO    HAVECMD                 YES, BRANCH
         SPACE 2
         MVI   ATTNECB,2+1             FLAG -- CAN BE ATTENTIONED
        $PUTGET MSGENTER,ATTN=NEWCMD2  FIRST TRY FOR A COMMAND
         B     HAVECMD                 GOT A COMMAND
         SPACE 1
NEWCMD2  MVI   ATTNECB,2+1             FLAG -- CAN BE ATTENTIONED
        $PUTGET MSGENTER,ATTN=EXIT8    SECOND TRY FOR A COMMAND
         EJECT
*
*        SET UP FOR SUBCOMMAND SCAN
*
         SPACE 1
HAVECMD  NI    FLAGSBB,FF-FCMD
         SPACE 2
         LA    R15,PARMLIST
         USING CSPL,R15
         SPACE
         L     R1,ADDRUPT           ADDRESS OF THE UPT
         L     R2,ADDRECT           ADDRESS OF THE ECT
         LA    R3,ATTNECB           ADDRESS OF THE ATTENTION ECB
         LA    R4,ZERO              ADDRESS OF A FLAG AREA (WITH ZEROS)
         LA    R5,SCANANSR          ADDRESS OF THE RESULT AREA
         L     R6,ADDRCBUF          ADDRESS OF THE SUBCOMMAND BUFFER
         STM   R1,R6,CSPLUPT        INITIALIZE CSPLUPT, CSPLECT,
         DROP  R15                  CSPLECB, CSPLFLG, CSPLOA & CSPLCBUF
         SPACE 2
         MVI   ATTNECB,0            CLEAR ECB
         LR    R1,R15               PARAMETER LIST START
         L     R15,ADDRSCAN
         BALR  R14,R15              INVOKE COMMAND SCAN
         SPACE
         LA    R15,SCANANSR         ADDR OF ANSWER AREA
         USING CSOA,R15
         SPACE
         TM    CSOAFLG,CSOANOC      EMPTY BUFFER?
         BO    NEWCMD               YES, STILL NEED COMMAND
         SPACE
         TM    CSOAFLG,CSOAEXEC     IMPLICIT EXEC?
         BZ    HAVECMD1             NO, BRANCH
         EJECT
***********************************************************************
***      EXEC SUBCOMMAND       ADDED BY BRUCE LELAND -- JAN, 1980   ***
***********************************************************************
*
         SPACE 2
         L     R2,ADDRCBUF          ** IMPLICIT FORM OF EXEC **
         NI    ADDRPCL,FF-#@        ATTENTIONS ARE NOT ALLOWED FOR EXEC
         XC    2(2,R2),2(R2)        CLEAR OFFSET
         SPACE
EXEC     L     R2,ADDRCBUF          ** EXPLICIT FORM OF EXEC **
         L     R1,ADDRCPPL
         ST    R2,0(,R1)
         SPACE
         LINK  EPLOC=EXECLIT,SF=(E,LINKSFL)
         B     NEWSTAX
         EJECT
HAVECMD1 TM    CSOAFLG,CSOAVWP+CSOAVNP VALID COMMAND?
         LA    R1,MSGINVLD             ASSUME NOT
         BZ    MSGNEW                  NO, BRANCH
         SPACE 2
         TM    CSOAFLG,CSOAVWP         ANY OPERAND?
         BNO   *+8                     NO, BRANCH
         OI    FLAGSAA,FOPTIONS        YES, NOTE FOR LATER
         SPACE 2
         L     R2,CSOACNM              ADDR OF COMMAND NAME
         LH    R3,CSOALNM              LENGTH OF NAME
         BCTR  R3,0                    MACHINE LENGTH
         DROP  R15
         SPACE 2
         LA    R1,CMDTABLE             START OF COMMAND SCAN
         TM    DSORG,DS1DSGPO          DSORG=PO?
         BO    *+8                     YES, BRANCH
         LA    R1,MAINPCL              NO, START SCAN AT MAINPCL
*
*   COMMAND SCAN - IN THE CASE OF A POTENTIALLY AMBIGUOUS ENTRY
*                  (E.G. 'A ') THE FIRST MATCH IN THE COMMAND TABLE
*                  (ATTR IN THIS CASE) IS USED.
*
         SPACE 2
         CLC   0(*-*,R1),0(R2)         <<EXECUTED>>
CMDSCAN  EX    R3,*-6                  CHECK COMMAND NAME
         BE    CMDVALID                MATCH, MUST BE COMMAND
         SPACE
         LA    R1,16(R1)               NEXT ENTRY IN TABLE
         CLI   0(R1),X'FF'             END OF TABLE?
         BNE   CMDSCAN                 NO, CONTINUE
         SPACE
         MESSAGE MSGUNKN               NOT A VALID COMMAND
         SPACE 1
         LA    R2,MSGCMDSL             START OF AVAILABLE COMMAND LIST
         TM    DSORG,DS1DSGPO          DSORG=PO?
         BO    OPTIONS2                YES, BRANCH
         LA    R2,MSGCMDSS             NO, USE A DIFFERENT LIST
         B     OPTIONS2
         EJECT
CMDVALID MVC   SUBNAME(8),0(R1)  FULL SUBCOMMAND NAME
         MVC   ADDRCMD,8(R1)     COMMAND PROCESSOR ADDRESS
         MVC   ADDRPCL,12(R1)    PCL ADDRESS AND FLAGS
         SPACE 2
         XC    ANSWERS,ANSWERS   INITIALIZE THE EDIT PDL SAVE AREA
         MVC   MAXLEN(LINIT),INITMAX  INITIALIZE MAXLEN, MAXIN, MAXOUT,
*                                     SKIPREC, SKIPCOL, COMMDLTH
         SPACE 2
CMDCHECK TM    ADDRPCL,#N        IGNORE OPTIONS?
         BO    CALLCMD           YES, BRANCH
         SPACE 2
         TM    ADDRPCL,#G        MEMBER NAME DEFAULT (AND GROUP)?
         BNO   CHKREQD           NO, CHECK IF OPERANDS REQUIRED
         TM    FLAGSAA,FOPTIONS  ANY OPERAND SPECIFIED
         BO    CMDPARSE          YES, USE THE SPECIFIED MEMBER NAME
         SPACE 2
         CLI   MEMBERD,X'00'     ANY DEFAULT MEMBER NAME YET?
         BE    CMDPARSE          NO, CONTINUE THE PARSE
         MVC   LMEMBER1(2+8+8+2),MEMBERD+1  RESET DEFAULT MEMBER NAMES
         NI    FLAGSAA,FF-FMEMBER1-FMEMBER2-FMEM#MEM-FMEMRANG
         OC    FLAGSAA,MEMBERD   RESTORE THE DEFAULT FLAGS
         TM    FLAGSAA,FMEM#MEM  MEMBER GROUP REQUESTED?
         BO    CALLCMD           YES, BRANCH
         SPACE 1
         MVC   MSGTEXT1,MSGDEFM
         MVC   MSGTEXT1+MSGDEFM1-MSGDEFM(8),MEMBER1
         MESSAGE MSGTEXT1        TELL THE USER WHO IS BEING PROCESSED
         B     CALLCMD           CALL THE COMMAND
         SPACE 3
CHKREQD  TM    ADDRPCL,#R        OPERANDS REQUIRED?
         BO    CMDPARSE          YES, BRANCH
         TM    FLAGSAA,FOPTIONS  ANY OPERANDS SPECIFIED?
         BZ    CALLCMD           NO, BRANCH
         SPACE 2
CMDPARSE OI    FLAGSAA,FOPTIONS  NOW THERE ARE OPERANDS
         BAL   R14,GOPARSE       GET THE COMMAND OPERANDS
         B     NEWCMD            INVALID PARSE, IGNORE
         EJECT
CALLCMD  TM    FLAGSAA,FMEM#MEM    MEMBER GROUP DESIRED?
         BO    CALLCMD8            YES, BRANCH
         TM    ADDRPCL,#C          CHANGE DIRECTORY AND NO BLDL?
         BNO   CALLCMD2            NO, BRANCH
         MVC   DIRNAME,MEMBER1     GET MEMBER NAME
         NI    FLAGSDD,FF-FBLDLOK  DIRECTORY WILL BE CHANGED
         SPACE 2
CALLCMD2 TM    ADDRPCL,#B          BLDL REQUIRED?
         BNO   CALLCMD8            NO, BRANCH
         TM    FLAGSDD,FBLDLOK     BLDL STILL VALID?
         BNO   CALLCMD4            NO, BRANCH
         TM    FLAGSAA,FOPTIONS    ANY MEMBER NAME SPECIFIED?
         BO    CALLCMD4            YES, DO A BLDL THEN
         CLC   DIRNAME(8),MEMBER1  STILL THIS MEMBER NAME?
         BE    CALLCMD8            YES, NO NEED TO BLDL
         SPACE 2
CALLCMD4 XC    DIRUSER,DIRUSER     CLEAR THE USER FIELDS
         MVC   DIRNAME,MEMBER1     ORIGINAL MEMBER NAME
         NI    FLAGSDD,FF-FBLDLOK  ASSUME MEMBER NOT FOUND
         SPACE 2
         BLDL  INDCB,BLDLLIST      LOCATE DIRECTORY ENTRY
         SPACE
         B     *+4(R15)            PROCESS RETURN CODE
         B     CALLCMD6            00-SUCCESSFUL
         B     NOMEMBER            04-MEMBER NOT FOUND
         B     IOERROR             08-I/O ERROR
         SPACE 3
CALLCMD6 OI    FLAGSDD,FBLDLOK     MEMBER FOUND
         MVC   DIRFLAG(DIREND-DIRFLAG),DIRFLAG+2 BLDL ADDS THINGS
         SPACE 2
CALLCMD8 TM    FLAGSAA,FMEM#MEM           MEMBER GROUP TO START?
         BNO   CALLCMDZ                   NO, BRANCH
         NI    FLAGSDD,FF-FBLDLOK         YES, FORCE A BLDL NEXT TIME
         SPACE 1
         TM    FLAGSAA,FMEMBER1+FMEMBER2  ANY MEMBER NAMES?
         BNZ   MEMSINIT                   YES, BRANCH
         TM    ADDRPCL,#S                 SPFEDIT OR BROWSE?
         BNO   MEMSINIT                   NO, BRANCH
         NI    FLAGSAA,FF-FMEM#MEM        TURN OFF MEMBER GROUPS
         B     CALLCMDZ                   CALL SPFEDIT OR BROWSE
         EJECT
MEMSINIT MVC   MEMSHOLD(LMEMS),SUBNAME  SAVE SUBCOMMAND CHANGED DATA
         XC    DIRNAME(8),DIRNAME       CLEAR THE MEMBER NAME
         TM    FLAGSAA,FMEMRANG         MEMBER RANGE?
         BO    DISPLAY                  YES, BRANCH
         B     PATTERN                  NO, MEMBER PATTERN
         SPACE 1
MEMSGET  MVC   IOBSEEK(LIOBDIR),SIOBDIR CHANGED INFORMATION FOR READDIR
         L     R2,BUFFADDR              BUFFER ADDRESS
         LM    R15,R1,DIRPTRS           RELOCATE
         AR    R15,R2                     DIRPTRS+0 AND DIRPTRS+8
         AR    R1,R2                        IN CASE BUFFER
         STM   R15,R1,DIRPTRS                 WAS REALLOCATED
         MVC   0(256,R2),SAVDIR         RESTORE CURRENT DIRECTORY BLOCK
         B     DISPLAY2                 GET NEXT MEMBER
         SPACE 1
MEMSNEXT OI    FLAGSBB,FRANPAT          MEMBERS EXIST IN THIS RANGE
         L     R2,BUFFADDR              BUFFER ADDRESS
         L     R14,DIRPTRS              START OF CURRENT MEMBER NAME
         LM    R15,R1,DIRPTRS           RELOCATE
         SR    R15,R2                     DIRPTRS+0 AND DIRPTRS+8
         SR    R1,R2                        IN CASE BUFFER
         STM   R15,R1,DIRPTRS                 WILL BE REALLOCATED
         MVC   SIOBDIR(LIOBDIR),IOBSEEK CHANGED INFORMATION FOR READDIR
         MVC   SAVDIR(256),0(R2)        SAVE CURRENT DIRECTORY BLOCK
         MVC   SUBNAME(LMEMS),MEMSHOLD  RESET CHANGED INFORMATION
         CLC   DIRNAME(8),0(R14)        NAME PROCESSED BEFORE?
         BNL   MEMSGET                  YES, BRANCH AND IGNORE
         XC    DIRNAME(74),DIRNAME      CLEAR THE CURRENT ENTRY
         IC    R15,MEMFLAG              DIRECTORY FLAG BYTE
         N     R15,=XL4'0000001F'       NUMBER OF HALFWORDS
         LA    R15,11(R15,R15)          MACHINE LENGTH OF ENTRY
         MVC   DIRNAME(*-*),0(R14)      <<EXECUTED>>
         EX    R15,*-6                  MOVE IN THE CURRENT ENTRY
         SPACE 1
         MESSAGE MSGBLANK               ONE BLANK LINE
         MVC   MSGTEXT1+4(3),=CL3'** '
         MVC   MSGTEXT1+4+3(8),SUBNAME
         MVI   MSGTEXT1+4+3+8,X'40'
         MVC   MSGTEXT1+4+3+8+1(8),DIRNAME
         LA    R1,24
         SLL   R1,16
         ST    R1,MSGTEXT1
         MESSAGE MSGTEXT1
         SPACE 2
CALLCMDZ L     R15,ADDRCMD              SUBCOMMAND ROUTINE START
         BR    R15                      LINK TO THE SUBCOMMAND
         EJECT
***
***      ATTENTION EXIT ROUTINE
***
         SPACE 1
ATTNEXIT ENTER ATTNEXIT
         NI    FLAGSAA,FF-FMEM#MEM     TERMINATE ANY MEMBER GROUP
         TM    ATTNECB,2+1             PARSE OR "ENTER OPTIONS"?
         BM    ATTNPTGT                YES, PARSE -- BRANCH
         BO    ATTNPOST                YES, "ENTER OPTIONS" -- BRANCH
         SPACE 1
         TM    ADDRPCL,#@              ALLOW ATTENTIONS?
         BO    ATTNPTGT                YES, BRANCH
         STAX  ,                       NO, CANCEL ANY CURRENT STAX
         B     EXITATTN                QUIT
         SPACE 1
ATTNPTGT L     R2,R14PTGT              $PUTGET IS NOT RECURSIVE
        $PUTGET MSGENTER               PROMPT WITH "ENTER OPTIONS"
         ST    R2,R14PTGT              $PUTGET IS NOT RECURSIVE
         SPACE 1
         TM    FLAGSBB,FNULL           NULL LINE ENTERED?
         BO    EXITATTN                YES, JUST LEAVE
         OI    FLAGSBB,FCMD            NO, INDICATE COMMAND AVAILABLE
         SPACE 1
ATTNPOST POST  ATTNECB                 NOTIFY OF ATTENTION ENTERED
         SPACE
EXITATTN SR    R15,R15
         EXIT
         EJECT
***********************************************************************
***      DISPLAY SUBCOMMAND                                         ***
***                                                                 ***
***      MEMBERS SUBCOMMAND    ADDED BY BRUCE LELAND -- JULY, 1982  ***
***                                                                 ***
***      PATTERN SUBCOMMAND    ADDED BY BRUCE LELAND -- JAN, 1980   ***
***********************************************************************
*
         SPACE 1
DISPLAY  OI    FLAGSAA,FMEMRANG          **  MEMBER RANGE SELECTION
         TM    FLAGSAA,FMEMBER1+FMEMBER2 DISPLAY RANGE?
         BNO   DISPLAY0                  NO, NO RANGE CHECK
         LH    R14,LMEMBER1
         CH    R14,LMEMBER2              DETERMINE MIN NAME LENGTH
         BNH   *+8
         LH    R14,LMEMBER2
         CLC   MEMBER1(*-*),MEMBER2      <<EXECUTED>>
         EX    R14,*-6                   VALID DISPLAY RANGE?
         LA    R1,MSGRANGE               INVALID RANGE MESSAGE
         BH    MSGNEWXX                  YES, BRANCH
         SPACE 1
PATTERN  DS    0H                        **  MEMBER PATTERN SELECTION
         SPACE 1
MEMBERS  DS    0H                        **  MEMBER GROUP DISPLAY
         SPACE 1
DISPLAY0 CLC   MEMBLIT,SUBNAME           MEMBERS SUBCOMMAND?
         BNE   *+8                       NO, BRANCH
         NI    FLAGSAA,FF-FMEM#MEM       YES, TURN OFF ANY MEMBER GROUP
         NI    FLAGSBB,FF-FEXIST-FLINESET-FRANPAT
         MVI   STARTTR+2,X'01'          TTR=000001 (START OF DIRECTORY)
         SPACE 1
DISPLAY1 L     R4,LINESIZE               GET TERMINAL LINE SIZE
         LA    R4,MSGTEXT1+3-11(R4)      END OF LINE ADDRESS
         LA    R5,MSGTEXT1+4             START OF LINE
         CLEAR MSGTEXT1
         SPACE 1
DISPLAY2 BAL   R14,READDIR               GET NEXT DIRECTORY ENTRY
         B     DISPLAY6                  LAST MEMBER IN DIRECTORY
         SPACE 1
         OI    FLAGSBB,FEXIST            MEMBER EXISTS FLAG
         TM    FLAGSAA,FMEMRANG          MEMBER NAME RANGE?
         BNO   PATTERN1                  NO, BRANCH
         TM    FLAGSAA,FMEMBER1          START ENTRY SPECIFIED?
         BZ    DISPLAY3                  NO, BRANCH
         SPACE
         LH    R15,LMEMBER1              LENGTH-1 OF MEMBER NAME
         CLC   MEMBER1(*-*),MEMNAME      <<EXECUTED>>
         EX    R15,*-6
         BH    DISPLAY2                  NOT WANTED, GET NEXT
         XI    FLAGSAA,FMEMBER1
         SPACE 5
DISPLAY3 TM    FLAGSAA,FMEMBER2          LAST ENTRY SPECIFIED?
         BZ    DISPLAY4                  NO, BRANCH
         SPACE
         LH    R15,LMEMBER2
         CLC   MEMBER2(*-*),MEMNAME      <<EXECUTED>>
         EX    R15,*-6                   PAST END?
         BL    DISPLAY6                  YES, END OF DISPLAY
         B     DISPLAY4                  NO, DISPLAY THIS MEMBER NAME
         SPACE 1
PATTERN1 LH    R15,LMEMBER1              LENGTH-1 OF THE PATTERN
         LA    R1,8                      MAXIMUM PATTERN LENGTH
         SR    R1,R15                    NUMBER OF COMPARE LOOPS
         LA    R14,MEMNAME               START SCAN POSITION
         CLC   0(*-*,R14),MEMBER1        <<EXECUTED>>
PATTERN2 EX    R15,*-6                   PATTERN IN THIS MEMBER NAME?
         BE    PATTERN3                  YES, CHECK FOR ANOTHER PATTERN
         LA    R14,1(,R14)               MAYBE, CHECK AT THE NEXT BYTE
         BCT   R1,PATTERN2               CHECK ALL POSSIBLE POSITIONS
         B     DISPLAY2                  NO, IGNORE THIS ENTRY
         SPACE 1
PATTERN3 TM    FLAGSAA,FMEMBER2          A SECOND PATTERN SPECIFIED?
         BZ    DISPLAY4                  NO, DISPLAY THE MEMBER NAME
         LH    R15,LMEMBER2              LENGTH-1 OF THE PATTERN
         LA    R1,8                      MAXIMUM PATTERN LENGTH
         SR    R1,R15                    NUMBER OF COMPARE LOOPS
         LA    R14,MEMNAME               START SCAN POSITION
         CLC   0(*-*,R14),MEMBER2        <<EXECUTED>>
PATTERN4 EX    R15,*-6                   PATTERN IN THIS MEMBER NAME?
         BE    DISPLAY4                  YES, DISPLAY THE MEMBER NAME
         LA    R14,1(,R14)               MAYBE, CHECK AT THE NEXT BYTE
         BCT   R1,PATTERN4               CHECK ALL POSSIBLE POSITIONS
         B     DISPLAY2                  NO, IGNORE THIS ENTRY
         SPACE 1
DISPLAYT TRT   MEMNAME(*-*),TRTMEM       <<EXECUTED>>
DISPLAY4 TM    FLAGSAA,FMEM#MEM          MEMBER NAME GROUP DESIRED?
         BO    MEMSNEXT                  YES, FOUND A MEMBER
         LA    R1,7                      MEMBER NAME MACHINE LENGTH
         LA    R14,MEMNAME+8             END OF MEMBER NAME +1
DISPLAYB BCTR  R14,0                     SCAN
         CLI   0(R14),X'40'                  BACKWARDS
         BNE   *+8                                    FOR A
         BCT   R1,DISPLAYB                                 NON-BLANK
         CLI   MEMNAME,C'0'              FIRST DIGIT NUMERIC?
         BNL   *+12                      YES, FORCE A HEX DISPLAY
         EX    R1,DISPLAYT               ANY INVALID OR UNPRINTABLE?
         BZ    DISPLAY8                  NO, BRANCH
         TM    FLAGSBB,FLINESET          LINE IN PROGRESS?
         BZ    DISPLAY9                  NO, SKIP THE PUTLINE
         LA    R1,MSGTEXT1
         SR    R5,R1
         SLL   R5,16
         ST    R5,MSGTEXT1
         MESSAGE (R1)
         NI    FLAGSBB,FF-FLINESET
         SPACE 6
DISPLAY9 UNPK  MSGTEXT1+4(9),MEMNAME(5)  FIRST HALF OF NAME
         UNPK  MSGTEXT1+12(9),MEMNAME+4(5) SECOND HALF OF NAME
         TR    MSGTEXT1+4(16),TRTABLE    FINISH TRANSLATION
         MVC   MSGTEXT1+20(8),BLANKS     CLEAN OUT GARBAGE
         TM    MEMFLAG,X'80'             ALIAS?
         BZ    *+10                      NO, SKIP -A
         MVC   MSGTEXT1+20(2),=C'-A'     YES, SET -A
         MVI   MSGTEXT1+24,C'*'
         MVC   MSGTEXT1+25(8),MEMNAME    MEMBER NAME FROM DIRECTORY
         LA    R1,TRTMEM
         LA    R1,256(R1)
         TR    MSGTEXT1+25(8),0(R1)      TRANSLATE TO PRINTABLE
         MVI   MSGTEXT1+33,C'*'
         OI    FLAGSBB,FLINESET+FRANPAT  OUTPUT AND MEMBERS EXIST NOW
         LA    R5,MSGTEXT1+34
         B     DISPLAY5
         SPACE
DISPLAY8 MVC   0(8,R5),MEMNAME
         TM    MEMFLAG,X'80'             ALIAS?
         BZ    DISPLAY7                  NO, BRANCH
         MVC   8(2,R5),=C'-A'
DISPLAY7 OI    FLAGSBB,FLINESET+FRANPAT
         LA    R5,10+2(R5)
         CR    R5,R4                     LINE FULL?
         BL    DISPLAY2                  NO, CONTINUE
         SPACE
DISPLAY5 LA    R1,MSGTEXT1
         SR    R5,R1
         SLL   R5,16
         ST    R5,MSGTEXT1
         MESSAGE (R1)
         NI    FLAGSBB,FF-FLINESET
         B     DISPLAY1                  RETURN
         SPACE 2
DISPLAY6 TM    FLAGSBB,FLINESET          BUFFER IN PROGRESS?
         BNO   DISPLAYZ                  NO, BRANCH
         LA    R1,MSGTEXT1
         SR    R5,R1
         SLL   R5,16
         ST    R5,MSGTEXT1
         TM    FLAGSAA,FMEM#MEM          MEMBER GROUP IN PROGRESS?
         BNO   MSGNEW                    NO, BRANCH
         SPACE 2
DISPLAYZ NI    FLAGSAA,FF-FMEM#MEM       TERMINATE ANY MEMBER GROUP
         TM    FLAGSBB,FRANPAT           MEMBER IN RANGE?
         BO    NEWCMD                    YES, BRANCH
         TM    FLAGSBB,FEXIST            NO, BUT ANY IN DIRECTORY?
         LA    R1,MSGEMPTY
         BZ    MSGNEW                    NO, ** EMPTY DIRECTORY **
         LA    R1,MSGNODSP               ASSUME NONE IN RANGE
         TM    FLAGSAA,FMEMRANG MEMBER   CORRECT?
         BO    MSGNEW                    YES, BRANCH
         LA    R1,MSGNOPAT               NO, NONE MATCHING PATTERN
         B     MSGNEW
         EJECT
***********************************************************************
***      EDIT SUBCOMMAND       ADDED BY BRUCE LELAND -- NOV, 1977   ***
***********************************************************************
*
         SPACE
EDIT     MVC   MSGTEXT2+4(8),EDITLIT    MOVE IN "EDIT    "
         MVI   MSGTEXT2+12,C''''        ADD A QUOTE
         MVC   MSGTEXT2+13(44),DSNAME   ADD THE DATA SET NAME
         LH    R15,DSNLEN               DSNAME ACTUAL LENGTH
         LA    R2,MSGTEXT2+13(R15)      POINTER TO CURRENT BYTE
         MVI   0(R2),C'('               MEMBER NAME PAREN
         SR    R5,R5                    LENGTH OF LAST QUALIFIER
         LR    R14,R2                   BACKWARD SCAN POINTER
         BCTR  R14,0                    BACK UP FROM (
EDIT7    BCTR  R14,0                    SCAN
         LA    R5,1(,R5)                    TO
         CLI   0(R14),C'.'                    PREVIOUS
         BNE   EDIT7                                  PERIOD
         SPACE
         MVC   MSGTEXT1+4(9),1(R14)
         MVC   1(8,R2),DIRNAME          MEMBER NAME
         MVI   1+8(R2),X'40'            INSURE SCAN STOPS
         SPACE 1
         LA    R2,1(,R2)                SCAN
         CLI   0(R2),X'40'                  FOR FIRST
         BNE   *-8                                   BLANK
         SPACE 1
         MVC   0(3,R2),=C')'' '         ADD )' AND A BLANK
         LA    R2,3(,R2)
         SPACE 2
         USING PDLEDIT,R14
         LA    R14,ANSWERS
         CLI   PCLNON+1,1               NONUM CODED?
         BNE   EDIT9                    NO, BRANCH
         SPACE
         MVC   0(6,R2),=C'NONUM '       YES
         LA    R2,6(,R2)
EDIT9    CLI   PCLASIS+1,1              ASIS CODED?
         BNE   EDIT11                   NO, BRANCH
         SPACE
         MVC   0(5,R2),=C'ASIS '        YES
         LA    R2,5(,R2)
EDIT11   CLI   PCLTYPE+1,0              ANY DATA TYPE CODED?
         BE    EDIT13                   NO, BRANCH
         SPACE
         LH    R15,PCLTYPE              GET THE OPTION CODED
         MH    R15,=H'7'                INDEX  =  OPTIONUM * 7
         LA    R15,EDITTYPE-7(R15)      POINT TO THE PROPER OPTION
         B     EDIT19                   DONE WITH FORMATTING
         EJECT
EDIT13   BCTR  R5,0                     MACHINE QUALIFIER LENGTH
         LA    R15,EDITTYPE-7
EDIT15   LA    R15,7(,R15)              TABLE WIDTH IS 7
         CLC   PLIF,0(R15)              END OF DESCRIPTIVE QUALIFIERS?
         BE    EDIT17                   YES, USE "DATA" OR "GOFORT"
         CLC   0(*-*,R15),MSGTEXT1+4    <<EXECUTED>>
         EX    R5,*-6                   THIS QUALIFIER?
         BNE   EDIT15                   NO, TRY THE NEXT ONE
         B     EDIT19                   YES, USE THIS QUALIFIER
         SPACE 2
EDIT17   LA    R15,EDITTYPE             NOT FOUND, ASSUME "DATA"
         CLC   =C'FORT(',MSGTEXT1+4     FORT QUALIFIER?
         BNE   EDIT19
         LA    R15,GOFORT               YES, USE "GOFORT" (EDIT RULES)
         SPACE 1
EDIT19   MVC   0(7,R2),0(R15)           MOVE IN DATA TYPE
         LA    R1,MSGTEXT2
         ST    R1,ADDRTEXT              COMMAND ADDRESS
         LA    R2,7(,R2)
         SR    R2,R1                    COMMAND LENGTH
         SLL   R2,16
         ST    R2,MSGTEXT2              SAVE LENGTH OF STRING
*        MESSAGE MSGTEXT2               DELETE * TO OUTPUT THE COMMAND
         MVI   MSGTEXT2+3,8             OPERAND OFFSET
         DROP  R14
         BAL   R2,CLOSEIT               NEED TO CLOSE BEFORE THE EDIT
         SPACE 1
         L     R4,ADDRECT
         MVC   ECTPCMD-ECT(8,R4),EDITLIT       COMMAND NAME IS EDIT
         LA    R1,ADDRTEXT                     THE CPPL FOR EDIT
         LINK  EPLOC=EDITLIT,SF=(E,LINKSFL)    GO DO THE EDIT
         B     RESTART4                        OPEN INDCB AGAIN
         SPACE 3
         AIF (NOT &SPFGEN).NOSPFX3
         EJECT
***********************************************************************
***     SPFEDIT SUBCOMMAND     ADDED BY BRUCE LELAND -- JULY, 1982  ***
***                                                                 ***
***     BROWSE SUBCOMMAND      ADDED BY BRUCE LELAND -- JULY, 1982  ***
***********************************************************************
*
         SPACE 1
SPFEDIT  LA    R2,EDITLIT               POINT TO "EDIT    "
         B     SPFSERVE
         SPACE 1
BROWSE   LA    R2,BROWSLIT              POINT TO "BROWSE  "
         SPACE 1
SPFSERVE LA    R1,MSGOPT6               ASSUME UNDER SPF OPTION 6
         TM    FLAGSFF,FSPFOPT6         CORRECT?
         BO    MSGNEWXX                 YES, BRANCH
         MVC   MSGTEXT1(8),0(R2)        SPF SERVICE REQUESTED
         TM    FLAGSFF,FSPFCALL         SPF CALLED ALREADY?
         BO    SPFINTRF                 YES, CALL SPF EDIT OR BROWSE
         OI    FLAGSFF,FSPFCALL         SPF CALLED FLAG
         MVI   ADDRCMD,C'R'             RECURSIVE CALL FLAG
         BAL   R2,FREEESD               FREE ESD AND IDR STORAGE
         BAL   R2,FREEPDL               FREE PARSE STORAGE
         BAL   R14,FREEBUFF             RELEASE PUTGET BUFFERS
         BAL   R2,CLOSEIT               NEED TO CLOSE BEFORE SPF
         BAL   R2,DEALLDCB              AND FREE THE DATA SET
         MVC   MSGTEXT2+4(L'ISPF),ISPF  ISPF   PGM(PDS4567)  PARM(..
         LA    R1,MSGTEXT2+ISPFPGM+4    WHERE PDS COMMAND NAME GOES
         MVC   0(8,R1),PDSNAME          SAVE FOR RECURSIVE CALL
         LA    R1,1(,R1)                SCAN
         CLI   0(R1),X'40'                  FOR NEXT
         BNE   *-8                                  BLANK
         MVI   0(R1),C')'               ADD A FINAL PARENTHESIS
         STCM  R7,15,MSGTEXT2+ISPFPARM+4  ADD THE STORAGE ADDRESS
         LA    R1,L'ISPF+4              LENGTH OF STRING PASSED TO SPF
         SLL   R1,16                    CLEAR BOTTOM TWO BYTES
         ST    R1,MSGTEXT2              SAVE STRING TOTAL LENGTH
*        MESSAGE MSGTEXT2               DELETE * TO OUTPUT COMMAND
         MVI   MSGTEXT2+3,8             OFFSET OF PGM(... PARAMETER
         LA    R1,MSGTEXT2              START OF PARAMETER LIST
         ST    R1,ADDRTEXT              COMMAND ADDRESS
         LA    R1,ADDRTEXT              START OF CPPL PARAMETERS
         LINK  EPLOC=ISPF,SF=(E,LINKSFL)  TELL SPF WE ARE A DIALOG
         NI    FLAGSFF,FF-FSPFCALL      SPF FLAG TURNED OFF
         LTR   R5,R15                   GOOD RETURN?
         BZ    RETURN6                  YES, BRANCH
         NI    FLAGSAA,FF-FMEM#MEM      NO, TURN OFF ANY MEMBER GROUP
         MVI   ADDRCMD,0                DO NOT REPEAT SPFEDIT OR BROWSE
         B     RESTART                  IGNORE THIS SUBCOMMAND
         EJECT
SPFINTRF CLI   MSGTEXT1,C'B'            BROWSE SUBCOMMAND?
         BE    *+8                      YES, BRANCH
         BAL   R2,CLOSEIT               NO, CLOSE THE INPUT DATA SET
         SPACE 1
         LA    R0,=CL8'CONTROL'         FIRST PARAMETER
         LA    R1,=CL8'DISPLAY'         SECOND PARAMETER
         LA    R2,=CL8'REFRESH'         THIRD PARAMETER
         STM   R0,R2,MSGTEXT2           SAVE ADDRESSES
         OI    MSGTEXT2+8,X'80'         LAST
         LA    R1,MSGTEXT2                  PARAMETER
         LINK  EPLOC=ISPLINK,SF=(E,LINKSFL)  LET SPF KNOW
         SPACE 1
         MVI   MSGTEXT1+8,C''''         ADD A QUOTE
         MVC   MSGTEXT1+8+1(44),DSNAME  ADD THE DATA SET NAME
         LH    R15,DSNLEN               DSNAME ACTUAL LENGTH
         LA    R2,MSGTEXT1+8(R15)       POINT TO CURRENT BYTE
         TM    FLAGSAA,FMEMBER1+FMEMBER2  ALL MEMBERS DESIRED?
         BZ    SPFALLM                    YES, BRANCH
         SPACE 1
         MVI   1(R2),C'('               MEMBER NAME PARENTHESIS
         MVC   2(8,R2),DIRNAME          ADD MEMBER NAME
         MVI   10(R2),X'40'             INSURE SCAN STOPS
         LA    R2,1(,R2)                SCAN
         CLI   0(R2),X'40'                  FOR FIRST
         BNE   *-8                                   BLANK
         MVI   0(R2),C')'               ADD FINAL PARENTHESIS
         SPACE 2
SPFALLM  MVI   1(R2),C''''              ADD FINAL QUOTE
         MVI   2(R2),X'40'              ADD FINAL BLANK
         LA    R2,MSGTEXT1              FIRST PARAMETER
         LA    R3,MSGTEXT1+8            SECOND PARAMETER
         LA    R4,VOLUME                THIRD PARAMETER
         LA    R5,PASSWORD              FOURTH PARAMETER
         STM   R2,R5,MSGTEXT2           SAVE PARAMETER ADDRESSES
         MVI   MSGTEXT2+12,X'80'        MARK END OF LIST (FOUR ITEMS)
         SPACE 1
         LA    R1,MSGTEXT2              PARAMETER LIST
         LINK  EPLOC=ISPLINK,SF=(E,LINKSFL)  SPF INTERFACE ROUTINE
         BAL   R2,CLEAR2                TURN OFF FULL SCREEN MODE
         CLI   MSGTEXT1,C'B'            BROWSE SUBCOMMAND?
         BE    NEWSTAX                  YES, ISSUE A STAX AGAIN
         B     RESTART4                 OPEN THE DATA SET AGAIN
.NOSPFX3 ANOP
         EJECT
***********************************************************************
***    TSOLIST SUBCOMMAND      ADDED BY BRUCE LELAND -- JULY, 1981  ***
***                                                                 ***
***    SUBMIT SUBCOMMAND       ADDED BY BRUCE LELAND -- NOV, 1977   ***
***                                                                 ***
***    PRINTOFF SUBCOMMAND     ADDED BY BRUCE LELAND -- JULY, 1981  ***
***********************************************************************
*
         SPACE 1
TSOLIST  LA    R3,LISTLIT                 "LIST    "
         B     COMMAND1
         SPACE 1
SUBMIT   DS    0H
         SPACE 1
PRINTOFF LA    R3,SUBNAME                 "PRINTOFF" OR "SUBMIT  "
         SPACE 1
COMMAND1 MVC   MSGTEXT1+4(8),0(R3)        LIST, SUBMIT OR PRINTOFF
         MVI   MSGTEXT1+12,C''''          ADD A QUOTE
         MVC   MSGTEXT1+13(44),DSNAME     ADD THE DATA SET NAME
         LH    R15,DSNLEN                 DSNAME ACTUAL LENGTH
         LA    R1,13(,R15)                LENGTH OF "PRINTOFF'"
         LA    R2,MSGTEXT1+13(R15)        POINT TO CURRENT BYTE
         MVI   0(R2),C'('                 MEMBER NAME PARENTHESIS
         MVC   1(8,R2),DIRNAME            MEMBER NAME
         MVI   1+8(R2),X'40'              INSURE SCAN STOPS
         SPACE 1                                      BLANK
COMMAND2 LA    R1,1(,R1)                  SCAN
         LA    R2,1(,R2)                      FOR
         CLI   0(R2),X'40'                       FIRST
         BNE   COMMAND2                               BLANK
         SPACE 1
         MVC   0(3,R2),=C')'' '           ADD TERMINATOR BYTES
         LA    R1,3(,R1)                  ACCOUNT FOR ")' "
         LA    R2,COMMDSTR                START OF ANY ADDED TEXT
         SR    R2,R1                      WHERE TO START MESSAGE
         LR    R14,R1                     CURRENT MESSAGE LENGTH
         BCTR  R14,0                      MESSAGE MACHINE LENGTH
         MVC   0(*-*,R2),MSGTEXT1         <<EXECUTED>>
         EX    R14,*-6                    MOVE IN MESSAGE TEXT
         AH    R1,COMMDLTH                ADD REMAINING LENGTH
         SLL   R1,16                      CLEAR BOTTOM TWO BYTES
         STCM  R1,15,0(R2)                SAVE STRING TOTAL LENGTH
*        MESSAGE (R2)                     DELETE * TO OUTPUT COMMAND
         MVI   3(R2),8                    OPERAND OFFSET
         ST    R2,ADDRTEXT                COMMAND ADDRESS
         LA    R1,ADDRTEXT                ADDRESS OF THE CPPL
         LINK  EPLOC=(R3),SF=(E,LINKSFL)  GO DO THE COMMAND
         B     NEWSTAX                    DO THE NEXT COMMAND
         EJECT
***********************************************************************
***   RESTORE SUBCOMMAND    MODIFIED BY BRUCE LELAND -- JUNE, 1982  ***
***********************************************************************
*
         SPACE 1
RESTORE  MVC   MEMBERD+1(2+8),LMEMBER1  CHANGE DEFAULT MEMBER NAME
         MVI   MEMBERD,FMEMBER1         ONLY ONE MEMBER NAME NOW
         SPACE 2
         BAL   R14,CHKUSER              VERIFY DISP=OLD IF REQUIRED
         ICM   R1,15,MEMBER2            TTR TO BE USED
         CLI   LMEMBER2+1,1             COMPARE LENGTH:1
         BH    RESTOR2                    HIGH (DO NOT ADJUST)
         SRL   R1,8
         BE    RESTOR2                    EQUAL (ADJUSTED ONE TIME)
         SRL   R1,8                       LOW (ADJUSTED TWICE)
         SPACE 2
RESTOR2  STCM  R1,15,DIRTTR             SAVE THE UPDATED ADDRESS
         MVC   DIRNAME,MEMBER1          MEMBER NAME TO BE RESTORED
         MVI   DIRFLAG,X'00'            MEMBER, NO ADDITIONAL HALFWORDS
         SPACE 1
         LA    R1,MSGTOBIG
         CLC   DIRTTR(3),DS1LSTAR       IN DATA SET BOUNDS?
         BNL   MSGNEW                   NO, ERROR
         MVI   STARTTR+2,X'01'          TTR=000001 (START OF DIRECTORY)
         SPACE 2
RESTOR4  BAL   R14,READDIR              GET NEXT DIRECTORY MEMBER
         B     RESTOR5                  LAST MEMBER PROCESSED
         SPACE
         CLC   DIRTTR,MEMTTR            TTR'S MATCH?
         BNE   RESTOR4                  NO, BRANCH
         SPACE
         MVC   MSGTEXT1,MSGNORES        MEMBER ALREADY EXISTS AT TTR
         MVC   MSGTEXT1+MSGNORE1-MSGNORES(8),MEMNAME
         MESSAGE MSGTEXT1
         SPACE 1
         TM    MEMFLAG,X'80'            ALIAS ENTRY?
         BO    RESTOR4                  YES, CONTINUE SEARCHING
         SPACE 1
         CLC   =C'TEMP',DIRNAME         ALLOW IT ANYWAY?
         BNE   NEWCMD                   NO, BRANCH
         EJECT
RESTOR5  TM    FLAGSDD,RECFMU      LOAD LIBRARY?
         BNO   RESTOR98            NO, STOW AND QUIT
         XC    DIRUSER,DIRUSER     CLEAR THE ADDITIONAL FIELDS
         MVI   DIRFLAG,X'20'+12    1 TEXT TTR, 12 HALFWORDS
         MVI   DIRATTR,ATTREXEC    EXECUTABLE
         MVI   DIRATTR+1,ATTRNODC+ATTRZORG+ATTREP0+ATTRFLEV
*                                  NOT DC, ZERO ORG, EP=0, F-LEVEL
         MVI   DIRATTR2,DIRAOSLE+DIRAPFLG  VS EDITOR, APF DATA IS OK
         MVI   DIRAPF,X'01'        APF LENGTH IS ONE, DATA IS ZERO
         XC    FULLWORD,FULLWORD   MAXIMUM BLOCK LENGTH
         LA    R2,RESTOR10         WHERE-TO-GO
         MVC   STARTTR,DIRTTR      START ADDRESS
         SPACE 2
RESTOR6  BAL   R14,EXCP
         B     *+4(R15)                 CHECK RETURN CODE
         B     RESTOR8                  R15=00, GOOD READ
         B     RESTOR90                 R15=04, END OF MEMBER
         B     RESTOR90                 R15=08, END OF DATA SET
         B     PERMERR                  R15=12, I/O ERROR
         SPACE 2
RESTOR8  L     R5,LS                    CURRENT LENGTH
         L     R4,BUFFADDR              START OF BUFFER
         C     R5,FULLWORD              BLKSIZE>MAX?
         BNHR  R2                       NO, BRANCH
         ST    R5,FULLWORD              YES, SAVE NEW MAXIMUM
         BR    R2                       DECODE THE RECORD
         SPACE 3
RESTOR10 MVI   ENTRYPT,C'?'             NO ENTRY POINT NAME YET
         CLI   0(R4),X'40'              TEST SYM RECORD?
         BNE   RESTOR12                 NO, BRANCH
         OI    DIRATTR,ATTRTEST         TEST SYM FLAG
         OI    DIRATTR+1,ATTRSYMS       SYMBOLS ARE AVAILABLE
         SPACE 1
RESTOR12 LA    R2,RESTOR12              WHERE-TO-GO NEXT
         CLI   0(R4),X'40'              TEST SYM RECORD?
         BE    RESTOR6                  YES, GET NEXT RECORD
         SPACE
         CLI   0(R4),X'20'              CESD RECORD?
         BNE   RESTOR20                 NO, BRANCH
         SPACE
         LH    R6,4(,R4)                CURRENT ESDID
         LA    R3,8(,R4)                START OF ESD DATA
         LH    R5,6(,R4)                LENGTH OF DATA IN BUFFER
         AR    R5,R3                    END OF DATA
         LA    R4,16                    LENGTH OF ONE ENTRY
         SR    R5,R4                    END OF DATA -(ONE ENTRY LENGTH)
         EJECT
         USING ESDNAME,R3
RESTOR13 IC    R0,ESDTYPE
         LA    R1,CODESEG          CHECK FOR SEGTAB/ENTAB
         NI    ESDTYPE,X'0F'
         NR    R0,R1
         CLI   ESDTYPE,CODESD      VALID EXTERNAL SYMBOL?
         BE    RESTOR14            YES, BRANCH
         CLI   ESDTYPE,CODELR      EXTERNAL REFERENCE?
         BNE   RESTOR17            NO, BRANCH
         SPACE
RESTOR14 CLI   ESDSEG#,1           SYMBOL IN ROOT SEGMENT?
         BNE   RESTOR17            NO, BRANCH
         CLC   ESDNAME,DIRNAME     THIS MEMBER NAME?
         BNE   RESTOR15            NO, BRANCH
         SR    R14,R14
         ICM   R14,7,ESDADDR        ENTRY ADDRESS ZERO?
         BZ    *+8                  YES, BRANCH
         NI    DIRATTR+1,FF-ATTREP0 NO, INSURE ATTR FLAG OFF
         STCM  R14,B'0111',DIREPA  MOVE ENTRY ADDRESS TO DIRECTORY
         MVC   ENTRYPT,ESDNAME     SAVE THE NAME FOR LATER
         STCM  R6,3,DIRSCEP        SAVE THE ESDID OF THE ENTRY POINT
         SPACE
RESTOR15 OC    ESDADDR(3),ESDADDR  ZERO OFFSET?
         BNZ   RESTOR17            NO, BRANCH
         CLI   ENTRYPT,C'?'        ANY SYMBOL NAME YET?
         BNE   RESTOR17            YES, BRANCH
         MVC   ENTRYPT,ESDNAME     SAVE THE NAME FOR LATER
         STCM  R6,3,DIRSCEP        SAVE THE ESDID OF THE ENTRY POINT
RESTOR17 CR    R0,R1               THIS SEGTAB/ENTAB ENTRY?
         BE    RESTOR18            YES, BRANCH
         CLI   ESDTYPE,CODESD      EXTERNAL DEFINITION?
         BE    RESTOR18            YES, BRANCH
         CLI   ESDTYPE,CODEPC      PRIVATE CODE?
         BE    RESTOR18            YES, BRANCH
         CLI   ESDTYPE,CODECM      COMMON STORAGE?
         BNE   RESTOR19            NO, BRANCH
         SPACE 1
RESTOR18 L     R1,ESDADDR-1        RELATIVE OFFSET
         L     R14,ESDLEN-1        LENGTH OF ESD ENTRY
         LA    R14,7(R1,R14)       MAXIMUM DISPLACEMENT +7
         N     R14,=X'FFFFFFF8'    ROUND TO NEXT DOUBLE WORD
         CLM   R14,7,DIRSTORE      SMALLER THAN PREVIOUS HIGH?
         BL    *+8                 YES, BRANCH
         STCM  R14,7,DIRSTORE      NO, UPDATE MODULE LENGTH
         OC    ESDADDR,ESDADDR     ORIGIN AT LOCATION ZERO?
         BNZ   RESTOR19            NO, BRANCH
         OC    ESDLEN,ESDLEN       NULL LENGTH BLOCK?
         BZ    RESTOR19            YES, BRANCH
         STCM  R6,3,DIRSCET        SAVE THE FIRST TEXT ESDID
         SPACE 1
RESTOR19 A     R6,=F'1'            NEXT ESDID
         BXLE  R3,R4,RESTOR13
         B     RESTOR6             GET NEXT RECORD
         DROP  R3
         EJECT
RESTOR20 LA    R2,RESTOR20         WHERE-TO-GO NEXT
         CLI   0(R4),X'80'         IDR RECORD?
         BE    RESTOR6             YES, GET NEXT RECORD
         SPACE
         LA    R2,RESTOR30         WHERE-TO-GO NEXT
         CLI   0(R4),X'0D'         FILLER RECORD?
         BNE   RESTOR30            NO, BRANCH
         OI    DIRATTR+1,ATTRNRLD  NO RLD ENTRIES
         OI    DIRATTR,ATTR1TXT    ASSUME ONLY ONE TEXT RECORD TOO
         SPACE
RESTOR30 CLI   0(R4),X'01'         RLD ENTRY?
         BE    RESTOR6             YES, IGNORE
         SPACE 1
         CLI   0(R4),X'0D'         FILLER RECORD?
         BE    RESTOR6             YES, IGNORE
         SPACE 1
         TM    DIRATTR+1,ATTRNRLD  NO RLD MARKED?
         BNO   RESTOR33            NO, BRANCH
         CLM   R5,7,DIRSTORE       FIRST TEXT LENGTH=TOTAL LENGTH?
         BE    RESTOR33            YES, ONLY ONE TEXT BLOCK
         NI    DIRATTR,FF-ATTR1TXT NO, MULTI-BLOCK TEXT AND NO RLD
         SPACE 1
RESTOR33 BAL   R14,CCHHRTTR        CONVERT CCHHR TO TTR
         CLI   0(R4),X'10'         SCATTER LOADED?
         BE    RESTOR60            YES, BRANCH
         STCM  R0,B'1110',DIRSTART RESULT TTR
         STCM  R5,3,DIRTEXTL       SAVE LENGTH OF FIRST TEXT RECORD
         LA    R2,RESTOR6          WHERE-TO-GO NEXT TIME
         CLI   0(R4),X'00'         OVERLAY DEFINITION RECORD?
         BNER  R2                  NO, LOOP UNTIL END OF MEMBER
         LA    R2,RESTOR40         WHERE-TO-GO NEXT
         OI    DIRATTR,ATTROVLY    OVERLAY MODULE
         XI    DIRFLAG,X'40'+X'20' TWO USER TTR'S NOW
         LA    R14,7(,R5)
         N     R14,=X'FFFFFFF8'    ROUND TO NEXT DOUBLE WORD
         OC    DIREPA(3),DIREPA    NON-ZERO ENTRY POINT?
         BNZ   RESTOR6             YES, BRANCH
         STCM  R14,B'0111',DIREPA  MOVE ENTRY ADDRESS TO DIRECTORY
         NI    DIRATTR+1,FF-ATTREP0  INSURE ATTR FLAG OFF
         MVI   ENTRYPT,C'?'        ENTRY POINT ADDRESS IS NOT KNOWN
         B     RESTOR6
         SPACE 1
RESTOR40 SRL   R5,2                LENGTH/4
         STC   R5,DIRNOTE#         NUMBER OF ENTRIES
         BAL   R14,CCHHRTTR        CONVERT CCHHR TO TTR
         STCM  R0,B'1110',DIRNOTE  SAVE OVERLAY TABLE TTR
         B     RESTOR6             CONTINUE UNTIL END-OF-MEMBER
         SPACE 2
RESTOR60 STCM  R0,B'1110',DIRNOTE  START OF SCATTER LIST TABLE
         LA    R2,RESTOR63         WHERE-TO-GO NEXT
         MVI   DIRFLAG,X'40'+16    2 TEXT TTRS, 16 HALFWORDS
         OI    DIRATTR,ATTRSCAT    SCATTER LOADED MODULE
         MVI   DIRAPF3,X'01'       APF DATA IS 1 BYTE, NOT AUTHORIZED
         SR    R3,R3               ACCUMULATE LENGTH OF OVERLAY RECORDS
         SPACE 1
RESTOR63 CLI   0(R4),X'10'           SCATTER DEFINITION RECORD?
         BNE   RESTOR65              NO, BRANCH
         AR    R3,R5                 ACCUMULATE SCATTER RECORD LENGTH
         SH    R3,=H'4'              LESS THE HEADER AMOUNT
         B     RESTOR6               CONTINUE FOR ALL SCATTER RECORDS
         SPACE 1
RESTOR65 LA    R2,RESTOR67           WHERE-TO-GO NEXT
         CLI   0(R4),X'0D'           FILLER RECORD?
         BNE   RESTOR67              NO, BRANCH
         OI    DIRATTR+1,ATTRNRLD    NO RLD ENTRIES
         OI    DIRATTR,ATTR1TXT      ASSUME ONLY ONE TEXT RECORD TOO
         SPACE
RESTOR67 CLI   0(R4),X'01'           RLD ENTRY?
         BE    RESTOR6               YES, IGNORE
         SPACE 1
         CLI   0(R4),X'0D'           FILLER RECORD?
         BE    RESTOR6               YES, IGNORE
         SPACE 1
         TM    DIRATTR+1,ATTRNRLD    NO RLD MARKED?
         BNO   RESTOR69              NO, BRANCH
         CLM   R5,7,DIRSTORE         FIRST TEXT LENGTH=TOTAL LENGTH?
         BE    RESTOR69              YES, ONLY ONE TEXT BLOCK
         NI    DIRATTR,FF-ATTR1TXT   NO, MULTI-BLOCK TEXT AND NO RLD
         SPACE 1
RESTOR69 BAL   R14,CCHHRTTR          CONVERT CCHHR TO TTR
         STCM  R0,B'1110',DIRSTART   START OF TEXT
         STCM  R5,3,DIRTEXTL         LENGTH OF FIRST TEXT RECORD
         CH    R6,=H'400'            MORE THAN 400 ESDID'S?
         BNH   *+8                   NO, BRANCH
         A     R6,=F'1'              YES, ADD ONE TO LENGTH
         AR    R6,R6                 MAXIMUM ESDID*2
         STCM  R6,B'0011',DIRSCTL    SAVE LENGTH OF TRANSLATE TABLE
         SR    R3,R6
         STCM  R3,B'0011',DIRSCLL    SAVE LENGTH OF SCATTER LIST
         LA    R2,RESTOR6            WHERE-TO-GO NEXT TIME
         BR    R2                    SCAN UNTIL END-OF-MEMBER
         SPACE 2
RESTOR90 LA    R1,MSGNOTXT
         OC    DIRSTART(3),DIRSTART  ANY TEXT TTR?
         BZ    MSGNEW                NO, ERROR
         SPACE
         LA    R1,MSGNOESD
         OC    DIRSTORE(3),DIRSTORE  STORAGE SIZE AVAILABLE?
         BZ    MSGNEW                NO, ERROR
         SPACE
         CLC   FULLWORD+2(2),=H'1024'  LARGEST BLOCK=1024?
         BNE   RESTOR98                NO, PROBABLY NOT DC
         NI    DIRATTR+1,FF-ATTRNODC   YES, TURN OFF NO DC
         EJECT
RESTOR98 BAL   R2,OPENSTOW         OPEN THE STOW DCB IF REQUIRED
         BZ    NEWCMD              DID NOT OPEN -- QUIT
         MVC   DCBRELAD-IHADCB+STOWDCB,DIRTTR  TTR
         MVI   DCBRELAD-IHADCB+STOWDCB+3,0        0
         STOW  STOWDCB,DIRNAME,A   ADD AT THE GIVEN TTR
         SPACE
         B     *+4(R15)            PROCESS RETURN CODE
         B     RESTOR99            00 - ADDED CORRECTLY
         B     MEMEXIST            04 - NAME ALREADY IN THE DIRECTORY
         EX    0,*                 08 - SHOULD NOT HAPPEN WITH ADD
         B     FULLDIR             12 - DIRECTORY IS ALREADY FULL
         B     IOERROR             16 - I/O ERROR IN THE DIRECTORY
         SPACE
RESTOR99 MESSAGE MSGRESTO          RESTORED MESSAGE
         TM    FLAGSDD,RECFMU      LOAD LIBRARY?
         BNO   NEWCMD              NO, DONE
         SPACE 1
         BAL   R2,EPA#LEN          PROVIDE ENTRY ADDRESS AND LENGTH
         SPACE 1
         CH    R6,=H'800'          MORE THAN 400 (*2) ESDID'S?
         BL    NEWCMD              NO, BRANCH
         TM    DIRATTR,ATTRSCAT    SCATTER LOADED?
         BNO   NEWCMD              NO, BRANCH
         LA    R1,MSGSCAT          YES, WARN OF POSSIBLE ERRORS
         B     MSGNEW
         EJECT
***********************************************************************
***      DIRENTRY SUBCOMMAND   ADDED BY BRUCE LELAND -- JUNE, 1982  ***
***                                                                 ***
***      FIND SUBCOMMAND    MODIFIED BY BRUCE LELAND -- JUNE, 1982  ***
***                                                                 ***
***      LIST SUBCOMMAND    MODIFIED BY BRUCE LELAND -- JUNE, 1982  ***
***********************************************************************
*
         SPACE 1
DIRENTRY IC    R1,DIRFLAG
         N     R1,=XL4'0000001F'   NUMBER OF HALFWORDS
         LA    R5,12(R1,R1)        LENGTH IN BYTES
         LA    R6,DIRNAME          START OF DIRECTORY ENTRY
         LA    R4,16               DUMP FORMAT, WIDTH=16
         XC    FULLWORD,FULLWORD   INITIAL BYTE DISPLACEMENT
         MVC   MSGTEXT2,MSGDUMP
         CVD   R5,DOUBLE
         ED    MSGTEXT2+MSGDUMPL-MSGDUMP(7),DOUBLE+5
         AR    R5,R6
         BCTR  R5,0
         MVC   MSGTEXT2+MSGDUMPB-MSGDUMP(20),DUMPDIR
         LH    R1,MSGTEXT2
         SH    R1,=H'12'
         STH   R1,MSGTEXT2
         LA    R3,LIST30           PROCESSING ROUTINE
         BR    R3
         SPACE 2
*
FIND     CLI   FINDLTH+1,0         STRING EVER CODED?
         LA    R1,MSGFINDN
         BZ    MSGNEW              NO, ERROR
         SPACE 2
*
LIST     XC    BLKCOUNT,BLKCOUNT   BLKCOUNT=0
         NI    FLAGSEE,FF-DONONUM  TURN OFF THE NUM-->NONUM FLAG
         OC    MAXOUT,MAXOUT       ANY OUTPUT DESIRED?
         BZ    NEWCMD              NO, BRANCH
         MVC   STARTTR,DIRTTR      FIRST TTR
         EJECT
LIST1    BAL   R14,EXCP
         B     *+4(R15)                 CHECK RETURN CODE
         B     LIST3                    R15=00, GOOD READ
         B     LIST2                    R15=04, END OF MEMBER
         B     LIST98                   R15=08, END OF DATA SET
         B     PERMERR                  R15=12, I/O ERROR
         SPACE 1
LIST2    TM    DSORG,DS1DSGIS           ISAM DATA SET?
         BNO   LIST98                   NO, BRANCH
         MESSAGE MSGEOF                 YES, OUTPUT A MESSAGE
         B     LIST1                    CONTINUE
         SPACE 1
LIST3    L     R5,LS                    CURRENT LENGTH
         L     R6,BUFFADDR              START OF BUFFER
         LR    R1,R5                    SAVE BLOCKSIZE FOR LATER
         TM    FLAGSEE,BLOCK            BLOCK OUTPUT DESIRED?
         BO    LIST20                   YES, BRANCH
         TM    FLAGSEE,DUMP             DUMP OUTPUT DESIRED?
         BO    LIST24                   YES, BRANCH
         AR    R5,R6                    ADDRESS OF END OF BUFFER
         BCTR  R5,0                     END OF BUFFER ADDRESS
         LA    R3,LIST8                 ASSUME FIXED OR UNDEFINED
         TM    FLAGSDD,RECFMF           RECFM=F?
         LH    R4,LRECL                 GET RECORD LENGTH
         BOR   R3                       YES, BRANCH
         SPACE 1
         TM    FLAGSDD,RECFMU           RECFM=U?
         LR    R4,R1                    BLOCK LENGTH
         BOR   R3                       YES, BRANCH
         TM    FLAGSDD,RECFMV           RECFM=V?
         BNOR  R3                       NO, PROCESS LIKE RECFM=U
         SPACE 1                        SET END OF BUFFER ADDRESS
         AH    R6,=H'4'                 RECFM=V; START OF LRECL'S
         LA    R3,LIST6                 VARIABLE LEN RECORD PROCESSOR
         SPACE 1
LIST6    LH    R4,0(,R6)                GET LOGICAL RECORD LENGTH
         AH    R6,=H'4'                 SKIP OVER HEADER
         SH    R4,=H'4'                 SUBTRACT HEADER LENGTH
         BP    LIST8                    BRANCH IF RECORD EXISTS
         SR    R4,R4                    NO, RESET LENGTH TO ZERO
         SPACE 1
LIST7    BXLE  R6,R4,0(R3)              SKIP TO NEXT RECORD
         CLI   SUBNAME,C'D'             DIRENTRY SUBCOMMAND?
         BE    NEWCMD                   YES, BRANCH
         TM    FLAGSEE,MULTI+LDUMP      MULTILINE OR LINEDUMP?
         BZ    LIST1                    NO, GET A NEW BLOCK
         LM    R3,R6,LISTR3R6           RESTORE R3-R6
         BXLE  R6,R4,0(R3)              SKIP TO NEXT RECORD
         B     LIST1                    REAL END OF BLOCK
         EJECT
LIST8    L     R0,BLKCOUNT
         A     R0,=F'1'
         ST    R0,BLKCOUNT
         L     R0,SKIPREC
         S     R0,=F'1'                   SKIP THIS RECORD?
         ST    R0,SKIPREC
         BNM   LIST7                      YES, BRANCH
         L     R0,MAXIN
         S     R0,=F'1'                   SUFFICIENT INPUT RECORDS?
         ST    R0,MAXIN
         BM    NEWCMD                     YES, BRANCH
LIST9    LR    R1,R4                      LENGTH OF DATA AREA
         STM   R3,R6,LISTR3R6             SAVE FOR MULTILINE/LINEDUMP
         TM    FLAGSEE,MULTI              MULTILINE?
         BO    LIST20                     YES, BRANCH
         TM    FLAGSEE,LDUMP              LINEDUMP?
         BO    LIST24                     YES, BRANCH
         LA    R0,8                       WIDTH OF LINE NUMBER FIELD
         LR    R15,R6                     MOVE START POSITION
         LR    R14,R15                    LINE NUMBER FOR RECFM=V OR U
         A     R15,SKIPCOL                ADJUST START FOR START COLUMN
         S     R1,SKIPCOL                 ADJUST LEN FOR START COLUMN
         TM    FLAGSEE,NONUM+DONONUM      NONUM FORMAT?
         BNZ   LIST16                     YES, BRANCH
         AR    R15,R0                     ADJUST START FOR RECFM=V OR U
         SR    R1,R0                      ADJUST LENGTH, RECFM=V U OR F
         TM    FLAGSDD,RECFMF             RECFM=F?
         BNO   LIST11                     NO, BRANCH
         SR    R15,R0                     CORRECT DATA START POINTER
         LA    R14,0(R4,R6)               END OF LINE
         SR    R14,R0                     START OF LINE NUMBER
LIST11   TM    FLAGSEE,SNUM               SNUM FORMAT?
         BO    LIST16                     YES, BRANCH
         MVC   MSGTEXT1+4(8),0(R14)       NUM FORMAT -- GET LINE NUMBER
         NC    MSGTEXT1+4(8),=C'00000000' DROP NUMERIC PART
         CLC   MSGTEXT1+4(8),=C'00000000' ZONE DIGITS FOR ALL BYTES?
         BE    LIST13                     YES, BRANCH
         OI    FLAGSEE,DONONUM            CONTINUE WITH NONUM FORMAT
         B     LIST9
         SPACE 1
LIST13   MVC   MSGTEXT1+4(6),0(R14)       SPF LINE NUMBER FIELD
         TM    DIRFLAG,X'0F'              SPF ATTRIBUTES STORED?
         BO    LIST15                     YES, BRANCH
         LA    R0,5                       MAXIMUM OF 5 DIGITS TO BLANK
         LA    R2,MSGTEXT1+3              START OF FIELD TO BLANK
         MVC   MSGTEXT1+4(6),2(R14)       LINE NUMBER FIELD
LIST14   LA    R2,1(,R2)
         CLI   0(R2),C'0'                 BLANK LEADING ZEROES IN THE
         BNE   LIST15                        LINE NUMBER FIELD
         MVI   0(R2),X'40'
         BCT   R0,LIST14                  DO UP TO 5 DIGITS
LIST15   LA    R0,249                     MAXIMUM ALLOWED DATA LENGTH
         MVI   MSGTEXT1+10,X'40'          BLANK AFTER LINE NUMBER
         LA    R14,MSGTEXT1+11            WHERE TO MOVE DATA
         B     LIST17
         SPACE 2
LIST16   LA    R0,256                   MAXIMUM LRECL TO DISPLAY
         LA    R14,MSGTEXT1+4           WHERE TO MOVE OUTPUT DATA
         SPACE 1
LIST17   CR    R1,R0                    LENGTH>MAXIMUM ALLOWED?
         BL    *+6                      NO, BRANCH
         LR    R1,R0                    YES, USE MAXIMUM
         S     R1,=F'1'                 MACHINE LENGTH VALID?
         BM    LIST18                   NO, BRANCH
         MVC   0(*-*,R14),0(R15)        <<EXECUTED>>
         EX    R1,*-6                   MOVE DATA INTO LINE
         SPACE 1
LIST18   LR    R2,R1                    MACHINE LENGTH
         LA    R1,MSGTEXT1+4            START OF DATA
         CR    R14,R1                   NUM MODE?
         BE    *+8                      NO, BRANCH
         AH    R2,=H'7'                 YES, ACCOUNT FOR LINE NO, BLANK
         A     R2,=F'1'                 ACTUAL DATA LENGTH
         C     R2,MAXLEN                LENGTH>MAXLEN?
         BL    *+8                      NO, BRANCH
         L     R2,MAXLEN                YES, USE MAXLEN INSTEAD
         S     R2,=F'1'                 MACHINE LENGTH VALID?
         BM    LIST7                    LENGTH=0, BRANCH
         LA    R0,5(,R2)                ACTUAL LINE LENGTH + HALFWORDS
         SLL   R0,16
         ST    R0,MSGTEXT1              CREATE OUTPUT LINE HEADER
         CLI   SUBNAME,C'F'             FIND OPERATION?
         BNE   LISTOUT2                 NO, LIST -- BRANCH
         SPACE 1
         LA    R14,1(R1,R2)             END OF DATA
         LH    R15,FINDLTH              STRING LENGTH
         BCTR  R15,0                    MACHINE LENGTH
FIND19   EX    R2,FINDTRT               FIRST CHARACTER FOUND?
         BZ    LIST7                    NO, NOT IN STRING, QUIT
         LR    R2,R14
         SR    R2,R1                    MACHINE LENGTH LEFT
         CR    R15,R2                   POSSIBLY IN STRING?
         BNL   LIST7                    NO, QUIT
         EX    R15,FINDCLC              ENTIRE STRING FOUND?
         BE    LISTOUT2                 YES, OUTPUT THE LINE
         LA    R1,1(,R1)                NO, TRY NEXT CHARACTER
         LR    R2,R14
         SR    R2,R1                    MACHINE LENGTH LEFT NEGATIVE?
         BM    LIST7                    YES, NOT IN STRING, QUIT
         B     FIND19                   CONTINUE SEARCHING
         SPACE 2
FINDTRT  TRT   0(*-*,R1),FINDTBL        <<EXECUTED>> -- FIRST BYTE
FINDCLC  CLC   0(*-*,R1),FINDSTR        <<EXECUTED>> -- COMPLETE STRING
         EJECT
LIST20   L     R4,LINESIZE              BLOCK FORMAT, WIDTH=LINESIZE-10
         S     R4,=F'10'
         LA    R3,LIST28                PROCESSING ROUTINE
         L     R0,SKIPCOL               START COLUMN ADJUSTMENT AMOUNT
         A     R0,=F'1'                 PLUS ONE
         ST    R0,FULLWORD              INITIAL BYTE COUNTER
         B     LIST25                   FORMAT HEADER
         SPACE 2
LIST24   LA    R4,16                    DUMP FORMAT, WIDTH=16
         LA    R3,LIST30                PROCESSING ROUTINE
         MVC   FULLWORD,SKIPCOL         INITIAL BYTE DISPLACEMENT
         SPACE 1
LIST25   MVC   MSGTEXT2,MSGDUMP         HEADER FOR BLOCK OR DUMP
         NI    FLAGSEE,FF-OVERLAP       TURN OF THE OVERLAP INDICATOR
         LR    R5,R1                    DATA LENGTH
         C     R5,MAXLEN                RESTRICT DATA LENGTH?
         BL    *+8                      NO, BRANCH
         L     R5,MAXLEN                YES, USE MAX LENGTH
         AR    R5,R6                    COMPUTE NEW END-OF-BLOCK
         BCTR  R5,0                     COMPUTE NEW END-OF-BLOCK -1
         A     R6,SKIPCOL               ADJUST FOR START COLUMN
         TM    FLAGSEE,MULTI+LDUMP      MULTILINE OR LINEDUMP?
         BMR   R3                       YES, BRANCH
         L     R0,BLKCOUNT
         A     R0,=F'1'
         ST    R0,BLKCOUNT
         CVD   R0,DOUBLE
         ED    MSGTEXT2+MSGDUMPR-MSGDUMP(7),DOUBLE+5
         L     R0,SKIPREC
         S     R0,=F'1'                 SKIP THIS RECORD?
         ST    R0,SKIPREC
         BNM   LIST1                    YES, BRANCH
         L     R0,MAXIN
         S     R0,=F'1'                 SUFFICIENT INPUT RECORDS?
         ST    R0,MAXIN
         BM    NEWCMD                   YES, BRANCH
         CVD   R1,DOUBLE
         ED    MSGTEXT2+MSGDUMPL-MSGDUMP(7),DOUBLE+5
         SPACE 1
         BAL   R14,CCHHRTTR             CONVERT CCHHR --> TTR
         ST    R0,DOUBLE                SAVE RESULTING TTR
         SPACE 1
         UNPK  MSGTEXT2+MSGDUMPT-MSGDUMP(7),DOUBLE(4)
         TR    MSGTEXT2+MSGDUMPT-MSGDUMP(6),TRTABLE
         TM    FLAGSEE,DUMP
         BNOR  R3
         MVC   MSGTEXT2+MSGDUMPB-MSGDUMP(5),DUMPDIR
         BR    R3
         SPACE 6
LIST28   LR    R2,R4                    DATA LENGTH
         LR    R14,R5
         SR    R14,R6                   MACHINE LENGTH VALID?
         BM    LIST7                    NO, BRANCH
         CR    R2,R14
         BNH   *+8
         LA    R2,1(,R14)               DATA LENGTH FOR THIS SEGMENT
         BCTR  R2,0                     MACHINE LENGTH FOR THE SEGMENT
         MVC   MSGTEXT1+11(*-*),0(R6)   <<EXECUTED>>
         EX    R2,*-6                   MOVE IN TEXT
         L     R1,FULLWORD
         CVD   R1,DOUBLE
         AR    R1,R4
         ST    R1,FULLWORD
         MVC   MSGTEXT1+4(6),=X'402020202120'
         ED    MSGTEXT1+4(6),DOUBLE+5
         MVI   MSGTEXT1+10,X'40'
         LA    R1,12(,R2)               OUTPUT LENGTH
         B     LIST38                   FINISH FIND PROCESSING
         SPACE 2
LIST30   CLEAR MSGTEXT1                 DATA LENGTH
         LR    R2,R4                    DATA LENGTH
         LR    R14,R5
         SR    R14,R6                   MACHINE LENGTH VALID?
         BM    LIST7                    NO, BRANCH
         CR    R2,R14
         BNH   *+8
         LA    R2,1(,R14)               DATA LENGTH FOR THIS RECORD
         BCTR  R2,0                     MACHINE LENGTH FOR THE RECORD
         LA    R15,MSGTEXT1+6           PRINT AREA ADDR
         MVI   46(R15),C'*'             BEGINNING *
         MVC   47(*-*,R15),0(R6)        <<EXECUTED>>
         EX    R2,*-6                   MOVE IN TEXT
         LA    R1,47+1(R15,R2)
         MVI   0(R1),C'*'               FINAL *
         UNPK  0(7,R15),FULLWORD+1(4)   UNPACK ADDRESS
         TR    0(6,R15),TRTABLE         CONVERT TO HEXADECIMAL
         MVI   6(R15),X'40'             BLANK THE FOLLOWING BYTE
         L     R1,FULLWORD              HEX
         AR    R1,R4                       BYTE
         ST    R1,FULLWORD                     DISPLACEMENT
         LR    R1,R6                    CURRENT DATA POINTER
         LA    R14,1(,R2)               NUMBER OF BYTES TO FORMAT
         SR    R0,R0                    CURRENT FORMATTED CHARACTER
         SPACE 2
LIST33   MVC   DOUBLE(1),0(R1)          AVOID 0C5 FOR LAST BUFFER BYTE
         UNPK  8(3,R15),DOUBLE(2)       UNPACK DATA
         TR    8(2,R15),TRTABLE         CONVERT TO HEXADECIMAL
         MVI   10(R15),X'40'            CLEAR FOLLOWING BYTE
         LA    R15,2(,R15)              INCR INTO PRINT AREA
         A     R1,=F'1'                 INCREMENT INTO DATA
         A     R0,=F'1'                 NEXT FORMATTED CHARACTER
         ST    R0,DOUBLE
         TM    DOUBLE+3,X'03'           4, 8, 12, 16, ...?
         BNZ   LIST35                   NO, BRANCH
         LA    R15,1(,R15)              YES, INCREMENT ONE
         TM    DOUBLE+3,X'07'           8, 16, 24, 32, ...?
         BNZ   LIST35                   NO, BRANCH
         LA    R15,1(,R15)              YES, INCREMENT ONE
LIST35   BCT   R14,LIST33               GO FORMAT
         LA    R1,56(,R2)               OUTPUT LENGTH
         SPACE 1
LIST38   SLL   R1,16                    CREATE OUTPUT LINE HEADER
         ST    R1,MSGTEXT1
         CLI   SUBNAME,C'F'             FIND OPERATION?
         BNE   LISTOUT                  NO, LIST -- BRANCH
         XC    DOUBLE,DOUBLE
         LR    R1,R6                    START OF DATA
         LA    R14,0(R6,R2)             END OF DATA -1
         LH    R15,FINDLTH              STRING LENGTH
         ST    R14,DOUBLE               END OF DISPLAYED PART
         AR    R14,R15                  MAXIMUM ACCESS
         BCTR  R15,0                    MACHINE LENGTH OF STRING
         CR    R14,R5                   BEYOND RECORD END?
         BL    FIND39                   NO, BRANCH
         LR    R14,R5                   YES, USE END OF RECORD -1
         SPACE 1
FIND39   EX    R2,FINDTRT               FIRST CHARACTER FOUND?
         BZ    LISTTST                  NO, NOT IN STRING
         LR    R2,R14
         SR    R2,R1                    MACHINE LENGTH LEFT
         CR    R15,R2                   POSSIBLY IN STRING?
         BH    LISTTST                  NOT IN STRING
         EX    R15,FINDCLC              ENTIRE STRING FOUND?
         BNE   *+8                      NO, BRANCH
         ST    R1,DOUBLE+4              YES, SAVE THE LAST ADDRESS
         LA    R1,1(,R1)                NO, TRY NEXT CHARACTER
         L     R2,DOUBLE                LAST ACCESS BYTE
         SR    R2,R1                    MACHINE LENGTH LEFT NEGATIVE?
         BNM   FIND39                   NO, CONTINUE SEARCHING
         SPACE 2
LISTTST  ICM   R1,15,DOUBLE+4           ANY STRING FOUND?
         BZ    LISTTST2                 NO, BRANCH
         NI    FLAGSEE,FF-OVERLAP       CLEAR THE OVERLAP FLAG
         SR    R1,R6                    DISPLACEMENT INTO DISPLAY
         AH    R1,FINDLTH               LENGTH AT END OF COMPARE
         CR    R1,R4                    BEYOND DISPLAYED LENGTH?
         BNH   LISTOUT                  NO, BRANCH
         OI    FLAGSEE,OVERLAP          YES, MARK AS AN OVERLAP
         B     LISTOUT
LISTTST2 TM    FLAGSEE,OVERLAP          NO STRING FOUND -- OVERLAP SET?
         BNO   LIST7                    NO, BRANCH
         XI    FLAGSEE,OVERLAP          YES, TURN OF THE OVERLAP FLAG
         SPACE 5
LISTOUT  CLI   MSGTEXT2+1,0             ANY HEADER?
         BZ    LISTOUT3                 NO, BRANCH
         CLI   SUBNAME,C'D'             DIRENTRY SUBCOMMAND?
         BE    LISTOUT1                 YES, BRANCH
         CLI   SUBNAME+1,C'Y'           ANY OUTPUT YET?
         BNE   LISTOUT0                 NO, BRANCH
         MESSAGE MSGBLANK               OUTPUT A BLANK LINE
LISTOUT0 TM    FLAGSEE,MULTI+LDUMP      MULTILINE OR LINEDUMP?
         BM    LISTOUT2                 YES, BRANCH
LISTOUT1 MESSAGE MSGTEXT2               OUTPUT THE HEADER LINE
LISTOUT2 MVI   MSGTEXT2+1,0             TURN OFF THE HEADER
         MVI   SUBNAME+1,C'Y'           INDICATE OUTPUT GENERATED
         L     R0,MAXOUT                DECREMENT
         BCTR  R0,0                              THE MAXOUT
         ST    R0,MAXOUT                                   COUNTER
LISTOUT3 EQU   *
         LA    R1,TRTMEM
         LA    R1,256(R1)
         TR    MSGTEXT1+4(256),0(R1)
         MESSAGE MSGTEXT1               OUTPUT THE NEXT LINE
         TM    FLAGSAA,FIND1            FINDLIST MODIFICATION?
         BNO   *+8                      NO, BRANCH
         MVI   SUBNAME,C'1'             YES, NOW LIST THE REST
         OC    MAXOUT,MAXOUT            ANY MORE LINES TO DO?
         BZ    NEWCMD                   NO, BRANCH
         B     LIST7                    YES, CONTINUE
         SPACE 2
LIST98   CLI   SUBNAME+1,C'Y'           ANY OUTPUT DISPLAYED?
         BNE   LIST99                   NO, BRANCH
         TM    FLAGSEE,MULTI+LDUMP+BLOCK+DUMP  SEGMENT FORMAT?
         BZ    LIST99                          NO, BRANCH
         MESSAGE MSGBLANK               OUTPUT A BLANK LINE
LIST99   MVC   MSGTEXT1,MSGBLK
         L     R1,BLKCOUNT
         CVD   R1,DOUBLE
         ED    MSGTEXT1+MSGBLKC-MSGBLK(7),DOUBLE+5
         LA    R1,MSGTEXT1
         TM    FLAGSEE,DUMP+BLOCK
         BNZ   *+10
         MVC   MSGTEXT1+MSGBLKL-MSGBLK(6),=C' LINES'
         TM    DSORG,DS1DSGPO
         BO    MSGNEW
         MVC   MSGTEXT1+MSGDATAS-MSGBLK(8),=C'DATA SET'
         B     MSGNEW
         EJECT
***********************************************************************
***      HELP  SUBCOMMAND      ADDED BY BRUCE LELAND -- JAN, 1980   ***
***********************************************************************
*
         SPACE 2
HELP     MVC   DDNAMEH,DDNAME        SAVE ACTUAL DDNAME
         MVC   DDNAME,=C'SYSHELP '   DDNAME TO FREE
         BAL   R2,DEALLOCZ           FORCE A FREE OF SYSHELP
         L     R2,ADDRCBUF           INPUT BUFFER ADDRESS
         L     R1,ADDRCPPL
         USING CPPL,R1               ACTUAL ADDRESS
         ST    R2,CPPLCBUF           SET COMMAND ADDRESS
         DROP  R1
         LINK  EPLOC=HELPLIT,SF=(E,LINKSFL)
         BAL   R2,DEALLOCZ           FORCE A FREE OF SYSHELP
         MVC   DDNAME,DDNAMEH        RESTORE ACTUAL DDNAME
         B     NEWSTAX               NEXT COMMAND
         SPACE 2
*  NOTE: THE SYSHELP FILE IS FREED BOTH BEFORE AND AFTER THE HELP CALL
*
*    1.  BEFORE - IN CASE A PCF EXIT STATEMENT REQUESTED HELP AND
*                 SYSHELP IS NOT AVAILABLE.
*    2.  AFTER  - SO THAT PCF EXIT STATEMENTS CAN PERFORM AT LEAST
*                 ONE HELP REQUEST.
         EJECT
***********************************************************************
***      X     SUBCOMMAND      ADDED BY BRUCE LELAND -- AUG., 1982  ***
***********************************************************************
*
         SPACE 1
X        LA    R1,PARMLIST                 USE THE SAME PARAMETER LIST
         L     R15,ADDRSCAN                SCAN START ADDRESS
         BALR  R14,R15                     INVOKE COMMAND SCAN
         SPACE 1
         LA    R5,SCANANSR                       ADDR OF ANSWER AREA
         TM    CSOAFLG-CSOA(R5),CSOANOC          EMPTY BUFFER?
         BO    NEWCMD                            YES, NO TSO COMMAND
         TM    CSOAFLG-CSOA(R5),CSOAVWP+CSOAVNP  VALID COMMAND?
         LA    R1,MSGTSOXX                       ASSUME NOT
         BZ    MSGNEW                            NO, BRANCH
         L     R2,CSOACNM-CSOA(,R5)              ADDR OF COMMAND NAME
         LH    R3,CSOALNM-CSOA(,R5)              LENGTH OF NAME
         BCTR  R3,0                              MACHINE LENGTH
         SPACE 1
         MVC   DIRNAME,BLANKS              INITIALIZE WITH BLANKS
         MVC   DIRNAME(*-*),0(R2)          <<EXECUTED>>
         EX    R3,*-6                      MOVE IN THE COMMAND NAME
         BLDL  0,BLDLLIST                  ANY SUCH TSO COMMAND?
         LA    R1,MSGTSOXX                 ASSUME COMMAND NOT FOUND
         LTR   R15,R15                     CORRECT?
         BP    MSGNEW                      YES, BRANCH
         SPACE 1
         L     R1,ADDRCBUF                 COMMAND BUFFER ADDRESS
         ST    R1,ADDRTEXT                 COMMAND ADDRESS
         L     R4,ADDRECT                  ECT ADDRESS
         MVC   ECTPCMD-ECT(8,R4),DIRNAME   COMMAND NAME IS CHANGED
         OI    ECTSWS-ECT(R4),ECTNOPD      ASSUME NO OPERAND
         TM    CSOAFLG-CSOA(R5),CSOAVWP    ANY OPERAND?
         BNO   *+8                         NO, BRANCH
         NI    ECTSWS-ECT(R4),FF-ECTNOPD   YES, ZAP THE NO OPERAND FLAG
         XC    PARMLIST(8),PARMLIST        CLEAR PARAMETER LIST
         SPACE 1
         MVC   DDNAMEH,DDNAME              SAVE ACTUAL DDNAME
         MVC   DDNAME,=C'SYSHELP '         DDNAME TO FREE
         BAL   R2,DEALLOCZ                 FORCE A FREE OF SYSHELP
         MVC   DDNAME,DDNAMEH              RESTORE ACTUAL DDNAME
         SPACE 1
         LA    R1,ADDRTEXT                 CPPL START
         LINK  DE=DIRNAME,SF=(E,PARMLIST)  LINK TO THE COMMAND
         B     NEWSTAX                     ISSUE STAX; GET NEXT COMMAND
         EJECT
***********************************************************************
***      USAGE/DSNAME SUBCOMMANDS                                   ***
***********************************************************************
*
         SPACE 1
USAGE    MVC   MSGTEXT1,MSGDSNDD         ADD DDNAME SKELETON
         LH    R1,MSGTEXT1               LENGTH OF MESSAGE
         LA    R2,MSGTEXT1-1(R1)         LOCATION OF QUOTE +1
         MVC   MSGTEXT1+4+2(8),DDNAME    ADD THE CURRENT DDNAME
         LH    R15,DSNLEN                DSNAME STRING LENGTH
         MVC   0(44,R2),DSNAME           ADD DSNAME
         LA    R1,1(R1,R15)              ALLOW FOR QUOTE AND COMMA
         AR    R2,R15                    ADDRESS OF QUOTE
         MVC   0(11,R2),=C''',DISP=SHR,' ASSUME SHR
         CLI   DSPALLOC,DA08SHR          CORRECT?
         BE    *+10                      YES, BRANCH
         MVC   7(3,R2),=C'OLD'           NO, MUST BE OLD
         LA    R1,9(,R1)                 ADJUST FOR "DISP=XXX,"
         STH   R1,MSGTEXT1               UPDATE MESSAGE LENGTH
         MESSAGE MSGTEXT1
         MVC   MSGTEXT1(24),MSGDCB       "// DCB=(RECFM=, ..."
         IC    R2,FLAGSDD                RECFM BITS
         SLL   R2,29                     DROP TOP BITS
         SRL   R2,29                     REPOSITION
         IC    R2,RECFMTYP(R2)           RECORD FORMAT
         STC   R2,MSGTEXT1+19            MOVE INTO MESSAGE
         LA    R1,MSGTEXT1+20
         TM    SAVRECFM,DCBRECBR         RECFM=.B?
         BNO   *+12                      NO, BRANCH
         MVI   0(R1),C'B'
         LA    R1,1(R1)
         TM    SAVRECFM,DCBRECSB         RECFM=.S?
         BNO   *+12                      NO, BRANCH
         MVI   0(R1),C'S'
         LA    R1,1(R1)
         TM    SAVRECFM,DCBRECTO         RECFM=.T?
         BNO   *+12                      NO, BRANCH
         MVI   0(R1),C'T'
         LA    R1,1(R1)
         TM    SAVRECFM,DCBRECCA         RECFM=.A?
         BNO   *+12                      NO, BRANCH
         MVI   0(R1),C'A'
         LA    R1,1(R1)
         TM    SAVRECFM,DCBRECCM         RECFM=.M?
         BNO   *+12                      NO, BRANCH
         MVI   0(R1),C'M'
         LA    R1,1(R1)
         TM    FLAGSDD,RECFMU            RECFM=U?
         BO    USBLK                     YES, NO LRECL
         SPACE 5
         MVC   0(7,R1),LRECLTXT          MOVE IN LRECL TEXT
         LA    R1,7(R1)
         LH    R4,LRECL
         CVD   R4,DOUBLE
         UNPK  DOUBLE(5),DOUBLE+5(3)
         LA    R4,DOUBLE-1
         LA    R4,1(R4)
         CLI   0(R4),C'0'
         BE    *-8
         OI    DOUBLE+4,X'F0'
USMOVE1  MVC   0(1,R1),0(R4)
         LA    R1,1(R1)
         TM    1(R4),X'F0'
         LA    R4,1(R4)
         BO    USMOVE1
USBLK    MVC   0(9,R1),BLKSITXT
         LA    R1,9(R1)
         LH    R4,BLKSI
         CVD   R4,DOUBLE
         UNPK  DOUBLE(5),DOUBLE+5(3)
         LA    R4,DOUBLE-1
         LA    R4,1(R4)
         CLI   0(R4),C'0'
         BE    *-8
         OI    DOUBLE+4,X'F0'
USMOVE2  MVC   0(1,R1),0(R4)
         LA    R1,1(R1)
         TM    1(R4),X'F0'
         LA    R4,1(R4)
         BO    USMOVE2
         TM    DSORG,DS1DSGPO           PARTITIONED?
         BO    USVOLSER                 NO, BRANCH
         MVC   0(7,R1),DSORGTXT         ADD ,DSORG=
         IC    R2,DSORG                 DSORG BITS
         SLL   R2,24                    DROP TOP BITS
         SRL   R2,28                    REPOSITION BITS *2
         LA    R2,DSORGTYP(R2)          DSORG
         MVC   7(2,R1),0(R2)            MOVE INTO MESSAGE
         TM    DSORG+1,DS1ACBM          VSAM DATA SET?
         BNO   *+10                     YES, BRANCH
         MVC   7(2,R1),=C'VS'
         LA    R1,9(,R1)                SKIP OVER DSORG TEXT
         TM    DS1DSORG,DS1DSGU         UNMOVEABLE?
         BNO   USVOLSER                 NO, BRANCH
         MVI   0(R1),C'U'               ADD U
         LA    R1,1(,R1)                SKIP OVER U
         SPACE 1
USVOLSER MVC   0(10,R1),=C'),VOL=SER='  ADD PAREN, COMMA & VOL KEYWORD
         MVC   10(6,R1),VOLALLOC        ADD THE SERIAL NUMBER
         LA    R4,16(,R1)               INCREMENT THE MESSAGE LENGTH
         LA    R1,MSGTEXT1
         SR    R4,R1
         STH   R4,0(R1)
         MESSAGE (R1)                   OUTPUT THE DCB LINE
         SPACE 5
         CLI   SUBNAME,C'U'             USAGE SUBCOMMAND?
         BNE   NEWCMD                   NO, BRANCH
         TM    DSORG,DS1DSGPO           DSORG=PO?
         BNO   USEDEB                   NO, BRANCH
         MVI   STARTTR+2,X'01'          TTR=000001 (START OF DIRECTORY)
         SPACE 1
         BAL   R14,READDIR              SCAN THROUGH THE DIRECTORY
         SPACE 1
         LA    R2,MSGUSEB               MSG - TOTAL BLOCKS ALLOCATED
         LH    R1,TOTBLOCK              GET COUNTER
         BAL   R4,USEFMT                FORMAT MESSAGE
         SPACE
         LA    R2,MSGUSED               MSG - TOTAL BLOCKS USED
         LH    R1,TOTUSED               GET COUNTER
         BAL   R4,USEFMT
         SPACE
         LA    R2,MSGTRKS               MSG - TOTAL TRACKS IN DIRECTORY
         LH    R1,TOTTRKS               GET COUNTER
         BAL   R4,USEFMT
         SPACE
         LA    R2,MSGMAXM               MSG - MAX. MEMBERS/DIRECTORY
         LH    R1,TOTMAXM               GET COUNTER
         BAL   R4,USEFMT
         SPACE
         LA    R2,MSGUSER               MSG - TOTAL MEMBERS
         LH    R1,TOTMEMR               GET COUNTER
         AH    R1,TOTMEMA
         BAL   R4,USEFMT
         SPACE
         LA    R2,MSGUSEA               MSG - TOTAL ALIASES
         LH    R1,TOTMEMA
         LTR   R1,R1                    ANY ALIASES?
         BZ    *+8                      NO
         BAL   R4,USEFMT
         SPACE 1
USEDEB   L     R1,DCBDEBAD-IHADCB+INDCB GET DEB ADDRESS
         LH    R14,NUMEXT               NUMBER OF EXTENTS
         SR    R0,R0
USEXTNT  AH    R0,32+14(,R1)            ADD NUMBER OF TRACKS IN EXTENT
         LA    R1,16(,R1)               NEXT EXTENT
         BCT   R14,USEXTNT              IF MORE EXTENTS
         STH   R0,DSNTOTAL              SAVE TOTAL D.S. SIZE IN TRACKS
         LH    R1,DS1LSTAR              GET TT OF LAST TRACK
         LA    R1,1(,R1)                JUMP FOR COMPUTATION
         SR    R0,R1
         STH   R0,DSNEMPTY              TOTAL FREE SPACE
         EJECT
         LH    R1,DSNTOTAL              TOTAL SPACE USED
         LA    R2,MSGUSESI              MSG FOR TOTAL SPACE
         BAL   R4,USEFMT
         SPACE
         LH    R1,DSNEMPTY              TOTAL FREE SPACE
         LA    R2,MSGUSEMP
         BAL   R4,USEFMT
         SPACE
         LH    R1,NUMEXT                TOTAL EXTENTS
         LA    R2,MSGUSEXT
         BAL   R4,USEFMT
         B     NEWCMD
         SPACE 2
USEFMT   CVD   R1,DOUBLE                CONVERT COUNTER TO DECIMAL
         SR    R15,R15
USEFMT1  SR    R0,R0
         D     R0,=F'10'                COMPUTE NUMBER OF SIGIF. DIGITS
         LTR   R1,R1                    RESIDUAL FACTOR ZERO?
         LA    R15,1(,R15)
         BNZ   USEFMT1                  NO, KEEP GOING
         LA    R1,MSGTEXT1+4(R15)       YES, WHERE OUTPUT TEXT GOES
         BCTR  R15,0                    EXECUTE LENGTH
         SLL   R15,4                    SHIFT FOR EXECUTED UNPACK
         OI    DOUBLE+7,X'0F'           CORRECT SIGN FOR EXECUTE
         SPACE
         UNPK  MSGTEXT1+4(*-*),DOUBLE   <<EXECUTED>>
         EX    R15,*-6                  UNPACK THIS NUMBER
         SPACE
         LH    R15,0(,R2)
         LA    R0,5
         SR    R15,R0
         MVC   0(*-*,R1),4(R2)          <<EXECUTED>>
         EX    R15,*-6
         LA    R15,1(R1,R15)
         LA    R0,MSGTEXT1
         SR    R15,R0
         SLL   R15,16
         ST    R15,MSGTEXT1
         SPACE 1
         MESSAGE MSGTEXT1
         BR    R4                       RETURN
         EJECT
***********************************************************************
***      RENAME SUBCOMMAND                                          ***
***********************************************************************
*
         SPACE 1
RENAME   MVC   MEMBERD+1(2),LMEMBER2   CHANGE DEFAULT MEMBER LENGTH
         MVC   MEMBERD+1+2(8),MEMBER2  CHANGE DEFAULT MEMBER NAME
         MVI   MEMBERD,FMEMBER1        ONLY ONE MEMBER NAME NOW
         SPACE 2
         BAL   R14,CHKUSER             VERIFY DISP=OLD IF REQUIRED
         SPACE
         BAL   R2,OPENSTOW             OPEN STOW DCB
         BZ    NEWCMD                  EXIT IF DATA SET NOT OPENED
         STOW  STOWDCB,MEMBERRN,C      ISSUE STOW WITH CHANGE OPTION
         SPACE 2
         LA    R1,MSGRENAM             ASSUME RENAMED
         SPACE 2
         B     *+4(R15)                PROCESS RETURN CODE
         B     MSGNEW                  00 - SUCCESSFUL
         B     MEMEXIST                04 - MEMBER EXISTS WITH NEW NAME
         B     NOMEMBER                08 - CURRENT NAME DOES NOT EXIST
         EX    0,*                     12 - INVALID RETURN FROM RENAME
         B     IOERROR                 16 - IO ERROR IN DIRECTORY
         EJECT
*
*
*         ENTRY SUBCOMMAND
*
*
         SPACE 2
ENTRY    DS    0H
         BAL   R14,CHKUSER
         MVC   DIRNAME,MEMBER1
         BLDL  INDCB,BLDLLIST
         MVC   DIRFLAG(DIREND-DIRFLAG),DIRFLAG+2
         B     *+4(R15)
         B     ENTRY1
         B     ENTRYNON
         B     IOERROR
ENTRY1   EQU   *
         TM    FLAGSDD,RECFMU
         BO    ENTRY2
ENTRYER  EQU   *
         MESSAGE ENTRYM1
         B     ENTRYEND
ENTRYM1  MSG   ' MEMBER OR ALIAS IS NOT A LOAD-MODULE'
ENTRY2   DS    0F
         MVC   DIREPA,ENTRYAD
         CLC   DIREPA,=XL3'00'
         BE    EPZERO
         NI    DIRATTR+1,255-ATTREP0
         B     ENTRY3
EPZERO   EQU   *
         OI    DIRATTR+1,ATTREP0
ENTRY3   EQU   *
         BAL   R2,OPENSTOW
         BZ    ENTRYEND
         MVC   DCBRELAD-IHADCB+STOWDCB,DIRTTR
         MVI   DCBRELAD-IHADCB+STOWDCB+3,0
         STOW  STOWDCB,DIRNAME,R
         B     *+4(R15)
         B     ENTRY4
         EX    0,*       SHOULD NOT OCCUR
         EX    0,*
         B     FULLDIR
         B     IOERROR
         EX    0,*
         EX    0,*
ENTRY4   EQU   *
         MESSAGE MSGNTRY
         B     ENTRYEND
ENTRYNON EQU   *
         MESSAGE MSGNONE
         B     ENTRYEND
         LTORG
ENTRYEND EQU   *
         B     NEWCMD
         EJECT
***********************************************************************
***      ALIAS SUBCOMMAND                                           ***
***********************************************************************
*
         SPACE
ALIAS    MVC   MEMBERD+1(2),LMEMBER2      CHANGE DEFAULT MEMBER LENGTH
         MVC   MEMBERD+1+2(8),MEMBER2     CHANGE DEFAULT MEMBER NAME
         MVI   MEMBERD,FMEMBER1           ONLY ONE MEMBER NAME NOW
         SPACE 2
         BAL   R14,CHKUSER                VERIFY DISP=OLD IF REQUIRED
         MVC   DIRNAME,MEMBER2            SET ALIAS NAME
         MVI   ENTRYPT,C'?'               ENTRY POINT NOT KNOWN YET
         TM    DIRFLAG,X'80'              MODULE A CURRENT ALIAS?
         BZ    ALIAS2                     NO, BRANCH
         TM    FLAGSDD,RECFMU             LOAD MODULE?
         BO    ALIAS3                     YES, BRANCH
         B     ALIAS4                     NO, BRANCH
         SPACE
ALIAS2   OI    DIRFLAG,X'80'              SET ALIAS FLAG
         TM    FLAGSDD,RECFMU             LOAD MODULE?
         BZ    ALIAS4                     NO, BRANCH
         SPACE
         TM    DIRATTR2,DIRAOSLE+DIRAPFLG VS LKED & APF DATA PRESENT?
         BZ    ALIAS2Y                    NO, BRANCH
         SPACE
         LA    R2,DIRAPF                  POINT TO APF INFORMATION
         TM    DIRATTR,ATTRSCAT           SCATTER LOADED?
         BZ    *+8                        NO, BRANCH
         LA    R2,DIRAPF3                 YES, POINT TO APF DATA
         LA    R4,11(,R2)                 POINT TO ALIAS APF DATA
         TM    DIRATTR2,DIR2SSI           SSI PRESENT?
         BZ    ALIAS2B                    NO, BRANCH
         SPACE
         LA    R2,1(,R2)                  ROUND TO HALFWORD
         N     R2,=F'-2'                  FFFFFFFE MASK
         LA    R4,1(,R4)                  ROUND TO HALFWORD
         N     R4,=F'-2'                  FFFFFFFE MASK
         MVC   0(4,R4),0(R2)              MOVE SSI INFORMATION
         LA    R4,4(,R4)                  MOVE PAST SSI INFORMATION
         LA    R2,4(,R2)                  POINT TO APF DATA
         SPACE
ALIAS2B  CLI   0(R2),1                    IS APF LENGTH OK?
         BE    ALIAS2D                    YES, BRANCH
         MESSAGE MSGAABAD                 BAD APF INFORMATION FORMAT
         LA    R2,ZERO                    SET APF=0
         SPACE
ALIAS2D  MVI   0(R4),1                    SET PROPER LENGTH
         MVC   1(1,R4),1(R2)              MOVE IN APF DATA
         EJECT
ALIAS2Y  LA    R4,DIREP                   POINT TO START OF ALIAS INFO.
         LA    R5,(DIREND2-DIRUSER+1)/2   NUMBER OF HALFWORDS
         TM    DIRATTR,ATTRSCAT           SCATTER LOADED?
         BNO   ALIAS2Z                    NO, BRANCH
         LA    R4,DIREPSC                 POINT TO START OF ALIAS INFO.
         LA    R5,(DIREND3-DIRUSER+1)/2   NUMBER OF HALFWORDS
         SPACE 2
ALIAS2Z  MVC   0(3,R4),DIREPA             MOVE IN REAL MODULE ENTRY
         MVC   3(8,R4),MEMBER1            ADD REAL MODULE NAME
         TM    DIRATTR2,DIR2SSI           SSI INFORMATION?
         BNO   *+8                        NO, BRANCH
         LA    R5,2(,R5)                  YES, TWO MORE HALFWORDS
         NI    DIRFLAG,X'E0'              TURN OFF HALFWORD COUNT
         OI    DIRFLAG,*-*                <<EXECUTED>>
         EX    R5,*-4                     MOVE IN NUMBER OF HALFWORDS
         SPACE
ALIAS3   BAL   R14,READCESD               SCAN ESD FOR MEMBER NAME
         B     ALIAS4                     NOT FOUND, -- PSEUDO ENTRY
         SPACE
         OI    DIRATTR+1,ATTREP0          ASSUME ENTRY POINT ZERO
         LTR   R1,R1                      CORRECT?
         BZ    ALIAS3A                    YES, BRANCH
         XI    DIRATTR+1,ATTREP0          NO, INSURE ATTR FLAG OFF
ALIAS3A  STCM  R1,B'0111',DIREPA          SAVE ENTRY ADDRESS
         TM    DIRATTR,ATTRSCAT           SCATTER LOADED?
         BNO   ALIAS4                     NO, BRANCH
         STCM  R15,3,DIRSCEP              YES, SAVE ESDID OF ENTRY PT.
         SPACE
ALIAS4   BAL   R2,OPENSTOW
         BZ    NEWCMD                     EXIT IF DATA SET NOT OPENED
         STOW  STOWDCB,DIRNAME,A          ADD ALIAS TO DIRECTORY
         SPACE
         B     *+4(R15)                   PROCESS RETURN CODE
         B     ALIAS5                     00 - SUCCESSFUL
         B     MEMEXIST                   04 - MEMBER ALREADY EXISTS
         EX    0,*                        08 - SHOULD NOT HAPPEN - ADD
         B     FULLDIR                    12 - DIRECTORY IS FULL
         B     IOERROR                    16 - I/O ERROR IN DIRECTORY
         SPACE 1
ALIAS5   MESSAGE MSGALIAS                 MSG - ALIAS ASSIGNED
         TM    FLAGSDD,RECFMU             MUST WE GIVE ENTRY POINT?
         BZ    NEWCMD                     NO, BRANCH
         BAL   R2,EPA#LEN                 SHOW ENTRY POINT AND SYMBOL
         B     NEWCMD
         EJECT
***********************************************************************
***      DELETE SUBCOMMAND                                          ***
***********************************************************************
*
         SPACE 1
DELETE   BAL   R14,CHKUSER           VERIFY DISP=OLD IF REQUIRED
         SPACE
         BAL   R2,OPENSTOW           OPEN STOW DCB
         BZ    NEWCMD                EXIT IF DATA SET NOT OPENED
         SPACE 1
         MVC   DOUBLE(8),MEMBER1     MEMBER NAME
         CLI   MEMFIRST,C'*'         ASTERISK NOTATION?
         BE    DELETE4               YES, NO PROMPTS
         SPACE 1
         TM    FLAGSAA,FMEM#MEM      MEMBER GROUP?
         BO    DELETE2               YES, PROMPT FOR YES OR NO
         TM    FLAGSAA,FOPTIONS      ANY MEMBER NAME SPECIFIED?
         BO    DELETE6               YES, BRANCH
         SPACE 1
DELETE2 $PUTGET MSGYESNO,ATTN=NEWCMD PROMPT FOR YES OR NO
         TM    FLAGSBB,FNULL         NULL REPLY?
         BO    DELETE2               YES, BRANCH
         L     R1,ADDRCBUF           ADDRESS OF INPUT MESSAGE
         OI    04(R1),X'40'          UPPER-CASE THE RESULT
         CLI   04(R1),C'N'           "NO" REPLY?
         BE    NEWCMD                YES, DO NOT DELETE THIS MEMBER
         CLI   04(R1),C'Y'           "YES" REPLY?
         BNE   DELETE2               NO, ASK AGAIN
         SPACE 1
DELETE4  MVC   DOUBLE(8),DIRNAME     MEMBER NAME
         MVC   SIOBDIR(8),CURMBB     REREAD THIS DIRECTORY BLOCK
         MVC   SIOBDIR+11(1),OLDSNO  USING ITS SECTOR NUMBER
         MVI   IOBECB,X'7F'          PREVIOUS READ WAS SUCCESSFUL
         SPACE 1
DELETE6  STOW  STOWDCB,DOUBLE,D      ISSUE STOW WITH DELETE OPTION
         SPACE 1
         LA    R1,MSGGONE            ASSUME DELETED
         SPACE 1
         B     *+4(R15)              PROCESS RETURN CODE
         B     MSGNEW                00 - SUCCESSFUL
         EX    0,*                   04 - SHOULD NOT OCCUR
         B     NOMEMBER              08 - MEMBER DOES NOT EXIST
         EX    0,*                   12 - SHOULD NOT OCCUR
         B     IOERROR               16 - IO ERROR IN DIRECTORY
         EJECT
***********************************************************************
***      ATTRIB SUBCOMMAND                                          ***
***********************************************************************
*
         SPACE 1
ATTRIB   TM    FLAGSDD,RECFMU      LOAD MODULE LIBRARY?
         BO    ATTR0A              YES, BRANCH
*
         LA    R2,DIRUSER          LOAD START OF USER AREA (FOR SSI)
         TM    DIRFLAG,X'0F'       SPF STATISTICS PRESENT?
         BNO   A0NOGO              NO, BRANCH
         OC    DIRSPFZ(3),DIRSPFZ  RESERVED AND 00 OF 00YYDDDF ZEROS?
         BNZ   A0NOGO              NO, BRANCH
         CLI   DIRSPFCD,0          00 OF OTHER 00YYDDDF ZERO?
         BNZ   A0NOGO              NO, BRANCH
         MESSAGE MSGSPFHD
         SPACE 1
         MVC   MSGTEXT1,MSGSPFHD
         MVC   MSGTEXT1+5(30),MSGTEXT1+4  CLEAR "SPF STATS:    VER.MOD"
         LA    R2,MSGTEXT1
         MVC   6(8,R2),DIRNAME     MEMBER NAME
         SR    R1,R1
         IC    R1,DIRSPFR          REVISION NUMBER FIRST
         CVD   R1,DOUBLE
         MVC   21(4,R2),=X'40212020'
         ED    21(4,R2),DOUBLE+6
         MVI   22(R2),C'.'
         IC    R1,DIRSPFV          VERSION NUMBER
         CVD   R1,DOUBLE
         MVC   18(4,R2),=X'40212020'
         ED    18(4,R2),DOUBLE+6
         LA    R1,DIRSPFCR+1           POINT TO YYDDDF
         LA    R15,FULLWORD+1
         BAL   R14,SETLKDTE            CONVERT TO 00MMDDYY
         MVC   FULLWORD(1),FULLWORD+3  CONVERT TO YYMMDD
         MVC   26(L'DATEMASK,R2),DATEMASK
         ED    26(L'DATEMASK,R2),FULLWORD
         LA    R1,DIRSPFCD+1           POINT TO YYDDDF
         LA    R15,FULLWORD+1
         BAL   R14,SETLKDTE            CONVERT TO 00MMDDYY
         MVC   FULLWORD(1),FULLWORD+3  CONVERT TO YYMMDD
         MVC   36(L'DATEMASK,R2),DATEMASK
         ED    36(L'DATEMASK,R2),FULLWORD
         MVC   45(6,R2),=X'4021207A2020'
         ED    45(6,R2),DIRSPFCT       TIME OF LAST CHANGE
         LH    R1,DIRSPFSI
         CVD   R1,DOUBLE
         MVC   51(6,R2),=X'402020202120'
         ED    51(6,R2),DOUBLE+5
         LH    R1,DIRSPFIN
         CVD   R1,DOUBLE
         MVC   57(6,R2),=X'402020202120'
         ED    57(6,R2),DOUBLE+5
         LH    R1,DIRSPFMD
         CVD   R1,DOUBLE
         MVC   63(6,R2),=X'402020202120'
         ED    63(6,R2),DOUBLE+5
         MVC   71(8,R2),DIRSPFID
         MESSAGE MSGTEXT1              OUTPUT SPF STATISTICS
         LA    R2,DIRSPFID+12          NO SSI FOR SPF-SAVED MEMBERS
         TM    FLAGSAA,FATTR           ANY ATTRIBUTE CHANGE?
         BNO   ATTR22                  NO, CHECK FOR ALIAS
*
A0NOGO   LA    R1,MSGNLOAD             ASSUME ATTRIBUTES ASSIGNED
         TM    FLAGSAA,FATTR           CORRECT?
         BO    A0NOGO1                 YES, ERROR
         CLC   ZERO,0(R2)              ANY SSI INFORMATION?
         BNE   ATCK4SSI                YES, BRANCH
         LA    R1,MSGBNONE             NO, JUST SAY NO ATTRIBUTES
A0NOGO1  MESSAGE (R1)                  OUTPUT A MESSAGE
         B     ATCK4SSI                PROCESS SSI INFORMATION
         SPACE
ATTR0A   TM    FLAGSAA,FATTR           ANY CHANGED ATTRIBUTES?
         BNO   ATTR3                   NO, BRANCH
         SPACE
         BAL   R14,CHKUSER             VERIFY DISP=OLD IF REQUIRED
         TM    FLAGSCC,FAPFON+FAPFOFF  CHANGE APF PROCESSING?
         BZ    ATTR1A                  NO, BRANCH
         SPACE 1
         TM    DIRATTR2,DIRAOSLE+DIRAPFLG  CAN CHANGE APF INFORMATION?
         BNO   A1NOGO                      NO, BRANCH
         LA    R2,DIRAPF                   YES, POINT TO APF DATA
         TM    DIRATTR,ATTRSCAT        SCATTER LOAD?
         BNO   *+8                     NO, BRANCH
         LA    R2,8(,R2)               SCATTER SIZE
         TM    DIRFLAG,X'80'           ALIAS?
         BNO   *+8                     NO, BRANCH
         LA    R2,11(,R2)              ADD ALIAS LENGTH
         TM    DIRATTR2,DIR2SSI        SSI?
         BNO   *+12                    NO, BRANCH
         LA    R2,5(,R2)               ADD 4 AND ROUND TO HALFWORD
         N     R2,=F'-2'
         CLI   0(R2),1                 LENGTH RIGHT?
         BNE   A1NOGO                  NO, BRANCH
         TM    FLAGSCC,FAPFON          TURN ON?
         MVI   1(R2),0                 ASSUME TURN OFF
         BNO   *+8                     NO, BRANCH
         MVI   1(R2),1                 YES, USE ONE
         B     ATTR1A
         EJECT
A1NOGO   MESSAGE MSGADNC               INVALID APF DATA LENGTH
         SPACE 2
ATTR1A   TM    FLAGSCC,FPAGYES+FPAGNO  CHANGE PAGE PROCESSING?
         BZ    ATTR1B                  NO, BRANCH
         SPACE 1
         TM    DIRATTR2,DIRAOSLE+DIRAPFLG  CAN CHANGE PAGE INFORMATION?
         BNO   A2NOGO                      NO, BRANCH
         NI    DIRATTR2,FF-DIR2PAGA        ASSUME TURN OFF PAGE
         TM    FLAGSCC,FPAGYES             TURN ON?
         BNO   *+8                         NO, BRANCH
         OI    DIRATTR2,DIR2PAGA           YES, TURN ON PAGE BOUNDARY
         B     ATTR1B
         SPACE
A2NOGO   MESSAGE MSGNOPAG              INVALID APF DATA LENGTH
         SPACE 2
ATTR1B   OC    DIRATTR,ATTRYES         ADD POSITIVE ATTRIBUTES
         XC    ATTRNO(2),=F'-1'        INVERT THE NO BITS
         NC    DIRATTR,ATTRNO          REMOVE NEGATIVE ATTRIBUTES
         XC    ATTRNO(2),=F'-1'        RESTORE THE NO BITS
         SPACE 1
*
*   RESTRICTION: BOTH RENT AND REUS MUST BE SPECIFIED FOR REENTRANT
         TM    DIRATTR,ATTRRENT        WAS REENTRABLE SPECIFIED?
         BNO   *+8                     NO, BRANCH
         OI    DIRATTR,ATTRREUS        YES, ALSO FORCE REUSABLE
         SPACE
         BAL   R2,OPENSTOW             OPEN STOW DCB
         BZ    NEWCMD                  EXIT IF DATA SET NOT OPENED
         MVC   DCBRELAD-IHADCB+STOWDCB,DIRTTR
         MVI   DCBRELAD-IHADCB+STOWDCB+3,0
         STOW  STOWDCB,DIRNAME,R       REPLACE OPTION
         SPACE 1
         B     *+4(R15)                PROCESS RETURN CODE
         B     ATTR3                   00 - SUCCESSFUL
         EX    0,*                     04 - SHOULD NOT OCCUR
         EX    0,*                     08 - SHOULD NOT OCCUR
         B     FULLDIR                 12 - DIRECTORY FULL
         B     IOERROR                 16 - I/O ERROR
         EJECT
ATTR3    MESSAGE MSGATTRS              ATTRIBUTES MSG
         SPACE 1
         CLEAR MSGTEXT1
         LA    R1,MSGTEXT1+3           INDENT A SPACE
         SR    R0,R0                   NO ATTRIBUTES FLAG
         LA    R14,TBLATTR-12          ATTRIBUTES TABLE
         LH    R2,DIRATTR              GET MODULE ATTRIBUTES
         SPACE 2
NEXTATTR LA    R14,12(R14)
         CLI   0(R14),X'FF'            END OF TABLE?
         BE    LASTATTR                YES, BRANCH
         SPACE
         LH    R15,0(R14)              GET ATTRIBUTE FLAGS
         TM    2(R14),X'80'            POSITIVE OR NEGATIVE ATTRIBUTE?
         LA    R3,X'80'                MASK FOR POS (FOR BZ INST)
         BZ    *+8
         LA    R3,X'70'                MASK FOR NEG (FOR BNZ) INST
         NR    R15,R2                  CHECK FOR ATTRIBUTE PRESENT
         NOP   NEXTATTR                <<BZ OR BNZ>>
         EX    R3,*-4                  BRANCH IF NO DISPLAY ATTRIBUTE
         SPACE
         BALR  R0,0                    INDICATE ATTRIBUTE EXISTS
         LA    R3,X'7F'
         MVI   0(R1),C','              DELIMITER AFTER LAST ATTR
         IC    R15,2(R14)              LENGTH-1 OF ATTRIBUTE
         NR    R15,R3
         MVC   2(*-*,R1),3(R14)        <<EXECUTED>>
         EX    R15,*-6
         LA    R1,3(R15,R1)            JUMP POINTER
         B     NEXTATTR
         SPACE 3
LASTATTR LTR   R0,R0                   ANY ATTRIBUTES PRESENT?
         LA    R1,MSGBNONE
         BZ    NOATTRS                 NO, BRANCH
         SPACE
         LA    R1,L'MSGTEXT1
         SLL   R1,16
         ST    R1,MSGTEXT1
         LA    R1,MSGTEXT1
         SPACE
NOATTRS  MESSAGE (R1)
         EJECT
         LA    R2,DIRAPF               POINT TO APF INFORMATION
         SPACE
         TM    DIRATTR,ATTRSCAT        SCATTER FORMAT?
         BNO   *+8                     NO, BRANCH
         LA    R2,8(,R2)               YES, ADD SCATTER SIZE BYTES
         SPACE
         TM    DIRFLAG,X'80'           ALIAS?
         BNO   *+8                     NO, BRANCH
         LA    R2,11(,R2)              ADD ALIAS LENGTH
         SPACE
         TM    DIRATTR2,DIRAOSLE       VS LINKAGE EDITOR?
         BO    ATCKMODE                YES, BRANCH
         MESSAGE MSGNOVSL              NON-VS LINKAGE EDITOR MESSAGE
         SPACE
         TM    DIRFLAG,X'80'           ALIAS?
         BZ    ATGOTSSI                NO, BRANCH
         B     ATNOSSI
         SPACE
ATCKMODE EQU   *
         MVC   MSGMODE+22(4),=CL4'24'
         MVC   MSGMODE+10(4),=CL4'24'
         TM    DIRMODE,X'10'
         BNO   *+10
         MVC   MSGMODE+22(4),=CL4'ANY'
         TM    DIRMODE,X'03'
         BZ    AMODE24
         MVC   MSGMODE+10(4),=CL4'31'
         BNO   *+10
         MVC   MSGMODE+10(4),=CL4'ANY'
AMODE24  EQU   *
         MESSAGE MSGMODE
ATCKSSI  TM    DIRATTR2,DIR2SSI        SSI PRESENT?
         BNO   ATNOSSI                 NO, SKIP SSI PROCESSING
         SPACE
ATGOTSSI LA    R2,1(,R2)               ROUND UP TO HALFWORD
         N     R2,=F'-2'
         SPACE
ATCK4SSI CLC   ZERO,0(R2)              ZERO?
         BE    ATNOSSI                 YES, NO SSI
         CLC   =F'-1',0(R2)            FFFFFFFF?
         BE    ATNOSSI                 YES, NO SSI
         SPACE
         MVC   MSGTEXT1,MSGSSI         SSI MESSAGE
         UNPK  MSGTEXT1+MSGSSI1-MSGSSI(9),0(5,R2)
         TR    MSGTEXT1+MSGSSI1-MSGSSI(8),TRTABLE
         MESSAGE MSGTEXT1
         LA    R2,4(,R2)               ADD SSI SIZE
         EJECT
ATNOSSI  TM    FLAGSDD,RECFMU          LOAD MODULE LIB?
         BZ    ATTR22                  NO, BRANCH
         SPACE
         TM    DIRATTR2,DIRAOSLE       VS LINKAGE EDITOR?
         BZ    ATTR21                  NO, CANNOT BE AUTHORIZED
         TM    DIRATTR2,DIR2PAGA       PAGE ALIGNMENT REQUIRED?
         BNO   ATAPFCHK                NO, BRANCH
         MESSAGE MSGPAGA               PAGE ALIGNMENT REQUIRED
         SPACE
ATAPFCHK LA    R1,MSGNOAPF             ASSUME NO APF DATA
         TM    DIRATTR2,DIRAPFLG       APF DATA PRESENT AND VALID?
         BNO   ATTR20                  NO, BRANCH
         SPACE
         LA    R1,MSGAPFLB             ASSUME APF LENGTH INCORRECT
         CLI   0(R2),1                 APF DATA LENGTH OK?
         BNE   ATTR20                  NO, BRANCH
         SPACE
         LA    R1,MSGYAUTH             ASSUME AUTHORIZED
ATAPFLOK CLI   1(R2),1                 AUTHORIZED?
         BE    ATTR20                  YES, BRANCH
         BL    ATTR21                  NO, APF=0 (NO MESSAGE NEEDED)
         LA    R1,MSGAPF2B             APF DATA IS TOO LARGE
         SPACE 2
ATTR20   MESSAGE (R1)
         SPACE 2
ATTR21   MVI   ENTRYPT,C'?'            ENTRY POINT NAME IS UNKNOWN
         BAL   R2,EPA#LEN              SHOW ENTRY POINT AND LENGTH
         SPACE 2
         BAL   R14,READIDR             GET THE LINKAGE EDIT DATE
         B     ATTR22                  NO HISTORY IS AVAILABLE
         SPACE 1
         MVC   MSGTEXT1,MSGHISTD       LAST LINKEDIT DATE MSG
         ED    MSGTEXT1+DATEMASK-MSGHISTD(L'DATEMASK),LKEDDATE
         MESSAGE MSGTEXT1
         SPACE 2
ATTR22   NI    FLAGSBB,FF-FLINESET
         TM    DIRFLAG,X'80'           MODULE AN ALIAS?
         BO    MAPAREAL                YES, FIND THE REAL ENTRY
         MVI   STARTTR+2,X'01'         TTR=000001 (START OF DIRECTORY)
         EJECT
ATTR4    BAL   R14,READDIR          GET NEXT DIRECTORY MEMBER
         B     ATTRLAST             LAST MEMBER PROCESSED
         SPACE 2
         TM    MEMFLAG,X'80'        AN ALIAS?
         BZ    ATTR4                NO, IGNORE
         CLC   DIRTTR,MEMTTR        TTR MATCH?
         BNE   ATTR4                NO, BRANCH
         SPACE
         LA    R2,MEMNAME+7
         TM    FLAGSBB,FLINESET     LINE IN PROGRESS?
         BO    ATTR5B               YES, BRANCH
         OI    FLAGSBB,FLINESET     LINE NOW IN PROGRESS
         MVC   MSGTEXT1,MSGOTHER
         LH    R1,MSGTEXT1
         LA    R5,MSGTEXT1(R1)      POINT TO END OF MESSAGE
         SPACE
ATTR5B   CLI   0(R2),X'40'
         BNE   ATTR5C
         BCT   R2,ATTR5B
         SPACE
ATTR5C   LA    R0,MEMNAME
         SR    R2,R0
         BNM   ATTR5D
         SR    R2,R2
ATTR5D   LA    R15,2(R5,R2)
         LA    R1,MSGTEXT1
         SR    R15,R1
         C     R15,LINESIZE
         BNH   ATTR5E
         SR    R5,R1
         STH   R5,MSGTEXT1
         MESSAGE (R1)
         MVC   MSGTEXT1,MSGBLANK
         LH    R1,MSGTEXT1
         LA    R5,MSGTEXT1-1(R1)    INDENT FOR BLANKS
         SPACE
ATTR5E   MVI   0(R5),X'40'
         MVC   1(8,R5),MEMNAME
         LA    R1,2(R2,R5)
         MVI   0(R1),C','
         LA    R5,3(R2,R5)
         B     ATTR4
         SPACE 2
ATTRLAST TM    FLAGSBB,FLINESET     LINE IN PROGRESS?
         BZ    NEWCMD               NO, EXIT
         LA    R1,MSGTEXT1
         SR    R5,R1
         BCTR  R5,0                 DELETE FINAL COMMA
         STH   R5,MSGTEXT1
         B     MSGNEW
         EJECT
***********************************************************************
***      MAP SUBCOMMAND                                             ***
***                                                                 ***
***      SMAP SUBCOMMAND       ADDED BY BRUCE LELAND -- JAN, 1980   ***
***********************************************************************
*
         SPACE 1
MAP      DS    0H               REGULAR MAP
SMAP     LA    R1,MSGNLOAD      DISCARD ENTRY NAMES WITHIN CSECTS
         SPACE 1
         TM    FLAGSDD,RECFMU   PROCESSING LOAD LIBRARY?
         BNO   MSGNEW           NO, BRANCH
         SPACE
         MVI   ENTRYPT,C'?'     NO ENTRY POINT YET
         SPACE 2
         BAL   R14,READCESD     FORMAT THE CESD DATA
         B     MAPNOESD         NO ESD ENTRIES, BRANCH
         SPACE 2
         LA    R4,ESDPTR        ESD TABLE CHAIN POINTER
         SR    R5,R5            CLEAR SEGTAB/ENTAB SWITCH
         USING ESDENTRY,R4      BASE FOR TABLE
         SPACE 2
MAPESD   CLEAR MSGTEXT1
         ICM   R4,15,ESDLINK    END OF CHAIN?
         BZ    MAPLAST          YES, BRANCH
         SPACE
         CLI   ESDTYPE,CODESD   THIS EXTERNAL DEFINATION?
         BE    MAPSD            YES
         SPACE
         CLI   ESDTYPE,CODELR   THIS EXTERNAL REFERENCE?
         BE    MAPLR            YES
         SPACE
         CLI   ESDTYPE,CODEPC   PRIVATE CODE?
         BE    MAPPC            YES
         SPACE
*        MUST BE SEGTAB OR ENTAB ENTRY
         SPACE
         LTR   R5,R5            SEGTAB PROCESSED?
         MVC   MSGTEXT1+4(8),=CL8'$SEGTAB'
         BZ    MAPSEGTB
         MVC   MSGTEXT1+4(8),=CL8'$ENTAB'
MAPSEGTB BALR  R5,0             SEGTAB PROCESSED CODE
         B     MAPSD1
         SPACE 6
MAPPC    DS    0H
MAPSD    MVC   MSGTEXT1+4(8),ESDNAME
         SPACE
MAPSD1   TM    DIRATTR,ATTROVLY      OVERLAY PROGRAM?
         BZ    MAPNOVLY              NO, BRANCH
         SPACE
         SR    R0,R0
         IC    R0,ESDSEG#
         CVD   R0,DOUBLE
         OI    DOUBLE+7,X'0F'
         UNPK  MSGTEXT1+30(2),DOUBLE+6(2)
         SPACE 3
MAPNOVLY CLC   ESDADDR(3),DIREPA     ENTRY POINT?
         BNE   *+10                  NO, BRANCH
         MVC   ENTRYPT,MSGTEXT1+4    SAVE THE ENTRY POINT NAME
         SPACE
         UNPK  MSGTEXT1+14(7),ESDADDR(4)
         TR    MSGTEXT1+14(6),TRTABLE
         MVI   MSGTEXT1+20,X'40'     CLEAR GARBAGE BYTE
         UNPK  MSGTEXT1+22(7),ESDLEN(4)
         TR    MSGTEXT1+22(6),TRTABLE
         LA    R1,28
         B     MAPPRINT
         SPACE 3
MAPLR    CLC   ESDADDR(3),DIREPA     ENTRY POINT?
         BNE   MAPSM                 NO, BRANCH
         MVC   ENTRYPT,ESDNAME       YES, SAVE THE ENTRY POINT NAME
         B     MAPNOSM               ALWAYS MAP THIS SYMBOL (ENTRY PT)
MAPSM    CLI   SUBNAME,C'S'          SHORT MAP?
         BE    MAPESD                YES, BRANCH
MAPNOSM  MVC   MSGTEXT1+30(8),ESDNAME
         UNPK  MSGTEXT1+40(7),ESDADDR(4)
         TR    MSGTEXT1+40(6),TRTABLE
         LA    R1,46
         SPACE
MAPPRINT SLL   R1,16
         ST    R1,MSGTEXT1
         MESSAGE MSGTEXT1
         B     MAPESD
         EJECT
MAPLAST  MVC   MSGTEXT1(8),MSGBLANK
         SPACE
MAPNOESD MESSAGE MSGTEXT1
         SPACE
         BAL   R2,EPA#LEN         MAP ENTRY POINT AND LENGTH
         SPACE
         TM    DIRFLAG,X'80'      IS MODULE AN ALIAS?
         BZ    NEWCMD             NO, NO ALIAS INFORMATION
         SPACE 1
         CLI   SUBNAME,C'S'       SHORT MAP?
         BE    NEWCMD             YES, BRANCH
         SPACE 3
MAPAREAL MVI   STARTTR+2,X'01'    TTR=000001 (START OF DIRECTORY)
         SPACE 2
MAPALIAS BAL   R14,READDIR        GET NEXT DIRECTORY MEMBER
         B     MAPNREAL           LAST MEMBER PROCESSED
         SPACE 2
         TM    MEMFLAG,X'80'      THIS MODULE AN ALIAS?
         BO    MAPALIAS           YES, IGNORE
         SPACE
         CLC   DIRTTR,MEMTTR      TTR MATCH?
         BNE   MAPALIAS           NO, BRANCH
         SPACE
         MVC   MSGTEXT1,MSGREAL
         MVC   MSGTEXT1+MSGREAL1-MSGREAL(8),MEMNAME
         MESSAGE MSGTEXT1
         B     NEWCMD
         SPACE 2
MAPNREAL MESSAGE MSGNOMOD
         TM    FLAGSDD,RECFMU     LOAD MODULE?
         BNO   NEWCMD             NO, BRANCH
         MVC   MSGTEXT1,MSGXREAL  DIRECTORY NAME OF REAL MODULE
         LA    R1,MSGTEXT1
         MVC   MSGTEXT1+MSGXREA1-MSGXREAL(8),DIRREAL
         SPACE 1
         TM    DIRATTR,ATTRSCAT   SCATTER LOADED?
         BNO   MSGNEW             NO, BRANCH
         MVC   MSGTEXT1+MSGXREA1-MSGXREAL(8),DIRREALS
         B     MSGNEW
         SPACE
         DROP  R4
         EJECT
*
*
*        DIRECTORY READ SUBROUTINE
*
*
         SPACE 2
READDIR  ST    R14,12(,R13)
         SPACE
         NI    FLAGSCC,FF-FDIREND      END OF DIRECTORY TO COME YET
         CLI   STARTTR+2,X'01'         TTR=000001 (START OF DIRECTORY)?
         BNE   DEBLOCK                 NO, BRANCH
         SPACE
         XC    TOTBLOCK(LTOT),TOTBLOCK CLEAR TOTBLOCK, TOTUSED,
*                                            TOTMEMR,  TOTMEMA,
*                                            TOTMAXM,  TOTTHISM,
*                                            TOTTRKS & TOTCCHH
         SPACE 2
READDIR1 BAL   R14,EXCP
         B     *+4(R15)                 CHECK RETURN CODE
         B     READDIR2                 R15=00, GOOD READ
         B     READDIR4                 R15=04, END OF MEMBER
         B     READDIR4                 R15=08, END OF DATA SET
         B     IOERROR                  R15=12, I/O ERROR IN DIRECTORY
         SPACE 2
READDIR2 LH    R14,TOTTRKS
         LA    R14,1(,R14)
         CLC   TOTCCHH,CURMBB+3        SWITCH TRACKS?
         BE    *+8                     NO, BRANCH
         STH   R14,TOTTRKS             YES, UPDATE TRACK COUNT
         MVC   TOTCCHH,CURMBB+3        NEW CCHH QUANTITY
         SPACE
         LH    R14,TOTBLOCK
         LA    R14,1(R14)
         STH   R14,TOTBLOCK
         TM    FLAGSCC,FDIREND         USAGE AND LAST MEMBER FOUND?
         BO    READDIR1                YES, BRANCH
         SPACE
         LH    R14,TOTUSED
         LA    R14,1(R14)
         STH   R14,TOTUSED
         MVI   TOTTHISM+1,0
         SPACE
         L     R15,BUFFADDR
         LA    R0,2
         LH    R1,0(,R15)
         BCTR  R1,0
         LA    R1,0(R1,R15)
         STM   R15,R1,DIRPTRS
         SPACE 8
DEBLOCK  LM    R15,R1,DIRPTRS
         BXH   R15,R0,READDIR1         INDEX TO NEXT MEMBER NAME
         STM   R15,R1,DIRPTRS
         SPACE
         CLI   0(R15),X'FF'            LAST MEMBER?
         BE    READDIR3                YES
         SPACE
         MVC   MEMNAME(12),0(R15)      SAVE FIRST 12 BYTES OF ENTRY
         SPACE 1
         LH    R0,TOTTHISM
         A     R0,=F'1'
         STH   R0,TOTTHISM
         CH    R0,TOTMAXM
         BNH   *+8
         STH   R0,TOTMAXM              MAX DIRECTORY ENTRIES IN A BLOCK
         SPACE
         IC    R14,11(,R15)
         N     R14,=XL4'0000001F'
         LA    R0,12(R14,R14)
         STM   R15,R1,DIRPTRS
         SPACE 2
         TM    MEMFLAG,X'80'           ALIAS?
         LA    R14,TOTMEMR             ASSUME NOT
         BZ    *+8                     CORRECT?
         LA    R14,TOTMEMA             NO, ALIAS
         SPACE
         LH    R15,0(,R14)
         LA    R15,1(,R15)
         STH   R15,0(,R14)
         SPACE
         CLI   SUBNAME,C'U'            USAGE SUBCOMMAND?
         BE    DEBLOCK                 YES, CONTINUE THIS BLOCK
         SPACE 2
         LA    R15,4                   EXIT OFFSET
         B     READDIR5
         SPACE 2
READDIR3 OI    FLAGSCC,FDIREND         FLAG LAST MEMBER FOUND
         CLI   SUBNAME,C'U'            USAGE SUBCOMMAND?
         BE    READDIR1                YES, CONTINUE READING
         SPACE 2
READDIR4 SR    R15,R15                 END OF DIRECTORY OR LAST MEMBER
         SPACE 2
READDIR5 L     R14,12(,R13)
         B     0(R14,R15)
         EJECT
***********************************************************************
***      HISTORY SUBCOMMAND                                         ***
***********************************************************************
*
         SPACE 1
HISTORY  TM    FLAGSDD,RECFMU      PROCESSING LOAD LIBRARY?
         LA    R1,MSGNLOAD         NOT A LOAD LIBRARY MESSAGE
         BNO   MSGNEW              NO, BRANCH
         SPACE 2
         BAL   R14,READCESD        FORMAT THE CESD DATA
         NOP   0                   NO ESD ENTRIES AVAILABLE, CONTINUE
         SPACE 2
HISTORY1 BAL   R14,READIDR         FORMAT THE HISTORY DATA
         B     NOHIST              HISTORY NOT AVAILABLE
         B     HISTORY2            HISTORY AVAILABLE
NOHIST   LA    R1,MSGNHIST
         B     MSGNEW
         SPACE 3
HISTORY2 MVC   MSGTEXT1,MSGHISTD   LAST LINKEDIT DATE MSG
         ED    MSGTEXT1+DATEMASK-MSGHISTD(L'DATEMASK),LKEDDATE
         SPACE
         MESSAGE MSGTEXT1
         SPACE
         ICM   R0,15,ESDPTR        ANY ESD ENTRIES?
         BZ    NEWCMD              NO, TERMINATE
         EJECT
*
*        FORMAT IMASPZAP IDR DATA ENTRIES
*
         LA    R2,ESDPTR           START OF ESD CHAIN
         USING ESDENTRY,R2
         OI    FLAGSDD,F1IDR
         SPACE
HISTZAP  ICM   R2,15,ESDLINK       END OF ESD CHAIN?
         BZ    HISTZAP0            YES, BRANCH
         SPACE
         CLI   ESDTYPE,CODESD      CSECT ENTRY?
         BNE   HISTZAP             NO, SKIP THIS
         SPACE
         LA    R3,IDRPTR           SCAN IDR CHAIN
         USING IDRENTRY,R3
         SPACE
HISTZAP1 ICM   R3,15,IDRLINK       END OF ESD CHAIN?
         BZ    HISTZAP             YES, BRANCH
         SPACE
         CLC   ESDID,IDRESDID      REQUESTED IDR RECORD?
         BNE   HISTZAP1            NO, BRANCH
         CLI   IDRTYPE,IDRZAP      IMASPZAP ENTRY?
         BNE   HISTZAP1            NO, BRANCH
         SPACE
         TM    FLAGSDD,F1IDR       FIRST IDR RECORD?
         BZ    HISTZAP2            NO, BRANCH
         XI    FLAGSDD,F1IDR
         MESSAGE MSGHISTZ          IMASPZAP HISTORY TITLE
         SPACE
HISTZAP2 CLEAR MSGTEXT1
         SPACE
         MVC   MSGTEXT1+4(L'ESDNAME),ESDNAME
         MVC   MSGTEXT1+8+L'ESDNAME(L'DATEMASK),DATEMASK
         ED    MSGTEXT1+8+L'ESDNAME(L'DATEMASK),IDRDATE
         MVC   MSGTEXT1+12+L'ESDNAME+L'DATEMASK(L'IDRZDATA),IDRZDATA
         SPACE
         LA    R0,L'ESDNAME+L'DATEMASK+L'IDRZDATA+12
         SLL   R0,16
         ST    R0,MSGTEXT1
         MESSAGE MSGTEXT1
         B     HISTZAP1            NEXT IDR DATA RECORD THIS ESD ENTRY
         EJECT
*
*        FORMAT THE USER-SUPPLIED IDR DATA RECORDS
*
         SPACE 2
HISTZAP0 LA    R2,ESDPTR           ADDRESS OF ESD CHAIN
         OI    FLAGSDD,F1IDR
         SPACE
HISTUSER ICM   R2,15,ESDLINK       END OF ESD CHAIN?
         BZ    NEWCMD              YES, BRANCH
         SPACE
         CLI   ESDTYPE,CODESD      CSECT ENTRY?
         BNE   HISTUSER            NO, BRANCH
         LA    R3,IDRPTR
         SPACE
HISTUSR1 ICM   R3,15,IDRLINK       END OF IDR CHAIN?
         BZ    HISTUSER            YES, BRANCH
         SPACE
         CLI   IDRTYPE,IDRUSER     USER IDR DATA RECORD?
         BNE   HISTUSR1            NO, BRANCH
         CLC   ESDID,IDRESDID      WANTED ESD RECORD?
         BNE   HISTUSR1            NO, BRANCH
         SPACE 1
         TM    FLAGSDD,F1IDR       TITLE LINE REQUIRED?
         BZ    HISTUSR2            NO, BRANCH
         XI    FLAGSDD,F1IDR
         SPACE
         MESSAGE MSGHISTU          USER-SUPPLIED IDR TITLE
         SPACE 2
HISTUSR2 CLEAR MSGTEXT1
         MVC   MSGTEXT1+4(L'ESDNAME),ESDNAME
         MVC   MSGTEXT1+8+L'ESDNAME(L'DATEMASK),DATEMASK
         ED    MSGTEXT1+8+L'ESDNAME(L'DATEMASK),IDRDATE
         SR    R1,R1
         IC    R1,IDRLDATA
         CLI   IDRLDATA,X'FF'      ZERO BYTES?
         BE    HISTUSRS            YES, SKIP THE MOVE (LENGTH ZERO)
         SPACE
         MVC   MSGTEXT1+12+L'ESDNAME+L'DATEMASK(*-*),IDRDATA  <<EXEC>>
         EX    R1,*-6
         B     HISTUSRS+2          LENGTH IN R1 IS VALID
         SPACE 1
HISTUSRS SR    R1,R1               R1 LENGTH IS NOW ZERO
         LA    R1,13+L'ESDNAME+L'DATEMASK(R1)
         SLL   R1,16
         ST    R1,MSGTEXT1
         MESSAGE MSGTEXT1
         B     HISTUSR1
         DROP  R2,R3
         EJECT
*
*        IDR SCAN SUBROUTINE
*
         SPACE 3
READIDR  STM   R14,R12,12(R13)     SAVE REGISTERS
         BAL   R2,FREEIDR          FREE IDR STORAGE
         LA    R2,IDRPTR           FIRST OF IDR POINTER
         USING IDRENTRY,R2
         NI    FLAGSCC,FF-FIDRCONT-FIDRHCON
         NI    FLAGSDD,FF-FIDR-F1IDR
         MVC   STARTTR,DIRTTR      FIRST TTR
         SPACE 2
IDREXCP  BAL   R14,EXCP
         B     *+4(R15)            CHECK RETURN CODE
         B     IDREXCP1            R15=00, GOOD READ
         B     LASTIDR             R15=04, END OF MEMBER
         B     LASTIDR             R15=08, END OF DATA SET
         B     PERMERR             R15=12, I/O ERROR
         SPACE
IDREXCP1 L     R6,BUFFADDR         START OF RECORD
         CLI   0(R6),X'40'         TEST SYM RECORD?
         BE    IDREXCP             YES, SKIP RECORD
         SPACE
         CLI   0(R6),X'20'         CESD RECORD?
         BE    IDREXCP             YES, SKIP
         SPACE
         CLI   0(R6),X'80'         IDR RECORD?
         BNE   LASTIDR             NO, BRANCH
         SPACE
         LA    R3,3(,R6)           START OF IDR DATA
         TM    FLAGSCC,FIDRHCON    CONTINUED HEADER?
         BZ    IDREXCP3            NO, BRANCH
         SPACE
         L     R15,IDROFSAV        PICK UP AMOUNT WE GOT
         LA    R14,IDRUPREF+1(R15) TARGET OF MOVE
         LA    R1,3+5-1(,R6)       FIND LENGTH BYTE
         SR    R1,R15              BACK UP BY WHAT WE GOT
         SR    R4,R4               ZERO FOR IC
         IC    R4,0(,R1)           PICK UP LENGTH
         LR    R1,R4               SAVE FOR LATER
         LA    R4,4(,R1)           TOTAL LENGTH OF RECORD
         MVI   IDRTYPE,IDRUSER     RECORD TYPE
         BCTR  R1,0                MACHINE LENGTH
         STC   R1,IDRLDATA         SAVE LENGTH
         SR    R4,R15              LENGTH TO MOVE
         MVC   0(*-*,R14),3(R6)    <<EXECUTED>>
         EX    R4,*-6              MOVE INTO THE RECORD
         MVC   IDRESDID,IDRUPREF   SET ESDID
         NI    FLAGSCC,FF-FIDRHCON OFF FLAG
         LA    R3,1(R3,R4)         ADJUST TO NEXT RECORD
         EJECT
IDREXCP3 TM    FLAGSCC,FIDRCONT    CONTINUED IDR RECORD?
         BZ    IDREXCP2            NO, BRANCH
         SPACE
         SR    R5,R5               WHERE TO START MOVE
         IC    R5,IDRLDATA         DATA LENGTH
         LA    R5,IDRDATA+1(R5)    END OF DATA
         L     R15,IDROFSAV        LENGTH IN THIS RECORD
         SR    R5,R15              PLACE TO START MOVE
         LA    R3,0(R15,R3)        MOVE PAST CONTINUED PART
         BCTR  R15,0               MACHINE LENGTH
         MVC   0(*-*,R5),3(R6)     <<EXECUTED>>
         EX    R15,*-6             ADD THE REMAINDER
         NI    FLAGSCC,FF-FIDRCONT TURN OFF CONTINUED FLAG
         SPACE 2
IDREXCP2 SR    R5,R5
         IC    R5,1(,R6)           BYTE COUNT THIS RECORD
         LA    R5,0(R5,R6)         END OF BUFFER ADDRESS
         SPACE 2
         TM    2(R6),X'80'         LAST RECORD OF LOAD MODULE?
         BZ    *+8                 NO, BRANCH
         OI    FLAGSDD,F1IDR       YES, SET STOP FLAG
         SPACE
         CR    R5,R3               END OF BUFFER < CONTINUED START?
         BNH   NEXTIDR             YES, CONTINUATION (ALREADY DONE)
         SPACE
         NI    2(R6),X'0F'         CLEAR MISC FLAGS
         CLI   2(R6),IDRZAP        IMASPZAP IDR RECORD?
         BE    ZAPIDR              YES, BRANCH
         CLI   2(R6),IDRLKED       LINKAGE EDITOR IDR RECORD?
         BE    LKEDIDR             YES, BRANCH
         CLI   2(R6),IDRUSER       USER-SUPPLIED IDR RECORD?
         BNE   NEXTIDR             NO, NEXT RECORD
         SPACE 3
*        PROCESS USER-SUPPLIED DATA RECORDS
         SPACE
USERIDR  BAL   R14,GETIDR          GET A NEW IDR RECORD
         ST    R1,IDRLINK
         LR    R2,R1               ADDRESS OF NEW RECORD
         SPACE 2
         LR    R15,R5              CHECK FOR SPANNED RECORD HEADER
         SR    R15,R3              FIND BYTES LEFT IN HEADER
         LR    R14,R15             SAVE VALUE
         SH    R15,=H'5'           ROOM FOR HEADER?
         BNM   USERIDR0            YES, BRANCH
         OI    FLAGSCC,FIDRHCON    TURN ON HEADER CONTINUED FLAG
         MVC   IDRUPREF(*-*),0(R3) <<EXECUTED>>
         EX    R14,*-6             MOVE IN DATA
         ST    R14,IDROFSAV        SAVE LENGTH FOR LATER
         B     NEXTIDR             GET NEXT IDR RECORD
         SPACE
USERIDR0 MVI   IDRTYPE,IDRUSER
         MVC   IDRESDID,0(R3)      MOVE ESDID TO IDR AREA
         LA    R1,2(R3)            YYDDD IDR RECORD CREATED
         BAL   R14,SETIDRDT
         SR    R15,R15
         IC    R15,5(R3)           LENGTH OF USER DATA AREA
         LA    R4,6(R15)           LENGTH OF THIS RECORD ENTRY
         MVI   IDRTYPE,IDRUSER     INDICATE USER-SUPPLIED ENTRY
         BCTR  R15,0
         BCTR  R4,0                MACHINE LENGTH FOR MOVE
         STC   R15,IDRLDATA
         SPACE
         MVC   IDRUPREF(*-*),0(R3) <<EXECUTED>>
         EX    R4,*-6              MOVE USER DATA TO RECORD
         LA    R4,1(,R4)           RESTORE ACTUAL LENGTH
         SPACE 2
         BXLE  R3,R4,USERIDR
         SR    R3,R5               CHECK FOR SPANNED RECORDS
         BCTR  R3,0
         LTR   R3,R3               ENTRY SPAN AN IDR BLOCK?
         BNP   NEXTIDR             NO, BRANCH
         OI    FLAGSCC,FIDRCONT    MARK FOR CONTINUED PROCESSING
         ST    R3,IDROFSAV         SAVE AMOUNT IN NEXT IDR BLOCK
         B     NEXTIDR
         SPACE 2
*        PROCESS IMASPZAP IDR RECORDS
         SPACE
ZAPIDR   CLI   SUBNAME,C'A'        ATTRIB SUBCOMMAND?
         BE    NEXTIDR             YES, NO ZAP IDR RECORDS NEEDED
         SR    R4,R4
         NI    0(R3),X'3F'
         IC    R4,0(R3)            GET COUNT OF IMASPZAP ENTRIES
         LA    R3,1(R3)
         LA    R4,1(R4)            JUMP COUNT FOR LOOP
         B     ZAPIDR1
         SPACE 2
ZAPIDR2  BAL   R14,GETIDR
         ST    R1,IDRLINK
         LR    R2,R1
         MVC   IDRESDID,0(R3)      MOVE ESDID TO IDR RECORD
         LA    R1,2(R3)            ADDRESS OF DATE OF RECORD
         BAL   R14,SETIDRDT
         SPACE
         MVC   IDRDATA,5(R3)       MOVE DATA TO IDR RECORD
         MVI   IDRLDATA,8          SET LENGTH FOR COMPATIBILITY
         MVI   IDRTYPE,IDRZAP      INDICATE IMASPZAP ENTRY
         LA    R3,13(R3)           JUMP DATA ADDRESS
         SPACE 1
ZAPIDR1  BCT   R4,ZAPIDR2          IF ANOTHER ENTRY THIS RECORD
         B     NEXTIDR             READ NEXT IDR RECORD
         SPACE 8
*        LINKAGE EDITOR IDR RECORD PROCESSOR
         SPACE
LKEDIDR  OI    FLAGSDD,FIDR
         LA    R1,12(R3)           ADDRESS OF DATE
         LA    R15,LKEDDATE
         BAL   R14,SETLKDTE
         CLI   SUBNAME,C'A'        ATTRIB SUBCOMMAND?
         BE    LASTIDR             YES, ALL DONE
         SPACE 2
NEXTIDR  TM    FLAGSDD,F1IDR       LAST IDR RECORD?
         BZ    IDREXCP             NO, BRANCH
         SPACE 3
LASTIDR  NI    FLAGSCC,FF-FIDRCONT-FIDRHCON  OFF CONTINUATION FLAGS
         LA    R2,IDRPTR
SORTIDR  ICM   R2,15,IDRLINK
         BZ    SORTIDRZ
         SPACE
         LR    R1,R2
         SPACE
SORTIDR2 ICM   R1,15,IDRLINK-IDRENTRY(R1)  GET THE NEXT ENTRY
         BZ    SORTIDR
         SPACE
         CLC   IDRDATE,IDRDATE-IDRENTRY(R1)
         BNL   SORTIDR2
         XC    IDRSTART(LENIDR1),IDRSTART-IDRENTRY(R1)
         XC    IDRSTART-IDRENTRY(LENIDR1,R1),IDRSTART
         XC    IDRSTART(LENIDR1),IDRSTART-IDRENTRY(R1)
         B     SORTIDR2
         SPACE 2
SORTIDRZ LM    R14,R12,12(R13)
         TM    FLAGSDD,FIDR        ANY IDR RECORDS?
         BZR   R14                 NO, RETURN AT +0
         B     4(,R14)             YES, RETURN AT +4
         EJECT
SETIDRDT LA    R15,IDRDATE
         DROP  R2
         SPACE
SETLKDTE ST    R14,R14SAVE
         MVC   DAYTABLE,DAYMONTH
         XC    DOUBLE,DOUBLE
         SR    R14,R14             SETUP FOR LEAP YEAR TEST
         IC    R14,0(,R1)
         SLL   R14,4
         ST    R14,DOUBLE+4
         OI    DOUBLE+7,X'0F'
         LR    R14,R1
         CVB   R0,DOUBLE           GET YEAR IN BINARY
         SR    R1,R1
         SRDL  R0,2                SHIFT OFF REMAINDER OF YEAR/4
         LTR   R1,R1               THIS A LEAP YEAR?
         BNZ   *+8                 NO, BRANCH
         MVI   DAYTABLE+1,29       YES, FEB HAS 29 DAYS
         SPACE
         MVC   2(1,R15),0(R14)     YEAR RECORD CREATED
         MVC   DOUBLE+6(2),1(R14)
         CLI   DOUBLE+7,0          BAD DATE?
         BE    DAYSKIP             YES, DON'T 0C7
         CVB   R1,DOUBLE           GET RELATIVE DAYS IN BINARY
         SPACE
         LA    R14,DAYTABLE
         SR    R0,R0
DAYLOOP  IC    R0,0(R14)           DAYS THIS MONTH
         SR    R1,R0               WITHIN THIS MONTH?
         BNP   DAYNOW
         LA    R14,1(R14)
         B     DAYLOOP
         SPACE 1
DAYNOW   AR    R1,R0               GET DAY OF THE MONTH
         LA    R0,10
         MR    R0,R0
         CVD   R1,DOUBLE
         MVC   1(1,R15),DOUBLE+6
         LA    R1,DAYTABLE-1
         SR    R14,R1
         LA    R1,10
         MR    R0,R14
         CVD   R1,DOUBLE
         MVC   0(1,R15),DOUBLE+6
         SPACE
DAYSKIP  L     R14,R14SAVE
         BR    R14
         EJECT
*
*        CESD SCAN SUBROUTINE
*
         SPACE 3
READCESD STM   R14,R12,12(R13)    SAVE REGISTERS FOR RETURN
         BAL   R2,FREEESD         FREE ESD AND IDR STORAGE
         LA    R2,ESDPTR          ROOT OF ESD CHAIN
         MVC   STARTTR,DIRTTR     FIRST TTR
         SPACE 2
ESDEXCP  BAL   R14,EXCP
         B     *+4(R15)           CHECK RETURN CODE
         B     ESDEXCP1           R15=00, GOOD READ
         B     ESDLAST            R15=04, END OF MEMBER
         B     ESDLAST            R15=08, END OF DATA SET
         B     PERMERR            R15=12, I/O ERROR
         SPACE
ESDEXCP1 L     R3,BUFFADDR        START OF RECORD
         SPACE
         CLI   0(R3),X'40'        TEST SYM RECORD?
         BE    ESDEXCP            YES, SKIP RECORD
         SPACE
         CLI   0(R3),X'20'        CESD RECORD?
         BNE   ESDLAST            NO, BRANCH
         SPACE
         LH    R6,4(,R3)          RELATIVE # OF 1ST ESD ID
         LH    R5,6(,R3)          LENGTH OF DATA IN BUFFER
         LA    R3,8(,R3)          START OF ESD DATA
         AR    R5,R3
         LA    R4,16              LENGTH OF ONE ENTRY
         SR    R5,R4
         EJECT
         USING ESDNAME,R3
ESDSCAN  IC    R0,ESDTYPE
         LA    R1,CODESEG         CHECK FOR SEGTAB/ENTAB
         NI    ESDTYPE,X'0F'
         NR    R0,R1
         CLI   SUBNAME,C'A'       ALIAS SEARCH REQUEST?
         BNE   ESDMAP             NO, BRANCH
         SPACE
         CLI   ESDTYPE,CODESD     VALID EXTERNAL SYMBOL?
         BE    ESDCHECK           YES, BRANCH
         CLI   ESDTYPE,CODELR     ANOTHER VALID ENTRY
         BNE   NEXTESD            NO, GET THE NEXT ESD
         SPACE
ESDCHECK CLI   ESDSEG#,1          IS SYMBOL IN ROOT SEGMENT?
         BNE   NEXTESD            NO, CONTINUE
         CLC   ESDADDR(3),DIREPA  THIS ENTRY POINT ADDRESS?
         BNE   *+10               NO, BRANCH
         MVC   ENTRYPT,ESDNAME    YES, ENTRY POINT NAME IF NO ESD MATCH
         CLC   ESDNAME,DIRNAME    THIS NAME?
         BNE   NEXTESD            NO, BRANCH
         SPACE
         SR    R1,R1
         ICM   R1,7,ESDADDR       GET SYMBOL OFFSET
         ST    R6,12+4(,R13)      RETURN ESDID IN REG 15
         ST    R1,12+4+4+4(,R13)  RETURN OFFSET IN REG 1
         MVC   ENTRYPT,ESDNAME    USE THIS ESDNAME FOR THE ENTRY POINT
         B     ESDOUT             FOUND THE SYMBOL
         SPACE
ESDMAP   CR    R0,R1              THIS SEGTAB/ENTAB ENTRY?
         BE    ESDUSE1            YES, BRANCH
         SPACE
         CLI   ESDTYPE,CODESD     SD ENTRY?
         BE    ESDUSE             YES, BRANCH
         SPACE
         CLI   ESDTYPE,CODELR     LR ENTRY?
         BE    ESDUSE             YES, BRANCH
         SPACE
         CLI   ESDTYPE,CODEPC     PC ENTRY?
         BNE   NEXTESD            NO, BRANCH
         MVC   ESDNAME,=CL8'$PRIVATE'  PRIVATE CODE
         B     ESDUSE
         SPACE 1
ESDUSE1  STC   R0,ESDTYPE         RESTORE SEGTAB/ENTAB TYPE
ESDUSE   BAL   R14,GETESD
         ST    R1,ESDLINK-ESDENTRY(R2)             SAVE LINK POINTER
         STH   R6,ESDID-ESDENTRY(R1)               SAVE ESD ID
         MVC   ESDNAME-ESDENTRY(LENESD1,R1),0(R3)  SAVE ESD ENTRY
         LR    R2,R1                               CHAIN TO NEXT ONE
         SPACE 1
NEXTESD  LA    R6,1(R6)
         BXLE  R3,R4,ESDSCAN
         B     ESDEXCP            GET NEXT ESD RECORD
         EJECT
         DROP  R3
         USING ESDENTRY,R2
ESDLAST  OC    ESDPTR,ESDPTR      ANY ESD DATA AVAILABLE?
         MVC   MSGTEXT1,MSGNOESD
         L     R14,12(,R13)
         BZ    ESDEXIT            NO, BRANCH
         SPACE 2
         LA    R2,ESDPTR
         SPACE
ESDSORT  L     R2,ESDLINK
         ICM   R1,15,ESDLINK      END OF ESD ENTRIES?
         BZ    ESDOUT             YES, BRANCH
         SPACE
ESDSORT2 CLC   ESDSEG#,ESDSEG#-ESDENTRY(R1) CHECK ENTRY SEGMENT
         BL    ESDSORT3
         BH    ESDSWAP
         SPACE
         CLC   ESDADDR,ESDADDR-ESDENTRY(R1)
         BL    ESDSORT3
         BH    ESDSWAP
         SPACE
         CLC   ESDTYPE,ESDTYPE-ESDENTRY(R1)
         BL    ESDSORT3
         BH    ESDSWAP
         SPACE
         CLC   ESDNAME,ESDNAME-ESDENTRY(R1)
         BNH   ESDSORT3
         SPACE
ESDSWAP  XC    ESDNAME(LENESD2),ESDNAME-ESDENTRY(R1)
         XC    ESDNAME-ESDENTRY(LENESD2,R1),ESDNAME
         XC    ESDNAME(LENESD2),ESDNAME-ESDENTRY(R1)
         SPACE
ESDSORT3 ICM   R1,15,ESDLINK-ESDENTRY(R1)
         BNZ   ESDSORT2
         B     ESDSORT
         DROP  R2
         SPACE 4
ESDOUT   L     R14,12(,R13)
         LA    R14,4(,R14)        ADJUST EXIT ADDRESS
         SPACE 2
ESDEXIT  LM    R15,R12,16(R13)
         BR    R14                EXIT
         EJECT
***      ESD TABLE SUBROUTINES
         SPACE 1
GETESD   LA    R0,LENESD
         GETMAIN R,LV=(0)
         XC    0(LENESD,R1),0(R1)
         BR    R14
         SPACE 2
FREEESD  L     R14,ESDPTR
FREEESD1 LTR   R1,R14
         BZ    FREEESD2
         L     R14,ESDLINK-ESDENTRY(R14)
         LA    R0,LENESD
         FREEMAIN R,LV=(0),A=(1)
         B     FREEESD1
         SPACE 1
FREEESD2 ST    R1,ESDPTR
***      B     FREEIDR        FREE IDR STORAGE TOO (IF ANY)
         SPACE 4
***      IDR TABLE SUBROUTINES
         SPACE 1
FREEIDR  L     R14,IDRPTR
FREEIDR1 LTR   R1,R14
         BZ    FREEIDR2
         L     R14,IDRLINK-IDRENTRY(R14)
         LA    R0,LENIDR
         FREEMAIN R,LV=(0),A=(1)
         B     FREEIDR1
         SPACE 1
FREEIDR2 ST    R1,IDRPTR
         BR    R2
         SPACE 2
GETIDR   OI    FLAGSDD,FIDR   IDR DATA USED
         LA    R0,LENIDR
         GETMAIN R,LV=(0)
         XC    0(LENIDR,R1),0(R1)
         BR    R14
         EJECT
*
*   CHECK FOR REQUIRED DISPOSITION BEFORE ALLOWING AN ALIAS, ATTRIB
*   (WITH ATTRIBUTE CHANGES), DELETE, RENAME OR RESTORE SUBCOMMAND.
*
         SPACE 2
CHKUSER  NI    FLAGSDD,FF-FBLDLOK        FORCE BLDL NEXT TIME
         CLI   DSPALLOC,DA08OLD          DISP=OLD ALREADY?
         AIF   ('&GENDISP' NE 'SHR').NOTSHR
         BR    R14                       ALWAYS USE SHR
         AGO   .SHRSKIP
.NOTSHR  ANOP
         BER   R14                       YES, RETURN
         SPACE 2
         AIF   ('&GENDISP' NE 'OPER').NOTOPER
         L     R2,ADDRPSCB
         USING PSCB,R2
         TM    PSCBATR1,PSCBCTRL         OPERATOR AUTHORITY?
         BOR   R14                       YES, ALLOW SHARED ACCESS
         DROP  R2
.NOTOPER ANOP
         SPACE 2
         MESSAGE MSGREALL                REALLOCATE MESSAGE
         BAL   R2,CLOSEIT                CLOSE THE DATA SET
         BAL   R2,DEALLDCB               DEALLOCATE THE DATA SET
         MVI   DSPALLOC,DA08OLD          SPECIFY DISP=OLD
         MVI   ADDRCMD,C'R'              REALLOCATE FLAG
         B     RESTART2                  REALLOCATE AND TRY AGAIN
.SHRSKIP ANOP
         EJECT
*
*
*        STOW DCB OPEN SUBROUTINE
*
*
         SPACE 3
OPENSTOW TM    DCBOFLGS-IHADCB+STOWDCB,DCBOFOPN  STOW DCB OPEN?
         BOR   R2                                YES, EXIT
         SPACE 2
         MVI   OPENLIST,X'80'
         OPEN  (STOWDCB,OUTPUT),MF=(E,OPENLIST)  OPEN IT FOR OUTPUT NOW
         TM    DCBOFLGS-IHADCB+STOWDCB,DCBOFOPN  STOW DCB OPEN?
         BOR   R2                                YES, BRANCH
         SPACE 2
         MESSAGE MSGNOPEN                        STOW DID NOT OPEN
         SR    R15,R15                           FOR  BZ  TO BRANCH
         BR    R2                                RETURN
         EJECT
*
*        EXCP SUBROUTINE
*
         SPACE 1
EXCP     ST    R14,R14EXCP
         SPACE 1
         ICM   R0,15,STARTTR                NEW TTR?
         BZ    EXCPCONT                     YES, BRANCH
         SRL   R0,8
         BCTR  R0,0                         REDUCE INITIAL TTR BY ONE
         SLL   R0,8
         L     R1,INDCB+(DCBDEBAD-IHADCB)   DEB ADDRESS
         SPACE 2
         STM   R15,R12,12+4(R13)            CONVERT TTR TO MBBCCHHR
         LA    R2,IOBSEEK                   RETURN CCHHR
         L     R15,ADDRCNVT                 TTR TO MBBCCHHR CONVERTER
         LR    R3,R13                       SAVE ADDRESS OF SAVE AREA
         BALR  R14,R15
         LR    R13,R3                       RESTORE SAVE AREA ADDRESS
         LM    R15,R12,12+4(R13)            RESTORE REGISTERS
         SPACE 2
         XC    STARTTR,STARTTR              ZERO THE TTR
         LA    R1,16(,R1)                   CURRENT EXTENT POINTER - 16
         SPACE 1
         SR    R15,R15
EXCP2    LA    R1,16(,R1)                   NEXT EXTENT POINTER
         CLM   R15,1,IOBSEEK                THIS EXTENT?
         LA    R15,1(,R15)
         BNE   EXCP2                        NO, BRANCH
         B     EXCPINIT                     YES, DO THE FIRST READ
         SPACE 3
*    FOR EACH EXTENT, INITIALIZE CCHHR, SECTOR NUMBER AND READ IN THE
*        LENGTH OF THE FIRST RECORD.
         SPACE 1
EXCPXTNT SR    R1,R1                        AFTER THE FIRST EXTENT
         IC    R1,IOBSEEK
         A     R1,=F'1'
         STC   R1,IOBSEEK                   INCREMENT EXTENT NUMBER
         CH    R1,NUMEXT                    WITHIN THE EXTENTS?
         BNL   EXCPDEND                     NO, NO FINAL EOF RECORDED
         L     R1,CUREXT
         LA    R1,16(,R1)                   CURRENT EXTENT ENTRY
         MVC   IOBSEEK+3(4),6(R1)           INITIAL CCHH
         MVI   IOBSEEK+7,0                  INITIAL R=0
         SPACE 2
EXCPINIT ST    R1,CUREXT                    UPDATE FOR LATER
         MVI   SNO,0                        SET SECTOR NUMBER=ZERO
         EJECT
EXCPREST LA    1,CCW1A
         ST    1,IOBCCW                     CHANNEL PROGRAM ADDRESS
         MVI   IOECB,0                      ZERO THE ECB
         EXCP  IOB
         WAIT  ECB=IOECB
         MVC   IOBCCW,EXCPCCWI              CHANNEL PROGRAM ADDRESS
         CLI   IOECB,X'7F'                  GOOD READ?
         BNE   EXCPERR                      NO, INITIAL READ FAILED
         CLI   R14EXCP,C'T'                 TRACK OVERFLOW READ?
         BE    EXCPOVER                     YES, BRANCH
         SPACE 2
EXCPCONT TM    ATTNECB,X'40'                ATTENTION SIGNALLED?
         BO    NEWCMD                       YES, BRANCH
         SPACE 1
         CLI   IOECB,X'42'                  EXTENT VIOLATION LAST TIME?
         BE    EXCPXTNT                     YES, DO THE NEXT EXTENT
         CLI   IOECB,X'7F'                  PREVIOUS READ OK?
         BNE   EXCPREST                     NO, RETRY WITH OTHER EXCP
         MVC   CURMBB(8),IOBSEEK            DISK ADDRESS OF THIS RECORD
         MVC   OLDSNO(1),SNO                SAVE ITS SECTOR NUMBER
         MVC   LS+2(2),DATALN               BLOCK LENGTH FOR THIS READ
         LH    R0,BUFFSIZE
         C     R0,LS                        WILL THIS RECORD FIT?
         BNL   EXCPEXCP                     YES, BRANCH
         ICM   R1,15,BUFFADDR               ANY BUFFER?
         BNP   EXCPGETM                     NO, BRANCH
         FREEMAIN R,LV=(0),A=(1)            YES, FREE IT AND REALLOCATE
         SPACE 2
EXCPGETM L     R0,LS                        MAY NEED EXTRA ISAM BUFFER
         TM    FLAGSDD,RECFMF               RECFM=F..?
         BNO   *+8                          NO, BRANCH
         AH    R0,LRECL                     YES, PROTECT AGAINST S0C4
         CH    R0,=H'32760'                 ABOVE MAXIMUM BUFFER SIZE?
         BNH   *+8                          NO, BRANCH
         LH    R0,=H'32760'                 YES, USE THE MAXIMUM
         STH   R0,BUFFSIZE                  GETMAIN SIZE
         GETMAIN R,LV=(0)                   GET THE STORAGE
         ST    R1,BUFFADDR                  SAVE START ADDRESS
         STCM  R1,7,CCW3+1                  UPDATE CCW ADDRESS
         EJECT
EXCPEXCP MVI   IOECB,0                      ZERO THE ECB
         EXCP  IOB
         WAIT  ECB=IOECB
         SPACE 1
         SR    R15,R15                      ASSUME GOOD READ
         CLI   IOECB,X'42'                  EXTENT PROBLEM (NEXT TIME)?
         BE    EXCPEND                      YES, QUIT
         TM    DSORG+1,DS1ACBM              VSAM DATA SET?
         BO    EXCP7F                       YES, IGNORE DS1LSTAR
         TM    DSORG,DS1DSGIS               ISAM DATA SET?
         BO    EXCP7F                       YES, IGNORE DS1LSTAR
         CLC   CURMBB(8),LSTARMBB           PAST DS1LSTAR?
         BH    EXCPDEND                     YES, END OF DATA SET
         SPACE 1
EXCP7F   CLI   IOECB,X'7F'                  GOOD READ?
         BNE   EXCP41                       NO, BRANCH
         SPACE 2
         TM    SAVRECFM,DCBRECTO            TRACK OVERFLOW DATA SET?
         BNO   EXCPEND                      NO, BRANCH
         CLI   IOBSEEK+7,2                  NEXT R OF CCHHR = 2?
         BNE   EXCPEND                      NO, BRANCH
         CLI   CURMBB+7,1                   THIS R OF CCHHR = 1?
         BE    EXCPEND                      YES, NO ADJUSTMENT
         SPACE 1
*  TRACK OVERFLOW RECORDS READ OK; HOWEVER, THE LENGTH OF AN OVERFLOW
*    RECORD IS INCORRECT (IT EQUALS THE FIRST PART OF THE RECORD).
         SPACE 1
         MVC   LS(2),DATALN                 SAVE NEXT DATA LENGTH
         MVI   IOBSEEK+7,0                  WANT TO GET R=1 LENGTH
         MVI   R14EXCP,C'T'                 NEED A TRACK OVERFLOW READ
         B     EXCPREST
         SPACE 2
EXCPOVER SR    R1,R1                        RETURN FROM OVERFLOW READ
         ICM   R1,3,DATALN                  DATA LENGTH OF R=1
         AH    R1,LS+2                      ADDED TO PREVIOUS PART
         MVC   DATALN(2),LS                 RESTORE NEXT LENGTH
         ST    R1,LS                        FIX RECORD LENGTH
         MVI   IOBSEEK+7,2                  NEXT R OF CCHHR IS 2
         SR    R15,R15                      RETURN CODE ZERO (AGAIN)
         B     EXCPEND
         EJECT
EXCP41   CLI   IOECB,X'41'                  PERMANENT ERROR?
         BNE   EXCPERR                      NO, SOME OTHER DISK ERROR
         SPACE 1
         TM    IOBCSW+4,X'01'               ACTUALLY EOF?
         BNO   EXCPERR                      NO, ERROR
         SPACE 1
         TM    DSORG,DS1DSGPS+DS1DSGDA      DSORG=PS OR DA?
         BM    EXCPDEND                     YES, END OF DATA SET
         TM    DSORG+1,DS1ACBM              VSAM DATA SET?
         BO    EXCPDEND                     YES, END OF DATA SET
         LA    R15,4                        ASSUME END OF MEMBER
         B     EXCPEND                      BRANCH
         SPACE 2
EXCPERR  LA    R15,12                        PERMANENT I/O
         B     EXCPEND                         OR DISK ERROR
         SPACE 1
EXCPDEND LA    R15,8                         END OF DATA SET
EXCPEND  L     R14,R14EXCP                   RETURN ADDRESS
         BR    R14
         EJECT
*
*        CONVERT CURRENT CCHHR TO TTR
*
         SPACE 1
CCHHRTTR STM   R14,R12,12(R13)            SAVE REGISTERS FOR RETURN
         LA    R2,CURMBB                  CCHHR TO CONVERT
         L     R1,INDCB+(DCBDEBAD-IHADCB) DEB ADDRESS
         L     R15,CVTPTR                 START OF CVT
         L     R15,CVTPRLTV-CVT(R15)      ADDRESS OF CCHHR->TTR CONVERT
         LR    R3,R13                     ADDRESS OF SAVE AREA
         BALR  R14,R15                    CALL CONVERT ROUTINE
         LR    R13,R3                     RESTORE SAVE AREA ADDRESS
         ST    R0,12+4+4(R13)             RESULT TTR RETURNED IN R0
         LM    R14,R12,12(R13)            RESTORE REGISTERS
         BR    R14                        RETURN TO CALLER
         SPACE 3
*
*        MAP ENTRY POINT (AND SYMBOL IF AVAILABLE) AND LENGTH
*
         SPACE 1
EPA#LEN MVC    MSGTEXT1,MSGENTRY   ENTRY POINT ADDRESS AND SYMBOL
         UNPK  MSGTEXT1+MSGENTR1-MSGENTRY(7),DIREPA(4)
         TR    MSGTEXT1+MSGENTR1-MSGENTRY(6),TRTABLE
         LH    R15,MSGTEXT1
         LA    R14,MSGTEXT1(R15)
         MVC   0(6,R14),=C'  --  '
         MVC   6(8,R14),ENTRYPT    NAME OF THE ENTRY POINT
         CLI   ENTRYPT,C'?'        ANY FOUND?
         BE    *+8                 NO, BRANCH
         LA    R15,14(,R15)        YES, SHOW ENTRY SYMBOL
         STH   R15,MSGTEXT1
         MESSAGE MSGTEXT1
         SPACE 1
         CLC   SUBNAME,ALIASLIT    ALIAS SUBCOMMAND?
         BER   R2                  YES, DONE
         SPACE 1
         MVC   MSGTEXT1,MSGLEN
         UNPK  MSGTEXT1+MSGLEN1-MSGLEN(7),DIRSTORE(4)
         TR    MSGTEXT1+MSGLEN1-MSGLEN(6),TRTABLE
         MVI   MSGTEXT1+MSGLEN1-MSGLEN+6,X'40'
         SPACE 1
         ICM   R1,7,DIRSTORE       ACTUAL MODULE LENGTH
         LA    R1,1024/2(,R1)      ROUND TO
         SRL   R1,10                       NEAREST K
         CVD   R1,DOUBLE
         ED    MSGTEXT1+MSGLEN2-MSGLEN(6),DOUBLE+5
         MESSAGE MSGTEXT1
         BR    R2
         EJECT
*
*        SUBCOMMAND MESSAGE SUBROUTINES
*
         SPACE 3
MEMEXIST LA    R1,MSGEXIST     MSG - MEMBER EXISTS
         B     MSGNEW
         SPACE 3
NOMEMBER LA    R1,MSGNONE      MSG - MEMBER NOT FOUND
         B     MSGNEW
         SPACE 3
PERMERR  LA    R1,MSGPERMI     MSG - I/O ERROR IN DATA SET
         B     MSGNEW
         SPACE 3
IOERROR  LA    R1,MSGIODIR     MSG - I/O ERROR IN DIRECTORY
         B     MSGNEWXX
         SPACE 3
FULLDIR  LA    R1,MSGNODIR     MSG - DIRECTORY IS FULL
         SPACE 3
MSGNEWXX NI    FLAGSAA,FF-FMEM#MEM       TURN OFF ANY MEMBER GROUP
         SPACE 1
MSGNEW   MESSAGE (R1)          OUTPUT THE MESSAGE POINTED TO
         B     NEWCMD            AND GET A NEW SUBCOMMAND
         EJECT
***********************************************************************
***      ABEND SUBCOMMAND FOR TESTING                               ***
***                                                                 ***
***      KLEAR SUBCOMMAND  (SCREEN CLEAR FOR 3270 SCREENS)          ***
***********************************************************************
*
         SPACE
ABEND    DC    H'0'                S0C1
         SPACE 3
KLEAR    LA    R2,NEWCMD           A K OR KLEAR COMMAND WAS ENTERED
         SPACE 1
CLEAR    ICM   R0,15,PAGESIZE      3270 DISPLAY SCREEN?
         BZR   R2                  NO, RETURN
         SPACE 2
         STFSMODE ON               TURN ON FULLSCREEN MODE
         SPACE 2
         LA    R0,15               SET SIZE FOR TPUT
         LA    R1,=X'27F540115D7E1140401D403C404000'
         ICM   R1,B'1000',=X'03'   FULLSCR OPTION BITS
         TPUT  (1),(0),R           FULL SCREEN TPUT TO CLEAR THE SCREEN
         SPACE 2
CLEAR2   STLINENO LINE=1,MODE=OFF  TURN OFF FULL SCREEN MODE
         SPACE 2
         TCLEARQ INPUT             CLEAR INPUT QUEUE FOR SYNCRONIZATION
         BR    R2
         EJECT
***********************************************************************
***      CHANGE SUBCOMMAND                                          ***
***********************************************************************
*
         SPACE 3
*
CHANGE   BAL   R2,CLOSEIT               CLOSE THE DATA SET
         BAL   R2,DEALLDCB              FREE THE DATA SET
         TM    FLAGSAA,FOPTIONS         ANY OPERANDS?
         BO    RESTART                  YES, BRANCH
         CLI   SAVDSN+1+2,0             ANY OTHER DSNAME?
         BE    CHANGE2                  NO, BRANCH
         XC    SAVDSN+1(SAVLEN),DSNLEN  EXCHANGE
         XC    DSNLEN(SAVLEN),SAVDSN+1          OLD AND NEW
         XC    SAVDSN+1(SAVLEN),DSNLEN                     DSNAMES
         MVC   DSPALLOC,SAVDSN          GET PREVIOUS DISPOSITION
         MVC   SAVDSN(1),DSPREQST       SAVE REQUESTED DISPOSITION
         MVC   DSPREQST,DSPALLOC        GET PREVIOUS DISPOSITION
         SPACE 1
CHANGE2  MVC   MSGTEXT1,MSGDSN
         LH    R1,MSGTEXT1
         LH    R2,DSNLEN
         AR    R2,R1
         STH   R2,MSGTEXT1
         LA    R1,MSGTEXT1-1(R1)        LESS ONE AS IT ENDS WITH '
         MVC   0(44,R1),DSNAME
         AH    R1,DSNLEN
         MVI   0(R1),C''''
         MESSAGE MSGTEXT1
         B     RESTART                  REALLOCATE THE DATA SET
         EJECT
*
*        CLOSE DCB'S AND RELEASE BUFFER SPACE
*
CLOSEIT  ICM   R1,15,BUFFADDR
         BZ    FREENONE
         XC    BUFFADDR,BUFFADDR
         LH    R0,BUFFSIZE
         FREEMAIN R,LV=(0),A=(1)
         SPACE 2
FREENONE MVI   OPENLIST,0
         MVI   OPENLIST+4,X'80'
         CLOSE (INDCB,,STOWDCB),MF=(E,OPENLIST)
         SPACE 1
         BR    R2
         EJECT
*
*        PARSE INTERFACE SUBROUTINE
*
         SPACE 1
GOPARSE  ST    R14,R14PARSE
         CLC   ADDRPCL+1(3),MAINPCL+13  PARSE FOR NEW DATA SET?
         BNE   GOPARSE2                 NO, BRANCH
         STAX  ,                        YES, CANCEL ANY PREVIOUS STAX
GOPARSE2 BAL   R2,FREEPDL               FREE ANY PREVIOUS PARSE STORAGE
         SPACE 2
         LA    R15,PARMLIST             AREA FOR PARSE PARAMETERS
         USING PPL,R15                  BASE FOR PARSE PARAMETER LIST
         SPACE 1
         L     R1,ADDRUPT
         L     R2,ADDRECT
         LA    R3,ATTNECB
         L     R4,ADDRPCL
         LA    R5,ADDRANSR
         L     R6,ADDRCBUF
***      LA    R7,MAINSAVE
         STM   R1,R7,PPLUPT         INITIALIZE PPLUPT, PPLECT, PPLECB
*                                   PPLPCL, PPLANS, PPLCBUF AND PPLUWA
         DROP  R15
         LR    R1,R15
         MVI   ATTNECB,1            FLAG -- CAN BE ATTENTIONED
         SPACE 2
         L     R15,ADDRPARS         INVOKE
         BALR  R14,R15                    PARSE
         STC   R15,R14PARSE
         MVI   ATTNECB,0            CLEAR ATTENTION ECB
         L     R6,ADDRANSR
         SPACE 1
         LTR   R15,R15              GOOD PARSE?
         BNZ   PARSECHK             NO, BRANCH
         SPACE 2
         CLC   SUBNAME,EDITLIT      EDIT SUBCOMMAND?
         BNE   *+10                 NO, BRANCH
         MVC   ANSWERS(24),0(R6)    SAVE FIRST 24 BYTES OF PARSE PDL
         SPACE 2
         USING PDLPRINT,R6          NOTE: THIS PDL IS ALSO USED
*                                         FOR TSOLIST AND SUBMIT
         CLC   SUBNAME,PRINTLIT     PRINTOFF SUBCOMMAND?
         BE    COMMDSAV             YES, SAVE ANY OPERAND
         CLC   SUBNAME,TSOLILIT     TSOLIST SUBCOMMAND?
         BE    COMMDSAV             YES, SAVE ANY OPERAND
         CLC   SUBNAME,SUBLIT       SUBMIT SUBCOMMAND?
         BNE   LISTCHK              NO, TRY LIST
         SPACE 8
COMMDSAV TM    PCLPRSTR+6,X'80'     STRING CODED?
         BNO   PARSECHK             NO, DONE
         LH    R2,PCLPRSTR+4        LENGTH OF STRING
         LTR   R2,R2                NULL STRING CODED?
         BZ    PARSECHK             YES, DONE
         CH    R2,=H'256'           LENGTH(STRING)>=256?
         BL    *+8                  NO, BRANCH
         LH    R2,=H'256'           YES, USE 256 AS A MAXIMUM LENGTH
         STH   R2,COMMDLTH          SAVE ACTUAL LENGTH
         L     R1,PCLPRSTR          NEW STRING ADDRESS
         BCTR  R2,0                 MACHINE LENGTH
         MVC   COMMDSTR(*-*),0(R1)  <<EXECUTED>>
         EX    R2,*-6               MOVE IN ANY OTHER OPERANDS
         SPACE 3
         USING PDLLIST,R6
LISTCHK  CLC   SUBNAME,LISTLIT      LIST SUBCOMMAND?
         BNE   FINDCHK              NO, BRANCH
         CLI   LISTFMT+1,0          WAS A FORMAT SPECIFIED?
         BE    LISTCHK2             NO, QUIT
         NI    FLAGSEE,FF-NONUM-SNUM-BLOCK-DUMP-MULTI-LDUMP
         LH    R15,LISTFMT          FORMAT REQUESTED
         A     R15,=F'-2'           LESS 2 -- NEGATIVE?
         BM    LISTCHK2             YES, BRANCH
         LA    R1,1                 SHIFT VALUE
         SLL   R1,0(R15)            SHIFT INTO POSITION
         OI    FLAGSEE,*-*          <<EXECUTED>>
         EX    R1,*-4               OR INTO FLAG BYTE
         SPACE 1
LISTCHK2 LA    R1,LMAXLENC          MAXLEN
         BAL   R14,PACKMAX          CONVERT TO BINARY
         ST    R1,MAXLEN            SAVE RESULT
         SPACE 1
         LA    R1,LMAXINC           MAXIN
         BAL   R14,PACKMAX          CONVERT TO BINARY
         ST    R1,MAXIN             SAVE RESULT
         SPACE 1
         LA    R1,LMAXOUTC          MAXOUT
         BAL   R14,PACKMAX          CONVERT TO BINARY
         ST    R1,MAXOUT            SAVE RESULT
         SPACE 1
         LA    R1,LSKIPRC           SKIPREC
         BAL   R14,PACKMAX          CONVERT TO BINARY
         ST    R1,SKIPREC           SAVE RESULT
         SPACE 1
         LA    R1,LSKIPCC           SKIPCOL
         BAL   R14,PACKMAX          CONVERT TO BINARY
         ST    R1,SKIPCOL           SAVE RESULT
         SPACE 8
         USING PDLFIND,R6
FINDCHK  CLC   SUBNAME,FINDLIT      FIND COMMAND?
         BNE   MAINPDLR             NO, BRANCH
         TM    FINDSTRG+6,X'80'     STRING CODED?
         BNO   PARSECHK             NO, ASSUME OK
         L     R5,FINDSTRG          NEW STRING ADDRESS
         LH    R2,FINDSTRG+4        LENGTH OF STRING
FINDTEST LTR   R2,R2                NULL STRING CODED?
         BNP   FINDCHK0             YES, CHECK FORMAT
         BCTR  R5,0                 BACK UP ONE
         OI    0(R5),X'40'          UPPER CASE THE DELIMITER
         CLI   0(R5),C'X'           POSSIBLE HEX STRING?
         BNE   FINDCHAR             NO, BRANCH
         LA    R1,MSGHEXBD          BAD HEX STRING MESSAGE
         LA    R3,1(,R2)            STRING LENGTH +1
         N     R3,=F'-2'            NEXT EVEN NUMBER
         SR    R15,R15              ZERO
         LA    R4,MSGTEXT2+4        WHERE OUTPUT GOES
         LA    R0,2                 PAIRWISE COUNTER
         CR    R2,R3                EVEN LENGTH ORIGINALLY?
         SRL   R3,1                 (STRING LENGTH +1)/2
         ST    R3,MSGTEXT2          (STRING LENGTH +1)/2
         BNE   FINDHEX2             NO, BRANCH
         SPACE 1
FINDHEX1 LA    R5,1(,R5)            NEXT CHARACTER
         IC    R15,0(,R5)           GET A BYTE TO CONVERT
         CLI   0(R5),C'0'
         BL    *+12                 0-9?
         CLI   0(R5),C'9'
         BNH   FINDHEX2             YES, BRANCH
         LA    R15,9(,R15)          NO, ADJUST LOW DIGIT 1-5 TO A-F
         CLI   0(R5),C'A'           BELOW AN A?
         BL    FINDNEWS             YES, INVALID
         CLI   0(R5),C'F'           ABOVE AN F?
         BH    FINDNEWS             YES, INVALID
         SPACE
FINDHEX2 SLL   R15,28               SHIFT
         SLDL  R14,4                GET A GOOD DIGIT
         BCT   R0,FINDHEX1          DO THE NEXT DIGIT OF A PAIR
         LA    R0,2                 PAIRWISE COUNTER
         STC   R14,0(,R4)           SAVE AN OUTPUT CHARACTER
         LA    R4,1(,R4)            ANOTHER OUTPUT CHARACTER
         BCT   R3,FINDHEX1          DO ALL DIGITS
         SPACE
         LA    R5,MSGTEXT2+4-1      START OF CONVERTED STRING -1
         L     R2,MSGTEXT2          LENGTH OF CONVERTED STRING
         CH    R2,=H'16'            VALID LENGTH?
         BH    FINDNEWS             NO, BRANCH
         EJECT
FINDCHAR LA    R1,MSGCHRBD          INVALID LENGTH MESSAGE
         CH    R2,=H'16'            VALID LENGTH?
         BH    FINDNEWS             NO, BRANCH
         STH   R2,FINDLTH           SAVE ACTUAL LENGTH
         BCTR  R2,0                 MACHINE LENGTH
         MVC   FINDSTR(*-*),1(R5)   <<EXECUTED>>
         EX    R2,*-6               SAVE THE NEW STRING
         XC    FINDTBL,FINDTBL      RESET THE TRT TABLE
         SR    R15,R15
         IC    R15,FINDSTR          FIRST CHARACTER OF NEW STRING
         LA    R1,FINDTBL(R15)      ADDRESS OF NEW TRT BYTE
         MVI   0(R1),X'77'          SET TRT BYTE TO NON-ZERO
         B     FINDCHK0             TERMINATE
         SPACE 2
FINDNEWS MESSAGE (R1)               INVALID LENGTH STRING -- REENTER
FINDNEW0 LA    R2,NEWCMD            EXIT ADDRESS FOR ATTENTION
        $PUTGET MSGRESTR,ATTN=FREEPDL  SECOND PART OF MESSAGE
         L     R5,ADDRCBUF          ENTERED DATA
         LH    R2,0(,R5)            LENGTH OF STRING
         SH    R2,=H'5'             VALID MACHINE LENGTH?
         LA    R1,4(R5,R2)          LAST BYTE OF INPUT STRING
         BZ    FINDNEW3             MAYBE, CHECK FURTHER
         BNP   FINDNEW0             NO, NULL STRING -- PROMPT AGAIN
         SPACE 1
FINDNEW1 CLI   0(R1),X'40'          SCAN
         BNE   FINDNEW2                 BACKWARDS
         BCTR  R1,0                              FOR A
         BCT   R2,FINDNEW1                             NON-BLANK
         B     FINDNEW3             POSSIBLE STRING -- CHECK
         SPACE 1
FINDNEW2 CLI   4(R5),X'40'          SCAN
         BNE   FINDNEW3                 FORWARDS
         LA    R5,1(,R5)                        FOR A
         BCT   R2,FINDNEW1                            NON-BLANK
         SPACE 1
FINDNEW3 CLI   4(R5),X'40'          REAL STRING?
         BE    FINDNEW0             NO, PROMPT AGAIN
         MVI   MSGTEXT1,X'40'       BLANKS FOR
         MVC   MSGTEXT1+1(40),MSGTEXT1        UPPER-CASING INPUTS
         OC    4(*-*,R5),MSGTEXT1   <<EXECUTED>>
         EX    R2,*-6               UPPER-CASE DATA AND DELIMITERS
         CLC   0(1,R1),4(R5)        SAME DELIMITERS?
         BNE   *+6                  NO, BRANCH
         BCTR  R2,0                 YES, ALLOW FOR LAST DELIMITER
         LA    R5,5(,R5)            FIRST CHARACTER OF STRING
         B     FINDTEST             PARSE THIS NEW STRING
         EJECT
FINDCHK0 CLI   FINDLIST+1,1         FINDLIST SPECIFIED?
         BNE   FINDCHK1             NO, BRANCH
         OI    FLAGSAA,FIND1        YES, TURN ON THE FLAG
         SPACE 1
FINDCHK1 CLI   FINDFMT+1,0          WAS A FORMAT SPECIFIED?
         BE    FINDCHK2             NO, BRANCH
         NI    FLAGSEE,FF-NONUM-SNUM-BLOCK-DUMP-MULTI-LDUMP
         LH    R15,FINDFMT          FORMAT REQUESTED
         A     R15,=F'-2'           LESS 2 -- NEGATIVE?
         BM    FINDCHK2             YES, BRANCH
         LA    R1,1                 SHIFT VALUE
         SLL   R1,0(R15)            SHIFT INTO POSITION
         OI    FLAGSEE,*-*          <<EXECUTED>>
         EX    R1,*-4               MOVE INTO FLAG BYTE
         SPACE 1
FINDCHK2 LA    R1,FMAXLENC          MAXLEN
         BAL   R14,PACKMAX          CONVERT TO BINARY
         ST    R1,MAXLEN            SAVE RESULT
         SPACE 1
         LA    R1,FMAXINC           MAXIN
         BAL   R14,PACKMAX          CONVERT TO BINARY
         ST    R1,MAXIN             SAVE RESULT
         SPACE 1
         LA    R1,FMAXOUTC          MAXOUT
         BAL   R14,PACKMAX          CONVERT TO BINARY
         ST    R1,MAXOUT            SAVE RESULT
         SPACE 1
         LA    R1,FSKIPRC           SKIPREC
         BAL   R14,PACKMAX          CONVERT TO BINARY
         ST    R1,SKIPREC           SAVE RESULT
         SPACE 1
         LA    R1,FSKIPCC           SKIPCOL
         BAL   R14,PACKMAX          CONVERT TO BINARY
         ST    R1,SKIPCOL           SAVE RESULT
         B     PARSECHK
         SPACE
PACKMAX  LH    R15,4(,R1)           NUMBER OF DIGITS
         S     R15,=F'1'            ANY CODED?
         BM    4(R14)               NO, RETURN AT +4
         L     R1,0(,R1)            POINT TO INPUT STRING
         EX    R15,PACKNUMB         PACK ALL THE DIGITS
         CVB   R1,DOUBLE            CONVERT TO BINARY
         BR    R14                  RETURN AT +0
         SPACE
PACKNUMB PACK  DOUBLE(8),0(*-*,R1)  <<EXECUTED>>
         EJECT
         USING MAINPDL,R6
MAINPDLR CLC   ADDRPCL+1(3),MAINPCL+13 PARSE NEW DATA SET?
         BNE   PARSECHK                NO, BRANCH
         MVC   VOLUME,BLANKS        INITIALIZE VOLUME NAME
         TM    VOLNAME+6,X'80'      ANY NAME REQUESTED?
         BNO   MAINPDL2             NO, BRANCH
         LH    R15,VOLNAME+4        LENGTH OF NAME
         S     R15,=F'1'            VALID?
         BM    MAINPDL2             NO, BRANCH
         L     R1,VOLNAME           ADDRESS OF NAME
         MVC   VOLUME(*-*),0(R1)    <<EXECUTED>>
         EX    R15,*-6              MOVE IN THE NAME
         SPACE 1
MAINPDL2 MVI   DSPALLOC,DA08SHR     ASSUME DISP=SHR
         MVI   DSPREQST,DA08SHR     ASSUME DISP=SHR
         CLI   OPTDISP+1,1          CORRECT?
         BNE   MAINPDL4             NO, BRANCH
         MVI   DSPALLOC,DA08OLD     DISP=OLD
         MVI   DSPREQST,DA08OLD     DISP=OLD
         DROP  R6
         SPACE 1
MAINPDL4 TM    FLAGSBB,FQUOTE       QUOTED DATA SET NAME?
         BO    PARSECHK             YES, BRANCH
         CLI   VOLUME,X'40'         ANY VOLUME NAME SPECIFIED?
         BNE   PARSECHK             YES, ASSUME NO CATALOG USE
*  NEED TO FULLY QUALIFY THE DATA SET NAME
         USING DFPL,R6
         LA    R6,PARMLIST          START OF DFPL PARAMETER LIST
         L     R1,ADDRUPT
         L     R2,ADDRECT
         LA    R3,ATTNECB
         LA    R4,PARMLIST+16
         STM   R1,R4,DFPLUPT        INITIALIZE DFPLUPT, DFPLECT,
*                                              DFPLECB AND DFPLDFPB
         USING DFPB,R6
         LR    R6,R4
         LA    R1,DSNLEN            DSNAME LENGTH, DSNAME
         L     R2,ADDRPSCB          PSCB
         LA    R3,DOUBLE            BLANK DEFAULT QUALIFIER
         SR    R4,R4                NO USER CATALOG
         LA    R5,PASSWORD
         STM   R1,R5,DFPBDSN        INITIALIZE DFPBDSN, DFPBPSCB,
*                                     DFPBQUAL, DFBCAT AND DFPBPSWD
         MVI   DFPBCNTL,DFPBRET     ADD LOW-LEVEL QUALIFIER
         MVI   DFPBCODE,DFPB04      ENTRY CODE X'04'
         MVC   DOUBLE(8),BLANKS     BLANK DEFAULT QUALIFIER
         DROP  R6
         SPACE 1
         LA    R1,PARMLIST          ADDRESS OF PARM LIST
         L     R15,ADDRDEFT         DEFAULT ROUTINE ADDRESS
         BALR  R14,R15
         EJECT
PARSECHK SR    R15,R15
         IC    R15,R14PARSE
         SPACE 1
         LA    R14,MAXPARSE         RETURN CODE LIMIT
         CR    R15,R14              RETURN CODE WITHIN LIMITS?
         BH    PARSEBAD             NO, ERROR
         SPACE 1
         B     *+4(R15)             PROCESS RETURN CODE
PARSERET B     PARSEOK              00 - SUCCESSFUL
         B     EXIT8                04 - PARSE UNABLE TO PROMPT
         B     PARSERR              08 - USER ENTERED ATTENTION
         B     PARSEBAD             12 - INVALID PARAMETERS
         B     PARSEBAD             16 - PARSE INTERNAL FAILURE
         B     EXIT8                20 - VALIDITY CHECK ERROR
MAXPARSE EQU   *-PARSERET
         SPACE 2
PARSEBAD LA    R1,GFPARMS
         ST    R1,GFPARMP           SAVE ADDRESS OF PARMLIST
         L     R0,ADDRFF02          ADDRESS OF IKJEFF02
         STM   R15,R0,GFRCODE       SAVE GFRCODE AND GF02PTR
         LA    R1,GFPARSE
         STH   R1,GFCALLID          SAVE CALLER-ID FOR PARSE
         L     R0,ADDRCPPL          CPPL
         LA    R1,ATTNECB           ATTENTION ECB
         STM   R0,R1,GFCPPLP        SAVE GFCPPLP AND GFECBP
         MVI   ATTNECB,0            CLEAR THE ECB
         LINK  EP=IKJEFF19,MF=(E,GFPARMP)
         CLI   R14PARSE,X'4'        USER ENTER ATTENTION?
         BE    PARSERR              YES, BRANCH -- IGNORE COMMAND
         LTR   R15,R15              ERROR MESSAGE OUTPUT?
         BZ    EXIT8                YES, BRANCH
         CVD   R15,DOUBLE
         MVC   MSGTEXT1,MSGGENF     GENERAL FAIL ROUTINE FAILED
         ED    MSGTEXT1+MSGGENF1-MSGGENF(4),DOUBLE+6
         MVI   MSGTEXT1+MSGGENF1-MSGGENF,C'='
         MESSAGE MSGTEXT1
         B     EXIT8
         SPACE 1
PARSERR  L     R14,R14PARSE         RETURN AT OFFSET 0
         BR    R14
         SPACE 1
PARSEOK  L     R14,R14PARSE         RETURN AT OFFSET 4
         B     4(,R14)              EXIT FROM PARSE
         EJECT
EXIT12   MVI   RETURNCD+3,12  CBT-AXC   ERROR CODE 12 (NO CLOSE & FREE)
         B     RETURN2
         SPACE
PUTERROR DS    0H
GETERROR DS    0H
EXIT8    MVI   RETURNCD+3,8   CBT-AXC   ERROR CODE 8
         B     RETURN
         SPACE
EXIT0    DS    0H
         TM    FLAGSFF,FSPFOPT6         UNDER SPF OPTION 6?
         BNO   *+8                      NO, BRANCH
         BAL   R2,CLEAR                 YES, CLEAR THE SCREEN
         SPACE 3
RETURN   BAL   R2,CLOSEIT               CLOSE THE DATA SET
         BAL   R2,DEALLDCB              FREE THE DATA SET TOO
         SPACE 1
RETURN2  ICM   R5,15,RETURNCD CBT-AXC   NORMAL EXIT?
         BZ    RETURN4                  YES, BRANCH
         SPACE 2
         LA    R1,PARMLIST              AREA FOR STACK PARM LIST
         USING IOPL,R1
         SPACE
         L     R2,ADDRUPT
         L     R3,ADDRECT
         LA    R4,ATTNECB
         STM   R2,R4,IOPLUPT            INITIALIZE IOPLUPT, IOPLECT,
         DROP  R1
         SPACE 2
         MVI   ATTNECB,0
         L     R15,ADDRSTCK             STACK ROUTINE
         STACK PARM=PARMLIST+16,DELETE=ALL,MF=(E,(1)),ENTRY=(15)
         SPACE 2
         TCLEARQ INPUT                  CLEAR INPUT BUFFERS
         SPACE 3
         EJECT
RETURN4  BAL   R2,FREEESD               FREE ANY ESD AND IDR STORAGE
         BAL   R2,FREEPDL               FREE THE PARSE STORAGE
         BAL   R14,FREEBUFF             FREE THE PUTGET BUFFER
         STAX  ,                        CANCEL ANY OUTSTANDING STAX
***      STAE  0,OV                     CANCEL STAE EXIT  ***.NOSTAE
         SPACE 2
         AIF (NOT &SPFGEN).NOSPFX4
         TM    FLAGSFF,FSPFCALL         TERMINATE SPF TOO?
         BNO   RETURN6                  NO, BRANCH
         L     R13,4(,R13)              PREVIOUS SAVE AREA
         LM    R14,R12,12(R13)          SAVE REGISTERS
         LA    R15,4                    RC=4 -- SIMULATES RETURN KEY
         BR    R14                      RETURN TO SPF
.NOSPFX4 ANOP
         SPACE 2
RETURN6  LR    R13,R7                   ADDRESS OF THE FIRST SAVE AREA
         LR    R15,R5                   RETURN CODE
         SPACE
         L     R0,WORKSIZE
         SPACE
         EXIT  LV=(0)
         SPACE 3
         AGO .NOSTAE          *** NO STAE PROCESSING IS CURRENTLY DONE
         EJECT
*
*        STAE EXIT
*
         SPACE 3
         USING *,R15                    TEMPORARY BASE
STAEEXIT CH    R0,STAECODE              WORK AREA PROVIDED?
         BE    STAE1                    NO, BRANCH
         SPACE
         L     R7,0(,R1)                YES, GET OUR WORK AREA ADDR
         B     STAE2
         SPACE 2
STAE1    LR    R7,R2                    OUR WORK AREA ADDR
         SPACE 2
STAE2    STM   R0,R15,STAEREGS
         SPACE 2
         LM    R8,R12,BASES
         DROP  R15
         SPACE 2
         LM    R0,R15,STAEREGS
         SR    R15,R15                  NO RETRY EXIT
         BR    R14
         SPACE
STAECODE DC    H'20'
.NOSTAE  ANOP
         EJECT
*
*        FREE DATA SET NO LONGER REQUIRED
*
         SPACE 2
DEALLDCB DS    0H                 ** CONDITIONAL FREE OF FILE
         TM    FLAGSDD,FPERMDS    DATA SET PERMANENTLY ALLOCATED?
         BOR   R2                 YES, SKIP EXPLICIT FREE
         SPACE 1
DEALLOCZ LA    R6,DAIR18          ** ALWAYS FREE (EXCEPT SYSHELP AND
         XC    DAIR18,DAIR18                             SYSPROC)
         USING DAPB18,R6
         MVI   DA18CD+1,X'18'
         MVC   DA18DDN,DDNAME          DEALLOCATE THE DATA SET
         CLC   DDNAME(8),=C'SYSHELP '  SYSHELP DDNAME?
         BE    *+8                     YES, BRANCH
         OI    DA18CTL,DA18PERM        DEALLOCATE "PERM" ALLOCATED TOO
         CLC   DDNAME(8),=C'SYSPROC '  SYSPROC DDNAME?
         BER   R2                      YES, BRANCH
         SPACE
         LA    R1,PARMLIST             DYNALLOC PARAMETER LIST
         USING DAPL,R1
         SPACE
         L     R3,ADDRUPT
         ST    R3,DAPLUPT              SAVE DAPLUPT
         SPACE
         L     R3,ADDRECT
         LA    R4,ATTNECB
         L     R5,ADDRPSCB
***      LA    R6,DAIR18
         STM   R3,R6,DAPLECT           SAVE DAPLECT, DAPLECB,
*                                           DAPLPSCB AND DAPLDAPB
         SPACE
         MVI   ATTNECB,0
         DROP  R1,R6
         SPACE 2
         L     R15,ADDRDAIR
         BALR  R14,R15                 CALL DAIR TO FREE THE FILE
         SPACE 2
         BR    R2
         EJECT
*
*        DATA SET ALLOCATION SUBROUTINE
*
         SPACE 2
ALLOCATE ST    R14,R14SAVE             SAVE LINKAGE REGISTER
         NI    FLAGSDD,FF-FRECOVER     CLEAR RECOVERY PROMPT FLAG
         SPACE 2
RETRY    NI    FLAGSDD,FF-FPERMDS      CLEAR PERMANENT STATUS
         SPACE 2
         LA    R6,DAIR08               POINT TO THE DAIR BLOCK
         XC    DAIR08,DAIR08
         USING DAPB08,R6
         MVI   DA08CD+1,X'08'          DATA SET ALLOCATION CODE
         SPACE
         LA    R0,DSNLEN               ADDR OF DSNAME FIELD
         ST    R0,DA08PDSN
         SPACE
         MVC   DA08PSWD,PASSWORD       PASSWORD
         MVC   DA08DDN,BLANKS          NO DDNAME
         MVC   DA08SER,VOLUME          VOLUME SPECIFIED (OR BLANKS)
         MVC   DA08MNM,BLANKS          NO MEMBER NAME
         MVC   DA08UNIT,BLANKS         NO UNIT REQUESTED
         CLI   VOLUME,X'40'            VOLUME SERIAL SPECIFIED?
         BE    *+10                    NO, BRANCH (CATALOG LOOKUP)
         MVC   DA08UNIT,=C'SYSALLDA'   YES, DEFAULT UNIT IS SYSALLDA
         SPACE
*                                      DISP=(SHR,KEEP,KEEP)
         MVC   DA08DSP1,DSPALLOC         OR DISP=(OLD,KEEP,KEEP)
         MVI   DA08DPS2,DA08KEEP
         MVI   DA08DPS3,DA08KEP
         OI    DA08CTL,DA08PERM         MUST BE SPECIFICALLY UNALLOC.
         SPACE 2
         LA    R1,PARMLIST              DYNALLOC PARAMETER LIST
         USING DAPL,R1
         SPACE
         L     R2,ADDRUPT
         L     R3,ADDRECT
         LA    R4,ATTNECB
         L     R5,ADDRPSCB
***      LA    R6,DAIR08
         STM   R2,R6,DAPLUPT            SAVE DAPLUPT, DAPLECT, DAPLECB,
*                                            DAPLPSCB AND DAPLDAPB
         SPACE 2
         MVI   ATTNECB,0
         L     R15,ADDRDAIR
         BALR  R14,R15
         EJECT
         LTR   R15,R15                  SUCCESSFUL?
         BNZ   DAIRFAIL                 NO, ERROR
         MVC   DDNAME,DA08DDN           SAVE DDNAME
         SPACE
         CLC   DDNAME(3),=C'SYS00000'   TEMPORARY TYPE DDNAME?
         BNE   NOTTEMP                  NO, BRANCH
         NC    DA08DDN(8),=C'SYS00000'  TURN OFF NUMERIC DIGITS
         CLC   DA08DDN(8),=C'SYS00000'  TEMPORARY TYPE DDNAME?
         BE    TEMPDSN                  YES, BRANCH
NOTTEMP  OI    FLAGSDD,FPERMDS          MARK AS "PERMANENT"
         SPACE
TEMPDSN  MVC   DSORG(1),DA08DSO         SAVE DSORG
         TM    DA08DSO,DS1DSGPO         PARTITIONED?
         BO    GOTALLOC                 YES, DONE
         DROP  R1,R6
         SPACE 2
         LA    R1,X'100'                TTR=1
         ST    R1,DIRTTR                SAVE FOR LATTER
         MESSAGE MSGNLIB                OUTPUT A WARNING MESSAGE
         SPACE 2
GOTALLOC L     R14,R14SAVE              RETURN AT
         B     4(R14)                            +4 (SUCCESSFUL)
         SPACE 2
DAIRFAIL CLC   ENDLIT(3),DSNAMEH        WAS "END" ENTERED BY THE USER?
         BNE   DAIRR15                  NO, BRANCH
         CLI   DSNAMEH+3,0              WITH A FOLLOWING NULL?
         BE    NOTALLOC                 YES, TERMINATE THE PROGRAM
         SPACE 1
DAIRR15  ST    R15,DAIRRC               SAVE DAIR RETURN CODE
         SPACE 2
         LA    R14,PARMLIST             POINTER TO DAIR PARAMETER LIST
         LA    R15,DAIRRC               POINTER TO RETURN CODE
         LA    R0,ADDRFF02              POINTER TO A(IKJEFF02)
         LA    R1,=AL2(DFDAIR)          POINTER TO INVOCATION TYPE
         L     R2,ADDRCPPL              POINTER TO THE CPPL
         STM   R14,R2,DFDAPLP           INITIALIZE DFDAPLP, DFDRCP,
*                                         DFJEFF02, DFIDP AND DFCPPLP
         SPACE 1
         LINK  EP=IKJEFF18,MF=(E,DFPARMS)
         LTR   R15,R15                  PROBLEM WITH IKJEFF18?
         BZ    FAILBAD2                 NO, BRANCH
         EJECT
FAILBAD  CVD   R15,DOUBLE
         MVC   MSGTEXT1,MSGDAIRX        DAIRFAIL ROUTINE FAILED
         ED    MSGTEXT1+MSGDAIR1-MSGDAIRX(4),DOUBLE+6
         MVI   MSGTEXT1+MSGDAIR1-MSGDAIRX,C'='
         MESSAGE MSGTEXT1
         SPACE 1
FAILBAD2 CLI   DSPREQST,DA08OLD         DISP=OLD REQUESTED?
         BE    RECOVERY                 YES, ATTEMPT RETRY
         CLI   DSPALLOC,DA08OLD         OLD ALLOCATION ATTEMPT?
         BNE   RECOVERY                 NO, REALLOCATE
         SPACE 1
         MVI   DSPALLOC,DA08SHR         YES, RETRY WITH DISP=SHR
         MVI   ADDRCMD,X'40'            TURN OFF THE REALLOCATE FLAG
         NI    FLAGSAA,FF-FMEM#MEM      TURN OFF MEMBER GROUPS
         B     RETRY
         SPACE 2
RECOVERY OI    FLAGSDD,FRECOVER         DATA SET RECOVERY ROUTINE
        $PUTGET MSGRETRY,ATTN=NOTALLOC
         SPACE 2
         TM    FLAGSBB,FNULL            USER WANT ANOTHER DATA SET?
         BO    RECOVERY                 NULL REPLY, ASK AGAIN
         SPACE
         MVC   ADDRPCL(4),MAINPCL+12
         BAL   R14,GOPARSE              INVOKE PARSE
         B     NOTALLOC                 EXIT - PARSE FAILURE
         B     RETRY                    SUCCESSFUL - RETRY ALLOCATION
         SPACE 2
NOTALLOC L     R14,R14SAVE              ERROR EXIT - NOT ALLOCATED
         BR    R14
         EJECT
*
*
*        MESSAGE PROCESSING (MULTILEVEL MESSAGES HAVE BEEN DISABLED)
*
*
         SPACE 1
MESSTXT1 LA    R1,MSGTEXT1              OUTPUT MSGTEXT1
         SPACE 1
MESSAGE0 ST    R14,R14PUTM              SAVE LINKAGE REGISTER
        $PUTLINE (R1),ATTN=NEWCMD       DEFAULT INTERRUPT ADDRESS
         L     R14,R14PUTM              RESTORE LINKAGE REGISTER
         BR    R14                      RETURN
         SPACE 3
         AGO   .NOMULTI       NO-MULTILEVEL MESSAGES ARE USED NOW
MESSAGE0 SR    R0,R0          NO SECOND LEVEL MESSAGE
         SPACE 3
MESSAGE  ST    R14,R14SAVE    OUTPUT ONE OR TWO MESSAGES
         LTR   R0,R0          SECOND LEVEL MSG?
         BZ    ERRORM1        NO
         SPACE
         MVC   MSGTEXT1,0(R1) INSURE MSG IN WORK AREA
         LA    R1,MSGTEXT1
         LH    R14,0(R1)      LENGTH OF FIRST LEVEL MSG
         LA    R15,0(R14,R1)  ADDR OF END OF MSG
         LA    R14,1(R14)     JUMP MSG LENGTH
         STH   R14,0(R1)
         MVI   0(R15),C'+'    INDICATE SECOND LEVEL MSG EXISTS
         SPACE
         SR    R14,R14        CLEAR CHAIN FIELD
         LA    R15,1          ONE SEGMENT IN 2ND MSG
         STM   R14,R0,PUTOLD2 CREATE SECOND-LEVEL
*                             OUTPUT LINE DESCRIPTOR ('OLD')
         LA    R0,PUTOLD2
         SPACE 2
ERRORM1  LR    R14,R0         NEXT 'OLD' ADDR OR ZERO
         LA    R15,1          ONE SEGMENT
         LR    R0,R1          MSG ADDR
         STM   R14,R0,PUTOLD1 FIRST LEVEL 'OLD'
         SPACE
         LA    R1,PARMLIST
         USING IOPL,R1
         MVC   IOPLECT,ADDRECT
         MVC   IOPLUPT,ADDRUPT
         LA    R0,ATTNECB
         ST    R0,IOPLECB
         DROP  R1
         MVI   ATTNECB,0
         L     R15,ADDRPUTL
         XC    PARMLIST+16(4),PARMLIST+16
         PUTLINE PARM=PARMLIST+16,ENTRY=(15),MF=(E,(1)),               X
               OUTPUT=(PUTOLD1,TERM,MULTLVL,INFOR)
         L     R14,R14SAVE
         BR    R14
.NOMULTI ANOP
         EJECT
*
*
*        PUTLINE PROCESSING
*
*
         SPACE 1
$PUTLINE TM    ATTNECB,X'40'          ATTN OCCUR?
         BOR   R14                    YES, IMMEDIATE RETURN
         ST    R14,R14PUTL
         SPACE
         LR    R0,R1                  SAVE DATA LINE POINTER
         LA    R1,PARMLIST
         USING IOPL,R1
         L     R14,ADDRUPT
         L     R15,ADDRECT
         STM   R14,R15,IOPLUPT       INITIALIZE IOPLUPT AND IOPLECT
         SPACE
         LA    R15,ATTNECB
         ST    R15,IOPLECB           INITIALIZE IOPLECB
         DROP  R1
         SPACE
         L     R15,ADDRPUTL
         SPACE 2
         PUTLINE PARM=PUTLPARM,ENTRY=(15),MF=(E,(1)),                  X
               OUTPUT=((0),TERM,SINGLE,DATA),                          X
               TERMPUT=(EDIT,WAIT,NOHOLD,NOBREAK)
         SPACE 2
         L     R14,R14PUTL           RETURN ADDRESS (+0 OR +4)
         TM    ATTNECB,X'40'         ATTN OCCUR?
         BOR   R14                   YES, RETURN AT +0
         SPACE 2
         CH    R15,=H'4'             PUTLINE ERROR SIGNALLED?
         BH    PUTERROR              YES, BRANCH
         B     4(R14)                NO, RETURN AT +4
         EJECT
*
*
*        PUTGET PROCESSING
*
*
         SPACE 3
$PUTGET  TM    ATTNECB,X'40'         ATTN OCCUR?
         BOR   R14                   YES, IMMEDIATE RETURN
         ST    R14,R14PTGT
         NI    FLAGSBB,FF-FNULL
         SPACE
         LA    R0,1                  ONLY ONE SEGMENT
         STM   R0,R1,PUTOLD1
         SPACE 2
PUTGET0  BAL   R14,FREEBUFF          RELEASE ANY PREVIOUS PUTGET BUFFER
         LA    R1,PARMLIST
         L     R14,ADDRUPT
         L     R15,ADDRECT
         LA    R0,ATTNECB
         STM   R14,R0,IOPLUPT-IOPL(R1)  INITIALIZE IOPLUPT, IOPLECT,
*                                                  AND IOPLECB
         L     R15,ADDRPTGT
         SPACE
         PUTGET PARM=PTGTPARM,MF=(E,(1)),ENTRY=(15),                   X
               OUTPUT=(PUTOLD1,SINGLE,MODE),                           X
               TERMPUT=(EDIT,WAIT,NOHOLD,NOBREAK),                     X
               TERMGET=(EDIT,WAIT)
         SPACE
         STC   R15,PARMLIST          SAVE RETURN CODE
         CLI   PARMLIST,12           PUTGET STATUS:
         BH    GETERROR                ERROR -- BRANCH
         BL    PUTGET1                 SUCCESSFUL, STACK OR ATTENTION
         L     R1,ADDRECT              STACK, 2ND-LEVEL MSG., NO PAUSE
         OI    ECTMSGF-ECT(R1),X'80' IGNORE SECOND LEVEL MESSAGES AND
         B     PUTGET0               GET THE DATA FROM THE STACK
         EJECT
PUTGET1  SR    R15,R15               ASSUME RETURN AT +0
         TM    ATTNECB,X'40'         ATTN OCCUR?
         BO    PUTGET8               YES, BRANCH
         SPACE
         LA    R1,PTGTPARM PUTGET    PARM AREA START
         L     R1,PGPBIBUF-PGPB(R1)  INPUT BUFFER ADDRESS
         SPACE 2
***
*** PFK SUPPORT WILL BE PROVIDED IN THE NEAR FUTURE --
***
***  EARLY TESTS WITH PUTGET ASIS INPUT UNCOVERED THREE PROBLEMS WITH
***  PUTGET SUPPORT MODULES IKJEFT45 AND IKJEFT55 (APAR OZ65820):
***   A.  ? PROCESSING DOES NOT WORK (IKJEFT45)
***   B.  PAUSE PROCESSING DOES NOT WORK (IKJEFT45)
***   C.  A PF KEY OR NULL LINE ENTERED ON A 3270 IN THE FIRST COLUMN
***       OF LINES 3, 7, 11, 15, ... IS NOT PROVIDED TO THE PUTGET
***       REQUESTOR.  SINCE ITS LAST SCREEN ADDRESS CHARACTER IS AN
***       X'60' OR MINUS, THIS LINE IS CONCATENATED WITH THE NEXT
***       LINE ENTERED BY THE USER.
***
         SPACE 2
         ST    R1,ADDRCBUF           SAVE THE SUBCOMMAND ADDRESS
         LA    R15,4                 ASSUME RETURN AT +4
         CH    R15,0(,R1)            A NULL LINE?
         BL    PUTGET8               NO, BRANCH
         OI    FLAGSBB,FNULL         YES, INDICATE A NULL LINE
         SPACE 2
PUTGET8  L     R14,R14PTGT
         B     0(R14,R15)
         EJECT
*
*        PUTGET BUFFER RELEASE ROUTINE
*
         SPACE 1
FREEBUFF TM    FLAGSBB,FCMD          BUFFER IN USE?
         BOR   R14                   YES, LEAVE IT
         ICM   R1,15,ADDRCBUF        ANY BUFFER?
         BZR   R14                   NO, BRANCH (DO NOT FREEMAIN)
         SPACE
         LH    R0,0(R1)              BUFFER LENGTH
         ICM   R0,B'1000',=X'01'     SUBPOOL IS 1
         SPACE
         FREEMAIN R,LV=(0),A=(1)
         SPACE
         XC    ADDRCBUF,ADDRCBUF
         BR    R14
         SPACE 4
*
*        PARSE CLEANUP ROUTINE
*
         SPACE 1
FREEPDL  IKJRLSA ADDRANSR            RELEASE THE STORAGE
         SPACE
         XC    ADDRANSR,ADDRANSR
         BR    R2
         EJECT
*
*        DCB OPEN EXIT
*
         USING IHADCB,R1
OPENEXIT MVC   SAVRECFM(1),DCBRECFM            SAVE RECORD FORMAT BYTE
         NI    FLAGSDD,FF-RECFMU-RECFMV-RECFMF CLEAR TEST BITS
         XI    FLAGSDD,RECFMU                  ASSUME RECFM=U
         TM    DCBRECFM,DCBRECU                CORRECT?
         BO    OPENEXT2                        YES, BRANCH
         XI    FLAGSDD,RECFMU+RECFMV           ASSUME RECFM=V
         TM    DCBRECFM,DCBRECV                CORRECT?
         BO    OPENEXT2                        YES, BRANCH
         XI    FLAGSDD,RECFMV+RECFMF           ASSUME RECFM=F
         NI    DCBRECFM,FF-DCBRECSB            DROP ANY S OF RECFM=FBS
         TM    DCBRECFM,DCBRECF                CORRECT?
         BO    OPENEXT2                        YES, BRANCH
         XI    FLAGSDD,RECFMV                  NO, INDICATE UNKNOWN
         SPACE
OPENEXT2 ICM   R0,15,BUFFADDR                  BUFFER PRESENT?
         BNZR  R14                             YES, DONE
         SPACE 2
         LH    R2,DCBBLKSI                     GET SIZE OF BUFFER
         MVC   LRECL,DCBLRECL                  SAVE LRECL
         STH   R2,BLKSI                        SAVE BLOCKSIZE
         LR    R3,R14                          SAVE R14
         CH    R2,=H'256'                      BUFFSIZE>256?
         BH    *+8                             YES, BRANCH
         LH    R2,=H'256'                      NO, USE 256 AS A MINIMUM
         TM    DCBRECFM,DCBRECTO               RECFM=.T?
         BNO   *+8                             NO, BRANCH
         LH    R2,=H'32760'                    YES, USE THE MAXIMUM
         SPACE 1
         GETMAIN EC,LV=(R2),SP=0,A=BUFFADDR,MF=(E,PARMLIST)
         SPACE 1
         LR    R14,R3                          RESTORE R14
         LTR   R15,R15                         SUCCESSFUL?
         BZ    OPENEXT4                        YES, BRANCH
         SPACE 1
         SR    R2,R2                           NO, INSURE ZERO LENGTH
         ST    R2,BUFFADDR                     NO, INSURE ZERO POINTER
         SPACE 1
OPENEXT4 STH   R2,BUFFSIZE                     SAVE BUFFER SIZE
         BR    R14
         EJECT
*
*
*        ENTRY-POINT ADDRESS VALIDITY CHECK SUBROUTINE
*
*
         SPACE 2
CHKNTRY  ENTER VALCHECK
         L     R15,0(R6)
         LH    R14,4(R6)
         CH    R14,=H'6'
         BNE   NTRYER
         MVC   DBLWD(6),0(R15)
         LA    R14,6
         LA    R15,DBLWD
CONTNI   EQU   *
         NI    0(R15),X'3F'
         LA    R15,1(R15)
         BCT   R14,CONTNI
         TR    DBLWD(6),TRTAB
         TRT   DBLWD(6),ZEROES
         BZ    NTRYOK
NTRYER   EQU   *
         MESSAGE NTRYINV
         LA    R15,8
         B     NTRYEX
TRTAB    DS    0CL64
         DC    X'FF0A0B0C0D0E0F'
         DC    41XL1'FF'
         DC    X'00010203040506070809'
         DC    6XL1'FF'
         DC    0F'0'
ZEROES   DC    16XL1'00'
         DC    240XL1'FF'
         LTORG
NTRYINV  MSG   ' INVALID ENTRY-POINT ADDRESS'
         DS    0H
NTRYOK   EQU   *
         PACK  ENTRYAD(4),DBLWD(7)
         SR    R15,R15
NTRYEX   EQU   *
         EXIT
         EJECT
*
*        MEMBER NAME VALIDITY CHECK SUBROUTINE
*
         SPACE 1
VERMEMBR ENTER VALCHECK
         L     R15,0(R6)          ADDR OF MEMBER NAME
         LH    R14,4(R6)          LENGTH OF NAME
VERMEMS  BCTR  R14,0              EXECUTE LENGTH
         SPACE 1
         OI    FLAGSAA,FMEMBER2
         TM    FLAGSAA,FMEMBER1   FIRST MEMBER PROCESSED?
         LA    R6,MEMBER2
         LA    R2,LMEMBER2
         BO    MEM2ND             YES, DO THE SECOND MEMBER NAME
         XI    FLAGSAA,FMEMBER1+FMEMBER2
         LA    R6,MEMBER1
         LA    R2,LMEMBER1
MEM2ND   MVC   0(8,R6),BLANKS     BLANK THE MEMBER NAME
         SPACE 1
         TM    FLAGSAA,FMEMBER2   SECOND MEMBER NAME?
         BO    VERSOUT            YES, BRANCH
         TM    ADDRPCL,#M         IGNORE MEMBER NAME?
         BO    VERGOOD            YES, BRANCH
         TM    ADDRPCL,#G         DEFAULT AND MEMBER GROUPS ALLOWED?
         BNO   VERSOUT            NO, BRANCH
         LA    R0,1(,R14)         ACTUAL MEMBER NAME LENGTH
         LR    R5,R15             START OF MEMBER NAME
         LTR   R14,R14            SINGLE CHARACTER NAME?
         BNZ   VERS10             NO, BRANCH
         CLI   0(R5),C'/'         MEMBER PATTERN REQUEST?
         BE    VERBAD             YES, INVALID
         CLI   0(R5),C'*'         MEMBER PLACE-HOLDER?
         BE    VERS00             YES, BRANCH
         CLI   0(R5),C':'         MEMBER RANGE REQUEST?
         BNE   VERSOUT            NO, BRANCH
         NI    FLAGSAA,FF-FMEMBER1        ENTIRE DIRECTORY DESIRED
         OI    FLAGSAA,FMEM#MEM+FMEMRANG  MEMBER RANGE GROUP DESIRED
         B     VERGOOD
         EJECT
VERS00   MVI   MEMFIRST,C'*'      MEMBER NAME STAR (*) NOTATION
         CLI   MEMBERD,X'00'      ANY MEMBER DEFAULT YET?
         BE    VERSOUT            NO, JUST USE *
         NI    FLAGSAA,FF-FOPTIONS    SET FLAGS FOR NO OPERAND
         MVC   LMEMBER1(2+8+8+2),MEMBERD+1
         NI    FLAGSAA,FF-FMEMBER1-FMEMBER2-FMEM#MEM-FMEMRANG
         OC    FLAGSAA,MEMBERD    RESET THE FLAG BITS
         B     VERGOOD
         SPACE 1
VERS10   CLI   0(R5),C':'         MEMBER RANGE DESIRED?
         BE    VERS20             YES, BRANCH
         CLI   0(R5),C'/'         MEMBER PATTERN DESIRED?
         BE    VERS22             YES, BRANCH
         LA    R5,1(,R5)          NEXT MEMBER CHARACTER
         BCT   R0,VERS10          CHECK ALL MEMBER CHARACTERS
         B     VERSOUT            NOT FOUND -- NORMAL MEMBER NAME
         SPACE 1
VERS20   OI    FLAGSAA,FMEMRANG   MEMBER RANGE DESIRED
VERS22   OI    FLAGSAA,FMEM#MEM   MEMBER GROUP DESIRED
         CR    R15,R5             FIRST CHARACTER OF NAME?
         BNE   VERS30             NO, BRANCH
         LA    R15,1(,R15)        SKIP OVER : OR +
         XC    LMEMBER2,LMEMBER2  NO MEMBER 2 YET
         TM    FLAGSAA,FMEMRANG   MEMBER RANGE DESIRED?
         BNO   VERS40             NO, BRANCH
         MVI   LMEMBER1+1,0       MACHINE LENGTH IS ZERO
         MVI   MEMBER1,X'00'      DATA IS X'00'
         B     VERMEMS            CONTINE WITH MEMBER2
         SPACE 1
VERS30   S     R0,=F'1'           ACTUAL LENGTH OF MEMBER2
         STH   R0,LMEMBER2        SAVE FOR LATER
         SR    R14,R0             ACTUAL LENGTH OF MEMBER1
         LA    R5,1(,R5)          SKIP OVER : OR +
         ST    R5,FULLWORD        SAVE FOR LATTER
         SPACE 1
VERS40   BCTR  R14,0              REDUCE MACHINE LENGTH BY ONE
         SPACE 2
VERSOUT  STH   R14,0(,R2)         STASH LENGTH
         SPACE
         LA    R5,0(R14,R15)      POINT TO LAST CHARACTER OF MEMBER
         LM    R0,R1,BLANKS       HEX MEMBER NAME PADDING
         SPACE
         CLC   =C'X''',0(R15)     BEGINS WITH X'?
         BE    VERHEX             YES, MUST BE A HEX MEMBER NAME
         SPACE
         TM    FLAGSAA,FMEMBER2   SECOND MEMBER?
         BNO   MEMLEN             NO, BRANCH
         CLC   SUBNAME,RESTOLIT   RESTORE SUBCOMMAND?
         BNE   MEMLEN             NO, BRANCH
         BCTR  R15,0              BACK UP R15
         B     VERNULL            CHECK FOR A NULL
         EJECT
MEMLEN   CLI   1(R2),7            COMPARE LENGTH > 7?
         BNH   VERCHAR            NO, BRANCH
         B     VERBAD             YES, INVALID MEMBER NAME
         SPACE 2
VERHEX   CLI   0(R5),C''''        A FINAL QUOTE?
         BNE   VERBAD             NO, INVALID HEXADECIMAL
         BCTR  R5,0               POINT TO PRECEDING CHARACTER
         LA    R15,1(,R15)        POINT TO FIRST QUOTE
         SPACE
VERNULL  CR    R5,R15             NULL HEX STRING?
         BNH   VERBAD             YES, INVALID SYNTAX
         SR    R4,R4              COUNT OF DIGITS
         L     R14,=F'-1'         BXH INCREMENT
         SPACE
VERHLOOP IC    R3,0(,R5)          NEXT CHARACTER (REVERSE SCAN)
         CLI   0(R5),C'0'
         BL    *+12               0-9?
         CLI   0(R5),C'9'
         BNH   VER0TOF            YES, BRANCH
         LA    R3,9(,R3)          NO, ADJUST LOW DIGIT 1-5 TO A-F
         CLI   0(R5),C'A'
         BL    VERBAD             A-F?
         CLI   0(R5),C'F'
         BH    VERBAD             NO, BRANCH
         SPACE
VER0TOF  SLL   R3,28              GET DIGIT IN TOP DIGIT
         SRDL  R0,4               CREATE ROOM IN R0,R1
         OR    R0,R3              ADD TO R0,R1
         LA    R4,1(,R4)          ANOTHER DIGIT
         BXH   R5,R14,VERHLOOP    DO ALL DIGITS
         SPACE
         LA    R14,1(,R4)         DIGITS+1
         SRL   R14,1              (DIGITS+1)/2    -- TRUNCATED
         BCTR  R14,0              MACHINE COMPARE LENGTH
         STH   R14,0(,R2)         MACHINE LENGTH AFTER CONVERSION
         LA    R14,2(R14,R14)     (COMPARE LENGTH+1)*2
         CR    R14,R4             EVEN NUMBER OF DIGITS?
         BE    *+8                YES, BRANCH
         SRDL  R0,4               NO, ADJUST BY ONE MORE DIGIT
         SPACE
         STM   R0,R1,DOUBLE       SAVE CREATED MEMBER NAME
         LA    R14,7              FULL LENGTH MEMBER NAME
         LA    R15,DOUBLE         START OF MOVE ADDRESS
         SPACE 2
VERCHAR  MVC   0(*-*,R6),0(R15)   <<EXECUTED>>
         EX    R14,*-6            MOVE IN MEMBER NAME
         EJECT
         TM    FLAGSAA,FMEM#MEM   MEMBER GROUP PROCESSING?
         BNO   VERGOOD            NO, BRANCH
         TM    FLAGSAA,FMEMBER2   SECOND MEMBER PROCESSED?
         BO    VERGOOD            YES, BRANCH
         LH    R14,LMEMBER2       ACTUAL LENGTH OF MEMBER2
         L     R15,FULLWORD       START OF MEMBER2
         LTR   R14,R14            ANY MEMBER2?
         BP    VERMEMS            YES, BRANCH
         SPACE 1
VERGOOD  SR    R15,R15
         TM    ADDRPCL,#G         NEW DEFAULT MEMBER NAME?
         BNO   VERMEMX            NO, BRANCH
         MVC   MEMBERD+1(2+8+8+2),LMEMBER1  SAVE CURRENT MEMBER NAMES
         MVC   MEMBERD(1),FLAGSAA           SAVE CURRENT FLAGS
         NI    MEMBERD,FF-FOPTIONS-FATTR-FATTN-FIND1
         B     VERMEMX            TERMINATE
         SPACE 2
VERBAD   LA    R15,4               INVALID MEMBER NAME -- TRY AGAIN
         TM    FLAGSAA,FMEMBER2    PROCESSING MEMBER2?
         BO    *+8                 YES, BRANCH
         NI    FLAGSAA,FF-FMEMBER1 NO, SAY NO MEMBER1 YET
         NI    FLAGSAA,FF-FMEMBER2 ALWAYS SAY NOT MEMBER2 NOW
         TM    FLAGSAA,FMEM#MEM    MEMBER GROUP REQUEST?
         BNO   VERMEMX             NO, BRANCH
         NI    FLAGSAA,FF-FMEM#MEM-FMEMBER1-FMEMBER2-FMEMRANG
VERMEMX  EXIT
         EJECT
*
*
*        NEW ATTRIBUTES VALIDITY CHECK SUBROUTINE
*
*
         SPACE 1
VERATTR  ENTER VALCHECK
         L     R15,0(R6)
         LH    R14,4(R6)
         SPACE 2
         TM    FLAGSAA,FATTR            ANY CHANGES RECORDED YET?
         BO    VERATTRI                 YES, BRANCH
         XC    ATTRYES,ATTRYES          NO, INITIALIZE ATTRYES
         XC    ATTRNO,ATTRNO                INITIALIZE ATTRNO
         NI    FLAGSCC,FF-FPAGYES-FPAGNO-FAPFON-FAPFOFF
         SPACE 2
VERATTRI LA    R3,ATTRNO
         LA    R1,ATTRYES
         SPACE
         LA    R2,2
         CR    R14,R2                   "NO" PREFIX POSSIBLE?
         BL    VERATTR1                 NO, BRANCH
         SPACE
         CLC   =C'NO',0(R15)            "NO" PREFIX?
         BNE   VERATTR1                 NO, BRANCH
         SPACE
         AR    R15,R2                   ADJUST ATTRIBUTE ADDRESS
         SR    R14,R2                   DECREMENT LENGTH
         BZ    VERATBAD                 LENGTH ERROR
         LA    R1,ATTRNO
         LA    R3,ATTRYES
         SPACE 2
VERATTR1 BCTR  R14,0                    MACHINE LENGTH
         LA    R0,LATTR                 MAXIMUM ATTRIBUTE LENGTH
         CR    R14,R0
         BNL   VERATBAD                 INVALID LENGTH
         EJECT
         SR    R0,R0                    NO FIRST ATTRIBUTE
         SPACE
         LA    R2,ATTRTBL               TABLE OF CHANGEABLE ATTRIBUTES
         SPACE
LOOPATTR CLC   0(*-*,R15),0(R2)         <<EXECUTED>>
         EX    R14,*-6                  THIS ATTRIBUTE?
         BE    VERATTR2                 YES, BRANCH
VERATTR5 LA    R2,LATTRTBL(R2)
         CLI   0(R2),X'FF'
         BNE   LOOPATTR
         LTR   R2,R0                    PREVIOUS MATCH?
         BNZ   VERATTR3                 YES, BRANCH
         B     VERATBAD                 INVALID ATTRIBUTE
         SPACE
VERATTR2 LTR   R0,R0                    FIRST MATCH?
         BNZ   VERAMBIG                 NO, AMBIGUOUS
         SPACE
         LR    R0,R2                    SAVE ADDRESS
         B     VERATTR5                 CONTINUE SCAN
         SPACE 2
VERATTR3 TM    LATTR(R2),X'40'          AUTH REQUEST?
         BZ    VERATTR4                 NO, BRANCH
         SPACE
         LA    R0,ATTRNO                TURN ON OR OFF?
         CR    R0,R1
         BE    VERATOFF
         SPACE
         OI    FLAGSCC,FAPFON           TURN APFON ON
         NI    FLAGSCC,FF-FAPFOFF       TURN OFF OTHER FLAG
         B     EXITATT0
         SPACE
VERATOFF OI    FLAGSCC,FAPFOFF          TURN APFOFF ON
         NI    FLAGSCC,FF-FAPFON        TURN OFF OTHER FLAG
         B     EXITATT0
         SPACE 2
VERATTR4 TM    LATTR(R2),X'20'          PAGE REQUEST?
         BZ    VERATTRY                 NO, BRANCH
         SPACE
         LA    R0,ATTRNO                TURN ON OR OFF?
         CR    R0,R1
         BE    VERPAGFF
         SPACE
         OI    FLAGSCC,FPAGYES          TURN PAGYES ON
         NI    FLAGSCC,FF-FPAGNO        TURN OFF OTHER FLAG
         B     EXITATT0
         SPACE
VERPAGFF OI    FLAGSCC,FPAGNO           TURN PAGNO ON
         NI    FLAGSCC,FF-FPAGYES       TURN OFF OTHER FLAG
         B     EXITATT0
         EJECT
VERATTRY TM    LATTR(R2),X'80'          REVERSE MATCH?
         BZ    VERATTR6                 NO, BRANCH
         LR    R1,R3                    ALTERNATE BIT MASK
         SPACE 1
VERATTR6 OC    0(L'ATTRYES,R1),LATTR+1(R2)  SET ATTRIBUTE STATUS FLAGS
         SPACE 2
EXITATT0 OI    FLAGSAA,FATTR            INDICATE CHANGE ATTRIBUTES
         SR    R15,R15
         B     EXITATTR
         SPACE 3
VERAMBIG MVC   MSGTEXT1,MSGDUPAT
         B     BADATTR
         SPACE 2
VERATBAD MVC   MSGTEXT1,MSGBADAT
BADATTR  L     R15,0(R6)
         LH    R14,4(R6)
         BCTR  R14,0
         LH    R1,MSGTEXT1
         LA    R0,1(R1,R14)
         STH   R0,MSGTEXT1
         LA    R1,MSGTEXT1(R1)
         MVC   0(*-*,R1),0(R15)         <<EXECUTED>>
         EX    R14,*-6
         MESSAGE MSGTEXT1
         SPACE 1
         LA    R15,8
         SPACE 3
EXITATTR EXIT
         EJECT
*
*
*        INPUT DATA SET VALIDITY CHECK EXIT
*
*
         SPACE 3
VERDSN   ENTER VALCHECK
         TM    FLAGSDD,FRECOVER         RECOVERY PROMPT?
         BO    VERDSN2                  YES, BRANCH
         MVC   SAVDSN+1(SAVLEN),DSNLEN  SAVE PREVIOUS DSNAME
         MVC   SAVDSN(1),DSPREQST       SAVE DISPOSITION FOR LATER
         SPACE 1
VERDSN2  CLEAR DSNAME
         MVC   PASSWORD,BLANKS
         SPACE 1
         L     R15,0(R6)                ADDR OF DSNAME
         LH    R14,4(R6)                LENGTH OF DSNAME
         STH   R14,DSNLEN
         BCTR  R14,0
         MVC   DSNAME(*-*),0(R15)       <<EXECUTED>>
         EX    R14,*-6                  MOVE DSNAME TO AREA
         L     R1,ADDRPSCB              ADDRESS OF THE PSCB
         SR    R14,R14
         IC    R14,PSCBUSRL-PSCB(R1)    LENGTH OF USERID
         MVC   DSNAMEH(4),DSNAME        FIRST FOUR BYTES OF DSNAME
         BCTR  R14,0                    MACHINE LENGTH
         CLC   DSNAME(*-*),PSCBUSER-PSCB(R1)  <<EXECUTED>>
         EX    R14,*-6                        START WITH USERID?
         LA    R1,2(R14,R15)                  DATA AFTER PERIOD
         BNE   *+10                           NO, BRANCH
         MVC   DSNAMEH(4),0(R1)         FIRST FOUR BYTES OF DSNAME
         SPACE 10
         TM    14(R6),X'80'             MEMBER SUPPLIED?
         BZ    NOMEMB                   NO, BRANCH
         SPACE
         L     R15,8(,R6)               POINTER TO MEMBER NAME
         LH    R14,12(,R6)              LENGTH OF MEMBER NAME
         BCTR  R14,0
         MVC   MEMBERD+3(8),BLANKS      MEMBER NAME DEFAULT AREA
         MVC   MEMBERD+3(*-*),0(R15)    <<EXECUTED>>
         EX    R14,*-6                  MOVE MEMBER TO AREA
         STCM  R14,3,MEMBERD+1          MACHINE LENGTH OF MEMBER NAME
         MVI   MEMBERD,FMEMBER1         JUST ONE MEMBER NAME DEFAULT
         SPACE 2
NOMEMB   TM    22(R6),X'80'             PASSWORD SUPPLIED?
         BZ    NOPASS                   NO, BRANCH
         SPACE
         L     R15,16(,R6)              POINTER TO PASSWORD
         LH    R14,20(,R6)              PASSWORD LENGTH
         BCTR  R14,0
         MVC   PASSWORD(*-*),0(R15)     <<EXECUTED>>
         EX    R14,*-6                  MOVE PASSWORD TO AREA
         SPACE 3
NOPASS   OI    FLAGSBB,FQUOTE           ASSUME DSNAME QUOTED
         TM    6(R6),X'40'              CORRECT?
         BO    *+8                      YES, BRANCH
         XI    FLAGSBB,FQUOTE           NO, MUST BE QUALIFIED
         SPACE 3
         SR    R15,R15
         SPACE
         EXIT
         EJECT
*
*        P A R S E   C O N T R O L   L I S T
*
         PRINT NOGEN
         SPACE 3
PCLMAIN  IKJPARM DSECT=MAINPDL
INPUTDSN IKJPOSIT DSNAME,USID,VALIDCK=VERDSN,                          $
               PROMPT='NAME OF DATA SET',                              $
               HELP=('NAME OF THE DATA SET TO BE PROCESSED')
OPTVOL   IKJKEYWD
         IKJNAME 'VOLUME',SUBFLD=$VOLUME
OPTDISP  IKJKEYWD
         IKJNAME 'OLD'
         IKJNAME 'SHR'
$VOLUME  IKJSUBF
VOLNAME  IKJIDENT 'VOLUME NAME',MAXLNTH=6,FIRST=ALPHANUM,              $
               OTHER=ALPHANUM,PROMPT='VOLUME NAME',                    $
               HELP=('NAME OF THE VOLUME WHERE THE DATA SET RESIDES')
         IKJENDP
         SPACE 3
PCLLIST  IKJPARM DSECT=PDLLIST
PCLL1    IKJIDENT 'MEMBER NAME',FIRST=ANY,OTHER=ANY,MAXLNTH=39,        $
               PROMPT='NAME OF MEMBER',                                $
               HELP=('NAME OF THE MEMBER TO BE LISTED'),               $
               VALIDCK=VERMEMBR
LISTFMT  IKJKEYWD
         IKJNAME  'NUM'        FLAGSEE=X'00'
         IKJNAME  'NONUM'      FLAGSEE=X'01'
         IKJNAME  'SNUM'       FLAGSEE=X'02'
         IKJNAME  'MULTILINE'  FLAGSEE=X'04'
         IKJNAME  'LINEDUMP'   FLAGSEE=X'08'
         IKJNAME  'BLOCK'      FLAGSEE=X'10'
         IKJNAME  'DUMP'       FLAGSEE=X'20'
LMAXLEN  IKJKEYWD
         IKJNAME  'MAXLEN',SUBFLD=LMAXLENS
LMAXIN   IKJKEYWD
         IKJNAME  'MAXIN',SUBFLD=LMAXINS
LMAXOUT  IKJKEYWD
         IKJNAME  'MAXOUT',SUBFLD=LMAXOUTS
LSKIPR   IKJKEYWD
         IKJNAME  'SKIPREC',SUBFLD=LSKIPRS
LSKIPC   IKJKEYWD
         IKJNAME  'SKIPCOL',SUBFLD=LSKIPCS
LMAXLENS IKJSUBF
LMAXLENC IKJIDENT 'MAXIMUM LENGTH',FIRST=NUMERIC,OTHER=NUMERIC,        $
               PROMPT='MAXIMUM LENGTH',MAXLNTH=5,                      $
               HELP=('MAXIMUM LENGTH OF EACH INPUT RECORD')
LMAXINS  IKJSUBF
LMAXINC  IKJIDENT 'MAXIMUM INPUT',FIRST=NUMERIC,OTHER=NUMERIC,         $
               PROMPT='MAXIMUM INPUT COUNT',MAXLNTH=5,                 $
               HELP=('MAXIMUM NUMBER OF RECORDS TO INPUT')
LMAXOUTS IKJSUBF
LMAXOUTC IKJIDENT 'MAXIMUM OUTPUT',FIRST=NUMERIC,OTHER=NUMERIC,        $
               PROMPT='MAXIMUM OUTPUT RECORDS',MAXLNTH=5,              $
               HELP=('MAXIMUM NUMBER OF RECORDS TO DISPLAY')
LSKIPRS  IKJSUBF
LSKIPRC  IKJIDENT 'SKIP COUNT',FIRST=NUMERIC,OTHER=NUMERIC,            $
               PROMPT='RECORDS TO SKIP',MAXLNTH=5,                     $
               HELP=('NUMBER OF INPUT RECORDS TO IGNORE')
LSKIPCS  IKJSUBF
LSKIPCC  IKJIDENT 'SKIP COLUMNS',FIRST=NUMERIC,OTHER=NUMERIC,          $
               PROMPT='COLUMNS TO SKIP',MAXLNTH=5,                     $
               HELP=('THE NUMBER OF BEGINNING COLUMNS TO IGNORE')
         IKJENDP
         SPACE 3
PCLFIND  IKJPARM DSECT=PDLFIND
PCLFIND1 IKJIDENT 'MEMBER NAME',MAXLNTH=39,FIRST=ANY,OTHER=ANY,        $
               PROMPT='NAME OF MEMBER',VALIDCK=VERMEMBR,               $
               HELP=('NAME OF THE MEMBER TO BE SEARCHED')
FINDDLM1 IKJPOSIT DELIMITER
FINDSTRG IKJPOSIT STRING
FINDFMT  IKJKEYWD
         IKJNAME  'NUM'        FLAGSEE=X'00'
         IKJNAME  'NONUM'      FLAGSEE=X'01'
         IKJNAME  'SNUM'       FLAGSEE=X'02'
         IKJNAME  'MULTILINE'  FLAGSEE=X'04'
         IKJNAME  'LINEDUMP'   FLAGSEE=X'08'
         IKJNAME  'BLOCK'      FLAGSEE=X'10'
         IKJNAME  'DUMP'       FLAGSEE=X'20'
FINDLIST IKJKEYWD
         IKJNAME  'FIRST'
         IKJNAME  'NOFIRST'
FMAXLEN  IKJKEYWD
         IKJNAME  'MAXLEN',SUBFLD=FMAXLENS
FMAXIN   IKJKEYWD
         IKJNAME  'MAXIN',SUBFLD=FMAXINS
FMAXOUT  IKJKEYWD
         IKJNAME  'MAXOUT',SUBFLD=FMAXOUTS
FSKIPR   IKJKEYWD
         IKJNAME  'SKIPREC',SUBFLD=FSKIPRS
FSKIPC   IKJKEYWD
         IKJNAME  'SKIPCOL',SUBFLD=FSKIPCS
FMAXLENS IKJSUBF
FMAXLENC IKJIDENT 'MAXIMUM LENGTH',FIRST=NUMERIC,OTHER=NUMERIC,        $
               PROMPT='MAXIMUM LENGTH',MAXLNTH=5,                      $
               HELP=('MAXIMUM LENGTH OF EACH INPUT RECORD')
FMAXINS  IKJSUBF
FMAXINC  IKJIDENT 'MAXIMUM INPUT',FIRST=NUMERIC,OTHER=NUMERIC,         $
               PROMPT='MAXIMUM INPUT COUNT',MAXLNTH=5,                 $
               HELP=('MAXIMUM NUMBER OF RECORDS TO INPUT')
FMAXOUTS IKJSUBF
FMAXOUTC IKJIDENT 'MAXIMUM OUTPUT',FIRST=NUMERIC,OTHER=NUMERIC,        $
               PROMPT='MAXIMUM OUTPUT RECORDS',MAXLNTH=5,              $
               HELP=('MAXIMUM NUMBER OF LINES OR PARTIAL RECORDS TO DIS$
               PLAY')
FSKIPRS  IKJSUBF
FSKIPRC  IKJIDENT 'SKIP COUNT',FIRST=NUMERIC,OTHER=NUMERIC,            $
               PROMPT='RECORDS TO SKIP',MAXLNTH=5,                     $
               HELP=('NUMBER OF INPUT RECORDS TO IGNORE')
FSKIPCS  IKJSUBF
FSKIPCC  IKJIDENT 'SKIP COLUMNS',FIRST=NUMERIC,OTHER=NUMERIC,          $
               PROMPT='COLUMNS TO SKIP',MAXLNTH=5,                     $
               HELP=('THE NUMBER OF BEGINNING COLUMNS TO IGNORE')
         IKJENDP
         SPACE 3
PCLPATTR IKJPARM DSECT=PDL2MEM
PCLPAT1  IKJIDENT 'PATTERN NAME',MAXLNTH=19,VALIDCK=VERMEMBR,          $
               HELP=('PATTERN CHARACTERS FOR A DIRECTORY SEARCH'),     $
               FIRST=ANY,OTHER=ANY,PROMPT='PATTERN NAME'
PCLPAT2  IKJIDENT 'PATTERN NAME',MAXLNTH=19,VALIDCK=VERMEMBR,          $
               FIRST=ANY,OTHER=ANY
         IKJENDP
         SPACE 3
PCLDSPLY IKJPARM DSECT=PDL1MEM
PCLD1    IKJIDENT 'MEMBER NAME',MAXLNTH=19,                            $
               FIRST=ANY,OTHER=ANY,VALIDCK=VERMEMBR
PCLD2    IKJIDENT 'MEMBER NAME',MAXLNTH=19,                            $
               FIRST=ANY,OTHER=ANY,VALIDCK=VERMEMBR
         IKJENDP
         SPACE 3
PCLENTRY IKJPARM DSECT=PDLENTRY
PCLNTRY1 IKJIDENT 'MEMBER OR ALIAS NAME',FIRST=ALPHA,OTHER=ANY,        *
               PROMPT='CURRENT MEMBER OR ALIAS NAME',                  *
               HELP='NAME OF MEMBER OR ALIAS THE ENTRY-POINT OF WHICH I*
               S TO BE CHANGED',VALIDCK=VERMEMBR,MAXLNTH=19
PCLNTRY2 IKJIDENT 'ENTRY-POINT ADDRESS',FIRST=ANY,OTHER=ANY,           *
               PROMPT='NEW ENTRY-POINT ADDRESS IN HEX',                *
               HELP='ENTRY-POINT ADDRESS TO BE ASSIGNED TO THE MEMBER O*
               R ALIAS',VALIDCK=CHKNTRY,MAXLNTH=6
         IKJENDP
         SPACE 3
PCLALIAS IKJPARM DSECT=PDLALIAS
PCLAL1   IKJIDENT 'MEMBER NAME',FIRST=ANY,OTHER=ANY,MAXLNTH=19,        $
               PROMPT='CURRENT MEMBER NAME',VALIDCK=VERMEMBR,          $
               HELP=('NAME OF THE MEMBER TO BE ASSIGNED AN ALIAS')
PCLAL2   IKJIDENT 'MEMBER NAME',FIRST=ANY,OTHER=ANY,MAXLNTH=19,        $
               PROMPT='ALIAS NAME',VALIDCK=VERMEMBR,                   $
               HELP=('NAME TO BE ASSIGNED AS AN ALIAS')
         IKJENDP
         SPACE 3
PCLRESTO IKJPARM DSECT=PDLRESTO
PCLRS1   IKJIDENT 'MEMBER NAME',FIRST=ANY,OTHER=ANY,MAXLNTH=19,        $
               PROMPT='NAME OF MEMBER TO RESTORE',VALIDCK=VERMEMBR,    $
               HELP=('NAME OF THE MEMBER TO BE RESURRECTED')
PCLRS2   IKJIDENT 'TTR ADDRESS',FIRST=ALPHANUM,OTHER=ALPHANUM,         $
               PROMPT='HEXADECIMAL TTR',MAXLNTH=6,VALIDCK=VERMEMBR,    $
               HELP=('THE START ADDRESS OF THE MEMBER TO BE RESTORED')
         IKJENDP
         SPACE 4
PCLDELET IKJPARM DSECT=PDLDELET
PCLS1    IKJIDENT 'MEMBER NAME',FIRST=ANY,OTHER=ANY,MAXLNTH=39,        $
               PROMPT='NAME OF MEMBER TO BE DELETED',VALIDCK=VERMEMBR, $
               HELP=('NAME OF THE MEMBER TO BE SCRATCHED')
         IKJENDP
         SPACE 3
PCLRENAM IKJPARM DSECT=PDLRENAM
PCLREN1  IKJIDENT 'MEMBER NAME',FIRST=ANY,OTHER=ANY,MAXLNTH=19,        $
               PROMPT='CURRENT MEMBER NAME',VALIDCK=VERMEMBR,          $
               HELP=('NAME OF THE MEMBER TO BE RENAMED')
PCLREN2  IKJIDENT 'MEMBER NAME',FIRST=ANY,OTHER=ANY,MAXLNTH=19,        $
               PROMPT='NEW MEMBER NAME',VALIDCK=VERMEMBR,              $
               HELP=('A NEW NAME FOR THE MEMBER')
         IKJENDP
         SPACE 3
PCLMAP   IKJPARM DSECT=PDLMAP
PCLM1    IKJIDENT 'MEMBER NAME',FIRST=ANY,OTHER=ANY,MAXLNTH=39,        $
               PROMPT='NAME OF MEMBER TO BE MAPPED',                   $
               HELP=('NAME OF THE MEMBER WHOSE LOAD MODULE MAP IS TO BE$
                PRODUCED'),VALIDCK=VERMEMBR
         IKJENDP
         SPACE 3
PCLDIR   IKJPARM DSECT=PDLDIR
PCLDIR1  IKJIDENT 'MEMBER NAME',FIRST=ANY,OTHER=ANY,MAXLNTH=39,        $
               PROMPT='NAME OF MEMBER',                                $
               HELP=('NAME OF THE MEMBER WHOSE DIRECTORY ENTRY IS TO BE$
                DUMPED'),VALIDCK=VERMEMBR
         IKJENDP
         SPACE 3
PCLPRINT IKJPARM DSECT=PDLPRINT
PCLPR1   IKJIDENT 'MEMBER NAME',FIRST=ANY,OTHER=ANY,MAXLNTH=39,        $
               PROMPT='NAME OF MEMBER TO PRINT',VALIDCK=VERMEMBR,      $
               HELP=('NAME OF THE MEMBER FOR THE PRINTOFF COMMAND')
PCLPR2   IKJPOSIT SPACE
PCLPRSTR IKJPOSIT STRING
         IKJENDP
         SPACE 3
PCLTSOLI IKJPARM DSECT=PDLTSOLI
PCLTL1   IKJIDENT 'MEMBER NAME',FIRST=ANY,OTHER=ANY,MAXLNTH=39,        $
               PROMPT='NAME OF MEMBER TO LIST',VALIDCK=VERMEMBR,       $
               HELP=('NAME OF THE MEMBER FOR THE TSO LIST COMMAND')
PCLTL2   IKJPOSIT SPACE
PCLTLSTR IKJPOSIT STRING
         IKJENDP
         SPACE 3
PCLSUBMI IKJPARM DSECT=PDLSUBMI
PCLSU1   IKJIDENT 'MEMBER NAME',FIRST=ANY,OTHER=ANY,MAXLNTH=39,        $
               PROMPT='NAME OF MEMBER TO SUBMIT',VALIDCK=VERMEMBR,     $
               HELP=('NAME OF THE MEMBER FOR THE SUBMIT COMMAND')
PCLSU2   IKJPOSIT SPACE
PCLSUSTR IKJPOSIT STRING
         IKJENDP
         SPACE 3
         AIF (NOT &SPFGEN).NOSPFX6
PCLBROWS IKJPARM DSECT=PDLBROWS
PCLBR1   IKJIDENT 'MEMBER NAME',FIRST=ANY,OTHER=ANY,MAXLNTH=39,        $
               PROMPT='NAME OF MEMBER TO BE BROWSED',VALIDCK=VERMEMBR, $
               HELP=('NAME OF THE MEMBER FOR THE SPF BROWSE COMMAND')
         IKJENDP
         SPACE 3
PCLSPFED IKJPARM DSECT=PDLSPFED
PCLSP1   IKJIDENT 'MEMBER NAME',FIRST=ANY,OTHER=ANY,MAXLNTH=39,        $
               PROMPT='NAME OF MEMBER TO BE EDITED',VALIDCK=VERMEMBR,  $
               HELP=('NAME OF THE MEMBER FOR THE SPF EDIT COMMAND')
         IKJENDP
         EJECT
.NOSPFX6 ANOP
         SPACE 3
PCLATTR  IKJPARM DSECT=PDLATTR
PCLAT1   IKJIDENT 'MEMBER NAME',FIRST=ANY,OTHER=ANY,MAXLNTH=39,        $
               PROMPT='NAME OF MEMBER',                                $
               HELP=('NAME OF THE MEMBER WHOSE ATTRIBUTES ARE TO BE LIS$
               TED'),VALIDCK=VERMEMBR
PCLAT2   IKJIDENT 'NEW ATTRIBUTES',LIST,FIRST=ALPHA,OTHER=ALPHA,       $
               VALIDCK=VERATTR,MAXLNTH=6,                              $
               HELP=('THE NEW ATTRIBUTES TO BE ASSIGNED TO THE LOAD MOD$
               ULE+','ATTRIBUTE: AUTH, EDIT, EXEC, LOAD, PAGE, REFR, RE$
               NT, REUS, NOAUTH, NOEDIT, NOEXEC, NOLOAD, NOPAGE, NOREFR$
               , NORENT, AMODE OR RMODE')
         IKJENDP
         SPACE 3
PCLHIST  IKJPARM DSECT=PDLHIST
PCLH1    IKJIDENT 'MEMBER NAME',FIRST=ANY,OTHER=ANY,MAXLNTH=39,        $
               PROMPT='NAME OF MEMBER',VALIDCK=VERMEMBR,HELP=('NAME OF $
               THE LOAD MODULE WHOSE HISTORY IS TO BE LISTED')
         IKJENDP
         SPACE 3
PCLMEMB  IKJPARM DSECT=PDLMEMB
PCLMEM   IKJIDENT 'MEMBER NAME',FIRST=ANY,OTHER=ANY,MAXLNTH=39,        $
               PROMPT='MEMBER GROUP',VALIDCK=VERMEMBR,HELP=('THE MEMBER$
                GROUP TO BE DISPLAYED')
         IKJENDP
         SPACE 3
PCLEDIT  IKJPARM DSECT=PDLEDIT
PCLEDIT1 IKJIDENT 'MEMBER NAME',MAXLNTH=39,FIRST=ANY,OTHER=ANY,        $
               PROMPT='NAME OF MEMBER TO EDIT',VALIDCK=VERMEMBR,       $
               HELP=('NAME OF THE MEMBER FOR THE EDIT COMMAND')
PCLNON   IKJKEYWD
         IKJNAME  'NONUM'
PCLASIS  IKJKEYWD
         IKJNAME  'ASIS'
         EJECT
**    THE FOLLOWING ORDERED TABLE MUST CORRESPOND WITH EDITTYPE BELOW
**
**     DATA SET TYPE VS. EDIT DATA TYPE RULES ARE FROM "HELP EDIT S"
**
PCLTYPE  IKJKEYWD
         IKJNAME  'DATA'
** INSERT INSTALLATION-ADDED DATA SET TYPES HERE AND IN EDITTYPE BELOW
         IKJNAME  'LIST'        ADDED LOCALLY AS A EDIT DATA SET TYPE
         IKJNAME  'VSBASIC'     NEW VS BASIC
         IKJNAME  'BASIC'
         IKJNAME  'IPLI'
         IKJNAME  'TEXT'
         IKJNAME  'COBOL'
         IKJNAME  'ASM'
         IKJNAME  'CLIST'
         IKJNAME  'CNTL'
         IKJNAME  'PLI'          $  -- DATA TYPE .PLI
* END OF VALID DATA SET TYPES
         IKJNAME  'PLIF'         $        (DEFAULT EDIT TYPE IS PLI)
         IKJNAME  'FORTE'    *
         IKJNAME  'FORTG'    *
         IKJNAME  'FORTGI'   *  -- DATA TYPE .FORT
         IKJNAME  'FORTH'    *        (DEFAULT EDIT TYPE IS GOFORT)
         IKJNAME  'GOFORT'   *
         IKJENDP
         SPACE 3
**  THE FOLLOWING ORDERED TABLE MUST CORRESPOND WITH PCLTYPE ABOVE
**
**     DATA SET TYPE VS. EDIT DATA TYPE RULES ARE FROM "HELP EDIT S"
**
EDITTYPE DC    CL7'DATA'
** INSERT INSTALLATION-ADDED EDIT DATA TYPES HERE AND IN PCLTYPE ABOVE
         DC    CL7'LIST'      ADDED LOCALLY AS A VALID DATA SET TYPE
         DC    CL7'VSBASIC'   NEW VS BASIC
         DC    CL7'BASIC'
         DC    CL7'IPLI'
         DC    CL7'TEXT'
         DC    CL7'COBOL'
         DC    CL7'ASM'
         DC    CL7'CLIST'
         DC    CL7'CNTL'
         DC    CL7'PLI'
* END OF VALID DATA SET TYPES
PLIF     DC    CL7'PLIF'
         DC    CL7'FORTE'    *
         DC    CL7'FORTG'    *
         DC    CL7'FORTGI'   *  -- DATA TYPE .FORT
         DC    CL7'FORTH'    *        (DEFAULT EDIT TYPE IS GOFORT)
GOFORT   DC    CL7'GOFORT'   *
         EJECT
FF       EQU   X'FF'          IMMEDIATE FLAG MASK (FOR NI INSTRUCTIONS)
         SPACE 2
DEBNMEXT EQU   16             OFFSET IN DEB FOR NUMBER OF EXTENTS
DEBUCBAD EQU   32             OFFSET IN DEB FOR UCB ADDRESS
UCBTYP   EQU   16             OFFSET IN UCB FOR UNIT TYPE WORD
UCBVOLI  EQU   28             OFFSET IN UCB FOR DISK VOLUME NAME
         SPACE 3
EXCPDCB  DCB   DEVD=DA,DDNAME=X,MACRF=E,EXLST=EXLST
LEXCPDCB EQU   *-EXCPDCB
SAMDCB   DCB   DSORG=PO,DEVD=DA,DDNAME=X,MACRF=(R,W),EXLST=EXLST
LSAMDCB  EQU   *-SAMDCB
EXLST    DC    X'85',AL3(OPENEXIT)
         PRINT GEN
         SPACE 2
OBTAIN   CAMLST SEARCH,0,0,0
         ORG   OBTAIN+4
         SPACE 2
BLDLPARM DC    AL2(1,74)
DUMPDIR  DC    C'DUMP DIRECTORY ENTRY'
RECFMTYP DC    C'*FV?U'                   RECFM=. TEXT
DSORGTYP DC    C'**DAPS??IS'              DSORG=.. TEXT
         SPACE 2
DAYMONTH DC    AL1(31,28,31,30,31,30,31,31,30,31,30,31)
TRTABLE  EQU   *-X'F0'
         DC    C'0123456789ABCDEF'
         SPACE 2
SPFUSER  DC    CL8'SPFUSER'               FOR SPF OPTION 6 ENQ TEST
         AIF (NOT &SPFGEN).NOSPFX7
ISPF     DC    C'ISPF    PGM(1234567)  PARM(1234)'
ISPFPGM  EQU   12,8                       DISPLACEMENT TO PROGRAM NAME
ISPFPARM EQU   27,4                       DISPLACEMENT TO PARM PASSED
ISPLINK  DC    CL8'ISPLINK'               SPF LINK MODULE NAME
.NOSPFX7 ANOP
         EJECT
WORKSIZE DC    0F'0',AL1(1),AL3(LENWORK)  SUBPOOL, DYNAMIC STORAGE SIZE
BLANKS   DC    0F'0',8X'40'
         SPACE 5
*
*        NOTE - THESE CCWS ARE USED FOR ALL READS
*
         SPACE
CCWINIT  CCW   X'31',IOBSEEK-IOBSEEK+3,X'60',5  SEARCH ID EQUAL (CCHHR)
         CCW   X'08',*-8-(*-8),X'60',1          TIC
         CCW   X'92',IOBSEEK-IOBSEEK+3,X'20',8  MT READ NEXT COUNT
*
         CCW   X'23',SNO-SNO,X'60',1            SET SECTOR
         CCW   X'31',IOBSEEK-IOBSEEK+3,X'60',5  SEARCH ID EQUAL (CCHHR)
         CCW   X'08',*-8-(*-8),X'60',1          TIC
         CCW   X'06',*-*,X'60',32760            READ DATA
         CCW   X'92',IOBSEEK-IOBSEEK+3,X'60',8  MT READ NEXT COUNT
         CCW   X'22',SNO-SNO,X'20',1            READ SECTOR NUMBER
         SPACE 3
ENQMFL   ENQ   (*-*,*-*,E,7,STEP),RET=TEST,MF=L  LIST FORM OF ENQ
         ORG   ENQMFL+4
         SPACE 3
INITMAX  DC    F'99999'         INITIALIZE MAXLEN
         DC    F'99999'         INITIALIZE MAXIN
         DC    F'99999'         INITIALIZE MAXOUT
ZERO     DC    F'0'             INITIALIZE SKIPREC
         DC    F'0'             INITIALIZE SKIPCOL
         DC    H'0'             INITIALIZE COMMDLTH
         EJECT
***BITS FOR DIRATTR+0:
ATTRRENT EQU   X'80'          REENTRANT
ATTRREUS EQU   X'40'          REUSABLE
ATTROVLY EQU   X'20'          OVERLAY STRUCTURE
ATTRTEST EQU   X'10'          TEST SYMBOLS ARE AVAILABLE
ATTRLOAD EQU   X'08'          ONLY LOADABLE
ATTRSCAT EQU   X'04'          SCATTER LOADED
ATTREXEC EQU   X'02'          EXECUTABLE
ATTR1TXT EQU   X'01'          ONE TEXT RECORD ONLY AND NO RLD ITEMS
         SPACE
***BITS FOR DIRATTR+1:
ATTRNODC EQU   X'80'          NOT DOWNWARD-COMPATABLE
ATTRZORG EQU   X'40'          FIRST TEXT BLOCK HAS A ZERO ORIGIN
ATTREP0  EQU   X'20'          ENTRY POINT IS AT OFFSET ZERO
ATTRNRLD EQU   X'10'          NO RLD ITEMS
ATTRNE   EQU   X'08'          CANNOT BE REPROCESSED BY LINKAGE-EDITOR
ATTRSYMS EQU   X'04'          CONTAINS TEST SYMBOLS
ATTRFLEV EQU   X'02'          CREATED BY F LEVEL LINKAGE-EDITOR
ATTRREFR EQU   X'01'          REFRESHABLE
         SPACE 3
TBLATTR  DS    0H
         DC    AL1(ATTRRENT,0,00003),CL9'RENT'
         DC    AL1(ATTRREUS,0,00003),CL9'REUS'
         DC    AL1(0,ATTRREFR,00003),CL9'REFR'
         DC    AL1(ATTROVLY,0,00006),CL9'OVERLAY'
         DC    AL1(ATTRTEST,0,00003),CL9'TEST'
         DC    AL1(ATTRLOAD,0,00008),CL9'LOAD ONLY'
         DC    AL1(ATTRSCAT,0,00003),CL9'SCTR'
         DC    AL1(0,ATTRNE+0,00007),CL9'NOT EDIT'
         DC    AL1(ATTREXEC,0,128+7),CL9'NOT EXEC'
         DC    AL1(0,ATTRFLEV,128+6),CL9'E-LEVEL'
         DC    AL1(0,ATTRNODC,128+1),CL9'DC'
         DC    X'FF'
         SPACE 3
ATTRTBL  DS    0X
         DC    CL4'RENT',X'00',AL1(ATTRRENT,0)  ***
LATTRTBL EQU   *-ATTRTBL                         ***  ATTRIBUTES
LATTR    EQU   4                                  ***  WHICH
         DC    CL4'REUS',X'00',AL1(ATTRREUS,0)     ***  CAN
         DC    CL4'REFR',X'00',AL1(0,ATTRREFR)      ***  BE
         DC    CL4'EXEC',X'00',AL1(ATTREXEC,0)       ***  CHANGED
         DC    CL4'LOAD',X'00',AL1(ATTRLOAD,0)        ***  BY
         DC    CL4'EDIT',X'80',AL1(0,ATTRNE+0)         ***  PDS
         DC    CL4'AUTH',X'40',AL1(0,0)                 ***
         DC    CL4'PAGE',X'20',AL1(0,0)                  ***
         DC    X'FF'
         EJECT
         PRINT NOGEN
MSGAVAIL MSG   'THE FOLLOWING OPTIONS ARE AVAILABLE:'
OPTNTBL  MSG   'ATTRIB   - LIST ATTRIBUTES OF A MEMBER'
         MSG   'ALIAS    - ASSIGN AN ALIAS TO A MEMBER'
         AIF (NOT &SPFGEN).NOSPFX8
         MSG   'BROWSE   - BROWSE A MEMBER WITH SPF'
.NOSPFX8 ANOP
         MSG   'CHANGE   - SELECT A NEW DATA SET',S
         MSG   'DISPLAY  - DISPLAY DIRECTORY NAMES'
         MSG   'DIRENTRY - DUMP A DIRECTORY ENTRY'
         MSG   'DELETE   - DELETE A MEMBER'
         MSG   'EDIT     - EDIT A MEMBER'
         MSG   'END      - STOP THE PROGRAM',S
         MSG   'ENTRY    - ASSIGN A NEW ENTRY-POINT TO A LOADMODULE'
         MSG   'EXEC     - EXECUTE PDS SUBCOMMANDS FROM A CLIST',S
         MSG   'FIND     - LIST LINES CONTAINING A STRING',S
         MSG   'HELP     - DISPLAY PDS SUBCOMMAND HELP',S
         MSG   'HISTORY  - LIST HISTORY OF A LOAD MODULE'
         MSG   'LIST     - DISPLAY A MEMBER',S
         MSG   'MAP      - MAP A LOAD MODULE'
         MSG   'MEMBERS  - DISPLAY A MEMBER GROUP'
         MSG   'OPTIONS  - DISPLAY THIS MENU',S
         MSG   'PATTERN  - DISPLAY DIRECTORY NAMES MATCHING A PATTERN'
         MSG   'PRINTOFF - PRINT A HARDCOPY OF A MEMBER'
         MSG   'RENAME   - RENAME A MEMBER'
         MSG   'RESTORE  - RESURRECT A PREVIOUSLY DELETED MEMBER'
         MSG   'SMAP     - MAP A LOAD MODULE IN SHORT FORM'
         AIF (NOT &SPFGEN).NOSPFX9
         MSG   'SPFEDIT  - EDIT A MEMBER WITH SPF'
.NOSPFX9 ANOP
         MSG   'SUBMIT   - SUBMIT A JCL MEMBER'
         MSG   'TSOLIST  - LIST A MEMBER WITH TSO LIST'
         MSG   'USAGE    - LIST DATA SET STATISTICS',S
         DC    X'FF'
         SPACE 2
MSGUNKN  MSG   'INVALID OPTION, ENTER "HELP" OR "OPTIONS" FOR HELP'
         AIF (NOT &SPFGEN).NOSPFXA
MSGCMDSL MSG   'SUBCOMMANDS: ATTRIB, ALIAS, BROWSE, CHANGE, DISPLAY,'
     MSG  '  DIRENTRY, DELETE, END, ENTRY, EXEC, FIND, HELP, HISTORY,'
     MSG  '  LIST, MAP, MEMBERS, OPTIONS, PATTERN, PRINTOFF, RENAME,'
     MSG  '  RESTORE, SMAP, SPFEDIT, SUBMIT, TSOLIST AND USAGE'
         AGO   .YESSPF1
.NOSPFXA ANOP
MSGCMDSL MSG   'SUBCOMMANDS: ATTRIB, ALIAS, CHANGE, DISPLAY, DIRENTRY,'
         MSG   '  DELETE, EDIT, END, ENTRY, EXEC, FIND, HELP, HISTORY,'
         MSG   '  LIST, MAP, MEMBERS, OPTIONS, PATTERN, PRINTOFF,'
         MSG   '  RENAME, RESTORE, SMAP, SUBMIT, TSOLIST AND USAGE'
.YESSPF1 ANOP
         DC    X'FF'
         SPACE 2
MSGCMDSS MSG   'SUBCOMMANDS: CHANGE, END, EXEC, FIND, HELP, LIST,',S
         MSG   '   OPTIONS AND USAGE',S
         DC    X'FF'
         EJECT
#@       EQU   X'80'    ATTENTIONS HONORED FOR THIS SUBCOMMAND
#S       EQU   X'40'    SPFEDIT OR BROWSE ALLOW COLON NOTATION
#N       EQU   X'20'    OPERAND IS IGNORED IF PRESENT
#R       EQU   X'10'    OPERAND REQUIRED, PARSE IS ALWAYS CALLED
#M       EQU   X'08'    MEMBER OPERAND IS IGNORED IN PARSE
#G       EQU   X'04'    MEMBER GROUP AND MEMBER DEFAULT ALLOWED
#B       EQU   X'02'    BLDL REQUIRED TO VERIFY FIRST MEMBER EXISTS
#C       EQU   X'01'    SUBCOMMAND INVALIDATES BLDL, NO BLDL REQUIRED
         SPACE 2
 DS 0F **** SUBCOMMAND , PFK ,   PROCESSOR ,      FLAGS  ,  PCL ADDRESS
*********** ----------   ---     ---------      --------    -----------
CMDTABLE DC C'ATTRIB  ',X'07',AL3(0+ATTRIB),AL1(#@+#G+#B),AL3(+PCLATTR)
ALIASLIT DC C'ALIAS   ',X'00',AL3(00+ALIAS),AL1(#@+#R+#B),AL3(PCLALIAS)
         AIF (NOT &SPFGEN).NOSPFXB
BROWSLIT DC C'BROWSE  ',X'0B',AL3(0+BROWSE),AL1(#S+#G+#B),AL3(PCLBROWS)
.NOSPFXB ANOP   '
         DC C'DISPLAY ',X'00',AL3(+DISPLAY),AL1(#@+00+00),AL3(PCLDSPLY)
         DC C'DIRENTRY',X'00',AL3(DIRENTRY),AL1(#@+#G+#B),AL3(0+PCLDIR)
         DC C'DELETE  ',X'00',AL3(0+DELETE),AL1(#@+#G+#C),AL3(PCLDELET)
EDITLIT  DC C'EDIT    ',X'00',AL3(000+EDIT),AL1(00+#G+#C),AL3(+PCLEDIT)
FINDLIT  DC C'FIND    ',X'05',AL3(000+FIND),AL1(#@+#G+#B),AL3(+PCLFIND)
HELPLIT  DC C'HELP    ',X'01',AL3(000+HELP),AL1(00+#N+00),AL3(00000000)
         DC C'HISTORY ',X'00',AL3(+HISTORY),AL1(#@+#G+#B),AL3(+PCLHIST)
LISTLIT  DC C'LIST    ',X'02',AL3(000+LIST),AL1(#@+#G+#B),AL3(+PCLLIST)
         DC C'MAP     ',X'08',AL3(0000+MAP),AL1(#@+#G+#B),AL3(0+PCLMAP)
       DC C'ENTRY   ',X'05',AL3(0+ENTRY),AL1(#@+#G+#B),AL3(0+PCLENTRY)
MEMBLIT  DC C'MEMBERS ',X'0A',AL3(0+NEWCMD),AL1(#@+#G+#B),AL3(+PCLMEMB)
         DC C'PATTERN ',X'00',AL3(+PATTERN),AL1(#@+#R+00),AL3(PCLPATTR)
PRINTLIT DC C'PRINTOFF',X'04',AL3(PRINTOFF),AL1(00+#G+#B),AL3(PCLPRINT)
         DC C'RENAME  ',X'00',AL3(0+RENAME),AL1(#@+#R+00),AL3(PCLRENAM)
RESTOLIT DC C'RESTORE ',X'00',AL3(+RESTORE),AL1(#@+#R+00),AL3(PCLRESTO)
         DC C'SMAP    ',X'00',AL3(000+SMAP),AL1(#@+#G+#B),AL3(0+PCLMAP)
         DC C'SCRATCH ',X'00',AL3(0+DELETE),AL1(#@+#G+#C),AL3(PCLDELET)
         AIF (NOT &SPFGEN).NOSPFXC
         DC C'SPFEDIT ',X'0C',AL3(+SPFEDIT),AL1(#S+#G+#C),AL3(PCLSPFED)
.NOSPFXC ANOP
SUBLIT   DC C'SUBMIT  ',X'00',AL3(0+SUBMIT),AL1(00+#G+#B),AL3(PCLSUBMI)
TSOLILIT DC C'TSOLIST ',X'00',AL3(+TSOLIST),AL1(00+#G+#B),AL3(PCLTSOLI)
         SPACE 1
*  THE FOLLOWING ARE FOR NON-PARTITIONED DATA SETS:
MAINPCL  DC C'CHANGE  ',X'06',AL3(0+CHANGE),AL1(#@+00+#C),AL3(+PCLMAIN)
ENDLIT   DC C'END     ',X'03',AL3(00+EXIT0),AL1(#@+#N+00),AL3(00000000)
EXECLIT  DC C'EXEC    ',X'00',AL3(000+EXEC),AL1(00+#N+00),AL3(00000000)
         DC C'FIND    ',X'05',AL3(000+FIND),AL1(#@+#M+00),AL3(+PCLFIND)
         DC C'HELP    ',X'01',AL3(000+HELP),AL1(00+#N+00),AL3(00000000)
         DC C'LIST    ',X'02',AL3(000+LIST),AL1(#@+#M+00),AL3(+PCLLIST)
         DC C'OPTIONS ',X'00',AL3(+OPTIONS),AL1(#@+#N+00),AL3(00000000)
         DC C'PDSNEW  ',X'00',AL3(0+CHANGE),AL1(#@+00+#C),AL3(+PCLMAIN)
         DC C'USAGE   ',X'09',AL3(00+USAGE),AL1(#@+#N+00),AL3(00000000)
         DC C'ABEND   ',X'00',AL3(00+ABEND),AL1(00+#N+00),AL3(00000000)
         DC C'DSNAMES ',X'00',AL3(00+USAGE),AL1(#@+#N+00),AL3(00000000)
         DC C'KLEAR   ',X'00',AL3(00+KLEAR),AL1(#@+#N+00),AL3(00000000)
         DC C'W (TEST)',X'00',AL3(0+NEWCMD),AL1(#@+#N+00),AL3(00000000)
         DC C'X -NOPCF',X'00',AL3(000000+X),AL1(00+#N+#C),AL3(00000000)
         DC X'FF'
         EJECT
*
*        PROGRAM MESSAGES
*
         PRINT NOGEN
MSGDSNDD MSG   '//12345678  DD  DSN='''
MSGDCB   MSG   '//  DCB=(RECFM=,LRECL=,BLKSIZE=,DSORG=**'
LRECLTXT EQU   MSGDCB+19,7
BLKSITXT EQU   MSGDCB+19+7,9
DSORGTXT EQU   MSGDCB+19+7+9,9
MSGUSEB  MSG   ' DIRECTORY BLOCKS ALLOCATED'
MSGUSED  MSG   ' DIRECTORY BLOCKS IN USE'
MSGTRKS  MSG   ' TRACKS USED FOR DIRECTORY BLOCKS'
MSGMAXM  MSG   ' MAXIMUM ENTRIES IN A DIRECTORY BLOCK'
MSGUSER  MSG   ' MEMBERS EXIST'
MSGUSEA  MSG   ' OF THEM ARE ALIASES'
         SPACE 3
         DS    0X
MSGUSESI MSG   ' TRACKS ALLOCATED'
MSGUSEMP MSG   ' TRACKS UNUSED'
MSGUSEXT MSG   ' EXTENTS USED'
MSGNDSCB MSG   'OBTAIN ERROR'
MSGPERMI MSG   'PERMANENT I/O ERROR'
MSGIODIR MSG   'I/O ERROR IN DIRECTORY'
MSGNOTXT MSG   'NO TEXT FOUND FOR MEMBER'
MSGSCAT  MSG   'SCATTER LOADED -- A LINKAGE-EDIT IS RECOMMENDED'
         SPACE 3
         DS    0X
MSGNLIB  MSG   'NOTE: THIS DATA SET IS NOT PARTITIONED'
MSGNLOAD MSG   'DATA SET IS NOT A LOAD LIBRARY'
MSGNOPEN MSG   'UNABLE TO OPEN DATA SET'
MSGEOF   MSG   'END OF FILE'
MSGNODIR MSG   'DIRECTORY IS FULL'
MSGBLANK MSG   '  '
MSGBNONE MSG   'NONE'
MSGEMPTY MSG   'NO MEMBERS EXIST'
         SPACE 3
         DS    0X
MSGRANGE MSG   'INVALID NAME RANGE'
MSGNODSP MSG   'NO MEMBER NAMES ARE IN THIS RANGE'
MSGNOPAT MSG   'NO MEMBER NAMES MATCH THIS PATTERN'
MSGEXIST MSG   'MEMBER ALREADY EXISTS'
MSGNONE  MSG   'MEMBER NOT FOUND'
MSGGONE  MSG   'MEMBER DELETED'
MSGRENAM MSG   'MEMBER RENAMED'
MSGRESTO MSG   'MEMBER RESTORED'
         EJECT
         DS    0X
MSGCHRBD MSG   'SEARCH STRING IS TOO LONG'
MSGHEXBD MSG   'INVALID HEXADECIMAL STRING'
MSGNOMOD MSG   'MEMBER IS AN ALIAS BUT NO REAL MEMBER EXISTS'
MSGYAUTH MSG   'APF AUTHORIZED'
MSGNOVSL MSG   'NOT APF AUTHORIZED, NOT OS/VS LINKED'
MSGNOAPF MSG   'NOT APF AUTHORIZED, APF DATA MISSING'
MSGAPFLB MSG   'NOT APF AUTHORIZED, APF DATA WRONG LENGTH'
MSGAPF2B MSG   'APF AUTHORIZED, APF DATA VALUE > 1'
MSGMODE  MSG   'AMODE=24    RMODE=24    '
         SPACE 3
         DS    0X
MSGADNC  MSG   'APF DATA COULD NOT BE CHANGED'
MSGNOPAG MSG   'PAGE ALIGNMENT COULD NOT BE CHANGED'
MSGPAGA  MSG   'PAGE ALIGNMENT IS REQUIRED'
MSGAABAD MSG   'BAD APF INFORMATION FORMAT, ZERO USED'
MSGNOESD MSG   'MODULE HAS NO EXTERNAL SYMBOLS'
MSGALIAS MSG   'ALIAS ASSIGNED'
MSGNTRY  MSG   ' ENTRY-POINT ASSIGNED'
MSGNHIST MSG   'NO HISTORY AVAILABLE'
MSGFINDN MSG   'THE FIRST FIND SUBCOMMAND MUST CONTAIN A STRING'
         SPACE 3
         DS    0X
MSGRESTR MSG   ' REENTER FIND STRING WITH DELIMITERS:'
MSGENTER MSG   ' ENTER OPTION'
MSGRETRY MSG   ' RE-ENTER DATA SET NAME, VOLUME AND DISPOSITION:'
MSGYESNO MSG   ' ENTER Y (FOR YES) OR N (FOR NO):'
MSGSPFHD MSG   ' SPF STATS:    VER.MOD  CREATED   LAST MODIFIED  SIZE  X
               INIT   MOD   ID     '
MSGOPT6  MSG   'NOT ALLOWED UNDER SPF'
MSGHISTZ MSG   'IMASPZAP UPDATE HISTORY BY CSECT -'
MSGHISTU MSG   'USER-SUPPLIED UPDATE HISTORY BY CSECT -'
         SPACE 3
         DS    0X
MSGTOBIG MSG   'TTR IS BEYOND THE USED PORTION OF THE DATA SET'
MSGINVLD MSG   'INVALID SUBCOMMAND'
MSGREALL MSG   'DATA SET WILL BE REALLOCATED AS OLD'
MSGBADAT MSG   'INVALID ATTRIBUTE: '
MSGDUPAT MSG   'AMBIGUOUS ATTRIBUTE: '
MSGATTRS MSG   'ATTRIBUTES ARE:'
MSGOTHER MSG   'ALIASES FOR THIS MEMBER ARE: '
MSGDSN   MSG   'DATA SET '''
MSGTSOXX MSG   'TSO COMMAND NOT FOUND'
         EJECT
MSGDUMP  MSG   'BLOCK  RECORD 12,345    LENGTH 12,345    TTR 123456'
MSGDUMPB EQU   MSGDUMP+4,5         "DUMP "
         ORG   MSGDUMP+17
MSGDUMPR DC    X'4020206B202120'   EDIT PATTERN
         ORG   MSGDUMP+34
MSGDUMPL DC    X'4020206B202120'   EDIT PATTERN
MSGDUMPT EQU   MSGDUMP+49,6        TTR OUTPUT
         ORG   ,
         SPACE 3
MSGBLK   MSG   ' -- 12,345 BLOCKS IN THIS MEMBER  '
         ORG   MSGBLK+7
MSGBLKC  DC    X'4020206B202120'   EDIT PATTERN
MSGBLKL  EQU   MSGBLK+15,6         " LINES"
MSGDATAS EQU   MSGBLK+30,7         "DATA SET"
         ORG   ,
MSGNORES MSG   'A MEMBER ALREADY EXISTS AT THIS TTR: 12345678'
MSGNORE1 EQU   MSGNORES+41,8
         SPACE 3
MSGREAL  MSG   'MEMBER IS AN ALIAS FOR 12345678'
MSGREAL1 EQU   MSGREAL+27,8
MSGXREAL MSG   'THE ALIAS DIRECTORY ENTRY NOTES THE REAL ENTRY NAME AS X
               12345678'
MSGXREA1 EQU   MSGXREAL+59,8
MSGDAIRX MSG   'ERROR IN DAIRFAIL SERVICE ROUTINE;  R15=123'
         ORG   MSGDAIRX+43
MSGDAIR1 DC    X'40202120'
         SPACE 3
MSGGENF  MSG   'ERROR IN GENERAL FAIL SERVICE ROUTINE;  R15=123'
         ORG   MSGGENF+47
MSGGENF1 DC    X'40202120'
MSGENTRY MSG   'ENTRY POINT AT 123456' -- ENTRYPOINTNAME
MSGENTR1 EQU   MSGENTRY+19,6
MSGLEN   MSG   'MODULE LENGTH  123456  -- 12345K'
MSGLEN1  EQU   MSGLEN+19,6
         ORG   MSGLEN+29
MSGLEN2  DC    X'402020202120D2'
         SPACE 3
MSGHISTD MSG   'LAST LINK-EDITED ON 12/34/56'
         ORG   MSGHISTD+23
DATEMASK DC    X'402120612020612020'
MSGDEFM  MSG   'DEFAULT MEMBER - 12345678'
MSGDEFM1 EQU   MSGDEFM+21,8
MSGSSI   MSG   'SSI INFORMATION: 12345678'
MSGSSI1  EQU   MSGSSI+21,8
         EJECT
         PRINT GEN
         LTORG
         EJECT
***  TRANSLATE AND TEST TABLE TO FIND INVALID MEMBER NAMES
TRTMEM   DC    256X'FF'           ASSUME ALL INVALID FIRST
         ORG   TRTMEM+C'#'
         DC    1X'00'             # IS OK
         ORG   TRTMEM+C'$'
         DC    1X'00'             $ IS OK
         ORG   TRTMEM+C'@'
         DC    1X'00'             @ IS OK
         ORG   TRTMEM+C'A'
         DC    9X'00'             ABCDEFGHI  ARE OK
         ORG   TRTMEM+C'J'
         DC    9X'00'             JKLMNOPQR  ARE OK
         ORG   TRTMEM+C'S'
         DC    8X'00'             STUVWXYZ  ARE OK
         ORG   TRTMEM+C'0'
         DC    10X'00'            0123456789  ARE OK
         ORG   ,
         SPACE 3
***  TRANSLATE TABLE TO CONVERT UNPRINTABLES TO PERIODS
TRLINE   DC    256C'.'            ASSUME ALL UNPRINTABLE FIRST
         ORG   TRLINE+C' '
         DC    1X'40'             BLANK IS OK
         ORG   TRLINE+C'Ö'
         DC    C'Ö.<(+×&&'        Ö.<(+×&  ARE OK
         ORG   TRLINE+C'!'
         DC    C'!$*);^-/'        !$*);^-/  ARE OK
         ORG   TRLINE+C','
         DC    C',%_>?'           ,%_>?  ARE OK
         ORG   TRLINE+C':'
         DC    C':#@''="'         :#@'="  ARE OK
         ORG   TRLINE+X'81'       LOWER-CASE ABCDEFGHI
         DC    X'818283848586878889'
         ORG   TRLINE+X'91'       LOWER-CASE JKLMONPQR
         DC    X'919293949596979899'
         ORG   TRLINE+X'A2'       LOWER-CASE STUVWXYZ
         DC    X'A2A3A4A5A6A7A8A9'
         ORG   TRLINE+C'A'
         DC    C'ABCDEFGHI'       ABCDEFGHI  ARE OK
         ORG   TRLINE+C'J'
         DC    C'JKLMNOPQR'       JKLMNOPQR  ARE OK
         ORG   TRLINE+C'S'
         DC    C'STUVWXYZ'        STUVWXYZ  ARE OK
         ORG   TRLINE+C'0'
         DC    C'0123456789'      0123456789  ARE OK
         ORG   ,
         EJECT
***
***      WORK AREA
***
         SPACE 3
WORKAREA DSECT
MAINSAVE DS    18A
         SPACE 2
VALSAVE  DS    18A
ATTNSAVE DS    18A
*TAEREGS DS    16A            STAE REGISTER SAVE AREA   ***.NOSTAE
SPFMAIN  DS    18A            SECONDARY SAVE AREA FOR SPF
         SPACE
R14SAVE  DS    A              FIRST LEVEL SAVE AREA
R14PARSE DS    A              SECOND LEVEL SAVE AREA
R14PUTM  DS    A              THIRD LEVEL SAVE AREA
R14PUTL  DS    A              THIRD LEVEL SAVE AREA
R14PTGT  DS    A              THIRD LEVEL SAVE AREA
R14EXCP  DS    A              THIRD LEVEL SAVE AREA
         SPACE
BASES    DS    5A             PROGRAM BASE ADDRESSES
         SPACE
***
***      NOTE: KEEP THE FOLLOWING STATEMENTS TOGETHER AND IN THE
***            SAME PHYSICAL ORDER (FOR STM INSTRUCTIONS).
***
ADDRTEXT DS    A        * *    ADDRESS OF TEXT PASSED
ADDRUPT  DS    A        * *    ADDRESS OF THE UPT
ADDRPSCB DS    A        * *    ADDRESS OF THE PSCB
ADDRECT  DS    A        * *    ADDRESS OF THE ECT
ADDRCBUF DS    A        * *    ADDRESS OF THE COMMAND BUFFER
ADDRCPPL DS    A        * *    ADDRESS OF THE CPPL
ADDRPCL  DS    A        * *    ADDRESS OF PCL FOR PARSE
ADDRPUTL DS    A        * *    ADDRESS OF IKJPUTL
ADDRPARS DS    A        * *    ADDRESS OF IKJPARS
ADDRPTGT DS    A        * *    ADDRESS OF IKJPTGT
ADDRSCAN DS    A        * *    ADDRESS OF IKJSCAN
ADDRDAIR DS    A        * *    ADDRESS OF IKJDAIR
ADDRSTCK DS    A        * *    ADDRESS OF IKJSTCK
ADDRDEFT DS    A        * *    ADDRESS OF IKJEHDEF
ADDRFF02 DS    A        * *    ADDRESS OF IKJEFF02
ADDRCNVT DS    A        * *    TTR --> MBBCCHHR CONVERT ROUTINE
***
         SPACE 2
ADDRANSR DS    A
ADDRCMD  DS    A
OPENLIST DS    2A
         EJECT
PARMLIST DS    8A             GENERAL PARAMETER LIST
PUTLPARM DS    4A             $PUTLINE PARAMETER AREA
PTGTPARM DS    4A             $PUTGET PARAMETER AREA
SCANANSR DS    XL8
BLKCOUNT DS    F              LIST RECORD/BLOCK COUNTER
ATTNECB  DS    F
DAIRRC   DS    F              DAIR RETURN CODE FROM REGISTER 15
RETURNCD DS    F  CBT-AXC     PROGRAM RETURN CODE
         SPACE
ESDPTR   DS    A              ADDRESS OF ESD DATA CHAIN
IDRPTR   DS    A
BUFFADDR DS    A
BUFFSIZE DS    H
DSORG    DS    H
LRECL    DS    H
BLKSI    DS    H
ATTRYES  DS    XL2
ATTRNO   DS    XL2
         SPACE 2
TOTBLOCK DS    H        **  --   THIS AREA IS CLEARED
TOTUSED  DS    H        **  --     VIA AN XC INSTRUCTION
TOTMEMR  DS    H        **  --     (LENGTH IS LTOT).
TOTMEMA  DS    H        **  --
TOTMAXM  DS    H        **  --
TOTTHISM DS    H        **  --
TOTTRKS  DS    H        **  --
TOTCCHH  DS    XL4      **  --
LTOT     EQU   *-TOTBLOCK        LENGTH OF XC AREA
DSNTOTAL DS    H
DSNEMPTY DS    H
NUMEXT   DS    H              NUMBER OF EXTENTS
         SPACE
LMEMBER1 DS    H              LENGTH OF MEMBER NAME ONE
MEMBERRN DS    0CL16          FOR RENAME
MEMBER1  DS    CL8            FIRST MEMBER NAME
MEMBER2  DS    CL8            SECOND MEMBER NAME
LMEMBER2 DS    H              LENGTH OF MEMBER NAME TWO
         SPACE
MEMBERD  DS    XL1,XL2,CL8,CL8,XL2
***      SAVE  FLAGSAA,LMEMBER1,MEMBER1,MEMBER2,LMEMBER2
         SPACE
ENTRYPT  DS    CL8            ENTRY POINT NAME FOR MAP AND SMAP
LKEDDATE DS    XL3
ENTRYAD  DS    CL3
         DS    CL1
DBLWD    DS    D
         SPACE 2
DSPALLOC DS    X              CURRENT DISPOSITION (SHARE OR OLD)
DSPREQST DS    X              INITIAL DISPOSITION (SHARE OR OLD)
OLDSNO   DS    X              SECTOR NUMBER OF THIS BLOCK
SAVRECFM DS    X              DCBRECFM FOR THIS DATA SET
         SPACE
DOUBLE   DS    D
FULLWORD DS    F
PAGESIZE DS    F              LINES/SCREEN
LINESIZE DS    F              CHARACTERS/LINE
         EJECT
FLAGSAA  DS    XL1   FLAG BYTE 1
FOPTIONS EQU   X'80'          OPTIONS PRESENT WITH COMMAND
FATTR    EQU   X'40'          CHANGE ATTRIBUTES REQUEST
FATTN    EQU   X'20'          **AVAILABLE FOR USE
FIND1    EQU   X'10'          CONVERT FIND-->LIST AFTER FIRST MATCH
FMEMBER1 EQU   X'08'          FIRST MEMBER FLAG
FMEMBER2 EQU   X'04'          SECOND MEMBER FLAG
FMEMRANG EQU   X'02'          MEMBER RANGE DESIRED
FMEM#MEM EQU   X'01'          MEMBER GROUP IS IN PROGRESS
         SPACE
FLAGSBB  DS    XL1   FLAG BYTE 2
FLINESET EQU   X'40'          OUTPUT LINE IN PROGRESS
FEXIST   EQU   X'20'          MEMBERS EXIST IN DATA SET
FRANPAT  EQU   X'10'          MEMBERS EXIST IN RANGE OR PATTERN
FALLESD  EQU   X'08'          REQUEST ALL ESD ENTRIES
FCMD     EQU   X'04'          SUBCOMMAND BUFFER AVAILABLE
FQUOTE   EQU   X'02'          DATA SET NAME IS QUOTED
FNULL    EQU   X'01'          NULL LINE ENTERED
         SPACE 1
FLAGSCC  DS    XL1   FLAG BYTE 3
FDIREND  EQU   X'40'          END OF MEMBERS IN DIRECTORY REACHED
FIDRCONT EQU   X'20'          IDR RECORD PROCESSING CONTINUED
FIDRHCON EQU   X'10'          IDR HEADER CONTINUED
FPAGYES  EQU   X'08'          TURN ON PAGE BOUNDARY REQUEST
FPAGNO   EQU   X'04'          TURN OFF PAGE BOUNDARY REQUEST
FAPFON   EQU   X'02'          TURN ON APF REQUESTED
FAPFOFF  EQU   X'01'          TURN OFF APF REQUESTED
         SPACE 1
FLAGSDD  DS    XL1   FLAG BYTE 4
FPERMDS  EQU   X'80'          "PERM" DATA SET
FRECOVER EQU   X'40'          DSNAME PARSE FOR DATA SET RECOVERY
FIDR     EQU   X'20'          IDR RECORDS EXIST
F1IDR    EQU   X'10'          IDR TITLE PROCESSED
FBLDLOK  EQU   X'08'          PREVIOUS BLDL IS STILL VALID
RECFMU   EQU   X'04'          RECORD FORMAT U
RECFMV   EQU   X'02'          RECORD FORMAT V
RECFMF   EQU   X'01'          RECORD FORMAT F
         SPACE 1
FLAGSEE  DS    XL1   FLAG BYTE 5
OVERLAP  EQU   X'80'          OUTPUT THE NEXT LINE (OVERLAPPED STRING)
DONONUM  EQU   X'40'          NUM --> NONUM FOR THE REST OF THE MEMBER
DUMP     EQU   X'20'          ** DUMP OUTPUT FORMAT
BLOCK    EQU   X'10'          ** BLOCK OUTPUT FORMAT
LDUMP    EQU   X'08'          ** LINEDUMP OUTPUT FORMAT
MULTI    EQU   X'04'          ** MULTILINE OUTPUT FORMAT
SNUM     EQU   X'02'          ** SNUM OUTPUT FORMAT
NONUM    EQU   X'01'          ** NONUM OUTPUT FORMAT
*NUM     EQU   X'00'          ** NUM (DEFAULT) IF NOT SNUM, NONUM,
*                                    MULTILINE, LINEDUMP, BLOCK OR DUMP
FLAGSFF  DS    XL1   FLAG BYTE 6
FSPFOPT6 EQU   X'02'          EXECUTING UNDER SPF OPTION 6
FSPFCALL EQU   X'01'          SET AFTER SPF HAS BEEN CALLED ONCE
         EJECT
*TAEPARM STAE  0,CT,MF=L                LIST FORM STAE    ***.NOSTAE
         SPACE
STAXPARM STAX  ATTNEXIT,REPLACE=YES,IBUF=0,OBUF=0,MF=L
         SPACE 2
PDSNAME  DS    CL8                      PDS ACTUAL COMMAND NAME
DDNAME   DS    CL8
DDNAMEH  DS    CL8                      DDNAME HOLD
DSNAMEH  DS    CL4                      FIRST FOUR DSNAME CHARACTERS
VOLALLOC DS    CL6                      ALLOCATED DISK VOLUME NAME
         SPACE 2
DSNLEN   DS    H
DSNAME   DS    CL44
PASSWORD DS    CL8
VOLUME   DS    CL8
SAVLEN   EQU   *-DSNLEN
         SPACE 1
SAVDSN   DS    XL1,XL2,XL44,XL8,XL8
*        SAVE REQUESTED DISPOSITION, DSN LENGTH, DSN, PASSWORD, VOLUME
         SPACE 2
CAMLST   CAMLST SEARCH,0,0,0
         EJECT
         DS    0F
MSGTEXT1 DS    XL124,XL136       4 BYTE COUNT AND 256 BYTE DISPLAY
MSGTEXT2 DS    XL124
         SPACE
COMMDSTR EQU   MSGTEXT1+124,256  OPERAND FOR SUBMIT, PRINTOFF, TSOLIST
         SPACE
DAYTABLE DS    XL12
         SPACE 2
PUTOLD1  DS    3F
PUTOLD2  DS    3F
         SPACE 2
         PRINT NOGEN
INDCB    DCB   DEVD=DA,DDNAME=X,MACRF=E,EXLST=EXLST
STOWDCB  DCB   DSORG=PO,DEVD=DA,DDNAME=X,MACRF=(R,W),EXLST=EXLST
EXLSTX   DS    A
         PRINT GEN
         SPACE 2
FINDTBL  DS    XL256           TRT TABLE (FIND FIRST BYTE OF STRING)
IDROFSAV DS    F               CONTINUED IDR BLOCK OFFSET SAVE AREA
LISTR3R6 DS    4A              FIND/LIST SAVE AREA FOR R3, R4, R5 & R6
ANSWERS  DS    XL24            FIRST 24 BYTES OF PARSE RESULTS FOR EDIT
MEMFIRST EQU   ANSWERS,1       FIRST MEMBER NAME CHARACTER FOR DELETE
FINDLTH  DS    H               ACTUAL STRING LENGTH
FINDSTR  DS    CL16            ACTUAL FIND STRING
         SPACE 3
         DS    0F
SUBNAME  DS    CL8            CURRENT FULL SUBCOMMAND NAME
MAXLEN   DS    F              MAXIMUM RECORD LENGTH
MAXIN    DS    F              MAXIMUM RECORD TO READ
MAXOUT   DS    F              MAXIMUM DATA LINES TO OUTPUT
SKIPREC  DS    F              RECORDS TO SKIP AT THE BEGINNING
SKIPCOL  DS    F              COLUMNS TO SKIP FOR EACH RECORD
LMEMS    EQU   *-SUBNAME      RESET LENGTH FOR SUBCOMMANDS
COMMDLTH DS    H              EXTERNAL SUBCOMMAND OPERAND LENGTH
LINIT    EQU   *-MAXLEN       INITIALIZATION LENGTH FOR SUBCOMMANDS
         SPACE 1
MEMSHOLD DS    CL8,5XL4       RESET SAVE AREA FOR SUBCOMMANDS
         SPACE 3
MEMNAME  DS    CL8            DIRECTORY NAME FOR READDIR
MEMTTR   DS    XL3            TTR ADDRESS FOR READDIR
MEMFLAG  DS    X              FLAG BYTE FOR READDIR
         EJECT
         DS    0F
BLDLLIST DS    XL4
DIRNAME  DS    CL8
DIRTTR   DS    XL3
DIRFLAG  DS    X
DIRUSER  DS    XL62
         ORG   DIRUSER
*        THE FOLLOWING FIELDS APPLY TO LOAD MODULES
DIRSTART DS    XL4            TTR OF FIRST TEXT BLOCK
DIRNOTE  DS    XL3            TTR OF NOTE LIST
DIRNOTE# DS    X
DIRATTR  DS    XL2
DIRSTORE DS    XL3            SIZE OF LOAD MODULE
DIRTEXTL DS    XL2            LENGTH OF 1ST TEXT RECORD
DIREPA   DS    XL3            ENTRY POINT ADDRESS
DIRATTR2 DS    XL1        ADDITIONAL ATTRIBUTE BYTES:
DIRAOSLE EQU   X'80'          VS LINKAGE EDITOR CREATED THIS MODULE
DIRRESRV EQU   X'40'          RESERVED FOR FUTURE EXPANSION
DIR2PAGA EQU   X'20'          PAGE ALIGNMENT REQUIRED FOR THIS MODULE
DIR2SSI  EQU   X'10'          SSI INFORMATION IS PRESENT FOR MODULE
DIRAPFLG EQU   X'08'          APF INFORMATION FOR THIS MODULE IS VALID
DIRMODE  DS    X
         DS    XL1            RESERVED
DIRAPF   DS    0XL2           APF (IF NOT SCAT, SSI OR ALIAS)
DIREP    DS    XL3            ENTRY POINT (REAL MEMBER)
DIRREAL  DS    CL8            REAL NAME OF MEMBER
DIRAPF2  DS    XL2            APF INFORMATION (ALIAS, NO SCAT OR SSI)
DIREND2  EQU   *              END OF ALIAS SECTION
         ORG   DIRAPF    FOLLOWING FOR SCATTER LOADED MEMBERS
DIRSCLL  DS    XL2            LENGTH OF SCATTER LIST
DIRSCTL  DS    XL2            LENGTH OF TRANSLATE TABLE
DIRSCET  DS    XL2            ESDID OF FIRST TEXT RECORD
DIRSCEP  DS    XL2            ESDID OF ENTRY POINT
DIRAPF3  DS    0XL2           APF (IF SCAT, NO SSI AND NO ALIAS)
DIREPSC  DS    XL3            ENTRY POINT (REAL MEMBER)
DIRREALS DS    CL8            REAL NAME OF MEMBER
DIRAPF4  DS    XL2            APF INFORMATION (SCAT, NO SSI AND ALIAS)
DIREND3  EQU   *              END OF SCATTER, ALIAS SECTION
*
         ORG   DIRUSER   FOLLOWING FOR MODULES SAVED BY SPF EDIT
DIRSPFV  DS    XL1            VERSION NUMBER IN BINARY
DIRSPFR  DS    XL1            REVISION NUMBER IN BINARY
DIRSPFZ  DS    XL2            NOT CURRENTLY USED
DIRSPFCR DS    XL4            CREATION DATE IN FORMAT 00YYDDDF
DIRSPFCD DS    XL4            LAST CHANGE DATE IN FORMAT 00YYDDDF
DIRSPFCT DS    XL2            LAST CHANGE TIME IN FORMAT HHMM
DIRSPFSI DS    XL2            CURRENT SIZE IN BINARY
DIRSPFIN DS    XL2            INITIAL SIZE IN BINARY
DIRSPFMD DS    XL2            MODIFIED LINES IN BINARY
DIRSPFID DS    CL8            USERID OF LAST PERSON TO UPDATE
*                             END OF SPF SECTION
         ORG   ,
DIREND   EQU   *              END OF DIRECTORY INFORMATION
         DS    XL2            PADDING FOR:    MVC    DIRFLAG,DIRFLAG+2
         EJECT
CCWS     DS    0D
CCW1A    CCW   X'31',IOBSEEK-IOBSEEK+3,X'60',5  SEARCH ID EQUAL (CCHHR)
CCW2A    CCW   X'08',*-8-(*-8),X'60',1          TIC
CCW3A    CCW   X'92',IOBSEEK-IOBSEEK+3,X'20',8  MT READ NEXT COUNT
*
CCW0     CCW   X'23',SNO-SNO,X'60',1            SET SECTOR
CCW1     CCW   X'31',IOBSEEK-IOBSEEK+3,X'60',5  SEARCH ID EQUAL (CCHHR)
CCW2     CCW   X'08',*-8-(*-8),X'60',1          TIC
CCW3     CCW   X'06',*-*,X'60',32760            READ DATA
CCW4     CCW   X'92',IOBSEEK-IOBSEEK+3,X'60',8  MT READ NEXT COUNT
CCW5     CCW   X'22',SNO-SNO,X'20',1            READ SECTOR NUMBER
LCCWINIT EQU   *-CCWS
         SPACE 2
IOB      DC    X'C2000000'
IOBECB   DC    A(IOECB)
IOBCSW   DC    2A(0)
IOBCCW   DC    A(CCW1)
IOBDCB   DC    A(INDCB)
         DC    2A(0)
IOBSEEK  DC    2A(0)       *** NEXT MBBCCHHR ADDRESS
KEYLN    DS    X           *** NEXT KEYLENGTH
DATALN   DS    2X          *** NEXT RECORD LENGTH
SNO      DS    X           *** NEXT SECTOR NUMBER
DIRPTRS  DS    3A          *** READDIR CURRENT DIRECTORY POINTERS
IOECB    DS    F           *** ECB FOR EXCP
CUREXT   DS    F           *** CURRENT DATA SET EXTENT
LIOBDIR  EQU   *-IOBSEEK
         SPACE 2
SIOBDIR  DS    2A,4X,3A,2F *** READDIR SAVED DATA
SAVDIR   DS    XL256           READDIR SAVED DIRECTORY BLOCK
*
CURMBB   DS    XL8             CURRENT MBBCCHHR ADDRESS
LSTARMBB DS    XL8             DS1LSTAR IN MBBCCHHR FORMAT
         SPACE
EXCPCCWI DS    A               INITIAL CCW (CCW0 OR CCW1)
STARTTR  DS    F               INITIAL TTR TO READ
LS       DS    F               CURRENT RECORD LENGTH
         SPACE 3
LINKSFL  LINK  EPLOC=SUBLIT,SF=L    LIST FORM OF LINK MACRO
         EJECT
         DS    0F
DAIR08   DS    XL88,XL12      DAIR ALLOCATION BLOCK
DAIR18   DS    XL40           DAIR FREE BLOCK
         ORG   DAIR08-44
         IECSDSL1 (1)         FORMAT 1 DSCB
         ORG   ,
         EJECT
GFPARMP  DS    F              POINTER TO START OF GENERAL FAIL PARMS
         IKJEFFGF
         EJECT
         IKJEFFDF
         ORG   DFBUFS         NO CALLER-SUPPLIED BUFFERS NEEDED
         SPACE 3
LENWORK  EQU   *-WORKAREA
         EJECT
*
*
*        ESD TABLE FORMAT
*
*
         SPACE 1
ESDENTRY DSECT
ESDLINK  DS    F
ESDNAME  DS    CL8            NAME OF EXTERNAL SYMBOL
ESDTYPE  DS    X              ESD TYPE
CODESD   EQU   X'00'          ENTERNAL DEFINITION
CODELR   EQU   X'03'          EXTERNAL REFERENCE
CODEPC   EQU   X'04'          PRIVATE CODE DEFINITION
CODECM   EQU   X'05'          COMMON BLOCK
CODESEG  EQU   X'14'          OVERLAY SEGMENT TABLE
CODEENTB EQU   CODESEG        OVERLAY ENTRY TABLE
ESDADDR  DS    XL3            RELATIVE OFFSET
ESDSEG#  DS    X              SEGMENT NUMBER
ESDLEN   DS    XL3            LENGTH OF SD ENTRY
LENESD1  EQU   *-ESDNAME      LENGTH OF ESD DATA
ESDID    DS    XL2            RELATIVE ESD ID #
LENESD2  EQU   *-ESDNAME      LENGTH OF ESD DATA
LENESD   EQU   *-ESDENTRY     LENGTH OF ENTRY
         SPACE 3
*
*
*        IDR TABLE FORMAT
*
*
         SPACE 1
IDRENTRY DSECT
IDRLINK  DS    A
IDRSTART EQU   *
IDRESDID DS    XL2
IDRTYPE  DS    X
IDRZAP   EQU   X'01'
IDRLKED  EQU   X'02'
IDRUSER  EQU   X'08'
IDRDATE  DS    XL3
IDRLDATA DS    X
IDRUPREF DS    XL6            USER RECORD PREFIX
IDRZDATA DS    0CL8
IDRDATA  DS    CL40
LENIDR1  EQU   *-IDRSTART
LENIDR   EQU   *-IDRENTRY
         EJECT
         IKJPPL
         SPACE 3
         IKJCSPL
         SPACE 2
         IKJCSOA
         EJECT
         IKJIOPL
         SPACE 5
         IKJPGPB
**       EJECT
**       IKJGTPB
         EJECT
         IKJPSCB
         EJECT
         IKJECT
         EJECT
         IKJCPPL
         EJECT
         IKJDAPL
**       EJECT
**       IKJDAP00
**       EJECT
**       IKJDAP04
         EJECT
         IKJDAP08
         EJECT
         IKJDAP18
         SPACE 2
**       IKJDAP0C
**0CDDN  DS    XL8 START OF DDNAME LIST
**       EJECT
**       IKJDAP10
**       EJECT
**       IKJDAP14
**       EJECT
**       IKJDAP1C
**       EJECT
**       IKJDAP24
**       EJECT
**       IKJDAP28
**       EJECT
**       IKJDAP2C
**       EJECT
**       IKJDAP30
         EJECT
         IKJDFPL
         SPACE 3
         IKJDFPB
         EJECT
         PRINT NOGEN
         DCBD  DSORG=PO
         SPACE 5
         CVT   DSECT=YES
         SPACE 5
.NOGEN   END  PDS
./ ADD NAME=XQCB
         TITLE 'XQCB                             X-COMMAND QCB'
QCB      CSECT
         SPACE 3
***********************************************************************
*                                                                     *
*      IDENTIFICATION DIVISION.                                       *
*                                                                     *
*      PROGRAM-ID. QCB.                                               *
*      AUTHOR. EHNERT.                                                *
*      INSTALLATION. BAYER AG, LEVERKUSEN, RECHENZENTRUM.             *
*      DATE-WRITTEN. 3.7.1974.                                        *
*      REMARKS.                                                       *
*          DAS X-COMMAND QCB ZEIGT MOEGLICHE ZUKUENFTIGE ODER BE-     *
*          REITS BESTEHENDE KONFLIKTSITUATIONEN VON TASKS AN.         *
*                                                                     *
*          WIRD KEIN PARAMETER ANGEGEBEN, SO WERDEN ALLE TASKS ANGE-  *
*          ZEIGT, DIE EXCLUSIVEN ZUGRIFF AUF EINE DATEI HABEN, WENN   *
*          NOCH ANDERE TASKS GLEICHZEITIG AUF DIE DATEI WARTEN.       *
*                                                                     *
*          WIRD DER PARAMETER 'ALL' ANGEGEBEN, SO WERDEN ALLE EXCLU-  *
*          SIVEN REQUESTS ANGEZEIGT. IN DIESEM FALL KANN UEBER DAS    *
*          BESTEHEN EINER KONFLIKTSITUATION KEINE AUSSAGE GETROFFEN   *
*          WERDEN.                                                    *
*          WIRD DER PARAMETER '<JOBNAME>' ANGEGEBEN, SO WERDEN ALLE   *
*          REQUESTS DIESES JOBS ANGEZEIGT.                            *
*          WIRD DER PARAMETER '<Q-NAME>' ANGEGEBEN, SO WERDEN ALLE    *
*          BESTEHENDEN QCB MIT DEM NAMEN <Q-NAME> AUSGEGEBEN.         *
*          WIRD DER PARAMETER '<MAJOR-QCB>' ANGEGEBEN, WERDEN ALLE    *
*          BESTEHENDEN QCB MIT DEM MANJOR-NAME <MAJOR-QCB>            *
*          AUSGEGEBEN.                                                *
*          (ICR)                                                      *
*                                                                     *
*          JOB- UND STEPNAMEN WERDEN UNTER VS2,REL2 MIT HILFE DES     *
*          UNTERPROGRAMMS FASID AUFGESUCHT.                           *
*                                                                     *
***********************************************************************
         EJECT
***********************************************************************
*                                                                     *
*      PROCEDURE DIVISION.                                            *
*                                                                     *
***********************************************************************
         SPACE 3
*
*      SICHERN DER REGISTER, ZUORDNUNG DER BASISREGISTER UND
*      SPEICHERPLATZANFORDERUNG FUER DIE ARBEITSBEREICHE.
*
         SPACE 2
         XSAVE R12,,QCB,ABERL
         REG
         LR    R11,R1        BASISREG. FUER DSECT PARMAREA INITIAL.
         USING PARMAREA,R11  BASISREG. FUER DSECT PARMAREA ZUORDNEN
         USING ABER,R13      BASISREG. FUER DSECT ABER ZUORDNEN
         EJECT
         XC    MSGCNT(4),MSGCNT
         MVI   JOBBYTE,X'00' SCHALTER LOESCHEN
         MVI   MQNBYTE,X'00' SCHALTER LOESCHEN
         MVI   ALLBYTE,X'00' SCHALTER LOESCHEN
         MVI   SWITCH+1,X'F0'
         MVI   SWITCH1+1,X'F0'
         L     R15,16
         L     R15,196(R15)    SMCA
         MVC   SYSID,16(R15)    GET SYSID
         CLC   TEXT+4(4),=C'ALL ' PARAMETER = 'ALL' ?
         BNE   *+12          NEIN, VERZWEIGEN
         MVI   ALLBYTE,X'FF' SCHALTER SETZEN
         B     ASKSYS        VERZWEIGEN
         CLC   TEXT+3(3),=C',,,'  Q. MAJOR QCBNAME ANGEGEBEN        ICR
         BNE   NCLC               A. NO                             ICR
         MVC   SYSDSN,TEXT+6      A. YES - MOVE MAJOR-QCB-N SEARCH  ICR
         MVI   MQNBYTE,X'FF'         GLEICH WIE MINOR-QCB-HANDLING  ICR
         MVI   MQNB+1,X'00'          UEBERGEHEN MINOR-QCB-ABFRAGE   ICR
         B     ASKSYS                                               ICR
NCLC     EQU   *                                                    ICR
         CLC   TEXT+3(2),=C',,' QCB NAME ANGEGEBEN ?
         BNE   *+16          NEIN, VERZWEIGEN
         MVI   MQNBYTE,X'FF' SCHALTER SETZEN
         MVI   SWITCH+1,X'00'
         B     ASKSYS        VERZWEIGEN
         CLC   TEXT+4(8),=CL8' ' KEIN PARAMETER ANGEGEBEN ?
         BE    ASKSYS        JA, VERZWEIGEN
         MVI   JOBBYTE,X'FF' SCHALTER SETZEN
         SPACE 2
*
*      ABFRAGE DES SYSTEMS.
*
         SPACE 1
ASKSYS   EQU   *
         MVI   SCH,X'00'     SCHALTER LOESCHEN
         GETMAIN R,LV=409600
         ST    R1,TABAD
         LR    R8,R1
         L     R9,=F'79920'
         AR    R9,R8
         ST    R9,TABEND
         OI    SCH,X'40'     BIT FUER MVS SETZEN
         LA    R0,ASID       ADRESSE DER ASID LADEN
         LA    R1,JOBNAME    ADRESSE DES JOBNAMEN LADEN
         LA    R2,STEPNAME   ADRESSE DES STEPNAMEN LADEN
         STM   R0,R2,PARMLIST ADRESSEN IN DIE PARAMETERLISTE UEBERTR.
         MVI   LASTPARM,X'80' BIT FUER LETZTEN PARAMETER SETZEN
         B     SP3ROUT
         EJECT
***********************************************************************
*                                                                     *
*      WTO-NACHRICHTENAUSGABE.                                        *
*                                                                     *
***********************************************************************
         SPACE 3
WTOR1    EQU   *
         ST    R14,SAVE14
         L     R0,REG4
         C     R0,=CL4'ROSC'
         BNE   NOROS
         STM   R14,R12,12(R13)                   SAVE ALL REGS IN SA
*
*              NOW WE CAN ADDRESS DUMMYSECTION IN XMON
*
         LH    R0,0(R1)      LOAD LENGTH OF WTO
         SH    R0,=H'4'      DECREMENT BY 4
         STC   R0,3(R1)      INSERT LENGTH TO MESSAGE FOR USE BY ROSCOE
         LA    R0,3(R1)      LOAD MESSAGE ADDRESS
         L     R13,4(R13)    R13 --> SA IN XMON
         ST    R0,76(R13)    STORE IT IN DYN AREA OF XMON = INAREA
         OI    76(R13),X'80' SET HIGHORDER BIT ON
         L     R15,100(R13)  LOAD ROSCOE-CODE <<OUTCODE>>
         LA    R1,76(R13)    LOAD PARAMETER REGISTER
         L     R13,4(R13)    R13 --> SA IN ROSCOE
         L     R14,12(R13)   LOAD RETURNADDRESS
         LM    R2,R12,28(R13)                    LOAD REMAINDER
         BR    R14           RETURN DIRECT TO ROSCOE
NOROS    EQU   *
         C     R0,=CL4'TSO'
         BNE   DOWTO
         LH    R0,0(R1)
         SH    R0,=H'4'
         LA    R1,4(R1)
         SVC   93             TPUT
         L     R14,SAVE14
         BR    R14
DOWTO    EQU   *
         WTO   MF=(E,(1))
         L     R14,SAVE14
         BR    R14
ENDWTO   EQU   *
         L     R3,TABAD
         FREEMAIN R,LV=409600,A=(R3)
         XRETURN 0,R
         TITLE ' X - QCB: MVS/SP REL. 3 SECTION'
SP3ROUT  EQU   *
         USING RIB,R7
         USING RIBVAR,R8
         USING RIBE,R10
         TM    JOBBYTE,X'FF'
         BZ    TSTALL
         MVI   SWITCH1+1,X'00'
         B     ALLSP3
TSTALL   TM    ALLBYTE,X'FF'
         BZ    NOTALL
ALLSP3   L     R1,TABAD
         GQSCAN AREA=((R1),409600),REQLIM=MAX,SCOPE=ALL
         B     CHKCODE
NOTALL   EQU   *
         CLI   MQNBYTE,X'FF'
         BNE   NOQNM
         L     R1,TABAD
         GQSCAN AREA=((R1),409600),REQLIM=MAX,SCOPE=ALL,               *
               RESNAME=SYSDSN
         LTR   R15,R15
         BZ    PROCRIB
         CH    R15,=H'4'
         BNE   CHK8
         MVC   WTO(LENMSG09),MSG09
         LA    R1,WTO
         BAL   R14,WTOR1
         B     ENDWTO
NOQNM    EQU   *
         L     R1,TABAD
         GQSCAN AREA=((R1),409600),REQLIM=MAX,SCOPE=ALL
CHKCODE  LTR   R15,R15
         BZ    PROCRIB
         CH    R15,=H'4'
         BNE   CHK8
OUT6     MVC   WTO(LENMSG06),MSG06
         LA    R1,WTO
         BAL   R14,WTOR1
         B     ENDWTO
CHK8     EQU   *
         CH    R15,=H'8'
         BNE   SCANERR
         MVC   WTO(LENMSG11),MSG11
         LA    R1,WTO
         BAL   R14,WTOR1
         B     PROCRIB
SCANERR  EQU   *
         MVC   WTO(LSCANMSG),SCANMSG
         LA    R1,WTO
         BAL   R14,WTOR1
         ABEND 111,DUMP
PROCRIB  EQU   *
         ST    R0,FULLWD
         LH    R2,FULLWD    LENGTH OF FIXED RIB
         LH    R3,FULLWD+2  LENGTH OF EACH RIBE
         LR    R4,R1        NUBER OF RIB'S RETURNED
         L     R7,TABAD     A(1. RIB)
RIBLP    EQU   *
         MVI   RIBBYTE,X'00'
         CLI   JOBBYTE,X'FF'
         BE    WAITING
         CLI   ALLBYTE,X'FF'
         BE    WAITING
         CLI   MQNBYTE,X'FF'
         BE    WAITING
         L     R15,RIBNTWE
         A     R15,RIBNTWS
         LTR   R15,R15
         BNZ   WAITING
         CLC   RIBQNAME,=CL8'SYSIEFSD'
         BE    WAITING
         MVI   RIBBYTE,X'FF'
WAITING  EQU   *
         L     R5,RIBNRIBE  NO. OF RIBE'S FOR THIS RIB
         LH    R10,RIBVLEN
         LA    R8,0(R2,R7)     ADDR. OF RIBVAR
         LA    R10,0(R10,R8)   ADDR. OF 1. RIBE
         MVC   WTO(LENMSG1X),MSG01X
         MVC   WTO+36(8),RIBQNAME
         SR    R15,R15
         IC    R15,RIBRNMLN
         CH    R15,=H'30'
         BNH   NOEX
         LA    R15,30
NOEX     EQU   *
         BCTR  R15,0
         EX    R15,MVCEXRIB
RIBELP   EQU   *
         MVC   WTO+12(8),RIBEJBNM
         MVC   WTO+7(4),RIBESYSN
         TM    RIBERFLG,RIBERESV    RESERVE-REQU.?
         BNO   NORES                NO
         TM    RIBERFLG,RIBERESC    REQU. CONVERTED?
         BO    NORES                YES
         CLC   SYSID,RIBESYSN
         BNE   NORES
         L     R15,RIBEUCB
         LTR   R15,R15
         BZ    NORES
         CLI   36(R15),X'00'
         BE    NORES
         L     R14,16
         TM    116(R14),X'80'    XA?
         BNO   NONXA
         SH    R15,=H'15'
         TM    0(R15),X'80'
         BNO   NORES
         LA    R15,15(R15)
         B     XARES
NONXA    TM    7(R15),X'10'
         BNO   NORES
XARES    MVC   WTO+22(2),=C'R='
         MVC   WTO+24(6),28(R15)
         B     RESOK
NORES    EQU   *
         MVC   WTO+22(8),=CL8'ENQUEUES'
RESOK    EQU   *
         TM    RIBERFLG,RIBETYPE
         BO    SHR
         MVI   WTO+31,C'E'
         B     EXCL
SHR      EQU   *
         MVI   WTO+31,C'S'
EXCL     EQU   *
         TM    RIBERFLG,RIBEMC
         BO    MC
         MVI   WTO+32,C'0'
         B     NOMC
MC       EQU   *
         MVI   WTO+32,C'M'
NOMC     EQU   *
         TM    RIBERFLG,RIBERESV
         BO    RES1
         MVI   WTO+33,C'0'
         B     NORES1
RES1     EQU   *
         MVI   WTO+33,C'R'
NORES1   EQU   *
         TM    RIBESFLG,RIBESTAT
         BO    OWN
         MVI   WTO+34,C'W'
         B     WAIT
OWN      EQU   *
         MVI   WTO+34,C'O'
WAIT     EQU   *
         CLI   MQNBYTE,X'FF'
         BNE   NOQNM1
         CLC   WTO+45(30),TEXT+5
MQNB     BNE   NOOUT
         MVI   SWITCH+1,X'F0'
NOQNM1   EQU   *
         TM    JOBBYTE,X'FF'
         BZ    NOJOBSP3
         CLC   WTO+12(8),TEXT+4
         BNE   NOOUT
         MVI   SWITCH1+1,X'F0'
NOJOBSP3 EQU   *
         CLI   RIBBYTE,X'FF'
         BE    NOOUT
         L     R1,MSGCNT
         LA    R1,1(R1)
         ST    R1,MSGCNT
         LA    R1,WTO
         BAL   R14,WTOR1
NOOUT    LA    R10,0(R3,R10)   GET ADDR. OF NEXT RIBE
         BCT   R5,RIBELP
NXTRIB   EQU   *
         LR    R7,R10
         BCT   R4,RIBLP
         CLC   TEXT+4(8),=CL8' '
         BNE   SWITCH
         CLC   MSGCNT(4),=F'0'
         BNE   ENDWTO
         BE    OUT6
SWITCH   NOP   SWITCH1
         MVC   WTO(LENMSG09),MSG09
         LA    R1,WTO
         BAL   R14,WTOR1
         B     ENDWTO
SWITCH1  NOP   ENDWTO
         MVC   WTO(LENMSG08),MSG08
         MVC   WTO+34(8),TEXT+4
         LA    R1,WTO
         BAL   R14,WTOR1
         B     ENDWTO
***********************************************************************
*                                                                     *
*      DATA DIVISION.                                                 *
*                                                                     *
***********************************************************************
         SPACE 3
*
*      NACHRICHTEN.
*
MSG01X   WTO   'QCBSIDX           ENQUEUES S000 12345678/              *
                               ',                                      *
               MF=L,MCSFLAG=(REG0)
LENMSG1X EQU   *-MSG01X
SCANMSG  WTO   'XQCB010 ERROR ENCOUNTERED IN GQSCAN-FUNCTION',         *
               MF=L,MCSFLAG=(REG0)
LSCANMSG EQU   *-SCANMSG
MSG02    WTO   'XQCB002 INVALID TCB-ADDR',                             *
               MF=L,MCSFLAG=(REG0)
LENMSG02 EQU   *-MSG02
MSG06    WTO   'XQCB006 NO JOBS IN CONFLICT SITUATION',                *
               MF=L,MCSFLAG=(REG0)
LENMSG06 EQU   *-MSG06
MSG07    WTO   'XQCB007 NO EXISTING QCB''S',                           *
               MF=L,MCSFLAG=(REG0)
LENMSG07 EQU   *-MSG07
MSG08    WTO   'XQCB008 NO EXISTING QCB''S FOR *JOBNAME',              *
               MF=L,MCSFLAG=(REG0)
LENMSG08 EQU   *-MSG08
MSG09    WTO   'XQCB009 NO EXISTING QCB''S OF SPECIFIED NAME FOUND',   *
               MF=L,MCSFLAG=(REG0)
LENMSG09 EQU   *-MSG09
MSG11    WTO   'XQCB011 TABLE OVERFLOW FOR GQSCAN-FUNCTION',           *
               MF=L,MCSFLAG=(REG0)
LENMSG11 EQU   *-MSG11
MVCEXRIB MVC   WTO+45(0),RIBRNAME
SYSDSN   DC    CL8'SYSDSN'
MSGCNT   DC    F'0'
         EJECT
*
*      ARBEITSBEREICHE.
*
         SPACE 2
ABER     DSECT
SAVEAREA DS    18F           SAVEAREA FUER REGISTER
SAVE14   DS    F
TABAD    DS    F
TABEND   DS    F
SYSID    DS    CL4
WTO      DS    0F            BEREICH FUER NACHRICHTEN
         ORG   WTO+12
JOBNAME  DS    CL8           JOB NAME
         DS    C
STEPNAME DS    CL8           STEP NAME
         DS    CL14
MAJQCBNM DS    CL9
MINQCBNM DS    CL22          MINOR QCB NAME
         ORG   WTO+120
         SPACE 1
PARMLIST DS    0F
ADDRASID DS    A(ASID)       ADRESSE DER ASID
ADDRJOBN DS    A(JOBNAME)    ADRESSE DES JOBNAMEN
LASTPARM DS    C             = X'80'
ADDRSTPN DS    AL3(STEPNAME) ADRESSE DES STEPNAMEN
MAJNAM   DS    CL8
FULLWD   DS    F
         SPACE 1
ASID     DS    H
SCH      DS    C             BEREICH FUER SCHALTER-BITS
JOBBYTE  DS    C             PARAMETER-SCHALTER
RIBBYTE  DS    C             PARAMETER-SCHALTER
MQNBYTE  DS    C             PARAMETER-SCHALTER
ALLBYTE  DS    C             PARAMETER-SCHALTER
ABERL    EQU   *-ABER        LAENGE DES ARBEITSBEREICHS
         SPACE 3
*
*      PARAMETERBEREICH.
*
         SPACE 2
         XPARM
         EJECT
         ISGRIB
         END   QCB
./ ADD NAME=QCNC
DN       START
         XSAVE R12,SVA,DN
         REG
         LR    R11,R1
         USING PARMAREA,R11
         B     TSOOK
RETURN   EQU   *
         XRETURN 0
TSOOK    EQU   *
         GETMAIN R,LV=96028
         LR    R2,R1
         LR    R4,R1
         LINK  EP=JES2JOBQ
         LA    R2,28(R2)
         L     R3,=F'6000'   # OF JOBS
NXTENT   EQU   *
         CLC   4(8,R2),TEXT+5
         BE    FNDJOB
         CLC   0(4,R2),TEXT+5
         BE    FNDJOB
         LA    R2,16(R2)
         BCT   R3,NXTENT
         LA    R1,NOMSG
         BAL   R14,WTOROUT
         B     $DJDN
FNDJOB   EQU   *
         TM    15(R2),X'81'
         BNZ   CANCEL
         LA    R1,WRQ
         BAL   R14,WTOROUT
         B     $DJDN
CANCEL   MVC   CMD+8(4),0(R2)
         SR    R0,R0
         LA    R1,CMD
         SVC   249
         MVC   CNCMSG+12(8),TEXT+5
         LA    R1,CNCMSG
         BAL   R14,WTOROUT
$DJDN    FREEMAIN R,LV=96028,A=(R4)
         B     RETURN
WTOROUT  EQU   *
         ST    R14,SAVE14
         CLC   REG4(4),=CL4'TSO'
         BNE   NOTSO
         TPUT  (1),70
         L     R14,SAVE14
         BR    R14
NOTSO    EQU   *
         L     R0,REG4
         MVC   WTOM,0(R1)
         LA    R1,WTO
         C     R0,=CL4'ROSC'
         BNE   NOROS
         STM   R14,R12,12(R13)                   SAVE ALL REGS IN SA
*
*              NOW WE CAN ADDRESS DUMMYSECTION IN XMON
*
         LH    R0,0(R1)      LOAD LENGTH OF WTO
         SH    R0,=H'4'      DECREMENT BY 4
         STC   R0,3(R1)      INSERT LENGTH TO MESSAGE FOR USE BY ROSCOE
         LA    R0,3(R1)      LOAD MESSAGE ADDRESS
         L     R13,4(R13)    R13 --> SA IN XMON
         ST    R0,76(R13)    STORE IT IN DYN AREA OF XMON = INAREA
         OI    76(R13),X'80' SET HIGHORDER BIT ON
         L     R15,100(R13)  LOAD ROSCOE-CODE <<OUTCODE>>
         LA    R1,76(R13)    LOAD PARAMETER REGISTER
         L     R13,4(R13)    R13 --> SA IN ROSCOE
         L     R14,12(R13)   LOAD RETURNADDRESS
         LM    R2,R12,28(R13)                    LOAD REMAINDER
         BR    R14           RETURN DIRECT TO ROSCOE
NOROS    EQU   *
         WTO   MF=(E,WTO)
         L     R14,SAVE14
         BR    R14
NOMSG    DC    CL70'XQCNC02 JOB NOT FOUND'
WRQ      DC    CL70'XQCNC01 JOB NOT IN INPUT-QUEUE'
CNCMSG   DC    CL70'XQCNC03 JOB 12345678 CANCELLED'
CMD      DS    0F
         DC    H'28,0'
         DC    CL24' $CJ1234     ***XQCNC***'
WTO      DS    0F
         DC    H'70',X'4000'
WTOM     DC    CL70' '
SAVE14   DC    F'0'
         XPARM
         END
./ ADD NAME=REN
***********************************************************************
*                                                                     *
*        INITIAL PROCESSING.                                          *
*                                                                     *
***********************************************************************
         SPACE 2
XREN     CSECT
         XSAVE R12,,XREN,WORKLEN
         USING WORK,R13                 ALLOC. BASE REG. OF WORKAREA
         USING PARMAREA,R11             ALLOC. BASE REG. OF PARMAREA
         LR    R11,R01                  INIT. BASE REG. OF PARMAREA
INIT     EQU   *
         XC    TRTTAB(256),TRTTAB       CLEAR TRANSLATE TABLE
         MVI   MEMBER,C' '              INITIALIZE
         MVC   MEMBER+1(15),MEMBER       MEMBER NAME
         MVI   DSNAME,C' '              INITIALIZE
         MVC   DSNAME+1(43),DSNAME      DSNAME
         MVI   VOLSER,C' '              INITIALIZE
         MVC   VOLSER+1(5),VOLSER       VOLSER
         MVI   VOL,X'00'                INIT. FLAG BYTE FOR VOL. SPEC.
         CLC   REG4(4),=CL4'TSO'
         BNE   NOTSO1
         L     R5,4(R13)
         L     R5,4(R5)
         L     R5,24(R5)
         MVC   UPT(4),4(R5)
         MVC   ECT(4),12(R5)
NOTSO1   EQU   *
*
*   SCAN PARAMETERS
*
         CLI   TEXT+3,C','              LOOK FOR FIRST SEPERATOR
         BNE   ERROR                    BRANCH IF NOT FOUND
         MVI   KOMMA,C','               MOVE SEPARATOR TO TRANSL. TAB.
         TRT   TEXT+4(119),TRTTAB       LOOK FOR NEXT SEPERATOR
         BZ    ERROR                    IF NONE, ONLY DSN. SPECIFIED
         LR    R5,R1                    LOAD ADRESS FOR SECOND SEPERAT.
DSNPO    EQU   *
         MVI   KOMMA,X'00'              CLEAR TRANSLATE TABLE AGAIN
         MVI   LPAN,C'('                MOVE LEFT PARENTHESIS TO TABLE
         TRT   TEXT(124),TRTTAB         LOOK FOR LEFT PARENTHESIS
         BZ    ERROR                    IF NONE,SEQUENTIAL DATASET
         LR    R3,R1                    SAVE ADDRESS OF LEFT PAREN.
         CLI   1(R3),C'+'
         BE    ERROR
         CLI   1(R3),C'-'
         BE    ERROR
         TM    1(R3),X'F0'
         BO    ERROR
         MVI   LPAN,X'00'               CLEAR TRANSLATE TABLE AGAIN
         MVI   RPAN,C')'                MOVE RIGHT PARENTHESIS TO TABLE
         TRT   TEXT(124),TRTTAB         LOOK FOR RIGHT PARENTHESIS
         BZ    ERROR                    IF NONE, SYNTAXERROR
         MVI   RPAN,X'00'               CLEAR TRANSLATE TABLE
         LR    R4,R1                    SAVE ADDRESS OF RIGHT PAREN.
         SR    R1,R3                    MEMBERLENGTH+2
         BM    ERROR                    IF NEGATIVE, BRANCH ERROR
         BCTR  R1,0                     DECREASE BY
         BCTR  R1,0                     TWO
         EX    R1,MOVEMEM               BRANCH TO MOVE MEMBER NAME
         LA    R1,TEXT+4                LOAD ADDRESS OF DSN
         LR    R2,R3                    SAVE ADDRESS OF LEFT PAREN.
         SR    R2,R1                    COMPUT LENGTH OF DSN
         BCTR  R2,0                     DECREASE BY ONE
         EX    R2,MOVEDSN               BRANCH TO MOVE DSN
VOLUME   EQU   *
         CLC   1(2,R5),=C'N='           NEXT PARM = NEW MBR-NAME?
         BNE   VOLFIRST                 IF NOT, VOL FIRST SPECIFIED
         MVC   MEMBER+8(8),3(R5)        MOVE NEW MBR-NAME.
         B     RENAME
VOLFIRST EQU   *
         LA    R2,TEXT+123              LOAD ADDRESS OF TEXTEND
         SR    R2,R5                    COMPUTE LENGTH OF REMAINDER
         BCTR  R2,0                     DECRAESE BY ONE
         MVI   KOMMA,C','               MOVE KOMMA TO TRANSLATE TABLE
         EX    R2,TRT                   BRANCH TO LOOK FOR NEXT SEP.
         BZ    ERROR                    IF NONE, BRANCH
         LR    R6,R1                    ELSE SAVE ADDRESS OF THIRD SEP.
         MVI   KOMMA,C' '               CLEAR TRANSLATE TABLE
         SR    R1,R5                    COMPUTE LENGTH OF VOLSER
         BCTR  R1,0                     DECREASE BY
         BCTR  R1,0                     TWO
         EX    R1,MOVEVOL               BRANCH TO MOVE VOLSER
         OI    VOL,X'80'                SET FLAG FOR VOLSER
         CLC   1(2,R6),=C'N='           CHECK NEW MBR-NAME
         BNE   ERROR                    IF NOT, BRANCH ERROR
         MVC   MEMBER+8(8),3(R6)
RENAME   EQU   *
         TM    VOL,X'80'                 ELSE TEST FOR VOLUME SPEC.
         BO    LOOKDEVT                  IF YES, BRANCH TO UCB PROC.
         EJECT
**********************************************************************
*                                                                    *
*        RETRIEVE CATALOG INFORMATION.                               *
*                                                                    *
**********************************************************************
         SPACE 2
         MVC   LOCLIST(16),LOCLISTX      MOVE LOCATELIST SKELETON
         LA    R2,DSNAME                 LOAD ADDRESS OF DSN
         LA    R3,LOCAREA                LOAD ADDRESS OF LOCATE AREA
         ST    R2,LOCLIST+4              STORE ADDRESS OF DSN TO LOCL.
         ST    R3,LOCLIST+12             STORE ADDR. OF LOCAREA TO LOC.
         LOCATE LOCLIST                  RETRIEVE CATALOG INF.
         LTR   R15,R15                   RETURNCODE=0 ?
         BZ    RENAMEM                   IF YES, BRANCH TO RENAME
         CVD   R15,DOPPELW               CONVERT RC TO DECIMAL
         UNPK  RC,DOPPELW                UNPACK RC
         OI    RC+3,X'F0'                MODIFY SIGN
         MVC   WTO(LMSG06),MSG06         MOVE MESSAGE SKELETON
         MVC   WTO+40(2),RC+2            MOVE RC TO MSG
         MVC   WTO+47(44),DSNAME         MOVE DSN TO MSG
         L     R0,REG4                   MOVE UCM-ID.
         LA    R1,WTO
         BAL   R14,WTOROUT
         B     RETURN                    BRANCH RETURN
         EJECT
***********************************************************************
*                                                                     *
*        PROCESSING OF UCB LOOKUP-TABLE.                              *
*                                                                     *
***********************************************************************
         SPACE 2
LOOKDEVT EQU   *
         L     R1,16                     LOAD CVT ADDRESS
         L     R2,40(R1)                 LOAD UCB LOOKUP-TABLE ADDR.
         SR    R4,R4                     CLEAR R4
LOOP     EQU   *
         CLC   0(2,R2),=X'FFFF'          END OF UCB LOOKUP-TABLE ?
         BE    NODEV                     IF YES, NO DEVICE FOUND
         ICM   R4,3,0(R2)                SAVE UCB ADDRESS
         CLC   28(6,R4),VOLSER           COMPARE VOLSER
         BE    MOVEDEV                   IF EQUAL, DEVICE FOUND
         LA    R2,2(,R2)                 LOAD ADDRESS OF NEXT UCB-ADDR.
         B     LOOP                      BRANCH FOR NEXT UCB
NODEV    EQU   *
         MVC   WTO(LMSG07),MSG07          MOVE MESSAGE SKELETON
         MVC   WTO+19(6),VOLSER           MOVE VOLSER TO MSG
         L     R0,REG4                    MOVE UCM-ID.
         LA    R1,WTO
         BAL   R14,WTOROUT
         B     RENAMEM
MOVEDEV  EQU   *
         XC    LOCAREA(256),LOCAREA      CLEAR LOCATE AREA
         XC    LOCAREA+256(9),LOCAREA+256
         MVC   LOCAREA+6(6),VOLSER        MOVE VOLSER TO LOCATE AREA
         MVC   LOCAREA+2(4),16(R4)        MOVE DEVICETYPE TO LOC. AREA
         LA    R1,1(,0)                   LOAD VOLUME COUNT
         STH   R1,LOCAREA                 STORE VOLUME COUNT TO LOC. A.
         EJECT
**********************************************************************
*                                                                    *
*        RENAME  PROCESSING FOR MEMBERS.                             *
*                                                                    *
**********************************************************************
         SPACE 2
*        DYNALLOC
RENAMEM  EQU   *
         LA    R1,DYNAREA                 LOAD ADDRESS OF DYNAREA
         LA    R2,S99RB                   LOAD ADDRESS OF REQUEST BLOCK
         ST    R2,S99RBPTR                STORE RB-ADDR. TO RBPTR
         OI    S99RBPTR,X'80'             MODIFY HIGH ORDER BYTE
         XC    S99RB(RBLEN),S99RB         CLEAR REQUEST BLOCK
         MVI   S99RBLN,RBLEN              MOVE LENGTH TO RB
         MVI   S99VERB,X'01'              SET FLAG BYTE
         MVI   S99FLG11,X'00'             SET FLAG BYTE
         MVI   S99FLG12,X'00'             SET FLAG BYTE
         LA    R2,S99TUPT1                LOAD ADDRESS FIRST TXTUNITPTR
         ST    R2,S99TXTPP                STORE ADDRESS TO RB
         MVI   S99FLG21,X'D9'             SET FLAG BYTE
         MVI   S99FLG22,X'00'             SET FLAG BYTE
         MVI   S99FLG23,X'00'             SET FLAG BYTE
         MVI   S99FLG24,X'00'             SET FLAG BYTE
         LA    R3,S99TUKE1                LOAD ADDRESS FIRST TEXTUNIT
         ST    R3,S99TUPT1                STORE ADDRESS TO TXTUNITPTR
         LA    R4,4(,0)                   GET THE STATUS KEY
         STH   R4,S99TUKE1                STORE KEY TO TEXTUNIT
         LA    R4,1(,0)                   GET NUMBER AND LENGTH OF
         STH   R4,S99TUNU1                PARAMETER AND STORE IT TO
         STH   R4,S99TULN1                THE TEXTUNIT
         MVI   S99TUPA1,X'08'             MOVE PARAMETER
         LA    R3,S99TUKE2                LOAD ADDRESS OF NEXT TEXTUNIT
         ST    R3,S99TUPT2                STORE ADDR. TO NEXT TXTUNITPT
         LA    R4,5(,0)                   GET THE KEY FOR NORMAL DISP.
         STH   R4,S99TUKE2                STORE KEY TO TEXTUNIT
         LA    R4,1(,0)                   GET NUMBER AND LENGTH OF
         STH   R4,S99TUNU2                PARAMETER AND STORE IT TO
         STH   R4,S99TULN2                THE TEXTUNIT
         MVI   S99TUPA2,X'08'             MOVE PARAMETER TO TEXTUNIT
         LA    R3,S99TUKE3                LOAD ADDRESS OF NEXT TEXTUNIT
         ST    R3,S99TUPT3                STORE ADDR. TO NEXT TXTUNITPT
         LA    R4,6(,0)                   GET THE KEY FOR COND. DISP.
         STH   R4,S99TUKE3                STORE THE KEY TO TEXTUNIT
         LA    R4,1(,0)                   GET NUMBER AND LENGTH OF
         STH   R4,S99TUNU3                PARAMETER AND STORE IT TO
         STH   R4,S99TULN3                THE TEXTUNIT
         MVI   S99TUPA3,X'08'             MOVE PARAMETER TO TEXTUNIT
         LA    R3,S99TUKE4                LOAD ADDRESS OF NEXT TEXTUNIT
         ST    R3,S99TUPT4                STORE ADDR. TO NEXT TXTUNITPT
         MVC   S99TUKE4,=X'001C'          STORE THE KEY TO TEXTUNIT
         LA    R4,0(,0)                   GET NUMBER OF PARAMETER
         STH   R4,S99TUNU4                AND STORE IT TO TEXTUNIT
         LA    R3,S99TUKE5                LOAD ADDRESS OF NEXT TEXTUNIT
         ST    R3,S99TUPT5                STORE ADDR. TO NEXT TXTUNITPT
         MVC   S99TUKE5,=X'0055'          STORE KEY TO TEXTUNIT
         LA    R4,1(0)                    GET NUMBER OF PARAMETER
         STH   R4,S99TUNU5                AND STORE IT TO TEXTUNIT
         LA    R4,8(0)                    GET LENGTH OF PARAMETER
         STH   R4,S99TULN5                AND STORE IT TO TEXTUNIT
         MVC   S99TUPA5(8),=CL8' '        MOVE PARAMETER TO TEXTUNIT
         LA    R3,S99TUKE6                LOAD ADDRESS OF NEXT TEXTUNIT
         ST    R3,S99TUPT6                STORE ADDR. TO NEXT TXTUNITPT
         LA    R4,2(,0)                   GET KEY FOR DSNAME ALLOCATION
         STH   R4,S99TUKE6                STORE KEY TO TEXTUNIT
         LA    R4,1(,0)                   GET NUMBER OF PARAMETER
         STH   R4,S99TUNU6                AND STORE IT TO TEXTUNIT
         LA    R4,44(,0)                  GET LENGTH OF PARAMETER
         STH   R4,S99TULN6                AND STORE IT TO TEXTUNIT
         MVC   S99TUPA6(44),DSNAME        MOVE PARAMETER TO TEXTUNIT
         LA    R3,S99TUKE7                LOAD ADDRESS OF NEXT TEXTUNIT
         ST    R3,S99TUPT7                STORE ADDR. TO NEXT TXTUNITPT
         MVC   S99TUKE7,=X'0010'          STORE KEY TO TEXTUNIT
         LA    R4,1(,0)                   GET NUMBER OF PARAMETER
         STH   R4,S99TUNU7                AND STORE IT TEXTUNIT
         LA    R4,6(,0)                   GET LENGTH OF PARAMETER
         STH   R4,S99TULN7                STORE IT TO TEXTUNIT
         MVC   S99TUPA7(6),LOCAREA+6      MOVE PARAMETER TO TEXTUNIT
         LA    R3,S99TUKE8                LOAD ADDRESS OF NEXT TEXTUNIT
         ST    R3,S99TUPT8                STORE ADDR. TO NEXT TXTUNITPT
         MVC   S99TUKE8,=X'0015'          STORE KEY TO TEXTUNIT
         LA    R4,1(,0)                   GET NUMBER OF PARAMETER
         STH   R4,S99TUNU8                AND STORE IT TO TEXTUNIT
         LA    R4,8(,0)                   GET LENGTH OF PARAMETER
         STH   R4,S99TULN8                AND STORE IT TO TEXTUNIT
         LA    R5,DEVTAB                  LOAD ADDR. DEV.TABLE(EBCDIC)
DEVLOOP  EQU   *
         CLC   0(2,R5),=X'FFFF'           END OF DEV.TABLE(EBCDIC) ?
         BE    PUTMSG11                   IF YES, BRANCH TO PUT MSG
         CLC   0(2,R5),LOCAREA+4          IF DEV.TYPE IN DEV.TABLE
         BE    MOVUNIDS                   (EBCDIC), BRANCH TO MOVE TYPE
         LA    R5,12(,R5)                 LOAD ADDR. NEXT TABLE ENTRY
         B     DEVLOOP                    BRANCH TO LOOK AGAIN
PUTMSG11 EQU   *
         MVC   WTO(LMSG11),MSG11          MOVE MESSAGE SKELETON
         MVC   WTO+47(44),DSNAME          MOVE DSN TO MSG
         L     R0,REG4                    MOVE UCM-ID.
         LA    R1,WTO
         BAL   R14,WTOROUT
         B     RETURN                     BRANCH TO RETURN
MOVUNIDS EQU   *
         TM    LOCAREA+3,X'08'            VIRTUEL DEVICE ?
         BNO   REAL                       IF NOT, BRANCH TO MOVE REAL D
         MVC   S99TUPA8(10),=C'3330V     '   MOVE VIRTUEL DEVICE TYPE
         OI    S99TUPT8,X'80'             SET IND. FOR LAST TEXTUNITPTR
         B     ALLOC                      BRANCH ALLOCATION
REAL     EQU   *
         MVC   S99TUPA8(10),2(R5)         MOVE REAL DEV.TYPE TO TEXTUN.
         OI    S99TUPT8,X'80'             SET IND. FOR LAST TEXTUNITPTR
ALLOC    EQU   *
         LA    R15,SVCROUT
         SVC   250
         LTR   R15,R15                    RETURNCODE = 0 ?
         BZ    OBTAIN                     IF YES, LOOK FOR DSCB1
PUTMSG12 EQU   *
         CVD   R15,DOPPELW                CONVERT RC TO DECIMAL
         UNPK  RC,DOPPELW                 UNPACK RC
         OI    RC+3,X'F0'                 MODIFY SIGN
         MVC   WTO(LMSG12),MSG12          MOVE MESSAGE SKELETON
         MVC   WTO+24(2),RC+2             MOVE RC TO MSG
         LA    R4,S99RB                   LOAD ADDR. OF REQUEST BLOCK
         UNPK  DOPPELW,4(3,R4)            UNPACK ERROR REASON CODE
         TR    DOPPELW+3(4),TRTAB         TRANSLATE  RIGHT PORTION
         MVC   WTO+40(4),DOPPELW+3        MOVE ERROR REASON CODE TO MSG
         UNPK  DOPPELW,6(3,R4)            UNPACK INFORMATIONAL CODE
         TR    DOPPELW+3(4),TRTAB         TRANSLATE RIGHT PORTION
         MVC   WTO+31(4),DOPPELW+3        MOVE INF. CODE TO MSG
         L     R0,REG4                    MOVE UCM-ID.
         LA    R1,WTO
         BAL   R14,WTOROUT
         B     RETURN                     BRANCH TO RETURN
SVCROUT  EQU   *
         SVC   99
         SVC   3
*
*    LOOK FOR DSCB1
*
OBTAIN   EQU   *
         MVC   DSCB(16),DSCBX             MOVE CAMLIST SKELETON
         LA    R2,DSNAME                  LOAD ADDR. OF DSNAME
         ST    R2,DSCB+4                  STORE ADDR. TO DSCB
         LA    R2,LOCAREA+6               LOAD ADDR. OF VOLSER
         ST    R2,DSCB+8                  STORE ADDR. TO DSCB
         LA    R2,DSCBAREA                LOAD ADDR. OF AREA
         ST    R2,DSCB+12                 STORE ADDR. TO DSCB
         OBTAIN DSCB                      LOOK FOR DSCB1
         LTR   R15,R15                    RETURNCODE = 0 ?
         BZ    OPEN                       IF YES, BRANCH TO OPEN DATAS.
PUTMSG16 EQU   *
         MVC   WTO(LMSG16),MSG16          MOVE MESSAGE SKELETON
         MVC   WTO+29(44),DSNAME          MOVE DSN TO MSG
         CVD   R15,DOPPELW                CONVERT RC TO DECIMAL
         UNPK  RC,DOPPELW                 UNPACK RC
         OI    RC+3,X'F0'                 MODIFY SIGN
         MVC   WTO+22(2),RC+2             MOVE RC TO MSG
         L     R0,REG4                    MOVE UCM-ID.
         LA    R1,WTO
         BAL   R14,WTOROUT
         B     RETURN
*
*   OPEN DATASET
*
OPEN     EQU   *
         MVC   DCB(DCBLEN),DCBX           MOVE DCB SKELETON
         MVC   DCB+40(8),S99TUPA5         MOVE DDNAME TO DCB
         LA    R4,DCB                     LOAD ADDRESS OF DCB
         ST    R4,DCBADDR                 STORE ADDRESS
         LA    R1,DCBADDR                 LOAD ADDR. OF DCBADDR.
         MVI   0(R1),X'8F'                SET INDICATOR
         SVC   19                         OPEN
         TM    DCB+48,X'10'               OPEN OK ?
         BO    STOW                       IF YES, BRANCH TO DEL. MEMBER
PUTMSG13 EQU   *
         MVC   WTO(LMSG13),MSG13          MOVE MESSAGE SKELETON
         MVC   WTO+28(44),DSNAME          MOVE DSN TO MSG
         L     R0,REG4                    MOVE UCM-ID.
         LA    R1,WTO
         BAL   R14,WTOROUT
         B     RETURN                     BRANCH TO RETURN
*
*   RENAME THE MEMBER
*
STOW     EQU   *
         LA    R4,DCB                     LOAD ADDRESS OF DCB
         LA    R6,MEMBER                  LOAD ADDRESS OF  MEMBER
         STOW  (R4),(R6),C                STOW
         LTR   R15,R15                    RETURNCODE = 0 ?
         BNZ   PUTMSG14                   IF NOT, BRANCH TO PUT MSG
         MVC   WTO(LMSG15),MSG15          MOVE MESSAGE SKELETON
         MVC   WTO+35(8),MEMBER           MOVE MEMBER TO MSG
         L     R0,REG4                    MOVE UCM-ID.
         LA    R1,WTO
         BAL   R14,WTOROUT
         LA    R1,DCBADDR                 LOAD ADDRESS  OF DCBADDR
         MVI   0(R1),X'80'                SET INDICATOR
         SVC   20                         CLOSE
         B     RETURN                     BRANCH TO RETURN
PUTMSG14 EQU   *
         MVC   WTO(LMSG14),MSG14          MOVE MESSEAGE SKELETON
         ST    R15,RC                     STORE R15 TO RETURNCODE
         UNPK  DOPPELW,RC+3(2)            UNPACK RC
         TR    DOPPELW+5(2),TRTAB         TRANSLATE RIGHT PORTION
         MVC   WTO+27(2),DOPPELW+5        MOVE RC TO MSG
         ST    R0,RC                      ST R0 TO RETURNCODE
         UNPK  DOPPELW,RC+3(2)            UNPACK RC
         TR    DOPPELW+5(2),TRTAB         TRANSLATE RIGHT PORTION
         MVC   WTO+38(2),DOPPELW+5        MOVE RC TO MSG
         MVC   WTO+45(8),MEMBER           MOVE MEMBERNAME TO MSG
         L     R0,REG4                    MOVE UCM-ID. TO MSG
         LA    R1,WTO
         BAL   R14,WTOROUT
         LA    R1,DCBADDR                 LOAD ADDR. OF DCBADDR.
         MVI   0(R1),X'80'                SET INDICATOR
         SVC   20                         CLOSE
         B     RETURN                     BRANCH TO RETURN
         EJECT
*
*   ERROR PROCESSING.
*
ERROR    EQU   *
         L     R0,REG4
         LA    R1,MSG17
         BAL   R14,WTOROUT
*
*   FREEMAIN WORKAREA AND RETURN
*
RETURN   EQU   *
         XRETURN 0,R
WTOROUT  EQU   *
         ST    R14,SAVER14
         C     R0,=CL4'ROSC'
         BNE   NOROS
         STM   R14,R12,12(R13)                   SAVE ALL REGS IN SA
*
*              NOW WE CAN ADDRESS DUMMYSECTION IN XMON
*
         LH    R0,0(R1)      LOAD LENGTH OF WTO
         SH    R0,=H'4'      DECREMENT BY 4
         STC   R0,3(R1)      INSERT LENGTH TO MESSAGE FOR USE BY ROSCOE
         LA    R0,3(R1)      LOAD MESSAGE ADDRESS
         L     R13,4(R13)    R13 --> SA IN XMON
         ST    R0,76(R13)    STORE IT IN DYN AREA OF XMON = INAREA
         OI    76(R13),X'80' SET HIGHORDER BIT ON
         L     R15,100(R13)  LOAD ROSCOE-CODE <<OUTCODE>>
         LA    R1,76(R13)    LOAD PARAMETER REGISTER
         L     R13,4(R13)    R13 --> SA IN ROSCOE
         L     R14,12(R13)   LOAD RETURNADDRESS
         LM    R2,R12,28(R13)                    LOAD REMAINDER
         BR    R14           RETURN DIRECT TO ROSCOE
NOROS    EQU   *
         CLC   REG4(4),=CL4'TSO'
         BE    TPUT
         WTO   MF=(E,(1))
         L     R14,SAVER14
         BR    R14
TPUT     EQU   *
         MVC   2(2,R1),=H'0'
         STM   R2,R4,SAVPUTL
         L     R2,UPT
         L     R3,ECT
         LR    R4,R1
         PUTLINE PARM=PUTL,UPT=(R2),ECT=(R3),ECB=ECB,                  *
               OUTPUT=((R4),TERM,SINGLE,DATA),MF=(E,IOPL)
         LM    R2,R4,SAVPUTL
         L     R14,SAVER14
         BR    R14
         EJECT
***********************************************************************
*                                                                     *
*        MESSAGE SKELETONS.                                           *
*                                                                     *
***********************************************************************
         SPACE 2
MSG06    WTO   'XREN006 CATALOG FAILURE (LOCATE) RC=99 FOR XXXXXXXXXXXX*
               XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX',MCSFLAG=(REG0),MF=L
LMSG06   EQU   *-MSG06
MSG07    WTO   'XREN007 VOLUME XXXXXX NOT AVAILABLE',MCSFLAG=(REG0),   *
               MF=L
LMSG07   EQU   *-MSG07
MSG11    WTO   'XREN011 DEVICETYPE NOT IN PROGRAMTABLE FOR XXXXXXXXXXXX*
               XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX',MCSFLAG=(REG0),MF=L
LMSG11   EQU   *-MSG11
MSG12    WTO   'XREN012 DYNALLOC RC=99, IC=9999, EC=9999',             *
               MCSFLAG=(REG0),MF=L
LMSG12   EQU   *-MSG12
MSG13    WTO   'XREN013 OPEN FAILED FOR XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX*
               XXXXXXXXXXXXX',MCSFLAG=(REG0),MF=L
LMSG13   EQU   *-MSG13
MSG14    WTO   'XREN014 STOW FAILED RC=99, REASON=99 FOR XXXXXXXX',    *
               MCSFLAG=(REG0),MF=L
LMSG14   EQU   *-MSG14
MSG15    WTO   'XREN015 RENAME  SUCCESSFUL FOR XXXXXXXX',              *
               MCSFLAG=(REG0),MF=L
LMSG15   EQU   *-MSG15
MSG16    WTO   'XREN016 OBTAIN RC=99 FOR XXXXXXXXXXXXXXXXXXXXXXXXXXXXXX*
               XXXXXXXXXXXXX',MCSFLAG=(REG0),MF=L
LMSG16   EQU   *-MSG16
MSG17    WTO   'XREN001 SYNTAX ERROR IN PARMLIST',MF=L,MCSFLAG=REG0
PUTL     PUTLINE MF=L
UPT      DC    F'0'
ECT      DC    F'0'
ECB      DC    F'0'
IOPL     DC    4F'0'
SAVPUTL  DC    3F'0'
         EJECT
***********************************************************************
*                                                                     *
*        DECLARATIONS.                                                *
*                                                                     *
***********************************************************************
         SPACE 2
DEVTAB   DC    X'2009'
         DC    C'3330      '
         DC    X'200A'
         DC    C'3340      '
         DC    X'200B'
         DC    C'3350      '
         DC    X'200D'
         DC    C'3330-11   '
         DC    X'200E'
         DC    C'3380      '
         DC    X'FFFF'
         DC    C'XXXXXXXXXX'
TRTAB    DC    240C'?'
         DC    C'0123456789ABCDEF'
DCBX     DCB   DSORG=PO,MACRF=(W),DDNAME=SYSXXXXX
DCBLEN   EQU   *-DCBX
LOCLISTX CAMLST NAME,0,,0
DSCBX    CAMLST SEARCH,0,0,0
         EJECT
***********************************************************************
*                                                                     *
*        COMMANDS FOR EXECUTE STATEMENTS.                             *
*                                                                     *
***********************************************************************
         SPACE 2
MOVEMEM  MVC   MEMBER(0),1(R3)
MOVEDSN  MVC   DSNAME(0),0(R1)
TRT      TRT   1(0,R5),TRTTAB
MOVEVOL  MVC   VOLSER(0),1(R5)
         EJECT
***********************************************************************
*                                                                     *
*        EQUATES.                                                     *
*                                                                     *
***********************************************************************
         SPACE 2
R0       EQU   0
R00      EQU   0
R1       EQU   1
R01      EQU   1
R2       EQU   2
R02      EQU   2
R3       EQU   3
R03      EQU   3
R4       EQU   4
R04      EQU   4
R5       EQU   5
R05      EQU   5
R6       EQU   6
R06      EQU   6
R7       EQU   7
R07      EQU   7
R8       EQU   8
R08      EQU   8
R9       EQU   9
R09      EQU   9
R10      EQU   10
R11      EQU   11
R12      EQU   12
R13      EQU   13
R14      EQU   14
R15      EQU   15
RBLEN    EQU   20
         EJECT
***********************************************************************
*                                                                     *
*        PARMAREA.                                                    *
*                                                                     *
***********************************************************************
         SPACE 2
         XPARM
         EJECT
***********************************************************************
*                                                                     *
*        WORKAREA.                                                    *
*                                                                     *
***********************************************************************
         SPACE 2
WORK     DSECT
SAVEAREA DS    18F'0'
SAVER14  DS    F
TRTTAB   DS    77C
LPAN     DS    C
         DS    15C
RPAN     DS    C
         DS    13C
KOMMA    DS    C
         DS    148C
         DS    0F
MEMLENG  DS    F
MEMBER   DS    CL16
CATLIST  DS    CL12
DSNAME   DS    CL44
VOLSER   DS    CL6
VOL      DS    C
WTO      DS    34F
REPLY    DS    CL3
DOPPELW  DS    0D
         DS    2F
RC       DS    F
LOCAREA  DS    0D
         DS    265C
LOCLIST  DS    0F
         DS    CL16
DCB      DS    CL96
DYNAREA  DS    0F
S99RBPTR DS    F
S99RB    DS    0F
S99RBLN  DS    CL1
S99VERB  DS    CL1
S99FLG11 DS    CL1
S99FLG12 DS    CL1
S99ERROR DS    H
S99INFO  DS    H
S99TXTPP DS    F
S99RSV01 DS    F
S99FLG21 DS    CL1
S99FLG22 DS    CL1
S99FLG23 DS    CL1
S99FLG24 DS    CL1
S99TUPT1 DS    F
S99TUPT2 DS    F
S99TUPT3 DS    F
S99TUPT4 DS    F
S99TUPT5 DS    F
S99TUPT6 DS    F
S99TUPT7 DS    F
S99TUPT8 DS    F
S99TUKE1 DS    H
S99TUNU1 DS    H
S99TULN1 DS    H
S99TUPA1 DS    CL1
S99TUKE2 DS    H
S99TUNU2 DS    H
S99TULN2 DS    H
S99TUPA2 DS    CL1
S99TUKE3 DS    H
S99TUNU3 DS    H
S99TULN3 DS    H
S99TUPA3 DS    CL1
S99TUKE4 DS    H
S99TUNU4 DS    H
S99TUKE5 DS    H
S99TUNU5 DS    H
S99TULN5 DS    H
S99TUPA5 DS    CL8
S99TUKE6 DS    H
S99TUNU6 DS    H
S99TULN6 DS    H
S99TUPA6 DS    CL44
S99TUKE7 DS    H
S99TUNU7 DS    H
S99TULN7 DS    H
S99TUPA7 DS    CL6
S99TUKE8 DS    H
S99TUNU8 DS    H
S99TULN8 DS    H
S99TUPA8 DS    CL8
DCBADDR  DS    F
DSCB     DS    CL16
DSCBAREA DS    CL140
WORKLEN  EQU   *-WORK
         SPACE 3
         END
./ ADD NAME=RENAM
LUXRENAM START
         REG
         XSAVE R12,,LUXRENAM,WORKL
         LR    R11,R1
         USING WORK,R13
         USING PARMAREA,R11
         MVC   UNCLIST,UNCLISTS
         LA    R2,DSNAME
         ST    R2,UNCLIST+4
         LA    R2,NEWNAME
         ST    R2,UNCLIST+8
         LA    R2,VOLNO
         ST    R2,UNCLIST+12
         MVC   SEQNO,=C'0001'
         MVI   NEWNAME,X'40'
         MVC   NEWNAME+1(43),NEWNAME
         MVI   DSNAME,C' '
         MVC   DSNAME+1(43),DSNAME
         MVI   UNIT,C' '
         MVC   UNIT+1(5),UNIT
         OC    TEXT,BLNKS
         XC    VOLNO,VOLNO
         LA    R8,TEXT+6
         LA    R3,100
         LR    R4,R8
         LA    R5,100(R8)
DSN1     EQU   *
         CLC   0(2,R4),=CL2'D='
         BNE   DSN3
         LA    R4,2(R4)
         B     DSN5
DSN3     EQU   *
         LA    R4,1(R4)
         BCT   R3,DSN1
         MVC   WTO,MESS1
GIVEWTO  EQU   *
         L     R0,REG4
         BAL   R14,WTOROUT
         B     RETURN
DSN5     EQU   *
         LR    R7,R5
         SR    R7,R4
         EX    R7,TCOMMA
         BNZ   DSN6
         LA    R1,1(R5)
DSN6     EQU   *
         SR    R1,R4
         BCTR  R1,0
         LTR   R1,R1
         BNM   DSN8
DELERROR EQU   *
         MVC   WTO,MESS2
         B     GIVEWTO
DSN8     EQU   *
         EX    R1,MOVEDSN
         LR    R4,R8
         LA    R3,100
NEW1     EQU   *
         CLC   0(2,R4),=CL2'N='
         BNE   NEW3
         LA    R4,2(R4)
         B     NEW5
NEW3     EQU   *
         LA    R4,1(R4)
         BCT   R3,NEW1
         MVC   WTO,MESS1
         MVC   WTO+40(2),=CL2'N='
         B     GIVEWTO
NEW5     EQU   *
         LR    R7,R5
         SR    R7,R4
         EX    R7,TCOMMA
         BNZ   NEW6
         LA    R1,1(R5)
NEW6     EQU   *
         SR    R1,R4
         BCTR  R1,0
         LTR   R1,R1
         BM    DELERROR
         EX    R1,MOVENEW
         LR    R4,R8
         LA    R3,100
UNIT1    EQU   *
         CLC   0(2,R4),=CL2'U='
         BE    UNIT2
         LA    R4,1(R4)
         BCT   R3,UNIT1
         MVC   WTO,MESS1
         MVC   WTO+40(2),=CL2'U='
         B     GIVEWTO
UNIT2    EQU   *
         LA    R4,2(R4)
         LR    R7,R5
         SR    R7,R4
         EX    R7,TCOMMA
         BNZ   UNIT5
         LA    R1,1(R5)
UNIT5    EQU   *
         SR    R1,R4
         BCTR  R1,0
         LTR   R1,R1
         BM    DELERROR
         EX    R1,MOVEUNT
         CLC   UNIT(2),=CL2'24'
         BE    XXX
         CLC   UNIT(2),=CL2'34'
         BE    XXX
         CLC   UNIT(4),=C'TAPE'
         BNE   SEQ7
XXX      EQU   *
         LR    R4,R8
         LA    R3,100
SEQ1     EQU   *
         CLC   0(2,R4),=CL2'S='
         BE    SEQ2
         LA    R4,1(R4)
         BCT   R3,SEQ1
         B     VOL1
SEQ7     EQU   *
         MVI   SEQNO+3,C'0'
         B     VOL1
SEQ2     EQU   *
         LA    R4,2(R4)
         LR    R7,R5
         SR    R7,R4
         EX    R7,TCOMMA
         BNZ   SEQ5
         LA    R1,1(R5)
SEQ5     EQU   *
         SR    R1,R4
         BCTR  R1,0
         LTR   R1,R1
         BM    DELERROR
         EX    R1,TNUM
         BZ    SEQ6
         MVC   WTO,MESS1
         MVC   WTO+40(2),=CL2'S='
         B     GIVEWTO
SEQ6     EQU   *
         LA    R9,SEQNO+3
         SR    R9,R1
         EX    R1,MOVESEQ
VOL1     EQU   *
         LR    R4,R8
         LA    R3,100
VOL2     EQU   *
         CLC   0(2,R4),=CL2'V='
         BE    VOL3
         LA    R4,1(R4)
         BCT   R3,VOL2
         MVC   WTO,MESS1
         MVC   WTO+40(2),=CL2'V='
         B     GIVEWTO
VOL3     EQU   *
         LA    R4,2(R4)
         LA    R8,DEVTAB
         LA    R6,11
         LA    R7,DEVEND-11
VOL6     EQU   *
         CLC   4(6,R8),UNIT
         BE    VOL7
         BXLE  R8,R6,VOL6
         MVC   WTO,MESS3
         B     GIVEWTO
VOL7     EQU   *
         LH    R2,VOLNO
         LA    R9,VOLIST
         LA    R3,VOLIST+240
         CLI   0(R4),C'('
         BE    VOL11
         LR    R7,R5
         SR    R7,R4
         ST    R2,ALIST
         EX    R7,TCOMMA
         L     R2,ALIST
         BNZ   VOL8
         LA    R1,1(R5)
VOL8     EQU   *
         SR    R1,R4
         CH    R1,=H'6'
         BNH   VOL9
         MVC   WTO,MESS4
         B     GIVEWTO
VOL9     EQU   *
         MVC   0(4,R9),0(R8)
         BCTR  R1,0
         MVI   4(R9),X'40'
         MVC   5(5,R9),4(R9)
         EX    R1,MOVESER
         CH    R1,=H'5'
         BNE   NOMNT
         CLC   UNIT(5),=CL5'3330V'
         BNE   NOMNT
         LA    R1,4(R9)
         CALL  MSSMNT,((R1)),VL
NOMNT    EQU   *
         PACK  D,SEQNO
         CVB   R1,D
         STH   R1,10(R9)
         LA    R2,1(R2)
VOL10    EQU   *
         STH   R2,VOLNO
         B     ENDRT2
VOL11    EQU   *
         PACK  D,SEQNO
         CVB   R1,D
VOL12    EQU   *
         LA    R4,1(R4)
         STM   R1,R2,WTO
         LR    R7,R5
         SR    R7,R4
         EX    R7,TKLAM
         BZ    DELERROR
         SR    R1,R4
         LR    R6,R1
         LM    R1,R2,WTO
         BCTR  R6,0
         MVI   4(R9),X'40'
         MVC   5(5,R9),4(R9)
         EX    R6,MOVESER
         MVC   0(4,R9),0(R8)
         LA    R4,1(R6,R4)
         STH   R1,10(R9)
         LA    R2,1(R2)
         CLI   0(R4),C')'
         BE    VOL10
         LA    R9,12(R9)
         CR    R9,R3
         BL    VOL12
         MVC   WTO,MESS5
         B     GIVEWTO
ENDRT2   EQU   *
         SR    R0,R0
         RENAME UNCLIST
         LH    R5,VOLNO
         LA    R6,VOLIST
         LA    R7,12
TEST2    EQU   *
         SR    R10,R10
         IC    R10,11(R6)
         SLL   R10,2
         LA    R9,ERRTAB
         AR    R10,R9
         L     R9,0(R10)
         MVC   WTO,0(R9)
         L     R0,REG4
         BAL   R14,WTOROUT
         AR    R6,R7
         BCT   R5,TEST2
RETURN   EQU   *
         XRETURN 0,R
WTOROUT  EQU   *
         ST    R14,SAVE14
         LA    R1,WTO
         C     R0,=CL4'ROSC'
         BNE   NOROS
         STM   R14,R12,12(R13)                   SAVE ALL REGS IN SA
*
*              NOW WE CAN ADDRESS DUMMYSECTION IN XMON
*
         LH    R0,0(R1)      LOAD LENGTH OF WTO
         SH    R0,=H'4'      DECREMENT BY 4
         STC   R0,3(R1)      INSERT LENGTH TO MESSAGE FOR USE BY ROSCOE
         LA    R0,3(R1)      LOAD MESSAGE ADDRESS
         L     R13,4(R13)    R13 --> SA IN XMON
         ST    R0,76(R13)    STORE IT IN DYN AREA OF XMON = INAREA
         OI    76(R13),X'80' SET HIGHORDER BIT ON
         L     R15,100(R13)  LOAD ROSCOE-CODE <<OUTCODE>>
         LA    R1,76(R13)    LOAD PARAMETER REGISTER
         L     R13,4(R13)    R13 --> SA IN ROSCOE
         L     R14,12(R13)   LOAD RETURNADDRESS
         LM    R2,R12,28(R13)                    LOAD REMAINDER
         BR    R14           RETURN DIRECT TO ROSCOE
NOROS    EQU   *
         C     R0,=CL4'TSO'
         BNE   DOWTO
         LH    R0,WTO
         SH    R0,=H'4'
         LA    R1,WTO+4
         SVC   93             *** TPUT ****
         L     R14,SAVE14
         BR    R14
DOWTO    EQU   *
         WTO   MF=(E,WTO)
         L     R14,SAVE14
         BR    R14
ERRTAB   DS    0F
         DC    A(MESS6)
         DC    A(MESS7)
         DC    A(0)
         DC    A(MESS8)
         DC    A(MESS9)
         DC    A(MESS10)
         DC    A(MESS10)
         DC    A(MESS11)
UNCLISTS CAMLST RENAME,ERRTAB,ERRTAB,ERRTAB
BLNKS    DC    CL124' '
TKLAM    TRT   0(0,R4),TTAB
TTAB     DC    93X'00',X'FF',13X'00',X'FF',148X'00'
TCOMMA   TRT   0(0,R4),TRTTAB
TRTTAB   DC    64X'00',X'FF',42X'00',X'FF',148X'00'
MOVEDSN  MVC   DSNAME(0),0(R4)
MOVEUNT  MVC   UNIT(0),0(R4)
TNUM     TRT   0(0,R4),NUMTAB
NUMTAB   DC    240X'FF',10X'00',6X'FF'
MOVESEQ  MVC   0(0,R9),0(R4)
MOVESER  MVC   4(0,R9),0(R4)
MOVENEW  MVC   NEWNAME(0),0(R4)
DEVTAB   DC    X'30502009'
         DC    C'3330  4'
         DC    X'3050200B'
         DC    C'3350  4'
         DC    X'3010200E'
         DC    C'3380  4'
         DC    X'30582009'
         DC    C'3330V 5'
         DC    X'3050200D'
         DC    C'3330-16'
DEVEND   EQU   *
MESS1    WTO   'XRENAM0 INVALID OR MISSING KEYWORD: D=.',MCSFLAG=REG0, *
               MF=L
MESS2    WTO   'XRENAM1 DELIMITER ERROR',MCSFLAG=REG0,MF=L
MESS3    WTO   'XRENAM2 INVALID UNIT NAME',MCSFLAG=REG0,MF=L
MESS4    WTO   'XRENAM3 INVALID VOLSER',MCSFLAG=REG0,MF=L
MESS5    WTO   'XRENAM4 MORE THAN 20 VOLSERS',MCSFLAG=REG0,MF=L
MESS6    WTO   'XRENAM5 THE SPECIFIED DATA SET HAS BEEN RENAMED',MF=L, *
               MCSFLAG=REG0
MESS7    WTO   'XRENAM5 DSCB NOT FOUND',MF=L,MCSFLAG=REG0
MESS8    WTO   'XRENAM5 DUPLICATE DSNAME IN VTOC',MF=L,MCSFLAG=REG0
MESS9    WTO   'XRENAM5 PERM. I/O ERROR',MF=L,MCSFLAG=REG0
MESS10   WTO   'XRENAM5 UNABLE TO MOUNT VOLUME',MF=L,MCSFLAG=REG0
MESS11   WTO   'XRENAM5 DATASET NOT RENAMED BECAUSE IT IS OPEN',       *
               MF=L,MCSFLAG=REG0
         DS    CL108
         LTORG
         XPARM
WORK     DSECT
SVA      DS    18F
SAVE14   DS    F
WTO      DS    CL108
         DS    0F
UNCLIST  DS    CL16
DSNAME   DS    CL44
NEWNAME  DS    CL44
         CNOP  2,4
VOLNO    DS    H
VOLIST   DS    20CL12
SEQNO    DS    CL4
UNIT     DS    CL6
D        DS    D
ALIST    DS    F
WORKL    EQU   *-WORK
         END
./ ADD NAME=RLSALL
RLSALL   START
         XSAVE R12,SVA,RLSALL
         REG
         LR    R11,R1
         USING PARMAREA,R11
         CLC   REG4(4),=CL4'TSO'
         BNE   TSOOK
         TPUT  TSOMSG,70
RETURN   XRETURN 0
TSOOK    EQU   *
         GETMAIN R,LV=96028
         LR    R2,R1
         LR    R4,R1
         LINK  EP=JES2JOBQ
         L     R3,=F'6000'   # OF JOBS
         LA    R2,28(R2)  SKIP FIRST PART=QSE'S
$DJLP    EQU   *
         LR    R5,R2            SAVE JOB ELEMENT ADDR
         CLC   =C'INIT',4(R2)   IS THIS AN INITIATOR?
         BE    $DJNXT
         CLI   14(R2),C'*'
         BE    $DJNXT
         CLI   14(R2),C'$'
         BE    $DJNXT
         CLI   14(R2),C'U'
         BE    $DJNXT
         CLI   15(R2),X'81'
         BNE   $DJNXT
         TRT   10(2,R2),TABSOND
         BNZ   $DJNXT
         CLI   14(R2),C'C'
         BE    GIVECMD
         CLI   14(R2),C'D'
         BE    GIVECMD
         CLI   14(R2),C'E'
         BE    GIVECMD
         CLI   14(R2),C'G'
         BE    GIVECMD
         CLI   14(R2),C'H'
         BE    GIVECMD
         CLI   14(R2),C'N'
         BE    GIVECMD
         CLI   14(R4),C'Y'
         BE    GIVECMD
$DJNXT   EQU   *
         LA    R2,16(R5)
         OC    0(16,R2),0(R2)
         BZ    $DJDN
         BCT   R3,$DJLP
$DJDN    EQU   *
         FREEMAIN R,LV=96028,A=(R4)
         B     RETURN
GIVECMD  EQU   *
         MVC   JOBNAME(4),0(R2)
         MVC   CMD,=C' $AJ'
         LA    R1,LL
         SR    R0,R0
         SVC   249
         B     $DJNXT
LL       DS    0F
         DC    H'17,0'
CMD      DC    CL4' $AJ'
JOBNAME  DC    CL8' '
         DC    CL4' '
TSOMSG   DC    CL70'XRLSALL NOT SUPPORTED IN TSO'
TABSOND  DC    256XL1'00'
         ORG   TABSOND+C'@'
         DC    X'FF'
         ORG   TABSOND+C'#'
         DC    X'FF'
         ORG   TABSOND+C'$'
         DC    X'FF'
         ORG
         XPARM
         END
./ ADD NAME=RQE
         TITLE 'XRQE                                 X-COMMAND RQE'
RQE      CSECT
RQE      AMODE 31
RQE      RMODE 24
         SPACE 2
***********************************************************************
*                                                                     *
*      IDENTIFICATION DIVISION.                                       *
*                                                                     *
*      PROGRAM-ID. RQE.                                               *
*      AUTHOR. EHNERT.                                                *
*      INSTALLATION. BAYER AG, LEVERKUSEN, RECHENZENTRUM.             *
*      DATE-WRITTEN. 15.3.74.                                         *
*      REMARKS.                                                       *
*          DAS X-COMMAND RQE GIBT INFORMATIONEN AUS DER EIN-/AUS-    *
*          GABE-WARTESCHLANGE BEZUEGLICH DER DURCH PARAMETER SPEZI-   *
*          FIZIERTTEN DEVICES AUS.                                    *
*              ES GELTEN FOLGENDE PARAMETER:                          *
*          A) ALL = ALLE DEVICES                                      *
*          B) UR = UNIT-RECORD DEVICES                                *
*          C) TAPE = TAPE DEVICES                                     *
*          D) DASD = DIRECT-ACCESS DEVICES                            *
*          E) TP = TELEPROCESSING DEVICES                             *
*          F) GRAPHIC = GRAPHIC DEVICES                               *
*          G) 'TEST' : WIRD DIESER PARAMETER ANGEGEBEN, SO WERDEN     *
*          FEHLERMELDUNGEN BEZUEGLICH DER GANZEN RQE-KETTE AUSGEGE-   *
*          BEN, DIE STANDARDMAESSIG IMMER UNTERDRUECKT WERDEN.        *
*              WERDEN KEINE PARAMETER ANGEGEBEN, SO GELTEN STANDARD-  *
*          MAESSIG DIE PARAMETER 'UR', 'TAPE', 'DASD'.                *
*                                                                     *
***********************************************************************
         EJECT
***********************************************************************
*                                                                     *
*      PROCEDURE DIVISION.                                            *
*                                                                     *
***********************************************************************
         SPACE 3
*
*      REGISTER SICHERN UND SPEICHERPLATZANFORDERUNG FUER
*      ARBEITSBEREICHE.
*
         SPACE 2
         XSAVE R12,,TESTRQE,ABERL
         SPACE 3
         LA    R15,SUPV
         LR    R0,R12
         SVC   250
         XRETURN 0,R
SUPV     EQU   *
         LR    R12,R0
*
*      REGISTERZUORDNUNGEN.
*
         SPACE 2
         USING ABER,R13      R13 ALS BASISREG. FUER ARBEITSBEREICHE
         LR    R11,R1        ADRESSE DES PARAMETERBEREICHS LADEN
         USING PARMAREA,R11  R11 ALS BASISREG. FUER PARAMETERBEREICHE
         SR    R3,R3         R3 LOESCHEN
         EJECT
***********************************************************************
*                                                                     *
*      VERARBEITUNG DER PARAMETERKETTE.                               *
*                                                                     *
***********************************************************************
         SPACE 3
         MVC   ABERTAB,DEVTAB DEVICE-TABELLE UEBERTRAGEN
         SR    R2,R2         R2 LOESCHEN
         LA    R5,5          R5 INITIALISIEREN
         LA    R8,TEXT+3     ADRESSE DER PARAMETERKETTE LADEN
         LA    R4,124        LAENGE DER PARAMETERKETTE LADEN
         CLI   0(R8),C','    FOLGEN PARAMETER ?
         BNE   DEFAULT       NEIN, VERZW ZUR DEFAULT-EINTRAGUNG
         SPACE 3
*
*      AUFSUCHEN DER EINZELPARAMETER.
*
         SPACE 2
PARMSCHL EQU   *
         LA    R8,1(R8)      R8 ZEIGT AUF DEN PARAMETER
         LR    R6,R8         ADRESSE DES PARAMETERS UMLADEN
         SR    R9,R9         R9 LOESCHEN
         LA    R5,1(R5)      R5 ERHOEHEN
         SPACE 1
ABFRAGE  EQU   *
         CLI   0(R6),C','    FOLGT NAECHSTER PARAMETER ?
         BE    AUSG          JA, VERZWEIGEN
         CLI   0(R6),X'00'   ENDE DER PARAMETERKETTE ERREICHT ?
         BE    AUSG          JA, VERZWEIGEN
         CLI   0(R6),C' '    ENDE DER PARAMETERKETTE ERREICHT ?
         BE    AUSG          JA, VERZWEIGEN
         LA    R9,1(R9)      R9 ERHOEHEN
         CH    R9,=H'08'     PARAMETERLAENGE GUELTIG ?
         BH    FEHLPARM      NEIN, VERZW. ZUR FEHLERROUTINE
         SPACE 1
         LA    R5,1(R5)      R5 ERHOEHEN
         CR    R5,R4         ENDE DER PARAMETERKETTE ERREICHT ?
         BH    AUSG          JA, VERZWEIGEN
         LA    R6,1(R6)      R6 ERHOEHEN
         B     ABFRAGE       VERZWEIGEN ZUR ABFRAGE
         EJECT
*
*      ABFRAGE DER EINZELPARAMETER.
*
         SPACE 2
AUSG     EQU   *
         MVC   ZWISPEI(8),=CL8' ' ZWISCHENSPEICHER LOESCHEN
         SH    R9,=H'01'
         STC   R9,UEBERTR+1  LAENGENANGABE MODIFIZIEREN
         SPACE 1
UEBERTR  EQU   *
         MVC   ZWISPEI,0(R8) PARAMETER UEBERTRAGEN
         CLC   ZWISPEI(8),=CL8'TEST' PARAMETER = TEST ?
         BNE   SUCHALL       NEIN, VERZWEIGEN ZU WEITEREN ABFRAGEN
         LH    R2,=H'08'     R2 INITIALISIEREN
         B     ENDPARM       VERZW. ZUM ENDE DER ROUTINE
         SPACE 3
*
*      ROUTINE BEI PARAMETER = 'ALL'.
*
         SPACE 2
SUCHALL  EQU   *
         LA    R7,ABERTAB-10 ADRESSE DER TABELLE LADEN
         CLC   ZWISPEI(8),=CL8'ALL' ALLE DEVICE-KLASSEN ?
         BNE   TABSCHL       NEIN, VERZW. ZU WEITEREN ABFRAGEN
         SPACE 1
ALLSCHL  EQU   *
         LA    R7,10(R7)     R7 UM DIE LAENGE EINES ELEMENTS ERHOEHEN
         CLI   0(R7),X'FF'   TABELLENENDE ERREICHT ?
         BE    ENDPARM       JA, VERZW. ZUM ENDE DER PARM.-VERARB.
         SPACE 1
         OI    0(R7),X'80'   BIT SETZEN
         B     ALLSCHL
         SPACE 3
*
*      ROUTINE FUER EINZELPARAMETER.
*
         SPACE 2
TABSCHL  EQU   *
         LA    R7,10(R7)     R7 UM DIE LAENGE EINES ELEMENTS ERHOEHEN
         CLI   0(R7),X'FF'   PARAMETER GUELTIG ?
         BE    FEHLPARM      NEIN, VERZW. ZUR FEHLERROUTINE
         SPACE 1
         CLC   ZWISPEI(8),2(R7) PARAMETER = TABELLENELEMENT ?
         BNE   TABSCHL       NEIN, VERZWEIGEN
         OI    0(R7),X'80'   JA, BIT SETZEN
         EJECT
*
*      ABSCHLUSS DER ROUTINE.
*
         SPACE 2
ENDPARM  EQU   *
         LR    R8,R6         R8 NEU INITIALISIEREN
         CLI   0(R8),C','    FOLGT NOCH EIN PARAMETER ?
         BE    PARMSCHL      JA, VERZWEIGEN
         B     SUCHRQE       VERZW. ZUM AUFSUCHEN DER RQE-TABELLE
         SPACE 3
*
*      DEFAULT-EINTRAGUNGEN.
*
         SPACE 2
DEFAULT  EQU   *
         OI    ABERTAB,X'80'    BIT SETZEN BEI 'TAPE'
         OI    ABERTAB+10,X'80' BIT SETZEN BEI 'DASD'
         OI    ABERTAB+20,X'80' BIT SETZEN BEI 'UR'
         EJECT
***********************************************************************
*                                                                     *
*      RQE-VERARBEITUNG.                                              *
*                                                                     *
***********************************************************************
         SPACE 3
*
*      AUFSUCHEN DER RQE-TABELLE.
*
         SPACE 2
SUCHRQE  EQU   *
         XC    CURRUCB,CURRUCB
         XC    WTOUCB,WTOUCB
         L     R10,16        ADRESSE DER CVT LADEN
         TM    116(R10),X'80' SYSTEM = XA  ?
         BNO   VSSYSTEM      JA, VERZW. ZUR ROUTINE FUER VS2,REL2
NEXTUCB  EQU   *
         CLC   CURRUCB,=F'0'
         BE    FIRST
         CLC   CURRUCB,WTOUCB
         BE    FIRST
         L     R15,CURRUCB
         CLI   18(R15),X'20'   DASD?
         BNE   CHKTPE
         SH    R15,=H'15'
         TM    0(R15),X'80'   RESERVED?
         BNO   FIRST
         L     R15,CURRUCB
         MVC   NACHR,MSG4
         MVC   NACHR+19(3),13(R15)
         L     R0,REG4
         LA    R1,NACHR
         BAL   R14,WTOROUT
         MVI   SW1+1,X'F0'
         B     FIRST
CHKTPE   EQU   *
         CLI   18(R15),X'80'     TAPE?
         BNE   FIRST
         TM    3(R15),X'08'    ALLOCATED?
         BNO   FIRST
         TM    6(R15),X'40'    NOT READY?
         BNO   FIRST
         CLC   28(6,R15),=CL6'=STAM='
         BE    FIRST
         MVC   NACHR,MSG5
         MVC   NACHR+20(3),13(R15)   DEVICE ADDR.
         L     R0,REG4
         LA    R1,NACHR
         BAL   R14,WTOROUT
         MVI   SW1+1,X'F0'
         B     FIRST
FIRST    UCBSCAN STATUS=ONLINE
         LTR   R15,R15
         BNZ   ABSCHLUS
         LR    R2,R1         GET UCB-ADDRESS
         CLI   18(R2),X'20'
         BE    PROCUCB
         CLI   18(R2),X'80'
         BE    PROCUCB
         CLI   18(R2),X'08'
         BNE   NEXTUCB
PROCUCB  EQU   *
         ST    R2,CURRUCB
         TM    6(R2),X'0E'
         BZ    NEXTUCB
         LR    R3,R2
         SH    R3,=H'4'
         L     R3,0(R3)      GET ADDR. OF IOQ-ELEMENT
         LTR   R3,R3
         BZ    NEXTUCB
CKIOACT  TM    16(R3),X'80'      IOQ ACTIVE?
         BO    IOACT
NEXTIOQ  L     R3,4(R3)
         LTR   R3,R3
         BZ    NEXTUCB
         B     CKIOACT
IOACT    EQU   *
         MVC   NACHR,MSG1
         LH    R1,28(R3)
         BAL   R14,GETJOBN
         LTR   R1,R1
         BZ    NEXTIOQ
         MVC   MSGJOBN,0(R1)
         MVC   MSGUNITN,13(R2)
         ST    R3,IOQAD
         MVC   ZWISPEI(4),IOQAD
         UNPK  ZWISPEI+1(9),ZWISPEI(5)
         TR    ZWISPEI+1(8),CCTAB-240
         MVC   MSGSTEPN+2(8),ZWISPEI+1
         MVC   MSGTEXT,=CL30' '
         TM    6(R2),X'40'
         BNO   CHKRSV
         MVC   MSGTEXT(4),=C'NRDY'
CHKRSV   EQU   *
         CLI   18(R2),X'20'   DASD?
         BNE   WTOXA
         CLC   28(3,R2),=CL3'DSP'
         BE    FIRST
         LR    R14,R2
         SH    R14,=H'15'   POINT TO IOS FLAG-BYTE
         TM    0(R14),X'80'   RESERVE-INDIC.
         BNO   CHKMSS
         MVC   MSGTEXT+5(4),=C'RSVD'
CHKMSS   EQU   *
         TM    37(R2),X'06'
         BNO   WTOXA
         MVC   MSGTEXT+10(4),=C'MSSW'
WTOXA    EQU   *
         L     R0,REG4       NEIN, VERZW.
         LA    R1,NACHR
         BAL   R14,WTOROUT
         ST    R2,WTOUCB
         MVI   SW1+1,X'F0'
         B     NEXTIOQ
         EJECT
***********************************************************************
*                                                                     *
*      ROUTINE FUER MVS/370
*                                                                     *
***********************************************************************
         SPACE 3
VSSYSTEM EQU   *
         LA    R2,UCBTAB           ADRESSE UCB-TABELLE
         LA    R0,UCBTABE          ADRESSE UCB TABELLE ENDE
         L     R4,X'7C'(,R10)      ADRESSE I/O COMM. TABLE
         L     R5,X'48'(,R4)       ADRESSE LCH TABLE
         L     R3,X'40'(,R4)       ADRESSE I/O COMM. TABLE EXTENSION
         SR    R6,R6               LOESCHEN R6 FUER IC
         IC    R6,X'05'(,R3)       ANZAHL LCH'S
*
LCHLP    CLC   0(4,R5),=X'FFFFFFFF'  PTR -> IOQE VORHANDEN?
         BE    LCHLPBCT            NEIN - NAECHSTER LCH
*
         LM    R7,R8,0(R5)         ADRESSEN LCHFST, LCHLST LADEN
IOQLP    L     R3,8(,R7)           ADRESSE IOSB
         L     R9,X'10'(,R3)       ADRESSE UCB
         LH    R10,X'06'(,R3)      ASID
*
TABLPA   LA    R1,ABERTAB          ADRESSE DER TABELLE
TABLP    CLI   0(R1),X'FF'         ENDE DER TABELLE?
         BE    TABLPE              JA - NAECHSTES IOQE
         CLI   0(R1),X'80'         GEWUENSCHTE DEVICE-CLASS?
         BNE   TABLPBCT            NEIN - NAECHSTES TAB-ELEMENT
         CLC   18(1,R9),1(R1)      DEV-CLASS (UCB) = DEV-CLASS (TAB)?
         BNE   TABLPBCT            NEIN - NAECHSTES TAB-ELEMENT
         USING UCBTAB,R2
         STM   R9,R10,UCBADDR      UCB-ADRESSE UND ASID SPEICHERN
         ST    R7,IOQAD            IOQ-ADDRESSE SPEICHERN
         LA    R2,UCBNXTEL         ADRESSE SPEICHER ERHOEHEN
         DROP  R2
         CR    R2,R0               ENDE SPEICHER ERREICHT?
         BNL   LCHLPE              JA - AUSGABE EINLEITEN
         B     TABLPE              NAECHSTES IOQE VERARBEITEN
*
TABLPBCT LA    R1,10(,R1)          ADRESSE NAECHSTES TAB-ELEMENT
         B     TABLP               VERZWEIGEN ZUM VERGLEICH
*
IOQLPBCT EQU   *
TABLPE   CR    R7,R8               LETZTES IOQE IN LCH QUEUE?
         BE    LCHLPBCT            JA - NAECHSTEN LCH VERARBEITEN
         L     R7,0(,R7)           ADRESSE NAECHSTES IOQE
         C     R7,=X'FFFFFFFF'     PRUEFEN
         BE    LCHLPBCT                AUF
         LTR   R7,R7                       PLAUSI-
         BZ    LCHLPBCT                        BILITAET
         B     IOQLP               ABARBEITEN DER TAB-ELEMENTE
*
LCHLPBCT LA    R5,32(,R5)          ADRESSE NAECHSTER LCH
         BCT   R6,LCHLP            VERARBEITEN NAECHSTEN LCH
LCHLPE   EQU   *
         LR    R5,R2               ADRESSE LFD. UCB-EL
         LA    R2,UCBTAB           ADRESSE 1. UCB-EL
         USING UCBTAB,R2
         SR    R5,R2               -> ANZAHL UCB-EL * LAENGE
         SR    R4,R4               R4 LOESCHEN FUER DIV
         LA    R0,L'UCBEL          LAENGE EINES UCB-EL
         DR    R4,R0               -> ANZAHL UCB-EL
         LTR   R3,R5               ANZAHL = 0?
         BNP   ABSCHLUS            NEIN - ABSCHLUSS
*
MSGLP    EQU   *
         MVC   NACHR,MSG1         MSG-GERUEST UEBERTRAGEN
         MVC   MSGJOBN,=CL8' '    JOBNAME = BLANKS (FASID)
         LH    R1,ASID            ADRESSE ASID
         BAL   R14,GETJOBN
         LTR   R1,R1
         BZ    XXX1
         MVC   MSGJOBN,0(R1)
         L     R9,UCBADDR         UCB-ADDR LADEN
         MVC   MSGUNITN,13(R9)    UNIT-NAMEN UEBERTRAGEN
         MVC   ZWISPEI(4),IOQAD
         UNPK  ZWISPEI+1(9),ZWISPEI(5)
         TR    ZWISPEI+1(8),CCTAB-240
         MVC   MSGSTEPN+2(8),ZWISPEI+1
         LA    R7,DEVFLAG         ADRESSE DER TABELLE
         LA    R6,4               ZAEHLER
FLGLP    MVC   ZWISPEI(1),6(R9)
         NC    ZWISPEI(1),0(R7)   ENTSPRECHENDES BIT GESETZT?
         BZ    *+10               NEIN -
         MVC   MSGTEXT,1(R7)      JA - TEXT UEBERTRAGEN
         LA    R7,20(,R7)         ADRESSE ERHOEHEN
         BCT   R6,FLGLP           BCT
*
         CLI   18(R9),X'80'       TAPE DEVICE?
         B     NOMOUNT  MOUNT-MSG NOT SUPP. IN MVS/SP REL. 3
         CLC   28(6,R9),=XL6'00'  VOLSER-NR EINGETRAGEN?
         BNE   NOMOUNT            JA -
* MOUNT-MSG SUCHEN
         L     R6,X'10'           R6 = CVTPTR
         L     R6,X'64'(,R6)      R6 = PTR -> UCM-BASE
         L     R1,X'18'(,R6)      R1 = PTR -> FIRST WQE
         LTR   R1,R1              LAST WQE?
         BNP   UCMLPA             JA -
WQELP    CLC   X'A9'(3,R1),36(R9) MSG-ID'S GLEICH?
         BE    MOUNTMSG           JA -
         CLC   X'01'(3,R1),=XL3'00'  LAST WQE?
         BE    UCMLPA             JA -
         L     R1,X'00'(,R1)      ADRESSE NAECHSTES WQE
         B     WQELP
MOUNTMSG MVC   MSGTEXT2-9(13),X'27'(R1)  UEBERTRAGEN MSG-TEXT
         B     NOALTPTH
UCMLPA   L     R8,X'50'(,R6)      ADRESSE LETZTE UCM ENTRY
         L     R4,X'4C'(,R6)      LAENGE EINER UCM ENTRY
         L     R6,X'48'(,R6)      ADRESSE ERSTE UCM ENTRY
UCMLP    CR    R6,R8              VERGLEICHEN MIT ADRESSE LETZTE ENTRY
         BH    NOMOUNT            BEI >: NICHT GEFUNDEN
         L     R7,X'1C'(,R6)      ADRESSE DCM
         LTR   R7,R7              GRAPHICS?
         BZ    UCMLPE             NEIN - NAECHSTER UCM-ENTRY
         L     R7,X'00'(,R7)      ADRESSE PAGEABLE DCM
         LTR   R7,R7              VORHANDEN?
         BZ    UCMLPE             NEIN - NAECHSTER UCM-ENTRY
         LH    R0,X'FE'(,R7)      NUMBER OF LINES IN MSG AREA
         L     R14,X'20'(,R7)     ADDRESS OF FIRST DOM NUMBER
DOMLP    CLC   5(3,R14),36(R9)    MSG-ID'S GLEICH?
         BE    LINEGEF            JA - TEXT AUSGEBEN
         LA    R14,8(,R14)        NAECHSTE DOM-NUMBER
         BCT   R0,DOMLP           BCT
         B     UCMLPE             NAECHSTE UCM-ENTRY
LINEGEF  LH    R15,X'FE'(,R7)     NUMBER OF LINES IN MSG AREA
         SR    R15,R0             -> INDEX DER ZEILE
         MH    R15,X'104'(,R7)    * LAENGE EINER ZEILE
         L     R1,X'30'(,R7)      ADRESSE DER 1. ZEILE
         AR    R1,R15             -> ADRESSE DER MSG
         LA    R0,25              BCT-COUNT
LINELP   CLC   0(2,R1),=C'*I'     TEXT = '*I(EF233A M XXX,)'?
         BE    MSGGEF             JA - RICHTIGE SPALTE ERWISCHT
         LA    R1,1(,R1)          ADRESSE NAECHSTE SPALTE
         BCT   R0,LINELP          BCT
         B     NOMOUNT            TEXT NICHT GEFUNDEN
MSGGEF   MVC   MSGTEXT2-9(13),8(R1)  TEXT UEBERTRAGEN
         B     NOALTPTH           UND AUSGEBEN
UCMLPE   AR    R6,R4              ADRESSE NAECHSTE UCM ENTRY
         B     UCMLP
NOMOUNT  EQU   *
         TM    1(R9),X'01'        ALT PATH VORHANDEN?
         BZ    NOALTPTH           NEIN - TEXT AUSLASSEN
         TM    8(R9),X'C0'        PATH'S CPU 0 VORHANDEN?
         BZ    NOALTPTH           JA - TEXT AUSLASSEN
         MVC   MSGTEXT2,PATHZ     TEXT UEBERTRAGEN
         SR    R8,R8              R8 LOESCHEN FUER IC
         IC    R8,8(,R9)          PATH-BITS HOLEN
         SRL   R8,4               4 NACH RECHTS,
         SLL   R8,2               UND 2 NACH LINKS SHIFTEN
         LA    R8,PATHTAB-4(R8)   ADRESSE DES PATH-TEXTS LADEN
         MVC   MSGTEXT2+5(4),0(R8)  UND UEBERTRAGEN
NOALTPTH L     R0,REG4            KONSOL-ID
         LA    R1,NACHR
         BAL   R14,WTOROUT
         MVI   SW1+1,X'F0'
XXX1     LA    R2,UCBNXTEL        NAECHSTES UCB-EL
         BCT   R5,MSGLP               VERARBEITEN
         DROP  R2
         B     ABSCHLUS           ENDE
*
*      ROUTINE BEI FALSCHEM PARAMETER.
*
         SPACE 2
FEHLPARM EQU   *
         MVC   NACHR,MSG3    NACHRICHT UEBERTRAGEN
         L     R0,REG4       ADRESSE DES BILDSCHIRMS LADEN
         LA    R1,NACHR
         BAL   R14,WTOROUT
         B     ENDE          VERZW. ZUM VERARBEITUNGSENDE
         EJECT
***********************************************************************
*                                                                     *
*      ABSCHLUSS-ROUTINE.                                             *
*                                                                     *
***********************************************************************
         SPACE 3
ABSCHLUS EQU   *
SW1      NOP   END
         L     R0,REG4       ADRESSE DES BILDSCHIRMS LADEN
         MVC   NACHR,MSG2    NACHRICHT UEBERTRAGEN
         LA    R1,NACHR
         BAL   R14,WTOROUT
         B     ENDE          VERZW. ZUM VERARBEITUNGSENDE
         SPACE 1
END      EQU   *
         MVC   NACHR,MSG7    NACHRICHT UEBERTRAGEN
         L     R0,REG4       ADRESSE DES BILDSCHIRMS LADEN
         LA    R1,NACHR
         BAL   R14,WTOROUT
         EJECT
*
*      REGISTER LADEN UND SPEICHERPLATZFREIGABE.
*
         SPACE 2
ENDE     EQU   *
         SVC   3
GETJOBN  EQU   *
         L     R15,16
         L     R15,X'22C'(R15) ADDR. OF ASVT
         L     R6,X'204'(R15)   MAX. NR. OF ASCBS
         LA    R7,X'210'(R15)
NXTASCB  EQU   *
         TM    0(R7),X'80'    ASSIGNED
         BO    NOTASS
         L     R8,0(R7)   GET ASCB
         CH    R1,36(R8)  ASID=?
         BE    ASCBOK
NOTASS   EQU   *
         LA    R7,4(R7)
         BCT   R6,NXTASCB
         SR    R1,R1
         BR    R14
ASCBOK   EQU   *
         L     R1,172(R8)
         LTR   R1,R1
         BNZR  R14
         L     R1,176(R8)
         BR    R14
WTOROUT  EQU   *
         ST    R14,SAVE14
         C     R0,=CL4'ROSC'
         BNE   NOROS
         STM   R14,R12,12(R13)                   SAVE ALL REGS IN SA
*
*              NOW WE CAN ADDRESS DUMMYSECTION IN XMON
*
         LH    R0,0(R1)      LOAD LENGTH OF WTO
         SH    R0,=H'4'      DECREMENT BY 4
         STC   R0,3(R1)      INSERT LENGTH TO MESSAGE FOR USE BY ROSCOE
         LA    R0,3(R1)      LOAD MESSAGE ADDRESS
         L     R13,4(R13)    R13 --> SA IN XMON
         ST    R0,76(R13)    STORE IT IN DYN AREA OF XMON = INAREA
         OI    76(R13),X'80' SET HIGHORDER BIT ON
         L     R15,100(R13)  LOAD ROSCOE-CODE <<OUTCODE>>
         LA    R1,76(R13)    LOAD PARAMETER REGISTER
         L     R13,4(R13)    R13 --> SA IN ROSCOE
         L     R14,12(R13)   LOAD RETURNADDRESS
         LM    R2,R12,28(R13)                    LOAD REMAINDER
         BR    R14           RETURN DIRECT TO ROSCOE
NOROS    EQU   *
         C     R0,=CL4'TSO'
         BNE   DOWTO
         LH    R0,0(R1)
         SH    R0,=H'4'
         LA    R1,4(R1)
         SVC   93             *** TPUT ***
         L     R14,SAVE14
         BR    R14
DOWTO    EQU   *
         WTO   MF=(E,(1))
         L     R14,SAVE14
         BR    R14
         EJECT
***********************************************************************
*                                                                     *
*      DATA DIVISION.                                                 *
*                                                                     *
***********************************************************************
         SPACE 3
*
*      EQUATES.
*
         SPACE 2
R0       EQU   0             ENTHAELT BEI WTO ADRESSE DES BILDSCHIRMS
R1       EQU   1
R2       EQU   2             SCHALTER F. AUSGABE VON FEHLERNACHRICHTEN
R3       EQU   3             ANZEIGE AUF RQE
R4       EQU   4             ZEIGT AUF I/O-DEVICE-STATISTIC-TABLE
R5       EQU   5             INDEXREG.: 0 BEI MVT, 4 BEI VS
R6       EQU   6             INDEX FUER PARAMETERKETTE
R7       EQU   7             TABELLENINDEX
R8       EQU   8             ENTHAELT ADR. DER FEHLERROUTINEN
R9       EQU   9             ZEIGT AUF UCB, BZW. TCB-TIOT
R10      EQU   10            INDEX FUER RQE-TABELLE
R11      EQU   11            BASIS FUER PARAMETERBEREICH
R12      EQU   12            BASISREG. FUER CSECT TESTRQE
R13      EQU   13            BASIS FUER ARBEITSBEREICHE
R14      EQU   14
R15      EQU   15
         EJECT
*
*      TABELLEN.
*
         SPACE 2
CCTAB    DC    C'0123456789ABCDEF'
         SPACE 3
DEVSTATA DS    0CL20
         DC    X'80',CL19'OFFLINE'
         DC    X'02',CL19'SYSRES'
         DC    X'02',CL19'CONSOLE'
         DC    X'10',CL19'UNLOAD PENDING'
         DC    X'40',CL19'OFFLINE PENDING'
DEVFLAG  DS    0CL20
         DC    X'40',CL19'NOT READY'
         DC    X'08',CL19'CONTROL UNIT BUSY '
         DC    X'01',CL19'I/O RECOVERY ACTIVE'
*
         DC    X'04',CL19'DEVICE RESERVED'
         SPACE 3
DEVTAB   DS    0CL10
         DC    X'0080',CL8'TAPE'
         DC    X'0020',CL8'DASD'
         DC    X'0008',CL8'UR'
         DC    X'0040',CL8'TP'
         DC    X'0010',CL8'GRAPHIC'
         DC    X'FFFF',CL8' '
         DC    X'0000',CL8' '
         DC    X'0000',CL8' '
         DC    X'0000',CL8' '
         SPACE 3
PATHZ    DC    CL14'PATH .... INOP'
PATHTAB  DS    0CL4
         DC    C'...1'
         DC    C'..1.'
         DC    C'..11'
         DC    C'.1..'
         DC    C'.1.1'
         DC    C'.11.'
         DC    C'.111'
         DC    C'1...'
         DC    C'1..1'
         DC    C'1.1.'
         DC    C'1.11'
         DC    C'11..'
         DC    C'11.1'
         DC    C'111.'
         DC    C'1111'
         EJECT
*
*      NACHRICHTEN.
*
         SPACE 2
MSG1     WTO   'XRQE001 *UNKNWN* Q=*UNKNWN* ADR=999                    *
                               ',                                      *
               MCSFLAG=(REG0),MF=L
MSG2     WTO   'XRQE002 NO OPEN REQUEST ELEMENTS',                     *
               MCSFLAG=(REG0),MF=L
MSG3     WTO   'XRQE003 ERROR IN PARAMETER LIST',                      *
               MCSFLAG=(REG0),MF=L
MSG4     WTO   'XRQE004 DEVICE CUU IS RESERVED',                       *
               MCSFLAG=(REG0),MF=L
MSG5     WTO   'XRQE005 TAPE AT CUU IS ALLOCATED AND NOT READY',       *
               MCSFLAG=(REG0),MF=L
MSG7     WTO   'XRQE007 END OF OPEN REQUEST ELEMENTS',                 *
               MCSFLAG=(REG0),MF=L
*
*      PARAMETERBEREICH.
*
         SPACE 2
         XPARM
         SPACE 3
*
*      ARBEITSBEREICHE.
*
         SPACE 2
ABER     DSECT
SAVEAREA DS    18F
SAVE14   DS    F
DUMMY    DS    CL8
CURRUCB  DS    F
WTOUCB   DS    F
ZWISPEI  DS    3F            ZWISCHENSPEICHER
NACHR    DS    0CL75         BEREICH FUER NACHRICHTEN
         DS    CL12
MSGJOBN  DS    CL8           JOBNAME
         DS    C
MSGSTEPN DS    CL8           STEPNAME
         DS    CL7
MSGUNITN DS    CL3           UNIT-NAME
         DS    CL2
MSGTEXT  DS    CL19          TEXT UEBER DEVICE-STATUS
         DS    C
MSGTEXT2 DS    CL14
         ORG   NACHR+50
MSGRQE   DS    CL6           RQE-ADRESSE
         ORG   NACHR+49
MSGCLS   DS    CL2
         ORG   NACHR+75
SCH      DS    C             PRUEF- UND SCHREIBSCHALTER
ASIDX    DS    H
ABERTAB  DS    CL90
*
PARMLIST DS    3F            PARAMETER-LISTE FUER FASID
*
UCBTAB   DS    0D            DWB-ALIGN
ANZUCBEL EQU   99
*
UCBEL    DS    0CL12
UCBADDR  DS    F
RESERVE  DS    H
ASID     DS    H
IOQAD    DS    F
*
UCBNXTEL DS    0C
         DS    (ANZUCBEL-1)CL(L'UCBEL)
UCBTABE  EQU   *
*
ABERL    EQU   *-ABER        LAENGE DES ARBEITSBEREICHS
         END   RQE
./ ADD NAME=SHOW
XSHOW    START
         REG
         XSAVE R12,SVA,XSHOW
         USING PARMAREA,R11
         LR    R11,R1
         CLC   REG4(4),=CL4'ROSC'
         BE    LINK
         ATTACH EP=XSHOX,ECB=ECB,SHSPV=78
         ST    R1,TCBADDR
         STIMER REAL,TMEXIT,BINTVL=BINTVL
         WAIT  1,ECBLIST=ECBLIST
         TM    ECB2,X'40'   TIMER ABGELAUFEN ?
         BNO   DETACH
         CLC   REG4(4),=CL4'TSO'
         BNE   WTO
         TPUT  MSG1,60
         B     DETACH
MSG1     DC    CL60'XSHOW00 X-SHOW TERMINATED - TIME LIMIT REACHED'
WTO      EQU   *
         L     R0,REG4
         WTO   'XSHOW00 X-SHOW TERMINATED - TIME LIMIT REACHED',       *
               MCSFLAG=REG0
DETACH   DETACH TCBADDR
RETURN   XRETURN 0
LINK     EQU   *
         LR    R4,R13
         L     R13,4(R13)
         LR    R5,R13
         MVC   SAVE(72),0(R13)
         LINK  EP=XSHOX
         LR    R13,R4
         MVC   0(72,R5),SAVE
         B     RETURN
SAVE     DS    18F
TMEXIT   EQU   *
         XSAVE R10,SVA1,TMEXIT
         POST  ECB2
         XRETURN 0
ECB2     DC    F'0'
         DROP  R10
ECB      DC    F'0'
BINTVL   DC    F'12000'
TCBADDR  DC    F'0'
         DS    0F
ECBLIST  DC    A(ECB)
         DC    X'80'
         DC    AL3(ECB2)
         XPARM
         END
./ ADD NAME=SHOX
         TITLE 'XSHOW                             X-COMMAND SHOW'
SHOW     CSECT
         SPACE 3
***********************************************************************
*                                                                     *
*      PROGRAM-ID. SHOW.                                              *
*      AUTHOR. EHNERT.                                                *
*      INSTALLATION. BAYER AG, LEVERKUSEN, RECHENZENTRUM.             *
*      DATE-WRITTEN. 24. 2. 1975.                                     *
*      REMARKS.                                                       *
*                                                                     *
*          DAS X-COMMAND 'SHOW' GIBT INFORMATIONEN UEBER EINE ALS     *
*          PARAMETER SPEZIFIZIERTE DATEI AUS.                         *
*                                                                     *
*          ZUSAETZLICH KOENNEN FOLGENDE PARAMETER ANGEGEBEN WERDEN:   *
*          A) MSG: ES WERDEN INFORMATIONEN UEBER SPEICHERPLATZANFOR-  *
*             DERUNG UND -BELEGUNG SOWIE UEBER DIE DCB'S DER          *
*             DATEIEN AUSGEGEBEN,                                     *
*          B) EXT: ES WERDEN INFORMATIONEN UEBER DIE EXTENTS DER      *
*             DATEIEN AUSGEGEBEN, DEREN DSNAME ALS PARAMETER ANGE-    *
*             GEBEN WURDE,                                            *
*          C) DATE: ES WERDEN INFORMATIONEN UEBER ERSTELL- UND VER-   *
*             FALLDATUM DER DATEIEN AUSGEGEBEN,                       *
*          D) BIS ZU ZEHN MASKEN FUER DIE VOLUME SERIAL NUMBERS, MIT  *
*             DEREN HILFE EINE AUSWAHL DER VOLUMES GETROFFEN WERDEN   *
*             KANN, DABEI STEHT '*' FUER JEDES ZEICHEN AN DIESER      *
*             STELLE.                                                 *
*                                                                     *
*          WIRD KEINER DER PARAMETER B), C) UND D) ANGEGEBEN,         *
*          SO WIRD STANDARDMAESSIG A) ANGENOMMEN. WERDEN KEINE        *
*          VOLSER-MASKEN SPEZIFIZIERT, SO WERDEN ALLE ONLINE          *
*          LIBRARIES NACH DEN DATEIEN DURCHSUCHT.                     *
*                                                                     *
***********************************************************************
         EJECT
***********************************************************************
*                                                                     *
*      BEGINN DER VERARBEITUNG.                                       *
*                                                                     *
***********************************************************************
         SPACE 3
*
*      SICHERN DER REGISTER,
*      SPEICHERPLATZANFORDERUNG FUER ARBEITSBEREICHE,
*      ZUORDNUNG DER BASISREGISTER.
*
         SPACE 1
         XSAVE (R12,R11),,SHOW,ABERL
         SPACE 1
         USING MESSAGE,R10   BASISREG. FUER DSECT MESSAGE ZUORDNEN
         USING PARMAREA,R3   BASISREG. FUER DSECT PARMAREA ZUORDNEN
         USING ABER,R13      BASISREG. FUER DSECT ABER ZUORDNEN
         EJECT
*
*      INITIALISIERUNG DER SPEICHER.
*
         SPACE 1
         LR    R3,R1        BASISREG. FUER DSECT PARMAREA INITIALIS.
         ST    R3,PARMREG
         MVC   UCMID,REG4    UCM-ID. DES AUFRUFERS UEBERTRAGEN
         MVI   CAMSEEK,X'00' CAMLIST-MACROS
         MVC   CAMSEEK+1(47),CAMSEEK LOESCHEN
         MVI   CAMSEEK,X'C0' FLAG BYTE SETZEN
         MVI   CAMSEEK+1,X'80' FLAG BYTE SETZEN
         MVI   CAMSRCH,X'C1' FLAG BYTE SETZEN
         MVI   CAMNAME,X'44' FLAG BYTE SETZEN
         MVC   FNDBYTE(6),=XL6'0' SCHALTER LOESCHEN
         MVI   VOLBYTE,X'FF'
         LA    R2,CCHHR      ADRESSE DES CCHHR-FELDES LADEN
         LA    R3,VOLSERNO   ADRESSE DER VOLSER NUMBER LADEN
         LA    R4,CAMWKFLD   ADRESSE VON CAMWKFLD LADEN
         STM   R2,R4,CADRCCHH ADRESSEN IN CAMSEEK SPEICHERN
         LA    R2,DSNAME     ADRESSE DES DSNAME LADEN
         STM   R2,R4,CADRDSN ADRESSEN IN CAMSRCH SPEICHERN
         SR    R3,R3         R3 LOESCHEN
         STM   R2,R4,CAMDSN  ADRESSEN IN CAMNAME SPEICHERN
         LA    R2,ENDTAB1    ENDADRESSEN
         LA    R3,ENDTAB2        DER
         LA    R4,ENDTAB3        TABELLEN
         LA    R5,ENDTPVOL       LADEN UND
         STM   R2,R5,ADDRETB1    SPEICHERN
         MVI   TABPVOL1,X'80'
         MVI   TABPVOL2,X'80'
         SPACE 2
*
*      FLAG BYTS IN NACHRICHTENBEREICHEN SETZEN.
*
         SPACE 1
         LA    R2,MSGTAB     ADRESSEN DER
         LA    R3,EXTNTAB        NACHRICHTENTABELLEN
         LA    R4,DATETAB        LADEN UND
         STM   R2,R4,SAVE1R10    SPEICHERN
         L     R3,ADDRETB3   ENDADRESSE DER TABELLEN LADEN
         LR    R10,R2        R10 INITIALISIEREN
CLEARMSS EQU   *
         MVC   MESSFLAG,=X'FFFF' FLAG BYTES SETZEN
         LA    R10,68(R10)   R10 ERHOEHEN
         CR    R10,R3        ENDE DER TABELLEN ERREICHT ?
         BL    CLEARMSS      NEIN, VERZWEIGEN
         EJECT
***********************************************************************
*                                                                     *
*      VERARBEITUNG DER EINGABEPARAMETER.                             *
*                                                                     *
***********************************************************************
         SPACE 3
*
*      VERARBEITUNG DES DATA SET NAME.
*
         SPACE 1
         L     R3,PARMREG
         LA    R4,TEXT+4     R4 INITIALISIEREN
         SR    R5,R5         R5 LOESCHEN
         MVI   DSNAME,C' '   ZWISCHENSPEICHER FUER DEN
         MVC   DSNAME+1(43),DSNAME DATA SET NAME LOESCHEN
         LA    R8,PARMENDE   ENDADRESSE DES PARAMETERBEREICHS LADEN
         CLI   0(R4),C','    PARAMETER ANGEGEBEN ?
         BNE   FEHLPARM      NEIN, VERZW. ZUR FEHLERROUTINE
NXTPNAM  EQU   *
         LA    R4,1(R4)      R4 ERHOEHEN
         CR    R4,R8         PARAMETERBEREICH UEBERSCHRITTEN ?
         BNL   FEHLPARM      JA, VERZW. ZUR FEHLERROUTINE
         CLI   0(R4),C'*'    1. PARAMETER = DATA SET NAME ?
         BE    FEHLPARM      NEIN, VERZW. ZUR FEHLERROUTINE
         CLI   0(R4),C','    ENDE DES DSNAME ERREICHT ?
         BE    ENDPNAM       JA, VERZWEIGEN
         CLI   0(R4),X'00'   ENDE DER PARAMETERKETTE ERREICHT ?
         BE    ENDPNAM       JA, VERZWEIGEN
         CLI   0(R4),C' '    ENDE DER PARAMETERKETTE ERREICHT ?
         BE    ENDPNAM       JA, VERZWEIGEN
         LA    R5,1(R5)      R5 ERHOEHEN
         B     NXTPNAM       VERZWEIGEN
ENDPNAM  EQU   *
         CH    R5,=H'44'     LAENGE DES MEMBER NAME GUELTIG ?
         BH    FEHLPARM      NEIN, VERZW. ZUR FEHLERROUTINE
         LTR   R5,R5         MEMBER NAME ANGEGEBEN ?
         BZ    FEHLPARM      NEIN, VERZW. ZUR FEHLERROUTINE
         BCTR  R5,0          R5 UM EINS VERMINDERN
         EX    R5,MOVEPNAM   VERZW. ZUR UEBERTR. DES DSNAME
         LA    R10,ZEILE     ADRESSE DES ZWISCHENSPEICHERS LADEN
         MVC   ZEILE(LENMSG01),MSG01 NACHRICHTENZEILE UEBERTRAGEN
         MVC   MS1DSN,DSNAME DATA SET NAME UEBERTRAGEN
         EJECT
*
*      VERARBEITUNG DER UEBRIGEN PARAMETER (VOLSER-MASKEN,
*      'MSG', 'EXT' UND 'DATE'.
*
         SPACE 1
         LA    R6,TABPVOL1   ADRESSE DER VOLSER-TABELLE LADEN
NEXTPARM EQU   *
         CLI   0(R4),C','    FOLGEN WEITERE PARAMETER ?
         BNE   ENDPARM       NEIN, VERZWEIGEN
         SR    R5,R5         R5 LOESCHEN
         LR    R7,R4         ADRESSE UMLADEN
NXTBYTE  EQU   *
         LA    R4,1(R4)      R4 ERHOEHEN
         CR    R4,R8         PARAMETERBEREICH UEBERSCHRITTEN ?
         BNL   FEHLPARM      JA, VERZW. ZUR FEHLERROUTINE
         CLI   0(R4),C','    ENDE DES PARAMETERS ERREICHT ?
         BE    ENDNXTPM      JA, VERZWEIGEN
         CLI   0(R4),X'00'   ENDE DER PARAMETERKETTE ERREICHT ?
         BE    ENDNXTPM      JA, VERZWEIGEN
         CLI   0(R4),C' '    ENDE DER PARAMETERKETTE ERREICHT ?
         BE    ENDNXTPM      JA, VERZWEIGEN
         LA    R5,1(R5)      R5 ERHOEHEN
         CLI   0(R4),C'*'    BELIEBIGES ZEICHEN AN DIESER STELLE ?
         BNE   NXTBYTE       NEIN, VERZWEIGEN
         MVI   0(R4),X'FF'   ZEICHEN UMSETZEN
         B     NXTBYTE       VERZWEIGEN
ENDNXTPM EQU   *
         CH    R5,=H'5'      LAENGE DES PARAMETERS < 5 ?
         BNL   NEXTPVOL      NEIN, VERZWEIGEN
         CH    R5,=H'2'      LAENGE DES PARAMETERS > 2 ?
         BNH   NEXTPVOL      NEIN, VERZWEIGEN
         CLC   1(3,R7),=C'MSG' MSG-INFORMATION ANGEFORDERT ?
         BNE   *+12          NEIN, VERZWEIGEN
         MVI   MSGBYTE,X'FF' FLAG BYTE SETZEN
         B     NEXTPARM      VERZWEIGEN
         CLC   1(3,R7),=C'EXT' EXTENT-INFORMATION ANGEFORDERT ?
         BNE   *+12
         MVI   EXTBYTE,X'FF' FLAG BYTE SETZEN
         B     NEXTPARM      VERZWEIGEN
         CLC   1(4,R7),=C'DATE' DATE-INFORMATION ANGEFORDERT ?
         BNE   *+12
         MVI   DATEBYTE,X'FF' FLAG BYTE SETZEN
         B     NEXTPARM      VERZWEIGEN
         CLC   1(3,R7),=C'ALL'
         BNE   NOTALL
         MVI   ALLBYTE,X'FF'
         MVI   VOLBYTE,X'00'
         B     NEXTPARM
NOTALL   EQU   *
         EJECT
NEXTPVOL EQU   *
         C     R6,ADDRETPV   TABELLENENDE UEBERSCHRITTEN ?
         BNL   FEHLPARM      JA, VERZWEIGEN
         CH    R5,=H'6'      LAENGE DER VOLID GUELTIG ?
         BH    FEHLPARM      NEIN, VERZW. ZUR FEHLERROUTINE
         LTR   R5,R5         VOLID ANGEGEBEN ?
         BZ    ENDPARM       NEIN, VERZWEIGEN
         BCTR  R5,0          R5 UM EINS VERMINDERN
         EX    R5,MOVEPVOL   VERZW. ZUR UEBERTR. DER VOLSER NUMBER
         LA    R1,1(R6)
         CALL  MSSMNT,((R1)),VL
         MVI   VOLBYTE,X'FF' FLAG BYTE SETZEN
         STC   R5,0(R6)      LAENGENANGABE IN TABELLE EINTRAGEN
         LA    R6,7(R6)      R6 ERHOEHEN
         B     NEXTPARM      VERZWEIGEN
         SPACE 2
*
*      ABSCHLUSS DER PARAMETERVERARBEITUNG.
*
         SPACE 1
         DROP  R3
ENDPARM  EQU   *
         LA    R2,TABPVOL2
         LA    R3,TABPVOL1
         CLC   MSGBYTE(3),=XL6'0' INFORMATION-PARAMETER ANGEGEBEN ?
         BNE   *+8           JA, VERZWEIGEN
         MVI   MSGBYTE,X'FF' FLAG BYTE SETZEN
         CLI   VOLBYTE,X'FF' VOLSER-MASKEN ANGEGEBEN ?
         BNE   LOCATE        NEIN, VERZWEIGEN
         MVI   0(R6),X'80'   TABELLENENDE SPEZIFIZIEREN
         MVC   TABPVOL2,TABPVOL1 VOLSER-TABELLE KOPIEREN
         LR    R3,R6
         LA    R6,TABPVOL2-1 ADRESSE DER TABELLE LADEN
NEXTFF   EQU   *
         LA    R6,1(R6)      R6 ERHOEHEN
         CLI   0(R6),X'80'   TABELLENENDE ERREICHT ?
         BE    LOCATE        JA, VERZWEIGEN
         CLI   0(R6),X'FF'   TABELLENZEICHEN = X'FF' ?
         BNE   NEXTFF        NEIN, VERZWEIGEN
         MVI   0(R6),X'00'   TABELLENZEICHEN UMSETZEN
         B     NEXTFF        VERZWEIGEN
         EJECT
***********************************************************************
*                                                                     *
*      VERARBEITUNG DER CATALOG-INFORMATIONEN.                        *
*                                                                     *
***********************************************************************
         SPACE 3
LOCATE   EQU   *
         LR    R2,R6
         LOCATE CAMNAME      CATALOG LESEN
         LTR   R15,R15       RETURN CODE = 0 ?
         BNZ   FEHLLOC       NEIN, VERZW. ZUR FEHLERROUTINE
         LA    R10,ZEILE
         MVC   MS1DSN,DSNAME
         LA    R10,FEHLTAB   R10 INITIALISIEREN
         MVC   MESSAGE(LENMSG00),MSG00 NACHRICHTENZEILE UEBERTRAGEN
         LH    R5,CAMWKFLD   ANZ. DER VOLUMES LADEN
         LTR   R5,R5
         BNZ   NOTZERO
         L     R0,UCMID
         LA    R1,MSG014
         BAL   R14,WTOROUT
         B     GETUCB
NOTZERO  EQU   *
         LA    R6,CAMWKFLD+6 ADRESSE DER ERSTEN VOLSERNO. LADEN
         LA    R7,20         MAX. ANZ. DER VOLSERNO. LADEN
         CR    R5,R7         ANZ. > MAX. ANZ. ?
         BNH   *+6           NEIN, VERZWEIGEN
         LR    R5,R7         MAX. ANZ. DER VOLSERNO. LADEN
         LA    R7,4          LOOP COUNTER INITIALISIEREN
         CR    R7,R5         LOOP COUNTER > ANZ. DER VOLSERNO. ?
         BNH   *+6           NEIN, VERZWEIGEN
         LR    R7,R5         LOOP COUNTER NEU INITIALISIEREN
         LR    R8,R7         LOOP COUNTER SPEICHERN
         LA    R9,MS0VOL2    ADRESSE IN NACHRICHTENZEILE LADEN
         EJECT
MOVELOOP EQU   *
         CALL  MSSMNT,((R6)),VL
         MVC   0(6,R9),0(R6) VOLSER NUMBER UEBERTRAGEN
         LR    R14,R6
         SH    R14,=H'2'
         CLI   0(R14),X'20'
         BNE   NOMORE
         C     R3,ADDRETPV
         BNL   NOMORE
         MVI   0(R2),X'06'
         MVC   1(6,R2),0(R6)
         MVI   0(R3),X'06'
         MVC   1(6,R3),0(R6)
         LA    R2,7(R2)
         LA    R3,7(R3)
         MVI   0(R2),X'80'
         MVI   0(R3),X'80'
NOMORE   EQU   *
         LA    R9,8(R9)      ADRESSE IN  DER NACHRICHTENZEILE ERHOEHEN
         LA    R6,12(R6)     ADRESSE DER NAECHSTEN VOLSERNO. LADEN
         BCT   R7,MOVELOOP   VERZWEIGEN
         SPACE 1
         CR    R8,R5         SIND ALLE VOLSERNO. UEBERTRAGEN ?
         BL    *+8           NEIN, VERZWEIGEN
         MVI   6(R9),C' '    TRENNUNGSZEICHEN LOESCHEN
         L     R0,UCMID      UCM-ID. DES AUFRUFERS LADEN
         LA    R1,MESSAGE
         BAL   R14,WTOROUT
         CR    R8,R5         SIND ALLE VOLSERNO. UEBERTRAGEN ?
         BNL   GETUCB        JA, VERZWEIGEN
         SR    R5,R8         RK UM ANZ. DER UEBERTR. VOLSERNO. VERMIND.
         LA    R7,7          LOOP COUNTER SETZEN
         CR    R7,R5         LOOP COUNTER > ANZ. OFFENER VOLSERNO. ?
         BNH   *+6           NEIN, VERZWEIGEN
         LR    R7,R5         LOOP COUNTER NEU INITIALISIEREN
         LR    R8,R7         LOOP COUNTER SPEICHERN
         LA    R9,MS0VOL1-2  ADRESSE IN DER NACHRICHTENZEILE LADEN
         MVC   MS0VOL1-2(54),MS0VOL1-3 NACHRICHTENZEILE LOESCHEN
         B     MOVELOOP      VERZWEIGEN
         EJECT
***********************************************************************
*                                                                     *
*      VERARBEITUNG DES UCB-VEKTORS.                                  *
*                                                                     *
***********************************************************************
         SPACE 3
GETUCB   EQU   *
         CLI   CAMWKFLD+4,X'80'
         BNE   NOTAPE
         MVC   MESSAGE(LENMSG15),MSG015
         LH    R14,CAMWKFLD+12
         LTR   R14,R14
         BNZ   *+8
         LA    R14,1
         CVD   R14,DBWORD
         UNPK  MESSAGE+42(3),DBWORD
         OI    MESSAGE+44,X'F0'
         L     R0,UCMID
         LA    R1,MESSAGE
         BAL   R14,WTOROUT
         LA    R10,ZEILE     ADRESSE DES ZWISCHENSPEICHERS LADEN
         MVC   ZEILE(LENMSG01),MSG01 NACHRICHTENZEILE UEBERTRAGEN
         MVC   MS1DSN,DSNAME DATA SET NAME UEBERTRAGEN
         L     R0,UCMID
         LA    R1,ZEILE
         BAL   R14,WTOROUT
NOTAPE   EQU   *
         CLI   VOLBYTE,X'FF'
         BNE   NEXTUCB
         TM    TABPVOL1,X'80'
         BO    ENDE
NEXTUCB  EQU   *
         UCBSCAN DEVTYPE=DASD,STATUS=ONLINE
         LTR   R15,R15
         BNZ   ABSCHLUS
         LR    R3,R1
         USING UCB,R3
         TM    DEVSTAT,X'10' EINHEIT IM UNLOAD ?
         BO    NEXTUCB       JA, VERZWEIGEN
         CLC   UCBVOLI,=XL6'0' VOLID VORHANDEN ?
         BE    NEXTUCB       NEIN, VERZWEIGEN
         CLI   VOLBYTE,X'FF' VOLSER-MASKEN ANGEGEBEN ?
         BE    VERGLSER      JA, VERZWEIGEN
         B     MVCVOLID
VERGLSER EQU   *
         EJECT
*
*      VERGLEICH MIT SPEZIFIZIERTEN VOLSER NUMBERS.
*
         SPACE 1
         SR    R5,R5         R5 LOESCHEN
         LA    R6,TABPVOL1-7 ADRESSE DER VOLSER-TABELLE LADEN
         LA    R7,TABPVOL2-7 ADRESSE DER VOLSER-TABELLE LADEN
NXTVOLID EQU   *
         LA    R6,7(R6)      R6 ERHOEHEN
         LA    R7,7(R7)      R7 ERHOEHEN
         TM    0(R6),X'80'   TABELLENENDE ERREICHT ?
         BO    NEXTUCB       JA, VERZWEIGEN
         IC    R5,0(R6)      LAENGENANGABE LADEN
         MVC   ZWVOLID1,UCBVOLI VOLSER NUMBER UEBERTRAGEN
         MVC   ZWVOLID2,UCBVOLI VOLSER NUMBER UEBERTRAGEN
         EX    R5,NCVOLID1   VERZW. ZUR UEBERLAGERUNG DER VOLID
         EX    R5,OCVOLID2   VERZW. ZUR UEBERLAGERUNG DER VOLID
         CLC   ZWVOLID1,ZWVOLID2 VOLID = AUSGEW. VOLID ?
         BNE   NXTVOLID      VERZW., WENN VOLID ^= AUSGEW. VOLID
MVCVOLID EQU   *
         MVC   VOLSERNO,UCBVOLI VOLSER NUMBER UEBERTRAGEN
         EJECT
***********************************************************************
*                                                                     *
*      DSCB1 LESEN UND AUSWERTEN.                                     *
*                                                                     *
***********************************************************************
         SPACE 3
         OBTAIN CAMSRCH      DSCB1 DES DATA SET AUFSUCHEN
         CH    R15,=H'8'     DSCB1 DES DATA SET GEFUNDEN ?
         BE    NEXTUCB       NEIN, VERZW. ZUR VERARB. DES NAECHSTEN UCB
         LTR   R15,R15       RC = 0 ?
         BNZ   FEHLOBT       NEIN, VERZWEIGEN
         CLC   DS1CCHHR,=XL6'0' DUMMY DSCB1 ?
         BE    NEXTUCB       JA, VERZWEIGEN
         MVI   FNDBYTE,X'FF' FLAG BYTE SETZEN
         LA    R14,DSCB1MSG  FOLGEADRESSE LADEN
         CLI   DATEBYTE,X'FF' DATE-INFORMATION ANGEFORDERT ?
         BE    DATEINFO      JA, VERZW. ZUR AUFBER. DER DATE-INFORM.
DSCB1MSG EQU   *
         LA    R14,DSCB1EXT  FOLGEADRESSE LADEN
         CLI   MSGBYTE,X'FF' MSG-INFORMATION ANGEFORDERT ?
         BE    MSGINFO       JA, VERZW. ZUR AUFBER. DER MSG-INFORM.
DSCB1EXT EQU   *
         LA    R14,NEXTUCB   FOLGEADRESSE LADEN
         CLI   EXTBYTE,X'FF' EXTENT-INFORMATION ANGEFORDERT ?
         BE    EXTINFO       JA, VERZW. ZUR AUFBER. DER EXTENT-INFORM.
         BR    R14           VERZW. ZUR VERARB. DES NAECHSTEN UCB
         EJECT
***********************************************************************
*                                                                     *
*      ABSCHLUSSROUTINEN.                                             *
*                                                                     *
***********************************************************************
         SPACE 3
ABSCHLUS EQU   *
         CLI   FNDBYTE,X'FF' DATA SET GEFUNDEN ?
         BE    AUSRMSGN      JA, VERZWEIGEN
         L     R0,UCMID      UCM-ID. DES AUFRUFERS LADEN
         LA    R1,ZEILE
         BAL   R14,WTOROUT
         L     R0,UCMID      UCM-ID. DES AUFRUFERS LADEN
         LA    R1,MSG08
         BAL   R14,WTOROUT
         B     ENDE          VERZWEIGEN
         EJECT
*
*      AUSGABE NOCH OFFENER MSG-NACHRICHTEN.
*
         SPACE 1
AUSRMSGN EQU   *
         LA    R10,MSGTAB    ADRESSE DER TABELLE LADEN
         CLC   MESSFLAG,=XL6'0' SIND NOCH NACHRICHTEN OFFEN ?
         BNE   AUSREXTN      NEIN, VERZWEIGEN
         BAL   R14,AUSMSGM   JA, VERZW. ZUR NACHRICHTENAUSGABE
         SPACE 2
*
*      AUSGABE NOCH OFFENER EXTENT-NACHRICHTEN.
*
         SPACE 1
AUSREXTN EQU   *
         LA    R10,EXTNTAB   ADRESSE DER TABELLE LADEN
         CLC   MESSFLAG,=XL6'0' SIND NOCH NACHRICHTEN OFFEN ?
         BNE   AUSRDTEN      NEIN, VERZWEIGEN
         BAL   R14,AUSEXTM   VERZWEIGEN ZUR NACHRICHTENAUSGABE
         SPACE 2
*
*      AUSGABE NOCH OFFENER DATE-NACHRICHTEN.
*
         SPACE 1
AUSRDTEN EQU   *
         LA    R10,DATETAB   ADRESSE DER TABELLE LADEN
         CLC   MESSFLAG,=XL6'0' SIND NOCH NACHRICHTEN OFFEN ?
         BNE   ENDE          NEIN, VERZWEIGEN
         BAL   R14,AUSDATEM  JA, VERZW. ZUR NACHRICHTENAUSGABE
         EJECT
*
*      SPEICHERPLATZFREIGABE,
*      REINITIALISIERUNG DER REGISTER UND
*      RUECKSPRUNG ZUM AUFRUFENDEN PROGRAMM.
*
         SPACE 1
ENDE     EQU   *
         XRETURN ,R
         EJECT
***********************************************************************
*                                                                     *
*      VERARBEITUNG DER ALLOCATION- UND DCB-INFORMATIONEN.            *
*                                                                     *
***********************************************************************
         SPACE 3
MSGINFO  EQU   *
         ST    R14,SAVE1R14  RUECKSPRUNGADRESSE SICHERN
         L     R10,SAVE1R10  R10 INITIALISIEREN
         MVC   MESSFLAG,=XL6'0' FLAG BYTES LOESCHEN
         MVC   MESSAGE(LENMSG03),MSG03 NACHRICHTENZEILE UEBERTRAGEN
         MVC   MS3VOLID,UCBVOLI VOLSER NUMBER UEBERTRAGEN
         MVC   MS3ADR,UCBNAME UNIT NAME UEBERTRAGEN
         SPACE 2
*
*      AUFBEREITUNG DER DCB-INFORMATIONEN.
*
         SPACE 1
         LA    R9,MS3DCBIN   ADRESSE DES INFORMATIONSFELDES LADEN
         TM    DS1DSORG,X'80' DSORG = IS ?
         BZ    *+14          NEIN, VERZWEIGEN
         MVC   0(3,R9),=C'IS,' DSORG = IS SPEZIFIZIEREN
         B     RECFM         VERZWEIGEN
         TM    DS1DSORG,X'40' DSORG = PS ?
         BZ    *+14          NEIN, VERZWEIGEN
         MVC   0(3,R9),=C'PS,' DSORG = PS SPEZIFIZIEREN
         B     RECFM         VERZWEIGEN
         TM    DS1DSORG,X'20' DSORG = DA ?
         BZ    *+14          NEIN, VERZWEIGEN
         MVC   0(3,R9),=C'DA,' DSORG = DA SPEZIFIZIEREN
         B     RECFM         VERZWEIGEN
         TM    DS1DSORG,X'10' DSORG = CX ?
         BZ    *+14          NEIN, VERZWEIGEN
         MVC   0(3,R9),=C'CX,' DSORG = CX SPEZIFIZIEREN
         B     RECFM         VERZWEIGEN
         TM    DS1DSORG,X'02' DSORG = PO ?
         BZ    *+14          NEIN, VERZWEIGEN
         MVC   0(3,R9),=C'PO,' DSORG = PO SPEZIFIZIEREN
         B     RECFM         VERZWEIGEN
         TM    DS1DSORG,X'01' DSORG = U ?
         BZ    *+16          NEIN, VERZWEIGEN
         MVC   0(2,R9),=C'U,' DSORG = U SPEZIFIZIEREN
         BCTR  R9,0          R9 UM EINS VERMINDERN
         B     RECFM         VERZWEIGEN
         EJECT
         TM    DS1DSORG+1,X'80' DSORG = GS ?
         BZ    *+14          NEIN, VERZWEIGEN
         MVC   0(3,R9),=C'GS,' DSORG = GS SPEZIFIZIEREN
         B     RECFM         VERZWEIGEN
         TM    DS1DSORG+1,X'40' DSORG = TX ?
         BZ    *+14          NEIN, VERZWEIGEN
         MVC   0(3,R9),=C'TX,' DSORG = TX SPEZIFIZIEREN
         B     RECFM         VERZWEIGEN
         TM    DS1DSORG+1,X'20' DSORG = TQ ?
         BZ    *+14          NEIN, VERZWEIGEN
         MVC   0(3,R9),=C'TQ,' DSORG = TQ SPEZIFIZIEREN
         B     RECFM         VERZWEIGEN
         TM    DS1DSORG+1,X'04' DSORG = TR ?
         BZ    *+14          NEIN, VERZWEIGEN
         MVC   0(3,R9),=C'TR,' DSORG = TR SPEZIFIZIEREN
         B     RECFM         VERZWEIGEN
         TM    DS1DSORG+1,X'08' DSORG = VSAM ?
         BZ    *+18          NEIN, VERZWEIGEN
         MVC   0(5,R9),=C'VSAM,' DSORG = VSAM SPEZIFIZIEREN
         LA    R9,2(R9)      R9 ERHOEHEN
         B     RECFM         VERZWEIGEN
         MVC   0(3,R9),=C'--,'
         SPACE 1
RECFM    EQU   *
         LA    R9,3(R9)      R9 ERHOEHEN
         TM    DS1RECFM,X'C0' RECFM = U ?
         BNO   *+12          NEIN, VERZWEIGEN
         MVI   0(R9),C'U'    RECFM = U SPEZIFIZIEREN
         B     RECFMBLK      VERZWEIGEN
         TM    DS1RECFM,X'80' RECFM = F ?
         BNO   *+12          NEIN, VERZWEIGEN
         MVI   0(R9),C'F'    RECFM = F SPEZIFIZIEREN
         B     RECFMBLK      VERZWEIGEN
         MVI   0(R9),C'V'    RECFM = V SPEZIFIZIEREN
         EJECT
RECFMBLK EQU   *
         LA    R9,1(R9)      R9 ERHOEHEN
         TM    DS1RECFM,X'10' RECFM = BLOCKED ?
         BZ    *+12          NEIN, VERZWEIGEN
         MVI   0(R9),C'B'    RECFM = BLOCKED SPEZIFIZIEREN
         LA    R9,1(R9)      R9 ERHOEHEN
         TM    DS1RECFM,X'08' SPANNED, STANDARD ?
         BZ    *+12          NEIN, VERZWEIGEN
         MVI   0(R9),C'S'    SPANNED, STANDARD SPEZIFIZIEREN
         LA    R9,1(R9)      R9 ERHOEHEN
         TM    DS1RECFM,X'06' CONTROL CARACTER ?
         BZ    NOCONTC       NEIN, VERZWEIGEN
         TM    DS1RECFM,X'04' CONTROL CARACTER = A ?
         BZ    *+12          NEIN, VERZWEIGEN
         MVI   0(R9),C'A'    CONTROL CARACTER = A SPEZIFIZIEREN
         B     *+8           VERZWEIGEN
         MVI   0(R9),C'M'    CONTROL CARACTER = M SPEZIFIZIEREN
         LA    R9,1(R9)      R9 ERHOEHEN
         SPACE 1
NOCONTC  EQU   *
         MVI   0(R9),C','    KOMMA EINTRAGEN
         LH    R4,DS1BLKL    BLOCKGROESSE LADEN
         BAL   R14,CONVDEC   VERZW. ZUM UMWANDELN IN DEZIMALZAHL
         BAL   R14,UEBERLEN  VERZW. ZUM UEBERTR. DER BLOCKGROESSE
         MVI   0(R9),C','    KOMMA EINTRAGEN
         TM    DS1RECFM,X'C0' RECFM = U ?
         BNO   *+12          NEIN, VERZWEIGEN
         MVI   1(R9),C'*'    SATZLAENGE BEI RECFM = U NICHT VORHANDEN
         B     *+16          VERZWEIGEN
         LH    R4,DS1LRECL   SATZLAENGE LADEN
         BAL   R14,CONVDEC   VERZW. ZUM UMWANDELN IN DEZIMALZAHL
         BAL   R14,UEBERLEN  VERZW. ZUM UEBERTR. DER SATZLAENGE
         TM    DS1DSIND,X'14' PASSWORD PROTECTION ?
         BZ    NOPW          NEIN, VERZWEIGEN
         MVI   MS3MARK,C'P'  PASSWORD PROTECTION SPEZIFIZIEREN
NOPW     EQU   *
         TM    DS1DSIND,X'40'
         BNO   NORACF
         CLI   MS3MARK,C'P'
         BNE   SETR
         MVI   MS3MARK,C'B'
         B     NORACF
SETR     MVI   MS3MARK,C'R'
NORACF   EQU   *
         MVI   MS3CHNG,C'N'
         TM    DS1DSIND,DS1IND02
         BNO   NOCHNG
         MVI   MS3CHNG,C'Y'
NOCHNG   EQU   *
         EJECT
*
*      AUFBEREITUNG DER ALLOCATION-INFORMATIONEN.
*
         SPACE 1
         SR    R4,R4         R4 LOESCHEN
         IC    R4,DEVCODE    DEVICE CODE LADEN
         SLA   R4,1          DEVICE CODE * 2
         LA    R8,TABTCAP    ADRESSE DER TABTCAP-TABELLE LADEN
         AR    R8,R4         R8 ERHOEHEN
         CLI   0(R8),X'80'   DEVICE RESERVED ?
         BE    FEHLDEVC      JA, VERZW. ZUR FEHLERROUTINE
         MVC   TABELEM,0(R8) TABELLENELEMENT SPEICHERN
         LH    R4,DS1LSTAR   TT-ADRESSE DES LAST BLOCK POINTERS LADEN
         LA    R4,1(R4)      R4 ERHOEHEN
         CH    R4,=H'9999'   MEHR ALS 9999 SPUREN BELEGT ?
         BNH   *+8           NEIN, VERZWEIGEN
         B     *+14
         BAL   R14,CONVDEC   VERZW. ZUM UMWANDELN IN DEZIMALZAHL
         MVC   MS3USED,ZWFELD+11 ANZAHL BELEGTER SPUREN UEBERTRAGEN
         LA    R9,MS3ALLOC   ADRESSE DES INFORMATIONSFELDES LADEN
         TM    DS1SCALO,X'C0' REQUEST IN CYLINDERS ?
         BNO   REQINTRK      NEIN, VERZWEIGEN
         MVC   0(5,R9),=C'CYL,(' REQUEST = 'CYL' SPEZIFIZIEREN
         LA    R9,4(R9)      R9 ERHOEHEN
         TM    DS1EXT1,X'FF' EXTENT-BESCHREIBUNG VORHANDEN ?
         BNZ   REQCYLOK      JA, VERZWEIGEN
         MVC   1(3,R9),=C'--,'
         LA    R9,3(R9)      R9 ERHOEHEN
         B     SECALLOC      VERZWEIGEN
REQCYLOK EQU   *
         BAL   R14,EXT1LEN   VERZW. ZUR BERECHNUNG DER EXTENT-GROESSE
         LM    R4,R5,DBWORD  EXTENT-GROESSE LADEN
         LTR   R5,R5         EXTENT NUR IN GANZEN ZYLINDERN ?
         BZ    ALLOCOK       JA, VERZWEIGEN
         LA    R4,1(R4)      ANZ. DER ZYLINDER ERHOEHEN
         B     ALLOCOK       VERZWEIGEN
         EJECT
REQINTRK EQU   *
         TM    DS1SCALO,X'80' REQUEST IN TRACKS ?
         BZ    REQINBLK      NEIN, VERZWEIGEN
         MVC   0(5,R9),=C'TRK,(' REQUEST = 'TRK' SPEZIFIZIEREN
         LA    R9,4(R9)      R9 ERHOEHEN
         TM    DS1EXT1,X'FF' EXTENT-BESCHREIBUNG VORHANDEN ?
         BNZ   REQTRKOK      JA, VERZWEIGEN
         MVC   1(3,R9),=C'--,'
         LA    R9,3(R9)      R9 ERHOEHEN
         B     SECALLOC      VERZWEIGEN
REQTRKOK EQU   *
         BAL   R14,EXT1LEN   VERZW. ZUR BERECHNUNG DER EXTENT-GROESSE
         L     R4,DBWORD     EXTENT-GROESSE LADEN
         MH    R4,TABELEM    ANZ DER CYL. IN ANZ. TRACKS UMRECHNEN
         A     R4,DBWORD+4   ANZ. EINZELNER TRACKS HINZUADDIEREN
         B     ALLOCOK       VERZWEIGEN
REQINBLK EQU   *
         TM    DS1SCALO,X'40' REQUEST IN BLOCKS ?
         BZ    ENDSEALC      NEIN, VERZWEIGEN
         LH    R4,DS1BLKL    BLOCKGROESSE LADEN
         BAL   R14,CONVDEC   VERZW. ZUM UMWANDELN IN DEZIMALZAHL
         BCTR  R9,0          R9 UM EINS VERMINDERN
         BAL   R14,UEBERLEN  VERZW. ZUM UEBERTR. DER BLOCKGROESSE
         MVC   0(5,R9),=C'(**,'
         LA    R9,3(R9)      R9 ERHOEHEN
         B     SECALLOC      VERZWEIGEN
ALLOCOK  EQU   *
         BAL   R14,CONVDEC   VERZW. ZUM UMWANDELN IN DEZIMALZAHL
         BAL   R14,UEBERLEN  VERZW. ZUM UEBERTR. DER EXTENT-GROESSE
         MVI   0(R9),C','    KOMMA EINTRAGEN
SECALLOC EQU   *
         MVC   DBWORD(4),DS1SCALO SEC. ALLOC. QUANTITY UEBERTRAGEN
         L     R4,DBWORD     SEC. ALLOC. QUANTITY LADEN
         LA    R4,0(R4)      ERSTES BYTE IN R4 LOESCHEN
         BAL   R14,CONVDEC   VERZW. ZUM UMWANDELN IN DEZIMALZAHL
         BAL   R14,UEBERLEN  VERZW. ZUM UEBERTR. DER SEC. ALLOC. QUANT.
         MVI   0(R9),C')'
ENDSEALC EQU   *
         EJECT
*
*      BERECHNUNG DER ALLOCATED TRACKS.
*
         SPACE 1
         BAL   R14,GETEXT    VERZW. ZUM FUELLEN DER EXTENT-TABELLE
         LA    R8,EXTTAB-10  ADRESSE DER EXTENT-TABELLE LADEN
         SR    R9,R9         R9 LOESCHEN
         ST    R9,CCANZ      SUMMENSPEICHER
         ST    R9,HHANZ          LOESCHEN
ALOTRKLP EQU   *
         LA    R8,10(R8)     R8 ERHOEHEN
         TM    0(R8),X'FF'   TABELLENENDE ERREICHT ?
         BO    ALOTRKEN      JA, VERZWEIGEN
         BZ    ALOTRKLP      VERZW., WENN KEINE EXTENT-BESCHR. VORH.
         MVC   DS1EXT1,0(R8) EXTENT-BESCHREIBUNG UEBERTRAGEN
         BAL   R14,EXT1LEN   VERZW. ZUM BERECHNEN DER EXTENT-GROESSE
         L     R9,CCANZ      ANZAHL DER
         AR    R9,R6             CYLINDER ZUR
         ST    R9,CCANZ          SUMME ADDIEREN
         L     R9,HHANZ      ANZAHL DER
         AR    R9,R7             TRACKS ZUR
         ST    R9,HHANZ          SUMME ADDIEREN
         B     ALOTRKLP      VERZWEIGEN
ALOTRKEN EQU   *
         L     R4,CCANZ      ANZAHL ALLOCATED CYLINDERS LADEN
         MH    R4,TABELEM    MULTIPL. MIT ANZ. TRACKS PRO CYLINDER
         A     R4,HHANZ      ANZAHL ALLOCATED TRACKS ADDIEREN
         CH    R4,=H'9999'   ANZAHL DER ALLOCATED TRACKS > 9999 ?
         BH    *+14          JA, VERZWEIGEN
         BAL   R14,CONVDEC   VERZW. ZUM UMWANDELN IN DEZIMALZAHL
         MVC   MS3TRKS,ZWFELD+11 ANZ. ALLOCATED TRACKS UEBERTRAGEN
         L     R14,SAVE1R14  RUECKSPRUNGADRESSE LADEN
         LA    R10,68(R10)   R10 ERHOEHEN
         C     R10,ADDRETB1  TABELLENENDE ERREICHT ?
         BNL   AUSMSGM       JA, VERZWEIGEN
         ST    R10,SAVE1R10  LAUFENDE ADRESSE SPEICHERN
         BR    R14           VERZWEIGEN
         EJECT
***********************************************************************
*                                                                     *
*      VERARBEITUNG DER EXTENT-INFORMATIONEN.                         *
*                                                                     *
***********************************************************************
         SPACE 3
EXTINFO  EQU   *
         ST    R14,SAVE1R14  RUECKSPRUNGADRESSE SICHERN
         CLI   MSGBYTE,X'FF' EXTENT-TABELLE BEREITS GEFUELLT ?
         BE    *+8           JA, VERZWEIGEN
         BAL   R14,GETEXT    VERZW. ZUM FUELLEN DER EXTENT-TABELLE
         L     R10,SAVE2R10  R10 INITIALISIEREN
         SR    R5,R5         R5 LOESCHEN
         MVC   ZAEHLER,=PL2'+0' ZAEHLER LOESCHEN
         LA    R6,EXTTAB     ADRESSE DER EXTENT-TABELLE LADEN
LOOP1    EQU   *
         TM    0(R6),X'FF'   ENDE DER TABELLE ERREICHT ?
         BO    ENDLOOP       JA, VERZWEIGEN
         LA    R5,1(R5)      R5 ERHOEHEN
         MVC   MESSFLAG,=XL6'0' FLAG BYTES LOESCHEN
         MVC   MESSAGE(LENMSG04),MSG04 NACHRICHTENZEILE UEBERTRAGEN
         C     R10,ADDRETB1  ERSTE ZEILE IN DER TABELLE ?
         BNE   LOOP2-8       NEIN, VERZWEIGEN
         MVC   MS5VOLID,=C'VOLSER' UEBERSCHRIFTEN
         MVC   MS5NOEXT,=C'NO'   EINTRAGEN
         LA    R7,MS4EXT1-14 R7 INITIALISIEREN
         LA    R8,3          R8 INITIALISIEREN
LOOP2    EQU   *
         LA    R7,14(R7)     R7 ERHOEHEN
         AP    ZAEHLER,=P'+1' ZAEHLER ERHOEHEN
         UNPK  0(2,R7),ZAEHLER ZAEHLER SPEICHERN
         OI    1(R7),C'0'    VORZEICHEN MODIFIZIEREN
         BCT   R8,LOOP2      VERZWEIGEN
         LA    R10,68(R10)   R10 ERHOEHEN
         MVC   MESSAGE(LENMSG04),MSG04 NACHRICHTENZEILE UEBERTRAGEN
         MVC   MESSAGE+12(54),MESSAGE+11 ZEILE LOESCHEN
         MVC   MESSFLAG,=XL6'0' FLAG BYTES LOESCHEN
         CH    R5,=H'1'      ZWEITE NACHRICHTENZEILE ?
         BNE   LOOP3-8       NEIN, VERZWEIGEN
         MVC   MS5VOLID,UCBVOLI VOLSER NUMBER UEBERTRAGEN
         LH    R4,NOEXT      ANZAHL DER EXTENTS LADEN
         BAL   R14,CONVDEC   VERZW. ZUM UMWANDELN IN DEZIMALZAHL
         MVC   MS5NOEXT,ZWFELD+13 ANZAHL DER EXTENTS UEBERTRAGEN
         LA    R7,MS5EXT-14  R7 INITIALISIEREN
         LA    R8,3          R8 INITIALISIEREN
         EJECT
LOOP3    EQU   *
         LA    R7,14(R7)     R7 ERHOEHEN
         TM    0(R6),X'FF'   EXTENT-BESCHREIBUNG EINGETRAGEN ?
         BZ    EOFLOOP3      NEIN, VERZWEIGEN
         MVC   DBWORD,2(R6)  EXTENT-BESCHREIBUNG UEBERTRAGEN
         LH    R4,DBWORD     CC-ADRESSE DES EXTENT-BEGINNS LADEN
         BAL   R14,CONVDEC   VERZW. ZUM UMWANDELN IN DEZIMALZAHL
         MVC   0(3,R7),ZWFELD+12 CC-ADRESSE DES EXTENT-BEG. UEBERTR.
         MVI   3(R7),C'/'    ZEICHEN EINTRAGEN
         MVC   DBWORD,2(R6)  EXTENT-BESCHREIBUNG UEBERTRAGEN
         LH    R4,DBWORD+2   HH-ADRESSE DES EXTENT-BEGINNS LADEN
         BAL   R14,CONVDEC   VERZW. ZUM UMWANDELN IN DEZIMALZAHL
         MVC   4(2,R7),ZWFELD+13 HH-ADRESSE DES EXTENT-BEG. UEBERTR.
         MVC   DBWORD,2(R6)  EXTENT-BESCHREIBUNG UEBERTRAGEN
         LH    R4,DBWORD+4   CC-ADRESSE DES EXTENT-ENDES LADEN
         BAL   R14,CONVDEC   VERZW. ZUM UMWANDELN IN DEZIMALZAHL
         MVC   7(3,R7),ZWFELD+12 CC-ADRESSE DES EXTENT-ENDES UEBERTR.
         MVC   DBWORD,2(R6)  EXTENT-BESCHREIBUNG UEBERTRAGEN
         MVI   10(R7),C'/'   ZEICHEN EINTRAGEN
         LH    R4,DBWORD+6   HH-ADRESSE DES EXTENT-ENDES LADEN
         BAL   R14,CONVDEC   VERZW. ZUM UMWANDELN IN DEZIMALZAHL
         MVC   11(2,R7),ZWFELD+13 HH-ADRESSE DES EXTENT-ENDES UEBERTR.
EOFLOOP3 EQU   *
         LA    R5,1(R5)      R5 ERHOEHEN
         LA    R6,10(R6)     R6 ERHOEHEN
         TM    0(R6),X'FF'   ENDE DER TABELLE ERREICHT ?
         BO    ENDLOOP       JA, VERZWEIGEN
         BCT   R8,LOOP3      VERZWEIGEN
         LA    R10,68(R10)   R10 ERHOEHEN
         B     LOOP1         VERZWEIGEN
ENDLOOP  EQU   *
         L     R14,SAVE1R14  RUECKSPRUNGADRESSE LADEN
         LA    R10,68(R10)   R10 ERHOEHEN
         C     R10,ADDRETB2  TABELLENENDE ERREICHT ?
         BNL   AUSEXTM       JA, VERZW. ZUR NACHRICHTENAUSGABE
         ST    R10,SAVE2R10  LAUFENDE ADRESSE SPEICHERN
         BR    R14           VERZWEIGEN
         EJECT
***********************************************************************
*                                                                     *
*      VERARBEITUNG VON ERSTELL- UND VERFALLDATUM.                    *
*                                                                     *
***********************************************************************
         SPACE 3
DATEINFO EQU   *
         ST    R14,SAVE1R14  RUECKSPRUNGADRESSE SICHERN
         L     R10,SAVE3R10  R10 INITIALISIEREN
         MVC   MESSFLAG,=XL6'0' FLAG BYTES LOESCHEN
         MVC   MESSAGE(LENMSG06),MSG06 NACHRICHTENZEILE UEBERTRAGEN
         MVC   MS6VOLID,UCBVOLI VOLSER NUMBER UEBERTRAGEN
         SR    R4,R4         R4 LOESCHEN
         IC    R4,DS1CREDT   CREATION DATE (JAHR) LADEN
         BAL   R14,CONVDEC   VERZW. ZUM UMWANDELN IN DEZIMALZAHL
         MVC   MS6CREDT(2),ZWFELD+13 JAHR UEBERTRAGEN
         IC    R4,DS1EXPDT   EXPIRATION DATE (JAHR) LADEN
         BAL   R14,CONVDEC   VERZW. ZUM UMWANDELN IN DEZIMALZAHL
         MVC   MS6EXPDT(2),ZWFELD+13 JAHR UEBERTRAGEN
         MVC   DBWORD(2),DS1CREDT+1 CREATION DATE (TAGE) UEBERTRAGEN
         LH    R4,DBWORD     CREATION DATE (TAGE) LADEN
         BAL   R14,CONVDEC   VERZW. ZUM UMWANDELN IN DEZIMALZAHL
         MVC   MS6CREDT+3(3),ZWFELD+12 TAGE UEBERTRAGEN
         MVC   DBWORD(2),DS1EXPDT+1 EXPIRATION DATE (TAGE) UEBERTRAGEN
         LH    R4,DBWORD     EXPIRATION DATE (TAGE) LADEN
         BAL   R14,CONVDEC   VERZW. ZUM UMWANDELN IN DEZIMALZAHL
         MVC   MS6EXPDT+3(3),ZWFELD+12 TAGE UEBERTRAGEN
         MVI   MS6EXPDT+2,C'.'
         MVI   MS6CREDT+2,C'.'
         SR    R4,R4
         IC    R4,DS1REFD
         BAL   R14,CONVDEC
         MVC   MS6REFD(2),ZWFELD+13
         MVC   DBWORD(2),DS1REFD+1
         LH    R4,DBWORD
         BAL   R14,CONVDEC
         MVC   MS6REFD+3(3),ZWFELD+12
         MVI   MS6REFD+2,C'.'
         L     R14,SAVE1R14  RUECKSPRUNGADRESSE LADEN
         LA    R10,68(R10)   R10 ERHOEHEN
         C     R10,ADDRETB3  TABELLENENDE ERREICHT ?
         BNL   AUSDATEM      JA, VERZWEIGEN
         ST    R10,SAVE3R10  LAUFENDE ADRESSE SPEICHERN
         BR    R14           VERZWEIGEN
         EJECT
***********************************************************************
*                                                                     *
*      FEHLERROUTINEN.                                                *
*                                                                     *
***********************************************************************
         SPACE 3
*
*      ROUTINE BEI FEHLER IN DER PARAMETERKETTE.
*
         SPACE 1
FEHLPARM EQU   *
         L     R0,UCMID      UCM-ID. DES AUFRUFERS LADEN
         LA    R1,MSG09
         BAL   R14,WTOROUT
         B     ENDE          VERZWEIGEN
         SPACE 2
*
*      ROUTINE BEI OBTAIN-FEHLER (RC ^= 0 × RC ^= 8).
*
         SPACE 1
FEHLOBT  EQU   *
         LA    R10,FEHLTAB   R10 INITIALISIEREN
         MVC   MESSAGE(LENMSG11),MSG011 NACHRICHTENZEILE UEBERTRAGEN
         MVC   MS11VOLI,UCBVOLI VOLSER NUMBER UEBERTRAGEN
         LR    R4,R15        RETURN CODE IN R4 LADEN
         BAL   R14,CONVDEC   VERZW. ZUM UMWANDELN IN DEZIMALZAHL
         MVC   MS11RC,ZWFELD+13 RETURN CODE UEBERTRAGEN
         L     R0,UCMID      UCM-ID. DES AUFRUFERS LADEN
         LA    R1,MESSAGE
         BAL   R14,WTOROUT
         B     NEXTUCB       VERZWEIGEN
         EJECT
*
*      ROUTINE BEI RESERVED DEVICES.
*
         SPACE 1
FEHLDEVC EQU   *
         B     NEXTUCB       VERZWEIGEN
         SPACE 2
*
*      ROUTINE BEI LOCATE-FEHLER (RC ^= 0).
*
         SPACE 1
FEHLLOC  EQU   *
         LA    R10,FEHLTAB   R10 INITIALISIEREN
         LR    R4,R15        RETURN CODE LADEN
         CH    R15,=H'8'     RETURN CODE = 8 ?
         BE    NONCATLG      JA, VERZWEIGEN
         MVC   MESSAGE(LENMSG12),MSG012 NACHRICHTENZEILE UEBERTRAGEN
         BAL   R14,CONVDEC   VERZW. ZUM UMWANDELN IN DEZIMALZAHL
         MVC   MS12RC,ZWFELD+13 RETURN CODE UEBERTRAGEN
WTOFMSG  EQU   *
         L     R0,UCMID      UCM-ID. DER AUFRUFERS LADEN
         LA    R1,MESSAGE
         BAL   R14,WTOROUT
         CLI   ALLBYTE,X'FF'
         BE    GETUCB
         CH    R4,=H'8'
         BE    GETUCB
*        L     R1,AREADR
*        FREEMAIN R,LV=VEKLEN,A=(R1)
         B     ENDE
NONCATLG EQU   *
         MVC   MESSAGE(LENMSG13),MSG013 NACHRICHTENZEILE UEBERTRAGEN
         B     WTOFMSG      VERZWEIGEN
         EJECT
***********************************************************************
*                                                                     *
*      AUSGABE DER NACHRICHTEN.                                       *
*                                                                     *
***********************************************************************
         SPACE 3
*
*      AUSGABE DER NACHRICHTEN MIT ALLOCATION- UND DCB-INFORMATIONEN.
*
         SPACE 1
AUSMSGM  EQU   *
         ST    R14,SAVE1R14  RUECKSPRUNGADRESSE SICHERN
         L     R0,UCMID      UCM-ID. DES AUFRUFERS LADEN
         LA    R1,ZEILE
         BAL   R14,WTOROUT
         L     R0,UCMID      UCM-ID. DES AUFRUFERS LADEN
         LA    R1,MSG02
         BAL   R14,WTOROUT
         LA    R10,MSGTAB-68 ADRESSE DER TABELLE LADEN
         L     R9,ADDRETB1   ENDADRESSE DER TABELLE LADEN
         BAL   R14,AUSGABE   VERZW. ZUR AUSGABE WEITERER ZEILEN
         LA    R10,MSGTAB    ADRESSE DER TABELLE LADEN
         ST    R10,SAVE1R10      UND SPEICHERN
         L     R14,SAVE1R14  RUECKSPRUNGADRESSE LADEN
         BR    R14           VERZWEIGEN
         SPACE 2
*
*      AUSGABE DER NACHRICHTEN MIT EXTENT-INFORMATIONEN.
*
         SPACE 1
AUSEXTM  EQU   *
         ST    R14,SAVE1R14  RUECKSPRUNGADRESSE SICHERN
         L     R0,UCMID      UCM-ID. DES AUFRUFERS LADEN
         LA    R1,ZEILE
         BAL   R14,WTOROUT
         LA    R10,EXTNTAB-68 ADRESSE DER TABELLE LADEN
         LA    R9,DATETAB    ENDADRESSE DER TABELLE LADEN
         BAL   R14,AUSGABE   VERZW. ZUR AUSGABE WEITERER NACHRICHTEN
         LA    R10,EXTNTAB   ADRESSE DER TABELLE LADEN
         ST    R10,SAVE2R10      UND SPEICHERN
         L     R14,SAVE1R14  RUECKSPRUNGADRESSE LADEN
         BR    R14           VERZWEIGEN
         EJECT
*
*      AUSGABE DER NACHRICHTEN MIT DATE-INFORMATIONEN.
*
         SPACE 1
AUSDATEM EQU   *
         ST    R14,SAVE1R14  RUECKSPRUNGADRESSE SICHERN
         L     R0,UCMID      UCM-ID. DES AUFRUFERS LADEN
         LA    R1,ZEILE
         BAL   R14,WTOROUT
         L     R0,UCMID      UCM-ID. DES AUFRUFERS LADEN
         LA    R1,MSG06
         BAL   R14,WTOROUT
         LA    R10,DATETAB-68 ADRESSE DER TABELLE LADEN
         L     R9,ADDRETB3   ENDADRESSE DER TABELLE LADEN
         BAL   R14,AUSGABE   VERZW. ZUR AUSGEEBE WEITERER ZEILEN
         LA    R10,DATETAB   ADRESSE DER TABELLE LADEN
         ST    R10,SAVE3R10      UND SPEICHERN
         L     R14,SAVE1R14  RUECKSPRUNGADRESSE LADEN
         BR    R14           VERZWEIGEN
         EJECT
*
*      AUSGABE EINZELNER NACHRICHTENZEILEN.
*
         SPACE 1
AUSGABE  EQU   *
         ST    R14,SAVE2R14  RUECKSPRUNGADRESSE SICHERN
NEXTMESS EQU   *
         LA    R10,68(R10)   R10 ERHOEHEN
         CR    R10,R9        ENDE DER TABELLE ERREICHT ?
         BNL   ENDMESS       JA, VERZWEIGEN
         CLC   MESSFLAG,=X'FFFF' FLAG BYTES GESETZT ?
         BE    ENDMESS       JA, VERZWEIGEN
         MVC   MESSFLAG,=X'FFFF' FLAG BYTES SETZEN
         L     R0,UCMID      UCM-ID. DES AUFRUFERS LADEN
         LA    R1,MESSAGE
         BAL   R14,WTOROUT
         B     NEXTMESS      VERZWEIGEN
ENDMESS  EQU   *
         L     R14,SAVE2R14  RUECKSPRUNGADRESSE LADEN
         BR    R14           VERZWEIGEN
         EJECT
***********************************************************************
*                                                                     *
*      FUELLEN DER EXTENT-TABELLE.                                    *
*                                                                     *
***********************************************************************
         SPACE 3
GETEXT   EQU   *
         ST    R14,SAVE2R14  RUECKSPRUNGADRESSE SICHERN
         SR    R4,R4         R4 LOESCHEN
         IC    R4,DS1NOEPV   ANZAHL DER EXTENTS LADEN
         STH   R4,NOEXT          UND SPEICHERN
         LA    R6,EXTTAB-10  ADRESSE DER EXTENT-TABELLE LADEN
         SR    R5,R5         R5 LOESCHEN
         SPACE 2
*
*      EINLESEN DER ERSTEN DREI EXTENTS-BESCHREIBUNGEN.
*
         SPACE 1
         LA    R7,DS1EXT1-10 ADRESSE DER EXTENT-BESCHR. LADEN
         MVC   DBWORD(4),=F'3' MAX. ANZAHL DER EXTENT-BESCHR. SPEICHERN
         BAL   R14,NXTEXT    VERZW. ZUM UEBERTR. DER EXTENT-BESCHR.
         CR    R5,R4         ALLE EXTENT-BESCHR. UEBERTRAGEN ?
         BNL   ENDEXT        JA, VERZWEIGEN
         SPACE 2
*
*      EINLESEN DER NAECHSTEN VIER EXTENT-BESCHREIBUNGEN.
*
         SPACE 1
         MVC   CCHHR,DS1PTRDS ADRESSE DES NAECHSTEN DSCB UEBERTRAGEN
         OBTAIN CAMSEEK       NAECHSTEN DSCB LESEN
         LTR   R15,R15        RETURN CODE = 0 ?
         BNZ   FEHLOBT        NEIN, VERZW. ZUR FEHLERROUTINE
         CLI   DS2FMTID,C'2'  DSCB = DSCB2 ?
         BNE   DSCB3OK        NEIN, VERZWEIGEN
         MVC   CCHHR,DS2PTRDS ADRESSE DES NAECHSTEN DSCB UEBERTRAGEN
         OBTAIN CAMSEEK       NAECHSTEN DSCB LESEN
         LTR   R15,R15        RETURN CODE = 0 ?
         BNZ   FEHLOBT        NEIN, VERZW. ZUR FEHLERROUTINE
DSCB3OK  EQU   *
         LA    R15,99         RETURN CODE SETZEN
         CLI   DS3FMTID,C'3'  DSCB = DSCB3 ?
         BNE   FEHLOBT        NEIN, VERZWEIGEN
         LA    R7,DS3EXTNT-10 ADRESSE DER EXTENT-BESCHR. LADEN
         MVC   DBWORD(4),=F'7' MAX. ANZAHL DER EXTENT-BESCHR. SPEICHERN
         BAL   R14,NXTEXT     VERZW. ZUM UEBERTR. DER EXTENT-BESCHR.
         CR    R5,R4          ALLE EXTENT-BECHREIBUNGEN UEBERTRAGEN ?
         BNL   ENDEXT         JA, VERZWEIGEN
         EJECT
*
*      EINLESEN DER LETZTEN NEUN EXTENT-BESCHREIBUNGEN.
*
         SPACE 1
         LA    R7,DS3ADEXT-10 ADRESSE DER EXTENT-BESCHR. LADEN
         MVC   DBWORD(4),=F'16' MAX. ANZAHL DER EXTENT-BESCHR.SPEICHERN
         BAL   R14,NXTEXT     VERZW. ZUM UEBERTR. DER EXTENT-BESCHR.
         SPACE 2
ENDEXT   EQU   *
         CR    R5,R4         R5 > R4 ?
         BH    *+8           JA, VERZWEIGEN
         LA    R6,10(R6)     NEIN, R6 ERHOEHEN
         MVI   0(R6),X'FF'   TABELLENENDE SPEZIFIZIEREN
         L     R14,SAVE2R14  RUECKSPRUNGADRESSE LADEN
         BR    R14           VERZWEIGEN
         SPACE 2
*
*      EXTENT-BESCHREIBUNGEN IN DIE TABELLE UEBERTRAGEN.
*
         SPACE 1
NXTEXT   EQU   *
         LA    R5,1(R5)      R5 ERHOEHEN
         LA    R6,10(R6)     R6 ERHOEHEN
         LA    R7,10(R7)     R7 ERHOEHEN
         CR    R5,R4         ALLE EXTENT-BESCHR. UEBERTRAGEN ?
         BHR   R14           JA, VERZWEIGEN
         MVC   0(10,R6),0(R7) EXTENT-BESCHREIBUNG UEBERTRAGEN
         C     R5,DBWORD     ALLE ZUSAMMENH. EXT.-BESCHR. UEBERTR.?
         BL    NXTEXT        NEIN, VERZWEIGEN
         BR    R14           JA, VERZWEIGEN
         EJECT
***********************************************************************
*                                                                     *
*      GROESSE EINES EXTENT BERECHNEN.                                *
*                                                                     *
***********************************************************************
         SPACE 3
EXT1LEN  EQU   *
         MVC   DBWORD,DS1EXT1+2 EXTENT-BESCHREIBUNG UEBERTRAGEN
         LH    R4,DBWORD      CC-ADRESSE DES EXTENT-BEGINNS LADEN
         LH    R5,DBWORD+2    HH-ADRESSE DES EXTENT-BEGINNS LADEN
         LH    R6,DBWORD+4    CC-ADRESSE DES EXTENT-ENDES LADEN
         LH    R7,DBWORD+6    HH-ADRESSE DES EXTENT-ENDES LADEN
         CR    R7,R5          R7 > R5 ?
         BNL   ADDROK         JA, VERZWEIGEN
         BCTR  R6,0           R6 UM EINS VERMINDERN
         AH    R7,TABELEM     R7 ERHOEHEN
ADDROK   EQU   *
         SR    R6,R4          R6 VERMINDERN UND
         ST    R6,DBWORD          ANZAHL DER CYLINDER SPEICHERN
         LA    R7,1(R7)       R7 ERHOEHEN
         SR    R7,R5          R7 VERMINDERN UND
         ST    R7,DBWORD+4        ANZAHL DER TRACKS SPEICHERN
         BR    R14            VERZWEIGEN
         EJECT
***********************************************************************
*                                                                     *
*      UMWANDLUNG VON DUALZAHLEN IN ENTPACKTE DEZIMALZAHLEN.          *
*                                                                     *
***********************************************************************
         SPACE 3
CONVDEC  EQU   *
         CVD   R4,DBWORD     INHALT VON R4 UMWANDELN
         UNPK  ZWFELD,DBWORD DEZIMALZAHL ENTPACKEN
         OI    ZWFELD+14,C'0' VORZEICHEN MODIFIZIEREN
         BR    R14           VERZWEIGEN
         SPACE 3
***********************************************************************
*                                                                     *
*      ZAHLENUEBERTRAGUNG OHNE FUEHRENDE NULLEN.                      *
*                                                                     *
***********************************************************************
         SPACE 3
UEBERLEN EQU   *
         LA    R6,ZWFELD-1   ADRESSE DES ZWISCHENSPEICHERS LADEN
         LA    R7,ZWFELD+14  ADRESSE DES LETZTEN BYTES LADEN
CONVSCHL EQU   *
         LA    R6,1(R6)      R6 ERHOEHEN
         CR    R6,R7         LETZTES BYTE ERREICHT ?
         BNL   LENOK         JA, VERZWEIGEN
         CLI   0(R6),C'0'    FUEHRENDE NULL ?
         BE    CONVSCHL      JA, VERZWEIGEN
LENOK    EQU   *
         SR    R7,R6         LAENGE DER ZAHL FESTSTELLEN
         EX    R7,MOVELEN    VERZW. ZUM UEBERTR. DER ZAHL
         AR    R9,R7         R9 ERHOEHEN
         LA    R9,2(R9)      R9 ERHOEHEN
         BR    R14           VERZWEIGEN
WTOROUT  EQU   *
         ST    R14,SAVE14
         C     R0,=CL4'ROSC'
         BNE   NOROS
         STM   R14,R12,12(R13)                   SAVE ALL REGS IN SA
*
*              NOW WE CAN ADDRESS DUMMYSECTION IN XMON
*
         LH    R0,0(R1)      LOAD LENGTH OF WTO
         SH    R0,=H'4'      DECREMENT BY 4
         STC   R0,3(R1)      INSERT LENGTH TO MESSAGE FOR USE BY ROSCOE
         LA    R0,3(R1)      LOAD MESSAGE ADDRESS
         L     R13,4(R13)    R13 --> SA IN XMON
         ST    R0,76(R13)    STORE IT IN DYN AREA OF XMON = INAREA
         OI    76(R13),X'80' SET HIGHORDER BIT ON
         L     R15,100(R13)  LOAD ROSCOE-CODE <<OUTCODE>>
         LA    R1,76(R13)    LOAD PARAMETER REGISTER
         L     R13,4(R13)    R13 --> SA IN ROSCOE
         L     R14,12(R13)   LOAD RETURNADDRESS
         LM    R2,R12,28(R13)                    LOAD REMAINDER
         BR    R14           RETURN DIRECT TO ROSCOE
NOROS    EQU   *
         C     R0,=CL4'TSO'
         BNE   DOWTO
         LH    R0,0(R1)
         SH    R0,=H'4'
         LA    R1,4(R1)
         SVC   93             **** TPUT ****
         L     R14,SAVE14
         BR    R14
DOWTO    EQU   *
         WTO   MF=(E,(1))
         L     R14,SAVE14
         BR    R14
         EJECT
***********************************************************************
*                                                                     *
*      BEFEHLE, DIE MIT HILFE DES EXECUTE-BEFEHLS AUSGEFUEHRT WERDEN. *
*                                                                     *
***********************************************************************
         SPACE 3
MOVEPNAM EQU   *
         MVC   DSNAME(0),9(R3) DSNAME UEBERTRAGEN
MOVEPVOL EQU   *
         MVC   1(0,R6),1(R7) VOLID IN TABELLE UEBERTRAGEN
NCVOLID1 EQU   *
         NC    ZWVOLID1(0),1(R6) VOLID UEBERLAGERN
OCVOLID2 EQU   *
         OC    ZWVOLID2(0),1(R7) VOLID UEBERLAGERN
MOVELEN  EQU   *
         MVC   1(0,R9),0(R6) ZAHL UEBERTRAGEN
         SPACE 3
***********************************************************************
*                                                                     *
*      REGISTER EQUATES.                                              *
*                                                                     *
***********************************************************************
         SPACE 3
R0       EQU   0             MACRO- UND-PARAMETER REGISTER
R1       EQU   1             MACRO- UND-PARAMETER REGISTER
R2       EQU   2             POINTER IN CVT / UCB LOOKUP TABLE
R3       EQU   3             POINTER FUER UCB
R4       EQU   4             ARBEITSREGISTER
R5       EQU   5             ARBEITSREGISTER
R6       EQU   6             ARBEITSREGISTER
R7       EQU   7             ARBEITSREGISTER
R8       EQU   8             ARBEITSREGISTER
R9       EQU   9             ARBEITSREGISTER
R10      EQU   10            POINTER IN NACHRICHTEN-TABELLEN
R11      EQU   11            BASISREG. FUER DSECTS PARMAREA / VEKTOR
R12      EQU   12            BASISREG. FUER CSECT SHOW
R13      EQU   13            BASISREG. FUER DSECT ABER
R14      EQU   14            RUECKSPRUNGADRESSEN
R15      EQU   15            CSECT-ADRESSEN UND RETURN CODES
         EJECT
***********************************************************************
*                                                                     *
*      DEFINITION DER KONSTANTEN-SPEICHER.                            *
*                                                                     *
***********************************************************************
         SPACE 3
*
*      TABELLE FUER AUFBEREITUNG VON HEXADEZIMALZAHLEN.
*
         SPACE 1
TABHEXA  DC    C'0123456789ABCDEF'
         SPACE 2
         EJECT
***********************************************************************
*                                                                     *
*      DEFINITION DER AUSGABENACHRICHTEN.                             *
*                                                                     *
***********************************************************************
         SPACE 3
MSG00    WTO   'XSHOW CATALOG POINTS TO:                               *
                      ',                                               *
               MF=L,MCSFLAG=(REG0)
LENMSG00 EQU   *-MSG00
         SPACE 1
MSG01    WTO   'XSHOW DSN=                                             *
                ',                                                     *
               MF=L,MCSFLAG=(REG0)
LENMSG01 EQU   *-MSG01
         SPACE 1
MSG02    WTO   'XSHOW VOLSER ADR --ALLOCATED-- TRKS USED -DCB-INFORMATI*
               ON- S C',                                               *
               MF=L,MCSFLAG=(REG0)
LENMSG02 EQU   *-MSG02
         SPACE 1
MSG03    WTO   'XSHOW 123456 123                                       *
                      ',                                               *
               MF=L,MCSFLAG=(REG0)
LENMSG03 EQU   *-MSG03
         EJECT
MSG04    WTO   'XSHOW           --EXTENT01--- --EXTENT02--- --EXTENT03-*
               --',                                                    *
               MF=L,MCSFLAG=(REG0)
LENMSG04 EQU   *-MSG04
         SPACE 1
MSG06    WTO   'XSHOW VOLSER CREDTE EXPDTE REFDTE',                    *
               MF=L,MCSFLAG=(REG0)
LENMSG06 EQU   *-MSG06
         SPACE 1
MSG08    WTO   'XSHOW D.S. NOT FOUND',                                 *
               MF=L,MCSFLAG=(REG0)
LENMSG08 EQU   *-MSG08
         EJECT
MSG09    WTO   'XSHOW PARM-ERROR',                                     *
               MF=L,MCSFLAG=(REG0)
LENMSG09 EQU   *-MSG09
         SPACE 1
         SPACE 1
MSG011   WTO   'XSHOW VOLSER=123456, OBTAIN FAILURE, RC=99',           *
               MF=L,MCSFLAG=(REG0)
LENMSG11 EQU   *-MSG011
         SPACE 1
MSG012   WTO   'XSHOW LOCATE FAILURE, RC=99',                          *
               MF=L,MCSFLAG=(REG0)
LENMSG12 EQU   *-MSG012
         SPACE 1
MSG013   WTO   'XSHOW D.S. NOT CATLGD',                                *
               MF=L,MCSFLAG=(REG0)
LENMSG13 EQU   *-MSG013
MSG014   WTO   'XSHOW VOL-CNT = 0',MF=L,MCSFLAG=REG0
MSG015   WTO   'XSHOW TAPE-DATASET. SEQUENCE-NUMBER = XXX',            *
               MF=L,MCSFLAG=REG0
LENMSG15 EQU   *-MSG015
         LTORG
*
*      TRACKS / CYLINDER DER DASD-EINHEITEN.
*
         SPACE 1
TABTCAP  DS     0H
         DC     X'8000'      00 - RESERVED
         DC     H'10'        01 - 2311    DISK STORAGE DEVICE
         DC     H'08'        02 - 2301    PARALLEL DRUM
         DC     H'10'        03 - 2303    SERIAL DRUM
         DC     H'46'        04 - 2302    DISK STORAGE
         DC     H'20'        05 - 2321    DATA CELL DRIVE
         DC     H'08'        06 - 2305/1  FIXED HEAD STORAGE / MODEL 1
         DC     H'08'        07 - 2305/2  FIXED HEAD STORAGE / MODEL 2
         DC     H'20'        08 - 2314    DISK STORAGE FACILITY
         DC     H'19'        09 - 3330/1  DISK STORAGE / MODEL 1
         DC     H'12'        0A - 3340    DISK STORAGE
         DC     H'30'        0B - 3350    DISK STORAGE
         DC     X'8000'      0C - RESERVED
         DC     H'19'        0D - 3330/11 DISK STORAGE / MODEL 11
         DC     H'15'        0E - 3380
         DC     X'8000'      0F - RESERVED
         EJECT
***********************************************************************
*                                                                     *
*      DEFINITION DER ARBEITSBEREICHE.                                *
*                                                                     *
***********************************************************************
         SPACE 3
ABER     DSECT
SAVEAREA DS    18F           SAVEAREA FUER ALLGEMEINE REGISTER
SAVE14   DS    F
ALCERR   DS    F
PARMREG  DS    F
         SPACE 2
*
*      ADRESSEN-SPEICHER.
*
         SPACE 1
ADDRETB1 DS    F             ENDADRESSE DER MSG-NACHRICHTEN-TABELLE
ADDRETB2 DS    F             ENDADRESSE DER EXT-NACHRICHTEN-TABELLE
ADDRETB3 DS    F             ENDADRESSE DER DATE-NACHRICHTEN-TABELLE
ADDRETPV DS    F             ENDADRESSE DER VOLSER-TABELLE
SAVE1R10 DS    F             SAVEAREA1 FUER R10
SAVE2R10 DS    F             SAVEAREA2 FUER R10
SAVE3R10 DS    F             SAVEAREA3 FUER R10
SAVE1R14 DS    F             SAVEAREA1 FUER R14
SAVE2R14 DS    F             SAVEAREA2 FUER R14
         SPACE 2
*
*      SCHALTER.
*
         SPACE 1
FNDBYTE  DS    C             SCHALTER FUER GEFUNDENE DATA SETS
MSGBYTE  DS    C             SCHALTER FUER DEFAULT MESSAGES
EXTBYTE  DS    C             SCHALTER FUER EXTENT-INFORMATIONEN
DATEBYTE DS    C             SCHALTER FUER DATE-INFORMATIONEN
VOLBYTE  DS    C             SCHALTER FUER SPEZIFIZIERTE VOLSER NUMBERS
ALLBYTE  DS    C             SCHALTER FUER SPEZIFIZIERTE VOLSER NUMBERS
         EJECT
*
*      ARBEITSSPEICHER.
*
         SPACE 1
ZAEHLER  DS    CL2           ZAEHLER FUER DEZIMALZAHLEN
         DS    0H
CCHHR    DS    CL5           CCHHR-ADRESSE DES NAECHSTEN DSCB
ZWFELD   DS    CL15          ZWISCHENSPEICHER FUER DEZIMALZAHLEN
DSNAME   DS    CL44          SPEICHER FUER DATA SET NAME
VOLSERNO DS    CL6           ZWISCHENSPEICHER FUER VOLSER NUMBER
ZWVOLID1 DS    CL6           ZWISCHENSPEICHER FUER VOLSER NUMBER
ZWVOLID2 DS    CL6           ZWISCHENSPEICHER FUER VOLSER NUMBER
NOEXT    DS    H             ZWISCHENSPEICHER FUER ANYZAHL DER EXTENTS
TABELEM  DS    H             SPEICHER FUER ELEMENT AUS TABTCAP
CCANZ    DS    F             SUMMENSPEICHER FUER ALLOCATED CYLINDERS
HHANZ    DS    F             SUMMENSPEICHER FUER ALLOCATED TRACKS
DBWORD   DS    D             ZWISCHENSPEICHER FUER DEZIMALZAHLEN
UCMID    DS    F             UCM-ID. DES AUFRUFERS
         EJECT
*
*      CAMLIST-MACROS (ARBEITSBEREICHE).
*
         SPACE 1
CAMSEEK  DS    0F
         DS    C             AL1(192)
         DS    C             AL1(128)
         DS    C             AL1(0)
         DS    C             AL1(0)
CADRCCHH DS    F             A(CCHHR)
CADRUCBV DS    F             A(VOLSERNO)
CADRCAMW DS    F             A(CAMWKFLD)
         SPACE 1
CAMSRCH  DS    0F
         DS    C             AL1(193)
         DS    C             AL1(0)
         DS    C             AL1(0)
         DS    C             AL1(0)
CADRDSN  DS    F             A(DSNAME)
CADUCBVO DS    F             A(VOLSERNO)
CADCAMWK DS    F             A(CAMWKFLD)
         SPACE 1
CAMNAME  DS    0F
         DS    C             AL1(68)
         DS    C             AL1(0)
         DS    C             AL1(0)
         DS    C             AL1(0)
CAMDSN   DS    F             A(DSNAME)
         DS    F             A(0)
CAMCWK   DS    F             A(CAMWKFLD)
         DS    0D
CAMWKFLD DS    CL265         WORK FIELD
         EJECT
*
*      DSCB1-DEFINITIONEN.
*
         SPACE 1
         ORG   CAMWKFLD
WKDSCB1  DS    0CL96         DATA SET CONTROL BLOCK FORMAT 1
DS1FMTID DS    C             FORMAT IDENTIFIER (= C'1')
         DS    CL8
DS1CREDT DS    CL3           CREATION DATE (YDD)
DS1EXPDT DS    CL3           EXPIRATION DATE (YDD)
DS1NOEPV DS    C             NO. OF SEPERATE EXTENTS
         DS    CL15
DS1REFD  DS    CL3
         DS    CL4
DS1DSORG DS    CL2           DATA SET ORGANISATION
DS1RECFM DS    C             DATA SET RECORD FORMAT
         DS    C
DS1BLKL  DS    CL2           DATA SET BLOCK LENGTH
DS1LRECL DS    CL2           DATA SET RECORD LENGTH
         DS    CL3
DS1DSIND DS    C             DATA SET INDICATORS
DS1IND02 EQU   X'02'
DS1SCALO DS    CL4           ALLOCATION PARAMETERS
DS1LSTAR DS    CL3           LAST BLOCK POINTER (TTR
DS1TRBAL DS    CL2                               LL)
         DS    CL2
DS1EXT1  DS    3CL10         DESCRIPTION OF EXTENT1 - EXTENT3
DS1PTRDS DS    CL5           POINTER TO NEXT DSCB (CCHHR)
DS1CCHHR DS    CL5           POINTER TO DSCB1 (CCHHR)
         EJECT
*
*      DSCB2-DEFINITIONEN.
*
         SPACE 1
         ORG   CAMWKFLD
WKDSCB2  DS    0CL140        DATA SET CONTROL BLOCK FORMAT 2
         DS    CL44
DS2FMTID DS    C             FORMAT IDENTIFIER (=C'2')
         DS    CL90
DS2PTRDS DS    CL5           POINTER TO DSCB3 (CCHHR)
         SPACE 2
*
*      DSCB3-DEFINITIONEN.
*
         SPACE 1
         ORG   CAMWKFLD
WKDSCB3  DS    0CL140        DATA SET CONTROL BLOCK FORMAT 3
         DS    CL4
DS3EXTNT DS    4CL10         DESCRIPTION OF EXTENT4 - EXTENT7
DS3FMTID DS    C             FORMAT IDENTIFIER (=C'3')
DS3ADEXT DS    9CL10         DESCRIPTION OF EXTENT8 - EXTENT16
         ORG   CAMWKFLD+265
         EJECT
*
*      MASKEN-TABELLEN FUER VOLSER NUMBERS AUS DEM PARAMETERBEREICH.
*
*      AUFBAU DER TABELLE:
*      BYTE1 - LAENGE DES ANGEGEBENEN VOLSER-PARAMETERS ODER
*          X'80' BEI TABELLENENDE
*      BYTES2-7 - ANFANGSZEICHEN DER VOLSER NUMBER UND MASKENZEICHEN
*
         SPACE 1
TABPVOL1 DS    10CL7         TABELLE MIT MASKENZEICHEN X'FF'
ENDTPVOL EQU   *
         DS    CL7
TABPVOL2 DS    CL77          TABELLE MIT MASKENZEICHEN X'00'
         SPACE 2
*
*      TABELLE MIT EXTENT-INFORMATIONEN.
*
*      AUFBAU:
*      BYTE1: DATA SET EXTENT TYPE INDICATOR, X'FF' BEI TABELLENENDE
*      BYTE2: EXTENT SEQUENCE NUMBER
*      BYTE3-6: LOWER LIMIT OF THIS EXTENT (CCHH)
*      BYTE7-10: UPPER LIMIT OF THIS EXTENT (CCHH)
*
         SPACE 1
EXTTAB   DS    17CL10
         SPACE 2
*
*      NACHRICHTEN-BEREICHE.
*
*      AUFBAU:
*      BYTE1-66: WTO-NACHRICHTENZEILE
*      BYTE67-68: X'0000', WENN NACHRICHTENZEILE VERFUEGBAR
*
         SPACE 1
         DS    0F
MSGTAB   DS    10CL68        TABELLE FUER ALLOC.- UND DCB-NACHRICHTEN
ENDTAB1  EQU   *
EXTNTAB  DS    10CL68        TABELLE FUER EXTENT-NACHRICHTEN
ENDTAB2  EQU   *
         DS    7CL68         ERWEITERUNG DER EXTN-TABELLE
DATETAB  DS    10CL68        TABELLE FUER DATE-NACHRICHTEN
ENDTAB3  EQU   *
FEHLTAB  DS    CL68          TABELLE FUER FEHLERNACHRICHTEN
ZEILE    DS    CL66          UEBERSCHRIFTENZEILE
         SPACE 1
ABERL    EQU   *-ABER        LAENGE DER ARBEITSBEREICHE
         EJECT
***********************************************************************
*                                                                     *
*      DEFINITIONEN FUER EINE NACHRICHTENZEILE.                       *
*                                                                     *
***********************************************************************
         SPACE 3
MESSAGE  DSECT
         SPACE 2
*
*      DEFINITIONEN FUER MSG00.
*
         SPACE 1
         ORG   MESSAGE+4
         DS    CL8
MS0VOL1  EQU   *
         DS    CL17
MS0VOL2  EQU   *
         SPACE 2
*
*      DEFINITIONEN FUER MSG01.
*
         SPACE 1
         ORG   MESSAGE+4
         DS    CL10
MS1DSN   DS    CL44          DATA SET NAME
         SPACE 2
*
*      DEFINITIONEN FUER MSG03.
*
         SPACE 1
         ORG   MESSAGE+4
         DS    CL6
MS3VOLID DS    CL6           VOLUME SERIAL NUMBER
         DS    C
MS3ADR   DS    CL3           UNIT ADDRESS
         DS    C
MS3ALLOC DS    CL13          ALLOCATION INFORMATION
         DS    C
MS3TRKS  DS    CL4           ALLOCATED TRACKS
         DS    C
MS3USED  DS    CL4           USED TRACKS
         DS    C
MS3DCBIN DS    CL17          DCB INFORMATION
         DS    C
MS3MARK  DS    C             MARK (='P': PASSWORD PROTECTED)
         DS    C
MS3CHNG  DS    C             CHANGE-BIT
         EJECT
*
*      DEFINITIONEN FUER MSG04.
*
         SPACE 1
         ORG   MESSAGE+4
         DS    CL6
MS4VOLID DS    CL6           VOLUME SERIAL NUMBER
         DS    C
MS4NOEXT DS    CL2           NUMBER OF SEPERATE EXTENTS
         DS    CL9
MS4EXT1  DS    CL2           EXTENT NUMBER
         DS    CL12
MS4EXT2  DS    CL2           EXTENT NUMBER
         DS    CL12
MS4EXT3  DS    CL2           EXTENT NUMBER
         SPACE 2
*
*      DEFINITIONEN FUER MSG05 (MSG04).
*
         SPACE 1
         ORG   MESSAGE+4
         DS    CL6
MS5VOLID DS    CL6           VOLUME SERIAL NUMBER
         DS    C
MS5NOEXT DS    CL2           NUMBER OF SEPERATE EXTENTS
         DS    C
MS5EXT   DS    3CL14         EXTENT DESCRIPTION
         SPACE 2
*
*      DEFINITIONEN FUER MSG06.
*
         SPACE 1
         ORG   MESSAGE+4
         DS    CL6
MS6VOLID DS    CL6           VOLUME SERIAL NUMBER
         DS    C
MS6CREDT DS    CL6           CREATION DATE
         DS    C
MS6EXPDT DS    CL6           EXPIRATION DATE
         DS    C
MS6REFD  DS    CL6
         EJECT
*
*      DEFINITIONEN FUER MSG010.
*
         SPACE 1
         ORG   MESSAGE+4
         DS    CL13
MS10VOLI DS    CL6           VOLUME SERIAL NUMBER
         DS    CL26
MS10DEVC DS    CL2           DEVICE CODE
         SPACE 2
*
*      DEFINITIONEN FUER MSG011.
*
         SPACE 1
         ORG   MESSAGE+4
         DS    CL13
MS11VOLI DS    CL6           VOLUME SERIAL NUMBER
         DS    CL21
MS11RC   DS    CL2           RETURN CODE
         SPACE 2
*
*      DEFINITIONEN FUER MSG012.
*
         SPACE 1
         ORG   MESSAGE+4
         DS    CL25
MS12RC   DS    CL2           RETURN CODE
         SPACE 2
         ORG   MESSAGE+66
MESSFLAG DS    CL2           FLAG BYTES
         EJECT
***********************************************************************
*                                                                     *
*      UCB-DEFINITIONEN.                                              *
*                                                                     *
***********************************************************************
         SPACE 3
UCB      DSECT
         DS    CL3
DEVSTAT  DS    C             DEVICE STATUS
         DS    CL9
UCBNAME  DS    CL3           UNIT NAME
UCBTYPE  DS    CL2           DEVICE TYPE
UCBDVCLS DS    C             DEVICE CLASS
DEVCODE  DS    C             DEVICE CODE
         DS    CL4
UCBVTOC  DS    CL4           REL. ADDR. OF VTOC FOR THIS VOL. (TTR0)
UCBVOLI  DS    CL6           VOLUME SERIAL NUMBER
UCBSTAB  DS    C             VOLUME STATUS
         SPACE 3
***********************************************************************
*                                                                     *
*      PARAMETERBEREICH.                                              *
*                                                                     *
***********************************************************************
         SPACE 3
         XPARM
PARMENDE EQU   *
         END   SHOW
./ ADD NAME=SPACE
         TITLE 'XSPACE                             X-COMMAND SPACE'
SPACE    CSECT
         SPACE 3
***********************************************************************
*                                                                     *
*      PROGRAM-ID. SPACE.                                             *
*      AUTHOR. EHNERT.                                                *
*      INSTALLATION. BAYER AG, LEVERKUSEN, RECHENZENTRUM.             *
*      DATE-WRITTEN. 16. 7. 1975.                                     *
*      REMARKS.                                                       *
*                                                                     *
*          DAS X-COMMAND 'SPACE' GIBT INFORMATIONEN UEBER DEN         *
*          FREIEN SPEICHERPLATZ, DIE ANZAHL DER EXTENTS UND DEN       *
*          EXTENT DER ALS PARAMETER SPEZIFIZIERTEN VOLUMES AUS.       *
*                                                                     *
*          ALS PARAMETER KOENNEN BIS ZU ZEHN VOLSER-MASKEN ANGE-      *
*          GEBEN WERDEN, MIT DEREN HILFE EINE AUSWAHL DER VOLUMES     *
*          GETROFFEN WIRD. DABEI STEHT '*' FUER JEDES ZEICHEN AN      *
*          DIESER STELLE.                                             *
*                                                                     *
***********************************************************************
         EJECT
***********************************************************************
*                                                                     *
*      BEGINN DER VERARBEITUNG.                                       *
*                                                                     *
***********************************************************************
         SPACE 3
*
*      SICHERN DER REGISTER,
*      SPEICHERPLATZANFORDERUNG FUER ARBEITSBEREICHE,
*      ZUORDNUNG DER BASISREGISTER.
*
         SPACE 1
         XSAVE R12,,SPACE,ABERL
         SPACE 1
         LR    R11,R1        BASISREG. FUER DSECT PARMAREA INITIALIS.
         USING UCB,R3        BASISREG. FUER DSECT UCB ZUORDNEN
         USING MESSAGE,R10   BASISREG. FUER DSECT MESSAGE ZUORDNEN
         USING PARMAREA,R11  BASISREG. FUER DSECT PARMAREA ZUORDNEN
         USING ABER,R13      BASISREG. FUER DSECT ABER ZUORDNEN
         EJECT
*
*      INITIALISIERUNG DER SPEICHER.
*
         SPACE 1
         MVI   FNDBYTE,X'00' SCHALTER LOESCHEN
         MVI   WTORBYTE,X'FF' SCHALTER SETZEN
         LA    R2,ENDTAB1    ENDADRESSEN DER
         LA    R3,ENDTPVOL       TABELLEN LADEN
         STM   R2,R3,ADDRETB1    UND SPEICHERN
         MVC   UCMID,REG4    UCM-ID. DES AUFRUFERS UEBERTRAGEN
         SPACE 2
*
*      FLAG BYTS IN NACHRICHTENBEREICHEN SETZEN.
*
         SPACE 1
         LA    R10,MSGTAB    ADRESSE DER TABELLE LADEN
         ST    R10,SAVE1R10      UND SPEICHERN
         L     R3,ADDRETB1   ENDADRESSE DER TABELLEN LADEN
CLEARMSS EQU   *
         MVC   MESSFLAG,=X'FFFF' FLAG BYTES SETZEN
         LA    R10,68(R10)   R10 ERHOEHEN
         CR    R10,R3        ENDE DER TABELLEN ERREICHT ?
         BL    CLEARMSS      NEIN, VERZWEIGEN
         EJECT
***********************************************************************
*                                                                     *
*      VERARBEITUNG DER EINGABEPARAMETER.                             *
*                                                                     *
***********************************************************************
         SPACE 3
         LA    R4,TEXT+5     R4 INITIALISIEREN
         LA    R8,PARMENDE   ENDADRESSE DES PARAMETERBEREICHS LADEN
         CLI   0(R4),C','    PARAMETER ANGEGEBEN ?
         BNE   FEHLPARM      NEIN, VERZW. ZUR FEHLERROUTINE
         LA    R6,TABPVOL1   ADRESSE DER VOLSER-TABELLE LADEN
NEXTPARM EQU   *
         SR    R5,R5         R5 LOESCHEN
         LR    R7,R4         ADRESSE DES TRENNUNGSZEICHENS LADEN
NXTBYTE  EQU   *
         LA    R4,1(R4)      R4 ERHOEHEN
         CR    R4,R8         PARAMETERBEREICH UEBERSCHRITTEN ?
         BNL   FEHLPARM      JA, VERZW. ZUR FEHLERROUTINE
         CLI   0(R4),C','    ENDE DES PARAMETERS ERREICHT ?
         BE    NEXTPVOL      JA, VERZWEIGEN
         CLI   0(R4),X'00'   ENDE DER PARAMETERKETTE ERREICHT ?
         BE    NEXTPVOL      JA, VERZWEIGEN
         CLI   0(R4),C' '    ENDE DER PARAMETERKETTE ERREICHT ?
         BE    NEXTPVOL      JA, VERZWEIGEN
         LA    R5,1(R5)      R5 ERHOEHEN
         CLI   0(R4),C'*'    BELIEBIGES ZEICHEN AN DIESER STELLE ?
         BNE   NXTBYTE       NEIN, VERZWEIGEN
         MVI   0(R4),X'FF'   ZEICHEN UMSETZEN
         B     NXTBYTE       VERZWEIGEN
         EJECT
NEXTPVOL EQU   *
         C     R6,ADDRETPV   TABELLENENDE UEBERSCHRITTEN ?
         BNL   FEHLPARM      JA, VERZWEIGEN
         C     R5,=F'6'      LAENGE DER VOLID GUELTIG ?
         BH    FEHLPARM      NEIN, VERZW. ZUR FEHLERROUTINE
         LTR   R5,R5         VOLID ANGEGEBEN ?
         BZ    FEHLPARM      NEIN, VERZW. ZUR FEHLERROUTINE
         BCTR  R5,0          R5 UM EINS VERMINDERN
         EX    R5,MOVEPVOL   VERZW. ZUR UEBERTR. DER VOLSER NUMBER
         CH    R5,=H'5'
         BNE   NOMNT
         LA    R1,1(R6)
         CALL  MSSMNT,((R1)),VL
NOMNT    EQU   *
         STC   R5,0(R6)      LAENGENANGABE IN TABELLE EINTRAGEN
         LA    R6,7(R6)      R6 ERHOEHEN
         CLI   0(R4),C','    FOLGEN WEITERE PARAMETER ?
         BE    NEXTPARM      JA, VERZWEIGEN
         SPACE 2
*
*      ABSCHLUSS DER PARAMETERVERARBEITUNG.
*
         SPACE 1
         MVI   0(R6),X'80'   TABELLENENDE SPEZIFIZIEREN
         MVC   TABPVOL2,TABPVOL1 VOLSER-TABELLE KOPIEREN
         LA    R6,TABPVOL2-1 ADRESSE DER TABELLE LADEN
NEXTFF   EQU   *
         LA    R6,1(R6)      R6 ERHOEHEN
         CLI   0(R6),X'80'   TABELLENENDE ERREICHT ?
         BE    GETUCB        JA, VERZWEIGEN
         CLI   0(R6),X'FF'   TABELLENZEICHEN = X'FF' ?
         BNE   NEXTFF        NEIN, VERZWEIGEN
         MVI   0(R6),X'00'   TABELLENZEICHEN UMSETZEN
         B     NEXTFF        VERZWEIGEN
         EJECT
***********************************************************************
*                                                                     *
*      VERARBEITUNG DER UCB-INFORMATIONEN.                            *
*                                                                     *
***********************************************************************
         SPACE 3
GETUCB   EQU   *
         DROP  R11           R11 FREIGEBEN
NEXTUCB  EQU   *
         UCBSCAN DEVTYPE=DASD,STATUS=ONLINE
         LTR   R15,R15
         BNZ   ABSCHLUS
         LR    R3,R1
         TM    DEVSTAT,X'10' EINHEIT IM UNLOAD ?
         BO    NEXTUCB       JA, VERZWEIGEN
         CLC   UCBVOLI,=XL6'0' VOLID VORHANDEN ?
         BE    NEXTUCB       NEIN, VERZWEIGEN
         EJECT
*
*      VERGLEICH MIT SPEZIFIZIERTEN VOLSER NUMBERS.
*
         SPACE 1
         SR    R5,R5         R5 LOESCHEN
         LA    R6,TABPVOL1-7 ADRESSE DER VOLSER-TABELLE LADEN
         LA    R7,TABPVOL2-7 ADRESSE DER VOLSER-TABELLE LADEN
NXTVOLID EQU   *
         LA    R6,7(R6)      R6 ERHOEHEN
         LA    R7,7(R7)      R7 ERHOEHEN
         TM    0(R6),X'80'   TABELLENENDE ERREICHT ?
         BO    NEXTUCB       JA, VERZWEIGEN
         IC    R5,0(R6)      LAENGENANGABE LADEN
         MVC   ZWVOLID1,UCBVOLI VOLSER NUMBER UEBERTRAGEN
         MVC   ZWVOLID2,UCBVOLI VOLSER NUMBER UEBERTRAGEN
         EX    R5,NCVOLID1   VERZW. ZUR UEBERLAGERUNG DER VOLID
         EX    R5,OCVOLID2   VERZW. ZUR UEBERLAGERUNG DER VOLID
         CLC   ZWVOLID1,ZWVOLID2 VOLID = AUSGEW. VOLID ?
         BNE   NXTVOLID      VERZW., WENN VOLID ^= AUSGEW. VOLID
         MVC   VOLSERNO,UCBVOLI VOLSER NUMBER UEBERTRAGEN
         MVI   FNDBYTE,X'FF' FLAG BYTE SETZEN
         EJECT
***********************************************************************
*                                                                     *
*      DSCB5 LESEN UND AUSWERTEN (SVC 78).                            *
*                                                                     *
***********************************************************************
         SPACE 3
         L     R10,SAVE1R10  R10 INITIALISIEREN
         MVC   MESSAGE(LENMSG02),MSG02 NACHRICHTENZEILE UEBERTRAGEN
         MVC   MS2VOLID,UCBVOLI VOLSER NUMBER UEBERTRAGEN
         MVC   MS2ADR,UCBNAME UNIT NAME UEBERTRAGEN
         LA    R1,SVCWKFLD   ADRESSE DES SVC WORK FIELD LADEN
         LR    R0,R3         UCB-ADRESSE LADEN
         SVC   78            VERZW. ZUR VERARBEITUNG DES DSCB5
         MVC   MS2FRCYL,SVCFRCYL ANZ. FREIER CYLINDER UEBERTRAGEN
         MVC   MS2FRTRK,SVCFRTRK ANZ. FREIER TRACKS UEBERTRAGEN
         MVC   MS2NOEXT,SVCNOEXT ANZ. DER EXTENTS UEBERTRAGEN
         MVC   MS2MXCYL,SVCMXCYL ANZ. CYL. DES GROESSTEN EXT. UEBERTR.
         MVC   MS2MXTRK,SVCMXTRK ANZ. TRK. DES GROESSTEN EXT. UEBERTR.
         LA    R14,NEXTUCB   RUECKSPRUNGADRESSE LADEN
         MVC   MESSFLAG,=XL6'0' FLAG BYTES LOESCHEN
         LA    R10,68(R10)   R10 ERHOEHEN
         C     R10,ADDRETB1  ENDE DER TABELLE UEBERSCHRITTEN ?
         BNL   AUSMSGM       JA, VERZWEIGEN
         ST    R10,SAVE1R10  LAUFENDE ADRESSE SPEICHERN
         BR    R14           VERZWEIGEN
         EJECT
***********************************************************************
*                                                                     *
*      ABSCHLUSSROUTINEN.                                             *
*                                                                     *
***********************************************************************
         SPACE 3
ABSCHLUS EQU   *
         FREEMAIN R,SP=125    SPEICHERPLATZ FREIGEBEN
         MVI   WTORBYTE,X'00' FLAG BYTE LOESCHEN
         CLI   FNDBYTE,X'FF' VOLUME(S) GEFUNDEN ?
         BE    AUSRMSGN      JA, VERZWEIGEN
         L     R0,UCMID      UCM-ID. DES AUFRUFERS LADEN
         LA    R1,MSG03
         BAL   R14,WTOROUT
         B     ENDE          VERZWEIGEN
         SPACE 2
*
*      AUSGABE NOCH OFFENER INFO-NACHRICHTEN.
*
         SPACE 1
AUSRMSGN EQU   *
         LA    R10,MSGTAB    ADRESSE DER TABELLE LADEN
         CLC   MESSFLAG,=XL6'0' SIND NOCH NACHRICHTEN OFFEN ?
         BNE   ENDE          NEIN, VERZWEIGEN
         BAL   R14,AUSMSGM   JA, VERZW. ZUR NACHRICHTENAUSGABE
         EJECT
*
*      SPEICHERPLATZFREIGABE,
*      REINITIALISIERUNG DER REGISTER UND
*      RUECKSPRUNG ZUM AUFRUFENDEN PROGRAMM.
*
         SPACE 1
ENDE     EQU   *
         XRETURN ,R
         EJECT
***********************************************************************
*                                                                     *
*      FEHLERROUTINEN.                                                *
*                                                                     *
***********************************************************************
         SPACE 3
*
*      ROUTINE BEI FEHLER IN DER PARAMETERKETTE.
*
         SPACE 1
FEHLPARM EQU   *
         L     R0,UCMID      UCM-ID. DES AUFRUFERS LADEN
         LA    R1,MSG04
         BAL   R14,WTOROUT
         B     ENDE          VERZWEIGEN
         EJECT
***********************************************************************
*                                                                     *
*      AUSGABE DER NACHRICHTEN.                                       *
*                                                                     *
***********************************************************************
         SPACE 3
AUSMSGM  EQU   *
         ST    R14,SAVE1R14  RUECKSPRUNGADRESSE SICHERN
         L     R0,UCMID      UCM-ID. DES AUFRUFERS LADEN
         LA    R1,MSG01
         BAL   R14,WTOROUT
         LA    R10,MSGTAB-68 ADRESSE DER TABELLE LADEN
         L     R9,ADDRETB1   ENDADRESSE DER TABELLE LADEN
         BAL   R14,AUSGABE   VERZW. ZUR AUSGABE WEITERER ZEILEN
         LA    R10,MSGTAB    ADRESSE DER TABELLE LADEN
         ST    R10,SAVE1R10      UND SPEICHERN
         L     R14,SAVE1R14  RUECKSPRUNGADRESSE LADEN
         CLC   UCMID(4),=CL4'TSO'
         BER   R14
         CLC   UCMID(4),=CL4'ROSC'
         BER   R14
         CLI   WTORBYTE,X'FF' FLAG BYTE GESETZT ?
         BNER  R14           NEIN, VERZWEIGEN
NXTREPLY EQU   *
         XC    ECB,ECB       EVENT CONTROL BLOCK LOESCHEN
         L     R0,UCMID      UCM-ID. DES AUFRUFERS LADEN
         LA    R4,ECB        ADRESSE DES ECB LADEN
         LA    R5,REPLY      ADRESSE DES REPLY LADEN
         MVC   WTOR(LENMSG05),MSG05 NACHRICHTENZEILE UEBERTRAGEN
         WTOR  ,(R5),1,(R4),MF=(E,WTOR)
         SPACE 1
         WAIT  ECB=ECB       AUF REPLY WARTEN
         CLI   REPLY,C'N'    REPLY = NO ?
         BE    ENDE          JA, VERZWEIGEN
         CLI   REPLY,C'Y'    REPLY = YES ?
         BNE   NXTREPLY      NEIN, VERZWEIGEN
         L     R14,SAVE1R14  RUECKSPRUNGADRESSE LADEN
         BR    R14           VERZWEIGEN
         EJECT
*
*      AUSGABE EINZELNER NACHRICHTENZEILEN.
*
         SPACE 1
AUSGABE  EQU   *
         ST    R14,SAVE2R14  RUECKSPRUNGADRESSE SICHERN
NEXTMESS EQU   *
         LA    R10,68(R10)   R10 ERHOEHEN
         CR    R10,R9        ENDE DER TABELLE ERREICHT ?
         BNL   ENDMESS       JA, VERZWEIGEN
         CLC   MESSFLAG,=X'FFFF' FLAG BYTES GESETZT ?
         BE    ENDMESS       JA, VERZWEIGEN
         MVC   MESSFLAG,=X'FFFF' FLAG BYTES SETZEN
         L     R0,UCMID      UCM-ID. DES AUFRUFERS LADEN
         LA    R1,MESSAGE
         BAL   R14,WTOROUT
         B     NEXTMESS      VERZWEIGEN
ENDMESS  EQU   *
         L     R14,SAVE2R14  RUECKSPRUNGADRESSE LADEN
         BR    R14           VERZWEIGEN
WTOROUT  EQU   *
         ST    R14,SAVE14
         C     R0,=CL4'ROSC'
         BNE   NOROS
         STM   R14,R12,12(R13)                   SAVE ALL REGS IN SA
*
*              NOW WE CAN ADDRESS DUMMYSECTION IN XMON
*
         LH    R0,0(R1)      LOAD LENGTH OF WTO
         SH    R0,=H'4'      DECREMENT BY 4
         STC   R0,3(R1)      INSERT LENGTH TO MESSAGE FOR USE BY ROSCOE
         LA    R0,3(R1)      LOAD MESSAGE ADDRESS
         L     R13,4(R13)    R13 --> SA IN XMON
         ST    R0,76(R13)    STORE IT IN DYN AREA OF XMON = INAREA
         OI    76(R13),X'80' SET HIGHORDER BIT ON
         L     R15,100(R13)  LOAD ROSCOE-CODE <<OUTCODE>>
         LA    R1,76(R13)    LOAD PARAMETER REGISTER
         L     R13,4(R13)    R13 --> SA IN ROSCOE
         L     R14,12(R13)   LOAD RETURNADDRESS
         LM    R2,R12,28(R13)                    LOAD REMAINDER
         BR    R14           RETURN DIRECT TO ROSCOE
NOROS    EQU   *
         C     R0,=CL4'TSO'
         BNE   DOWTO
         LH    R0,0(R1)
         SH    R0,=H'4'
         LA    R1,4(R1)
         SVC   93             TPUT
         L     R14,SAVE14
         BR    R14
DOWTO    EQU   *
         WTO   MF=(E,(1))
         L     R14,SAVE14
         BR    R14
***********************************************************************
*                                                                     *
*      BEFEHLE, DIE MIT HILFE DES EXECUTE-BEFEHLS AUSGEFUEHRT WERDEN. *
*                                                                     *
***********************************************************************
         SPACE 3
MOVEPVOL EQU   *
         MVC   1(0,R6),1(R7) VOLID IN TABELLE UEBERTRAGEN
NCVOLID1 EQU   *
         NC    ZWVOLID1(0),1(R6) VOLID UEBERLAGERN
OCVOLID2 EQU   *
         OC    ZWVOLID2(0),1(R7) VOLID UEBERLAGERN
         EJECT
***********************************************************************
*                                                                     *
*      REGISTER EQUATES.                                              *
*                                                                     *
***********************************************************************
         SPACE 3
R0       EQU   0             MACRO- UND-PARAMETER REGISTER
R1       EQU   1             MACRO- UND-PARAMETER REGISTER
R2       EQU   2             POINTER IN UCB-ADR. VEKTOR
R3       EQU   3             POINTER FUER UCB
R4       EQU   4             ARBEITSREGISTER
R5       EQU   5             ARBEITSREGISTER
R6       EQU   6             ARBEITSREGISTER
R7       EQU   7             ARBEITSREGISTER
R8       EQU   8             ARBEITSREGISTER
R9       EQU   9             ARBEITSREGISTER
R10      EQU   10            POINTER IN NACHRICHTEN-TABELLEN
R11      EQU   11            BASISREG. FUER DSECT PARMAREA / VEKTOR
R12      EQU   12            BASISREG. FUER CSECT SPACE
R13      EQU   13            BASISREG. FUER DSECT ABER
R14      EQU   14            RUECKSPRUNGADRESSEN
R15      EQU   15            CSECT-ADRESSEN UND RETURN CODES
         EJECT
***********************************************************************
*                                                                     *
*      DEFINITION DER AUSGABENACHRICHTEN.                             *
*                                                                     *
***********************************************************************
         SPACE 3
MSG01    WTO   'XSPACE1 VOLSER ADR FREE-SPACE EXT LARGEST-EXTENT',     *
               MF=L,MCSFLAG=(REG0)
         SPACE 1
MSG02    WTO   'XSPACE2 VOLSER ADR 9999/9999  999    9999/999   ',     *
               MF=L,MCSFLAG=(REG0)
LENMSG02 EQU   *-MSG02
         SPACE 1
MSG03    WTO   'XSPACE3 SPECIFIED VOLUME(S) NOT FOUND',                *
               MF=L,MCSFLAG=(REG0)
         SPACE 1
MSG04    WTO   'XSPACE4 INVALID PARAMETER LIST',                       *
               MF=L,MCSFLAG=(REG0)
         SPACE 1
MSG05    WTOR  'XSPACE5 REPLY ''Y'' (YES) OR ''N'' (NO) TO CONTINUE',  *
               MF=L,MCSFLAG=(REG0)
LENMSG05 EQU   *-MSG05
         EJECT
***********************************************************************
*                                                                     *
*      DEFINITION DER ARBEITSBEREICHE.                                *
*                                                                     *
***********************************************************************
         SPACE 3
ABER     DSECT
SAVEAREA DS    18F           SAVEAREA FUER ALLGEMEINE REGISTER
SAVE14   DS    F
         SPACE 2
*
*      ADRESSEN-SPEICHER.
*
         SPACE 1
ADDRETB1 DS    F             ENDADRESSE DER MSG-NACHRICHTEN-TABELLE
ADDRETPV DS    F             ENDADRESSE DER VOLSER-TABELLE
SAVE1R10 DS    F             SAVEAREA1 FUER R10
SAVE1R14 DS    F             SAVEAREA1 FUER R14
SAVE2R14 DS    F             SAVEAREA2 FUER R14
UCMID    DS    F             UCM-ID. DES AUFRUFERS
         SPACE 2
*
*      ARBEITSSPEICHER.
*
         SPACE 1
FNDBYTE  DS    C             SCHALTER FUER GEFUNDENE VOLUMES
WTORBYTE DS    C             SCHALTER FUER WTOR
REPLY    DS    C             SPEICHER FUER REPLY
VOLSERNO DS    CL6           ZWISCHENSPEICHER FUER VOLSER NUMBER
ZWVOLID1 DS    CL6           ZWISCHENSPEICHER FUER VOLSER NUMBER
ZWVOLID2 DS    CL6           ZWISCHENSPEICHER FUER VOLSER NUMBER
ECB      DS    F             EVENT CONTROL BLOCK
WTOR     DS    15F           BEREICH FUER WTOR-NACHRICHT
SVCWKFLD DS    0F            SVC WORK FIELD
         DS    CL6
SVCFRCYL DS    CL4           ANZ. FREIER CYLINDER
         DS    CL1
SVCFRTRK DS    CL4           ANZ. FREIER TRACKS
         DS    CL1
SVCNOEXT DS    CL4           ANZ. DER EXTENTS
         DS    CL1
SVCMXCYL DS    CL4           ANZ. CYLINDER DES GROESSTEN EXTENTS
         DS    CL2
SVCMXTRK DS    CL3           ANZ. TRACKS DES GROESSTEN EXTENTS
         ORG   SVCWKFLD+80
         EJECT
*
*      MASKEN-TABELLEN FUER VOLSER NUMBERS AUS DEM PARAMETERBEREICH.
*
*      AUFBAU DER TABELLE:
*      BYTE1 - LAENGE DES ANGEGEBENEN VOLSER-PARAMETERS ODER
*          X'80' BEI TABELLENENDE
*      BYTES2-7 - ANFANGSZEICHEN DER VOLSER NUMBER UND MASKENZEICHEN
*
         SPACE 1
TABPVOL1 DS    10CL7         TABELLE MIT MASKENZEICHEN X'FF'
ENDTPVOL EQU   *
         DS    CL7
TABPVOL2 DS    CL77          TABELLE MIT MASKENZEICHEN X'00'
         SPACE 2
*
*      NACHRICHTEN-BEREICHE.
*
*      AUFBAU:
*      BYTE1-66: WTO-NACHRICHTENZEILE
*      BYTE67-68: X'0000', WENN NACHRICHTENZEILE VERFUEGBAR
*
         SPACE 1
         DS    0F
MSGTAB   DS    10CL68        TABELLE FUER NACHRICHTEN
ENDTAB1  EQU   *
         SPACE 1
ABERL    EQU   *-ABER        LAENGE DER ARBEITSBEREICHE
         EJECT
***********************************************************************
*                                                                     *
*      DEFINITIONEN FUER EINE NACHRICHTENZEILE.                       *
*                                                                     *
***********************************************************************
         SPACE 3
MESSAGE  DSECT
         SPACE 2
*
*      DEFINITIONEN FUER MSG02.
*
         SPACE 1
         ORG   MESSAGE+4
         DS    CL8
MS2VOLID DS    CL6           VOLUME SERIAL NUMBER
         DS    C
MS2ADR   DS    CL3           UNIT ADDRESS
         DS    CL1
MS2FRCYL DS    CL4           FREE CYLINDERS
         DS    CL1
MS2FRTRK DS    CL4           FREE TRACKS
         DS    CL1
MS2NOEXT DS    CL4           NO. OF EXTENTS
         DS    CL4
MS2MXCYL DS    CL4           CYLINDERS OF LARGES EXTENTS
         DS    CL1
MS2MXTRK DS    CL3           TRACKS OF LARGES EXTENT
         ORG   MESSAGE+66
MESSFLAG DS    CL2           FLAG BYTES
         EJECT
***********************************************************************
*                                                                     *
*      UCB-DEFINITIONEN.                                              *
*                                                                     *
***********************************************************************
         SPACE 3
UCB      DSECT
         DS    CL3
DEVSTAT  DS    C             DEVICE STATUS
         DS    CL9
UCBNAME  DS    CL3           UNIT NAME
         DS    CL2
UCBDVCLS DS    C             DEVICE CLASS
DEVCODE  DS    C             DEVICE CODE
         DS    CL4
UCBVTOC  DS    CL4           REL. ADDR. OF SPACE FOR THIS VOL. (TTR0)
UCBVOLI  DS    CL6           VOLUME SERIAL NUMBER
         SPACE 3
***********************************************************************
*                                                                     *
*      PARAMETERBEREICH.                                              *
*                                                                     *
***********************************************************************
         SPACE 3
         XPARM
PARMENDE EQU   *
         END   SPACE
./ ADD NAME=TCMD
XCMD     START
         REG
         XSAVE R12,SVA,XCMD
         USING PARMAREA,R11
         LR    R11,R1
         SR    R0,R0
         CLC   REG4(4),=CL4'TSO'
         BE    TSO
         CLC   REG4(4),=CL4'ROSC'
         BE    ROSC
         L     R0,REG4
         WTO   'XCMD01I X-CMD ALLOWED ONLY FOR TSO',MCSFLAG=REG0
         B     RETURN
TSO      EQU   *
         L     R8,16
         L     R8,0(R8)
         L     R8,12(R8)
         MVC   ASID+2(2),36(R8)
         OI    ASID+2,X'80'
         L     R0,ASID
ROSC     EQU   *
         MVC   BUF+1(123),TEXT+5
         LA    R1,CMD
         LA    R15,SVCROUT
         SVC   250
RETURN   EQU   *
         XRETURN 0
SVCROUT  EQU   *
         SVC   34
         SVC   3
ASID     DC    F'0'
CMD      DS    0H
         DC    H'104,0'
BUF      DC    CL124' '
         XPARM
         END
./ ADD NAME=TSOSTOP
TSOSTOP  START
         REG
         XSAVE R12,SVA,TSOSTOP
         LR    R11,R1
         USING PARMAREA,R11
         CLC   REG4(4),=CL4'TSO'
         BNE   TSTROSC
         TPUT  MSG5,70
         B     RETURN
TSTROSC  EQU   *
         CLC   REG4(4),=CL4'ROSC'
         BE    RETURN
         CLC   TEXT+7(5),=C',VTAM'
         BNE   TSTTCAM
         MVC   MSG2+41(23),=CL23'-VTAM GESTOPPT.  *****'''
         B     OV1
TSTTCAM  EQU   *
         CLC   TEXT+7(5),=C',TCAM'
         BNE   OV1
         MVC   MSG2+41(23),=CL23'-TCAM GESTOPPT.  *****'''
OV1      EQU   *
         MVC   REPLY,=CL30' '
         XC    ECB,ECB
         WTOR  'TSOSTP1 BITTE GRUND FUER TSOSTOP EINGEBEN',REPLY,30,ECB*
               ,ROUTCDE=2
         WAIT  ECB=ECB
         MVC   MSG2A+23(30),REPLY
         XC    ECB,ECB
         MVC   REPLY,=CL30' '
         WTOR  'TSOSTP2 BITTE DAUER DES TSOSTOPS EINGEBEN',REPLY,30,ECB*
               ,ROUTCDE=2
         WAIT  ECB=ECB
         MVC   MSG2B+23(30),REPLY
         LA    R3,LENTAB
         LA    R4,TIMTAB
NXTTIM   EQU   *
         CALL  TIME,(DBLWD),VL
         MVC   MSG1+29(2),DBLWD
         MVC   MSG1+32(2),DBLWD+3
         LA    R1,MSG1
         SVC   249
         STIMER WAIT,BINTVL=ONESEC
         MVC   MSG2+25(2),4(R4)
         LA    R1,MSG2
         SVC   249
         STIMER WAIT,BINTVL=ONESEC
         LA    R1,MSG2A
         SVC   249
         STIMER WAIT,BINTVL=ONESEC
         LA    R1,MSG2B
         SVC   249
         STIMER WAIT,BINTVL=ONESEC
         LA    R1,MSG3
         SVC   249
         MVC   WTO1+35(2),4(R4)
         WTO   MF=(E,WTO1)
         STIMER WAIT,BINTVL=0(R4)
         LA    R4,8(R4)
         BCT   R3,NXTTIM
         L     R2,16
         L     R2,556(R2)
         LA    R3,524(R2)
         L     R4,516(R2)
ALOOP    EQU   *
         CLI   0(R3),X'00'
         BE    ASCBON
ALOOP1   EQU   *
         LA    R3,4(R3)
         BCT   R4,ALOOP
         B     RETURN
ASCBON   EQU   *
         L     R5,0(R3)
         L     R15,172(R5)
         LTR   R15,R15
         BNZ   ASCBON2
         L     R15,176(R5)
         LTR   R15,R15
         BZ    ALOOP1
ASCBON2  EQU   *
         LR    R6,R15
         CLC   TEXT+7(5),=C',VTAM'
         BE    OV2
         CLC   0(4,R6),=C'TCAM'
         BE    COMMND
OV2      CLC   TEXT+7(5),=C',TCAM'
         BE    ALOOP1
         CLC   0(4,R6),=C'TCAS'
         BNE   ALOOP1
         LA    R1,MODFY
         SVC   249
         STIMER WAIT,BINTVL=BTVL
COMMND   EQU   *
         MVC   CNC(16),CNC1
         MVC   CNC+7(8),0(R6)
         LA    R1,CNC
         SVC   249
         B     ALOOP1
RETURN   XRETURN 0
MSG1     DS    0F
         DC    H'74,0'
         DC    CL70' SE ''*****  ES IST JETZT HH:MM UHR                *
                   *****'''
MSG2     DS    0F
         DC    H'74,0'
         DC    CL70' SE ''*****  IN GENAU 15 MIN. WIRD TSO GESTOPPT.   *
                   *****'''
MSG2A    DS    0F
         DC    H'74,0'
         DC    CL70' SE ''*****  GRUND: 012345678901234567890123456789 *
                   *****'''
MSG2B    DS    0F
         DC    H'74,0'
         DC    CL70' SE ''*****  DAUER: 012345678901234567890123456789 *
                   *****'''
MSG3     DS    0F
         DC    H'74,0'
         DC    CL70' SE ''*****  BITTE MACHEN SIE BIS DAHIN LOGOFF!    *
                   *****'''
MSG5     DC    CL70'TSOSTOP NOT SUPPORTED FROM TSO-TERMINAL'
CNC      DS    0F
         DC    H'16,0'
         DC    CL12' C 12345678 '
CNC1     DS    0F
         DC    H'16,0'
         DC    CL12' C 12345678 '
MODFY    DS    0F
         DC    H'24,0'
         DC    CL20' F TCAS,USER=FSTOP '
BTVL     DC    F'1000'
ONESEC   DC    F'100'
WTO1 WTO 'TSOSPT1 TSO-STOP WILL OCCUR IN XX MINUTES',ROUTCDE=2,DESC=2, *
               MF=L
REPLY    DC    CL30' '
ECB      DC    F'0'
DBLWD    DC    D'0'
TIMTAB   DC    F'30000',CL4'15'
         DC    F'30000',CL4'10'
         DC    F'24000',CL4' 5'
         DC    F'6000',CL4' 1'
LENTAB   EQU   (*-TIMTAB)/8
         XPARM
         END
./ ADD NAME=UNCAT
LUXUNCAT START
         REG
         XSAVE R12,,LUCUNCAT,WORKL
         USING WORK,R13
         USING PARMAREA,R11
         LR    R11,R1
         MVC   CLIST,CLISTX
         LA    R3,DSNAME
         ST    R3,CLIST+4
         MVI   DSNAME,X'40'
         MVC   DSNAME+1(43),DSNAME
         TRT   TEXT+6(45),TRTDEL
         BZ    ERROR
         LA    R2,TEXT+7
         LR    R3,R1
         SR    R3,R2
         EX    R3,MVCEX1
         CLC   0(3,R1),=C',C='
         BNE   UNCAT
         L     R15,16
         TM    116(R15),X'01'
         BNO   NOMVS
         MVC   WTO,MESS9
         L     R0,REG4
         BAL   R14,WTOROUT
         B     RETURN
NOMVS    EQU   *
         MVC   CVOL,3(R1)
         LA    R1,CVOL
         ST    R1,CLIST+8
         OI    CLIST,X'80'
UNCAT    EQU   *
         CATALOG CLIST
         LA    R3,ERRTAB
         AR    R3,R15
         L     R3,0(R3)
         MVC   WTO,0(R3)
         L     R0,REG4
         BAL   R14,WTOROUT
RETURN   EQU   *
         XRETURN ,R
TRTDEL   DC    256XL1'00'
         ORG   TRTDEL+64
         DC    X'40'
         ORG   TRTDEL+107
         DC    C','
         ORG
ERROR    EQU   *
         MVC   WTO,MESS8
         L     R0,REG4
         BAL   R14,WTOROUT
         B     RETURN
WTOROUT  EQU   *
         ST    R14,SAVE14
         LA    R1,WTO
         C     R0,=CL4'ROSC'
         BNE   NOROS
         STM   R14,R12,12(R13)                   SAVE ALL REGS IN SA
*
*              NOW WE CAN ADDRESS DUMMYSECTION IN XMON
*
         LH    R0,0(R1)      LOAD LENGTH OF WTO
         SH    R0,=H'4'      DECREMENT BY 4
         STC   R0,3(R1)      INSERT LENGTH TO MESSAGE FOR USE BY ROSCOE
         LA    R0,3(R1)      LOAD MESSAGE ADDRESS
         L     R13,4(R13)    R13 --> SA IN XMON
         ST    R0,76(R13)    STORE IT IN DYN AREA OF XMON = INAREA
         OI    76(R13),X'80' SET HIGHORDER BIT ON
         L     R15,100(R13)  LOAD ROSCOE-CODE <<OUTCODE>>
         LA    R1,76(R13)    LOAD PARAMETER REGISTER
         L     R13,4(R13)    R13 --> SA IN ROSCOE
         L     R14,12(R13)   LOAD RETURNADDRESS
         LM    R2,R12,28(R13)                    LOAD REMAINDER
         BR    R14           RETURN DIRECT TO ROSCOE
NOROS    EQU   *
         C     R0,=CL4'TSO'
         BNE   DOWTO
         LH    R0,WTO
         SH    R0,=H'4'
         LA    R1,WTO+4
         SVC   93             ****  TPUT ***
         L     R14,SAVE14
         BR    R14
DOWTO    EQU   *
         WTO   MF=(E,WTO)
         L     R14,SAVE14
         BR    R14
MVCEX1   MVC   DSNAME(0),TEXT+6
CLISTX   CAMLST UCATDX,ERRTAB
ERRTAB   DS    0F
         DC    A(MESS1)
         DC    A(MESS2)
         DC    A(MESS3)
         DC    A(0)
         DC    A(MESS4)
         DC    A(MESS5)
         DC    A(MESS6)
         DC    A(MESS7)
MESS1    WTO   'XUNCAT1 SPECIFIED DSNAME HAS BEEN UNCATALOGED',MF=L,   *
               MCSFLAG=REG0
MESS2    WTO   'XUNCAT2 CATALOG VOLUME NOT MOUNTED',MCSFLAG=REG0,MF=L
MESS3    WTO   'XUNCAT3 INCONSISTENT INDEX STRUCTURE',MF=L,            *
               MCSFLAG=REG0
MESS4    WTO   'XUNCAT4 INDEX STRUCTURE DOES NOT EXIST',MF=L,          *
               MCSFLAG=REG0
MESS5    WTO   'XUNCAT5 NO SPACE AVAILABLE IN THE CATALOG DATA SET',   *
               MF=L,MCSFLAG=REG0
MESS6    WTO   'XUNCAT6 INPROPERLY NAMED GENERATION DATA GROUP',       *
               MF=L,MCSFLAG=REG0
MESS7    WTO   'XUNCAT7 PERM. I/O ERROR',MF=L,MCSFLAG=REG0
MESS8    WTO   'XUNCAT8 SYNTAX ERROR',MCSFLAG=REG0,MF=L
MESS9    WTO   'XUNCAT9 CVOL SPECIFIC. NOT ALLOWED IN MVS',            *
               MCSFLAG=REG0,MF=L
         XPARM
WORK     DSECT
SVA      DS    18F
SAVE14   DS    F
WTO      DS    CL80
CLIST    DS    CL12
DSNAME   DS    CL44
CVOL     DS    CL6
WORKL    EQU   *-WORK
         END
./ ADD NAME=VTOC
         TITLE 'XVTOC                             X-COMMAND VTOC'
VTOC     CSECT
         SPACE 3
***********************************************************************
*                                                                     *
*      PROGRAM-ID. VTOC.                                              *
*      AUTHOR. EHNERT.                                                *
*      INSTALLATION. BAYER AG, LEVERKUSEN, RECHENZENTRUM.             *
*      DATE-WRITTEN. 24. 3. 1975.                                     *
*      REMARKS.                                                       *
*                                                                     *
*          DAS X-COMMAND 'VTOC' GIBT INFORMATIONEN UEBER DIE          *
*          VTOC'S DER ALS PARAMETER SPEZIFIZIERTEN VOLUMES AUS.       *
*                                                                     *
*          ALS PARAMETER KOENNEN BIS ZU ZEHN VOLSER-MASKEN ANGE-      *
*          GEBEN WERDEN, MIT DEREN HILFE EINE AUSWAHL DER VOLUMES     *
*          GETROFFEN WIRD. DABEI STEHT '*' FUER JEDES ZEICHEN AN      *
*          DIESER STELLE.                                             *
*                                                                     *
***********************************************************************
         EJECT
***********************************************************************
*                                                                     *
*      BEGINN DER VERARBEITUNG.                                       *
*                                                                     *
***********************************************************************
         SPACE 3
*
*      SICHERN DER REGISTER,
*      SPEICHERPLATZANFORDERUNG FUER ARBEITSBEREICHE,
*      ZUORDNUNG DER BASISREGISTER.
*
         SPACE 1
         XSAVE R12,,VTOC,ABERL
         SPACE 1
         LR    R11,R1        BASISREG. FUER DSECT PARMAREA INITIALIS.
         USING UCB,R3        BASISREG. FUER DSECT UCB ZUORDNEN
         USING MESSAGE,R10   BASISREG. FUER DSECT MESSAGE ZUORDNEN
         USING PARMAREA,R11  BASISREG. FUER DSECT PARMAREA ZUORDNEN
         USING ABER,R13      BASISREG. FUER DSECT ABER ZUORDNEN
         EJECT
*
*      INITIALISIERUNG DER SPEICHER.
*
         SPACE 1
         MVC   CAMOBT(CAMLEN),CAMCOBT CAMLIST-MACRO UEBERTRAGEN
         MVI   FNDBYTE,X'00' SCHALTER LOESCHEN
         MVI   MVSBYTE,X'00' SCHALTER LOESCHEN
         MVI   WTORBYTE,X'FF' SCHALTER SETZEN
         LA    R2,CCHHR      ADRESSE DES CCHHR-FELDES LADEN
         LA    R3,VOLSERNO   ADRESSE DER VOLSER NUMBER LADEN
         LA    R4,CAMWKFLD   ADRESSE VON CAMWKFLD LADEN
         STM   R2,R4,CADRCCHH ADRESSEN IN CAMOBT SPEICHERN
         LA    R2,ENDTAB1    ENDADRESSEN DER
         LA    R3,ENDTPVOL       TABELLEN LADEN
         STM   R2,R3,ADDRETB1    UND SPEICHERN
         MVC   UCMID,REG4    UCM-ID. DES AUFRUFERS UEBERTRAGEN
         SPACE 2
*
*      FLAG BYTS IN NACHRICHTENBEREICHEN SETZEN.
*
         SPACE 1
         LA    R10,MSGTAB    ADRESSE DER TABELLE LADEN
         ST    R10,SAVE1R10      UND SPEICHERN
         L     R3,ADDRETB1   ENDADRESSE DER TABELLEN LADEN
CLEARMSS EQU   *
         MVC   MESSFLAG,=X'FFFF' FLAG BYTES SETZEN
         LA    R10,72(R10)   R10 ERHOEHEN
         CR    R10,R3        ENDE DER TABELLEN ERREICHT ?
         BL    CLEARMSS      NEIN, VERZWEIGEN
         EJECT
***********************************************************************
*                                                                     *
*      VERARBEITUNG DER EINGABEPARAMETER.                             *
*                                                                     *
***********************************************************************
         SPACE 3
         LA    R4,TEXT+4     R4 INITIALISIEREN
         LA    R8,PARMENDE   ENDADRESSE DES PARAMETERBEREICHS LADEN
         CLI   0(R4),C','    PARAMETER ANGEGEBEN ?
         BNE   FEHLPARM      NEIN, VERZW. ZUR FEHLERROUTINE
         LA    R6,TABPVOL1   ADRESSE DER VOLSER-TABELLE LADEN
NEXTPARM EQU   *
         SR    R5,R5         R5 LOESCHEN
         LR    R7,R4         ADRESSE DES TRENNUNGSZEICHENS LADEN
NXTBYTE  EQU   *
         LA    R4,1(R4)      R4 ERHOEHEN
         CR    R4,R8         PARAMETERBEREICH UEBERSCHRITTEN ?
         BNL   FEHLPARM      JA, VERZW. ZUR FEHLERROUTINE
         CLI   0(R4),C','    ENDE DES PARAMETERS ERREICHT ?
         BE    NEXTPVOL      JA, VERZWEIGEN
         CLI   0(R4),X'00'   ENDE DER PARAMETERKETTE ERREICHT ?
         BE    NEXTPVOL      JA, VERZWEIGEN
         CLI   0(R4),C' '    ENDE DER PARAMETERKETTE ERREICHT ?
         BE    NEXTPVOL      JA, VERZWEIGEN
         LA    R5,1(R5)      R5 ERHOEHEN
         CLI   0(R4),C'*'    BELIEBIGES ZEICHEN AN DIESER STELLE ?
         BNE   NXTBYTE       NEIN, VERZWEIGEN
         MVI   0(R4),X'FF'   ZEICHEN UMSETZEN
         B     NXTBYTE       VERZWEIGEN
         EJECT
NEXTPVOL EQU   *
         C     R6,ADDRETPV   TABELLENENDE UEBERSCHRITTEN ?
         BNL   FEHLPARM      JA, VERZWEIGEN
         C     R5,=F'6'      LAENGE DER VOLID GUELTIG ?
         BH    FEHLPARM      NEIN, VERZW. ZUR FEHLERROUTINE
         LTR   R5,R5         VOLID ANGEGEBEN ?
         BZ    FEHLPARM      NEIN, VERZW. ZUR FEHLERROUTINE
         BCTR  R5,0          R5 UM EINS VERMINDERN
         EX    R5,MOVEPVOL   VERZW. ZUR UEBERTR. DER VOLSER NUMBER
         CH    R5,=H'5'
         BNE   NOMNT
         LA    R1,1(R6)
         CALL  MSSMNT,((R1)),VL
NOMNT    EQU   *
         STC   R5,0(R6)      LAENGENANGABE IN TABELLE EINTRAGEN
         LA    R6,7(R6)      R6 ERHOEHEN
         CLI   0(R4),C','    FOLGEN WEITERE PARAMETER ?
         BE    NEXTPARM      JA, VERZWEIGEN
         SPACE 2
*
*      ABSCHLUSS DER PARAMETERVERARBEITUNG.
*
         SPACE 1
         MVI   0(R6),X'80'   TABELLENENDE SPEZIFIZIEREN
         MVC   TABPVOL2,TABPVOL1 VOLSER-TABELLE KOPIEREN
         LA    R6,TABPVOL2-1 ADRESSE DER TABELLE LADEN
NEXTFF   EQU   *
         LA    R6,1(R6)      R6 ERHOEHEN
         CLI   0(R6),X'80'   TABELLENENDE ERREICHT ?
         BE    GETUCB        JA, VERZWEIGEN
         CLI   0(R6),X'FF'   TABELLENZEICHEN = X'FF' ?
         BNE   NEXTFF        NEIN, VERZWEIGEN
         MVI   0(R6),X'00'   TABELLENZEICHEN UMSETZEN
         B     NEXTFF        VERZWEIGEN
         EJECT
***********************************************************************
*                                                                     *
*      VERARBEITUNG DER UCB-INFORMATIONEN.                            *
*                                                                     *
***********************************************************************
         SPACE 3
GETUCB   EQU   *
         L     R2,16         ADRESSE DER CVT LADEN
         TM    116(R2),X'01' SYSTEM = OS/VS2 (MVS) ?
         BZ    *+8           NEIN, VERZWEIGEN
         MVI   MVSBYTE,X'FF' FLAG BYTE SETZEN
         DROP  R11           R11 FREIGEBEN
NEXTUCB  EQU   *
         UCBSCAN DEVTYPE=DASD,STATUS=ONLINE
         LTR   R15,R15
         BNZ   ABSCHLUS
         LR    R3,R1
         TM    DEVSTAT,X'10' EINHEIT IM UNLOAD ?
         BO    NEXTUCB       JA, VERZWEIGEN
         CLC   UCBVOLI,=XL6'0' VOLID VORHANDEN ?
         BE    NEXTUCB       NEIN, VERZWEIGEN
         EJECT
*
*      VERGLEICH MIT SPEZIFIZIERTEN VOLSER NUMBERS.
*
         SPACE 1
         SR    R5,R5         R5 LOESCHEN
         LA    R6,TABPVOL1-7 ADRESSE DER VOLSER-TABELLE LADEN
         LA    R7,TABPVOL2-7 ADRESSE DER VOLSER-TABELLE LADEN
NXTVOLID EQU   *
         LA    R6,7(R6)      R6 ERHOEHEN
         LA    R7,7(R7)      R7 ERHOEHEN
         TM    0(R6),X'80'   TABELLENENDE ERREICHT ?
         BO    NEXTUCB       JA, VERZWEIGEN
         IC    R5,0(R6)      LAENGENANGABE LADEN
         MVC   ZWVOLID1,UCBVOLI VOLSER NUMBER UEBERTRAGEN
         MVC   ZWVOLID2,UCBVOLI VOLSER NUMBER UEBERTRAGEN
         EX    R5,NCVOLID1   VERZW. ZUR UEBERLAGERUNG DER VOLID
         EX    R5,OCVOLID2   VERZW. ZUR UEBERLAGERUNG DER VOLID
         CLC   ZWVOLID1,ZWVOLID2 VOLID = AUSGEW. VOLID ?
         BNE   NXTVOLID      VERZW., WENN VOLID ^= AUSGEW. VOLID
         MVC   VOLSERNO,UCBVOLI VOLSER NUMBER UEBERTRAGEN
         MVI   FNDBYTE,X'FF' FLAG BYTE SETZEN
         EJECT
***********************************************************************
*                                                                     *
*      CCHHR DER VTOC BERECHNEN.                                      *
*                                                                     *
***********************************************************************
         SPACE 3
         SR    R4,R4         R4 LOESCHEN
         IC    R4,DEVCODE    DEVICE CODE LADEN
         SLA   R4,2          DEVICE CODE * 4
         LA    R5,TABTCAP    ADRESSE DER TABTCAP-TABELLE LADEN
         AR    R5,R4         R5 ERHOEHEN
         CLI   0(R5),X'80'   DEVICE RESERVED ?
         BE    FEHLDEVC      JA, VERZW. ZUR FEHLERROUTINE
         LH    R6,0(R5)      TABELLENELEMENTEHN
         LH    R7,2(R5)          LADEN UND
         STM   R6,R7,TRKPCYL     SPEICHERN
         LH    R6,UCBVTOC    REL. ADRESSE DER VTOC LADEN
         CLI   MVSBYTE,X'FF' FLAG BYTE GESETZT ?
         BE    *+8           JA, VERZWEIGEN
         LH    R6,SRTEFSCT   REL. ADRESSE DER VTOC LADEN
         SRDA  R6,32         R6 --> R7
         D     R6,TRKPCYL    DIV. TT / SPECIFIC TRACKS/CYLINDER
         STH   R7,CCHHR      CC-ADRESSE DER VTOC SPEICHERN
         STH   R6,CCHHR+2    HH-ADRESSE DER VTOC SPEICHERN
         MVI   CCHHR+4,X'01' R-ADRESSE DER VTOC SPEICHERN
         EJECT
***********************************************************************
*                                                                     *
*      DSCB4 LESEN UND AUSWERTEN.                                     *
*                                                                     *
***********************************************************************
         SPACE 3
         OBTAIN CAMOBT       DSCB4 LESEN
         LTR   R15,R15       RETURN CODE = 0 ?
         BNZ   FEHLOBT       NEIN, VERZWEIGEN
         CLI   DS4FMTID,C'4' DSCB = DSCB4 ?
         BNE   FEHLDSCB      NEIN, VERZWEIGEN
         SPACE 1
         L     R10,SAVE1R10  R10 INITIALISIEREN
         MVC   MESSAGE(LENMSG02),MSG02 NACHRICHTENZEILE UEBERTRAGEN
         MVC   MS2VOLID,UCBVOLI VOLSER NUMBER UEBERTRAGEN
         MVC   MS2IX,=CL2'NO'
         MVC   MS2ADR,UCBNAME UNIT NAME UEBERTRAGEN
         UNPK  MS2CCHH(3),CCHHR+1(2) CC-ADRESSE UEBERTRAGEN
         UNPK  MS2CCHH+2(3),CCHHR+3(2) HH-ADRESSE UEBERTRAGEN
         MVI   MS2CCHH+4,C' '
         TR    MS2CCHH,TABHEXA-240 ADRESSE AUFBEREITEN
         LH    R5,DS4NOATK   ANZ. DER ALT. TRACKS REM. LADEN
         L     R4,NOALTRK    ANZ. DER ALTERNATE TRACKS LADEN
         SR    R4,R5         ANZ. BENUTZTER ALTERN. TRACKS BERECHNEN
         BAL   R14,CONVDEC   VERZW. ZUM UMWANDELN IN DEZIMALZAHL
         MVC   MS2ATRK,ZWFELD+11 ANZ. ALT. TRACKS UEBERTRAGEN
         BAL   R14,ALOTRK    VERZW. ZUM BERECHNEN DER ALLOCATED TRACKS
         SR    R4,R4         R4 LOESCHEN
         IC    R4,DS4DEVDT   ANZ. DER DSCBS PRO TRACK LADEN
         MR    R6,R4         ANZ. DER ALLOCATED DSCBS BERECHNEN
         LR    R4,R7         ANZ. DER ALLOCATED DSCBS LADEN
         ST    R4,NODSCBS         UND SPEICHERN
         C     R4,=F'9999'   ANZ. DER ALLOC. DSCBS > 9999 ?
         BH    *+14          JA, VERZWEIGEN
         BAL   R14,CONVDEC   VERZW. ZUM UMWANDELN IN DEZIMALZAHL
         MVC   MS2DSCB,ZWFELD+11 ANZ. DER ALLOC. DSCBS UEBERTR.
         MVC   SVVTOCI,DS4VTOCI
         TM    SVVTOCI,X'01'
         BO    IXDVTOC
         SH    R4,DS4DSREC
IXDVTOC  EQU   *
         ST    R4,HIGHWATM   HIGH WATER MARK SPEICHERN
         MVI   VSAMBYTE,X'00' FLAG BYTE LOESCHEN
         EJECT
         TM    DS4VSCID,X'C0' VSAM INDICATORS ?
         BZ    NOVSAM        NEIN, VERZWEIGEN
         MVI   VSAMBYTE,X'01' FLAG BYTE SETZEN
         UNPK  MS2VSTMS(9),DS4VSTMS(5) TIMESTAMP UEBERTRAGEN
         UNPK  MS2VSTMS+8(9),DS4VSTMS+4(5) TIMESTAMP UEBERTRAGEN
         MVI   MS2VSTMS+16,C' '
         TR    MS2VSTMS,TABHEXA-240 TIMESTAMP AUFBEREITEN
NOVSAM   EQU   *
         BAL   R14,GETDSCBS  VERZW. ZUM BERECHNEN DER BEN. DSCBS
         TM    VSAMBYTE,X'FF' VSAM ?
         BZ    MSG02OK       NEIN, VERZWEIGEN
         TM    VSAMBYTE,X'10' MASTER CATALOG ?
         BZ    *+14          NEIN, VERZWEIGEN
         MVC   MS2FLAGS,=C'MCAT' MASTER CATALOG SPEZIFIZIEREN
         B     MSG02OK       VERZWEIGEN
         TM    VSAMBYTE,X'08' USER CATALOG ?
         BZ    *+14          NEIN, VERZWEIGEN
         MVC   MS2FLAGS,=C'UCAT' USER CATALOG SPEZIFIZIEREN
         B     MSG02OK       VERZWEIGEN
         TM    VSAMBYTE,X'04' VSAM DATASET ?
         BZ    *+14          NEIN, VERZWEIGEN
         MVC   MS2FLAGS,=C'DSET' VSAM DATASET SPEZIFIZIEREN
         B     MSG02OK       VERZWEIGEN
         TM    VSAMBYTE,X'02' VSAM SPACE ?
         BZ    *+14          NEIN, VERZWEIGEN
         MVC   MS2FLAGS,=C'DSPC' VSAM SPACE SPEZIFIZIEREN
         B     MSG02OK       VERZWEIGEN
         MVC   MS2FLAGS,=C'CAND'
MSG02OK  EQU   *
         C     R4,=F'9999'   ANZ. DER BENUTZTEN DSCBS > 9999 ?
         BH    *+14          JA, VERZWEIGEN
         BAL   R14,CONVDEC   VERZW. ZUM UMWANDELN IN DEZIMALZAHL
         MVC   MS2USED,ZWFELD+11 ANZ. DER BENUTZTEN DSCBS UEBERTR.
         TM    SVVTOCI,X'01'
         BNO   NOIXD
         MVC   MS2IX,=CL2'IX'
NOIXD    EQU   *
         LA    R14,NEXTUCB   RUECKSPRUNGADRESSE LADEN
         MVC   MESSFLAG,=XL6'0' FLAG BYTES LOESCHEN
         LA    R10,72(R10)   R10 ERHOEHEN
         C     R10,ADDRETB1  ENDE DER TABELLE UEBERSCHRITTEN ?
         BNL   AUSMSGM       JA, VERZWEIGEN
         ST    R10,SAVE1R10  LAUFENDE ADRESSE SPEICHERN
         BR    R14           VERZWEIGEN
         EJECT
***********************************************************************
*                                                                     *
*      BERECHNUNG DER ALLOCATED TRACKS.                               *
*                                                                     *
***********************************************************************
         SPACE 3
ALOTRK   EQU   *
         MVC   DBWORD,DS4VTOCE+2 EXTENT-BESCHREIBUNG UEBERTRAGEN
         LH    R4,DBWORD+6   HH-ADRESE DES EXTENT-ENDES LADEN
         LH    R5,DBWORD     CC-ADRESE DES EXTENT-BEGINNS LADEN
         LH    R6,DBWORD+2   HH-ADRESE DES EXTENT-BEGINNS LADEN
         LH    R7,DBWORD+4   CC-ADRESE DES EXTENT-ENDES LADEN
         CR    R4,R6         R4 ^< R6 ?
         BNL   *+10          JA, VERZWEIGEN
         A     R4,TRKPCYL    R4 UM ANZ. TRACKS/CYLINDER ERHOEHEN
         BCTR  R7,0          R7 UM EINS VERMINDERN
         LA    R4,1(R4)      R4 UM EINS ERHOEHEN
         SR    R7,R5         ANZ. DER ALLOCATED CYLINDERS BERECHNEN
         SR    R4,R6         ANZ. DER ALLOCATED TRACKS BERECHNEN
         SR    R6,R6         R6 LOESCHEN
         M     R6,TRKPCYL    MULT. MIT ANZ. TRACKS/CYLINDER
         AR    R7,R4         ANZ. ALLOCATED TRACKS ADDIEREN
         BR    R14           VERZWEIGEN
         EJECT
***********************************************************************
*                                                                     *
*      BERECHNUNG DER BENUTZTEN DSCBS.                                *
*                                                                     *
***********************************************************************
         SPACE 3
GETDSCBS EQU   *
         ST    R14,SAVE1R14  RUECKSPRUNGADRESSE SICHERN
         L     R8,NODSCBS    ANZ. DER ALLOCATED DSCBS LADEN
         L     R7,HIGHWATM   HIGH WATER MARK LADEN
         BCTR  R7,0          R7 UM EINS VERMINDERN
         LA    R6,1          DSCB-ZAEHLER INITIALISIEREN
         LA    R4,1          R4 INITIALISIEREN
         MVC   MTRKNO,DS4DEVSZ+2 MAX. SPURADRESSE SPEICHERN
         XC    MRECNO,MRECNO MRECNO LOESCHEN
         MVC   MRECNO+1(1),DS4DEVDT MAX. SATZADRESSE LADEN
NEXTDSCB EQU   *
         LA    R6,1(R6)      DSCB-ZAEHLER ERHOEHEN
         CR    R6,R8         HIGH WATER MARK UEBERSCHRITTEN ?
         BH    LOOPENDE      JA, VERZWEIGEN
         SR    R5,R5         R5 LOESCHEN
         IC    R5,CCHHR+4    LFD. SATZADRESSE LADEN
         LA    R5,1(R5)      SATZADRESSE ERHOEHEN
         CH    R5,MRECNO     SPUR UEBERSCHRITTEN ?
         BNH   NEXTREC       NEIN, VERZWEIGEN
         LH    R5,CCHHR+2    LFD. SPURADRESSE LADEN
         LA    R5,1(R5)      SPURADRESSE ERHOEHEN
         CH    R5,MTRKNO     ZYLINDER UEBERSCHRITTEN ?
         BL    NEXTTRK       NEIN, VERZWEIGEN
         LH    R5,CCHHR      LFD. ZYLINDERADRESSE LADEN
         LA    R5,1(R5)      ZYLINDERADRESSE ERHOEHEN
         STH   R5,CCHHR      NEUE ZYLINDERADRESSE SPEICHERN
         SR    R5,R5         NEUE SPURADRESSE = 0
NEXTTRK  EQU   *
         STH   R5,CCHHR+2    NEUE SPURADRESSE SPEICHERN
         LA    R5,1          NEUE SATZADRESSE = 1
NEXTREC  EQU   *
         STC   R5,CCHHR+4    NEUE SATZADRESSE SPEICHERN
         OBTAIN CAMOBT       NAECHSTEN DSCB LESEN
         LTR   R15,R15       RETURN CODE = 0 ?
         BNZ   FEHLOBT       NEIN, VERZW. ZUR FEHLERROUTINE
         CLI   DS4FMTID,X'00' DUMMY DSCB ?
         BE    NEXTDSCB      JA, VERZWEIGEN
         LA    R4,1(R4)      ANZ. BENUTZTER DSCBS ERHOEHEN
         CLI   DS4FMTID,C'1' DSCB = DSCB1 ?
         BNE   RETFLOOP      NEIN, VERZWEIGEN
         TM    VSAMBYTE,X'FF' VSAM ?
         BZ    RETFLOOP      NEIN, VERZWEIGEN
         EJECT
         CLC   CAMWKFLD(9),=C'VSAMDSET.'
         BNE   *+12          NEIN, VERZWEIGEN
         OI    VSAMBYTE,X'04' VSAM DATASET
         BCT   R7,NEXTDSCB   VERZWEIGEN
         CLC   CAMWKFLD(17),=C'Z9999992.VSAMDSPC'
         BNE   *+12          NEIN, VERZWEIGEN
         OI    VSAMBYTE,X'02' VSAM SPACE
         BCT   R7,NEXTDSCB   VERZWEIGEN
         CLC   CAMWKFLD(17),=C'Z9999994.VSAMDSPC'
         BNE   *+12          NEIN, VERZWEIGEN
         OI    VSAMBYTE,X'08' USER CATALOG
         BCT   R7,NEXTDSCB   VERZWEIGEN
         CLC   CAMWKFLD(17),=C'Z9999996.VSAMDSPC'
         BNE   RETFLOOP      NEIN, VERZWEIGEN
         OI    VSAMBYTE,X'10' MASTER CATALOG
RETFLOOP EQU   *
         BCT   R7,NEXTDSCB   VERZWEIGEN
LOOPENDE EQU   *
         L     R14,SAVE1R14  RUECKSPRUNGADRESSE LADEN
         BR    R14           VERZWEIGEN
         EJECT
***********************************************************************
*                                                                     *
*      ABSCHLUSSROUTINEN.                                             *
*                                                                     *
***********************************************************************
         SPACE 3
ABSCHLUS EQU   *
         FREEMAIN R,SP=125    SPEICHERPLATZ FREIGEBEN
         MVI   WTORBYTE,X'00' FLAG BYTE LOESCHEN
         CLI   FNDBYTE,X'FF' VOLUME(S) GEFUNDEN ?
         BE    AUSRMSGN      JA, VERZWEIGEN
         L     R0,UCMID      UCM-ID. DES AUFRUFERS LADEN
         LA    R1,MSG03
         BAL   R14,WTOROUT
         B     ENDE          VERZWEIGEN
         SPACE 2
*
*      AUSGABE NOCH OFFENER INFO-NACHRICHTEN.
*
         SPACE 1
AUSRMSGN EQU   *
         LA    R10,MSGTAB    ADRESSE DER TABELLE LADEN
         CLC   MESSFLAG,=XL6'0' SIND NOCH NACHRICHTEN OFFEN ?
         BNE   ENDE          NEIN, VERZWEIGEN
         BAL   R14,AUSMSGM   JA, VERZW. ZUR NACHRICHTENAUSGABE
         EJECT
*
*      SPEICHERPLATZFREIGABE,
*      REINITIALISIERUNG DER REGISTER UND
*      RUECKSPRUNG ZUM AUFRUFENDEN PROGRAMM.
*
         SPACE 1
ENDE     EQU   *
         XRETURN ,R
WTOROUT  EQU   *
         ST    R14,SAVE14
         C     R0,=CL4'ROSC'
         BNE   NOROS
         STM   R14,R12,12(R13)                   SAVE ALL REGS IN SA
*
*              NOW WE CAN ADDRESS DUMMYSECTION IN XMON
*
         LH    R0,0(R1)      LOAD LENGTH OF WTO
         SH    R0,=H'4'      DECREMENT BY 4
         STC   R0,3(R1)      INSERT LENGTH TO MESSAGE FOR USE BY ROSCOE
         LA    R0,3(R1)      LOAD MESSAGE ADDRESS
         L     R13,4(R13)    R13 --> SA IN XMON
         ST    R0,76(R13)    STORE IT IN DYN AREA OF XMON = INAREA
         OI    76(R13),X'80' SET HIGHORDER BIT ON
         L     R15,100(R13)  LOAD ROSCOE-CODE <<OUTCODE>>
         LA    R1,76(R13)    LOAD PARAMETER REGISTER
         L     R13,4(R13)    R13 --> SA IN ROSCOE
         L     R14,12(R13)   LOAD RETURNADDRESS
         LM    R2,R12,28(R13)                    LOAD REMAINDER
         BR    R14           RETURN DIRECT TO ROSCOE
NOROS    EQU   *
         C     R0,=CL4'TSO'
         BNE   DOWTO
         LH    R0,0(R1)
         SH    R0,=H'4'
         LA    R1,4(R1)
         SVC   93             TPUT
         L     R14,SAVE14
         BR    R14
DOWTO    EQU   *
         WTO   MF=(E,(1))
         L     R14,SAVE14
         BR    R14
***********************************************************************
*                                                                     *
*      FEHLERROUTINEN.                                                *
*                                                                     *
***********************************************************************
         SPACE 3
*
*      ROUTINE BEI FEHLER IN DER PARAMETERKETTE.
*
         SPACE 1
FEHLPARM EQU   *
         L     R0,UCMID      UCM-ID. DES AUFRUFERS LADEN
         LA    R1,MSG04
         BAL   R14,WTOROUT
         B     ENDE          VERZWEIGEN
         SPACE 2
*
*      ROUTINE BEI OBTAIN-FEHLER (RC ^= 0).
*
         SPACE 1
FEHLOBT  EQU   *
         LA    R10,FEHLTAB   R10 INITIALISIEREN
         MVC   MESSAGE(LENMSG06),MSG06 NACHRICHTENZEILE UEBERTRAGEN
         MVC   MS6VOLI,UCBVOLI VOLSER NUMBER UEBERTRAGEN
         LR    R4,R15        RETURN CODE IN R4 LADEN
         BAL   R14,CONVDEC   VERZW. ZUM UMWANDELN IN DEZIMALZAHL
         MVC   MS6RC,ZWFELD+13 RETURN CODE UEBERTRAGEN
         L     R0,UCMID      UCM-ID. DES AUFRUFERS LADEN
         LA    R1,MESSAGE
         BAL   R14,WTOROUT
         B     NEXTUCB       VERZWEIGEN
         EJECT
*
*      ROUTINE BEI RESERVED DEVICES.
*
         SPACE 1
FEHLDEVC EQU   *
         LA    R10,FEHLTAB   R10 INITIALISIEREN
         MVC   MESSAGE(LENMSG05),MSG05 NACHRICHTENZEILE UEBERTRAGEN
         UNPK  MS5DEVC(3),DEVCODE(2) DEVICE CODE UEBERTRAGEN
         TR    MS5DEVC,TABHEXA-240 DEVICE CODE AUFBEREITEN
         MVC   MS5VOLI,UCBVOLI VOLSER NUMBER UEBERTRAGEN
         L     R0,UCMID      UCM-ID. DES AUFRUFERS LADEN
         LA    R1,MESSAGE
         BAL   R14,WTOROUT
         B     NEXTUCB       VERZWEIGEN
         SPACE 2
*
*      ROUTINE BEI DSCB-FEHLER (1.DSCB ^= DSCB4).
*
         SPACE 1
FEHLDSCB EQU   *
         LA    R10,FEHLTAB   R10 INITIALISIEREN
         MVC   MESSAGE(LENMSG07),MSG07 NACHRICHTENZEILE UEBERTRAGEN
         MVC   MS7VOLI,UCBVOLI VOLSER NUMBER UEBERTRAGEN
         L     R0,UCMID      UCM-ID. DES AUFRUFERS LADEN
         LA    R1,MESSAGE
         BAL   R14,WTOROUT
         B     NEXTUCB       VERZWEIGEN
         EJECT
***********************************************************************
*                                                                     *
*      AUSGABE DER NACHRICHTEN.                                       *
*                                                                     *
***********************************************************************
         SPACE 3
AUSMSGM  EQU   *
         ST    R14,SAVE1R14  RUECKSPRUNGADRESSE SICHERN
         L     R0,UCMID      UCM-ID. DES AUFRUFERS LADEN
         LA    R1,MSG01
         BAL   R14,WTOROUT
         LA    R10,MSGTAB-72 ADRESSE DER TABELLE LADEN
         L     R9,ADDRETB1   ENDADRESSE DER TABELLE LADEN
         BAL   R14,AUSGABE   VERZW. ZUR AUSGABE WEITERER ZEILEN
         LA    R10,MSGTAB    ADRESSE DER TABELLE LADEN
         ST    R10,SAVE1R10      UND SPEICHERN
         L     R14,SAVE1R14  RUECKSPRUNGADRESSE LADEN
         CLC   UCMID(4),=CL4'TSO'
         BER   R14
         CLI   WTORBYTE,X'FF' FLAG BYTE GESETZT ?
         BNER  R14           NEIN, VERZWEIGEN
NXTREPLY EQU   *
         XC    ECB,ECB       EVENT CONTROL BLOCK LOESCHEN
         L     R0,UCMID      UCM-ID. DES AUFRUFERS LADEN
         LA    R4,ECB        ADRESSE DES ECB LADEN
         LA    R5,REPLY      ADRESSE DES REPLY LADEN
         MVC   WTOR(LENMSG08),MSG08 NACHRICHTENZEILE UEBERTRAGEN
         WTOR  ,(R5),1,(R4),MF=(E,WTOR)
         SPACE 1
         WAIT  ECB=ECB       AUF REPLY WARTEN
         CLI   REPLY,C'N'    REPLY = NO ?
         BE    ENDE          JA, VERZWEIGEN
         CLI   REPLY,C'Y'    REPLY = YES ?
         BNE   NXTREPLY      NEIN, VERZWEIGEN
         L     R14,SAVE1R14  RUECKSPRUNGADRESSE LADEN
         BR    R14           VERZWEIGEN
         EJECT
*
*      AUSGABE EINZELNER NACHRICHTENZEILEN.
*
         SPACE 1
AUSGABE  EQU   *
         ST    R14,SAVE2R14  RUECKSPRUNGADRESSE SICHERN
NEXTMESS EQU   *
         LA    R10,72(R10)   R10 ERHOEHEN
         CR    R10,R9        ENDE DER TABELLE ERREICHT ?
         BNL   ENDMESS       JA, VERZWEIGEN
         CLC   MESSFLAG,=X'FFFF' FLAG BYTES GESETZT ?
         BE    ENDMESS       JA, VERZWEIGEN
         MVC   MESSFLAG,=X'FFFF' FLAG BYTES SETZEN
         L     R0,UCMID      UCM-ID. DES AUFRUFERS LADEN
         LA    R1,MESSAGE
         BAL   R14,WTOROUT
         B     NEXTMESS      VERZWEIGEN
ENDMESS  EQU   *
         L     R14,SAVE2R14  RUECKSPRUNGADRESSE LADEN
         BR    R14           VERZWEIGEN
         EJECT
***********************************************************************
*                                                                     *
*      UMWANDLUNG VON DUALZAHLEN IN ENTPACKTE DEZIMALZAHLEN.          *
*                                                                     *
***********************************************************************
         SPACE 3
CONVDEC  EQU   *
         CVD   R4,DBWORD     INHALT VON R4 UMWANDELN
         UNPK  ZWFELD,DBWORD DEZIMALZAHL ENTPACKEN
         OI    ZWFELD+14,C'0' VORZEICHEN MODIFIZIEREN
         BR    R14           VERZWEIGEN
         SPACE 3
***********************************************************************
*                                                                     *
*      BEFEHLE, DIE MIT HILFE DES EXECUTE-BEFEHLS AUSGEFUEHRT WERDEN. *
*                                                                     *
***********************************************************************
         SPACE 3
MOVEPVOL EQU   *
         MVC   1(0,R6),1(R7) VOLID IN TABELLE UEBERTRAGEN
NCVOLID1 EQU   *
         NC    ZWVOLID1(0),1(R6) VOLID UEBERLAGERN
OCVOLID2 EQU   *
         OC    ZWVOLID2(0),1(R7) VOLID UEBERLAGERN
         EJECT
***********************************************************************
*                                                                     *
*      REGISTER EQUATES.                                              *
*                                                                     *
***********************************************************************
         SPACE 3
R0       EQU   0             MACRO- UND-PARAMETER REGISTER
R1       EQU   1             MACRO- UND-PARAMETER REGISTER
R2       EQU   2             POINTER IN CVT / UCB LOOKUP TABLE
R3       EQU   3             POINTER FUER UCB
R4       EQU   4             ARBEITSREGISTER
R5       EQU   5             ARBEITSREGISTER
R6       EQU   6             ARBEITSREGISTER
R7       EQU   7             ARBEITSREGISTER
R8       EQU   8             ARBEITSREGISTER
R9       EQU   9             ARBEITSREGISTER
R10      EQU   10            POINTER IN NACHRICHTEN-TABELLEN
R11      EQU   11            BASISREG. FUER DSECT PARMAREA / VEKTOR
R12      EQU   12            BASISREG. FUER CSECT VTOC
R13      EQU   13            BASISREG. FUER DSECT ABER
R14      EQU   14            RUECKSPRUNGADRESSEN
R15      EQU   15            CSECT-ADRESSEN UND RETURN CODES
         EJECT
***********************************************************************
*                                                                     *
*      DEFINITION DER KONSTANTEN-SPEICHER.                            *
*                                                                     *
***********************************************************************
         SPACE 3
*
*      CAMLIST-MACRO (KONSTANTEN).
*
         SPACE 1
CAMCOBT  CAMLST SEEK,0,0,0
CAMLEN   EQU   *-CAMCOBT     LAENGE DES CAMLIST-MACROS
         SPACE 2
*
*      TABELLE FUER AUFBEREITUNG VON HEXADEZIMALZAHLEN.
*
         SPACE 1
TABHEXA  DC    C'0123456789ABCDEF'
         EJECT
*
*      TRACKS / CYLINDER UND ALTERNATE TRACKS.
*
         SPACE 1
TABTCAP  DS     0H
         DC     X'80',XL3'0'  00 - RESERVED
         DC     X'80',XL3'0'  01 - 2311    DISK STORAGE DEVICE
         DC     X'80',XL3'0'  02 - 2301    PARALLEL DRUM
         DC     X'80',XL3'0'  03 - 2303    SERIAL DRUM
         DC     X'80',XL3'0'  04 - 2302    DISK STORAGE
         DC     X'80',XL3'0'  05 - 2321    DATA CELL DRIVE
         DC     H'08',H'001'  06 - 2305/1  FIXED HEAD STORAGE / MODEL 1
         DC     H'08',H'001'  07 - 2305/2  FIXED HEAD STORAGE / MODEL 2
         DC     X'80',XL3'0'  08 - 2314    DISK STORAGE FACILITY
         DC     H'19',H'133'  09 - 3330/1  DISK STORAGE / MODEL 1
         DC     H'12',H'012'  0A - 3340    DISK STORAGE
         DC     H'30',H'150'  0B - 3350    DISK STORAGE
         DC     X'80',XL3'0'  0C - RESERVED
         DC     H'19',H'133'  0D - 3330/11 DISK STORAGE / MODEL 11
         DC     H'15',H'015'  0E - 3380    DISK STORAGE
         DC     X'80',XL3'0'  0F - RESERVED
         EJECT
***********************************************************************
*                                                                     *
*      DEFINITION DER AUSGABENACHRICHTEN.                             *
*                                                                     *
***********************************************************************
         SPACE 3
MSG01    WTO   'XVTOC01 VOLSER ADR CCHH DSCB USED ATRK IX VSAM ---TIMES*
               TAMP----     ',                                         *
               MF=L,MCSFLAG=(REG0)
         SPACE 1
MSG02    WTO   'XVTOC02 VOLSER ADR 0000 **** **** 0000                 *
                            ',                                         *
               MF=L,MCSFLAG=(REG0)
LENMSG02 EQU   *-MSG02
         SPACE 1
MSG03    WTO   'XVTOC03 SPECIFIED VOLUME(S) NOT FOUND',                *
               MF=L,MCSFLAG=(REG0)
         SPACE 1
MSG04    WTO   'XVTOC04 INVALID PARAMETER LIST',                       *
               MF=L,MCSFLAG=(REG0)
         EJECT
MSG05    WTO   'XVTOC05 VOLSER=123456, DEVICE FAILURE, DEVCODE=99',    *
               MF=L,MCSFLAG=(REG0)
LENMSG05 EQU   *-MSG05
         SPACE 1
MSG06    WTO   'XVTOC06 VOLSER=123456, OBTAIN FAILURE, RC=99',         *
               MF=L,MCSFLAG=(REG0)
LENMSG06 EQU   *-MSG06
         SPACE 1
MSG07    WTO   'XVTOC07 VOLSER=123456, 1. DSCB NOT FORMAT 4',          *
               MF=L,MCSFLAG=(REG0)
LENMSG07 EQU   *-MSG07
         SPACE 1
MSG08    WTOR  'XVTOC08 REPLY ''Y'' (YES) OR ''N'' (NO) TO CONTINUE',  *
               MF=L,MCSFLAG=(REG0)
LENMSG08 EQU   *-MSG08
         EJECT
***********************************************************************
*                                                                     *
*      DEFINITION DER ARBEITSBEREICHE.                                *
*                                                                     *
***********************************************************************
         SPACE 3
ABER     DSECT
SAVEAREA DS    18F           SAVEAREA FUER ALLGEMEINE REGISTER
SAVE14   DS    F
         SPACE 2
*
*      ADRESSEN-SPEICHER.
*
         SPACE 1
ADDRETB1 DS    F             ENDADRESSE DER MSG-NACHRICHTEN-TABELLE
ADDRETPV DS    F             ENDADRESSE DER VOLSER-TABELLE
SAVE1R10 DS    F             SAVEAREA1 FUER R10
SAVE1R14 DS    F             SAVEAREA1 FUER R14
SAVE2R14 DS    F             SAVEAREA2 FUER R14
UCMID    DS    F             UCM-ID. DES AUFRUFERS
         SPACE 2
*
*      ARBEITSSPEICHER.
*
         SPACE 1
DBWORD   DS    D             ZWISCHENSPEICHER
ZWFELD   DS    CL15          ZWISCHENSPEICHER FUER DEZIMALZAHLEN
FNDBYTE  DS    C             SCHALTER FUER GEFUNDENE VOLUMES
MVSBYTE  DS    C             SCHALTER FUER SYSTEM = MVS
VSAMBYTE DS    C             SCHALTER FUER VSAM
WTORBYTE DS    C             SCHALTER FUER WTOR
SVVTOCI  DS    C
REPLY    DS    C             SPEICHER FUER REPLY
VOLSERNO DS    CL6           ZWISCHENSPEICHER FUER VOLSER NUMBER
ZWVOLID1 DS    CL6           ZWISCHENSPEICHER FUER VOLSER NUMBER
ZWVOLID2 DS    CL6           ZWISCHENSPEICHER FUER VOLSER NUMBER
TRKPCYL  DS    F             TRACKS PRO CYLINDER
NOALTRK  DS    F             ANZAHL DER ALLOCATED DSCBS
HIGHWATM DS    F             HIGH WATER MARK DER USED DSCBS
NODSCBS  DS    F             HIGH WATER MARK FUER ANZ. DER DSCBS
ECB      DS    F             EVENT CONTROL BLOCK
WTOR     DS    15F           BEREICH FUER WTOR-NACHRICHT
MRECNO   DS    H             MAX. SATZADRESSE
MTRKNO   DS    H             MAX. SPURADRESSE
         EJECT
*
*      CAMLIST-MACRO (ARBEITSBEREICH).
*
         SPACE 1
CAMOBT   DS    0F
         DS    C             AL1(192)
         DS    C             AL1(128)
         DS    C             AL1(0)
         DS    C             AL1(0)
CADRCCHH DS    F             A(CCHHR)
CADRUCBV DS    F             A(UCBVOLI)
CADRCAMW DS    F             A(CAMWKFLD)
         DS    0H
CCHHR    DS    CL5           CCHHR-ADRESSE DES NAECHSTEN DSCB
         DS    0D
CAMWKFLD DS    CL148         WORK FIELD
         SPACE 2
*
*      DSCB4-DEFINITIONEN.
*
         SPACE 1
         ORG   CAMWKFLD
WKDSCB4  DS    0CL148        DATA SET CONTROL BLOCK FORMAT 4
         DS    CL44
DS4FMTID DS    C             FORMAT IDENTIFIER (=C'1')
         DS    CL5
DS4DSREC DS    CL2           NUMBER OF AVAILABLE FORMAT 0 DSCBS
         DS    CL4
DS4NOATK DS    CL2           NUMBER OF ALTERNATE TRACKS REMAINING
DS4VTOCI DS    X             VTOC-INDICATORS
         DS    CL3
DS4DEVSZ DS    CL4           DEVICE SIZE
         DS    CL8
DS4DEVDT DS    C             NUMBER OF DSCBS PER TRACK
         DS    C
DS4VSTMS DS    CL8           VSAM TIMESTAMP
DS4VSCID DS    C             VSAM CATALOG INDICATOR
         DS    CL20
DS4VTOCE DS    CL10          VTOC EXTENT
         DS    CL25
         EJECT
*
*      MASKEN-TABELLEN FUER VOLSER NUMBERS AUS DEM PARAMETERBEREICH.
*
*      AUFBAU DER TABELLE:
*      BYTE1 - LAENGE DES ANGEGEBENEN VOLSER-PARAMETERS ODER
*          X'80' BEI TABELLENENDE
*      BYTES2-7 - ANFANGSZEICHEN DER VOLSER NUMBER UND MASKENZEICHEN
*
         SPACE 1
TABPVOL1 DS    10CL7         TABELLE MIT MASKENZEICHEN X'FF'
ENDTPVOL EQU   *
         DS    CL7
TABPVOL2 DS    CL77          TABELLE MIT MASKENZEICHEN X'00'
         SPACE 2
*
*      NACHRICHTEN-BEREICHE.
*
*      AUFBAU:
*      BYTE1-66: WTO-NACHRICHTENZEILE
*      BYTE67-68: X'0000', WENN NACHRICHTENZEILE VERFUEGBAR
*
         SPACE 1
         DS    0F
MSGTAB   DS    10CL72        TABELLE FUER NACHRICHTEN
ENDTAB1  EQU   *
FEHLTAB  DS    CL72          TABELLE FUER FEHLERNACHRICHTEN
         SPACE 1
ABERL    EQU   *-ABER        LAENGE DER ARBEITSBEREICHE
         EJECT
***********************************************************************
*                                                                     *
*      DEFINITIONEN FUER EINE NACHRICHTENZEILE.                       *
*                                                                     *
***********************************************************************
         SPACE 3
MESSAGE  DSECT
         SPACE 2
*
*      DEFINITIONEN FUER MSG02.
*
         SPACE 1
         ORG   MESSAGE+4
         DS    CL8
MS2VOLID DS    CL6           VOLUME SERIAL NUMBER
         DS    C
MS2ADR   DS    CL3           UNIT ADDRESS
         DS    C
MS2CCHH  DS    CL4           CCHH-ADRESSE DER VTOC
         DS    C
MS2DSCB  DS    CL4           AVAILABLE DSCBS
         DS    C
MS2USED  DS    CL4           USED DSCBS
         DS    C
MS2ATRK  DS    CL4           USED ALTERNATE TRACKS
         DS    C
MS2IX    DS    CL2
         DS    C
MS2FLAGS DS    CL4           VSAM FLAGS
         DS    C
MS2VSTMS DS    CL16          VSAM TIMESTAMP
         EJECT
*
*      DEFINITIONEN FUER MSG05.
*
         SPACE 1
         ORG   MESSAGE+4
         DS    CL15
MS5VOLI  DS    CL6           VOLUME SERIAL NUMBER
         DS    CL26
MS5DEVC  DS    CL2           DEVICE CODE
         SPACE 2
*
*      DEFINITIONEN FUER MSG06.
*
         SPACE 1
         ORG   MESSAGE+4
         DS    CL15
MS6VOLI  DS    CL6           VOLUME SERIAL NUMBER
         DS    CL21
MS6RC    DS    CL2           RETURN CODE
         SPACE 2
*
*      DEFINITIONEN FUER MSG07.
*
         SPACE 1
         ORG   MESSAGE+4
         DS    CL15
MS7VOLI  DS    CL6
         SPACE 2
         ORG   MESSAGE+66
MESSFLAG DS    CL2           FLAG BYTES
         EJECT
***********************************************************************
*                                                                     *
*      UCB-DEFINITIONEN.                                              *
*                                                                     *
***********************************************************************
         SPACE 3
UCB      DSECT
         DS    CL3
DEVSTAT  DS    C             DEVICE STATUS
         DS    CL9
UCBNAME  DS    CL3           UNIT NAME
         DS    CL2
UCBDVCLS DS    C             DEVICE CLASS
DEVCODE  DS    C             DEVICE CODE
         DS    CL4
UCBVTOC  DS    CL4           REL. ADDR. OF VTOC FOR THIS VOL. (TTR0)
UCBVOLI  DS    CL6           VOLUME SERIAL NUMBER
         ORG   UCB+36
SRTEFSCT DS    CL4           REL. ADDR. OF VTOC (MVT + VS2, REL.1)
         SPACE 3
***********************************************************************
*                                                                     *
*      PARAMETERBEREICH.                                              *
*                                                                     *
***********************************************************************
         SPACE 3
         XPARM
PARMENDE EQU   *
         END   VTOC
./ ADD NAME=XCNTRL
XCNTRLVS CSECT
         PRINT NOGEN
         XSAVE R12,,XCNTRLVS,WORKLX
         USING WORKX,R13
         L     R1,16
         L     R1,X'C4'(R1)
         L     R1,X'80'(R1)
         LTR   R1,R1
         BZ    NOIPL
         LA    R15,IPLSVC
         SVC   250
         B     NOIPL
IPLSVC   EQU   *
         MVI   1(R1),X'FF'
         BR    R14
NOIPL    EQU   *
         EXTRACT ANSWER,FIELDS=COMM
         L     R3,ANSWER
         LA    R3,4(R3)
         QEDIT ORIGIN=(R3)
         EXTRACT ANSWER,FIELDS=COMM
         L     R3,ANSWER
         LA    R3,4(R3)
         QEDIT ORIGIN=(R3),CIBCTR=5
         L     R3,ANSWER
WAITX    EQU   *
         L     R1,0(R3)
         WAIT  ECB=(1)
         EXTRACT ANSWER,FIELDS=COMM
         L     R6,ANSWER
         L     R6,4(R6)
CONT     EQU   *
         XR    R7,R7        LOAD CALLERS CON ID
         IC    R7,12(R6)    INTO REG 7.
         L     R3,=V(CONID) STORE CON ID
         ST    R7,0(R3)     INTO STAI-EXIT FOR ABEND MSG
         CLI   4(R6),X'40'
         BE    RETURN
         LH    R3,14(R6)
         LTR   R3,R3
         BNP   WAIT
         MVC   MODULENM,=CL8'X '
         BCTR  R3,0
         MVI   ZWI,X'40'
         MVC   ZWI+1(127),ZWI
         EX    R3,MVCEX2
         LR    R8,R6
* SEARCH L-OPERAND FOR DEDICATED CONID
         LA    R6,ZWI+4
         MVI   LCONID,X'00'
NEXTPOS  EQU   *
         LA    R4,ZWI+127
         SR    R4,R6     COMPUTE TRT-LENGTH
         SR    R1,R1     ERASE R1 FOR TRT
         LH    R2,=H'64' INSERT BLANK FOR END CONDITION
         EX    R4,TRTEX2
         CH    R2,=H'64' END OF REQUEST-MSG?
         BE    ENDSRCH
         CLC   1(2,R1),=C'L='
         BNE   WEITER
         CLI   5(R1),C'Z'
         BNE   WEITER
         CLI   6(R1),C','
         BE    *+12
         CLI   6(R1),C' '
         BNE   WEITER
         TM    3(R1),X'F0'
         BNO   WEITER
         TM    4(R1),X'F0'
         BNO   WEITER
         PACK  DBLWORD,3(2,R1)
         CVB   R4,DBLWORD
         STC   R4,LCONID     DESTINATION CONSOLE
         MVC   0(6,R1),=CL6' '
         B     ENDSRCH
WEITER   EQU   *
         LA    R6,1(R1)
         B     NEXTPOS
ENDSRCH  EQU   *
         LA    R6,ZWI-12
         LA    R1,17(R3,R6)
         EX    R3,TRTEX1
         LA    R5,16(R6)
         SR    R1,R5
         LTR   R1,R1
         BNP   WAIT
         CH    R1,=H'7'       MODULENAME MAX 8 CHAR
         BNH   *+8
         LH    R1,=H'7'
         BCTR  R1,0
         EX    R1,MVCEX1
ATTACH   EQU   *
* ISSUE BLDL FOR THE REQUESTED MODULE NAME
         BLDL  0,BLDLIST      ISSUE BLDL FOR DATA SET IN STEPLIB
         LTR   R15,R15        BLDL RETURN CODE = 0?
         BZ    ATTMOD         BR
* ISSUE ERROR MSG
ERRORMSG EQU   *
         MVC   MSGAREA,ERRMSGL  MOVE MSG SKELETON
         MVC   MSGMODNM(7),MODULENM+1
         SR    R0,R0          CLEAR R0 FOR IC
         IC    R0,12(,R8)     INSERT CONSOLE ID
         WTO   MF=(E,MSGAREA) ISSUE ERROR MSG
         B     WAIT           BR
ATTMOD   GETMAIN R,LV=128,SP=127
         MVC   4(124,R1),ZWI+4
         XC    0(4,R1),0(R1)
         MVC   3(1,R1),12(R8)
         CLI   LCONID,X'00'    L=..Z SPECIFIED?
         BE    *+10            NO.
         MVC   3(1,R1),LCONID  YES.
         ATTACH DE=MODULENM,STAI=(EXIT),GSPV=127
WAIT     EQU   *
         L     R3,ANSWER
         LA    R3,4(R3)
         L     R5,0(R3)
         QEDIT ORIGIN=(R3),BLOCK=(R5)
         EXTRACT ANSWER,FIELDS=COMM
         L     R3,ANSWER
         L     R6,4(R3)
         LA    R6,0(R6)
         LTR   R6,R6
         BZ    WAITX
         B     CONT
RETURN   EQU   *
         L     R15,16
         L     R15,0(R15)
         L     R15,4(R15)
         L     R15,136(R15)
         LA    R11,0(R15)
         LTR   R11,R11
         BZ    EXITRET
SWITCH   NOP   STORE
         XC    ECB,ECB
         MVC   REPLY,=CL3' '
         L     R7,=V(CONID)  INSERT CON ID
         L     R0,0(R7)
         WTOR  'XCNTRL1 REPLY ''YES'' OR ''NO'' TO STOP XCNTRL WITH ACT*
               IVE SUBTASKS',REPLY,3,ECB,MCSFLAG=(REG0)
         WAIT  ECB=ECB
         OC    REPLY,=CL3' '
         CLC   REPLY,=CL3'NO'
         BNE   TSTYES
         L     R3,ANSWER
         LA    R3,4(R3)
         QEDIT ORIGIN=(R3),CIBCTR=5
         B     WAIT
TSTYES   EQU   *
         CLC   REPLY,=CL3'YES'
         BNE   SWITCH
         MVI   SWITCH+1,X'F0'
STORE    EQU   *
         ST    R11,ANSWER
         DETACH ANSWER
         B     RETURN
EXITRET  EQU   *
         XRETURN 0,R
*
ERRMSGL  WTO   'XCNTRL3 MODULE AAAAAAA  NOT FOUND',                    *
               MCSFLAG=REG0,MF=L
MVCEX1   MVC   MODULENM+1(0),16(R6)
MVCEX2   MVC   ZWI+4(0),16(R6)
TRTEX1   TRT   16(0,R6),TRTAB
TRTEX2   TRT   00(0,R6),TRTAB
TRTAB    DC    256XL1'00'
         ORG   TRTAB+64
         DC    X'40'
         ORG   TRTAB+107
         DC    X'6B'
         ORG
         REG
ANSWER   DS    F
BLDLIST  DS    0CL62          BUILD LIST
BLDLFF   DC    H'0001'        NUMBER OF ENTRIES
BLDLLL   DC    H'0058'        LENGTH OF EACH ENTRY
MODULENM DS    CL8            MEMBER NAME
BLDLTTR  DS    CL3            MEMBER STARTING LOCATION
BLDLK    DS    CL1            CONCATENATION NUMBER
BLDLZ    DS    CL1            SOURCE OF DIRECTORY ENTRY
BLDLC    DS    CL1            NUMBER OF USER DATA HALFWORDS
BLDLUH   DS    22H            22 USER DATA HALFWORDS
ECB      DS    F
REPLY    DS    CL3
         LTORG
WORKX    DSECT
         DS    18F
LCONID   DS    C
DBLWORD  DS    D
MSGAREA  DS    0CL53             MSG AREA FOR ERROR MSG
         DS    CL4               RDW
         DS    CL15              'XCNTRL3 MODULE '
MSGMODNM DS    CL8               MODULE NAME
         DS    CL26              ' NOT FOUND IN XCMD LIBRARY'
*
         DS    0D
ZWI      DS    CL128
WORKLX   EQU   *-WORKX
         EJECT
EXIT     CSECT
         XSAVE R12,,EXIT,WORKL
         USING WORK1,R13
         LA    R15,12
         CR    R0,R15
         BNE   CROK
         LR    R3,R1
         B     CRNOK
CROK     EQU   *
         L     R3,4(R1)
CRNOK    EQU   *
         SLL   R3,8
         SRL   R3,8
         LR    R4,R3
         SLL   R4,20
         SRL   R4,20
         CR    R4,R3
         BNE   SYS
         CVD   R3,DBLWD
         UNPK  CC,DBLWD
         OI    CC+2,X'F0'
         B     DETACH
SYS      EQU   *
         SRL   R3,12
         ST    R3,DBLWD
         UNPK  CC(4),DBLWD(5)
         TR    CC,CCTAB-240
DETACH   EQU   *
         MVC   WTO1(CCTAB-MESS8),MESS8
         MVC   WTO1+39(3),CC
         CR    R0,R15
         BE    MOVNONAM
         TM    88(R1),X'40'  MODULE NAME OR RB ADDRESS?
         BO    MOVNAM        NO ADDRESS
MOVNONAM EQU   *
         MVC   WTO1+17(8),=CL8'NO NAME'
         B     WTO1XIT
MOVNAM   EQU   *
         MVC   WTO1+17(7),89(R1)
WTO1XIT  EQU   *
         L     R0,CONID        TAKE LATEST USER
         WTO   MF=(E,WTO1)
         XRETURN 0,R
MESS8    WTO   'XCNTRL2 TASK 1234567  ABENDED. CC= XXX',MF=L,          *
               MCSFLAG=(REG0)
CCTAB    DC    C'0123456789ABCDEF'
CONID    DC    A(0)         LATEST CON ID
         ENTRY CONID
         LTORG
WORK1    DSECT
SVA1     DS    18F
WTO1     DS    CL50
DBLWD    DS    D
CC       DS    CL3
         DS    X
WORKL    EQU   *-WORK1
         END
./ ADD NAME=XMSSMNT
//Z227128M JOB (6685,128,1),FRANZ,MSGCLASS=T,
//     CLASS=R,NOTIFY=Z227128
//MSSMNT EXEC ASMFCL
//ASM.SYSIN DD *
XMSSMNT  CSECT
         XSAVE R12,SVA,XMSSMNT
         REG
         LR    R11,R1
         USING PARMAREA,R11
         MVC   VOLSER,TEXT+7
         SPACE 2
         CLC   =CL4'TSO',REG4   IS THIS A TSO CALL
         BNE   ALLOC            NO, ASSUME CONSOLE COMMAND
         SPACE
         L     R1,16            A(CVT)
         L     R1,0(R1)         A(TCBPTR)
         L     R1,4(R1)         A(CURRENT = OWN TCB)
         L     R1,12(R1)        A(TIOT)
         CLC   0(4,R1),=CL4'Z227' JOBNAME
         BE    ALLOC            AUTHORIZE UIDS STARTING WITH Z227
         SPACE
         CLC   =CL3'VV0',VOLSER
         BE    ALLOC
         CLC   =CL3'VVM',VOLSER
         BE    ALLOC
         CLC   =CL3'VVN',VOLSER
         BNE   TPUT3
         SPACE 2
ALLOC    EQU   *
         CALL  LUALLOC,(ALCSTR,ALCLEN,ALCMSG,ALCMDEF),VL
         LTR   R15,R15
         BNZ   PUTALERR
         SPACE 2
         TIOTSCAN DDNAME
         LTR   R15,R15
         BZ    NOTFND
         SR    R8,R8        SAVE POINTER
         ICM   R8,3,18(R15) TO UCB
         SPACE 2
         CALL  LUFREE,(ALCSTR,ALCLEN,ALCMSG,ALCMDEF),VL
         LTR   R15,R15
         BNZ   PUTALERR
         SPACE 2
         CLC   REG4(4),=CL4'TSO'
         BE    TPUT
         L     R0,REG4
         MVC   WTO+41(3),13(R15)
         MVC   WTO+23(6),VOLSER
         MVC   WTO+41(3),13(R8)     MOVE UNIT ADDRESS
WTO      WTO   'MSSMNT1 VOLUME 123456 MOUNTED ON CUU',MCSFLAG=REG0
         B     RETURN
TPUT     EQU   *
         MVC   TSOMSG+33(3),13(R8)  MOVE UNIT ADDRESS
         MVC   TSOMSG+15(6),VOLSER  AND VOLSER TO MESSAGE
         TPUT  TSOMSG,50            TELL TSO-USER MOUNT COMPLETE
RETURN   EQU   *
         XRETURN 0
NOTFND   EQU   *
         CLC   REG4(4),=CL4'TSO'
         BE    TPUT1
         MVC   WTO1+23(6),VOLSER
         L     R0,REG4
WTO1     WTO   'MSSMNT2 VOLUME 123456 NOT MOUNTED',MCSFLAG=REG0
         B     RETURN
TPUT1    EQU   *
         MVC   TSOMSG1+15(6),VOLSER
         TPUT  TSOMSG1,50
TPUT3    EQU   *
         TPUT  TSOMSG2,79
         B     RETURN
PUTALERR EQU   *
         CLC   =CL4'TSO',REG4
         BE    TPUTERR
         MVC   WTOLIST+14(80),ALCMSG+80
         L     R0,REG4
         WTO   MF=(E,WTOLIST)
         MVC   WTOLIST+14(80),ALCMSG+160
         L     R0,REG4
         WTO   MF=(E,WTOLIST)
         B     RETURN
         SPACE 2
TPUTERR  EQU   *
         TPUT  ALCMSG+80,79
         TPUT  ALCMSG+160,79
         B     RETURN
         SPACE
WTOLIST  WTO   'MSSNTALC 0....5...20....5...30....5...40....5...50....5*
               ...60....5...70....5...80....5...90    ',MCSFLAG=REG0,  *
               MF=L
ALCSTR   DC    C'DDNAME='
DDNAME   DC    CL8'MSSMNT',C',DSN=MSSMNT,'
         DC    C',UNIT=3330V,VOL=SER='
VOLSER   DC    CL6' '
         DC    C',DISP=SHR'
ALCEND   EQU   *
         DS    0H
ALCLEN   DC    AL2(ALCEND-ALCSTR)
ALCMSG   DC    CL240' '
ALCMDEF  DC    CL16'WTP=NO,LMSG=YES'
TSOMSG   DC    CL50'MSSMNT1 VOLUME 123456 MOUNTED ON CUU'
TSOMSG1  DC    CL50'MSSMNT2 VOLUME 123456 NOT MOUNTED'
TSOMSG2  DC    CL80'MSSMNT3 VIA TSO ONLY VOLS STARTING WITH VV0, VVM UN*
               D VVN CAN BE MOUNTED'
         LTORG
         XPARM
         END
//LKED.SYSLMOD DD DSN=LU.LNKLIB(XMSSMNT),DISP=SHR
//
./ ADD NAME=FASID
         TITLE 'FASID                            FIND ASID OR JOBNAME'
FASID    CSECT
         SPACE 3
***********************************************************************
*                                                                     *
*      IDENTIFICATION DIVISION.                                       *
*                                                                     *
*      PROGRAM-ID. FASID.                                             *
*      AUTHOR. EHNERT.                                                *
*      INSTALLATION. BAYER AG, LEVERKUSEN, RECHENZENTRUM.             *
*      DATE-WRITTEN. 8.7.1974.                                        *
*      REMARKS.                                                       *
*          DAS PROGRAMM FASID IST EIN UNTERPROGRAMM ZU DEN X-COMMANDS.*
*          ES SUCHT ZU EINEM VORGEGEBENEN JOBNAMEN DIE ADRESS-SPACE-  *
*          IDENTIFICATION UNTER DER VORAUSSETZUNG, DASS DAS DAFUER    *
*          VORGESEHENE FELD = X'0000' IST.                            *
*              SOLLEN JOB- UND STEPNAMEN ZU EINER VORGEGEBENEN ASID   *
*          GESUCHT WERDEN, SO MUSS DER BEREICH FUER DEN JOBNAMEN      *
*          BLANKS ENTHALTEN.                                          *
*                                                                     *
*              DAS PROGRAMM ERWARTET IN REGISTER 1 DIE ADRESSE EINES  *
*          PARAMETERBEREICHES MIT FOLGENDEM AUFBAU:                   *
*          1)  DIE 4-BYTE-ADRESSE EINES HALBWORTS FUER DIE ASID       *
*          2)  DIE 4-BYTE-ADRESSE EINES 8-BYTE-BEREICHES FUER DEN     *
*              JOBNAMEN                                               *
*          3)  DIE 4-BYTE-ADRESSE EINES 8-BYTE-BEREICHES FUER DEN     *
*              STEPNAMEN. DAS ERSTE BIT DIESES ADRESSENBEREICHES MUSS *
*              GESETZT SEIN, UM DIE ADRESSE DES STEPNAMEN ALS LETZTEN *
*              PARAMETER IDENTIFIZIEREN ZU KOENNEN.                   *
*                                                                     *
*              DAS PROGRAMM WIRD MIT FOLGENDEN RETURN-CODES BEENDET:  *
*          RC = 0:  DIE VERARBEITUNG WURDE ERFOLGREICH BEENDET.       *
*          RC = 8:  GESUCHTE JOB- UND STEPNAMEN ODER GESUCHTE ASID    *
*                   WURDEN NICHT GEFUNDEN, ODER DAS SYSTEM IST NICHT  *
*                   VS2,REL2.                                         *
*          RC = 16: EIN FEHLER IN DER PARAMETERKETTE ODER BEI DER     *
*                   ADRESSIERUNG WURDE ENTDECKT.                      *
*                                                                     *
***********************************************************************
         EJECT
***********************************************************************
*                                                                     *
*      PROCEDURE DIVISION.                                            *
*                                                                     *
***********************************************************************
         SPACE 3
*
*      SICHERN DER REGISTER UND ZUORDNUNG DES BASISREGISTERS.
*
         SPACE 2
         SAVE  (14,12),,*    REGISTER SICHERN
         LR    R12,R15       BASISREGISTER INITIALISIEREN
         USING FASID,R12     BASISREGISTER ZUORDNEN
         SPACE 3
*
*      PARAMETERLISTE PRUEFEN.
*
         SPACE 2
         TM    0(R1),X'80'   ERSTER PARAMETER = LETZTE ADRESSE ?
         BO    RETURN16      JA, VERZWEIGEN ZUM ABSCHLUSS
         TM    4(R1),X'80'   ZWEITER PARAMETER = LETZTE ADRESSE ?
         BO    RETURN16      JA, VERZWEIGEN ZUM ABSCHLUSS
         TM    8(R1),X'80'   DRITTER PARAMETER = LETZTE ADRESSE ?
         BNO   RETURN16      NEIN, VERZWEIGEN ZUM ABSCHLUSS
         SPACE 1
         LM    R2,R4,0(R1)   ADRESSEN DER PARAMETER LADEN
         SPACE 1
         LTR   R2,R2         ADRESSE DER ASID GUELTIG ?
         BZ    RETURN16      NEIN, VERZWEIGEN ZUM ABSCHLUSS
         LTR   R3,R3         ADRESSE DES JOBNAMEN GUELTIG ?
         BZ    RETURN16      NEIN, VERZWEIGEN ZUM ABSCHLUSS
         LA    R4,0(R4)      ERSTES BYTE IN R4 LOESCHEN
         LTR   R4,R4         ADRESSE DES STEPNAMEN GUELTIG ?
         BZ    RETURN16      NEIN, VERZWEIGEN ZUM ABSCHLUSS
         EJECT
*
*      GUELTIGKEIT DER PARAMETER PRUEFEN.
*
         SPACE 2
         LH    R7,0(R2)      ASID LADEN
         LTR   R7,R7         ASID VORGEGEBEN ?
         BZ    GJN           NEIN, VERZWEIGEN
         SPACE 1
         CLC   0(8,R3),=CL8' ' JOBNAME VORGEGEBEN ?
         BNE   RETURN16      JA, VERZW., DA ASID UND JOBN. GEGEBEN
         SPACE 1
         B     FASVT         VERZW. ZUM AUFSUCHEN DER ASVT
         SPACE 1
GJN      EQU   *
         CLC   0(8,R3),=CL8' ' JOBNAME VORGEGEBEN ?
         BE    RETURN16      NEIN, VERZW.,DA ASID & JOBN. NICHT GEGEBEN
         SPACE 3
*
*      AUFSUCHEN DER ASVT.
*
         SPACE 2
FASVT    EQU   *
         L     R5,16         ADRESSE DER CVT LADEN
         TM    116(R5),X'01' SYSTEM = MVS ?
         BZ    RETURN16      NEIN, VERZW. ZUM ABSCHLUSS
         SPACE 1
         L     R5,556(R5)    ADRESSE DER ASVT LADEN
         CLC   512(4,R5),=CL4'ASVT' ASVT ?
         BNE   RETURN16      NEIN, VERZW. ZUM ABSCHLUSS
         SPACE 1
         LA    R5,524(R5)    POINTER AUF ASCB-ADRESSEN LADEN
         EJECT
*
*      DURCHLAUFEN DER ASCB-KETTE.
*
         SPACE 2
SCHLEIFE EQU   *
         LA    R5,4(R5)      POINTER AUF NAECHSTE ASCB-ADRESSE LADEN
         SR    R6,R6         R6 LOESCHEN
         ICM   R6,7,1(R5)    ADRESSE DES ASCB LADEN
         BZ    RETURN8       BEI ENDE DER ASCB'S ZUM ABSCHLUSS VERZW.
         SPACE 1
         TM    0(R5),X'80'   ASID VERFUEGBAR ?
         BO    SCHLEIFE      NEIN, VERZWEIGEN
         SPACE 1
         CLC   0(4,R6),=CL4'ASCB' ASCB ?
         BNE   RETURN16      NEIN, VERZW. ZUM ABSCHLUSS
         SPACE 1
         LM    R8,R9,172(R6) ADRESSEN DER JOBNAMEN LADEN
         CH    R7,36(R6)     ASID'S GLEICH ?
         BE    MAS           JA, VERZWEIGEN
         SPACE 1
         CLC   0(8,R8),0(R3) JOBNAME = 1.JOBNAME ?
         BE    STASID        JA, VERZW. ZUM UEBERTRAGEN DER ASID
         SPACE 1
         CLC   0(8,R9),0(R3) JOBNAME = 2.JOBNAME ?
         BNE   SCHLEIFE      NEIN, VERZW. ZUR SCHLEIFE
         SPACE 3
*
*      ASID UEBERTRAGEN.
*
         SPACE 2
STASID   EQU   *
         LH    R7,36(R6)     ASID LADEN
         STH   R7,0(R2)      ASID SPEICHERN
         EJECT
*
*      ROUTINE BEI MASTER-SCHEDULER.
*
         SPACE 2
MAS      EQU   *
         CLI   0(R9),C'*'    '*MASTER*' ODER '*AUXSTM*' ?
         BNE   NOMAS         NEIN, VERZW. ZU WEITEREN ABFRAGEN
         SPACE 1
         MVC   0(8,R3),0(R9) NAME UEBERTRAGEN
         MVC   0(8,R4),=CL8' ' STEPNAME = ' '
         B     RETURN0       VERZWEIGEN ZUM ABSCHLUSS
         SPACE 3
*
*      ROUTINE BEI INITIATOR.
*
         SPACE 2
NOMAS    EQU   *
         L     R10,56(R6)    ADRESSE DES CSCB LADEN
         CLI   28(R10),X'03' INITIATOR ?
         BNE   NOINIT        NEIN, VERZW. ZU WEITEREN ABFRAGEN
         SPACE 1
         LTR   R8,R8         ERSTE ADRESSE = 0 ?
         BZ    RETURN8       JA, VERZW. ZUM ABSCHLUSS
         SPACE 1
         MVC   0(8,R3),0(R8) JOBNAME UEBERTRAGEN
         LA    R0,8          R0 = 8
         SLR   R8,R0         R8 ZEIGT AUF CSCB
         CLC   32(8,R8),=CL8' ' PROCSTEPNAME = ' ' ?
         BE    *+14          JA, VERZWEIGEN
         SPACE 1
         MVC   0(8,R4),32(R8) PROCSTEPNAME UEBERTRAGEN
         B     RETURN0       VERZWEIGEN ZUM ABSCHLUSS
         SPACE 1
         MVC   0(8,R4),64(R8) STEPNAME UEBERTRAGEN
         B     RETURN0       VERZWEIGEN ZUM ABSCHLUSS
         EJECT
*
*      ROUTINE BEI STARTED TASK.
*
         SPACE 2
NOINIT   EQU   *
         CLI   28(R10),X'02' STARTED TASK ?
         BNE   NOTASK        NEIN, VERZW. ZU WEITEREN ABFRAGEN
         SPACE 1
         MVC   0(8,R3),16(R10) TASKNAME UEBERTRAGEN
         CLC   32(8,R10),=CL8' ' PROCSTEPNAME = ' ' ?
         BE    *+14          JA, VERZWEIGEN
         SPACE 1
         MVC   0(8,R4),32(R10) PROCSTEPNAME UEBERTRAGEN
         B     RETURN0       VERZWEIGEN ZUM ABSCHLUSS
         SPACE 1
         MVC   0(8,R4),8(R10) STEPNAME UEBERTRAGEN
         B     RETURN0       VERZWEIGEN ZUM ABSCHLUSS
         SPACE 3
*
*      ROUTINE BEI TSO-USER.
*
         SPACE 2
NOTASK   EQU   *
         CLI   28(R10),X'01' TSO USER ?
         BNE   RETURN16      NEIN, VERZW. ZUM ABSCHLUSS
         SPACE 1
         MVC   0(8,R3),8(R10) TSO-USERID UEBERTRAGEN
         MVC   0(8,R4),16(R10) PROCNAME UEBERTRAGEN
         EJECT
*
*      ABSCHLUSS.
*
         SPACE 2
RETURN0  EQU   *
         RETURN (14,12),RC=0
         SPACE 1
RETURN8  EQU   *
         RETURN (14,12),RC=8
         SPACE 1
RETURN16 EQU   *
         RETURN (14,12),RC=16
         EJECT
*
*      REGISTER EQUATES.
*
         SPACE 2
R0       EQU   0
R1       EQU   1             ENTHAELT ADRESSE DES PARAMETERBEREICHES
R2       EQU   2             ENTHAELT ADRESSE DER ASID
R3       EQU   3             ENTHAELT ADRESSE DES JOBNAMEN
R4       EQU   4             ENTHAELT ADRESSE DES STEPNAMEN
R5       EQU   5             ENTHAELT ADRESSE DER ASCB-ADRESSE
R6       EQU   6             ENTHAELT ADRESSE DES ASCB
R7       EQU   7             ENTHAELT ASID
R8       EQU   8             ENTHAELT ADRESSE DES ERSTEN JOBNAMEN
R9       EQU   9             ENTHAELT ADRESSE DES ZWEITEN JOBNAMEN
R10      EQU   10            ENTHAELT ADRESSE DES CSCB
R11      EQU   11
R12      EQU   12            BASISREGISTER FUER CSECT FASID
R13      EQU   13
R14      EQU   14
R15      EQU   15
         END   FASID
./ ADD NAME=LUDATE
//Z227128D JOB (6685,128,1),FRANZ,MSGCLASS=T,CLASS=R,NOTIFY=Z227128
//LUDATE EXEC ASMFCL,LEPRM='XREF,RENT'
//ASM.SYSIN DD *
TIMEDATE CSECT
*
         ENTRY TIME,DATE,TDATE
*
TIME     B     10(0,15)                ENTRY FOR TIME ONLY
         DC    X'04'
         DC    C'TIME'
         DC    C' '
         STM   14,12,12(13)
         XR    2,2                     CLEAR AND
         LA    3,X'F0'                 LOAD SWITCH
         L     4,0(0,1)                ARG ADDR
         B     ENTPNT-TIME(15)
*
DATE     B     10(0,15)                ENTRY FOR DATE ONLY
         DC    X'04'
         DC    C'DATE'
         DC    C' '
         STM   14,12,12(13)
         LA    2,X'F0'                 LOAD SWITCH
         L     5,0(0,1)                ARG ADDR
         B     ENTPNT-DATE(15)
*
TDATE    B     10(0,15)                ENTRY FOR BOTH, TIME AND DATE
         DC    X'05'
         DC    C'TDATE'
         STM   14,12,12(13)
         XR    2,2                     CLEAR
         XR    3,3                     SWITCHES
         LM    4,5,0(1)                ARG ADDR'S
*
ENTPNT   BALR  6,0                     COMMON ROUTINE, LOAD BASE REG
         USING ENTPNT+2,6
         LA    0,DSECTEND-DSECTANF     GET LENGTH SVA
         GETMAIN R,LV=(0)              DO A GETMAIN
         XC    0(3*4,1),0(1)           ZERO CHAIN ADDRESSES
         LA    0,DSECTEND-DSECTANF     GET LENGTH SVA
         STH   0,2(1)                  STORE LENGTH
         ST    1,8(0,13)               DOWN AND
         ST    13,4(0,1)               UP CHAIN
         LR    13,1                    LOAD SA REG
         L     1,4(0,13)               GET HIGH SA
         LM    0,1,20(1)               RESTORE REGS 0 AND 1
         USING SAVEAREA,13
         XC    REG-2(2),REG-2
         NI    SW,X'0'                 SET BRANCH-SWITCH ZERO
         MVC   DAYTB,=PL2'31,28,31,30,31,30,31,31,30,31,30,31'
         TIME  DEC                     (0)='HHMMSSTH', (1)='00YYDDDZ'
         EX    2,*+4
         NOP   SKIP                    BRANCH ON 'NO TIME'
*     TIME ROUTINE
         ST    0,REG
         MVI   3(4),X'0F'              SUPPLY ZONE
         MVO   0(4,4),REG(3)           IGNORE 10TH AND 100TH
         UNPK  1(7,4),0(4,4)           UNPACK
         MVC   0(2,4),2(4)             SHIFT
         MVC   3(2,4),4(4)             AND
         MVI   2(4),C','               SET
         MVI   5(4),C','               SEPARATORS
         EX    3,*+4
         NOP   EXIT                    BRANCH ON 'NO DATE'
*     DATE ROUTINE
SKIP     ST    1,REG
         MVC   2(8,5),MASK             SUPPLY SEPERATORS, COUNT, ZONE
         MVO   8(2,5),REG+1(1)         GET YEAR
         TM    SW,X'01'
         BO    YEAR
         OI    SW,X'01'
         MVC   REG(2),8(5)             YEAR
         DP    REG-1(3),PFOUR          DIVIDE BY FOUR
         TM    REG+1,X'30'             REMAINDER ZERO
         BNZ   YEAR
         OI    DAYTB+3,X'10'           YES, FEBRUARY 29 DAYS
YEAR     UNPK  8(2,5),8(2,5)           UNPACK YEAR
         LA    2,DAYTB                 TABLE OF DAYS
SEARCH   AP    3(2,5),PONE             COUNT OF MONTHS
         SP    REG+2(2),0(2,2)         SUBTRACT
         BNP   MONTH                   ZERO OR NEGATIVE
         LA    2,2(0,2)                NO, GET NEXT MONTH
         B     SEARCH                  AND LOOP
MONTH    AP    REG+2(2),0(2,2)         RESTORE
         OI    4(5),X'0F'              SET
         OI    REG+3,X'0F'             ZONES
         UNPK  3(2,5),3(2,5)           UNPACK MONTH
         UNPK  0(2,5),REG+2(2)         AND DAY
*
EXIT     L     13,4(0,13)              RELOAD SA REG
         L     1,8(0,13)               GET LOW SA ADDR
         LH    0,2(1)                  GET LENGTH
         FREEMAIN R,LV=(0),A=(1)       DO THE FREEMAIN
         LM    14,12,12(13)            RESTORE REGS
         SPM   14                      AND PGM MASK
         MVI   12(13),X'FF'            RETURN INDICATOR
         SR    15,15
         BR    14                      RETURN
*
*
MASK     DS    0CL8
         DC    C'.'                    SEPERATOR
         DC    X'000C'                 PACKED ZERO
         DC    C'.19'
         DC    X'000F'                 ZONE
PONE     DC    PL1'+1'
PFOUR    DC    PL1'+4'
         LTORG
*
DSECTANF DSECT
SAVEAREA DS    18F
         DS    F
REG      DS    F
DAYTB    DS    CL24
SW       DS    CL1
DSECTEND EQU   *
         END
//*LKED.SYSLMOD DD DSN=Z227128.P.LOAD,DISP=SHR
//LKED.SYSLMOD DD DSN=LU.SBRLIB,DISP=SHR
//LKED.SYSIN DD *
  ALIAS TIME,DATE,TDATE
  NAME LUDATE(R)
./ ADD NAME=SUPSCR
//Z223068S JOB (6695,068,1),
//  TIME=5,CLASS=1,MSGCLASS=O
//ASM EXEC ASMFCL,LEPRM=',AC=1'
//ASM.SYSIN DD *
SCR0     TITLE 'MAGNETPLATTENSPEICHER-SCRATCH-PROGRAMM VERSION 0'
***********************************************************************
*                                                                     *
*          DAS PROGRAMM 'SUPSCR' LISTET, LOESCHT UND ENT-             *
*      KATALOGISERT MAGNETPLATTENSPEICHER-DATEIEN ENTSPRECHEND DER    *
*      SPEZIFIZIERTEN PARAMETER:                                      *
*      LIST, LIST=ALL             => LIST                             *
*      LIST/SMF                   => LIST + SMF-SAETZE             BASF
*      LIST=STORAGE               => LIST                             *
*      LIST=PRIVATE               => LIST                             *
*      LIST=PUBLIC                => LIST                             *
*      LIST=<VOLID>               => LIST                             *
*      OLD                        => SCRATCH + UNCATLG                *
*      ALL                        => SCRATCH + UNCATLG                *
*      SCRATCH=<VOLID>            => SCRATCH                          *
*      SCRINV                     => SCRATCH INVALID DSN'S         BASF
*      SCRREL                     => END SCRINV                    BASF
*      PURGE=<VOLID>              => SCRATCH (BEDINGUNGSLOS)          *
*      PURGE=(<VOLID>/<DSN>)      => SCRATCH                          *
*      TEST=<VOLID>               => SCRATCH (REPLY 'YES')            *
*      INDEX=<DSN BIS 1. PUNKT>   => SCRATCH + UNCATLG                *
*      INIT=(SCRRET=XX,TOOLONG=XX)=> INITIALISIERUNG DES SCRATCH-     *
*                                    ZEITRAUMS FUER INVALID DSN UND   *
*                                    DES TOOLONG-ZEITRAUMS            *
*      UNCATLG=<DSN>              => UNCATALOG                        *
*      DELETE=<VOLID>             => SCRATCH + UNCATALOG              *
*      DELETE=(<VOLID>/<DSN>)     => SCRATCH + UNCATALOG              *
*                                                                     *
*          DIE PARAMETER-EINGABE IST MOEGLICH PER PARM-PARAMETER IN   *
*      DER EXEC-KARTE, UEBER SYSIN UND KONSOL. DIE PARAMETER-STEUERUNG*
*      ERFOLGT DURCH FOLGENDE PARAMETER:                              *
*      PARM      - PARM-PARAMETER BIS STEUERPARAMETER × PARM-ENDE     *
*      SYSIN     - SYSIN-EINGABE BIS STEUERPARAMETER × SYSIN-ENDE     *
*      CON(SOLE) - WTO-REPLY BIS STEUERPARAMETER                      *
*      END       - JOBENDE                                            *
*      DIE STEUERUNG GEHT VOM PARM-PARAMETER AUS; WENN DIESER NICHT   *
*      SPEZIFIZIERT IST, WIRD MIT DER SYSIN-VERARBEITUNG BEGONNEN.    *
*      KONSOL-EINGABE WIRD NUR DURCH DEN STEUERPARAMETER 'CON' IN DER *
*      PARM-PARAMETER-EINGABE ODER DER SYSIN-EINGABE MOEGLICH.        *
*      DIE PARAMETER MUESSEN IM PARM-PARAMETER UND IM WTO-REPLY DURCH *
*      KOMMA GETRENNT SEIN. BEI SYSIN GILT AUCH EIN BLANK ALS TRENN=  *
*      ZEICHEN. DIE PARAMETER KOENNEN VON SPALTE 1 - 71 (KOMMA AUCH   *
*      IN SPALTE 72) GELOCHT SEIN, EINE BESTIMMTE ANFANGSSPALTE IST   *
*      NICHT VORGESCHRIEBEN.                                          *
*                                                                     *
*          RUECKKEHRKODE, NACHRICHTEN UND FEHLERNACHRICHTEN SIND IM   *
*      FOLGENDEN AUFGEFUEHRT.                                         *
*      RC=0:  BAY001I FUNCTION: <PARAMETER>                           *
*             BAY002D ENTER PARAMETER OR 'END'                        *
*             BAY003D DSN=<DSN>                                       *
*             BAY004I END OF PARAMETER                                *
*             BAY005I PROCESSING COMPLETED - RC=<99>                  *
*                                                                     *
*      RC=4:  BAY041I SYSDIAG NOT SPECIFIED                           *
*             BAY042I WARNING-REPLY NOT 'GO'                          *
*             BAY043I ACTION INVALID - ENTER 'YES', 'NO' OR 'EOT'     *
*                     (BAY003D WIRD WIEDERHOLT)                       *
*                                                                     *
*      RC=8:  BAY081I PARAMETER INVALID: <PARAMETER, BIS 97 STELLEN)  *
*                                                                     *
*      RC=12: BAY121I OBTAIN -RC=<99>                                 *
*             BAY121I SCRATCH-RC=<99>                                 *
*            (BAY121I CATALOG-RC=<99>, R0=<99999999>, R1=<99999999>)  *
*             BAY122I 1. DSCB NOT FORMAT 4                            *
*             BAY123I DSCB-FORMAT NOT 2 × 3 AT EXTENT-OBTAIN          *
*             BAY124I DSCB-5 INCORRECT (SYSDIAG)                      *
*                                                                     *
*      RC=16: BAY161I SYSPRINT NOT SPECIFIED (KONSOL)                 *
*             BAY162I NEITHER PARM-PARAMETER NOR SYSIN SPECIFIED.     *
*             BAS163I SIZE OF INDEX-TAB EXHAUSTED---INCREASE       BASF
*                                                  GETMAIN SPACE   BASF
*             BAS164I SPECIFY INDEX DATA SET (SYSLIB DD ), IF      BASF
*                     'LIST/SMF'                                   BASF
*                                IS REQUIRED                       BASF
*                     'SCRINV  '                                   BASF
*              BAS165I SPSCR01 NOT FOUND
*              BAS166I I/O-ERROR WHEN SEARCHING FOR SPSCR01
*             BAS167I INSUFFICIENT VIRTUAL STORAGE
*                                                                     *
*      BEI DEN RUECKKEHRKODES 4 (BAY042I) UND 8 WIRD DIE VERARBEITUNG *
*      MIT DEM NAECHSTEN PARAMETER FORTGESETZT, BEI RUECKKEHRKODE 16  *
*      WIRD DAS PROGRAMM ABNORMAL BEENDET.                            *
*      BEI RUECKKEHRKODE 4 (BAY041I) GEHT DIE VERARBEITUNG WEITER,    *
*      OHNE DASS DIE LISTE SYSDIAG (PLATTEN MIT FALSCHEN DSCB-5)      *
*      ERSTELLT WIRD.                                                 *
*      BEI RUECKKEHRKODE 12 WIRD VOM NAECHSTMOEGLICHEN AUFSATZPUNKT   *
*      WEITER VERARBEITET:                                            *
*      BAY121I OBTAIN1 - LESEN NAECHSTEN DSCB => DSCB UEBERGANGEN     *
*      BAY121I OBTAIN2, CATALOG, SCRATCH - 'WEITER' => DATEIZ. FALSCH *
*      BAY122I - NXTPRM (WENN HAEUFIGER VORKOMMT AENDERN FUER NXTVOL) *
*      BAY123I - 'WEITER' => DATEIZEILE FEHLERHAFT                    *
*      BAY124I - 'WEITER'.                                            *
*                                                                     *
*          SOLL EINE FUNKTION (PARAMETER, DER NICHT STEUERPARAMETER   *
*      IST) UNWIRKSAM GEMACHT WERDEN, IST UNTER DER ENTSPRECHENDEN    *
*      'MARKE<ANFANGSBUCHSTABE>' FOLGENDER BEFEHL EINZUSETZEN:        *
*        B     NXTPRM                  VERARBEITUNG GEHT MIT NAECHSTEM*
*                                          PARAMETER WEITER           *
*      ODER:                                                          *
*        B     PRMUNGLT                PARAMETERFEHLER-NACHRICHT, DIE *
*                                          VERARBEITUNG WIRD MIT DEM  *
*                                          NAE. PARAMETER FORTGESETZT *
*      DIE BEFEHLE BIS ZUR NAECHSTEN **..*-ZEILE KOENNEN ENTFERNT     *
*      WERDEN. ACHTUNG 1) BEIM PARAMETER 'PURGE': DIE BEFEHLE VON     *
*      'MARKEP' MUESSEN BIS ZUR MARKE 'PRFPRGE' ERHALTEN BLEIBEN,     *
*                      2) BEIM PARAMETER 'SCRATCH': DIE BEFEHLE VON   *
*      'MARKES' MUESSEN BIS ZUR MARKE 'PRFSCR' ERHALTEN BLEIBEN.      *
*                                                                     *
*          IM NEUBAU MUSS FOLGENDER BEFEHL (UNTER 'MARKEM') ENTWEDER  *
*      DURCH NEUE UEBERSETZUNG ODER PER SUPERZAP VERAENDERT WERDEN:   *
*        LA    R3,ADRRZALT                                            *
*     -> LA    R3,ADRRZNEU.                                           *
*                                                                     *
***********************************************************************
         EJECT
BAYPROGM START
***********************************************************************
*                                                                     *
*      ZUORDNUNGSTABELLE DER BASIS- UND ALLGEMEINEN REGISTER          *
*                                                                     *
***********************************************************************
R0       EQU   00       OS MAKROREGISTER
R1       EQU   01       OS MAKRO- UND PARAMETERREGISTER
R2       EQU   02       ARBEITSREGISTER
R3       EQU   03       ARBEITSREGISTER
R4       EQU   04       ARBEITSREGISTER
R5       EQU   05       ARBEITSREGISTER
R6       EQU   06
R7       EQU   07       LFD. INDEX TRKLOOP1/2, SCHLFS1
R8       EQU   08       BASISREGISTER KONTROLLBLOECKE
R9       EQU   09
R10      EQU   10       BASISREGISTER 1 DES PROGRAMMS
R11      EQU   11       BASISREGISTER 2 DES PROGRAMMS
R12      EQU   12       BASISREGISTER 3 DES PROGRAMMS
R13      EQU   13       ADRESSE DER JEWEILIGEN AKTUELLEN SAVEAREA
R14      EQU   14       OS LINK- UND RUECKKEHRREGISTER
R15      EQU   15       OS LINK- UND RUECKKEHRREGISTER
***********************************************************************
         EJECT
***********************************************************************
*                                                                     *
*      INITIALISIERUNGS- UND ABSCHLUSSTEIL                            *
*                                                                     *
***********************************************************************
         SAVE  (14,12),T,*
         BALR  R10,0
         USING *,R10,R11,R12           INITIALISIEREN
         LR    R11,R10                     BASISREGISTER
         AH    R11,KON4096
         LR    R12,R11
         AH    R12,KON4096
         ST    R13,SAVEAREA+4
         LR    R14,R13                 SAVE-AREA-KETTUNG OS
         LA    R13,SAVEAREA
         ST    R13,8(R14)
         USING SAVEAREA,R13
         B     ANFANG
KON4096  DC    H'4096'       BASISKONSTANTE
***********************************************************************
ENDE     EQU   *
         CALL  COBAST,(RCODE,BZEIT,ANZSMF),VL
         L     13,SAVEAREA+4
         RETURN (14,12),RC=(15)
***********************************************************************
         EJECT
***********************************************************************
*                                                                     *
*      VORBEREITUNGSROUTINE                                           *
*                                                                     *
***********************************************************************
ANFANG   EQU   *
*** PRUEFUNG PARM-PARAMETER VORHANDEN
         L     R1,0(R1)                ADRESSE PARM-PARAMETER
         CLC   0(2,R1),=H'0'           PARM-LAENGE = 0
         BE    PRFSYSIN                JA - PARM-PARAMETER NICHT SPEZ.
         OI    PRMDA,X'01'             NEIN - SETZEN SCHALTER PARM VORH
         ST    R1,PARMADDR             SICHERN ADRESSE PARM-PARAMETER
*** PRUEFUNG SYSIN-SPEZIFIZIERT
PRFSYSIN EXTRACT TIOTADDR,FIELDS=(TIOT)
         L     R8,TIOTADDR             R8 = ADRESSE TIOT
         USING TIOT,R8
         SR    R3,R3
DDSCHLF  CLI   TIOELNGH,X'00'          TIOT-ENDE
         BE    DROP1R8                 JA
         CLC   TIOEDDNM,=C'SYSIN   '   SYSIN SPEZIFIZIERT
         BE    OPNSYSIN                JA
         IC    R3,TIOELNGH             NAECHSTER
         AR    R8,R3                       DD-ENTRY
         B     DDSCHLF
OPNSYSIN OI    PRMDA,X'02'             SETZEN SCHALTER SYSIN VORHANDEN
         OPEN  (SYSIN,(INPUT))
DROP1R8  EQU   *
         DROP  R8
*** MERKEN TAGESDATUM HEXADEZIMAL
         TIME  BIN                     => R1 = 00JJTTTF
         ST    R0,F0TIME                                           BASF
         ST    R1,F0DATE                                           BASF
         LR    R2,R1                   R2 = 00JJTTTF
         SRA   R2,12
         XC    DBLWORD,DBLWORD
         STH   R2,DBLWORD+6            0JJT
         OI    DBLWORD+7,X'0F'         0JJF
         CVB   R2,DBLWORD
         STC   R2,DATE                 => HEXA-JAHR IM 1. BYTE DATE
         STH   R1,DBLWORD+6            TTTF
         CVB   R1,DBLWORD
         STH   R1,DBLWORD+6
         MVC   DATE+1(2),DBLWORD+6     => HEXA-TAG IM 2. BYTE DATE
         L     R1,16                   A(CVT)                      BASF
         L     R1,196(R1)              A(SMCA)                     BASF
         MVC   F0SID(4),16(R1)         SID+MOD.NO.                 BASF
*** MERKEN JOBNAME UND SYSJJJTT
         L     R8,TIOTADDR             (AUS EXTRACT)
         USING TIOT,R8                 R8 = ADRESSE TIOT
         MVC   JOBNAME,TIOCNJOB        SPEICHERN JOBNAME
         DROP  R8
         MVC   DBLWORD(3),DATE         HEXA-DATUM
         BAL   14,CONVDATE                 DRUCKAUFBEREITEN
         MVC   JOBDATUM+3(2),DBLWORD+6
         MVC   JOBDATUM+5(3),DBLWORD+3
         MVC   ZDATE(2),DBLWORD+6          UND
         MVI   ZDATE+2,C'.'                EINSETZEN
         MVC   ZDATE+3(3),DBLWORD+3        IN UEBERSCHRIFT-1
*** LOESCHEN ZLINE
         MVC   ZLINE,BLANKS            LOESCHEN ZLINE
*** OPEN SYSOUT
         OPEN  (SYSOUT,(OUTPUT))
         TM    SYSOUT+48,X'10'         OPEN SYSPRINT ERFOLGREICH
         BO    OPNSFEHL                JA
         WTO   'BAY161I SYSPRINT NOT SPECIFIED',                       *
               ROUTCDE=(1,2,4),DESC=6
FEHLRC16 EQU   *
         MVC   RC,=C'16'               RC = 16
         B     ENDE                    PROGRAMMABBRUCH
*** OPEN SYSFEHL
OPNSFEHL OPEN  (SYSFEHL,(OUTPUT))
         TM    SYSFEHL+48,X'10'        OPEN SYSFEHL ERFOLGREICH
         BO    SFEHLKPF                JA
         MVI   SFEHLDA,X'00'           LOESCHEN SCHALTER SYSFEHL
         MVC   ZLINE+1(29),=C'BAY041I SYSDIAG NOT SPECIFIED'
         BAL   14,PRINT                BENUTZEN ZLINE FUER BAY041I
         MVC   RC,=C'04'               RC = 4
         B     INDLOAD
SFEHLKPF PUT   SYSFEHL,XKOPF
         B     INDLOAD                                             BASF
***********************************************************************
         EJECT
****************************************************************** BASF
*                                                                * BASF
*      LADEN DATEI DER GUELTIGEN SACHGEBIETSINITIALEN            * BASF
*                                                                * BASF
****************************************************************** BASF
         SPACE 2                                                   BASF
INDLOAD  EQU   *                                                   BASF
         OPEN  IND                                                 BASF
         TM    IND+48,X'10'            INDEX DATEI VORHANDEN?      BASF
         BO    LOAD                    JA.                         BASF
         OI    BASFLAG,NO                                          BASF
         B     CSLOAD                                              BASF
         SPACE 1                                                   BASF
LOAD     EQU   *                                                   BASF
         LA    R3,1024                 AREA FUER 512 INDICES       BASF
         GETMAIN R,LV=(R3)                                         BASF
         ST    R1,INDSTA                                           BASF
         LA    R2,0(R1,R3)                                         BASF
         ST    R2,INDEND                                           BASF
         MVI   0(R1),255                                           BASF
         LR    R2,R1                                               BASF
         LA    R1,1(,R1)                                           BASF
         BCTR  R3,0
         MOVE  (R1),(R3),(R2)                                      BASF
         L     R2,INDSTA                                           BASF
         SRL   R3,1                    ANZAHL ENTRIES              BASF
GETIND   EQU   *                                                   BASF
         GET   IND                                                 BASF
         MVC   0(2,R2),0(R1)                                       BASF
         LA    R2,2(,R2)               NAECHSTER ENTRY             BASF
         BCT   R3,GETIND                                           BASF
         SPACE 1                                                   BASF
         MVC   ZLINE+1(60),=C'BAS163I SIZE OF INDEX-TAB EXHAUSTED---INC*
               REASE GETMAIN SPACE'                                BASF
         BAL   R14,PRINT                                           BASF
         B     FEHLRC16                                            BASF
         SPACE 1                                                   BASF
ENDIND   EQU   *                                                   BASF
         CLOSE IND                                                 BASF
         B     CSLOAD
         SPACE 3                                                   BASF
INDSTA   DC    F'0'                                                BASF
INDEND   DC    F'0'                                                BASF
         SPACE 1                                                   BASF
IND      DCB   DDNAME=SYSLIB,MACRF=GL,DSORG=PS,EODAD=ENDIND        BASF
****************************************************************** BASF
         EJECT
*****************************************************************
*                                                     *
*       SPSCR01: LADEN (CSECT, DIE GESCHUETZTE DSN ENTHAELT)    *
*                                                               *
*****************************************************************
         SPACE 2
CSLOAD   EQU   *
         BLDL    0,BLDLLIST
         B     *+4(R15)
         B     FSP
         B     NFSP
         B     IOERR
FSP      EQU   *
         LOAD  DE=PGMN
         ST    R0,SPCSAD
         B     BLDTB
NFSP     EQU   *
         MVC   ZLINE+1(25),=C'BAS165I SPSCR01 NOT FOUND'
         BAL   R14,PRINT
         B     FEHLRC16
IOERR    EQU   *
         LTR  R0,R0
         BZ   MV1
         MVC ZLINE+1(36),=C'BAS167I INSUFFICIENT VIRTUAL STORAGE'
         B    MV2
MV1      EQU  *
      MVC  ZLINE+1(45),=C'BAS166I I/O-ERROR WHEN SEARCHING FOR SPSCR01'
MV2      EQU  *
         BAL   R14,PRINT
         B     FEHLRC16
BLDTB    EQU   *
         L     R1,SPCSAD
         L     R1,0(R1)
         L     R2,0(R1)    GET NUMBER OF ENTRIES
         LA   R2,1(R2)
         LA    R3,1
TPT2L    EQU   *
         CR    R3,R2
         BH    TPT2E
         SLA   R3,1
         B     TPT2L
TPT2E    EQU   *
         MH    R3,=H'46'  GET SIZE
         GETMAIN R,LV=(R3)         GET
         ST    R1,DSNTA
         LA    R2,0(R1,R3)
         ST    R2,DSNTE            AND
         MVC   0(2,R1),=H'0'
         MVI   2(R1),C' '
         MVC   3(43,R1),2(R1)
         LA    R1,46(R1)
         SH    R3,=H'92'
         MVC   0(2,R1),=H'0'
         MVC   2(44,R1),=44X'FF'
         LR    R2,R1
         LA    R1,46(R1)
         MOVE (R1),(R3),(R2)       DSN - TABLE
         L     R1,DSNTA
         LA    R1,46(R1)
         L     R2,SPCSAD
         L     R2,0(R2)
         L     R3,0(R2)
         MH    R3,=H'46'
         LA    R2,4(R2)
         MOVE (R1),(R3),(R2)       GET PROTECTED DSN'S INTO TABLE
         L     R2,SPCSAD    GET VOL-TAB
         L     R2,4(R2)
         L     R2,0(R2)    GET NUMBER OF ENTRIES
         LA    R2,1(R2)
         LA    R3,1
T2L      EQU   *
         CR    R3,R2
         BH    T2E
         SLA   R3,1
         B     T2L
T2E      EQU   *
         SLA   R3,3    GET SIZE
         GETMAIN R,LV=(R3)
         ST    R1,VOLTA
         LA    R2,0(R1,R3)
         ST    R2,VOLTE
         MVC   0(2,R1),=H'0'
         MVC   2(6,R1),=CL6' '
         LA    R1,8(R1)
         MVC   0(2,R1),=H'0'
         MVC   2(6,R1),=6X'FF'
         SH    R3,=H'16'
         LR    R2,R1
         LA    R1,8(R1)
         MOVE  (R1),(R3),(R2)
         L     R1,VOLTA
         LA    R1,8(R1)
         L     R2,SPCSAD
         L     R2,4(R2)
         L     R3,0(R2)
         SLA   R3,3
         LA    R2,4(R2)
         MOVE  (R1),(R3),(R2)
         DELETE DE=PGMN
         B     UADSLD
BLDLLIST DS    0H
FF       DC    H'1'
LL       DC    H'76'
PGMN     DC    C'SPSCR01 '
TTR      DS    CL3
K        DS    CL1
Z        DS    CL1
C        DS    CL1
USDA     DS    CL62
SPCSAD   DC    F'0'
DSNTA    DC    F'0'
DSNTE    DC    F'0'
VOLTA    DC    F'0'
VOLTE    DC    F'0'
         EJECT                                                     BASF
*****************************************************************
*                                                               *
*    LOAD UADS-TABLE AND GET ACCT-NO. FROM UADS                 *
*                                                               *
*****************************************************************
UADSLD   EQU   *
         OPEN  (UADS)
         GETMAIN R,LV=13000
         ST    R1,UADSADR
         LR    R4,R1
         USING UADSTAB,R4
         LA    R7,1000
NXTDIR   EQU   *
         GET   UADS
         LA    R5,18   NO. OF DIRECTORY ENTRIES IN ONE DIR. BLOCK
         LA    R6,2(R1)  POINT TO FIRST DIR. ENTRY
NXTUSER  EQU   *
         CLI   7(R6),X'FF'
         BE    ENDUADS
         CLI   7(R6),C'0'
         BH    INCRBLK         SKIP OVERFLOW BLOCK
         CLI   7(R6),C' '
         BE    SRCH            REDUCE USERID
         MVI   7(R6),C'.'
         MVI   LUID,X'07'
FILLTBL  EQU   *
         MVC   TTRN(4),=XL4'00'
         MVC   TTRN(3),8(R6)
         MVC   USERID,0(R6)
         LA    R4,13(R4)
         BCT   R7,INCRBLK
         MVC   ZLINE+1(50),=CL50'BAS168I UADS-TABLE TOO SMALL'
         BAL   R14,PRINT
         B     FEHLRC16
INCRBLK  EQU   *
         LA    R6,14(R6)
         BCT   R5,NXTUSER
         CLC   0(2,R1),=X'00FE'
         BNE   ENDUADS
         B     NXTDIR
SRCH     EQU   *
         SR    R8,R8
         LR    R9,R6
CHKNXT   EQU   *
         CLI   0(R9),C' '
         BE    ENDSRCH
         LA    R9,1(R9)
         LA    R8,1(R8)
         B     CHKNXT
ENDSRCH  EQU   *
         BCTR  R9,0
         MVI   0(R9),C'.'
         BCTR  R8,0
         STC   R8,LUID
         B     FILLTBL
ENDUADS  EQU   *
         MVI   LUID,X'FF'
         CLOSE (UADS)
         OPEN  (UADS1)
         L     R4,UADSADR
NXTACCT  EQU   *
         CLI   LUID,X'FF'
         BE    ENDACCT
         POINT UADS1,TTRN
         READ  DECB,SF,UADS1,UADSBER
         CHECK DECB
         LA    R9,UADSBER
         L     R8,24(R9)    PASSWORD OFFSET BLOCK
         L     R8,4(R8,R9)    ACCT-NR. OFFSET BLOCK
         L     R8,8(R8,R9)   ACCT-DATA-BLOCK
         AR    R8,R9
         MVC   ACCTNR(4),45(R8)
         LA    R4,13(R4)
         B     NXTACCT
ENDACCT  EQU   *
         CLOSE (UADS1)
         EJECT
***********************************************************************
*                                                                     *
*      HAUPTPROGRAMM UND ABSCHLUSS                                    *
*                                                                     *
***********************************************************************
HPTTEIL  TM    PRMDA,X'01'             PARM-PARAMETER VORHANDEN
         BNO   FRGSYSIN                NEIN
*** ANFANG PARM-PARAMETER
         MVI   ZUSTAND,C'P'            ZUSTAND P SETZEN
         L     R3,PARMADDR             R3 = ADRESSE PARM-PARAMETER
         LH    R2,0(R3)                R2 = LAENGE PARM-PARAMETER
         STH   R2,PARMLNGE             WEGSPEICHERN
         XC    PARMINDX,PARMINDX       LOESCHEN PARMINDX
         B     ANFNPRM
*** ANFANG SYSIN
FRGSYSIN TM    PRMDA,X'02'             SYSIN SPEZIFIZIERT
         BO    ERSTZSTD                JA
         MVC   ZLINE+1(50),=C'BAY162I NEITHER PARM-PARAMETER NOR SYSIN *
               SPECIFIED'
         BAL   14,PRINT                BENUTZEN ZLINE FUER BAY162I
         B     FEHLRC16                PROGRAMMABBRUCH
ERSTZSTD MVI   ZUSTAND,C'S'            ZUSTAND S SETZEN
         B     ANFNPRM
***********************************************************************
*** SUCHEN NAECHSTEN PARAMETER
NXTPRM   EQU   *
         MVI   PRFINDEX+1,X'00'   ACTIVATE INDEX/DSN - SCHUTZ
         NI    BASFLAG,SCRINV+NO                                   BASF
         BAL   14,VOLFUSS              VOL-FUSSZEILEN AUSGEBEN
         MVI   ZVORS,C'0'
         MVC   ZLINE+1(23),=C'BAY004I END OF FUNCTION'
         BAL   14,PRINT                AUSGEBEN PARAMETERENDE-ZEILE
ANFNPRM  EQU   *
         CLI   ZUSTAND,C'P'
         BE    VRBPARM                 ZUSTAND P
         CLI   ZUSTAND,C'S'
         BE    VRBSYSIN                ZUSTAND S
         CLI   ZUSTAND,C'C'
         BE    VRBCON                  ZUSTAND C
         B     ENDJOB                  ZUSTAND E (NICHT P, S, C)
***********************************************************************
         EJECT
***********************************************************************
*** PARAMETER AUS PARM-PARAMETER
VRBPARM  EQU   *
         L     R2,PARMADDR             R2 = ADRESSE PARM-PARAMETER
         LA    R2,2(R2)                R2 = ADRESSE PARAMETERLISTE
         LH    R3,PARMINDX             R3 = DISPL. PARAMETERLISTE
         LH    R4,PARMLNGE             R4 = LAENGE PARAMETERLISTE
         SR    R4,R3                   LAENGE PARAMETERLISTE AB DISPL.
         BNP   PRMENDE                 REST-LAENGE <= 0
         LA    R5,0(R2,R3)             R5 = ADR. PRM (^R2 WEGEN TRT)
         LA    R1,0(R5,R4)             SETZEN R1 FUER NICHT-GEFUNDEN
         BCTR  R4,0                    R4 = LAENGENSCHLUESSEL TRT
         EX    R4,TRTKOMMA             SUCHEN NAECHSTES KOMMA
         SR    R1,R5                   R1 = LAENGE PARAMETER
         LA    R3,1(R3,R1)             ERHOEHEN DISPL. PARAMETERLISTE
         STH   R3,PARMINDX             WEGSPEICHERN DISPL. NAE. PRM
         LR    R2,R5                   R2 = ADRESSE PARAMETER
*   R1 = LAENGE PARAMETER, R2 = ADRESSE PARAMETER IN PRMAUSW
         B     PRMAUSW
***********************************************************************
*** PARAMETER AUS SYSIN
VRBSYSIN EQU   *
         LA    R2,KART0172             R2 = ADRESSE SYSIN-KARTE
         LH    R3,SYSINDEX             R3 = DISPL. SYSIN-KARTE
         LA    R4,72                   72 - DISPL.
         SR    R4,R3                       => REST-LAENGE
         BP    PRFSPANF                REST-LAENGE > 0
NAEKARTE GET   SYSIN,KART0172          LESEN SYSIN-KARTE
         SR    R3,R3                   DISPL. = 0
         LA    R4,72                   REST-LAENGE = 72
PRFSPANF LR    R7,R4                   R7 = REST-LAENGE
         LA    R5,0(R2,R3)             LFD. SPALTE SYSIN-KARTE
SCHLFS1  CLI   0(R5),C' '              SUCHEN 1. ZEICHEN UNGLEICH BLANK
         BNE   SPRMANF                 GEFUNDEN
         LA    R5,1(R5)                NAECHSTE SPALTE SYSIN-KARTE
         BCT   R7,SCHLFS1              NICHT GEFUNDEN
         B     NAEKARTE
SPRMANF  LA    R3,72                   ERHOEHEN DISPL.
         SR    R3,R7                       UM ANZAHL BLANKS
         LA    R4,72                   72 - DISPL.
         SR    R4,R3                       => NEUE REST-LAENGE
         LA    R5,0(R2,R3)             R5 = ADRESSE PARAMETER
         MVI   TABKOMMA+64,X'40'       VERAENDERN TABKOMMA
         SR    R1,R1                   LOESCHEN R1 FUER TRT
         BCTR  R4,0                    R4 = LAENGENSCHLUESSEL TRT
         EX    R4,TRTKOMMA             SUCHEN KOMMA ODER BLANK
         BZ    NAEKARTE                NICHT GEFUNDEN
         SR    R1,R5                   R1 = LAENGE PARAMETER
         LA    R3,1(R3,R1)             GEFUNDEN - ERHOEHEN DISPL. KARTE
         STH   R3,SYSINDEX             WEGSPEICHERN DISPL. NAE. PRM
         MVI   TABKOMMA+64,X'00'       KORRIGIEREN TABKOMMA
         LR    R2,R5                   R2 = ADRESSE PARAMETER
         B     PRMAUSW
PRMENDE  EQU   *                       DATEIENDE SYSIN, PARM-ENDE
         MVI   ZUSTAND,C'E'
         B     ENDJOB
***********************************************************************
*** PARAMETER AUS KONSOL-EINGABE
VRBCON   EQU   *
         LA    R2,ANTWORT              R2 = ADRESSE KONSOL-EINGABE
         LH    R3,CONINDEX             R3 = DISPL. KONSOL-EINGABE
         LA    R4,115                  115 - DISPL.
         SR    R4,R3                       => REST-LAENGE
         BP    NAECPRM                 REST-LAENGE > 0
         XC    WTORECB,WTORECB
         MVC   ANTWORT,BLANKS          LOESCHEN REPLY-BEREICH
         MVC   ANTWORT+1(114),ANTWORT      AUF BLANKS
         CLC   XSAVECON,=F'0'  IST XCNTRL AKTIV
         BE    XNOTACTV        NEIN, NORMLES WTOR GEBEN
         L     R0,XSAVECON     CONSOLE-ID LADEN
         WTOR 'XLIST05 ENTER PARAMETER OR ''END''',                    *
               ANTWORT,115,WTORECB,                                    *
               MCSFLAG=REG0
         B     XWAIT           NORMALES WTOR UEBERSPRINGEN
XNOTACTV EQU   *
         WTOR  'BAY002D ENTER PARAMETER OR ''END''',                   *
               ANTWORT,115,WTORECB,                                    *
               ROUTCDE=(1,2,4),DESC=6
XWAIT    EQU   *
         WAIT  ECB=WTORECB
         OI    PRMDA,X'04'             SETZEN SCHALTER JOBENDE-ZEILE
*                                          AUF KONSOL
         OC    ANTWORT,BLANKS          -> GROSSBUCHSTABEN
         SR    R3,R3                   DISPL. = 0
         LA    R4,115                  REST-LAENGE = 115
NAECPRM  LA    R5,0(R2,R3)             R5 = ADRESSE PARAMETER
         SR    R1,R1                   LOESCHEN R1 FUER TRT
         BCTR  R4,0                    R4 = LAENGENSCHLUESSEL TRT
         EX    R4,TRTKOMMA             SUCHEN NAECHSTES KOMMA
         BNZ   ERHCIND                 GEFUNDEN
         MVI   TABKOMMA+64,X'40'       NICHT GEFUNDEN - TABKOMMA
         MVI   TABKOMMA+107,X'00'          -> TABBLANK
         LA    R1,1(R5,R4)             SETZEN R1 FUER NICHT-GEFUNDEN
         EX    R4,TRTKOMMA             SUCHEN NAECHSTES BLANK
         MVI   TABKOMMA+64,X'00'       TABBLANK
         MVI   TABKOMMA+107,C','           -> TABKOMMA
         BZ    ERHCIND                 LETZTER PRM OHNE FOLGEBLANKS
         SR    R1,R5                   R1 = LAENGE PARAMETER
         MVC   CONINDEX,=H'115'        DISPL. = REPLY-LAENGE
         B     AUSWCPRM                R1 = LAENGE AUS TRT FUER BLANK
ERHCIND  SR    R1,R5                   R1 = LAENGE PARAMETER
         LA    R3,1(R3,R1)             ERHOEHEN DISPL. PARAMETERLISTE
         STH   R3,CONINDEX             WEGSPEICHERN DISPL. NAE. PRM
AUSWCPRM LR    R2,R5                   R2 = ADRESSE PARAMETER
         B     PRMAUSW
***********************************************************************
         EJECT
***********************************************************************
*** AUSWERTEN VORGELEGTEN PARAMETER (R1 - LAENGE, R2 - ADRESSE)
PRMAUSW  EQU   *
         USING UCB,R8                  R8 = UCB-ADR. (INIT. IN NXTVOL)
*   DROP R8 IN DEVICEOK (SRTESTAB, SRTEVOLI BZW. UCBNAME WERDEN FUER
*   JEDE FUNKTION ZWISCHEN CALL-NXTVOL UND CALL-DEVICEOK BENUTZT).
*   BEI UCB-ENDE NEUINITIALISIERUNG R8 IN NXTVOL.
         XC    $UCBWA1(100),$UCBWA1
         MVC   DISPLBYT,0(R2)          1. ZEICHEN PARAMETER
         TR    DISPLBYT,TABCHAR
         CLI   DISPLBYT,X'FF'          BEGINNT PRM MIT VORGES. BUCHST.
         BE    PRMUNGLT                NEIN
         SR    R3,R3
         IC    R3,DISPLBYT
         B     BMARKE(R3)
PRMUNGLT EQU   *
         MVC   UNPRM,BLANKS            LOESCHEN AUF BLANKS
         CH    R1,=H'97'               PARAMETER-LAENGE > 97
         BNH   BERECHNL                NEIN
         LH    R3,=H'96'               => PARAMETER-LAENGE = 97
         B     MOVEPRM
BERECHNL LR    R3,R1                   LAENGENSCHLUESSEL
         BCTR  R3,0                        MVC
MOVEPRM  EX    R3,MVCPRM2              EINTRAGEN PARAMETER IN BAY081I
         ZAP   LINENO,=P'80'           SETZEN SEITENWECHSEL
         MVC   ZLINE+1(120),UNMSG+4    BENUTZEN ZLINE FUER
         BAL   14,PRINT                   BAY081I
         CLI   ZUSTAND,C'C'            ZUSTAND = C (CON)
         BNE   SETZRC08                NEIN
         LA    R1,UNMSG                KONSOL-AUSGABE
         WTO   MF=(E,(R1))                 BAY081I
SETZRC08 CLC   RC,=C'08'               RC >= 8
         BNL   NXTPRM                  JA
         MVC   RC,=C'08'               NEIN - RC = 8
         B     NXTPRM
BMARKE   EQU   *
         B     MARKEA
         B     MARKEC
         B     MARKED
         B     MARKEE
         B     MARKEI
         B     MARKEL
         B     MARKEM
         B     MARKEO
         B     MARKEP
         B     MARKES
         B     MARKET
         B     MARKEU
***********************************************************************
         EJECT
***********************************************************************
*** PARAMETER BEGINNT MIT A
MARKEA   EQU   *
         CLC   0(3,R2),=C'ALL'         PARAMETER = 'ALL'
         BNE   PRMUNGLT                NEIN
         CH    R1,=H'3'                LAENGE = 3
         BNE   PRMUNGLT                NEIN
         CLC   XSAVECON,=F'0'
         BNE   PRMUNGLT
*** PARAMETER = 'ALL'
         NI    VPSW+1,X'0F'   ACTIVATE VOL-SER PROT
         BAL   14,EDTPLINE             AUSGEBEN BAY001I AUF NEUER SEITE
ANXTVOL  BAL   14,NXTVOL               NAECHSTE EINHEIT WIRD VORGELEGT
         CLC   UCBADDR,=4X'00'         UCB-ENDE
         BE    NXTPRM                  JA
         TM    SRTESTAB,X'0C'          PUBLIC VOLUME    + STORAGE
         BZ    ANXTVOL                 NEIN
         TM    UCBTYP+1,X'08'
         BO    ANXTVOL
         BAL   14,DEVICEOK             VOL-AUSGANGSBEDINGUNGEN
ANXTDSCB BAL   14,NXTDSCB              NAECHSTER DSCB 1 WIRD VORGELEGT,
*                                          DSCB 4, 5 WERDEN AUSGEWERTET
         CLI   DSCBENDE,X'01'          DSCB-ENDE
         BE    ANXTVOL                 JA
         BAL   14,VRBDSCB1             AUSWERTEN DSCB 1
         CLI   RETAINSW,X'01'          DATEI GESCHUETZT
         BE    ANXTDSCB                JA
         BAL   R14,UNCATLG
         BAL   14,SCRATCH              AUSGEBEN DATEIZ., LOESCHEN DATEI
         B     ANXTDSCB                NAECHSTER DSCB
***********************************************************************
*** PARAMETER BEGINNT MIT C
MARKEC   EQU   *
         CH    R1,=H'3'                LAENGE = 3
         BE    PCON                    JA - PRUEFUNG AUF 'CON'
         CH    R1,=H'7'                LAENGE = 7
         BE    PCONSOLE                JA - PRUEFUNG AUF 'CONSOLE'
         B     PRMUNGLT                LAENGE WEDER 3 NOCH 7
PCON     CLC   0(3,R2),=C'CON'         PARAMETER = 'CON'
         BE    SZTDCON                 JA
         B     PRMUNGLT                NEIN
PCONSOLE CLC   0(7,R2),=C'CONSOLE'     PARAMETER = 'CONSOLE'
         BNE   PRMUNGLT                NEIN
SZTDCON  MVI   ZUSTAND,C'C'            ZUSTAND C
         B     VRBCON
***********************************************************************
*** PARAMETER BEGINNT MIT D
MARKED   EQU   *
         CLC   0(7,R2),=C'DELETE='     PARAMETER BEGINNT MIT 'DELETE='
         BNE   PRMUNGLT                NEIN
         MVI   VPSW+1,X'F0'
         CH    R1,=H'14'               LAENGE = 14
         BH    DELFMT2A                NEIN - DELETE-FORMAT 2
         MVC   SPEZVOL(6),7(R2)           WEGSPEICHERN VOLID FORMAT 1
         MVI   SPEZDSN,X'00'           SPEZDSN-KENNZ. FORMAT 1
         B     DELANF
DELFMT2A CLI   7(R2),C'('              DEL.-FORMAT 2 - 7. ZEICH. = '('
         BNE   PRMUNGLT                NEIN
         LR    R14,R2
         CLI   13(R2),C'/'             15. ZEICHEN PRM = '/'
         BE    DELGOON                 NEIN
         CLI   14(R2),C'/'
         BNE   PRMUNGLT
         LA    R14,1(R14)
         MVC   SPEZVOL(6),8(R2)        MOVE MSS-VOLSER LAENGE 6
DELGOON  EQU   *
         CH    R1,=H'60'               LAENGE > 60
         BH    PRMUNGLT                JA
         MVC   SPEZDSN,BLANKS          LOESCHEN SPEZDSN
         LR    R3,R1                   LAENGE PARAMETER
         SH    R3,=H'16'                   - 17 => LAENGENSCHL. DSN
         EX    R3,MVCDSN2              UEBERTRAGEN DSN AUS PRM
         CLC   SPEZDSN(8),=C'&&TOOLONG'
         BNE   DNORM
         OI    OLDSW+1,X'F0'
         MVI   SPEZDSN,X'00'
         MVI   VOLSW+1,X'00'
DNORM    EQU   *
         LA    R4,0(R1,R2)             R4 = R1 + R2
         BCTR  R4,0                        - 1
         CLI   0(R4),C')'              LETZTES ZEICHEN KLAMMER-ZU
         BNE   PRMUNGLT                NEIN
         MVC   SPEZVOL,8(R2)           WEGSPEICHERN VOLID FORMAT 2
*** PARAMETER = 'DELETE='
DELANF   BAL   14,EDTPLINE             AUSGEBEN BAY001I AUF NEUER SEITE
         CALL  MSSMNT,(SPEZVOL),VL
DNXTVOL  BAL   14,NXTVOL               NAECHSTE EINHEIT WIRD VORGELEGT
         CLC   UCBADDR,=4X'00'         UCB-ENDE
         BE    DPRMEND
         CLI   SPEZDSN,X'00'
         BNE   CLC5
         CLC   SRTEVOLI(6),SPEZVOL
         BNE   DNXTVOL
         B     XXBAL
CLC5     EQU   *
         CLC   SRTEVOLI,SPEZVOL        VOLID UCB = SPEZ. VOLID
         BNE   DNXTVOL                 NEIN
XXBAL    BAL   14,DEVICEOK             VOL-AUSGANGSBEDINGUNGEN
DNXTDSCB BAL   14,NXTDSCB              NAECHSTER DSCB 1 WIRD VORGELEGT,
*                                          DSCB 4, 5 WERDEN AUSGEWERTET
         CLI   DSCBENDE,X'01'          DSCB-ENDE
         BE    DPRMEND                 JA - VOL ABGEARBEITET
         CLI   SPEZDSN,X'00'           DELETE-FORMAT 1
         BE    DDELETE                 JA
         CLC   SPEZDSN,DS1DSNAM        LIEGT SPEZ. DATEI VOR
         BE    DDELETE                 JA
         BAL   14,GETTRKS              ERSTELLEN LINETRKS, LINEEXTS
         MVC   ZACTION,=C'NONE   '     DRUCKAUFBEREITEN
         BAL   14,EDTZLINE                 UND AUSGEBEN
         BAL   14,PRINT                    DATEIZEILE
         B     DNXTDSCB                NAECHSTER DSCB
DDELETE  BAL   14,VRBDSCB1             AUSWERTEN DSCB 1
         CLI   RETAINSW,X'01'          DATEI GESCHUETZT
         BE    DNXTDSCB                JA
         BAL   14,UNCATLG              ENTKATALOGISIEREN DSNAME
         BAL   14,SCRATCH              AUSGEBEN DATEIZ., LOESCHEN DATEI
         B     DNXTDSCB                NAECHSTER DSCB
DPRMEND  MVI   VOLSW+1,X'F0'           (-> NOP, S. VRBDSCB1)
         B     NXTPRM                  NAECHSTER PARAMETER
***********************************************************************
*** PARAMETER BEGINNT MIT E
MARKEE   EQU   *
         CLC   0(3,R2),=C'END'         PARAMETER = 'END'
         BNE   PRMUNGLT                NEIN
         CH    R1,=H'3'                LAENGE = 3
         BNE   PRMUNGLT                NEIN
         MVI   ZUSTAND,C'E'            ZUSTAND E
         B     ENDJOB
***********************************************************************
*** PARAMETER BEGINNT MIT I
MARKEI   EQU   *
         CLC   0(6,R2),=C'INDEX='      PARAMETER BEGINNT MIT 'INDEX='
         BNE   TSTINIT         NEIN
         CH    R1,=H'7'                LAENGE < 7
         BL    PRMUNGLT                JA
         CH    R1,=H'14'               LAENGE > 14
         BH    PRMUNGLT                JA
         MVC   INDEXNM,BLANKS          LOESCHEN INDEXNM AUF BLANKS
         LR    R3,R1                   LAENGE PARAMETER
         SH    R3,=H'7'                    - 7 => LAENGENSCHL. INDEXNM
         STH   R3,INDEXLNG             WEGSPEICHERN
         EX    R3,MVCINDNM             UEBERTRAGEN INDEX
         LA    R4,INDEXNM              R4 = ADRESSE INDEXNM
         LA    R4,1(R4,R3)                 + INDEXLNG + 1
         MVI   0(R4),C'.'              PUNKT NACH INDEX
*** PARAMETER = 'INDEX=<DSN BIS ZUM 1. PUNKT>'
         NI    VPSW+1,X'0F'  ACTIVATE VOL-SER PROT
         MVI   PRFINDEX+1,X'F0'
         BAL   14,EDTPLINE             AUSGEBEN BAY001I AUF NEUER SEITE
INXTVOL  BAL   14,NXTVOL               NAECHSTE EINHEIT WIRD VORGELEGT
         CLC   UCBADDR,=4X'00'         UCB-ENDE
         BE    NXTPRM                  JA
         BAL   14,DEVICEOK             VOL-AUSGANGSBEDINGUNGEN
INXTDSCB BAL   14,NXTDSCB              NAECHSTER DSCB 1 WIRD VORGELEGT,
*                                          DSCB 4, 5 WERDEN AUSGEWERTET
         CLI   DSCBENDE,X'01'          DSCB-ENDE
         BE    INXTVOL                 JA
         LH    R3,INDEXLNG             LAENGENSCHLUESSEL INDEXNM
         LA    R3,1(R3)                    EINSCHLIESSLICH PUNKT
         EX    R3,CLCINDNM             SOLL DATEI GELOESCHT WERDEN
         BE    ISCRATCH                JA
         BAL   14,GETTRKS              ERSTELLEN LINETRKS, LINEEXTS
         MVC   ZACTION,=C'NONE   '     DRUCKAUFBEREITEN
         BAL   14,EDTZLINE                 UND AUSGEBEN
         BAL   14,PRINT                    DATEIZEILE
         B     INXTDSCB                NAECHSTER DSCB
ISCRATCH BAL   14,VRBDSCB1             AUSWERTEN DSCB 1
         CLI   RETAINSW,X'01'          DATEI GESCHUETZT
         BE    INXTDSCB                JA
         BAL   R14,UNCATLG
         BAL   14,SCRATCH              AUSGEBEN DATEIZ., LOESCHEN DATEI
         B     INXTDSCB                NAECHSTER DSCB
***  PARAMETER = 'INIT=(SCRRET=XX/TOOLONG=XX)'
TSTINIT  EQU   *
         CLC   0(5,R2),=C'INIT=' PARM BEGINNT MIT 'INIT='
         BNE   PRMUNGLT         NEIN
         CH    R1,=H'28'        LAENGE <= 28
         BH    PRMUNGLT         NEIN
         CH    R1,=H'15'        LAENGE >= 15
         BL    PRMUNGLT         NEIN
         LA    R2,5(R2)
         SH    R1,=H'5'
         CLI   0(R2),C'('
         BNE   TSTKEY
         LA    R2,1(R2)
         BCTR  R1,0
TSTKEY   EQU   *
         MVI   BT1+1,X'00'
         CLC   0(7,R2),=C'SCRRET='
         BE    PA1
BT0      BNE   TOOL
         B     PRMUNGLT
PA1      EQU   *
         PACK  SCRR,7(2,R2)   SCRR SETZEN (RETPD FUER UNGUELTIGE DSN)
         ZAP   DBLWORD1,SCRR
         CVB   R3,DBLWORD1
         STH   R3,SCRR
         CH    R1,=H'10'      LAENGE > 10
         BNH   NXTPRM       NEIN
         CLI   9(R2),C'/'
         BNE   PRMUNGLT
         LA    R2,10(R2)
         SH    R1,=H'10'
TOOL     EQU   *
         CLC   0(8,R2),=C'TOOLONG='
         BE    PA2
BT1      BNE   TSTKEY
         B     PRMUNGLT
PA2      EQU   *
         PACK  RTOOL,8(2,R2)  RTOOL SETZEN (&TOOLONG)
     ZAP   DBLWORD1,RTOOL
         CVB   R3,DBLWORD1
         STH   R3,RTOOL
         CH    R1,=H'11'     LAENGE > 11
         BNH   NXTPRM       NEIN
         CLI   10(R2),C'/'
         BNE   PRMUNGLT
         MVI   BT0+1,X'00'
         LA    R2,11(R2)
         SH    R1,=H'11'
         B     TSTKEY
***********************************************************************
*** PARAMETER BEGINNT MIT L
MARKEL   EQU   *
         CLC   0(4,R2),=C'LIST'        PARAMETER BEGINNT MIT 'LIST'
         BNE   PRMUNGLT                NEIN
LISTX01  MVI   LISTPRM,X'01'                        - PARAMETER 'LIST'
         MVI   VPSW+1,X'F0'
         CH    R1,=H'4'                LAENGE = 4
         BE    PRMLIST                 LAENGE IST 4                BASF
LLNGEG4  CH    R1,=H'8'                LAENGE = 8
         BNE   LLNGEG8                 NEIN
         CLC   4(4,R2),=C'=ALL'        PARAMETER 'LIST=ALL'
         BE    PRMLIST                 JA                          BASF
         CLC   4(4,R2),=C'/SMF'        PARAMETER 'LIST/SMF'        BASF
         BNE   PRMUNGLT                                            BASF
         OI    BASFLAG,SMF                                         BASF
         TM    BASFLAG,NO              INDEX DATEI VORHANDEN?      BASF
         BZ    PRMLIST                 JA                          BASF
         MVC   BASVAR(8),=C'LIST/SMF'                              BASF
BASFMSG  EQU   *                                                   BASF
         MVC   ZLINE+1(70),BAS164I                                 BASF
         BAL   R14,PRINT                                           BASF
         B     FEHLRC16                                            BASF
LLNGEG8  EQU   *
         CLC   4(5,R2),=C'=MSS='
         BNE   TSTVOL
         MVI   SMFMSS+1,X'00'
         MVI   SMFMSS1+1,X'00'
         OI    BASFLAG,SMF
         TM    BASFLAG,NO
         BNZ   BASFMSG
         B     LISTX02
TSTVOL   EQU   *
         CLC   4(5,R2),=C'=VOL='
         BE    LISTX02
         CH    R1,=H'11'               LAENGE = 11
         BNE   LLNGEG11                NEIN
         CLC   4(7,R2),=C'=PUBLIC'     PARAMETER 'LIST=PUBLIC'
         BNE   LISTX02                 NEIN
         MVI   LISTPRM,X'08'           JA
         B     PRMLIST
LISTX02  MVI   LISTPRM,X'02'           PARAMETER 'LIST=<VOLID>'
         MVC   SPEZVOL(6),9(R2)           WEGSPEICHERN VOLID LIST-PRM
         CALL  MSSMNT,(SPEZVOL),VL
         B     PRMLIST
LLNGEG11 CH    R1,=H'12'               LAENGE = 12
         BNE   PRMUNGLT                LAENGE NICHT 4, 8, 11, 12
         CLC   4(8,R2),=C'=STORAGE'    PARAMETER 'LIST=STORAGE'
         BNE   PRFLPRIV                NEIN
         MVI   LISTPRM,X'04'
         B     PRMLIST
PRFLPRIV CLC   4(8,R2),=C'=PRIVATE'    PARAMETER 'LIST=PRIVATE'
         BNE   PRMUNGLT                NEIN
         MVI   LISTPRM,X'10'           JA
*** PARAMETER LIST
PRMLIST  EQU   *
         BAL   14,EDTPLINE             AUSGEBEN BAY001I AUF NEUER SEITE
         OI    LISTSW1+1,X'F0'         (LISTSW1: B)
         NI    LISTSW2+1,X'0F'         (LISTSW2: NOP)
LNXTVOL  BAL   14,NXTVOL               NAECHSTE EINHEIT WIRD VORGELEGT
         CLC   UCBADDR,=4X'00'         UCB-ENDE
         BE    LUCBENDE                JA
         CLI   LISTPRM,X'01'           LIST × LIST=ALL × LIST,SMF  BASF
         BE    LBALDVOK                JA
         CLI   LISTPRM,X'02'           LIST=<VOLID>
         BE    LPRFVOL                 JA
         IC    R3,LISTPRM              MASKE STORAGE × PUBLIC × PRIVATE
         EX    R3,TMSTATUS             PRUEFEN AUF GEFORDERTEN STATUS
         BZ    LNXTVOL                 LIEGT NICHT VOR
         B     LBALDVOK
LPRFVOL  CLC   SRTEVOLI(6),SPEZVOL        VOLID UCB = SPEZ. VOLID
         BNE   LNXTVOL                 NEIN
         B     NMSSCK
LBALDVOK EQU   *
         TM    UCBTYP+1,X'08'
         BO    LNXTVOL
NMSSCK   EQU   *
         BAL   14,DEVICEOK             VOL-AUSGANGSBEDINGUNGEN
LNXTDSCB BAL   14,NXTDSCB              NAECHSTER DSCB 1 WIRD VORGELEGT,
*                                          DSCB 4, 5 WERDEN AUSGEWERTET
         CLI   DSCBENDE,X'01'          DSCB-ENDE
         BE    LNXTVOL                 JA
         BAL   14,VRBDSCB1             AUSWERTEN DSCB 1
         B     LNXTDSCB                BEI LIST IMMER RETAIN
LUCBENDE NI    LISTSW1+1,X'0F'         (-> NOP RETAIN5, S. VRBDSCB1)
         OI    LISTSW2+1,X'F0'         (-> B ACTIONOK, S. VRBDSCB1)
         NI    BASFLAG,255-SMF
         MVI   SMFMSS+1,X'80'
         MVI   SMFMSS1+1,X'10'
         B     NXTPRM                  NAECHSTER PARAMETER
*   NICHT UNTER EX-MARKEN, DA R8 BASISREGISTER
TMSTATUS TM    SRTESTAB,X'00'          VERGLEICHEN LIST-PARAMETER-
*                                          -STATUS MIT VOLUME-STATUS
***********************************************************************
*** PARAMETER BEGINNT MIT M
MARKEM   EQU   *
         B     PRMUNGLT
***********************************************************************
*** PARAMETER BEGINNT MIT O
MARKEO   EQU   *
         CLC   0(3,R2),=C'OLD'         PARAMETER = 'OLD'
         BNE   PRMUNGLT                NEIN
         CH    R1,=H'3'                LAENGE = 3
         BNE   PRMUNGLT                NEIN
*** PARAMETER = 'OLD'
         NI    VPSW+1,X'0F'   ACTIVATE VOL-SER PROT
         BAL   14,EDTPLINE             AUSGEBEN BAY001I AUF NEUER SEITE
         OI    OLDSW+1,X'F0'           (OLDSW: B)
ONXTVOL  BAL   14,NXTVOL               NAECHSTE EINHEIT WIRD VORGELEGT
         CLC   UCBADDR,=4X'00'         UCB-ENDE
         BE    OUCBENDE                JA
         TM    SRTESTAB,X'0C'          PUBLIC VOLUME    + STORAGE
         BZ    ONXTVOL                 NEI
         TM    UCBTYP+1,X'08'
         BO    ONXTVOL
         BAL   14,DEVICEOK             VOL-AUSGANGSBEDINGUNGEN
ONXTDSCB BAL   14,NXTDSCB              NAECHSTER DSCB 1 WIRD VORGELEGT,
*                                          DSCB 4, 5 WERDEN AUSGEWERTET
         CLI   DSCBENDE,X'01'          DSCB-ENDE
         BE    ONXTVOL                 JA
         BAL   14,VRBDSCB1             AUSWERTEN DSCB 1
         CLI   RETAINSW,X'01'          DATEI GESCHUETZT
         BE    ONXTDSCB                JA
         BAL   R14,UNCATLG
         BAL   14,SCRATCH              AUSGEBEN DATEIZ., LOESCHEN DATEI
         B     ONXTDSCB                NAECHSTER DSCB
OUCBENDE NI    OLDSW+1,X'0F'           (-> NOP, S. VRBDSCB1)
         B     NXTPRM
***********************************************************************
*** PARAMETER BEGINNT MIT P (ZWEIDEUTIG)
MARKEP   EQU   *
         CH    R1,=H'4'                LAENGE = 4
         BNE   PRFPRGE                 NEIN
         CLC   0(4,R2),=C'PARM'        PARAMETER = 'PARM'
         BNE   PRMUNGLT                NEIN
*** PARAMETER = 'PARM'
         TM    PRMDA,X'01'             PARM-PARAMETER VORHANDEN
         BNO   PRMUNGLT                NEIN
         MVI   ZUSTAND,C'P'            ZUSTAND P
         B     VRBPARM
*   PRUEFEN AUF 'PURGE'
PRFPRGE  CLC   0(6,R2),=C'PURGE='
         BNE   PRMUNGLT                PARAMETER UNGUELTIG
         CH    R1,=H'13'               LAENGE = 13
         BH    PRGFMT2A                NEIN - PURGE-FORMAT 2
         MVC   SPEZVOL(6),6(R2)           WEGSPEICHERN VOLID FORMAT 1
         MVI   SPEZDSN,X'00'           SPEZDSN-KENNZ. FORMAT 1
         B     PURGEANF
PRGFMT2A CLI   6(R2),C'('              PURGE-FORMAT 2 - 7. ZEICH. = '('
         BNE   PRMUNGLT                NEIN
         CLI   12(R2),C'/'             14. ZEICHEN PRM = '/'
         BNE   PRMUNGLT                NEIN
         CH    R1,=H'59'               LAENGE > 59
         BH    PRMUNGLT                JA
         MVC   SPEZDSN,BLANKS          LOESCHEN SPEZDSN
         LR    R3,R1                   LAENGE PARAMETER
         SH    R3,=H'15'                   - 16 => LAENGENSCHL. DSN
         EX    R3,MVCDSN               UEBERTRAGEN DSN AUS PRM
         LA    R4,0(R1,R2)             R4 = R1 + R2
         BCTR  R4,0                        - 1
         CLI   0(R4),C')'              LETZTES ZEICHEN KLAMMER-ZU
         BNE   PRMUNGLT                NEIN
         MVC   SPEZVOL,7(R2)           WEGSPEICHERN VOLID FORMAT 2
*** PARAMETER = 'PURGE='
PURGEANF BAL   14,EDTPLINE             AUSGEBEN BAY001I AUF NEUER SEITE
         CALL  MSSMNT,(SPEZVOL),VL
PNXTVOL  BAL   14,NXTVOL               NAECHSTE EINHEIT WIRD VORGELEGT
         CLC   UCBADDR,=4X'00'         UCB-ENDE
         BE    NXTPRM                  JA - SPEZ VOL NICHT GEFUNDEN
         CLI   SPEZDSN,X'00'
         BNE   CLC5X
         CLC   SRTEVOLI(6),SPEZVOL
         BNE   PNXTVOL
         B     YYBAL
CLC5X    EQU   *
         CLC   SRTEVOLI,SPEZVOL        VOLID UCB = SPEZ. VOLID
         BNE   PNXTVOL                 NEIN
YYBAL    BAL   14,DEVICEOK             VOL-AUSGANGSBEDINGUNGEN
PNXTDSCB BAL   14,NXTDSCB              NAECHSTER DSCB 1 WIRD VORGELEGT,
*                                          DSCB 4, 5 WERDEN AUSGEWERTET
         CLI   DSCBENDE,X'01'          DSCB-ENDE
         BE    NXTPRM                  JA - NAECHSTER PARAMETER
         BAL   14,GETTRKS              ERSTELLEN LINETRKS, LINEEXTS
         CLI   SPEZDSN,X'00'           PURGE-FORMAT 1
         BNE   PRGFMT2B                NEIN
         CLC   DS1DSNAM+23(5),JOBNAME  JOBNAME MUST BE GREATER THAN 4
*                                          VERGLEICH JOBNAME ST. 1-5
         BNE   PSCRATCH                UNGLEICH
         CLC   DS1DSNAM(8),JOBDATUM    VERGLEICH SYS<JJTTT>
         BNE   PSCRATCH                UNGLEICH
         MVC   ZREASON,=C'ACTIVE &&&&DATASET    '
         MVC   ZACTION,=C'NONE   '
         B     PDATEIZL
PRGFMT2B CLC   SPEZDSN,DS1DSNAM        DSCB 1 ZU SPEZ. DSNAME
         BE    PSCRATCH                JA
         MVC   ZACTION,=C'NONE   '     DRUCKAUFBEREITEN
PDATEIZL BAL   14,EDTZLINE                 UND AUSGEBEN
         BAL   14,PRINT                    DATEIZEILE
         B     PNXTDSCB                NAECHSTER DSCB
PSCRATCH BAL   14,SCRATCH              AUSGEBEN DATEIZ., LOESCHEN DATEI
         B     PNXTDSCB                NAECHSTER DSCB
***********************************************************************
*** PARAMETER BEGINNT MIT S (VIERDEUTIG)
MARKES   EQU   *
         CLC   0(5,R2),=C'SYSIN'       PARAMETER = 'SYSIN'
         BNE   PRFSCR                  NEIN
         CH    R1,=H'5'                LAENGE = 5
         BNE   PRMUNGLT                NEIN
*** PARAMETER = 'SYSIN'
         TM    PRMDA,X'02'             SYSIN SPEZIFIZIERT
         BNO   PRMUNGLT                NEIN
         MVI   ZUSTAND,C'S'            ZUSTAND S
         B     VRBSYSIN
*   PRUEFEN AUF 'SCRATCH'
PRFSCR   CLC   0(8,R2),=C'SCRATCH='    PARAMETER BEGINNT MIT 'SCRATCH='
         BNE   PRFSINV                 NEIN                        BASF
         CH    R1,=H'15'               LAENGE = 15
         BH    PRMUNGLT                NEIN
         MVC   SPEZVOL(6),8(R2)           WEGSPEICHERN VOLID
*** PARAMETER = 'SCRATCH=<VOLID>'
         BAL   14,EDTPLINE             AUSGEBEN BAY001I AUF NEUER SEITE
         CALL  MSSMNT,(SPEZVOL),VL
VNXTVOL  BAL   14,NXTVOL               NAECHSTE EINHEIT WIRD VORGELEGT
         CLC   UCBADDR,=4X'00'         UCB-ENDE
         BE    VPRMEND                 JA - SPEZ. VOL NICHT GEFUNDEN
         CLC   SRTEVOLI(6),SPEZVOL        VOLID UCB = SPEZ. VOLID
         BNE   VNXTVOL                 NEIN
         BAL   14,DEVICEOK             VOL-AUSGANGSBEDINGUNGEN
VNXTDSCB BAL   14,NXTDSCB              NAECHSTER DSCB 1 WIRD VORGELEGT,
*                                          DSCB 4, 5 WERDEN AUSGEWERTET
         CLI   DSCBENDE,X'01'          DSCB-ENDE
         BE    VPRMEND                 JA - VOL ABGEARBEITET
         BAL   14,VRBDSCB1             AUSWERTEN DSCB 1
         CLI   RETAINSW,X'01'          DATEI GESCHUETZT
         BE    VNXTDSCB                JA
         BAL   14,SCRATCH              AUSGEBEN DATEIZ., LOESCHEN DATEI
         B     VNXTDSCB                NAECHSTER DSCB
PRFSINV  EQU   *                                                   BASF
         CLC   0(6,R2),=C'SCRINV'                                  BASF
         BNE   PRFSREL                                             BASF
         OI    BASFLAG,SCRINV                                      BASF
         TM    BASFLAG,NO                                          BASF
         BZ    ANFNPRM                                             BASF
         MVC   BASVAR(8),=C'SCRINV'                                BASF
         B     BASFMSG                                             BASF
         SPACE 1                                                   BASF
PRFSREL  EQU   *                                                   BASF
         CLC   0(6,R2),=C'SCRREL'                                  BASF
         BNE   PRMUNGLT                                            BASF
         NI    BASFLAG,255-SCRINV                                  BASF
         B     ANFNPRM                                             BASF
VPRMEND  EQU   *
         B     NXTPRM                  NAECHSTER PARAMETER
***********************************************************************
*** PARAMETER BEGINNT MIT T
MARKET   EQU   *
         CLC   0(5,R2),=C'TEST='       PARAMETER BEGINNT MIT 'TEST='
         BNE   PRMUNGLT                NEIN
         CH    R1,=H'12'               LAENGE = 12
         BH    PRMUNGLT
         MVC   SPEZVOL(6),5(R2)           WEGSPEICHERN VOLID
         CALL  MSSMNT,(SPEZVOL),VL
*** PARAMETER = 'TEST=<VOLID>'
         BAL   14,EDTPLINE             AUSGEBEN BAY001I AUF NEUER SEITE
         CLI   ZUSTAND,C'C'            ZUSTAND C
         BNE   PRMUNGLT                NEIN - NUR IM ZUSTAND CON GUELTG
         MVI   EOT,X'00'               LOESCHEN SCHALTER EOT
TNXTVOL  BAL   14,NXTVOL               NAECHSTE EINHEIT WIRD VORGELEGT
         CLC   UCBADDR,=4X'00'         UCB-ENDE
         BE    NXTPRM                  JA - SPEZ. VOL NICHT GEFUNDEN
         CLC   SRTEVOLI(6),SPEZVOL        VOLID UCB = SPEZ. VOLID
         BNE   TNXTVOL                 NEIN
         BAL   14,DEVICEOK             VOL-AUSGANGSBEDINGUNGEN
TNXTDSCB BAL   14,NXTDSCB              NAECHSTER DSCB 1 WIRD VORGELEGT,
*                                          DSCB 4, 5 WERDEN AUSGEWERTET
         CLI   DSCBENDE,X'01'          DSCB-ENDE
         BE    NXTPRM                  JA - NAECHSTER PARAMETER
         BAL   14,GETTRKS              ERSTELLEN LINETRKS, LINEEXTS
         CLI   EOT,X'01'               END OF PRM 'TEST'
         BE    PRMTEOT                 JA
NBAY003D XC    WTORECB,WTORECB
         MVI   TESTANTW+2,C' '         LOESCHEN 3. ST.TESTANTW F. 'NO'
         MVC   TTDSN,DS1DSNAM          DSNAME FUER WTOR
         LA    R1,TTMSG-8              ADRESSE BAY003D
         WTOR  ,TESTANTW,3,WTORECB,MF=(E,(R1))
         WAIT  ECB=WTORECB
         OC    TESTANTW,BLANKS         -> GROSSBUCHSTABEN
         MVC   ZREASON(6),=C'REPLY='
         MVC   ZREASON+6(3),TESTANTW   REPLY -> ZREASON
         MVC   ZREASON+9(11),BLANKS
         CLC   TESTANTW(3),=C'YES'     REPLY = 'YES'
         BE    PRMTSCR
         CLC   TESTANTW(3),=C'EOT'     REPLY = 'EOT'
         BE    PRMTEOT
         MVC   ZACTION,=C'NONE   '     FUER REPLY 'NO'
         CLC   TESTANTW(3),=C'NO '     REPLY = 'NO '
         BE    TDATEIZL
         WTO   'BAY043I ACTION INVALID - ENTER ''YES'', ''NO'' OR ''EOT*
               ''',ROUTCDE=(1,2,4),DESC=6
         B     NBAY003D
PRMTEOT  MVC   ZREASON,=CL20'REPLY=EOT'
         MVC   ZACTION,=C'NONE   '
         MVI   EOT,X'01'               SETZEN SCHALTER EOT
TDATEIZL BAL   14,EDTZLINE             AUSGEBEN
         BAL   14,PRINT                    DATEIZEILE
         B     TNXTDSCB                NAECHSTER DSCB
PRMTSCR  BAL   14,SCRATCH              AUSGEBEN DATEIZ., LOESCHEN DATEI
         B     TNXTDSCB                NAECHSTER DSCB
***********************************************************************
*** PARAMETER BEGINNT MIT U
MARKEU   EQU   *
         CLC   0(8,R2),=C'UNCATLG='    PARAMETER BEGINNT MIT 'UNCATLG='
         BNE   PRMUNGLT                NEIN
         CH    R1,=H'9'                LAENGE < 9
         BL    PRMUNGLT                JA
         CH    R1,=H'52'               LAENGE > 52
         BH    PRMUNGLT                JA
         MVC   SPEZDSN,BLANKS          LOESCHEN SPEZDSN
         LR    R3,R1                   LAENGE PARAMETER
         SH    R3,=H'9'                    - 9 => LAENGENSCHL. DSN
         EX    R3,MVCUDSN              UEBERTRAGEN DSN AUS PRM
*** PARAMETER = 'UNCATLG=<DSN>'
         NI    VPSW+1,X'0F'   ACTIVATE VOL-SER PROT
         BAL   14,EDTPLINE             AUSGEBEN BAY001I AUF NEUER SEITE
         MVC   DSNAME,SPEZDSN          UEBERTRAGEN DSNAME
         CATALOG CAMCAT                UNCATALOG
         MVI   ZLINE,C'0'              VORSCHUB LEERZ. NACH BAY001I
         LTR   R15,R15                 RC = 0
         BZ    URCNULL                 JA
         MVC   ZACTION,=C'NONE   '
         MVC   ZREASON(3),=C'RC='
         CVD   R15,DBLWORD             DRUCKAUFBEREITEN
         UNPK  ZREASON+3(2),DBLWORD        RUECKKEHRKODE
         OI    ZREASON+4,X'F0'
         B     UDATEIZL
URCNULL  MVC   ZACTION,=C'UNCATLG'
         MVC   ZREASON,=CL20'USER''S REQUEST'
UDATEIZL MVC   ZDSNAME,SPEZDSN         DRUCKAUFBEREITEN UND
         BAL   14,PRINT                    AUSGEBEN DATEIZEILE
         B     NXTPRM                  NAECHSTER PARAMETER
***********************************************************************
         EJECT
***********************************************************************
*** ABSCHLUSS
ENDJOB   EQU   *
         BAL   14,VOLFUSS              AUSGEBEN VOL-FUSSZEILEN
         MVC   ENDWTO+42(2),RC         EINSETZEN RC IN JOBENDE-NACHR.
         TM    PRMDA,X'04'             SCHALTER KONSOL-EINGABE GESETZT
         BZ    ENDPUT                  NEIN
         CLC   XSAVECON,=F'0'  IST XCNTRL AKTIV
         BNE   ENDPUT          WENN JA, DANN KEIN WTO
ENDWTO   WTO   'BAY005I PROCESSING COMPLETED - RC=99',                 *
               ROUTCDE=(1,2,4),DESC=6
ENDPUT   MVC   ZLINE+1(36),ENDWTO+8    BENUTZEN ZLINE FUER
         BAL   14,PRINT                    JOBENDE-NACHRICHT
         CLOSE (SYSOUT,,SYSFEHL)
         B     ENDE
***********************************************************************
         EJECT
***********************************************************************
*                                                                     *
*      NEXT DIRECT ACCESS STORAGE DEVICE                              *
*                                                                     *
***********************************************************************
NXTVOL   ST    R14,SAVE1R14
LOOKUCB  UCBSCAN
         LTR   R15,R15
         BNZ   NOUCB
         LR    R8,R1
         CLI   18(R8),X'20'   DASD ?
         BNE   LOOKUCB
         TM    3(R8),X'80'    ONLINE ?
         BNO   LOOKUCB
         CLC   28(6,R8),=XL6'0'     VOLID VORHANDEN
         BE    LOOKUCB                 NEIN - NEXT UCB
         ST    R8,UCBADDR
VPSW     B      PROM
         L     R5,VOLTA
         L     R6,VOLTE
         SR    R6,R5
         SRA   R6,1
TP       EQU   *
         AR    R5,R6
COMPVOL  EQU   *
         SRA   R6,1
         CH    R6,=H'4'
         BL    PROM
         LH    R3,0(R5)
         LA    R1,2(R5)
         EX    R3,VGLVOL
         BE    LOOKUCB    GESCHUETZTES VOLUME
         BH    TP
         SR    R5,R6
         B     COMPVOL
VGLVOL   CLC   28(0,R8),0(R1)
PROM     EQU   *
         NI    BASFLAG,255-NOPRIV                                  BASF
         NI    BASFLAG,255-PRVRES                                  BASF
         TM    SRTESTAB,NOPRIV         PRIVATE DISK?               BASF
         BZ    PRON                    NEIN.                       BASF
         TM    SRTESTAT,RES            RESERVED?                   BASF
         BNO   PRON                    NEIN                        BASF
         OI    BASFLAG,PRVRES
         B     TSTALT
PRON     EQU   *                                                   BASF
         OI    BASFLAG,NOPRIV                                      BASF
TSTALT   EQU   *                                                   BASF
         MVC   F0DEVTYP,UCBTYP         × VORBEREITEN               BASF
         MVC   F0VOLSER,SRTEVOLI       × SMF-RECORD                BASF
         ST    R8,UCBADDR              WEGSPEICHERN ACTUAL UCB-ADDRESS
         B     RTRNNVOL
NOUCB    XC    UCBADDR,UCBADDR         UCBADDR = 0
RTRNNVOL L     R14,SAVE1R14
         BR    14
***********************************************************************
         SPACE 3                                                   BASF
         EJECT
***********************************************************************
*                                                                     *
*      DEVICE OK - VOL-ALT: FUSS, VOL: KOPF & DATEIANFANGSBEDINGUNGEN *
*                                                                     *
***********************************************************************
DEVICEOK ST    R14,SAVE1R14
*        USING UCB,R8                  R8 = UCB-ADR. (INIT. IN NXTVOL)
         BAL   14,VOLFUSS              AUSGEBEN VOL-FUSSZEILEN
         MVC   VOLUMSER,SRTEVOLI       SPEICHERN VOLID
         MVC   SVUNIT,UCBNAME          SPEICHERN UNIT ADDR
         MVC   DUNIT,SVUNIT            AUFBEREITEN
         MVC   DVOLID,VOLUMSER             VOLKOPF
         SR    R4,R4
         IC    R4,UCBTYP+3             DEVICE CODE (X'01'-X'09')
         TM    UCBTYP+1,X'08'
         BNO   NOMSS
         LA    R4,1
NOMSS    EQU   *
         STC   R4,DVTYP                SPEICHERN DEVICE TYPE
         SLA   R4,2                        => DISPL. UNITTYP-TAB
         LA    R3,UNITTYP-4(R4)        EINTRAGEN
         MVC   DUNITTYP,0(R3)              EINHEITENTYP
         MVC   DSTABB(17),SCHAB                                    BASF
         TM    SRTESTAT,PRES+RES                                   BASF
         BNM   TSTSTAB                                             BASF
         MVC   DSTABA,=C'PRES'                                     BASF
         TM    SRTESTAT,PRES                                       BASF
         BO    TSTSTAB                                             BASF
         MVC   DSTABA,=C'RES '                                     BASF
TSTSTAB  EQU   *                                                   BASF
         TM    SRTESTAB,NOPRIV+PUBLIC+STOR                         BASF
         BNM   TSTSYSR                                             BASF
         MVC   DSTABB,=C'PRV'                                      BASF
         TM    SRTESTAB,NOPRIV                                     BASF
         BO    TSTSYSR                                             BASF
         MVC   DSTABB,=C'PUB'                                      BASF
         TM    SRTESTAB,PUBLIC                                     BASF
         BO    TSTSYSR                                             BASF
         MVC   DSTABB,=C'STG'                                      BASF
TSTSYSR  EQU   *                                                   BASF
         TM    SRTESTAT,SYSRES                                     BASF
         BZ    OUTV                                                BASF
         MVC   DSYSRES,=C'SYSRES'                                  BASF
OUTV     EQU   *                                                   BASF
         MVC   ZLINE,DLINE             AUSGEBEN
         BAL   14,PRINT                    VOL-KOPFZEILE
         TM    BASFLAG,SCRINV                                      BASF
         BZ    NOWR                                                BASF
         MVC   ZLINE+1(27),=C'  **** ''SCRINV'' ACTIVE ****'       BASF
         BAL   R14,PRINT                                           BASF
NOWR     EQU   *                                                   BASF
         MVI   VOLKPFDA,X'01'          SETZEN SCHALTER VOLKOPF VORH.
         LH    R2,SRTEFSCT             VTOC-ADDRESS (TTR ABSOLUTE)
         L     R1,16
         TM    116(R1),X'01'      MVS?
         BNO   *+8
         LH    R2,X'18'(R8)    VTOC ADDR. IM MVS
         SLA   R4,1                    DEVICE CODE => DISPL. TCANDCAP
         SRDA  R2,32
         D     R2,TCANDCAP-8(R4)       DIVID. TT/SPECIFIC TRKS/CYL
         STH   R2,TRACKNO              => STARTING TRACK
         STH   R2,CCHHR+2              => HH -ADDRESS OF VTOC
         STH   R3,CYLNO                => STARTING CYL
         STH   R3,CCHHR                => CC -ADDRESS OF VTOC
         MVI   CCHHR+4,X'01'           RECORD NUMBER
         MVI   RECNO+1,X'01'           R-ADDRESS OF VTOC
         XC    TRKCNTSU,TRKCNTSU
         XC    FREETRKS,FREETRKS
         MVI   DSCB4DA,X'00'           LOESCHEN SCHALTER DSCB4
         MVI   DSCBENDE,X'00'          LOESCHEN SCHALTER DSCB-ENDE
         DROP  R8
         L     R14,SAVE1R14
         BR    14
***********************************************************************
         EJECT
***********************************************************************
*                                                                     *
*      LESEN DSCB'S - AUSWERTEN FORMAT 4, 5 UND VORLEGEN FORMAT 1     *
*                                                                     *
***********************************************************************
NXTDSCB  ST    R14,SAVE1R14
         CLI   DSCB4DA,X'01'           FORMAT 4 DSCB SCHON GELESEN
         BNE   FRSTDSCB                NEIN - CCHHR NICHT ERHOEHEN
READVTOC LH    R2,RECNO                LFD. SATZ-NUMMER
         LA    R2,1(R2)                ERHOEHEN
         CH    R2,MRECNO               SPUR UEBERSCHRITTEN
         BNH   RECOK                   NEIN - NEUE CCHHR-ADRESSE
         LH    R2,TRACKNO              JA - LFD. SPUR-NUMMER
         LA    R2,1(R2)                ERHOEHEN
         CH    R2,MTRACKNO             ZYLINDER UEBERSCHRITTEN
         BL    TRACKOK      NEIN, NEUE CCHHR-ADDR.
         LH    R2,CYLNO                JA - LFD. ZYLINDER-NUMMER
         LA    R2,1(R2)                ERHOEHEN
         STH   R2,CYLNO                SPEICHERN
         STH   R2,CCHHR                    NEUE ZYLINDER-ADRESSE
         LA    R2,0
TRACKOK  STH   R2,TRACKNO              SPEICHERN
         STH   R2,CCHHR+2                  NEUE SPUR-ADRESSE
         LA    R2,1                    R2 = 1
RECOK    STH   R2,RECNO                SPEICHERN
         STC   R2,CCHHR+4                  NEUE SATZ-ADRESSE
         CLC   CCHHR,DS4HPCHR          DSCB-ENDE
         BH    DSCBEND                 JA
FRSTDSCB OBTAIN CAMOBT                 READ NEXT DSCB
         LTR   R15,R15                 RC = 0
         BZ    OBTN1OK                 JA
         MVC   FMAKRO,=C'OBTAIN '
         BAL   14,EDITRC               DRUCKAUFB RC & AUSGEBN NACHRICHT
         BAL   14,SETZRC12             RC = 12
         B     READVTOC
OBTN1OK  CLI   DSCB4DA,X'01'           DSCB 4 SCHON GELESEN
         BE    DSCBOK                  JA
         CLI   WORKFLD+44,C'4'         NEIN - FORMT 4 (1. DSCB IN VTOC)
         BE    FORMAT4                 JA - VERARBEITEN DSCB 4
         MVC   ZLINE+1(28),=C'BAY122I 1. DSCB NOT FORMAT 4'
         BAL   14,PRINT                BENUTZEN ZLINE FUER BAY122I
         BAL   14,SETZRC12             RC = 12
         NI    LISTSW1+1,X'0F'         (-> NOP RETAIN5, S. VRBDSCB1)
         OI    LISTSW2+1,X'F0'         (-> B ACTIONOK, S. VRBDSCB1)
         NI    OLDSW+1,X'0F'           (-> NOP OLDONLY, S. VRBDSCB1)
         MVI   VOLSW+1,X'F0'
         B     NXTPRM                  NAECHSTER PARAMETER
DSCBOK   CLI   WORKFLD+44,C'1'         FORMAT 1
         BNE   FRGDSCB5                NEIN
         MVC   DSCB1,WORKFLD           SPEICHERN DSCB1
         B     RTRNNXTD
FRGDSCB5 CLI   WORKFLD+44,C'5'         FORMAT 5
         BE    FORMAT5
         B     READVTOC
*                                                                     *
*** FORMAT 4 DSCB (EINMAL PRO VOL)
FORMAT4  MVC   DSCB4,WORKFLD           SPEICHERN DSCB 4
         MVC   MTRACKNO,DS4DEVSZ+2     SPEICHERN MAX. SPUR-ADRESSE
         MVC   MRECNO+1(1),DS4DEVDT    SPEICHERN MAX. SATZ-ADRESSE
         MVI   DSCB4DA,X'01'           SETZEN SCHALTER DSCB 4
         B     READVTOC                READ NEXT DSCB
*                                                                     *
*** FORMAT 5 DSCB
FORMAT5  MVC   DSCB5,WORKFLD           SPEICHERN DSCB5
         LA    R8,DS5AVEXT
         USING DS5AVEXT,R8             R8 = ADRESSE 1. EXTENT
         MVC   DS5FMTID(90),DS5FMTID+1 TRENNUNG EXTENT 1-8 VON 9-26
*                                          DURCH FORMAT-ID AUFGEHOBEN
         LA    R7,26
         LH    R2,FREETRKS             R2 = ZAEHLER FREE TRKS
TRKLOOP2 SR    R4,R4
         IC    R4,DVTYP                EINHEITENTYP VOL
         SLA   R4,3                        * 8 => TCANDCAP-TAB
         L     R3,TCANDCAP-8(R4)       TRKS PRO CYL
         MVC   HALBWORT,DS5AVEXT+2         * FREE CYL AUS EXTENT
         MH    R3,HALBWORT                 => FREE CYLS IN TRKS
         AR    R2,R3                   ERHOEHEN ZAEHLER FREE TRKS
         SR    R4,R4
         IC    R4,DS5AVEXT+4           FREE TRACKS AUS EXTENT
         AR    R2,R4                   ERHOEHEN ZAEHLER FREE TRKS
         LA    R8,5(R8)                R8 = ADRESSE NAECHSTER EXTENT
         BCT   R7,TRKLOOP2
         DROP  R8
         STH   R2,FREETRKS             WEGSPEICHERN FREE TRKS
         B     READVTOC                NEXT DSCB
DSCBEND  MVI   DSCBENDE,X'01'          SETZEN SCHALTER DSCB-ENDE
RTRNNXTD L     R14,SAVE1R14
         BR    14
***********************************************************************
         EJECT
***********************************************************************
*                                                                     *
*      VERARBEITEN DSCB 1 (SCHUTZPRUEFUNGEN)                          *
*                                                                     *
***********************************************************************
VRBDSCB1 ST    R14,SAVE1R14
         MVI   RETAINSW,X'00'          LOESCHEN SCHALTER RETAIN
         BAL   14,GETTRKS              ERSTELLEN LINETRKS, LINEEXTS
*** PRUEFUNG AUF &&-DATEIEN
OLDSW    NOP   OLDONLY                 (-> B, S. PRM 'OLD')
         CLC   DS1DSNAM+23(5),JOBNAME  JOBNAME MUST BE GREATER THAN 4
*                                          VERGLEICH JOBNAME ST. 1-5
         BNE   PRFINDEX
OLDONLY  EQU   *
         CLC   DS1DSNAM(8),JOBDATUM
         BE    RETAIN1
*** PRUEFEN AUF GESCHUETZTE INDIZES
PRFINDEX NOP   PRFCATLG
         L     R5,DSNTA
         L     R6,DSNTE
         SR    R6,R5
         SRA   R6,1
TUP      EQU   *
         AR    R5,R6
COMPDSN  EQU   *
         SRA   R6,1
         CH    R6,=H'23'
         BL    PRFCATLG
         LH    R3,0(R5)
         LA    R2,2(R5)
         EX    R3,VGL1INDX
         BE    RETAIN2
         BH    TUP
         SR    R5,R6
         B     COMPDSN
*** DSNAME 'SYSCTLG' IST GESCHUETZT
PRFCATLG CLC   DS1DSNAM(7),=C'SYSCTLG'
         BE    RETAIN4
         CLC   DS1DSNAM(8),=C'PASSWORD'
         BE    RETAIN4A
         CLC   DS1DSNAM(3),=C'SYS'
         BNE   NOTEMP
         CLC   DS1DSNAM+8(2),=C'.T'
         BNE   NOTEMP
         CLC   DS1DSNAM+16(7),=C'.RA000.'
         BE    RTRNVRB1
         CLC   DS1DSNAM+16(7),=C'.RV000.'
         BE    RTRNVRB1
NOTEMP   EQU   *
VOLSW    B     DBPRFEND
         MVC   HALBWORT,DS1CREDT+1
         LH    R14,HALBWORT
         MVC   HALBWORT,DATE+1
         LH    R15,HALBWORT
         SR    R15,R14
         BNM   BASCOMP
         LH    R15,HALBWORT
         AH    R15,=H'365'
         SR    R15,R14
BASCOMP  EQU   *
         CH    R15,RTOOL
         BL    RETAIN8
         B     RTRNVRB1
RTOOL    DC    H'0'
DBPRFEND EQU   *
***   PRUEFUNG AUF VSAM DATASET
         TM    DS1DSORG+1,X'08'
         BO    RETAIN9
*** PRUEFUNG EXPIRATION DATE
VSAMRET  EQU   *                                          03/04/78 BASF
         CLC   DS1EXPDT,DATE           EXPIRATION DATE / TAGESDATUM
         BH    RETAIN3
*** PRUEFUNG MODEL DSCB
         CLC   LINETRKS,=C'  0000'     ZERO ALLOC.
         BNE   LISTSW1                 NEIN
         CLI   DS1DSNAM,C'*'           TEST AUF IEHMOVE GARBAGE
         BNE   RETAIN7
LISTSW1  NOP   RETAIN3                 (-> B, S. PRM 'LIST')
         B     RTRNVRB1
*** DATEI IST GESCHUETZT
RETAIN1  EQU   *
         MVC   ZREASON,=C'ACTIVE &&&&DATASET    '
         MVC   ZACTION,=C'NONE   '
         B     RETAINX
RETAIN2  EQU   *
         MVC   ZREASON,=C'FIRST INDEX LEV ×DSN'
RET2E    EQU   *
         MVC   ZACTION,=C'NONE   '
         MVC   F0K,=H'5'     DSN NICHT ABRECHENBAR ABER GESCH
         B     RETAIN
RETAIN3  EQU   *
         TM    BASFLAG,SCRINV+SMF                                  BASF
         BZ    RETAIN3A                                            BASF
         BAL   R14,VALDSN                                          BASF
         TM    BASFLAG,SMF                                         BASF
         BNO   TSTINV                                              BASF
         MVC   ZACTION(8),=C'LIST    '                             BASF
         BAL   R14,SMFWR                                           BASF
         B     ACTIONOK                                            BASF
TSTINV   EQU   *                                                   BASF
         TM    BASFLAG,SCRINV+INV                                  BASF
         BO    RTRNVRB1                                            BASF
RETAIN3A EQU   *                                                   BASF
         CLC   DS1EXPDT,DATE
         BL    RETAINX
         MVC   ZREASON,=C'PURGE DATE          '
         MVC   ZACTION,=C'NONE   '
          B     RETAINX
RETAIN4  EQU   *
         MVC   ZREASON,=C'CATALOG DATASET     '
         MVC   ZACTION,=C'NONE   '
          B     RETAINX
RETAIN4A EQU   *
         MVC   ZREASON,=C'PASSWORD DATASET    '
         MVC   ZACTION,=C'NONE   '
          B     RETAINX
RETAIN7  EQU   *
         MVC   ZREASON,=C'ALLOC 0 - MODEL DSCB'
         MVC   ZACTION,=C'NONE   '
         B     RETAINX
RETAIN8  EQU   *
         MVC   ZREASON,=C'DS. TOO YOUNG       '
         B     RET2E
RETAIN9  EQU   *
         MVC   ZREASON,=CL19'VSAM DATASET'
         TM    BASFLAG,SMF                                03/04/78 BASF
         BO    VSAMRET                                    03/04/78 BASF
         MVC   ZACTION,=C'NONE   '
         B     RETAINX
RETAIN   EQU   *
         TM    BASFLAG,SMF
         BZ    RETAINX
         BAL   R14,SMFWR
         B     RETAINX
RETAINX  EQU   *
         MVI   RETAINSW,X'01'   SETZEN SCHALTER RETAIN
LISTSW2  B     ACTIONOK                (-> NOP, S. PRM 'LIST')
         MVC   ZACTION,=C'LIST   '     JA - ACTION = LIST
ACTIONOK BAL   14,EDTZLINE             DRUCKAUFBEREITEN ZLINE
         BAL   14,PRINT
RTRNVRB1 L     R14,SAVE1R14
         BR    14
***********************************************************************
         EJECT
***********************************************************************
*                                                                     *
*      BERECHNEN ALLOCATED TRACKS UND EXTENTS (EV. READ DSCB 2 × 3)   *
*                                                                     *
***********************************************************************
GETTRKS  ST    R14,SAVE2R14
         LA    R8,DS1EXT1
         USING DS1EXT1,R8              R8 = ADRESSE 1. EXTENT
         XC    TRKCNT,TRKCNT           LOESCHEN ZAEHLER ALLOC. TRKS,
         XC    EXTCNT,EXTCNT               ZAEHLER EXTENTS
         LA    R7,3                    ANFANGSINDEX 1. SCHLEIFE
TRKLOOP1 EQU   *
         CLI   DS1EXT1,X'00'           EXTENT VORHANDEN
         BE    RTRNGETT                NEIN
         MVC   DBLWORD,DS1EXT1+2       EINGABE UP EXTTRKS
         BAL   R14,EXTTRKS             BERECHNEN EXTENT-TRACKS
         AH    R3,TRKCNT               R3 = AUSGABE EXTTRKS
         STH   R3,TRKCNT
         LH    R3,EXTCNT               ERHOEHEN
         LA    R3,1(R3)                    EXTENT-ZAEHLER
         STH   R3,EXTCNT
         LA    R8,10(R8)               R8 = ADRESSE NAECHSTER EXTENT
         BCT   R7,TRKLOOP1
         DROP  R8
         CLI   DURCHLF,C'2'            2. DURCHLAUF
         BE    RTRNGETT                JA - RETURN
         CLC   DS1PTRDS,=XL5'00'       DSCB3-POINTER BEI MEHR ALS 3 EXT
*                                      DSCB2-POINTER BEI ORGANIZ. IS
         BE    RTRNGETT                NICHT VORHANDEN
         MVC   SVCCHHR,CCHHR           SPEICHERN CCHHR-DSCB1 (F. SCR)
         MVC   CCHHR,DS1PTRDS          DSCB 2 × 3 PINTER
OBTAIN2  OBTAIN CAMOBT                 READ DSCB FORMAT 2 × 3
         LTR   R15,R15                 RC = 0
         BZ    OBTN2OK                 JA
         MVC   FMAKRO,=C'OBTAIN '
         BAL   14,EDITRC               DRUCKAUFB RC & AUSGEBN NACHRICHT
         BAL   14,SETZRC12             RC = 12
         B     ENDDSCB2
OBTN2OK  CLI   WORKFLD+44,C'3'         DSCB FORMAT 3
         BE    DSCB3OK                 JA
         CLI   WORKFLD+44,C'2'         DSCB FORMAT 2
         BE    DSCB2OK                 JA
         MVC   ZLINE+1(46),=C'BAY123I DSCB-FORMAT NOT 2 × 3 AT EXTENT-O*
               BTAIN'
         BAL   14,PRINT                BENUTZEN ZLINE FUER BAY123I
         BAL   14,SETZRC12             RC = 12
         B     ENDDSCB2
*                                                                     *
DSCB3OK  MVC   DSCB3,WORKFLD           SPEICHERN DSCB3
         MVC   CCHHR,SVCCHHR           CCHHR = CCHHR-DSCB1
         MVC   DS3FMTID(90),DS3FMTID+1 TRENNUNG EXTNT 1-4 VON 5-13
*                                      DURCH FORMAT-ID AUFGEHOBEN
         LA    R8,DS3EXTNT             R8 = ADRESSE 4. EXTENT
         LA    R7,13                   ANFANGSINDEX FUER 2. SCHLEIFE
         MVI   DURCHLF,C'2'            SETZEN SCHALTER 2. DURCHLAUF
         B     TRKLOOP1
*                                                                     *
DSCB2OK  MVC   DSCB2,WORKFLD           SPEICHERN DSCB2
         CLC   DS2PTRDS,=XL5'00'       POINTER DSCB3 VORHANDEN
         BE    ENDDSCB2                NEIN
         MVC   CCHHR,DS2PTRDS          POINTER DSCB 3
         B     OBTAIN2
ENDDSCB2 MVC   CCHHR,SVCCHHR           CCHHR = CCHHR-DSCB1
RTRNGETT MVI   DURCHLF,C'1'            SETZEN SCHALTER 1. DURCHLAUF
         LH    R2,TRKCNT               DRUCKAUFBEREITEN
         CVD   R2,DBLWORD                  TRKCNT
         MVC   LINETRKS,TRKMASK        => LINETRKS
         ED    LINETRKS,DBLWORD+5
         AH    R2,TRKCNTSU             ERHOEHEN
         STH   R2,TRKCNTSU                 ALLOCATED TRACKS
         LH    R2,EXTCNT               DRUCKAUFBEREITEN
         CVD   R2,DBLWORD                  EXTCNT
         UNPK  LINEEXTS,DBLWORD            => LINEEXTS
         OI    LINEEXTS+1,X'F0'
         L     R14,SAVE2R14
         BR    14
***********************************************************************
         EJECT
***********************************************************************
*                                                                     *
*      ENTKATALOGISIEREN DSNAME                                       *
*                                                                     *
***********************************************************************
UNCATLG  ST    R14,SAVE1R14
         MVC   DSNAME,DS1DSNAM         DSNAME AUS DSCB 1
         LOCATE LOCATE
         LTR   R15,R15
         BNZ   RTRNUNCT
         L     R8,UCBADDR
         USING UCB,R8
         CLC   WORKFLD+6(6),SRTEVOLI
         BNE   RTRNUNCT  DONT UNCATLG IF CATALOG POINTS TO
*                      AN OTHER VOLUME
         DROP  R8
         CATALOG CAMCAT                UNCATALOG
         LTR   R15,R15                 RC = 0
         BZ    DISPDEL                 JA
         B     RTRNUNCT
*        WENN BAY121I WIEDER BEI CATALOG-MAKRO-FEHLER AUSGEGEBEN WIRD,*
*        AUCH CATALOG-MAKRO UNTER 'MARKEU' BERUECKSICHTIGEN.          *
         MVC   FMAKRO,=C'CATALOG'
         MVC   FR0TEXT,=C', R0='
         ST    R0,KETTE5               KETTE5 STELLE 1-4 = R0 HEX
         UNPK  FR0(9),KETTE5           UEBERLAPPTES ENTPACKEN
         TR    FR0,TRTAB-240               => DRUCKBARER HEXWERT R0
         MVC   FR1TEXT,=C', R1='
         ST    R1,KETTE5               KETTE5 STELLE 1-4 = R1 HEX
         UNPK  FR1(9),KETTE5           UEBERLAPPTES ENTPACKEN
         TR    FR1,TRTAB-240               => DRUCKBARER HEXWERT R1
         BAL   14,EDITRC               DRUCKAUFB RC & AUSGEBN NACHRICHT
         MVC   FR0TEXT(26),BLANKS      LOESCHEN FR0TEXT BIS FR1
         BAL   14,SETZRC12             RC = 12
DISPDEL  MVC   ZACTION,=C'DELETE '
RTRNUNCT L     R14,SAVE1R14
         BR    14
***********************************************************************
         EJECT
***********************************************************************
*                                                                     *
*      DATEIZEILE AUSGEBEN, DATEI LOESCHEN                            *
*                                                                     *
***********************************************************************
SCRATCH  ST    R14,SAVE1R14
         CLC   ZACTION,=C'DELETE '     SCHON EINGETRAGEN
         BE    DISPRSN                 JA
         MVC   ZACTION,=C'SCRATCH'
DISPRSN  CLC   ZREASON(6),=C'REPLY='   SCHON EINGETRAGEN
         BE    SCRTRKS                 JA
         MVC   ZREASON,=C'USER''S REQUEST             '
SCRTRKS  EQU   *                                                   BASF
         TM    BASFLAG,INV+SCRINV                                  BASF
         BNO   SCRTRKS1                                            BASF
         MVC   ZREASON,=CL20'INVALID DSNAME'                       BASF
         NI    BASFLAG,255-INV                                     BASF
SCRTRKS1 EQU   *                                                   BASF
         LH    R3,TRKCNTSU             ERNIEDRIGEN
         SH    R3,TRKCNT                   ALLOCATED TRACKS
         STH   R3,TRKCNTSU                 UM SCRATCHED
         LH    R3,FREETRKS             ERHOEHEN
         AH    R3,TRKCNT                   FREE TRACKS
         STH   R3,FREETRKS                 UM SCRATCHED
         BAL   14,EDTZLINE             DRUCKAUFBEREITEN UND
         BAL   14,PRINT                    AUSGEBEN DATEIZEILE
         L     R8,UCBADDR
         USING UCB,R8                  R8 = ADRESSE CURRENT UCB
         MVC   DSNAME,DS1DSNAM         DSNAME AUS DSCB 1
         MVC   VOLIST+6(6),SRTEVOLI    VOLUME SER AUS DSCB 1
         MVC   VOLIST+2(4),UCBTYP      DEVICE TYPE AUS DSCB 1
         DROP  R8
         SR    0,0                     LOESCHEN R0 FUER SCRATCH-MAKRO
         SCRATCH CAMSCR                SCRATCH MIT OVRD
         LTR   15,15                   RC = 0
         BZ    RTRNSCR                 JA
         MVC   FMAKRO,=C'SCRATCH'
         BAL   14,EDITRC
         BAL   14,SETZRC12             RC = 12
RTRNSCR  L     R14,SAVE1R14
         BR    14
***********************************************************************
         EJECT
***********************************************************************
*                                                                     *
*      UNTERPROGRAMM BERECHNEN TRACKS PRO EXTENT                      *
*                                                                     *
***********************************************************************
EXTTRKS  LH    R3,DBLWORD              DBLWORD - EINGABEPARAMETER (EXT)
         MH    R3,MTRACKNO
         AH    R3,DBLWORD+2
         STH   R3,TRKA
         LH    R3,DBLWORD+4
         MH    R3,MTRACKNO
         AH    R3,DBLWORD+6
         STH   R3,TRKB
         SH    R3,TRKA
         LA    R3,1(R3)                R3 - AUSGABEPARAMETER (TRKS)
         BR    14
***********************************************************************
         SPACE 4
***********************************************************************
*                                                                     *
*      UNTERPROGRAMM KONVERTIEREN DATUM X'JJ0TTT' -> C'TTTJJ'         *
*                                                                     *
***********************************************************************
CONVDATE L     R2,DBLWORD              DBLWORD - EINGABEPARAMETER (JTT)
         SRDL  R2,24
         CVD   R2,DBLWORD1
         UNPK  DBLWORD+6(2),DBLWORD1   -> JJ
         SRL   R3,16
         CVD   R3,DBLWORD1
         UNPK  DBLWORD+3(3),DBLWORD1   -> TTT
         OI    DBLWORD+5,X'F0'
         OI    DBLWORD+7,X'F0'         DBLWORD - AUSGABEPARAM (TTTJJ)
         BR    14
***********************************************************************
         EJECT
*******************************************************************BASF
*                                                                 *BASF
*      SCHREIBEN SMF-SAETZE                                       *BASF
*                                                                 *BASF
*******************************************************************BASF
         SPACE 1                                                   BASF
SMFWR    EQU   *                                                   BASF
         ST    R14,SAVE2R14                                        BASF
         MVC   ZACTION(8),=CL8'LIST'
         SPACE 1                                                   BASF
         CLC   F0VOLSER(2),=C'VV'
SMFMSS   BE    RTRNSMF
         CLC   F0VOLSER(3),=C'MSS'
         BE    RTRNSMF
         TM    BASFLAG,PRVRES
SMFMSS1  BO    RTRNSMF
         TM    BASFLAG,SMF
         BNO   RTRNSMF
         MVC   ZACTION(8),=CL8'LIST+SMF'
         MVI   LISTSW2+1,X'F0'
         MVC   F0DSN,DS1DSNAM                                      BASF
         MVC   F0EXT,EXTCNT                                        BASF
         MVC   F0TRKA,TRKCNT                                       BASF
         SR    R1,R1                                               BASF
         IC    R1,DS1CREDT                                         BASF
         MH    R1,=H'1000'                                         BASF
         AH    R1,DS1CREDT+1                                       BASF
         CVD   R1,DBLWORD                                          BASF
         OI    DBLWORD+7,15                                        BASF
         MVC   F0CREDT,DBLWORD+4                                   BASF
         SR    R1,R1                                               BASF
         IC    R1,DS1EXPDT                                         BASF
         MH    R1,=H'1000'                                         BASF
         MVC   HALBWORT,DS1EXPDT+1                                 BASF
         AH    R1,HALBWORT                                         BASF
         CVD   R1,DBLWORD                                          BASF
         OI    DBLWORD+7,15                                        BASF
         MVC   F0EXPDT,DBLWORD+4                                   BASF
         CLC   F0VOLSER(2),=CL2'PG'
         BE    SYSVOL
         CLC   F0VOLSER(2),=CL2'RV'
         BE    SYSVOL
         CLC   F0VOLSER(2),=CL2'DL'
         BE    SYSVOL
         CLC   F0VOLSER(5),=CL5'SPOOL'
         BE    SYSVOL
         CLC   F0VOLSER(3),=CL3'MSS'
         BNE   NOSYSVOL
SYSVOL   EQU   *
         MVC   F0K,=H'5'
NOSYSVOL EQU   *
         LA    R1,TYPF0                                            BASF
         LA    R15,SMFWRIT                                         BASF
         SVC   250                                                 BASF
         LTR   R15,R15
         BNZ   RTRNSMF
         AP    ANZSMF,=P'1'
         SPACE 1                                                   BASF
RTRNSMF  EQU   *                                                   BASF
         L     R14,SAVE2R14                                        BASF
         BR    R14                                                 BASF
         SPACE 1                                                   BASF
SMFWRIT  EQU   *                                                   BASF
         SMFWTM (R1)                                               BASF
         BR    R14                                                 BASF
         SPACE 3                                                   BASF
****************************************************************** BASF
         EJECT
*SMF-RECORD TYP X'F0':                                             BASF
         SPACE 1                                                   BASF
         CNOP  2,4                                                 BASF
TYPF0    EQU   *                                                   BASF
         DC    AL2(F0END-TYPF0),AL2(0)                             BASF
         DC    H'240'                                              BASF
F0TIME   DS    XL4                                                 BASF
F0DATE   DS    PL4                                                 BASF
F0SID    DS    CL2                                                 BASF
F0MOD    DS    CL2                                                 BASF
F0DSN    DS    CL44                                                BASF
F0EXT    DS    CL2                                                 BASF
F0TRKA   DS    CL2                                                 BASF
F0DEVTYP DS    CL4                                                 BASF
F0VOLSER DS    CL6                                                 BASF
F0CREDT  DS    PL4                                                 BASF
F0EXPDT  DS    PL4                                                 BASF
F0K      DC    H'0'
F0RES    DC    18XL1'0'
F0END    EQU   *                                                   BASF
****************************************************************** BASF
         EJECT
****************************************************************** BASF
*                                                                * BASF
*      PRUEFEN AUF GUELTIGEN DSNAMEN                             * BASF
*                                                                * BASF
****************************************************************** BASF
         SPACE 1                                                   BASF
VALDSN   EQU   *                                                   BASF
         MVC   F0K,=H'1'
         MVC   F0RES(4),=CL4' '
         NI    BASFLAG,255-INV                                     BASF
         ST    R14,SAVE3R14                                        BASF
         TM    DS1DSORG+1,X'08'     VSAM ??
         BNO   NVSAM
         CLI   DS1DSNAM+3,C'.'                            03/04/78 BASF
         BE    TSTIND                                     03/04/78 BASF
         MVC   F0K,=H'7'
         B     RTRNVAL
NVSAM    CLI   DS1DSNAM+2,C'.'                                     BASF
         BNE   TSTUADS
         CLI   DS1DSNAM+1,C'X'
         BNE   TSTIND
         CLC   DS1DSNAM+2(2),=CL2'.A'
         BNE   TSTIND
         TM    DS1DSNAM+4,X'F0'
         BNO   TSTIND
         TM    DS1DSNAM+5,X'F0'
         BNO   TSTIND
         TM    DS1DSNAM+6,X'F0'
         BNO   TSTIND
         TM    DS1DSNAM+7,X'F0'
         BNO   TSTIND
         CLC   DS1DSNAM+8(2),=CL2'.I'
         BE    RTRNVAL
         CLC   DS1DSNAM+8(2),=CL2'.F'
         BE    RTRNVAL
         B     TSTIND
TSTUADS  SR    R6,R6
         L     R4,UADSADR
LOOK     EQU   *
         IC    R6,LUID
         EX    R6,CLCUID
         BL    BADRTRNA
         BH    INCUID
         MVC   F0RES(4),ACCTNR
         B     RTRNTSO
INCUID   EQU   *
         LA    R4,13(R4)
         CLI   LUID,X'FF'
         BNE   LOOK
BADRTRNA EQU   *
         MVC   HALBWORT,DS1CREDT+1
         LH    R5,HALBWORT
         MVC   HALBWORT,DATE+1
         LH    R6,HALBWORT
         SR    R6,R5
         BNM   BASCMP
         LH    R6,HALBWORT
         AH    R6,=H'365'
         SR    R6,R5
BASCMP   EQU   *
         CH    R6,SCRR
         BL    AO2
         OI    BASFLAG,INV                                         BASF
AO2      EQU   *
         MVC   F0K,=H'3'
RTRNVAL  EQU   *                                                   BASF
         L     R14,SAVE3R14                                        BASF
         BR    R14                                                 BASF
RTRNTSO  EQU   *
         MVC   F0K,=H'4'
         B     RTRNVAL
SCRR     DC    H'0'
         SPACE 2                                                   BASF
TSTIND    EQU  *                                                   BASF
          L    R5,INDSTA                                           BASF
          L    R6,INDEND                                           BASF
COMPIND  EQU   *                                                   BASF
         CR    R5,R6
         BE    BADRTRNA
         CLC   0(2,R5),DS1DSNAM                                    BASF
         BE    RTRNMV2                                             BASF
         BH    BADRTRNA
         LA    R5,2(R5)
         B     COMPIND                                             BASF
RTRNMV2  EQU   *
         MVC   F0K,=H'2'
         CLI   DS1DSNAM+3,C'.'                            03/04/78 BASF
         BNE   RTRNVAL                                    03/04/78 BASF
         MVC   F0K,=H'6'                                  03/04/78 BASF
         B     RTRNVAL
****************************************************************** BASF
         SPACE 3                                                   BASF
ZERO     DC    CL4'0'                                              BASF
CLCUID   CLC   DS1DSNAM(0),USERID
         EJECT                                                     BASF
***********************************************************************
*                                                                     *
*      UNTERPROGRAMM DRUCKAUFBEREITEN ZLINE                           *
*                                                                     *
***********************************************************************
EDTZLINE ST    R14,SAVE2R14
         MVC   ZDSNAME,DS1DSNAM
         MVC   ZTRACKS,LINETRKS
         CLC   DS1LSTAR(5),=XL5'00'    LAST BLOCK POINTER (TTRLL) NULL
         BNE   PRFLBP                  NEIN
         MVC   ZUSED+2,=C'----'
         B     MOVEEXTS
PRFLBP   LH    R2,DS1LSTAR             TRKS AUS LAST BLOCK POINTER
         CLI   DS1LSTAR+2,X'00'        RECNO AUS LAST BLOCK POINTER
         BE    CONVTRKS                    IST NULL
         LA    R2,1(R2)                ERHOEHEN TRACKS UM 1
CONVTRKS CVD   R2,DBLWORD                  DRUCKAUFBEREITEN
         MVC   ZUSED,TRKMASK               USED
         ED    ZUSED,DBLWORD+5             TRACKS
MOVEEXTS MVC   ZEXTENTS,LINEEXTS
         TM    DS1DSORG,X'80'          ORGANIZATION INDEXED SEQ.
         BZ    PRFORGPS                NEIN
         MVC   ZTYP,=C'IS'
         B     EDTCREDT
PRFORGPS TM    DS1DSORG,X'40'          ORGANIZATION PHYSICAL SEQ.
         BZ    PRFORGDA                NEIN
         MVC   ZTYP,=C'PS'
         B     EDTCREDT
PRFORGDA TM    DS1DSORG,X'20'          ORGANIZATION DIRECT
         BZ    PRFORGPO
         MVC   ZTYP,=C'DA'
         B     EDTCREDT
PRFORGPO TM    DS1DSORG,X'02'          ORGANIZATION PARTIONED
         BNO   PRFORGAM
         MVC   ZTYP,=C'PO'
         B     EDTCREDT
PRFORGAM TM    DS1DSORG+1,X'08'
         BNO   ORGU
         MVC   ZTYP,=C'AM'
         B     EDTCREDT
ORGU     MVC   ZTYP,=C'--'             ORGANIZ. NICHT IS, PS, DA, PO
EDTCREDT MVC   DBLWORD(3),DS1CREDT
         BAL   14,CONVDATE
         MVC   ZCREDAT+0(2),DBLWORD+6
         MVC   ZCREDAT+2(3),DBLWORD+3
         MVC   DBLWORD(3),DS1EXPDT
         BAL   14,CONVDATE
         CLC   DBLWORD+3(5),=C'00000'
         BE    HYPHEN
         MVC   ZPURDAT+0(2),DBLWORD+6
         MVC   ZPURDAT+2(3),DBLWORD+3
         B     NOHPH
HYPHEN   MVC   ZPURDAT,=C'-----'
NOHPH    EQU   *
         MVC   DBLWORD(3),DS1REFD
         BAL   R14,CONVDATE
         MVC   ZREFDT+0(2),DBLWORD+6
         MVC   ZREFDT+2(3),DBLWORD+3
         L     R14,SAVE2R14
         BR    14
***********************************************************************
         EJECT
***********************************************************************
*                                                                     *
*      UNTERPROGRAMM DRUCKAUFBEREITEN UND AUSGEBEN VOL-FUSSZEILEN     *
*                                                                     *
***********************************************************************
VOLFUSS  ST    R14,SAVE2R14
         CLI   VOLKPFDA,X'01'          VOLKOPF GESCHRIEBEN
         BNE   RTRNVOLF                NEIN - VOLFUSS UEBERFLUESSIG
         MVC   DBLWORD,DS4VTOCE+2      VTOC-EXTENT
         BAL   14,EXTTRKS              BERECHNEN EXTENT-TRACKS
         AH    R3,TRKCNTSU             ERHOEHEN TRKCNTSU
         STH   R3,TRKCNTSU                 UM VTOC-EXTENT =>
         CVD   R3,DBLWORD              ALLOCATED TRACKS
         UNPK  TTRACKS,DBLWORD             DRUCKAUFBEREITEN
         OI    TTRACKS+4,X'F0'
         MVC   XALLOC,TTRACKS          ALLOC. TRKS -> DSCB5-FEHLERZEILE
         CLI   TTRACKS,C'0'            TTRACKS <= 9999
         BNE   AUSGTXT1                NEIN
         MVI   TTRACKS,C' '            LOESCHEN 1. FUEHRENDE NULL
AUSGTXT1 MVC   TTEXT,=C'ALLOCATED TRACKS'
         PUT   SYSOUT,TLINE            AUSGEBEN VOL-FUSSZEILE 1
         SR    R4,R4
         IC    R4,DVTYP                EINHEITENTYP VOL-ALT
         SLA   R4,3                        * 8 => DISPL. TCANDCAP-TAB
         L     R2,TCANDCAP-4(R4)       CAPACITY IN TRACKS
         SH    R2,TRKCNTSU                 - ALLOCATED TRACKS
         LH    R3,FREETRKS             FREE TRKS AUS DSCBS FORMAT 5
         SR    R2,R3                   FREE TRKS/ERRECHNET - /DSCBS 5
         CH    R2,=H'1'                DIFFERENZ 1 - VOL-LABEL SPACE
         BE    AUFBTTRK                JA - NORMALFALL
         CH    R2,=H'2'                DIFFERENZ 2
         BNE   TRKSTERN                NEIN - FALSCHER DSCB 5
         CLI   DVTYP,X'01'             EINHEITENTYP 2311
         BE    AUFBTTRK                JA - SONDERFALL
TRKSTERN MVI   TSTERN1A,C'*'           KENNZEICHNEN FREE TRKS
         MVI   TSTERN2,C'*'                ALS FEHLERHAFT
         MVC   XUNITTYP,DUNITTYP       UNIT TYPE -> DSCB5-FEHLERZEILE
         MVC   XVOLID,DVOLID           VOLID -> DSCB5-FEHLERZEILE
AUFBTTRK CVD   R3,DBLWORD              FREE TRACKS DSCB 5
         UNPK  TTRACKS,DBLWORD             DRUCKAUFBEREITEN
         OI    TTRACKS+4,X'F0'
         MVC   XFREE,TTRACKS           FREE TRKS -> DSCB5-FEHLERZEILE
         CLI   TTRACKS,C'0'            TTRACKS <= 9999
         BNE   AUSGTXT2                NEIN
         MVI   TTRACKS,C' '            LOESCHEN 1. FUEHRENDE NULL
         MVC   TSTERN1A+1(1),TSTERN1A      UND SCHIFTEN
         MVI   TSTERN1A,C' '               EVENTUELLER FEHLER-STERN1
AUSGTXT2 MVC   TTEXT,=C'FREE TRACKS     '
         PUT   SYSOUT,TLINE            AUSGEBEN VOL-FUSSZEILE 2
         CLI   TSTERN2,C'*'            DSCB5 FALSCH
         BNE   VOLFZ3                  NEIN
         CLI   SFEHLDA,X'01'           SYSFEHL SPEZIFIZIERT
         BNE   SFEHLNDA                NEIN
         AH    R3,TRKCNTSU             R3 = FREE TRKS + ALLOC. TRKS
         CVD   R3,DBLWORD              DRUCKAUFBEREITEN
         UNPK  XSUM,DBLWORD                SUMME FREE + ALLOC.
         OI    XSUM+4,X'F0'                TRACKS
         L     R2,TCANDCAP-4(R4)       CAPACITY IN TRACKS
         BCTR  R2,0                        - 1
         CVD   R2,DBLWORD              DRUCKAUFBEREITEN
         UNPK  XCAP,DBLWORD                CAPACITY
         OI    XCAP+4,X'F0'                IN TRACKS
         SR    R2,R3                   CAPACITY - SUMME FREE / ALLOC.
         BM    DUPLCUSE                    IST KLEINER NULL
         MVC   XTEXT,=CL16'TRACKS LOST.'
         B     SFHLLINE
DUPLCUSE MVC   XTEXT,=C'DUPLICATE USAGE.'
SFHLLINE PUT   SYSFEHL,XLINE           DSCB5-FEHLERZEILE
SFEHLNDA BAL   14,SETZRC12             RC = 12
         MVC   TSTERN1A(2),BLANKS      LOESCHEN TSTERN1A/B,
         MVI   TSTERN2,C' '                TSTERN2
VOLFZ3   LH    R3,DS4DSREC             ANZAHL BLANK DSCBS
         CVD   R3,DBLWORD                  DRUCKAUFBEREITEN
         UNPK  TTRACKS,DBLWORD
         OI    TTRACKS+4,X'F0'
         CLI   TTRACKS,C'0'            TRACKS <= 9999
         BNE   AUSGTXT3                NEIN
         MVI   TTRACKS,C' '            LOESCHEN 1. FUEHRENDE NULL
AUSGTXT3 MVC   TTEXT,=C'FREE DSCBS      '
         PUT   SYSOUT,TLINE            AUSGEBEN VOL-FUSSZEILE 3
         AP    LINENO,=P'3'            ERHOEHEN ZEILENZAEHLER UM 3
         MVI   VOLKPFDA,X'00'          LOESCHEN SCHALTER VOLKOPF VORH.
RTRNVOLF L     R14,SAVE2R14
         BR    14
***********************************************************************
         EJECT
***********************************************************************
*                                                                     *
*      UNTERPROGRAMM AUSGEBEN BAY001I AUF NEUER SEITE                 *
*                                                                     *
***********************************************************************
EDTPLINE ST    R14,SAVE1R14
         ZAP   LINENO,=P'80'           SETZEN SEITENWECHSEL
         MVC   ZLINE+1(18),=C'BAY001I FUNCTION: '
         LR    R3,R1                   LAENGENSCHLUESSEL
         BCTR  R3,0                        MVC
         EX    R3,MVCPRM               EINTRAGEN PARAMETER NACH BAY001I
         BAL   14,PRINT                BENUTZEN ZLINE FUER BAY001I
         L     R14,SAVE1R14
         BR    14
***********************************************************************
         SPACE 4
***********************************************************************
*                                                                     *
*      UNTERPROGRAMM DRUCKAUFB. RC UND AUSGEBEN FLINE                 *
*                                                                     *
***********************************************************************
EDITRC   ST    R14,SAVE3R14
         CVD   R15,DBLWORD             DRUCKAUFBEREITEN
         UNPK  FRC,DBLWORD                 RUECKKERKODE
         OI    FRC+1,X'F0'
         MVC   ZLINE+1(120),FLINE+1    FEHLERNACHRICHT
         BAL   14,PRINT                    AUSGEBEN
         L     R14,SAVE3R14
         BR    14
***********************************************************************
         SPACE 4
***********************************************************************
*                                                                     *
*      UNTERPROGRAMM SETZEN RC = 12                                   *
*                                                                     *
***********************************************************************
SETZRC12 ST    R14,SAVE3R14
         CLC   RC,=C'12'               RC >= 12
         BNL   RTRNRC12                JA
         MVC   RC,=C'12'               NEIN - RC = 12
RTRNRC12 L     R14,SAVE3R14
         BR    14
***********************************************************************
         EJECT
***********************************************************************
*                                                                     *
*      UNTERPROGRAMM NACHRICHTEN-AUSGABE                              *
*                                                                     *
***********************************************************************
PRINT    ST    R14,SAVE4R14
         CP    LINENO,=P'58'           ZEILENZAEHLER > 58
*                                      P'58' IST SO BEMESSEN, DASS BEI
*                                      VOLID-WECHSEL & SEITENENDE DIE
*                                      3 VOL-FUSSZEIL. NOCH PLATZ HABEN
         BNH   DRKZLINE                NEIN
         AP    PAGENO,=P'1'            JA - NEUE SEITE
         UNPK  ZPAGENO,PAGENO          DRUCKAUFBEREITEN
         OI    ZPAGENO+3,X'F0'             SEITENNUMMER
         PUT   SYSOUT,KLINE            UEBERSCHRIFT-1
         PUT   SYSOUT,BLINE            UEBERSCHRIFT-2
         ZAP   LINENO,=P'4'            ZEILENZAEHLER = 4
         MVI   ZVORS,C'0'
DRKZLINE AP    LINENO,=P'1'            ERHOEHEN ZEILENZAEHLER UM 1
         CLI   ZLINE,C'0'              LEERZEILE VORM DRUCKEN
         BNE   PRINTZ                  NEIN - ZEILENZ BLEIBT UM 1 ERH.
         AP    LINENO,=P'1'            JA - ZEILENZ. IST UM 2 ERHOEHT
PRINTZ   PUT   SYSOUT,ZLINE            DATEIZEILE
         MVC   ZLINE,BLANKS            LOESCHEN ZLINE
         L     R14,SAVE4R14
         BR    14
***********************************************************************
         EJECT
***********************************************************************
*                                                                     *
*      ARBEITSSPEICHERBEREICH                                         *
*                                                                     *
***********************************************************************
HALBWORT DC    H'0'          ZW-WERT
UADSADR  DC    F'0'
BZEIT    DC    CL15' '
RCODE    DC    H'0'
ANZSMF   DC    PL4'0'
DBLWORD  DC    D'0'          ZW-WERT ALLGEMEIN, PARAMETER UP CONV1
DBLWORD1 DC    D'0'          ZW-WERT UP CONV1
PARMADDR DS    F             ADRESSE PARM-PARAMETER
TIOTADDR DS    F             ADRESSE TASK I/O-TABLE
UCBADDR  DS    F             CURRENT UCB
SAVE1R14 DS    F             SAVE R14 (NXTVOL, DEVICEOK, NXTDSCB,
*                                      VRBDSCB1, DISP, SCRATCH,
*                                      EDTPLINE)
SAVE2R14 DS    F             SAVE R14 (GETTRKS, EDTZLINE, VOLFUSS)
SAVE3R14 DS    F             SAVE R14 (EDITRC, SETZRC12)
SAVE4R14 DS    F             SAVE R14 (PRINT)
DATE     DC    F'0'          DATUM BINAER (JTTX)
JOBNAME  DC    CL8' '        JOBNAME
JOBDATUM DC    CL8'SYS'      SYSJJTTT
PRMDA    DC    XL1'00'       SCHALTER STEUERPARAMETER:
*                                X'01' - PARM-ANGABE VORHANDEN
*                                X'02' - SYSIN SPEZIFIZIERT
*                                X'04' - KONSOL-EINGABE IST ERFOLGT
ZUSTAND  DC    CL1'A'        A - JOBANFANG
*                            P - PARM
*                            S - SYSIN
*                            C - CON
*                            E - JOBENDE
PARMINDX DC    H'0'          LFD. BYTE IN PARM-PARAMETERLISTE
CONINDEX DC    H'115'        LFD. BYTE REPLY-BEREICH
*                                MAXIMAL 115-STELLIG MIT MFT-RUECKSICHT
SYSINDEX DC    H'72'         LFD. BYTE SYSIN-KARTE
PARMLNGE DS    H             LAENGE PARM-PARAMETER
SPEZDSN  DC    CL44' '       DSNAME SPEZIFIZIERT IN PARAMETER
SPEZVOL  DC    CL6' '        VOLID SPEZIFIZIERT IN PARAMETER
BASFLAG  DC    X'00'                                               BASF
*                                                                  BASF
SMF      EQU   1                                                   BASF
SCRINV   EQU   2                                                   BASF
*                                                                  BASF
NOPRIV   EQU   16                                                  BASF
NO       EQU   32                                                  BASF
INV      EQU   128                                                 BASF
PRVRES   EQU   X'40'
*                                                                  BASF
*                                                                  BASF
INDEXLNG DC    H'0'          LAENGE INDEX
INDEXNM  DS    CL9           DSN AUS INDEX-PARAMETER + PUNKT
LISTPRM  DC    XL1'00'       X'01' - LIST × LIST=ALL
*                            X'02' - LIST=<VOLID>
*                            X'04' - LIST=STORAGE (MASKE TM SRTESTAB)
*                            X'08' - LIST=PUBLIC  (MASKE TM SRTESTAB)
*                            X'10' - LIST=PRIVATE (MASKE TM SRTESTAB)
KART0172 DS    CL72          SYSIN-KARTE SPALTE 1 - 72
         DS    CL8               REST SYSIN-KARTE
ANTWORT  DS    CL115         KONSOL-EINGABE
WRNGANTW DS    CL2           ANTWORT AUF WARNING
TESTANTW DS    CL3           ANTWORT AUF BAY0002D (PARAMETER TEST)
EOT      DC    XL1'00'       SCHALTER EOT (END OF PARAMETER 'TEST')
VOLKPFDA DC    XL1'00'       SCHALTER VOLKOPF VORHANDEN => VOLFUSS
DISPLBYT DS    CL1           DISPLACEMENT FUER B BMARKE
DSCBENDE DC    XL1'00'       SCHALTER DSCB-ENDE
RETAINSW DC    XL1'00'       SCHALTER RETAIN
DSCB4DA  DC    XL1'00'       SCHALTER DSCB 4
DURCHLF  DC    CL1'1'        SCHALTER DURCHLAUF
SFEHLDA  DC    XL1'01'       SCHALTER SYSFEHL VORHANDEN (GESETZT)
RC       DC    CL02'00'      RUECKKEHRKODE FUER JOBENDE-NACHRICHT
SVCCHHR  DC    CL5' '        SAVE CCHHR
SVUNIT   DC    CL3'   '      SAVE UNIT
DVTYP    DC    CL1' '        EINHEITENTYP
BAS164I  DC    C'BAS164I SPECIFY INDEX DATA SET (SYSLIB DD ) IF ''     *
                  '' IS REQUIRED'                                  BASF
BASVAR   EQU   *-21                                                BASF
TRKCNT   DC    H'0'          SPUR-ZAEHLER
TRKA     DC    H'0'          SPUR-VON
TRKB     DC    H'0'          SPUR-BIS
EXTCNT   DC    H'0'          EXTENT-ZAEHLER
TRKCNTSU DC    H'0'          ALLOCATED TRACKS
FREETRKS DC    H'0'          ZAEHLER FREE TRACKS (MAX. 19600)
KETTE5   DS    F             5 BYTES AUF WORTGRENZE
         DC    XL1'04'           FUER DRUCKEN R0, R1
BLANKS   DC    CL121' '      121 LEERZEICHEN
CYLNO    DC    H'0'          ZYLINDER-NUMMER
TRACKNO  DC    H'0'          SPUR-NUMMER
RECNO    DC    H'0'          SATZ-NUMMER
MTRACKNO DC    H'0'          DS4DEVSZ+2 (MAX TRACK ADDR)
MRECNO   DC    H'0'          DS4DEVT (MAX RECORD ADDR)
LINENO   DC    PL4'99'       ZEILENZAEHLER
PAGENO   DC    PL4'0'        SEITENZAEHLER
LINETRKS DC    CL6'  0000'   SPUR-ZAEHLER DRUCKAUFB. (ZLINE ZW-BEREICH)
LINEEXTS DC    CL2'00'       EXTENT-ZAEHLER DRUCKAUFB. (ZLINE ZW-BER.)
TRKMASK  DC    XL6'402120202020' MASKE FUER LINETRKS, ZUSED
WTORECB  DC    F'0'          ECB FOR WTOR
* VERBINDUNG ZUM BAY-MODUL (XCNTRL)
         ENTRY XEXTADDR
XEXTADDR EQU   *
XSYSOUT  DC    A(SYSOUT) ADRESSE SYSOUT-DCB
XSYSFEHL DC    A(SYSFEHL) ADRESSE SYSFEHL-DCB
XSAVECON DC    F'0' CONSOLE-ID VOM XCNTRL
XNXTPRM  DC    A(NXTPRM) NAECHSTER PARAMETR-MARKE
*                                                                     *
TCANDCAP DS    0F            TRACKS PER CYLINDER AND CAPACITY IN TRACKS
         DC    A(19,7676)    01-MSS    DISK STORAGE DEVICE
         DC    A(8,200)      02-2301   PARALLEL DRUM
         DC    A(10,800)     03-2303   SERIAL DRUM
         DC    A(46,11316)   04-2302   DISK STORAGE
         DC    A(20,19600)   05-2321   DATA CELL DRIVE
         DC    A(8,384)      06-2305/1 FIXED HEAD STORAGE / MODEL 1
         DC    A(8,768)     07-2305/2 FIXED HEAD STORAGE / MODEL 2
         DC    A(20,4000)    08-2314   DISK STORAGE FACILITY
         DC    A(19,7676)    09-3330   DISK STORAGE
         DC    2A(0)
         DC    A(30,16650)   0B-3350   DISK STORAGE
         DC    2A(0)
         DC    A(19,15352)    0D-3330-11 DISK STORAGE
         DC    A(15,13290)    0E-3380  DISK STORAGE
*                                                                     *
UNITTYP  EQU   *             EINHEITENTYPEN (S. AUCH TCANDCAP)
         DC    CL4'MSS '
         DC    CL4'2301'
         DC    CL4'2303'
         DC    CL4'2302'
         DC    CL4'2321'
         DC    CL4'2305'
         DC    CL4'2305'
         DC    CL4'2314'
         DC    CL4'3330'
         DC    1CL4' '        FILLER
         DC    CL4'3350'
         DC    CL4' '
         DC    CL4'3311'
         DC    CL4'3380'
*                                                                     *
TRTAB    DC    CL16'0123456789ABCDEF' TR-TABELLE FUER HEXA-DRUCKEN
*                                                                     *
TABKOMMA DS    0CL256
         DC    107X'00'
         DC    C','
         DC    148X'00'
*                                                                     *
TABCHAR  DS    0CL256
         DC    193X'FF'
         DC    X'00'         BUCHSTABE A - B BMARKE
         DC    X'FF'
         DC    X'04'         BUCHSTABE C - B BMARKE+4
         DC    X'08'         BUCHSTABE D - B BMARKE+8
         DC    X'0C'         BUCHSTABE E - B BMARKE+12
         DC    3X'FF'
         DC    X'10'         BUCHSTABE I - B BMARKE+16
         DC    9X'FF'
         DC    X'14'         BUCHSTABE L - B BMARKE+20
         DC    X'18'         BUCHSTABE M - B BMARKE+24
         DC    X'FF'
         DC    X'1C'         BUCHSTABE O - B BMARKE+28
         DC    X'20'         BUCHSTABE P - B BMARKE+32
         DC    10X'FF'
         DC    X'24'         BUCHSTABE S - B BMARKE+36
         DC    X'28'         BUCHSTABE T - B BMARKE+40
         DC    X'2C'         BUCHSTABE U - B BMARKE+44
         DC    27X'FF'
***********************************************************************
         SPACE 4
***********************************************************************
*                                                                     *
*      EX-MARKEN                                                      *
*                                                                     *
***********************************************************************
TRTKOMMA TRT   0(0,R5),TABKOMMA        SUCHEN NACH KOMMA
MVCDSN   MVC   SPEZDSN(0),13(R2)       UEBERTRAGEN DSN AUS PURGE-PRM
MVCDSN2  MVC   SPEZDSN(0),14(R14)      UEBERTRAGEN DSN AUS DELETE-PRM
MVCINDNM MVC   INDEXNM(0),6(R2)        UEBERTRAGEN DSN-ANFANG AUS
*                                          INDEX-PARAMETER
MVCUDSN  MVC   SPEZDSN(0),8(R2)        UEBERTRAGEN DSNAME AUS UNCATLG-
*                                          PARAMETER
MVCPRM   MVC   ZLINE+19(0),0(R2)       EINTRAGEN PARAMETER NACH BAY001I
MVCPRM2  MVC   UNPRM(0),0(R2)          EINTRAGEN PARAMETER IN BAY081I
CLCINDNM CLC   INDEXNM(0),DS1DSNAM     SOLL DATEI GELOESCHT WERDEN
VGL1INDX CLC   DS1DSNAM(0),0(R2)       VERGLEICHEN DSN-ANFANG MIT
*                                          GESCHUETZTEM INDEX
***********************************************************************
         EJECT
***********************************************************************
*                                                                     *
*      DCB-DEFINITIONEN                                               *
*                                                                     *
***********************************************************************
UADS     DCB   DDNAME=UADS,DSORG=PS,MACRF=GL,RECFM=F,LRECL=256,        *
               BLKSIZE=256,EODAD=ENDUADS
UADS1    DCB   DDNAME=UADS,DSORG=PS,MACRF=RP
SYSIN    DCB   DDNAME=SYSIN,MACRF=(GM),EODAD=PRMENDE,DSORG=PS,         *
               RECFM=FB,LRECL=80
SYSOUT   DCB   DDNAME=SYSPRINT,MACRF=(PM),DSORG=PS,                    *
               EXLST=EXITLIST,                                         *
               RECFM=FBA,LRECL=121
SYSFEHL  DCB   DDNAME=SYSDIAG,MACRF=(PM),DSORG=PS,                     *
               EXLST=EXITLIST,                                         *
               RECFM=FBA,LRECL=121
***********************************************************************
         SPACE 4
***********************************************************************
*                                                                     *
*      DCB EXIT-ROUTINE                                               *
*                                                                     *
***********************************************************************
EXITLIST DS    0F                      DCB EXIT LISTE
         DC    XL01'85'
         DC    AL03(DCBEXIT)
*
DCBEXIT  EQU   *                       ROUTINE ZUM ERGAENZEN DES DCB
         SR    R0,R0
         CH    R0,62(R1)               BLKSIZE SPEZIFIZIERT
         BNE   EXITRTN                 JA
         MVC   62(2,R1),82(R1)         NEIN - BLKSIZE=LRECL
EXITRTN  BR    14                      RUECKKEHR ZUR OPENROUTINE
***********************************************************************
         EJECT
***********************************************************************
*                                                                     *
*      DSCB-DEFINITIONEN                                              *
*                                                                     *
***********************************************************************
*** FORMAT 1
         DS    0D
DSCB1    DS    0CL140
DS1DSNAM DS    CL44          DATA SET NAME
DS1FMTID DS    CL1           DSCB FORMAT
         DS    CL8
DS1CREDT DS    CL3           CREATION DATE
DS1EXPDT DS    CL3           EXPIRATION DATE
         DS    CL16
DS1REFD  DS    CL3
         DS    CL4
DS1DSORG DS    CL2           DATA SET ORGANIZATION
         DS    CL9
DS1DSIND DS    CL1           DATA SET INDICATORS
         DS    CL4
DS1LSTAR DS    CL3           LAST BLOCK POINTER (TTR
DS1TRBAL DS    CL2                               LL)
         DS    CL2
DS1EXT1  DS    3CL10         EXTENT DESCRIPTIONS 1 - 3
*              BYTE 1   :    DATA SET EXTENT TYPE INDICATOR
*              BYTE 2   :    EXTENT SEQUENCE NUMBER
*              BYTE 3-6 :    CCHH - LOWER LIMIT OF THIS EXTENT
*              BYTE 7-10:    CCHH - UPPER LIMIT OF THIS EXTENT
DS1PTRDS DS    CL5           DIRECT-ACCESS ADDRESS OF NEXT DSCB
*** FORMAT 2
         DS    0D
DSCB2    DS    0CL140
         DS    CL44
DS2FMTID DS    CL1           DSCB FORMAT
         DS    CL90
DS2PTRDS DS    CL5           POINTER TO DSCB 3 IF ONE IS NEEDED
*** FORMAT 3
         DS    0D
DSCB3    DS    0CL140
         DS    CL4
DS3EXTNT DS    4CL10         4 EXTENT DESCRIPTIONS
DS3FMTID DS    CL1           DSCB FORMAT
         DS    CL95
*** FORMAT 4
         DS    0D
DSCB4    DS    0CL140
         DS    CL45
DS4HPCHR DS    CL5           HIGHEST DISK ADDRESS OF DSCB
DS4DSREC DS    CL2           AVAILABLE FORMAT 0 DSCBS IN VTOC
         DS    CL10
DS4DEVSZ DS    CL4           NO. OF LOGICAL CYLINDERS OR NO. OF TRACKS
         DS    CL8
DS4DEVDT DS    CL1           NO. OF DSCB'S ON A TRACK
         DS    CL30
DS4VTOCE DS    CL10          VTOC EXTENT
         DS    CL25
*** FORMAT 5
         DS    0D
DSCB5    DS    0CL140
         DS    CL4
DS5AVEXT DS    CL5
*              BYTE 1-2 :    RELATIVE TRACK ADDRESS
*              BYTE 3-4 :    EMPTY CYLINDERS
*              BYTE 5   :    UNUSED TRACKS
DS5EXTAV DS    7CL5          EXTENT 2 - 8
DS5FMTID DS    CL1           FORMAT ID
DS5MAVET DS    18CL5         EXTENT 9 - 26
DS5PTRDS DS    CL5           CCHHR ADDRESS OF NEXT DSCB 5
***********************************************************************
SAVEAREA DC    18F'0'
         EJECT
***********************************************************************
*                                                                     *
*      CAMLIST-MAKROS                                                 *
*                                                                     *
***********************************************************************
*** OBTAIN
CAMOBT   CAMLST SEEK,CCHHR,VOLUMSER,WORKFLD
CCHHR    DC    XL5'0'
VOLUMSER DC    CL6' '
         DS    0D
WORKFLD  DS    2CL175
*        RC=4  THE REQUIRED VOLUME WAS NOT MOUNTED
*        RC=8  THE DSCB WAS NOT FOUND IN THE VTOC OF THE SPEC. VOLUME
*        RC=12 A PERMANENT I/O ERROR WAS FOUND WHEN PROCESSING THE
*              SPECIFIED VOLUME
*        RC=16 INVALID WORK AREA POINTER
*        RC=20 CCHH NOT WITHIN BOUNDERIES OF VTOC EXTENT
*** LOCATE
LOCATE   CAMLST NAME,DSNAME,,WORKFLD
*** UNCATALOG
CAMCAT   CAMLST UNCAT,DSNAME
*        RC=4  REQUIRED CONTROL VOLUME NOT MOUNTED OR SPECIFIED
*              VOLUME DOES NOT CONTAIN SYSCTLG
*        RC=8  THE EXISTING CATALOG STRUCTURE IS INCONSISTENT WITH THE
*              OPERATION PERFORMED
*        RC=12 NOT USED WITH THE CATALOG MACRO
*        RC=16 THE INDEX STRUCTURE NECESSARY TO CATALOG THE DATA SET
*              DOES NOT EXIST
*       (RC=20 SPACE IS NOT AVAILABLE ON THE SPECIFIED CONTROL VOLUME)
*        RC=24 AN ATTEMPT WAS MADE TO CATALOG AN IMPROPERLY NAMED
*              GENERATION DATA SET
*        RC=28 A PERMANENT I/O ERROR WAS FOUND WHEN PROCESSING THE
*              CATALOG
*** SCRATCH
CAMSCR   CAMLST SCRATCH,DSNAME,,VOLIST,,OVRD
DSNAME   DS    CL44
VOLIST   DC    H'1'
         DC    X'00000000'   DEVICE TYPE
         DC    CL6' '        VOLUME SERIAL NUMBER
         DC    H'0'
*        RC=4  NO VOLUMES CONTAINING ANY PART OF THE DATA SET WERE
*              MOUNTED, NOR WAS A UCB ADDRESS CONTAINED IN R0
*        RC=8  AN UNUSUAL CONDITION WAS ENCOUNTERED ON 1 OR MORE VOLS
***********************************************************************
         EJECT
***********************************************************************
*                                                                     *
*      NACHRICHTEN-DEFINITIONEN                                       *
*                                                                     *
***********************************************************************
*** VOL-KOPFZEILE
DLINE    DS    0CL121
         DC    CL01'0'
         DC    CL02' '
         DC    CL05'UNIT='
DUNIT    DS    CL03
         DC    CL05',VOL='
DUNITTYP DS    CL04
         DC    CL01'='
DVOLID   DS    CL06
DSTAT    DC    CL1' '                                              BASF
         DC    CL1'('                                              BASF
DSTABB   DC    CL3' '                                              BASF
         DC    CL1'/'                                              BASF
DSTABA   DC    CL4' '                                              BASF
         DC    CL2')'                                              BASF
DSYSRES  DC    CL6' '                                              BASF
         DC    CL76' '                                             BASF
SCHAB    DC    C'   /RMV )       '                                 BASF
*** DATEIZEILE
ZLINE    DS    0CL121
ZVORS    DS    CL01
ZDSNAME  DS    CL44
         DS    CL02
ZTRACKS  DS    CL06          (BERECHNET IM FELD LINETRKS)
         DS    CL01
ZUSED    DS    CL06
         DS    CL04
ZEXTENTS DS    CL02
         DS    CL04
ZTYP     DS    CL02
         DS    CL01
ZCREDAT  DS    CL05
         DS    CL01
ZPURDAT  DS    CL05
         DS    CL01
ZREFDT   DS    CL05
         DS    CL01
ZACTION  DS    CL07
         DS    CL03
ZREASON  DS    CL20
*** VOL-FUSSZEILEN
TLINE    DS    0CL121
         DC    CL01' '
         DC    CL04' '
TTEXT    DS    CL16          ALLOC. TRACKS / FREE TRACKS / FREE DSCBS
         DC    CL26' '
TSTERN1A DC    CL01' '
TTRACKS  DS    CL05
TSTERN2  DC    CL01' '
         DC    CL67' '
*** SYSFEHL-LISTENKOPF
XKOPF    DS    0CL121
         DC    CL01'1'
         DC    CL40'DIAGNOSTICS: WARNING - INFORMATION MAY B'
         DC    CL40'E MEANINGLESS DUE TO MULTIPROGRAMMING IN'
         DC    CL40' PROGRESS.'
*** DSCB5-FEHLERZEILE
XLINE    DS    0CL121
         DC    CL01'0'
         DC    CL08'BAY124I '
         DC    CL04'VOL='
XUNITTYP DS    CL04
         DC    CL01'='
XVOLID   DS    CL06
         DC    CL29' DSCB-5 INCORRECT. ALLOCATED '
XALLOC   DS    CL05
         DC    CL07', FREE '
XFREE    DS    CL05
         DC    CL06', SUM '
XSUM     DS    CL05
         DC    CL02' ('
XCAP     DS    CL05
         DC    CL05'). - '
XTEXT    DS    CL16          TRACKS LOST. / DUPLICATE USAGE.
         DC    CL12' '
*** FEHLERNACHRICHT BAY121I
FLINE    DS    0CL121
         DC    CL01' '
         DC    CL08'BAY121I '
FMAKRO   DS    CL07
         DC    CL04'-RC='
FRC      DS    CL02
FR0TEXT  DC    CL05' '       CATALOG: ', R0='
FR0      DC    CL08' '       CATALOG: R0-INHALT HEX-DRUCKAUFBEREITET
FR1TEXT  DC    CL05' '       CATALOG: ', R1='
FR1      DC    CL08' '       CATALOG: R1-INHALT HEX-DRUCKAUFBEREITET
         DC    CL73' '
*** FEHLERNACHRICHT BAY081I
         DS    0F
UNMSG    EQU   *
UNLAENGE DC    AL02(UNMSGEND-UNMSG)
         DC    XL02'8000'    MCSFLAG FIELD
         DC    CL27'BAY081I PARAMETER INVALID: '
UNPRM    DS    CL97
UNMSGEND EQU   *
UNDRCODE DC    XL04'0400D000' DESC=6,ROUTCDE=(1,2,4)
*** UEBERSCHRIFT-1
KLINE    DS    0CL121
         DC    CL01'1'
ZDATE    DS    CL06
         DC    35C' '
         DC    CL70'SYSTEM SUPPORT UTILITIES - SUPERSCRATCH'
         DC    CL05'PAGE '
ZPAGENO  DS    CL04
*** UEBERSCHRIFT-2
BLINE    DS    0CL121
         DC    CL01'-'
         DC    CL40'------------------ DSNAME --------------'
         DC    CL40'----   TRACKS  USED EXTENTS TYP CRDTE EX'
         DC    CL40'DTE REFDT ACTION    ------ REASON ------'
*** WTOR-MESSAGE FUER PARAMETER 'TEST'
         DS    2F
TTMSG    EQU   *
TTLAENGE DC    AL02(TTMSGEND-TTMSG)
         DC    XL02'8000'    MCSFLAGS FIELD
         DC    CL12'BAY003D DSN='
TTDSN    DS    CL44
TTMSGEND EQU   *
TTDRCODE DC    XL04'0400D000' DESC=6,ROUTCDE=(1,2,4)
***********************************************************************
         EJECT
         LTORG
         SPACE 3
UADSBER  DS    CL4000
         EJECT
***********************************************************************
*                                                                     *
*      SONSTIGE KONTROLLBLOECKE (DSECTS)                              *
*                                                                     *
***********************************************************************
*** COMMUNICATION VECTOR TABLE
CVT      DSECT
CVTTCBP  DS    F             POINTER TO ADDRESS FOR NEXT & CURRENT TCB
         DS    9F
CVTILK2  DS    F             ADDR OF UCB ADDR LIST PORTION IN UCB LKUPT
         DS    3F
CVTDATE  DS    F             CURRENT DATE IN PACKED DECIMAL
         DS    CL156
*** TASK I/O - TABLE
TIOT     DSECT
TIOCNJOB DS    CL8           JOB NAME
         DS    CL16
TIOELNGH DS    CL1           LAENGE DD-ENTRY
         DS    CL3
TIOEDDNM DS    CL8           DD-NAME
*** DASD - UNIT CONTROL BLOCK
UCB      DSECT
         DS    CL1                                                 BASF
SRTECHAN DS    CL1                     ALLOCATION CHANNEL  MASK    BASF
ALTPATH  EQU   1                                                   BASF
         DS    CL1                                                 BASF
SRTESTAT DS    CL1           STATUS BYTE A
RES      EQU   X'20'                                               BASF
PRES     EQU   X'04'                                               BASF
SYSRES   EQU   X'02'                                               BASF
         DS    CL9
UCBNAME  DS    CL3           UNIT NAME
UCBTYP   DS    CL4           DEVICE TYPE
         DS    CL8
SRTEVOLI DS    CL6           VOLUME SERIAL NUMBER
SRTESTAB DS    CL1           STATUS BYTE B
PUBLIC   EQU   X'08'                                               BASF
STOR     EQU   X'04'                                               BASF
         DS    CL1
SRTEFSCT DS    CL4           RELATIVE ADDR OF VTOC FOR THIS VOL (TTR0)
         DS    CL100
UADSTAB  DSECT
LUID     DS    X
USERID   DS    CL8
TTRN     DS    CL4
ACCTNR   EQU   TTRN
***********************************************************************
         END   BAYPROGM
//LKED.SYSLMOD DD DSN=LU.LNKLIB(SUPSCR),DISP=SHR
./ ADD NAME=SPSCR01
         SUPSCR01 DSN=(ADS.,IMS.,IMS2.,IMS2VS.,IMSVS.,                 *
               PASSWORD,RO.,OPV3.,TP.,SCRIPT.,ADMPRINT.,IMSFT.,        *
               @W.,@PL.,@.,ASPEN,                                      *
               LU.,LUSG.,SYS1.,SYS3.,MSS.,TV.,IMSFTVS.),               *
               VOL=(RV,PG,TSO,SPOOL,VV,MSS,DSP,DSC,DSR,DSS)
./ ADD NAME=KEYSCAN
         TITLE '*** KEYSCAN ***  GENERAL INFORMATION.'
* THIS PROGRAM ANALYSES A HEADER RECORD AND BUILDS UP
* A TABLE WHICH ADDRESS IS PASSED IN REGISTER 1.
* IT IS USED AS A SUBPROGRAM BY  :
*        CALL  KEYSCAN,(HEADER)
         SPACE 2
* FORM OF HEADER :  (ON A HALFWORD BOUNDARY)
         SPACE 1
* H1     DC    H'XX,0'   XX = LENGTH OF HEADER INCLUDING
*                             2 BYTES LENGTH, 2 BYTES ZEROES
*        DC    C'KEY1=PARM1,KEY2=PARM2,.....'
         SPACE 2
* FORM OF TABLE :   (ON A DOUBLEWORD BOUNDARY)
         SPACE 1
*        LLLL       LENGTH OF TABLE    (HEX)
*        LL         LENGTH OF KEYWORD  (HEX)
*        CC...      KEYWORD            (CHAR)
*        X'40'      ONLY IF KEYLENGTH WAS EVEN, OTHERWISE MISSING
*        YYYY       OFFSET OF KEYWORD IN HEADER  (HEX)
*        ZZZZ       LENGTH OF PARM    IN HEADER  (HEX)
*        ....
*        X'FFFF'    TABLE END SIGN
         SPACE 3
* EXAMPLE OF USE
         SPACE 2
* H1     DC    H'31,0'
*        DC    CL27'Q=ABC,D=''X=''Z'',F,R=(80,10)'
         SPACE 1
* AFTER CALLING KEYSCAN R1 POINTS AT THE FOLLOWING TABLE :
* X'001C01D9 00160007 01C60014 000001C4 000A0007 01D80004 0003FFFF'
         SPACE 3
* WHILE CREATING A HEADER THE USER SHOULD FOLLOW THE RULES OF THE JCL
* THE FOLLOWING RECORDS WOULD BE INCORRECT :
         SPACE 1
* X'00030000' C'X=1'                         WRONG LENGTH
* X'00120000' C'AB=(80,5)),B=C'              WRONG USE OF APOSTROPHEES
* X'00090000' C'R=A=4'                       = NOT INSIDE APOSTROPHEES
* X'00080000' C' X=1'                        1ST CHARACTER IS BLANK
*                   (A BLANK IS ALWAYS INTERPRETED AS END OF RECORD)
         SPACE 3
* AFTER RETURN REGISTER 15 SHOULD CONTAIN ZEROES :  ALL OK
* IF REGISTER 15 CONTAINS 4, AN ERROR WAS DETECTED
         TITLE '*** KEYSCAN ***   PROGRAM CHANGES.....'
         SPACE 15
*   SEVERAL CHANGES HAVE BEEN DONE
         SPACE 2
*   1. EVEN NUMBER OF APOSTROPHES WITHIN KEYWORD ALLOWED
*   2. BLANKS - ENCLOSED IN APOSTROPHES - ARE ALLOWED WITHIN KEYWORD
*      AND PARAMETER
*   3. COMMA AS LAST SIGN BEHIND LAST OPERAND ALLOWED
*                  (ON A VERY SPECIAL REQUEST OF H SOLTAU)
*   4. A KEYWORD AS   XXX=,   IS TREATED AS   XXX,
         SPACE 3
*   PGM CHANGE ON 30/6/76 :
*       MVT-FREEMAIN DID NOT CHANGE R15, WHICH IS DONE BY MVS
*       THUS THE RETCD IS SAVED BEFORE FREEMAIN AND LOADED AGAIN
*       AFTER IT                                (R. RUESSEL)
         SPACE 3
*   PGM CHANGE ON 05/8/80 :
*       AN OPERAND LONGER THAN 255 CHARACTERS WAS NOT CHECKED
*       CORRECTLY BECAUSE OF USING TRT AND NOT COMPARING THE
*       LENGTH BEFORE TRT. SO HANDLING THIS LONG STRING ONLY
*       THE LAST BYTE WAS USED INSTEAD OF THE WHOLE LENGTH.
*       E.G. STRING LENGTH X'00000101' STRING LENGTH 1 ASSUMED
*            ALTHOUGH THERE IS A LOT MORE TO CHECK.
*       CIRCUMVENTION: IF LENGTH > 255, 255 IS ASSUMED AS LENGTH
*       TO CHECK NEXT.                          (R. RUESSEL)
         TITLE '*** KEYSCAN ***  EQUATE SUYMBOLS, REGISTER USE'
KEYSCAN  CSECT
         SPACE 2
* EQUATE SYMBOLS
*        USE OF REGISTERS
         SPACE 1
         REG
         SPACE 1
* REG 12 USED AS BASE REGISTER FOR HDRSCANV
* REG 13 USED AS BASE REGISTER FOR DSECT
* REG 11 USED AS COUNTER FOR PARENTHESIS
* REG 9  USED AS COUNTER FOR NOAPS
* REG 5  USED AS VARIABLE LENGTH FOR TRT BY EX
         SPACE 1
H        EQU   3         POINTER THROUGH HEADER
T        EQU   4         POINTER THROUGH TABLE
W1       EQU   6         WORK REGISTER 1
W2       EQU   7         WORK REGISTER 2
W3       EQU   8         WORK REGISTER 3
LL       EQU   10        TABLE LENGTH
         SPACE 1
*        EXPLANATION OF BITS SET IN SW
         SPACE 1
PAR      EQU   X'01'     ON WHILE SCANNING A PARAMETER OF THE HEADER
KEY      EQU   X'02'     ON WHILE SCANNING A KEYWORD   OF THE HEADER
LPA      EQU   X'04'     ON WHEN LEFT PARENTHESIS OCCURED
RPA      EQU   X'08'     ON WHEN RIGHT PARENTHESIS OCCURED
FIN      EQU   X'10'     ON WHEN END OF HEADER WAS FOUND
FND      EQU   X'20'     ON WHEN AT LEAST ONE KEYWORD FOUND
EQ       EQU   X'40'     ON WHEN     KEY=,
         TITLE '*** KEYSCAN ***  CHAINING SAVE AREAS, START OF PROGRAM'
         XSAVE 12,,KEYSCAN,DUMEND-DUM
         USING DUM,13
         L     H,0(1)              LOAD HDR LENGTH ADDRESS
         LH    W1,0(H)             LOAD LENGTH
         SH    W1,=H'4'            IT MUST BE > 4, ELSE ERROR
         BNP   ERROR0
         ST    H,HSA               SAVE HDR START ADDRESS
         LA    H,4(H)              SET H ON 1ST KEYWORD
         ST    H,KEYADDR           SAVE H AS ADDR OF 1ST KEYWORD
         CLI   0(H),C' '           1ST CHAR BLANK ?
         BE    ERROR0
         CLI   0(H),C'='
         BE    ERROR0
         LR    5,H
         AR    5,W1                FIND END OF HDR + 1
         BCTR  5,0                 (EX)
         ST    5,HEA               SAVE HEADER END ADDRESS
         MVI   SW,X'00'            CLEAR SWITCH
         OI    SW,KEY
         SPACE 2
         LH    T,=H'800'
         GETMAIN R,LV=(T)  GET MAX OF STORAGE THAT COULD BE REQUESTED
         ST    1,TABSTART          SAVE TABLE START ADDRESS
         AR    T,1                 FIND END OF TABLE
         SH    T,=H'2'             DECREASE T BY 2
         LA    LL,2                LL = 2
         MVC   0(2,T),=X'FFFF'     SET TABLE END SIGN
         XC    NOAP,NOAP           CLEAR NO. OF APOSTROPHEES
         SR    2,2                 CLEAR REG2 (BECAUSE OF TRT)
         SR    9,9                 CLEAP COUNTER FOR NOAP
         SR    11,11               CLEAR COUNTER FOR PARENTHESES
         TITLE '*** KEYSCAN ***  ANALYSING HEADER'
TRTSTART L     5,HEA               FIND LENGTH FOR TRT INSTRUCTION
         SR    5,H                 SUBTRACT TRT- START ADDR
         SPACE
* CHANGE 5.8.80
         CH    R5,=H'255'          IS STRING TO SEARCH > 255 ?
         BNH   *+8                 IF NOT SKIP SETTING HIGH VALUE
         LH    R5,=H'255'          SET LENGTH REG TO MAX TRT VALUE
* END OF CHANGE 5.8.80
         SPACE
         LTR   5,5
         BM    SETR1               IF MINUS, END OF HEADER FOUND
         EX    5,TRT               FIND NEXT BYTE OF TRTTAB NOT ZERO
         BZ    SETR1               NOTHING LEFT
         CLI   0(1),C'='
         BE    EQSIGN              T E S T
         CLI   0(1),C','               F O U N D
         BE    COMMA                       B Y T E
         CLI   0(1),C' '
         BE    BLANK
         CLI   0(1),C''''
         BE    APOS
         CLI   0(1),C'('
         BE    LEFTPAR
         B     RIGPAR
         SPACE 2
EQSIGN   TM    NOAP+1,X'01'        = INSIDE APOSTROPHEES
         BO    SETH                IF YES SKIP SAVING KEY
         TM    SW,PAR              PROCESSING IN PARM STATE ?
         BO    ERROR               IF YES :  ERROR
         CLI   1(1),C','           PROVIDE   KEY1=,KEY2=,   ...
         BNE   SETPAR
         OI    SW,EQ               LENGTH WILL BE 1 TOO HIGH
         B     SAVE1
SETPAR   EQU   *
         OI    SW,PAR              SET PARM BIT
         NI    SW,255-KEY          CLEAR KEY BIT
         SPACE 1
SAVE1    EQU   *
         ST    1,ADDREQ            SAVE ADDR OF EQ SIGN
         SR    1,H
         STH   1,KEYLEN            SAVE LENGTH OF THIS KEYWORD
         LA    H,1(1,H)            SET H ON FOUND ADDR + 1
         B     TRTSTART
         SPACE 1
APOS     LA    9,1(9)              APOSTROPH  FOUND, COUNTER + 1
         STH   9,NOAP              SAVE NUMBER
         B     SETH
         SPACE 1
LEFTPAR  EQU   *
         TM    NOAP+1,X'01'        IF NOAP UNEVEN LEFT PAREN
         BO    SETH                MAY BE CHAR INSIDE APOSTROPHEES
         LTR   11,11               TEST IF ( HAD OCCURED EARLIER
         BNZ   ADD1                IF YES SKIP NEXT TEST
         LR    W1,1
         BCTR  W1,0
         CLI   0(W1),C'='
         BNE   ERROR
         OI    SW,LPA              SET SW FOR LEFT PAREN
ADD1     LA    11,1(11)            R11 + 1
         B     SETH
         SPACE 1
RIGPAR   EQU   *
         TM    NOAP+1,X'01'        IF NOAP UNEVEN RIGHT PAREN
         BO    SETH                MAY BE INSIDE APOSTROPHEES
         TM    SW,LPA              IF NOT THERE MUST HAVE BEEN
         BZ    ERROR               A LEFT PAREN, ELSE :  ERROR
         OI    SW,RPA              SET RIGHT PAREN BIT
         BCTR  11,0                R11 - 1
         LTR   11,11               PROCESSING STILL INSIDE PARENS ?
         BNZ   SETH
         L     W1,HEA
         SR    W1,1                TEST, IF ) IS FOLLOWED BY ,
         BZ    *+12
         CLI   1(1),C','
         BNE   ERROR
         NI    SW,255-LPA          CLEAR LPA BIT
         SPACE 2
SETH     LA    H,1(1)              SET H
         TM    SW,FIN
         BO    ERROR
         B     TRTSTART
         SPACE 2
BLANK    EQU   *
         TM    NOAP+1,X'01'
         BO    SETH
         B     SETLAST
         SPACE 2
         TITLE '*** KEYSCAN *** END OF 1 PARM, FILLING TABLE '
SETR1    L     1,HEA               MAKE R1 POINT AT HEA + 1
         LA    1,1(1)
SETLAST  OI    SW,FIN              SET END OF HEADER BIT
COMMA    TM    SW,LPA              COMMA FOUND. END OF ONE PARM, IF
         BO    SETH                 IT IS NOT INSIDE OF PARENS
         TM    NOAP+1,X'01' NO OF APOS. IN PARM FIELD MUST BE EVEN
         BO    SETH
         LTR   11,11               TEST IF NO. OF ( WAS EQUAL TO NO. OF
         BNZ   ERROR
         LA    H,1(1)              SET H
         LR    W1,1                TEST IF ) WAS JUST BEFORE
         BCTR  W1,0                  COMMA
         CLI   0(W1),C','          TWO COMMAS ?
         BE    SVKEYAD             IF YES :  IGNORE ONE
         L     W2,HSA              WAS 1ST SIGN A COMMA ?
         LA    W2,4(W2)            IF YES IGNORE IT
         CR    W2,1                SAME ADDR LIKE HSA + 4 ?
         BE    SVKEYAD
         TM    SW,RPA              WAS ) IN PARM ?
         BZ    GETOFF              IF NO SKIP NEXT STATEMENTS
         TM    SW,FIN
         BO    GETOFF
         CLI   0(W1),C')'          IF NOT: ERROR
         BNE   ERROR
GETOFF   EQU   *                   GET OFFSET
         L     W1,KEYADDR          LOAD ADDR OF KEYWORD
         S     W1,HSA              SUBTRACT HEADER START ADDR
         STH   W1,OFF              SAVE DIFFERENCE AS OFFSET
         TM    SW,KEY              PROCESSING STILL IN KEY STATE ?
         BO    NOPAR
         S     1,ADDREQ            R1 = LENGTH OF PARM
         BCTR  1,0                 OFF = OFFSET KEYWORD IN TABLE
         B     FILTAB
NOPAR    EQU   *                   HEADER WAS : ...,KEY,... (NO PARM)
         S      1,KEYADDR
         TM    SW,EQ               WAS   KEY=,    ?
         BZ    *+6                 IF ZERO IT WAS   KEY,
         BCTR  1,0                 KEYLENGTH - 1
         STH   1,KEYLEN
         SR    1,1                 PARM LENGTH IS ZERO
FILTAB   EQU   *
         TM    KEYLEN+1,X'01'      KEYLEN EVEN ?
         BO    *+10                --- IF NO SKIP
         BCTR  T,0                   ×  NEXT     STATEMENT
         LA    LL,1(LL)              ×
         SH    T,KEYLEN            <--  DECREASE T BY KEYLEN
         SH    T,=H'5'             2 OFFSET, 2 LEN PARM, 1 LEN KEY
         AH    LL,KEYLEN           ADD KEYLENGTH TO TABLE LENGTH
         LA    LL,5(LL)
         L     W1,KEYADDR          SET W1 ON KEYWORD
         LH    W3,KEYLEN           LOAD IT'S LENGTH
         STC   W3,0(T)             STORE IT INTO 1ST BYTE
         BCTR  W3,0                W3 = W3 - 1 (BECAUSE OF EX)
         EX    W3,MOVEKEY          MOVE KEYWORD INTO TABLE
         OI    SW,FND              AT LEAST ONE FOUND
         TM    KEYLEN+1,X'01'      WERE NO. OF CHAR EVEN ?
         BO    NOBLANK             ---  IF NO SKIP
         LR    W1,W3                 ×  FILLING ONE BYTE WITH A BLANK
         AR    W1,T                  ×
         MVI   2(W1),X'40'           ×
         LA    W3,1(W3)              ×
NOBLANK  LH    W1,OFF              <--
         STH   W1,2(W3,T)          STORE OFFSET INTO TABLE
         STH   1,4(W3,T)           STORE LENGTH INTO TABLE
SVKEYAD  ST    H,KEYADDR           SAVE ADDR OF  KEYWORD
         SPACE 1
         XC    NOAP,NOAP
         SR    9,9                 CLEAR COUNTER FOR NOAPS
         NI    SW,255-LPA-RPA-PAR-EQ   CLEAR BITS
         OI    SW,KEY              NOW AGAIN A KEYWORD IS TO BE FOUND
         TM    SW,FIN              WAS LAST PARM ?
         BZ    TRTSTART            IF NO, TRY TO FIND NEXT
         TM    SW,FND              ONLY COMMAS FOUND ?
         BZ    ERROR               YES IF ZERO
         SH    T,=H'2'             DECREASE T BY 2
         LA    LL,2(LL)            LL + 2
         STH   LL,0(T)             SAVE IT AT BEGINNING OF TABLE
         SPACE 2
         STH   T,SHIFT             SAVE RIGHT HALF OF TABLE ADDRESS
         MVI   SHIFT,X'00'
         NI    SHIFT+1,X'07'       GET   0000 0XXX
         SH    T,SHIFT             SET T AT A DOUBLEWORD BOUNDARY
         LR    W1,T
         MVC   MOVETAB(6),MVC
         MVC   MOVETAB+5(1),SHIFT+1    STORE DIFFERENCE INTO MOVETAB
SHIFTTAB EX    0,MOVETAB
         LA    W1,1(W1)
         BCT   LL,SHIFTTAB         SHIFT LEFT WHOLE TABLE
         SPACE 1
         SR    15,15               CLEAR REG 15, ALL OK
GETBACK  EQU   *
         L     1,TABSTART          LA OF 1ST GETMAINED BYTE
         LA    T,0(T)              CLEAR HIGH ORDER BYTE
         LR    0,T                 LOAD TABLE ADDR
         SR    0,1                 GET DIFFERENCE
         STH   R15,SVRETCD    SAVE RET CODE
         FREEMAIN R,LV=(0),A=(1)   FREE UNUSED AREA
         L     1,4(0,13)          GET HSA ADDR
         ST    T,24(0,1)     STORE TAB ADDR INTO SA AS REG 1
         LH    R15,SVRETCD    GET RET CD BACK
XRET     XRETURN (15),R
ERROR0   LA    15,4                ERROR, BUT NO FREMAIN
         B     XRET
ERROR    LA    15,4                ERROR FOUND. SET REG 15 ON 4
         B     GETBACK
         TITLE '*** KEYSCAN ***  TRANSLATE AND TEST TABLE, DSECT'
TRTTAB   DC    256X'00'
         ORG   TRTTAB+64
         DC    C' '                BLANK
         ORG   TRTTAB+77
         DC    C'('                LEFT PAREN  (
         ORG   TRTTAB+93
         DC    C')'                RIGHT PAREN )
         ORG   TRTTAB+107
         DC    C','                COMMA       ,
         ORG   TRTTAB+125
         DC    C'''='              APOSTROPHEE '  EQUAL SIGN =
         ORG   TRTTAB+256
         SPACE 2
MVC      MVC   0(1,W1),0(W1)
MOVEKEY  MVC   1(0,T),0(W1)        MOVE KEYWORD INTO TABLE
TRT      TRT   0(0,H),TRTTAB       FIND NEXT BYTE IN TRTTAB NOT ZERO
         LTORG
         SPACE 2
DUM      DSECT
SAVEAREA DS    18F
HSA      DS    F                   HEADER START ADDRESS
HEA      DS    F                   HEADER END ADDRESS
TABSTART DS    F                   ADDR OF 1ST GETMAINED BYTE
ADDREQ   DS    F                   ADDR OF = BEHIND KEYWORD
KEYADDR  DS    F                   ADDR OF KEYWORD
OFF      DS    H                   OFFSET OF PARM IN HEADER
NOAP     DS    H                   NO. OF APOSTROPHEES
KEYLEN   DS    H                   LENGTH OF KEYWORD
SHIFT    DS    H                   USED FOR SHIFTING TABLE
SVRETCD  DS    H              RETURN CODE SAVE AREA
MOVETAB  MVC   0(1,W1),0(W1)
SW       DS    CL1
DUMEND   EQU   *
         END
./ ADD NAME=TIOTSCAN
TIOTSCAN CSECT
*
*        AUTHOR: H. FRANZ
*
*              THIS PROGRAM EXPECTS IN REG 1 THE ADDRESS OF
*              AN 8-BYTE DDNAME AND RETURNS IN REG 15
*              THE ADDRESS OF THE ASSOCIATED TIOT-ENTRY OR
*              ZERO IF NO TIOT-ENTRY WAS FOUND.
*
*              ROUTINE IS REENTRABLE
*
         USING *,15
         STM   14,2,12(13)   SAVE REGS
         L     2,16          A(CVT)
         L     2,0(2)        A(CVTTCBP)
         L     2,4(2)        A(CURRTCB)
         L     2,12(2)       A(TIOT)
         LA    2,24(2)       FIRST TIOT ENTRY
         SR    0,0           CLEAR REG
CLC      CLC   4(8,2),0(1)   DDNAME EQUAL ?
         BE    FOUND         YES, RETURN
         IC    0,0(2)        GET ENTRY LENGTH
         LTR   0,0           LAST ONE ?
         BZ    NOTFOUND      YES, RETURN WITH CODE 0
         AR    2,0           NO, EXAMINE NEXT ONE
         B     CLC
NOTFOUND SR    2,2
FOUND    ST    2,16(13)      STORE CODE FOR REG 15
         LM    14,2,12(13)   RELOAD REGS, CHANGED IS REG 15 ONLY
         SPM   14            SET PROGRAM MASK
         BR    14            RETURN TO CALLER
         END
./ ADD NAME=HDRSCAN
HDRSCAN  START
*  THIS PROGRAM ANALYSES A HEADER-RECORD ACCORDING TO
*  A PARAMETER-TABLE
*  USED  AS A SUBPROGRAM
*  BY :  CALL HDRSCAN,(RECORD,TABLE)
*  FORM OF THE RECORD :  ×LLXX..PARAMETERS...×
*  FORM OF THE TABLE  :  DC CL1'P1',CL5' ',CL1'P2',CL5' ',...,XL1'FF'
*  AFTER EXECUTION OF HDRSCAN  THE TABLE HAS THE FOLLOWING FORM :
*     ×1 BYTE-PARAMETER×1 BYTE UNUSED/2 BYTES DISPLAC/2 BYTES LENGTH/
*  RETURN-CODES :    0    NO ERRORS
*                    ^= 0 ERROR IN PARAMETER-LIST
*  IF AN ERROR OCCURS THE CURRENT EXAMINATION-ADRESS IS SAVED IN ERRSAV
*  AND FILLED IN  REG15
*  REGISTER USE :
RECREG   EQU   0
TABREG   EQU   1
LENGTHR  EQU   3
SAVE1    EQU   4
SAVE2    EQU   5
CHAREG   EQU   6
WORK1    EQU   7
WORK2    EQU   8
WORK3    EQU   9
COUNTR   EQU   10
POINTR   EQU   11
         XSAVE 12,,HDRSCAN
         LM    SAVE1,SAVE2,0(1)    LOAD   REGISTERS
         LH    LENGTHR,0(SAVE1)     TOTAL LENGTH OF RECORD
         USING DYNAM,14
         GETMAIN R,LV=268
         ST    14,0(1)
         LR    14,1
*     CLEARING OF TRT-TABLE
         MVI   TRTTAB,X'00'
         MVC   TRTTAB+1(255),TRTTAB
*     INSERTATION  OF FIX VALUES
         MVI   TRTTAB+BLANK,X'38'   BLANK
         MVI   TRTTAB+X'4D',X'28'  LEFT  PAREN
         MVI   TRTTAB+X'5D',X'2C'     RIGHT PAREN
         MVI   TRTTAB+X'6B',X'34'     PERIOD
         MVI   TRTTAB+X'7D',X'30'     QUOTE
         MVI   TRTTAB+X'7E',X'3C'     EQUAL-SIGN
         MVI   FUNCB,X'00'
*  NOW THE PARAMETERS ARE FILLED IN  THE TRT-TABLE
FILLTAB  LA    CHAREG,1             FIRST TRT-VALUE = X'01'
         LR    POINTR,SAVE2         START OF TABLE
LOOP     CLI   0(POINTR),X'FF'      END OF TABLE ?
         BE    ENDLOOP              YES,BRANCH
         SR    WORK2,WORK2          CLEAR REG FOR  IC
         IC    WORK2,0(POINTR)      INSERT PARAMETER
         LA    WORK3,TRTTAB         COMPUTE THE CORRESPONDING
         LA    WORK3,0(WORK2,WORK3) PLACE IN THE TRT-TABLE AND
         STC   CHAREG,0(WORK3)      INSERT CURRENT TRT-VALUE
         LA    CHAREG,1(CHAREG)     INCREASE TRT-VALUE BY 1
         XC    2(4,POINTR),2(POINTR)  CLEARING OF TABLE WITH X'00'
*  AND THE TABLE IS CLEARED WITH X'00'
         LA    POINTR,6(POINTR)     NEXT PARAMETER
         B     LOOP                 TO FILL IN
ENDLOOP  CH    LENGTHR,=H'4'        NO PARAMETERS IN REC ?
         BNH   RETURN0              YES, RETURN
         BCTR  CHAREG,0             PARAMETERS IN
         LTR   CHAREG,CHAREG        TABLE ?
         BZ    RETURN0              NO, RETURN
*  NOW THE HEADER IS SCANNED
SCANHDR  EQU   *
         SR    COUNTR,COUNTR
         NI    SWITCH,X'00'
         OI    SWITCH,START+BLANK+PER  START-VALUES OF SWITCH
         LR    WORK2,LENGTHR        WORK2  CONTAINS
         SH    WORK2,=H'4'          THE LENGTH FOR TRT-INSTRUCTION
         LA    WORK1,4(SAVE1)       WORK1 CONTAINS THE CURRENT EX-ADRES
*   IS  FIRST CHARACTER A LEGAL PARAMETER
         LR    WORK3,WORK2   SET START-VALUES
         LR    POINTR,WORK1
CLIINST  CLI   0(POINTR),BLANK  BLANK ?
         BNE   TRTFIRST   NO  GO TO TRT
         BCTR  WORK3,0
         LTR   WORK3,WORK3   END  OF RECORD
         BZ    RETURN0    YES   RETURN
         LA    POINTR,1(POINTR)
         B     CLIINST
TRTFIN   TRT   0(0,POINTR),TRTTAB
TRTFIRST BCTR  WORK3,0
         EX    WORK3,TRTFIN
         BZ    RETURN0
         CR    1,POINTR  LEGAL PARAMETER
         BNH   *+8
         OI    SWITCH,BEG
         LR    POINTR,WORK1
EXTRT    SR    1,1                  CLEARING OF REGISTERS
         SR    2,2                  FOR  TRT-INSTRUCTION
         BCTR  WORK2,0              FOR EX  REQUIRED
         EX    WORK2,TRTINST
         BZ    RETURN0              END OF EXAMINATION
         BH    HANDLAST             HANDLE LAST CHARACTER
         CH    2,=H'40'             PARAMETER ?
         BL    PARAM                YES
         SH    2,=H'40'             NO, COMPUTE RIGHT
         B     *+4(2)               BRANCH-INSTRUCTION
         B     LEFTPAR
         B     RIGHTPAR
         B     QUOTES
         B     PERIODS
         B     BLANKS
         B     EQUALSIG
PARAM    EQU   *
         TM    SWITCH,START         START OF EXAMINATION ?
         BO    PFOUND               YES,FIRST PARAM FOUND
         TM    SWITCH,BLANK         BLANKS?
         BZ    RETURN8              YES,ERROR
         TM    SWITCH,HIGH+LPAR+EQUA     WAS ONE OF THIS?
         BNZ   COMPADD                   YES,SKIP IT
         TM    SWITCH,BEG           PARAMETER OF LENGTH 2 ?
         BO    RETURN8              YES,ERROR
PFOUND   EQU   *                    START OF A PARAMETER
         SR    COUNTR,COUNTR
         NI    SWITCH,255-START     CLEAR SWITCH
         ST    1,BEGINN             SAVING OF THE START-ADRESS
         STC   2,FUNCB              SAVING OF THE TRT-VALUE
         OI    SWITCH,BEG           SET SWITCH
         B     COMPADD
LEFTPAR  EQU   *                    LEFT PARENTHESIS
         TM    SWITCH,HIGH          WAS QUOTE ?
         BO    COMPADD              YES, SKIP IT
         TM    SWITCH,BEG+BLANK+EQUA+PER
         BNO   RETURN8              NO, ERROR
         LTR   COUNTR,COUNTR        SECOND  PARENTH   ?
         BP    SECPAR    YES
         BCTR  1,0
         CLI   0(1),EQUAL   IS LAST CHARACTER AN EQUAL-SIGN ?
         BNE   RETURN8
         LA    1,1(1)
SECPAR   EQU   *
         OI    SWITCH,LPAR          SET SWITCH
         LA    COUNTR,1(COUNTR)     INCREASE COUNTER
         B     COMPADD
RIGHTPAR EQU   *                    RIGHT PARENTHESIS
         TM    SWITCH,HIGH
         BO    COMPADD
         TM    SWITCH,BEG+LPAR+BLANK+EQUA
         BNO   RETURN8
         BCTR  COUNTR,0             DECREASE COUNTER
         LTR   COUNTR,COUNTR
         BP    COMPADD
         NI    SWITCH,255-LPAR
         B     COMPADD
PERIODS  EQU   *                    PERIOD
         TM    SWITCH,BEG+BLANK
         BNO   RETURN8
         TM    SWITCH,HIGH+LPAR
         BNZ   COMPADD
ENDPARA  EQU   *                    END OF PARAMETER FOUND
         LTR   COUNTR,COUNTR        COUNTER=0 ?
         BNZ   RETURN8              NO, ERROR
         CLI   FUNCB,X'00'         UNKNOWN CHARACTER ?
         BE    FILLIN+4    YES,SKIP FILLIN
         L     CHAREG,BEGINN        COMPUTATION OF
         SR    CHAREG,SAVE1         DISPLACEMENT IN RECORD
         SR    WORK3,WORK3          COMPUTATION OF
         IC    WORK3,FUNCB          DISPLACEMENT IN TABLE
         BCTR  WORK3,0
         MH    WORK3,=H'6'
         STH   CHAREG,2(WORK3,SAVE2)
         TM    SWITCH,EQUA          WAS THERE AN EQUAL-SIGN
         BO    *+12                 YES,BRANCH
         LA    COUNTR,0             NO ,LENGTH=0
         B     FILLIN
         LR    COUNTR,1             COMPUTATION
         L     CHAREG,BEGINN        OF
         LA    CHAREG,2(CHAREG)     LENGTH
         SR    COUNTR,CHAREG
         TM    SWITCH,END
         BZ    FILLIN
         LA    COUNTR,1(COUNTR)
         TM    SWITCH,BLANK
         BO    FILLIN
         CLI   0(1),BLANK
         BNE   *+12
         BCTR  COUNTR,0
         BCTR  1,0
         B     *-12
FILLIN   STH   COUNTR,4(WORK3,SAVE2)         STORE IN THE LENGTH
         SR    COUNTR,COUNTR
         NI    SWITCH,255-LPAR-EQUA-HIGH-BEG  CLEAR THE SWITCH
         OI    SWITCH,PER
         TM    SWITCH,END                    END OF EXAMINATION?
         BO    RETURN0                       YES,RETURN
NEXTC    LR    WORK3,1
         TRT   1(1,1),TRTTAB    IS NEXT CHARACTER IN TABLE ;
         BZ    SEARCH  NO,SEARCH OF NEXT PERIOD
         LR    1,WORK3   YES,GO ON
         B     COMPADD
SEARCH   LA    1,1(WORK3)
         BCTR  WORK2,0
         LTR   WORK2,WORK2   END  OF RECORD
         BNP   RETURN0   YES,  RETURN
         MVI   FUNCB,X'00'   CLEAR  FUNC-BYTE
         OI    SWITCH,BEG    SET SWITCH
         B     COMPADD
BLANKS   EQU   *                    BLANKS IN THE RECORD
         TM    SWITCH,START+HIGH    START OR QUOTE
         BNZ   COMPADD              YES, SKIP IT
         NI    SWITCH,255-BLANK     CLEAR SWITCH
         B     COMPADD
EQUALSIG EQU   *                    EQUAL-SIGN
         TM    SWITCH,HIGH          TESTING
         BO    COMPADD
         TM    SWITCH,BEG+BLANK     OF
         BNO   RETURN8
         TM    SWITCH,EQUA          SWITCH
         BO    RETURN8
         OI    SWITCH,EQUA          SET EQUAL-SWITCH
         CLI   FUNCB,X'00'
         BE    COMPADD
         CR    1,POINTR
         BH    RETURN8
         B     COMPADD
QUOTES   EQU   *                    QUOTE-SIGN
         TM    SWITCH,BEG+BLANK+EQUA+PER
         BNO   RETURN8              ALL BITS MUST BE ON,ELSE ERROR
         TM    SWITCH,HIGH          WAS  QUOTE ?
         BZ    HIGHSCAN             NO
         CLI   1(1),QUOTE           NEXT SIGN = QUOTE ?
         BNE   *+14
         BCTR  WORK2,0
         LA    1,1(1)
         B    COMPADD
         BCTR  COUNTR,0             NO, END OF QUOTE-TEXT
         NI    SWITCH,255-HIGH-PER  CLEAR  SWITCH
         B     COMPADD
HIGHSCAN LA    COUNTR,1(COUNTR)     INCREASE COUNTER
         OI    SWITCH,HIGH          SET SWITCH
         B     COMPADD
HANDLAST EQU   *                    LAST CHARACTER
         OI     SWITCH,END
         LR    WORK1,1
         LA    WORK2,2
         B     EXTRT
COMPADD  EQU   *                    COMPUTE LENGTH & ADRESS FOR EX
         TM    SWITCH,END
         BO    ENDPARA
         LA    WORK1,1(1)           NEXT BYTE
         SR    1,POINTR             COMPUTE LENGTH OF LAST TRT
NOLEN    EQU   *
         SR    WORK2,1
*
         LR    POINTR,WORK1         SET POINTER
         LTR   WORK2,WORK2          ANY MORE BYTES TO EXAMINE?
         BNP   RETURN0              NO, RETURN
         B     EXTRT                YES
RETURN0  SR    15,15
         LTR   COUNTR,COUNTR
         BP    RETURN8
         B     *+10
RETURN8  ST    WORK1,ERRSAVE
         LR    15,WORK1
         LR    1,14
         L    14,0(1)
         FREEMAIN R,LV=268,A=(1)
         XRETURN (15),R
* SWITCHES
HIGH     EQU   1
START    EQU   2
BEG      EQU   4
EQUA     EQU   8
LPAR     EQU   X'10'
END      EQU   X'20'
BLANK    EQU   X'40'
PER      EQU   X'80'
QUOTE    EQU   X'7D'
PERIOD   EQU   X'6B'
EQUAL    EQU   X'7E'
ERRSAVE  DC    F'0'
TRTINST  TRT   0(0,WORK1),TRTTAB
DYNAM    DSECT
SAVE14   DS    F
BEGINN   DC    F'0'
SWITCH   DS    C
FUNCB    DS    C
TRTTAB   DS    2CL128
         END
./ ADD NAME=GETUCBS
         TITLE 'GETUCBS                               GET UCB ADRESSES'
GETUCBS  CSECT
         SPACE 3
***********************************************************************
*                                                                     *
*      PROGRAM-ID. GETUCBS.                                           *
*      AUTHOR. EHNERT.                                                *
*      INSTALLATION. BAYER AG, LEVERKUSEN, RECHENZENTRUM.             *
*      DATE-WRITTEN. 18. 4. 1975.                                     *
*      REMARKS.                                                       *
*                                                                     *
*          DAS PROGRAMM 'GETUCBS' IST EIN UNTERPROGRAMM ZU DEN        *
*          X-COMMANDS. ES DURCHSUCHT DIE UCB LOOOKUP TABLE NACH       *
*          GUELTIGEN UCB-ADRESSEN, D. H. ADRESSEN, DIE MEHRFACH       *
*          VORHANDEN SIND, WERDEN NUR EINMAL BRUECKSICHTIGT UND       *
*          ADRESSEN VON DUMMY-UCB'S WERDEN UEBERGANGEN. DIE GUEL-     *
*          TIGEN ADRESSEN WERDEN IN EINEM VEKTOR GESPEICHERT.         *
*                                                                     *
*          ALS EINGABEPARAMETER WIRD IN REGISTER 1 DIE ADRESSE        *
*          EINES VOLLWORTS MIT DER ADRESSE DES VEKTORS ERWARTET,      *
*          DER 1024 HALBWORTE ENTHALTEN SOLL.                         *
*          DAS ERSTE BIT DIESES VOLLWORTS MUSS GESETZT SEIN, UM       *
*          DAS ENDE DER PARAMETERKETTE ANZUZEIGEN.                    *
*                                                                     *
*          DAS ENDE DER GUELTIGEN ADRESSE IM VEKTOR WIRD DURCH        *
*          EIN HALBWORT MIT DEM INHALT X'FFFF' GEKENNZEICHNET.        *
*                                                                     *
***********************************************************************
         EJECT
*
*      SICHERN DER REGISTER,
*      SPEICHERPLATZANFORDERUNG FUER ARBEITSBEREICHE,
*      ZUORDNUNG DER BASISREGISTER.
*
         SPACE 1
         XSAVE R12,,DSCB1,ABERL
         USING ABER,R13      BASISREG. FUER DSECT ABER ZUORDNEN
         SPACE 2
*
*      PRUEFUNG DER EINGABE.
*
         SPACE 1
         L     R1,0(R1)      ADRESSE DES VEKTORS LADEN
         LTR   R1,R1         NUR EIN PARAMETER ?
         BM    GETULT        JA, VERZWEIGEN
         MVC   0(2,R1),=X'FFFF' VEKTORENDE SPEZIFIZIEREN
         B     ENDE          VERZWEIGEN
         EJECT
*
*      AUFSUCHEN DER UCB LOOKUP TABLE.
*
         SPACE 1
GETULT   EQU   *
         L     R2,16         ADRESSE DER CVT LADEN
         L     R2,40(R2)     ADRESSE DER UCB LOOKUP TABLE LADEN
         SH    R2,=H'2'      R2 UM ZWEI VERMINDERN
         LR    R3,R1         ADRESSE DES VEKTORS LADEN
         SR    R4,R4         R4 LOESCHEN
         LA    R6,1024       LOOP CONTER INITIALISIEREN
         SPACE 2
*
*      VERARBEITUNG DER UCB-ADRESSEN.
*
         SPACE 1
NEXTUCB  EQU   *
         LA    R2,2(R2)      R2 ERHOEHEN
         ICM   R4,3,0(R2)    UCM-ADRESSE LADEN
         BZ    NEXTUCB       VERZW., WENN UCB = DUMMY-UCB
         STH   R4,0(R3)      UCM-ADRESSE SPEICHERN
         CLC   0(2,R3),=X'FFFF' ENDE DER UCB LOOKUP TABLE ERREICHT ?
         BE    ENDE          JA, VERZWEIGEN
         LR    R5,R1         ADRESSE DES VEKTORS LADEN
CLCLOOP  EQU   *
         CR    R5,R3         ALLE GUELTIGEN ADRESSEN VERGLICHEN ?
         BNL   UCBADROK      JA, VERZWEIGEN
         CLC   0(2,R5),0(R3) UCB-ADRESSE SCHON VORHANDEN ?
         BE    NEXTUCB       JA, VERZWEIGEN
         LA    R5,2(R5)      NAECHSTE ADRESSE IN DER TABELLE LADEN
         B     CLCLOOP       VERZWEIGEN
UCBADROK EQU   *
         LA    R3,2(R3)      NAECHSTE ADRESSE IN DER TABELLE LADEN
         BCT   R6,NEXTUCB    VERZWEIGEN
         EJECT
*
*      SPEICHERPLATZFREIGABE,
*      REINITIALISIERUNG DER REGISTER UND
*      RUECKSPRUNG ZUM AUFRUFENDEN PROGRAMM.
*
         SPACE 1
ENDE     EQU   *
         XRETURN ,R
         EJECT
***********************************************************************
*                                                                     *
*      DEFINITIONEN.                                                  *
*                                                                     *
***********************************************************************
         SPACE 3
R0       EQU   0
R1       EQU   1             POINTER AUF VEKTOR MIT UCB-ADRESSEN
R2       EQU   2             POINTER IN CVT / UCB LOOKUP TABLE
R3       EQU   3             POINTER IN UCB-VEKTOR
R4       EQU   4             ZWISCHENSPEICHER FUER UCB-ADRESSE
R5       EQU   5             POINTER IN UCB-VEKTOR
R6       EQU   6             LOOP COUNTER
R7       EQU   7
R8       EQU   8
R9       EQU   9
R10      EQU   10
R11      EQU   11
R12      EQU   12            BASISREG. FUER CSECT GETUCBS
R13      EQU   13            BASISREG. FUER DSECT ABER
R14      EQU   14            RUECKSPRUNGADRESSE
R15      EQU   15            CSECT-ADRESSE
         SPACE 2
ABER     DSECT
SAVEAREA DS    18F           SAVEAREA FUER ALLGEMEINE REGISTER
ABERL    EQU   *-ABER        LAENGE DER ARBEITSBEREICHE
         SPACE 2
         END   GETUCBS
./ ADD NAME=SVC250
IGC00250 CSECT
         SPKA  0(0)
         BR    15
         END
./ ADD NAME=SVC249
IGC0024I CSECT
         SPKA  0(0)
         SR    0,0
         SVC   34
         BR    14
         END
./ ADD NAME=XTIMEX
XTIMEX   CSECT
         XSAVE R12,SVA,XTIMEX
         REG
         LR    R3,R1          SAVE PARAMETER POINTER
         USING PARMAREA,R3 SET BASE REG FOR PARAMETER LIST
         CLI   10(R3),C','    TEST WHICH ROUTINE IS NEEDED
         BE    XTIME
         EJECT
***********************************************
*                                             *
*            ROUTINE FUER HHMMSS              *
*                                             *
***********************************************
         SPACE
         TRT   10(7,R3),TRTTAB  SEARCH FOR '0'
         BZ    LENERR
         SPACE 2
         LA    R4,10(R3)
         SR    R1,R4          GET LENGTH OF PARAMETER
         CH    R1,=H'6'
         BNE   LENERR
         SPACE 2
         XC    TIMEHEX,TIMEHEX CLEAR FIELD
         MVC   TIMEDEC,0(R4)  MOVE TIME HHMMSS
         B     CALLSUB
         EJECT
***********************************************
*                                             *
*            ROUTINE FUER ZEIT IN HEX         *
*                                             *
***********************************************
         SPACE
XTIME    EQU   *
         LA    R4,11(R3)      GET POINTER TO TIME PARAMETER
         TRT   0(9,R4),TRTTAB TEST FOR '0'
         BZ    PARMERR
         SPACE
         XC    DOUBLEW,DOUBLEW CLEAR FIELD
         TR    0(9,R4),TRANS TRANSLATE C1-C6 TO FA-FF
         SR    R1,R4          GET LENGTH OF PARAMETER
         BCTR  R1,0           REDUCE LENGTH BY ONE
         EX    R1,PACK
         LM    R14,R15,DOUBLEW
         SRDL  R14,4          DELETE SIGN
         ST    R15,TIMEHEX
         MVC   TIMEDEC,=CL6' ' CLEAR FIELD
         EJECT
CALLSUB  EQU   *
         SPACE
         CALL  HTIME,(TIMEDEC,TIMEHEX),VL
         SPACE
         LTR   R15,R15        TEST RETURN CODE
         BNZ   XRETURN
         SPACE
         UNPK  DOUBLEW(9),TIMEHEX(5)
         TR    DOUBLEW,TRANS1 TRANSLATE FA-FF TO C1-C6
         SPACE
         MVC   MSGX+12(8),DOUBLEW
         MVC   MSGX+34(2),TIMEDEC
         MVC   MSGX+41(2),TIMEDEC+2
         MVC   MSGX+48(2),TIMEDEC+4
         SPACE 2
         LA    R5,MSGX
         BAL   R14,TESTTSO
         B     XRETURN
         EJECT
***********************************************
*                                             *
*            RETURN TO CALLER                 *
*                                             *
***********************************************
         SPACE
PARMERR  EQU   *
         LA    R5,PARMMSG
         BAL   R14,TESTTSO
         B     XRETURN
         SPACE 2
LENERR   EQU   *
         LA    R5,LENMSG
         BAL   R14,TESTTSO
         SPACE 2
XRETURN  EQU   *
         XRETURN
         EJECT
***********************************************
*                                             *
*            WRITE TO CALLER                  *
*                                             *
***********************************************
         SPACE
TESTTSO  EQU   *
         L     R0,REG4
         C     R0,=CL4'TSO'   TEST IF TSO ?
         BE    TSO
         SPACE
         WTO   MF=(E,(R5))
         BR    R14
         SPACE 2
TSO      EQU   *
         SR    R0,R0          CLEAR REG 0
         LH    R0,0(R5)       LOAD LENGTH OF WTO
         SH    R0,=H'4'       REDUCE LENGTH BY FOUR
         LA    R1,4(R5)       GET ADDR OF WTO+4
         SVC   93             *** TPUT ***
         BR    R14
         EJECT
***********************************************
*                                             *
*            DEFINITIONEN                     *
*                                             *
***********************************************
         SPACE
DOUBLEW  DS    D
         DS    X
         SPACE
TIMEDEC  DS    CL6
TIMEHEX  DS    F
         SPACE
***********************************************
TRTTAB   DS    0XL256
         DC    64X'00'
         DC    X'40'
         DC    191X'00'
         SPACE
TRANS    EQU   *
         DC    193AL1(*-TRANS)
         DC    X'FAFBFCFDFEFF'
         DC    56AL1(*-TRANS)
         SPACE
TRANS1   EQU   *
         DC    250AL1(*-TRANS1)
         DC    X'C1C2C3C4C5C6'
************************************************
         SPACE
PACK     PACK  DOUBLEW,0(0,R4)
         SPACE
MSGX     WTO   'TIMEX03          1/100 SEC =>    STD    MIN    SEC',   *
               MCSFLAG=REG0,MF=L
LENMSG   WTO   'TIMEX02 FALSCHE LAENGE IM PARAMETERFELD',              *
               MCSFLAG=REG0,MF=L
PARMMSG  WTO   'TIMEX01 FALSCHE PARAMETERANGABE',MCSFLAG=REG0,MF=L
         SPACE 2
         LTORG
         SPACE 2
         XPARM
         END
./ ADD NAME=HTIME
HTIME    CSECT
         XSAVE R12,SVA,HTIME
         REG
         SR    R3,R3          CLEAR WORK REG 3
         LA    R4,8           SET MAX REQUEST COUNT
         LR    R2,R1          SAVE PARAMETERLIST ADDR
         SPACE 2
GETNUMB  EQU   *
         LA    R3,1(R3)       ADD 1 TO REQUEST REG
         TM    4(R2),X'80'    LAST REQUEST ?
         BO    GETROUT        YES
         LA    R2,8(R2)       GET NEXT ADDR
         BCT   R4,GETNUMB
         SPACE
         B     PARMERR
         SPACE 2
GETROUT  EQU   *
         ST    R3,REQCNT      SAVE REQUEST NUMBER
         L     R2,0(R1)       GET FIRST PARAMETER ADDR
         CLI   0(R2),C' '     TEST WHICH ROUTINE IS NEEDED ?
         BE    TIMEBIN
         LR    R5,R1          SAVE PARAMETER POINTER
         EJECT
******************************************
*                                        *
*     TESTEN DER EINGABEDATEN AUF        *
*     NUMMERISCH ENTPACKT                *
*                                        *
******************************************
         SPACE
TESTIN   EQU   *
         TRT   0(6,R2),TRTIN
         BNZ   INERROR        ERROR IN INPUT
         SPACE
         LA    R5,8(R5)       GET ADDR OF NEXT REQUEST
         L     R2,0(R5)       GET ADDR OF DATA AREA
         BCT   R3,TESTIN
         SPACE
         L     R3,REQCNT      GET REQUEST NUMBER
         L     R2,0(R1)       GET FIRST PARAMETER ADDR
         SPACE 2
******************************************
*                                        *
*     UMRECHNUNGS - ROUTINE              *
*     HHMMSS ==> 1/100 SECONDS           *
*                                        *
******************************************
         SPACE
TIMEDEC  EQU   *
         XC    DOUBLEW,DOUBLEW    CLEAR WORK FIELD
         PACK  DOUBLEW,0(2,R2)  PACK HOURS
         CVB   R14,DOUBLEW      GET HOURS IN BINARY
         MH    R14,=H'3600'   GET HOURS IN SECONDS
         PACK  DOUBLEW,2(2,R2)  PACK MINUTES
         CVB   R15,DOUBLEW      GET MINUTES IN BINARY
         MH    R15,=H'60'     GET MINUTES IN SECONDS
         AR    R15,R14        ADD SECONDS
         PACK  DOUBLEW,4(2,R2)  PACK SECONDS
         CVB   R14,DOUBLEW      GET SECONDS IN BINARY
         AR    R15,R14        ADD SECONDS
         MH    R15,=H'100'    GET TIME IN 1/100 SECONDS
         L     R2,4(R1)       LOAD FIRST PARAMETER ADDR
         ST    R15,0(R2)      STORE TIME BACK
         LA    R1,8(R1)       GET ADDR OF NEXT REQUEST
         L     R2,0(R1)       GET ADDR OF NEXT REQUEST
         BCT   R3,TIMEDEC
         SPACE
         SR    R5,R5
         B     XRETURN
         EJECT
******************************************
*                                        *
*     UMRECHNUNGS - ROUTINE              *
*     TIME IN 1/100 SEC. ==> HHMMSS      *
*                                        *
******************************************
         SPACE
TIMEBIN  EQU   *
         L     R2,4(R1)       GET ADDR OF TIME
         XC    DOUBLEW,DOUBLEW CLEAR WORK FIELD
         L     R15,0(R2)      GET TIME IN 1/100 SECONDS
         L     R2,0(R1)       GET ADDR OF DATA AREA
         SR    R14,R14        CLEAR WORK REG 14
         D     R14,=F'100'    GET TIME IN SECONDS
         SR    R14,R14        CLEAR WORK REG 14
         D     R14,=F'60'     GET TIME IN MINUTES
         CVD   R14,DOUBLEW    GET SECONDS IN DECIMAL
         UNPK  DOUBLEW(4),DOUBLEW+6(2)
         OI    DOUBLEW+3,X'F0' MAKE PRINTABLE
         MVC   4(2,R2),DOUBLEW+2 STORE SECONDS BACK
         SR    R14,R14        CLEAR WORK REG 14
         D     R14,=F'60'     GET TIME IN HOURS
         CVD   R14,DOUBLEW    GET MINUTES IN DECIMAL
         UNPK  DOUBLEW(4),DOUBLEW+6(2)
         OI    DOUBLEW+3,X'F0' MAKE PRINTABLE
         MVC   2(2,R2),DOUBLEW+2 STORE MINUTES BACK
         XC    DOUBLEW,DOUBLEW CLEAR WORK FIELD
         CVD   R15,DOUBLEW    GET HOURS IN DECIMAL
         UNPK  DOUBLEW(4),DOUBLEW+6(2)
         OI    DOUBLEW+3,X'F0' MAKE PRINTABLE
         MVC   0(2,R2),DOUBLEW+2 STORE HOURS BACK
         LA    R1,8(R1)
         BCT   R3,TIMEBIN
         SPACE
         SR    R5,R5          CLEAR RETURN REG
         EJECT
******************************************
*                                        *
*     RETURN TO CALLER                   *
*                                        *
******************************************
         SPACE
XRETURN  EQU   *
         XRETURN (R5)
         SPACE 2
INERROR  EQU   *
         LA    R5,8           SET ERROR RETURN CODE
         SPACE
         WTO   'HTIME01 EINGABEDATEN NICHT ENTPACKT',ROUTCDE=11
         B     XRETURN
         SPACE 2
PARMERR  EQU   *
         LA    R5,8           SET ERROR RETURN CODE
         SPACE
         WTO   'HTIME02 FEHLER IN PARAMETERLISTE',ROUTCDE=11
         B     XRETURN
         EJECT
******************************************
*                                        *
*    D E F I N I T I O N E N             *
*                                        *
******************************************
         SPACE
DOUBLEW  DS    D
         SPACE
REQCNT   DS    F
         SPACE
*****************************************************
TRTIN    DS    0XL256
*                 0 1 2 3 4 5 6 7 8 9 A B C D E F
         DC    X'40404040404040404040404040404040'  0
         DC    X'40404040404040404040404040404040'  1
         DC    X'40404040404040404040404040404040'  2
         DC    X'40404040404040404040404040404040'  3
         DC    X'40404040404040404040404040404040'  4
         DC    X'40404040404040404040404040404040'  5
         DC    X'40404040404040404040404040404040'  6
         DC    X'40404040404040404040404040404040'  7
         DC    X'40404040404040404040404040404040'  8
         DC    X'40404040404040404040404040404040'  9
         DC    X'40404040404040404040404040404040'  A
         DC    X'40404040404040404040404040404040'  B
         DC    X'40404040404040404040404040404040'  C
         DC    X'40404040404040404040404040404040'  D
         DC    X'40404040404040404040404040404040'  E
         DC    X'00000000000000000000404040404040'  F
*****************************************************
         SPACE
         LTORG
         END
        LA    R5,8           SET ERROR RETURN CODE
./ ADD NAME=CONV
LUXCONV  START
         REG
         XSAVE R12,,LUXCONV,WORKL
         USING WORK,R13
         USING PARMAREA,R11
         LR    R11,R1
         XC    DBLWD,DBLWD
         XC    SWITCH,SWITCH
         TRT   TEXT+5(11),TRTTAB
         BZ    ERROR
         LA    R10,TEXT+5
         CR    R10,R1
         BE    ERROR
         LR    R9,R1
         SR    R9,R10
         BCTR  R9,0
         MVC   WTO,MESS3
         LA    R8,WTO+12
         EX    R9,MVCEX1
         LA    R8,2(R9,R8)
         LA    R7,1(R9)
         CLI   1(R1),C'X'
         BNE   DECCONV
         MVC   0(8,R8),=C'(HEX)  ='
         LA    R8,10(R8)
KHEX     EQU   *
         EX    R9,TREX1
         EX    R9,TRTEX1
         BNZ   INVNUM
         EX    R7,PACKEX1
         L     R6,DBLWD
         LTR   R6,R6
         BNZ   INVNUM
         L     R6,DBLWD+4
         CVD   R6,DBLWD
         UNPK  0(10,R8),DBLWD
         OI    9(R8),X'F0'
         MVC   11(5,R8),=C'(DEC)'
         B     WTOROUT
DECCONV  EQU   *
         CLI   1(R1),C'D'
         BNE   KCONV
         MVC   0(8,R8),=C'(DEC)  ='
         LA    R8,10(R8)
KDEC     EQU   *
         EX    R9,TREX2
         EX    R9,TRTEX2
         BNZ   INVNUM
         EX    R7,PACKEX1
         MVO   ZWI,DBLWD
         NI    ZWI+7,X'F0'
         OI    ZWI+7,X'0C'
         CP    ZWI,PMAX
         BH    INVNUM
         CVB   R6,ZWI
         TM    SWITCH,X'80'
         BNO   DECOK
         SLL   R6,10
DECOK    EQU   *
         ST    R6,ZWI
         UNPK  0(9,R8),ZWI(5)
         MVC   8(6,R8),=C' (HEX)'
         TR    0(8,R8),CCTAB-240
         TM    SWITCH,X'80'
         BO    CONT1K
         B     WTOROUT
KCONV    EQU   *
         CLI   1(R1),C'K'
         BNE   ERROR
         C     R7,=F'5'
         BH    INVNUM
         MVC   0(4,R8),=C'K  ='
         LA    R8,6(R8)
         OI    SWITCH,X'80'
         B     KDEC
CONT1K   EQU   *
         MVC   ZWI2,0(R8)
         LA    R10,ZWI2
         MVI   16(R8),C'='
         LA    R8,19(R8)
         LA    R9,7
         LA    R7,8
         B     KHEX
RETURN   EQU   *
         XRETURN 0,R
ERROR    EQU   *
         MVC   WTO,MESS2
WTOROUT  EQU   *
         L     R0,REG4
         LA    R1,WTO
         LA    R14,RETURN
         C     R0,=CL4'ROSC'
         BNE   NOROS
         STM   R14,R12,12(R13)                   SAVE ALL REGS IN SA
*
*              NOW WE CAN ADDRESS DUMMYSECTION IN XMON
*
         LH    R0,0(R1)      LOAD LENGTH OF WTO
         SH    R0,=H'4'      DECREMENT BY 4
         STC   R0,3(R1)      INSERT LENGTH TO MESSAGE FOR USE BY ROSCOE
         LA    R0,3(R1)      LOAD MESSAGE ADDRESS
         L     R13,4(R13)    R13 --> SA IN XMON
         ST    R0,76(R13)    STORE IT IN DYN AREA OF XMON = INAREA
         OI    76(R13),X'80' SET HIGHORDER BIT ON
         L     R15,100(R13)  LOAD ROSCOE-CODE <<OUTCODE>>
         LA    R1,76(R13)    LOAD PARAMETER REGISTER
         L     R13,4(R13)    R13 --> SA IN ROSCOE
         L     R14,12(R13)   LOAD RETURNADDRESS
         LM    R2,R12,28(R13)                    LOAD REMAINDER
         BR    R14           RETURN DIRECT TO ROSCOE
NOROS    EQU   *
         C     R0,=CL4'TSO'
         BNE   DOWTO
         LH    R0,WTO
         SH    R0,=H'4'
         LA    R1,WTO+4
         SVC   93                    **** TPUT ****
         B     RETURN
DOWTO    EQU   *
         WTO   MF=(E,WTO)
         B     RETURN
INVNUM   EQU   *
         MVC   WTO,MESS1
         B     WTOROUT
MVCEX1   MVC   0(0,R8),0(R10)
TREX1    TR    0(0,R10),TRTAB
ZEROES   DC    16XL1'00'
TRTAB    DS    0CL256
         DC    193XL1'FF'
         DC    XL6'0A0B0C0D0E0F'
         DC    41XL1'FF'
         DC    X'00010203040506070809'
         DC    6XL1'FF'
TRTEX1   TRT   0(0,R10),ZEROES
PACKEX1  PACK  DBLWD(9),0(0,R10)
TREX2    TR    0(0,R10),TRTAB1
ZERO     DC    10XL1'00'
TRTAB1   DS    0CL256
         DC    240XL1'FF'
         DC    X'00010203040506070809'
         DC    6XL1'FF'
TRTEX2   TRT   0(0,R10),ZERO
PMAX     DC    XL8'000002147483647C'
CCTAB    DC    CL16'0123456789ABCDEF'
TRTTAB   DC    256XL1'00'
         ORG   TRTTAB+107
         DC    C','
         ORG
MESS1    WTO   'XCONV01 INVALID NUMERICS',MCSFLAG=REG0,MF=L
MESS2    WTO   'XCONV02 ERROR IN PARAMETER',MCSFLAG=REG0,MF=L
MESS3    WTO   'XCONV03                                                *
                       ',                                              *
               MCSFLAG=REG0,MF=L
         XPARM
WORK     DSECT
SVA      DS    18F
DBLWD    DS    D
ZWI      DS    D
ZWI2     DS    CL8
WTO      DS    CL80
SWITCH   DS    X
WORKL    EQU   *-WORK
         END
./ ADD NAME=XCYL
XCYL     CSECT
         XSAVE R12,,XCYL,WORKAREA
         REG
         LR    R2,R1
         USING PARAM,R2
         USING SAVEAREA,R13
         MVC   AUSGABE,MES2
         OI    SW,HEAD1
         BAL   R14,TESTTSO
         LA    R1,100
         SLL   R1,16
         ST    R1,LENGTH
         MVC   TEXT2,TEXT
         LA    R10,LENGTH
         MVC   RETABLE(25),TABLE
         LA    R11,RETABLE
*
         CALL  HDRSCAN,((R10),(R11))
*
*
*        PREPARE HEADLINE
*
         MVC   AUSGABE,MES4
         LH    R8,LRECL+2    LOAD DISPLACEMENT REG8
         LH    R6,LRECL+4    LOAD LENGTH REG 6
         LTR   R6,R6
         BNP   NUMB
         BAL   R9,ROUT
         EX    R6,MOVEL
*
NUMB     EQU   *
         LH    R8,NUMBER+2
         LH    R6,NUMBER+4
         LTR   R6,R6
         BNP   BLK
         BAL   R9,ROUT
         EX    R6,MOVEN
*
BLK      EQU   *
         LH    R8,BLKSIZE+2
         LH    R6,BLKSIZE+4
         LTR   R6,R6
         BNP   KEY
         BAL   R9,ROUT
         EX    R6,MOVEB
*
KEY      EQU   *
         LH    R8,KEYLEN+2
         LH    R6,KEYLEN+4
         LTR   R6,R6
         BNP   WRITEWTO
         BAL   R9,ROUT
         EX    R6,MOVEK
*
*        WRITE HEADLINE
*
WRITEWTO EQU   *
         BAL   R14,TESTTSO
         NI    SW,255-HEAD1
         LH    R7,NUMBER+4
         LTR   R7,R7
         BNZ   GOON1
         MVC   AUSGABE,ERR1WTO
         MVC   AUSGABE+20(2),=C'N='
         BAL   R14,TESTTSO
         B     ENDE
*
GOON1    EQU   *
         LH    R4,NUMBER+2
         LA    R4,2(R4,R10)  LOAD PARAMETER ADDRESS REG 4
         BCTR  R7,0
         CH    R7,=H'8'
         BH    ERROR4
         BAL   R9,CONVERT    TEST NUMERIC
         EX    R7,PACK
         CLC   COMPUTE,COMPARE
         BNH   ERROR
         CVB   R4,COMPUTE
         ST    R4,MULT       STORE RECORDS
         LH    R7,LRECL+4
         LTR   R7,R7
         BNZ   GOON2
         MVC   AUSGABE,ERR1WTO
         MVC   AUSGABE+20(2),=C'L='
         BAL   R14,TESTTSO
         B     ENDE
*
*        NUMBER OF BLOCKS
*
GOON2    EQU   *
         LH    R4,LRECL+2
         LA    R4,2(R4,R10)
         BCTR  R7,0
         CH    R7,=H'8'
         BH    ERROR4
         BAL   R9,CONVERT
         EX    R7,PACK
         CLC   COMPUTE,COMPARE
         BNH   ERROR
         CVB   R4,COMPUTE
         ST    R4,ADD        STORE LRECL
         SRDA  R4,32
         M     R4,MULT       MULTIPLY LRECL/RECORDS
         LH    R7,BLKSIZE+4
         LTR   R7,R7
         BNZ   GOON3
         MVC   AUSGABE,ERR1WTO
         MVC   AUSGABE+20(2),=C'B='
         BAL   R14,TESTTSO
         B     ENDE
*
*        NUMBER OF BLOCKS
*
GOON3    EQU   *
         LH    R4,BLKSIZE+2
         LA    R4,2(R4,R10)
         BCTR  R7,0
         CH    R7,=H'8'
         BH    ERROR4
         BAL   R9,CONVERT
         EX    R7,PACK
         CLC   COMPUTE,COMPARE
         BNH   ERROR
         CVB   R4,COMPUTE
         LH    R8,=H'13030'
         CR    R4,R8         COMPARE BLKSIZE
         BH    ERROR2
         C     R4,ADD        COMPARE BLKSIZE/LRECL
         BL    ERROR1
         ST    R4,ADD        STORE BLKSIZE
         LR    R4,R5         LOAD BYTES
         SRDA  R4,32
         D     R4,ADD        DIVIDE BLKSIZE/BYTES
*
*        NUMBER OF BLOCKS/TRACK
*
         SR    R6,R6         CLEAR REG
         LH    R7,KEYLEN+4
         LTR   R7,R7
         BZ    COUNT
         LH    R4,KEYLEN+2
         LA    R4,2(R4,R10)
         BCTR  R7,0
         CH    R7,=H'8'
         BH    ERROR4
         BAL   R9,CONVERT
         EX    R7,PACK
         CLC   COMPUTE,COMPARE
         BNH   ERROR
         CVB   R6,COMPUTE
         LA    R8,255
         CR    R6,R8         COMPARE KEYLENGTH
         BH    ERROR3
         AH    R6,=H'56'
*
COUNT    EQU   *
         AH    R6,=H'135'
         A     R6,ADD        ADD BLKSIZE
         ST    R6,ZAHL
         LH    R6,=H'13165'
         SRDA  R6,32
         D     R6,ZAHL
*
*        NUMBER OF CYLINDERS
*
         M     R6,=F'19'     MULTIPLY TRACKS
         ST    R7,BYTES
         LR    R6,R5
         SRDA  R6,32
         D     R6,BYTES
         LTR   R6,R6
         BNP   CYLWTO
         AH    R7,=H'1'
CYLWTO   EQU   *
         CVD   R7,COMPUTE
         LA    R8,30
         CR    R7,R8         COMPARE CYLINDERS
         BH    EX
         MVC   AUSGABE,MES1
         MVC   AUSGABE+23(4),SCHAB
         ED    AUSGABE+23(4),COMPUTE+6
         BAL   R14,TESTTSO
         B     ENDE
*
*        ERROR - WTOS
*
ERROR    EQU   *
         MVC   AUSGABE,ERR3WTO
         EX    R7,MOVEMSG
         BAL   R14,TESTTSO
         B     ENDE
ERROR1   EQU   *
         MVC   AUSGABE,ERR4WTO
         BAL   R14,TESTTSO
         B     ENDE
*
ERROR2   EQU   *
         MVC   AUSGABE,ERR2WTO
         BAL   R14,TESTTSO
         B     ENDE
*
ERROR3   EQU   *
         MVC   AUSGABE,ERR5WTO
         BAL   R14,TESTTSO
         B     ENDE
ERROR4   EQU   *
         MVC   AUSGABE,ERR7WTO
         EX    R7,MOVERR7
         BAL   R14,TESTTSO
         B     ENDE
*
ROUT     EQU   *
         LA    R8,2(R8,R10)
         BCTR  R6,0
         BR    R9
*
*        NUMERIC TEST
*
CONVERT  EQU   *
         LA    R8,1(,R7)     LOAD LENGTH REG 8
         LR    R3,R4         LOAD ADDRESS REG 3
*
CONV     EQU   *
         CLI   0(R3),C'0'
         BL    ERROR
         CLI   0(R3),C'9'
         BH    ERROR
         LA    R3,1(,R3)
         BCT   R8,CONV
         BR    R9
*
EX       EQU   *
         MVC   AUSGABE,MES3
         MVC   AUSGABE+12(4),SCHAB
         ED    AUSGABE+12(4),COMPUTE+6
         BAL   R14,TESTTSO
         B     ENDE
*
*        OUTPUT WTO
*
TESTTSO  EQU   *
         ST    R14,SAVE14
         LA    R1,AUSGABE
         L     R0,WORD
         C     R0,=CL4'ROSC'
         BNE   NOROS
         STM   R14,R12,12(R13)                   SAVE ALL REGS IN SA
*
*              NOW WE CAN ADDRESS DUMMYSECTION IN XMON
*
         LH    R0,0(R1)      LOAD LENGTH OF WTO
         SH    R0,=H'4'      DECREMENT BY 4
         STC   R0,3(R1)      INSERT LENGTH TO MESSAGE FOR USE BY ROSCOE
         LA    R0,3(R1)      LOAD MESSAGE ADDRESS
         L     R13,4(R13)    R13 --> SA IN XMON
         ST    R0,76(R13)    STORE IT IN DYN AREA OF XMON = INAREA
         OI    76(R13),X'80' SET HIGHORDER BIT ON
         L     R15,100(R13)  LOAD ROSCOE-CODE <<OUTCODE>>
         LA    R1,76(R13)    LOAD PARAMETER REGISTER
         L     R13,4(R13)    R13 --> SA IN ROSCOE
         L     R14,12(R13)   LOAD RETURNADDRESS
         LM    R2,R12,28(R13)                    LOAD REMAINDER
         BR    R14           RETURN DIRECT TO ROSCOE
NOROS    EQU   *
         C     R0,=CL4'TSO'
         BNE   WRITE
         LH    R0,AUSGABE
         SH    R0,=H'4'
         LA    R1,AUSGABE+4
         SVC   93                 *** TPUT ***
         L     R14,SAVE14
         BR    R14
WRITE    EQU   *
         WTO   MF=(E,AUSGABE)
         L     R14,SAVE14
         BR    R14
*
ENDE     EQU   *
         XRETURN 0
*
PACK     PACK  COMPUTE,0(0,R4)
MOVEMSG  MVC   AUSGABE+28(0),0(R4)
MOVEL    MVC   AUSGABE+12(0),0(R8)
MOVEN    MVC   AUSGABE+18(0),0(R8)
MOVEB    MVC   AUSGABE+25(0),0(R8)
MOVEK    MVC   AUSGABE+33(0),0(R8)
MOVERR7  MVC   AUSGABE+29(0),0(R4)
SAVE14   DC    F'0'
*
*        SWITCH - BYTE
*
SW       DC    X'00'
HEAD1    EQU   1
*
*        PARAMETER TABELLE
*
TABLE    DS    0CL25
         DC    CL6'L'
         DC    CL6'N'
         DC    CL6'B'
         DC    CL6'K'
         DC    X'FF'
*
*        SPEICHERFELDER
*
SCHAB    DC    X'40202120'
COMPARE  DC    X'000000000000000F'
*
*        TEXTE
*
MES1     WTO   'XCYL006 SPACE=(CYL,    )',MCSFLAG=REG0,MF=L
MES2     WTO   'XCYL006 LRECL NUMBER BLKSIZE KEYLENGTH',MCSFLAG=REG0,  *
               MF=L
MES3     WTO   'XCYL006      CYLINDERS NEEDED, USE TAPE',MCSFLAG=REG0, *
               MF=L
MES4     WTO   'XCYL006                               ',MCSFLAG=REG0,  *
               MF=L
ERR1WTO  WTO   'XCYL001 MISSING    PARAMETER',MCSFLAG=REG0,MF=L
ERR2WTO  WTO   'XCYL002 BLKSIZE GREATER THAN 13030',MCSFLAG=REG0,MF=L
ERR3WTO  WTO   'XCYL003 INVALID OPERAND        ',MCSFLAG=REG0,MF=L
ERR4WTO  WTO   'XCYL004 LRECL GREATER THAN BLKSIZE',MCSFLAG=REG0,MF=L
ERR5WTO  WTO   'XCYL005 KEYLENGTH GREATER 255',MCSFLAG=REG0,MF=L
ERR7WTO  WTO   'XCYL007 OPERAND TOO LONG           ',MCSFLAG=REG0,MF=L
*
         LTORG
*
PARAM    DSECT
WORD     DS    F
TEXT     DS    CL25
*
WORK     DSECT
SAVEAREA DS    18F
AUSGABE  DS    CL70
LENGTH   DS    F
TEXT2    DS    CL100
COMPUTE  DS    D
BYTES    DS    F
MULT     DS    F
ADD      DS    F
ZAHL     DS    F
RETABLE  DS    0CL25
LRECL    DS    CL6
NUMBER   DS    CL6
BLKSIZE  DS    CL6
KEYLEN   DS    CL6
         DS    X
WORKAREA EQU   *-SAVEAREA
         END
./ ADD NAME=FREE
XFREE    CSECT
XFREE    AMODE 31
XFREE    RMODE 24
         REG
*
*              XA-VERSION 4.7.1984 DEMEL
*
         XSAVE R12,,XFREE,WORKL
         USING WORK,R13
         LR    R3,R1
         USING PARMAREA,R3
         LA    R2,TEXT
         MVI   DSW,X'00'
         CLC   4(4,R2),=C',ALL'
         BNE   NORM
         OI    DSW,X'40'
NORM     EQU   *
         MVC   KMSGTEXT,KONS
         L     R1,16
         TM    116(R1),X'80'      MVS-XA?
         BZ    MVSDATA            NO, 370 MODE
         SPACE
         L     R2,560(R1)               A(GDA)
         SPACE
         MVC   WTO,MESSXA1
         L     R0,REG4
         BAL   R14,WTOROUT
         SPACE
         MVI   NAME,C' '
         MVC   NAME+1(55),NAME
         MVI   CONK,C'K'
         MVI   STRICH,C'-'
******** ***** ******************       PRIV EXT
         SPACE
         MVC   NAME,=CL8'EXT-PRIV'
         L     R1,168(R2)               R1 CONTAINS STARTADR
         L     R0,172(R2)               R0 CONTAINS SIZE
         BAL   R14,PREPARE
         SPACE
         L     R0,REG4
         BAL   R14,WTOROUT
         SPACE 3
******** ***** ******************       CSA EXT
         MVC   NAME,=CL8'EXT-CSA'
         L     R1,124(R2)               STARTADR
         L     R0,128(R2)               SIZE
         BAL   R14,PREPARE
         SPACE
         L     R1,116(R2)               START OF FBQE
         L     R0,120(R2)               END ADR OF LAST FBQE
         BAL   R14,FRCSA
         SPACE
         L     R1,128(R2)               SIZE OF CSA-EXT
         BAL   R14,FREEPRT
         SPACE
         L     R0,REG4
         BAL   R14,WTOROUT
         SPACE
******** ***** ***************     EXT  PLPA
         MVC   NAME,=CL8'EXT-PLPA'
         L     R1,152(R2)               START OF SQA EXT
         A     R1,156(R2)               R1 STARTADR OF PLPA
         L     R0,124(R2)               STARTADR OF CSA
         SR    R0,R1                    R1 CONTAINS SIZE
         SPACE
         BAL   R14,PREPARE
         L     R0,REG4
         BAL   R14,WTOROUT
         SPACE
******** ***** *******************         SQA EXTENDED
         MVC   NAME,=CL8'EXT-SQA'
         L     R1,152(R2)               STARTADR
         L     R0,156(R2)               SIZE
         BAL   R14,PREPARE
         MVC   D,=XL8'00000000'         CLEAR WORK FIELD
         L     R1,36(R2)                FIRST DFE OF SP 245 EXT
         L     R0,40(R2)                LAST  DFE OF SP 245 EXT
         BAL   R14,FRSQA
         SPACE
         ST    R4,D                     SAVE ACCUMULATED FREESPACE
         ST    R5,D+4                   SAVE LARGEST FREESPACE
         SPACE
         L     R1,260(R2)               FIRST DFE OF SP 239 EXT
         L     R0,264(R2)               LAST  DFE OF SP 239 EXT
         BAL   R14,FRSQA
         SPACE
         A     R4,D
         C     R5,D+4
         BH    MAXF
         L     R5,D+4
MAXF     EQU   *
         L     R1,156(R2)               SIZE OF SQA-EXT
         BAL   R14,FREEPRT
         SPACE
         L     R0,REG4
         BAL   R14,WTOROUT
         SPACE
******** ***** ************             NUCLEUS
         MVC   NAME,=CL8'NUCLEUS'
         L     R1,144(R2)               START OF SQA
         A     R1,148(R2)               R1 CONTAINS START OF NUCLEUS
         SPACE
         L     R0,152(R2)               R0 CONTAINS START OF SQA EXT
         SR    R0,R1                    R0 CONTAINS SIZE OF NUCLEUS
         BAL   R14,PREPARE
         L     R0,REG4
         BAL   R14,WTOROUT
         SPACE
******** ***** *****************   SQA
         MVC   NAME,=CL8'SQA'
         L     R1,144(R2)               STARTADR
         L     R0,148(R2)               SIZE
         BAL   R14,PREPARE
         SPACE
         MVC   D,=XL8'00000000'         CLEAR WORK FIELDS
         L     R1,12(R2)                FIRST DFE OF SP 245
         L     R0,16(R2)                LAST  DFE OF SP 245
         BAL   R14,FRSQA
         SPACE
         ST    R4,D                     SAVE ACCUMULATED FREESPACE
         ST    R5,D+4                   SAVE LARGEST FREESPACE
         SPACE
         L     R1,60(R2)                FIRST DFE OF SP 226
         L     R0,64(R2)                LAST  DFE OF SP 226
         BAL   R14,FRSQA
         SPACE
         A     R4,D
         ST    R4,D
         SPACE
         C     R5,D+4
         BH    MAXF1
         L     R5,D+4
MAXF1    EQU   *
         ST    R5,D+4                   FIRST DFE OF SP 226
         L     R1,236(R2)               FIRST DFE OF SP 226
         L     R0,240(R2)               LAST  DFE OF SP 226
         BAL   R14,FRSQA
         SPACE
         A     R4,D
         SPACE
         C     R5,D+4
         BH    MAXF2
         L     R5,D+4
MAXF2    EQU   *
         L     R1,148(R2)               SIZE OF SQA
         BAL   R14,FREEPRT
         L     R0,REG4
         BAL   R14,WTOROUT
*
******** ***** ****************         PLPA
         MVC   NAME,=CL8'PLPA'
         L     R1,108(R2)               START OF CSA
         A     R1,112(R2)               R1 CONTAINS START OF PLPA
         SPACE
         L     R0,144(R2)               START OF SQA
         SR    R0,R1                    R0 CONTAINS SIZE OF PLPA
         BAL   R14,PREPARE
         L     R0,REG4
         BAL   R14,WTOROUT
         SPACE
******** ***** *****************        CSA
         MVC   NAME,=CL8'CSA'
         SPACE
         L     R1,108(R2)               START OF CSA
         L     R0,112(R2)               SIZE
         BAL   R14,PREPARE
         SPACE
         L     R1,100(R2)               START OF FBQE
         L     R0,104(R2)               END OF FBQE
         BAL   R14,FRCSA
         SPACE
         L     R1,112(R2)
         BAL   R14,FREEPRT
         SPACE
         L     R0,REG4
         BAL   R14,WTOROUT
         SPACE
******** ***** ***************          PRIVATE
         MVC   NAME,=CL8'PRIV V=V'
         SPACE
         L     R1,192(R2)               START OF PRIV AREA
         L     R0,164(R2)               SIZE
         S     R0,192(R2)
         SPACE
         BAL   R14,PREPARE
         SPACE
         L     R0,REG4
         BAL   R14,WTOROUT
         SPACE
         MVC   NAME,=CL8'     V=R'
         SPACE
         L     R1,192(R2)               START OF V=R REGION
         L     R0,196(R2)               SIZE
         SPACE
         BAL   R14,PREPARE
         SPACE
         L     R0,REG4
         BAL   R14,WTOROUT
         SPACE
         MVC   NAME,=CL8'SYS-AREA'
         SPACE
         L     R1,160(R2)               START OF SYSAREA
         L     R0,192(R2)               SIZE
         SPACE
         BAL   R14,PREPARE
         SPACE
         L     R0,REG4
         BAL   R14,WTOROUT
         B     END
GOON     EQU   *                        DES DYNAM. BEREICHS)
         LM    R8,R9,8(R8)        A(PQE DES DYNAM. BEREICHS)
         STM   R8,R9,DPQE
         CLC   4(4,R2),=C',V=V'
         BNE   *+6
         LR    R8,R9
         CLC   4(4,R2),=C',V=R'
         BNE   *+6
         LR    R9,R8
         STM   R8,R9,PQEAD        STORE ADDR. OF DYNAMIC AREA
         L     R9,24(R8)          REGION BEGIN
         L     R10,20(R8)         REGION SIZE
         LA    R9,0(R9)           CLEAR HIGH ORDER BIS
         LA    R10,0(R10)         CLEAR HIGH ORDER BITS
         STM   R9,R10,DYNAVALS
         LA    R7,FBQETAB
         L     R8,PQEAD
PQE2     CLC   5(3,R8),PQEAD+1
         BE    DISARET
         ICM   R9,8,=X'08'
         C     R8,DPQE
         BE    *+8
         ICM   R9,8,=X'04'
         L     R8,04(R8)
         LA    R6,FBQEND
DISALOP  EQU   *
         L     R10,8(R8)
         LA    R10,0(R10)
         ICM   R9,7,13(R8)
         TM    116(R1),X'02'      DAT?
         BO    *+8
         LA    R9,0(R8)
         STM   R9,R10,0(R7)
         LA    R7,8(R7)
         CLC   5(3,R8),PQEAD+1    END OF FBQE'S?
         BE    DISARET
         CR    R7,R6              ENDE DER TABELLE?
         BNL   DISALOP1
         L     R8,4(R8)           NEXT FBQE
         B     DISALOP
DISALOP1 EQU   *
         OI    DSW,X'80'
DISARET  EQU   *
         ST    R7,FTABEND
         L     R8,PQEAD+4
         C     R8,PQEAD
         BE    PQE2E
         ST    R8,PQEAD
         B     PQE2
PQE2E    EQU   *
         TM    DSW,X'40'
         BNO   NTALL1
         TM    116(R1),X'02'
         BO    ALLVS
         MVC   WTO,MESS1
         L     R9,DYNAVALS+4
         LR    R1,R9
         SRA   R9,10
         CVD   R9,CON
         UNPK  WTO+40(4),CON
         OI    WTO+43,X'F0'
         L     R9,16
         L     R9,200(R9)
         L     R9,108(R9)
         LR    R11,R9
         L     R9,4(R9)
         L     R9,12(R9)
         LA    R9,0(R9)
         SRA   R9,10
         CVD   R9,CON
         UNPK  WTO+27(4),CON
         OI    WTO+30,X'F0'
         L     R9,4(R11)
         L     R9,8(R9)
         LA    R9,0(R9)
         SRA   R9,10
         CVD   R9,CON
         UNPK  WTO+16(4),CON
         OI    WTO+19,X'F0'
         L     R8,0(R11)
         LA    R8,0(R8)
         AR    R8,R1
         L     R9,16
         L     R9,164(R9)
         LA    R9,1(R9)
         SR    R9,R8
         SRA   R9,10
         CVD   R9,CON
         UNPK  WTO+51(4),CON
         OI    WTO+54,X'F0'
         L     R0,REG4
         BAL   R14,WTOROUT
         B     NTALL1
ALLVS    EQU   *
         TM    116(R1),X'01'
         BO    ALLMVS
         MVC   WTO,MESS7
         L     R1,16
         L     R9,128(R1)        CVTPTR
         SRA   R9,10
         CVD   R9,CON
         UNPK  WTO+16(5),CON
         OI    WTO+20,X'F0'
         L     R8,DPQE
         L     R9,20(R8)
         SRA   R9,10
         CVD   R9,CON
         UNPK  WTO+27(5),CON
         OI    WTO+31,X'F0'
         L     R8,DPQE+4
         L     R9,20(R8)
         SRA   R9,10
         CVD   R9,CON
         UNPK  WTO+38(5),CON
         OI    WTO+42,X'F0'
         L     R8,200(R1)       CVTABEND (SEC.CVT)
         L     R7,112(R8)       COMM TASK TCB
         L     R7,152(R7)       DPQE-8
         L     R7,8(R7)         MS-PQE
         L     R9,20(R7)        REGION SIZE
         L     R7,24(R7)        REGION BEGIN
         LA    R7,0(R9,R7)      REGION END
         SRA   R9,10
         CVD   R9,CON
         UNPK  WTO+48(5),CON
         OI    WTO+52,X'F0'
         L     R6,108(R8)       GOVRFLB
         L     R6,4(R6)         SQA-DQE
         L     R9,8(R6)
         SR    R9,R7
         SRA   R9,10
         CVD   R9,CON
         UNPK  WTO+59(5),CON
         OI    WTO+63,X'F0'
         L     R9,12(R6)
         SRA   R9,10
         CVD   R9,CON
         UNPK  WTO+70(5),CON
         OI    WTO+74,X'F0'
         L     R0,REG4
         BAL   R14,WTOROUT
         B     NTALL1
ALLMVS   EQU   *
         MVC   WTO,MESS8
         L     R9,X'80'(,R1)        LOWEST ADDRESS NOT IN THE NUCLEUS
         SRA   R9,10
         CVD   R9,CON
         UNPK  WTO+16(5),CON
         OI    WTO+20,X'F0'
         L     R4,X'230'(,R1)       ADDRESS OF GDA
         USING GDA,R4
         L     R9,PASIZE
         SRA   R9,10
         CVD   R9,CON
         UNPK  WTO+27(5),CON
         OI    WTO+31,X'F0'
         L     R5,CSAPQEP
         USING PQE,R5
         L     R9,PQESIZE
         SRA   R9,10
         ST    R9,CSASZ
         CVD   R9,CON
         UNPK  WTO+38(5),CON
         OI    WTO+42,X'F0'
         L     R8,X'1A0'(,R1)         ADDRESS OF FIRST BYTE OF LPA
         L     R5,SQASPQEP
         L     R5,4(,R5)              ADDRESS OF FIRST DQE
         L     R9,8(,R5)
         SLR   R9,R8
         LA    R9,0(,R9)
         SRA   R9,10
         S     R9,CSASZ
         CVD   R9,CON
         UNPK  WTO+49(5),CON
         OI    WTO+53,X'F0'
         L     R9,12(,R5)             LENGTH OF SQA
         SRA   R9,10
         CVD   R9,CON
         UNPK  WTO+60(5),CON
         OI    WTO+64,X'F0'
         L     R0,REG4
         BAL   R14,WTOROUT
NTALL1   EQU   *
*   FBQE-LOOP
         L     R7,FTABEND
         MVC   WTO,MESS3
         LA    R8,FBQETAB
         CR    R7,R8
         BE    NOFRECOR
         LA    R9,WTO
DRLOOP   EQU   *
         BAL   R11,CONVERT
         L     R0,REG4
         BAL   R14,WTOROUT
         LA    R8,8(R8)           NEXT FBQE IN TABLE
         CR    R7,R8
         BE    DREND
         B     DRLOOP
NOFRECOR EQU   *
         MVC   WTO,MESS4
         L     R0,REG4
         BAL   R14,WTOROUT
         B     RETURN
DREND    EQU   *
         TM    DSW,X'80'
         BNO   RETURN
         MVC   WTO,MESS5
         L     R0,REG4
         BAL   R14,WTOROUT
RETURN   EQU   *
         TM    DSW,X'40'
         BNO   END
         L     R5,16      CVT
         LA    R7,0
         SR    R4,R4
         L     R5,560(R5)
         L     R5,24(R5)
         L     R5,4(R5)
         L     R5,0(R5)    A(FIRST FQE)
         LTR   R5,R5   END OF FQE-CHAIN?
         BZ    NONE
NEXTFQE  EQU   *
         L     R6,4(R5)
         LA    R6,0(R6)   CLEAR HIGH ORDER BYTE
         CR    R6,R7
         BNH   INCR
         LR    R7,R6
INCR     EQU   *
         AR    R4,R6
         L     R5,0(R5)
         LA    R5,0(R5)
         LTR   R5,R5
         BNZ   NEXTFQE
NONE     EQU   *
         MVC   WTO,MESS6
         SRL   R4,10
         CVD   R4,CON
         UNPK  WTO+12(6),CON
         OI    WTO+17,X'F0'
         CVD   R7,CON
         UNPK  WTO+59(6),CON
         OI    WTO+64,X'F0'
         L     R0,REG4
         BAL   R14,WTOROUT
END      EQU   *
         XRETURN ,R
CONVERT  EQU   *
         SR    R10,R10
         IC    R10,0(R8)
         LA    R10,KMSGTEXT(R10)
         MVC   WTO+12(4),0(R10)
         ICM   R10,7,1(R8)
         SRA   R10,10
         CVD   R10,CON
         UNPK  WTO+39(5),CON
         OI    WTO+43,X'F0'
         L     R0,4(R8)
         SRA   R0,10
         CVD   R0,CON
         UNPK  WTO+58(5),CON
         OI    WTO+62,X'F0'
         AR    R10,R0
         CVD   R10,CON
         UNPK  WTO+49(5),CON
         OI    WTO+53,X'F0'
         BR    R11
MVSDATA  EQU   *
         L     R8,X'230'(R1)      A(GLOBAL DATA AREA)
         MVC   KMSGTEXT+4(4),KMSGTEXT+8
         MVC   KMSGTEXT+8(4),=C'CSA '
         B     GOON
WTOROUT  EQU   *
         ST    R14,SAVE14
         C     R0,=CL4'TSO'
         BNE   DOWTO
         LH    R0,WTO
         SH    R0,=H'4'
         LA    R1,WTO+4
         TPUT  (1),(0),R
         L     R14,SAVE14
         BR    R14
DOWTO    EQU   *
         WTO   MF=(E,WTO)
         L     R14,SAVE14
         BR    R14
PREPARE  EQU   *
*                                       R0 CONTAINS SIZE
*                                       R1 CONTAINS STARTADR
*                                       R14 RETURNADR
         ST    R1,D
         UNPK  WORKF,D(5)
         TR    WORKF(8),TRTAB-240
         MVC   STARTADR,WORKF
         SPACE
         AR    R1,R0                    GET ENDADR
         BCTR  R1,0                     REDUCE BY ONE
         ST    R1,D                     R1 CONTAINS END ADR
         UNPK  WORKF,D(5)
         TR    WORKF(8),TRTAB-240
         MVC   ENDADR,WORKF
         SPACE
         LA    R1,1                     INCREASE BY ONE
         AR    R0,R1                    ADD ONE
         SRL   R0,10                    DIVIDE BY 1024
         CVD   R0,D                     CONVERT TO DEZIMAL
         SPACE
         MVC   SIZE,MASKE
         ED    SIZE,D+4
         SPACE
         SPACE
         MVC   ALCACC(7),=CL7' '
         MVC   FREEMAX(7),=CL7' '
         MVC   PROZ(6),=CL7' '
         BR    R14
FRSQA    EQU   *
*                        R1 POINTS TO FIRST DFE
*                        R0 POINTS TO LAST DFE
         SR    R4,R4                    R4 FREESPACE SUMM
         SR    R5,R5                    R5 FREESPACE MAX
         SPACE
FRSQAL   EQU   *
         C     R5,20(R1)                MAX FREESPACE
         BH    FRSQAH                   NO
         L     R5,20(R1)                SAVE
         SPACE
FRSQAH   EQU   *
         A     R4,20(R1)                SUMM
         CR    R0,R1                    LAST DFE
         BER   R14                      YES,RETURN
         L     R1,0(R1)                 NEXT DFE
         B     FRSQAL                   LOOP
FRCSA    EQU   *
*                        R1 POINTS TO FIRST FBQE
*                        R0 POINTS TO LAST FBQE
         SR    R4,R4                    R4 FREESPACE SUMM
         SR    R5,R5                    R5 FREESPACE MAX
         SPACE
FRCSAL   EQU   *
         C     R5,8(R1)                 MAX ONE?
         BH    FRCSAH                   NO
         SPACE
         L     R5,8(R1)
FRCSAH   EQU   *
         A     R4,8(R1)                 SUMM
         CR    R0,R1                    END OF FBQE'S?
         BER   R14                      YES
         L     R1,0(R1)                 NEXT FBQE
         B     FRCSAL                   LOOP UNTIL FIND END OF FBQE'S
         SPACE
FREEPRT  EQU   *
*                                       R4 FREESIZE ACC
*                                       R5 FREEMAX
*                                       R1 SIZE
         SRL   R5,10
         CVD   R5,D
         MVC   FREEMAX,MASKE
         ED    FREEMAX,D+5
         MVI   FREEMAX+6,C'K'
         SPACE
         LR    R5,R1                    R5 CONTAINS SIZE
         SR    R1,R4                    R1 CONTAINS ALLOC SPACE
         LR    R4,R1
         SRL   R4,10
         CVD   R4,D
         MVC   ALCACC,MASKE
         ED    ALCACC,D+5
         MVI   ALCACC+6,C'K'
         SPACE
         M     R0,=F'1000'
         SPACE
         DR    R0,R5
         CVD   R1,D
         MVC   PROZ,MASKE1
         ED    PROZ,D+6
         MVI   PROZ+5,C'%'
         BR    R14                      RETURN
         SPACE
KONS     DC    C'MVT V=V V=R'
MESS1    WTO   'XFREE01 NUC=1234K, SQS=1234K, DYNAM=1234K, LPA=1234K', *
               MCSFLAG=REG0,MF=L
MESS3    WTO   'XFREE02 *** FREE STORAGE AREA FROM 12345K TO 12345K = 1*
               2345K',MCSFLAG=(REG0),MF=L    L
MESS4    WTO   'XFREE03 NO FREE STORAGE AREAS',MCSFLAG=REG0,           *
               MF=L
MESS5    WTO   'XFREE04 TABLE-OVERFLOW, MORE FREE AREAS ARE PRESENT',  *
               MCSFLAG=REG0,MF=L       MF=L
MESS6    WTO   'XFREE05 123456 KB FREE IN SQA -- LARGEST FREE AREA HAS *
               123456 BYTES',MCSFLAG=REG0,MF=L     MF=L
MESS7    WTO   'XFREE06 NUC=12345K,V=R=12345K,V=V=12345K,MS=12345K,LPA=*
               12345K,SQA=12345K',MCSFLAG=(REG0),MF=L
MESS8    WTO   'XFREE07 NUC=12345K,V=V=12345K,CSA=12345K,LPA=12345K,SQA*
               =12345K',MCSFLAG=REG0,MF=L
MESS9    WTO   'XFREE08                                                *
                      ',MCSFLAG=REG0,MF=L
MESSXA1  WTO   'XFREEXA  NAME       SIZE     ADDRESS RANGE    ALLOC   %*
                  FREEMX',MCSFLAG=REG0,MF=L
*                       '
TRTAB    DC    C'0123456789ABCDEF'
MASKE    DC    XL8'4020202020202021'
MASKE1   DC    XL5'4021206B20'
         LTORG
WORK     DSECT
SVA      DS    18F
CON      DS    D
DYNAVALS DS    D
FBQETAB  DS    50D
FBQEND   EQU   *
FTABEND  DS    A
PQEAD    DS   2A
DPQE     DS   2A
KMSGTEXT DS    CL12
WTO      DS    CL100
         ORG   WTO
         DS    CL4
         DS    CL8
NAME     DS    CL8
SIZE     DS    CL8
CONK     DS    C
         DS    CL2
STARTADR DS    CL8
STRICH   DS    C
ENDADR   DS    CL8
ALCACC   DS    CL6
         DS    C
PROZ     DS    CL5
         DS    C
FREEMAX  DS    CL6
         DS    C
         ORG
WORKF    DC    CL9' '
WORKF1   DC    CL5' '
SAVE14   DS    F
CSASZ    DS    F
DSW      DS    X
D        DS    D
WORKL    EQU   *-WORK
         XPARM
*
GDA      DSECT ,                     GLOBAL DATA AREA,
*                                    POINTED TO BY CVT+X'230'
*                                    PRESENT ONLY IN MVS SYSTEMS
GDAFLAGS DS    BL1         GLOBAL FLAGS
GDARESV  DS    CL3
VRDREG   DS    F           DEFAULT V=R REGION SIZE
CSAPQEP  DS    A           CSA PQE POINTER
VRPQEP   DS    A           V=R PQE POINTER
PASTRT   DS    A           PRIVATE AREA START ADDRESS
PASIZE   DS    F           PRIVATE AREA SIZE
SQASPQEP DS    A           SQA SPQE POINTER
SQASPLFT DS    F           SQA SPACE LEFT UNALLOCATED
         DS    5F
CSASPQEP DS    A           FIRST CSA SPQE POINTER
*
*
PQE      DSECT ,                     PARTITION QUEUE ELEMENT,
*                                    POINTED TO BY:
PQEFFBQE DS    A           PTR TO FIRST FBQE OR, IF NONE, TO PQE
PQEBFBQE DS    A           PTR TO LAST FBQE OR, IF NONE, TO PQE
PQEFPQE  DS    A           ADDR NEXT PQE OR ZERO
PQEBPQE  DS    A           ADDR PREVIOUS PQE OR ZERO
PQETCB   DS    A           ADDR TCB FOR JOB STEP TO WHICH SPACE
*                          BELONGS
PQESIZE  DS    F           SIZE OF REGION DESCRIBED BY THIS PQE
PQEREGN  DS    A           ADDR FIRST BYTE OF REGION DESCRIBED BY
*                          THIS PQE
         DS    CL2
VMMFLGS  DS    BL1         FLAGS, SEVEN HIGH ORDER BITS ZERO
VVVRFLG  EQU   B'00000001' REAL OR VIRTUAL REGION FLAG
         DS    CL1
*
*
FBQE     DSECT ,                     FREE BLOCK QUEUE ELEMENT,
*                                    POINTED TO BY PQE
FBQFPTR  DS    A           PTR TO NEXT FBQE OR PQE
FBQBPTR  DS    A           PTR TO PREVIOUS FBQE OR PQE
FBQSIZE  DS    F           SIZE OF THIS FREE BLOCK
FBQAREA  DS    A           LOW ADDRESS OF FREE BLOCK
*
         END

./ ADD  NAME=ALLOC
         TITLE 'ENTRY AND ROUTINES FOR MVT AND SVM'
ALLOC    START
         REG
         XSAVE R12,,ALLOC,WORKL
         USING WORK,R13
         USING PARMAREA,R11
         XC    ORIGIN,ORIGIN
         XC    SWITCH,SWITCH
         LR    R11,R1
         LA    R1,VEKTOR
         ST    R1,VEKADDR
         MVI   VEKADDR,X'80'
         LA    R1,VEKADDR
         LINK  EP=GETUCBS
         MVC   VEKEND,=X'FFFF'
         L     R4,16
         CLI   TEXT+6,C','
         BE    JOB
         LA    R4,VEKTOR
         SR    R5,R5
NEXTA    EQU   *
         BAL   R7,SEARCH
         CLC   TEXT+6(3),13(R5)
         BNE   NEXTA
         TM    3(R5),X'08'
         BO    ALLOCON
         MVC   WTO(LENMESS2),MESS2
         BAL   R14,WTOROUT
         B     RETURN
ALLOCON  EQU   *
         L     R2,16        LOAD CVT ADDRESS
         TM    116(R2),X'01'     MVS?
         BO    MVSALLOC          YES.
         L     R2,160(R2)
         MVC   WTO(LENMESS3),MESS3
         BAL   R14,WTOROUT
         MVC   WTO(LENMESS4),MESS4
         LA    R9,WTO+12
         LA    R4,6
         SR    R7,R7
LTIOT    EQU   *
         L     R3,12(R2)
         LA    R3,0(R3)
         LTR   R3,R3
         BZ    NEXTTCB
         LA    R6,24(R3)
STARTDD  EQU   *
         IC    R7,0(R6)
         LTR   R7,R7
         BZ    NEXTTCB
         SH    R7,=H'16'
         SRL   R7,2
         LTR   R7,R7
         BNP   NEXTTCB
         LA    R6,16(R6)
UCBTEST  EQU   *
         LH    R8,2(R6)
         CR    R8,R5
         BE    MOVENAM
         LA    R6,4(R6)
         BCT   R7,UCBTEST
         B     STARTDD
MOVENAM  EQU   *
         TM    SWITCH,X'80'
         BO    NOTFIRST
         OI    SWITCH,X'80'
         MVC   WTO+12(56),WTO+11
NOTFIRST EQU   *
         L     R14,ORIGIN
NEXT     EQU   *
         LTR   R14,R14
         BZ    GETMAIN
         CLC   4(8,R14),0(R3)
         BE    NEXTTCB
         L     R14,0(R14)
         B     NEXT
GETMAIN  EQU   *
         GETMAIN R,LV=12
         MVC   0(4,R1),ORIGIN
         ST    R1,ORIGIN
         MVC   4(8,R1),0(R3)
         MVC   0(8,R9),0(R3)
         LA    R9,9(R9)
         BCT   R4,NEXTTCB
         BAL   R14,WTOROUT
         NI    SWITCH,X'7F'
         LA    R4,6
         LA    R9,WTO+12
NEXTTCB  EQU   *
         L     R2,116(R2)
         LTR   R2,R2
         BNZ   LTIOT
JOBRET   EQU   *
         TM    SWITCH,X'80'
         BNO   RETURN
         BAL   R14,WTOROUT
RETURN   EQU   *
         L     R6,ORIGIN
NFREE    EQU   *
         LTR   R6,R6
         BZ    RET1
         L     R5,0(R6)
         FREEMAIN R,LV=12,A=(R6)
         LR    R6,R5
         B     NFREE
RET1     EQU   *
         XRETURN 0,R
SEARCH   EQU   *
         CLC   0(2,R4),=X'FFFF'  END OF LOOK UP TABLE
         BE    END               YES (MVS REL 3.0)
         ICM   R5,3,0(R4)        INSERT UCB-ADD
         LA    R4,2(R4)
         BZ    SEARCH
         BR    R7
END      EQU   *
         MVC   WTO(LENMESS1),MESS1
         BAL   R14,WTOROUT
         B     RETURN
WTOROUT  EQU   *
         L     R0,REG4
         WTO   MF=(E,WTO)
         BR    R14
JOB      EQU   *
         L     R2,16
         TM    116(R2),X'01'      MVS?
         BO    MVSJOBS            YES.
         L     R4,160(R4)
JOBNTCB  EQU   *
         L     R5,12(R4)
         CLC   0(8,R5),TEXT+7
         BE    JOBFND
         L     R4,116(R4)
         LA    R4,0(R4)
         LTR   R4,R4
         BNZ   JOBNTCB
JOBM7    EQU   *
         MVC   WTO(LENMESS7),MESS7
         MVC   WTO+16(8),TEXT+7
         BAL   R14,WTOROUT
         B     RETURN
JOBFND   EQU   *
         LA    R5,0(R5)
         LTR   R5,R5
         BNZ   JOBTIOT
JOBNTIOT EQU   *
         MVC   WTO(LENMESS6),MESS6
         MVC   WTO+16(8),TEXT+7
         BAL   R14,WTOROUT
         B     RETURN
JOBTIOT  EQU   *
         LA    R5,24(R5)
         SR    R7,R7
         CLI   0(R5),X'00'
         BNE   JOBNSYS
         CLI   28(R4),X'00'
         BNE   JOBNTIOT
         L     R5,136(R4)
         L     R5,12(R5)
         B     JOBFND
JOBNSYS  EQU   *
         LH    R6,18(R5)
         CLI   2(R6),X'FF'
         BNE   JOBM7
         TM    3(R6),X'88'
         BNO   JOBM7
         MVC   WTO(LENMESS5),MESS5
         MVC   WTO+16(8),TEXT+7
         BAL   R14,WTOROUT
         MVC   WTO(LENMESS4),MESS4
         LA    R9,WTO+12
         LA    R4,14
JOBNTRY  EQU   *
         IC    R7,0(R5)
         SH    R7,=H'16'
         SRL   R7,2
         LA    R6,16(R5)
JOBNUNT  EQU   *
         LH    R8,2(R6)
         CLI   2(R8),X'FF'
         BNE   JOBIUNT
         TM    3(R8),X'88'
         BNO   JOBIUNT
         L     R10,ORIGIN
JOBNNTRY EQU   *
         LTR   R10,R10
         BZ    JOBGTMN
         CH    R8,4(R10)
         BE    JOBIUNT
         L     R10,0(R10)
         B     JOBNNTRY
JOBIUNT  EQU   *
         LA    R6,4(R6)
         BCT   R7,JOBNUNT
         LR    R5,R6
         CLI   0(R5),X'00'
         BE    JOBRET
         B     JOBNTRY
JOBGTMN  EQU    *
         GETMAIN R,LV=12
         MVC   0(4,R1),ORIGIN
         ST    R1,ORIGIN
         STH   R8,4(R1)
         TM    SWITCH,X'80'
         BO    JOBNFST
         OI    SWITCH,X'80'
         MVC   WTO+12(56),WTO+11
JOBNFST  EQU   *
         MVC   0(3,R9),13(R8)
         LA    R9,4(R9)
         BCT   R4,JOBIUNT
         BAL   R14,WTOROUT
         NI    SWITCH,X'7F'
         LA    R4,14
         LA    R9,WTO+12
         B     JOBIUNT
         EJECT
MESS1    WTO   'XALLOC1 UNIT NOT FOUND IN UCBS',MF=L,                  *
               MCSFLAG=REG0
LENMESS1 EQU   *-MESS1
MESS2    WTO   'XALLOC2 UNIT IS NOT ALLOCATED',MCSFLAG=REG0,           *
               MF=L
LENMESS2 EQU   *-MESS2
MESS3    WTO   'XALLOC3 UNIT IS ALLOCATED TO FOLLOWING JOB(S):',       *
               MCSFLAG=REG0,MF=L
LENMESS3 EQU   *-MESS3
MESS4    WTO   'XALLOC4 NO JOB(S) FOUND                                *
                        ',MCSFLAG=REG0,MF=L
LENMESS4 EQU   *-MESS4
MESS5    WTO   'XALLOC5 JOB 12345678 HAS ALLOCATED FOLLOWING UNITS:',  *
               MCSFLAG=(REG0),MF=L
LENMESS5 EQU   *-MESS5
MESS6    WTO   'XALLOC6 JOB 12345678 HAS NO UNITS ALLOCATED          ',*
               MCSFLAG=(REG0),MF=L
LENMESS6 EQU   *-MESS6
MESS7    WTO   'XALLOC7 JOB 12345678 NOT ACTIVE',                      *
               MCSFLAG=(REG0),MF=L
LENMESS7 EQU   *-MESS7
MESS8    WTO   'XALLOC8 LAST TASK ALLOCATED TO UNIT ... IS:',          *
               MCSFLAG=(REG0),MF=L
LENMESS8 EQU   *-MESS8
MESS9    WTO   'XALLOC9 ADDRESS-SPACE COULD NOT BE LOCATED.',          *
               MCSFLAG=(REG0),MF=L
LENMESS9 EQU   *-MESS9
         LTORG
         TITLE 'MVS EXTENSION FOR RELEASE 2.0'
MVSALLOC EQU   *
         MVC   WTO(LENMESS8),MESS8
         MVC   WTO+40(3),TEXT+6
         BAL   R14,WTOROUT
         MVC   WTO(LENMESS9),MESS9
         L     R2,X'14'(R5)       LOAD UCBEXTP
         LH    R3,X'0E'(R2)       ALLOCATED ASID
         LTR   R3,R3              ASID=00?
         BNZ   LOOKAS
NOJOBSFD EQU   *
         BAL   R14,WTOROUT
         B     RET1
LOOKAS   EQU   *
         STH   R3,ASID
         L     R2,16
         L     R2,X'22C'(R2)    ASVT
         LA    R2,X'20C'(R2)    FIRST ASCB PTR
ASCBLP1  EQU   *
         SR    R4,R4
         ICM   R4,7,1(R2)       LAST ENTRY?
         BZ    NOJOBSFD         YES
         TM    0(R2),X'80'      AVAILABLE ASCB?
         BO    NEXTAS1
         CLC   ASID,X'24'(R4)   ASID FOUND?
         BNE   NEXTAS1
         MVC   WTO+12(60),WTO+11     ERASE LINE
         MVC   WTO+12(30),=CL30'JBNI=........  JBNS=........ '
         L     R9,X'AC'(R4)
         LTR   R9,R9             PTR ZERO?
         BZ    MVSU001           YES
         MVC   WTO+17(8),0(R9)   JBNI
MVSU001  EQU   *
         L     R9,X'B0'(R4)
         LTR   R9,R9
         BZ    AS1OUT
         MVC   WTO+32(8),0(R9)   JBNS
AS1OUT   EQU   *
         BAL   R14,WTOROUT
         B     RET1
NEXTAS1  EQU   *
         LA    R2,4(R2)           STEP TO NEXT PTR
         B     ASCBLP1
         EJECT
MVSJOBS  EQU   *
         L     R2,X'22C'(R2)       ADDRESS SPACE VECTOR TABLE
         LA    R2,X'20C'(R2)       FIRST ASCB PTR
ASCBLP2  EQU   *
         SR    R4,R4
         ICM   R4,7,1(R2)
         BZ    JOBM7
         TM    0(R2),X'80'
         BO    NEXTAS2             ASCB NOT USED
         ICM   R9,7,X'AC'+1(R4)
         BZ    MVSJ001
         CLC   0(8,R9),TEXT+7
         BE    AS2FOUND
MVSJ001  EQU   *
         ICM   R9,7,X'B0'+1(R4)
         BZ    NEXTAS2
         CLC   0(8,R9),TEXT+7
         BNE   NEXTAS2
AS2FOUND EQU   *
         MVC   ASID,X'24'(R4)
         B     GETUNITS
NEXTAS2  EQU   *
         LA    R2,4(R2)
         B     ASCBLP2
GETUNITS EQU   *
         LA    R4,VEKTOR           UCB LOOK UP TABLE
         SR    R5,R5
NEXTUCB2 EQU   *
         CLC   0(2,R4),=X'FFFF'  END OF LOOK UP TABLE
         BE    TESTSW2           YES (MVS REL 3.0)
         ICM   R5,3,0(R4)        INSERT UCB-ADD
         LA    R4,2(R4)            STEP TO NEXT ENTRY
         BZ    NEXTUCB2            ZERO ENTRY.
         TM    3(R5),X'88'         UCB ALLOCATED?
         BNO   NEXTUCB2            NO - SKIP UCB
         ICM   R2,7,X'14'+1(R5)    LOAD UCBEXTP
         BZ    NEXTUCB2
         CLC   ASID,X'0E'(R2)      COMPARE AGAINST ASCB-ID FIELD
         BNE   NEXTUCB2
         OI    SWITCH,X'08'        SET FOUND SW
         TM    SWITCH,X'04'        FIRST LINE WTO'ED?
         BO    MVSJ010             YES.
         OI    SWITCH,X'04'
         MVC   WTO(LENMESS5),MESS5
         MVC   WTO+16(8),TEXT+7
         MVC   WTO+29(26),=C'THE FOLLOWING UCBS MARKED:'
         BAL   R14,WTOROUT
         MVC   WTO(LENMESS4),MESS4
         MVC   WTO+12(MESS5-MESS4-12),WTO+11
         LA    R9,WTO+12
         LA    R6,MAXUNITS         MAX. UNITS/LINE
MVSJ010  EQU   *
         MVC   0(3,R9),13(R5)      MOVE UNIT ADDRESS
         LA    R9,4(R9)
         BCT   R6,NEXTUCB2
         BAL   R14,WTOROUT
         NI    SWITCH,X'F7'        RESET LINE SWITCH
         MVC   WTO+12(MESS5-MESS4-12),WTO+11
         LA    R9,WTO+12
         LA    R6,MAXUNITS         MAX. UNITS/LINE
         B     NEXTUCB2
TESTSW2  TM    SWITCH,X'08'
         BZ    MVSJ011
         BAL   R14,WTOROUT
MVSJ011  EQU   *
         MVC   WTO(LENMESS6),MESS6
         MVC   WTO+29(27),=C'NO UCBASID FIELD ASSIGNED'
         TM    SWITCH,X'04'        ANY UNIT FOUND?
         BZ    JOBNTIOT+6            NO.
         B     RET1                YES - NORMAL RETURN.
*
         EJECT
MAXUNITS EQU   13                 MAX. UNITS/LINE MVS
         XPARM
WORK     DSECT
         DS    18F
WTO      DS    CL100
ORIGIN   DS    F
VEKADDR  DS    F
SWITCH   DS    X
ASID     DS    H
VEKTOR   DS    1024H
VEKEND   DS    H
WORKL    EQU   *-WORK
         END
./ ADD  NAME=ALTR
ALTR     CSECT
         REG
         XSAVE R12,,ALTR,WORKL
         USING WORK,R13
         LR    R14,R1
         USING PARMAREA,R14
         ST    R14,SAVE14
         MVI   MVS,X'00'
         L     R2,16
         TM    116(R2),X'01'
         BZ    *+8
         MVI   MVS,X'FF'
         LA    R2,TEXT
         XC    ECB,ECB
         LA    R11,ZWI
AGAIN    EQU   *
         LR    R5,R2
         LA    R5,4(R5)
         LA    R4,0
NEXTCHAR EQU   *
         LA    R5,1(R5)
         CLI   0(R5),C','
         BE    PAREND
         LA    R4,1(R4)
         B     NEXTCHAR
PAREND   EQU   *
         LR    R6,R4
         SRL   R6,1
         SLL   R6,1
         CR    R6,R4
         BE    NOER
         MVC   ZWI,5(R2)
         MVI   5(R2),X'F0'
         MVC   6(80,R2),ZWI
         B     AGAIN
ERROR    EQU   *
         MVC   WTO(LENOFER),ER
         L     R0,REG4
         WTO   MF=(E,WTO)
RETURN   EQU   *
         XRETURN ,R
NOER     EQU   *
         LA    R6,4(R2)
         CH    R4,=H'8'
         BH    ERROR
         CH    R4,=H'0'
         BNH   ERROR
         LR    R7,R4
CONTNI   EQU   *
         LA    R6,1(R6)
         NI    0(R6),X'3F'
         BCT   R7,CONTNI
GOON     EQU   *
         LA    R6,5(R2)
         BCTR  R4,0
         EX    R4,TREX
         EX    R4,TRTEX
         BNZ   ERROR
         LA    R4,1(R4)
         LA    R7,4
         SLL   R7,4
         OR    R7,R4
         EX    R7,PCKEX
         LA    R8,1
         L     R10,16
         L     R10,164(R10)   R10 = HIGHEST STORAGE-ADDRESS
         LR    R9,R8
         SLL   R9,2
         SR    R10,R9
         LA    R10,1(R10)
         C     R10,0(R11)
         BNH   ERROR
         LA    R5,17
         LA    R7,0
         LA    R6,5(R4,R2)
ZAPLOOP  EQU   *
         LA    R6,1(R6)
         CLI   0(R6),X'40'
         BE    WEITER
         CLI   0(R6),C','
         BE    WEITER
         NI    0(R6),X'3F'
         LA    R7,1(R7)
         BCT   R5,ZAPLOOP
WEITER   EQU   *
         LTR   R7,R7
         BZ    ERROR
         CLI   0(R6),C','
         BNE   ERROR
         CLI   1(R6),C','
         BE    NOCPUID
         LA    R6,1(R6)
         CLI   0(R6),C'A'
         BE    SETRPLY
         CLI   0(R6),C'B'
         BNE   NOCPUID
SETRPLY  EQU   *
         MVC   REPLY,0(R6)
         MVI   ECB,X'FF'
NOCPUID  EQU   *
         CLI   1(R6),C','
         BNE   ERROR
         CLI   2(R6),X'40'
         BE    ERROR
         CLI   2(R6),C','
         BE    ERROR
         MVC   NAME,2(R6)
         BCTR  R7,0
         LA    R6,6(R4,R2)
         TR    0(16,R6),TRTAB
         EX    R7,TRTEX
         BNZ   ERROR
         PACK  5(5,R11),0(9,R6)
         PACK  9(5,R11),8(9,R6)
         L     R5,16
         TM    116(R5),X'14'
         BNO   NOMP
         CLI   ECB,X'FF'
         BE    CPUIDOK
         SR    R15,R15
         CLI   687(R15),X'00'
         BNE   NOMP
         CLC   0(4,R11),=F'4095'
         BH    NOMP
         MVC   WTO(LENOFASK),ASK
WTOR     EQU   *
         XC    ECB,ECB
         LA    1,WTO
         LA    0,REPLY
         ST    0,0(1,0)
         MVI   0(1),1
         LA    14,ECB
         ST    14,4(1,0)
         L     R14,SAVE14
         L     R0,REG4
         SVC   35
         WAIT  ECB=ECB
         OI    REPLY,X'40'
         CLI   REPLY,C'A'
         BE    CPUIDOK
         CLI   REPLY,C'B'
         BNE   WTOR
CPUIDOK  EQU   *
         SR    R15,R15
         CLC   REPLY,696(R15)
         BE    NOMP
         L     R3,0(R11)
         A     R3,688(R15)
         ST    R3,0(R11)
NOMP     EQU   *
         L     R4,0(R11)
         SRL   R7,1
         MVC   WTO(LENOFOLD),OLD
         UNPK  WTO+29(9),0(5,R4)
         UNPK  WTO+37(9),4(5,R4)
         MVI   WTO+45,X'40'
         TR    WTO+29(16),CCTAB-240
         L     R0,REG4
         WTO   MF=(E,WTO)
         TIME  BIN
         STM   R0,R1,WTO
         MVC   TIME(8),WTO
         LA    R15,SMFLEN
         STH   R15,SMFRDW
         XC    SMFRDW+2(4),SMFRDW+2
         MVI   SMFRTYPE+1,X'80'
         L     R15,16
         L     R15,196(R15)
         MVC   SID(4),16(R15)
         MVC   JOBNME,=CL8'XCNTRL'
         MVC   STEPNME,JOBNME
         MVC   PRGNME,JOBNME
         MVC   VOLSER,=CL6' '
         XC    IND,IND
         OI    IND,X'80'
         MVI   LIB,X'40'
         MVC   LIB+1(59),LIB
         LA    R15,1
         STH   R15,NBRFLDS
         ST    R4,ADDR
         XC    ADDR+4(2),ADDR+4
         MVC   OLDCONT,0(R4)
         CLI   MVS,X'FF'
         BNE   GOON1
         MODESET KEY=ZERO
GOON1    EQU   *
         EX    R7,MVCEX
         CLI   MVS,X'FF'
         BNE   GOON2
         MODESET KEY=NZERO
GOON2    EQU   *
         MVC   NEWCONT,0(R4)
         LA    R1,SMFRDW
         SVC   83
         LTR   R15,R15
         BZ    RETURN
         MVC   WTO(LENOFSMF),SMFER
         L     R0,REG4
         WTO   MF=(E,WTO)
         B     RETURN
TREX     TR    0(1,R6),TRTAB
TRTEX    TRT   0(0,R6),ZEROES
PCKEX    PACK  0(0,R11),0(0,R6)
MVCEX    MVC   0(0,R4),5(R11)
ER       WTO   'XALTR01 ERROR IN PARAMETER',MCSFLAG=(REG0),MF=L
LENOFER  EQU   *-ER
ASK      WTOR  'XALTR02 REPLY CPU-ID (''A'' OR ''B'').',               *
               MCSFLAG=(REG0),MF=L
LENOFASK EQU   *-ASK
OLD      WTO   'XALTR03 OLD CONTENTS WAS                  ',MF=L,      *
               MCSFLAG=REG0
LENOFOLD EQU   *-OLD
SMFER    WTO   'XALTR04 ERROR WHILE WRITING SMF-RECORD',MF=L,          *
               MCSFLAG=REG0
LENOFSMF EQU   *-SMFER
TRTAB    DS    0CL64
         DC    X'FF0A0B0C0D0E0F'
         DC    41XL1'FF'
         DC    X'00010203040506070809'
         DC    6XL1'FF'
         DC    0F'0'
ZEROES   DC    16XL1'0'
TABLE    DC    0F'0'
         DC    C'................'
         DC    C'................'
         DC    C'................'
         DC    C'................'
         DC    C'................'
         DC    C'................'
         DC    C'................'
         DC    C'................'
         DC    C'................'
         DC    C'................'
         DC    C'................'
         DC    C'................'
         DC    C'.ABCDEFGHI......'
         DC    C'.JKLMNOPQR......'
         DC    C'..STUVWXYZ......'
         DC    C'0123456789......'
CCTAB    DC    C'0123456789ABCDEF'
WORK     DSECT
SVA      DS    18F
WTO      DS    CL80
ZWI      DS    CL80
ECB      DS    F
REPLY    DS    X
SAVE14   DS    F
MVS      DS    C
*
****  SYSTEM ALTERATION RECORD
*
SMFREC   DS    0F
SMFRDW   DS    F
SMFRTYPE DS    XL2
TIME     DS    CL4
DATE     DS    CL4
SID      DS    CL2
MDL      DS    CL2
JOBNME   DS    CL8
STEPNME  DS    CL8
PRGNME   DS    CL8
NAME     DS    CL20
*
*   IND CAN HAVE THE FOLLOWING VALUES:
*
*      X'80'  --  ONLINE ALTERATION (X ALTR)
*      X'40'  --  IMASPZAP
*      X'20'  --  LKED
*      X'10'  --  IEBCOPY
*      X'08'  --  ZAP CCHHR
*      X'04'  --  NEW/REPL
*
IND      DS    XL2
VOLSER   DS    CL6
LIB      DS    CL44
MODACC   DS    CL8
CSECT    DS    CL8
NBRFLDS  DS    H
ADDR     DS    CL6
OLDCONT  DS    CL32
NEWCONT  DS    CL32
ALIAS    EQU   ADDR
CCHHR    EQU   ADDR
SMFLEN   EQU   *-SMFRDW
WORKL    EQU   *-WORK
         XPARM
         END   ALTR
./ ADD  NAME=AMS
         TITLE 'XAMS                            X-COMMAND AMS'
AMS      CSECT
         SPACE 3
***********************************************************************
*                                                                     *
*      PROGRAM-ID. AMS.                                               *
*      AUTHOR. EHNERT.                                                *
*      INSTALLATION. BAYER AG, LEVERKUSEN, RECHENZENTRUM.             *
*      DATE-WRITTEN. 13. 3. 1975.                                     *
*      REMARKS.                                                       *
*                                                                     *
*          DAS X-COMMAND 'AMS' DIENT ALS INTERFACE ZWISCHEN DER       *
*          SYSTEM-TASK 'XCNTRLVS' UND DEM UTILITY 'IDCAMS'. SO-       *
*          MIT STEHEN DIE ACCESS METHOD SERVICES ALS X-COMMAND        *
*          ZUR VERFUEGUNG.                                            *
*                                                                     *
*          DIE 120-STELLIGE PARAMETERLISTE WIRD ALS SYSIN-DATEI       *
*          AN DAS UTILITY UEBERGEBEN UND MUSS SOMIT DEN DAFUER        *
*          GELTENDEN REGELN GENUEGEN. SOLLEN MEHRERE STATEMENTS       *
*          VERARBEITET WERDEN, SO MUESSEN DIESE DURCH ';' GE-         *
*          TRENNT WERDEN.                                             *
*                                                                     *
*          DER INHALT DER SYSPRINT-DATEI WIRD IN INTERVALLEN MIT      *
*          JE 10 NACHRICHTENZEILEN AUSGEGEBEN. NACH JEDEM INTER-      *
*          VALL KANN DIE ANLISTUNG ABGEBROCHEN ODER AN EINER BE-      *
*          LIEBIGEN STELLE DER DATEI FORTGEFUEHRT WERDEN.             *
*                                                                     *
***********************************************************************
         EJECT
***********************************************************************
*                                                                     *
*      BEGINN DER VERARBEITUNG.                                       *
*                                                                     *
***********************************************************************
         SPACE 3
*
*      SICHERN DER REGISTER,
*      SPEICHERPLATZANFORDERUNG FUER ARBEITSBEREICHE,
*      ZUORDNUNG DER BASISREGISTER.
*
         SPACE 1
         XSAVE R12,,AMS,ABERL
         SPACE 1
         LR    R11,R01       BASISREG. FUER DSECT PARMAREA INITIALIS.
         USING EINGABE,R09   BASISREG. FUER DSECT EINGABE ZUORDNEN
         USING AUSGABE,R10   BASISREG. FUER DSECT AUSGABE ZUORDNEN
         USING PARMAREA,R11  BASISREG. FUER DSECT PARMAREA ZUORDNEN
         USING ABER,R13      BASISREG. FUER DSECT ABER ZUORDNEN
         SPACE 2
*
*      ABFRAGE DES SYSTEMS.
*
         SPACE 1
         L     R02,16                  LOAD ADDRESS OF CVT
         TM    116(R02),X'01'          SYSTEM = OS/VS2 (MVS) ?
         BZ    FEHLSYS       NEIN, VERZW. ZUR FEHLERROUTINE
         EJECT
*
*     PRUEFUNG AUF VORHANDENE AKTIVITAET
*     DER COMMANDS 'AMS' ODER 'BAY',
*     WARTEN, BIS DIESE INAKTIV SIND.
*
         SPACE 1
         MVC   ENQTLIST(12),ENQTLCON PARAMETERLISTE UEBERTRAGEN
         ENQ   ,MF=(E,ENQTLIST) ENQ-SVC (TEST)
         LTR   R15,R15       RETURN CODE = 0 ?
         BZ    *+14                    BRANCH IF YES
         L     R00,REG4      UCM-ID. DES AUFRUFERS LADEN
         WTO   MF=(E,MSG05)  NACHRICHTENZEILE AUSGEBEN
         ENQ   ,MF=(E,ENQULIST) ENQ-SVC (UNCONDITIONAL)
         SPACE 2
*
*      INITIALISIERUNG DER SPEICHER.
*
         SPACE 1
INIT     EQU   *
         MVC   EIN(EDCBLEN),EINDCB DCB FUER SYSPRINT UEBERTRAGEN
         MVC   AUS(ADCBLEN),AUSDCB DCB FUER SYSIN UEBERTRAGEN
         LA    R02,EIN       ADRESSEN DER
         LA    R03,AUS           DCB'S LADEN
         STM   R02,R03,EDCBADDR  UND SPEICHERN
         MVI   EDCBADDR,X'80' OPTION BYTE SETZEN
         MVI   ADCBADDR,X'8F' OPTION BYTE SETZEN
         MVI   FLAGBYTE,X'00' FLAG BYTE LOESCHEN
         XC    REPLY,REPLY    REPLY LOESCHEN
         NI    COMMFLAG,X'7F'          CLEAR FLAG
         SPACE 2
*
*      PRUEFUNG DER PARAMETERKETTE.
*
         SPACE 1
         CLC   TEXT,BLANK    TEXT = BLANK ?
         BE    FEHLPARM      JA, VERZW. ZUR FEHLERROUTINE
         EJECT
***********************************************************************
*                                                                     *
*      VERARBEITUNG DER PARAMETERKETTE.                               *
*                                                                     *
***********************************************************************
         SPACE 3
*
*      SYSIN EROEFFNEN.
*
         SPACE 1
         LA    R01,ADCBADDR            LOAD ADDRESS OF DCB ADDR.
         SVC   19            VERZW. ZUM EROEFFNEN DER DATEI
         SPACE 2
*
*      PARAMETERKETTE UEBERTRAGEN.
*
         SPACE 1
         LA    R02,TEXT-1    ADRESSE DES PARAMETERTEXTES LADEN
         LR    R03,R02       ADRESSE DES PARAMETERTEXTES LADEN
         LA    R04,PARMENDE  ENDADRESSE DES PARAMETERBEREICHS LADEN
PUTLOOP  EQU   *
         PUT   AUS           AUSGABEBEREICH ZUR VERFUEGUNG STELLEN
         LR    R10,R01       LAUFENDE ADRESSE LADEN
         MVC   AZEILE,BLANK  AUSGABEZEILE LOESCHEN
         LA    R05,ATEXT-1   ADRESSE DES AUSGABETEXTES LADEN
         LR    R06,R05       ADRESSE DES AUSGABETEXTES LADEN
         LA    R07,ATEXT+50  ENDADRESSE DES AUSGABETEXTES LADEN
MVCLOOP  EQU   *
         LA    R02,1(R02)    R02 ERHOEHEN
         CR    R02,R04       PARAMETERBEREICH UEBERSCHRITTEN
         BNL   CLOSYSIN                BRANCH IF YES
         LA    R08,1(,R02)   R08 INITIALISIEREN
         CR    R08,R04       ENDE DES PARAMETERBEREICHS ?
         BNL   GOON                    BRANCH IF YES
         CLC   0(2,R02),=C'/*'         START OF COMMENT ?
         BNE   *+8                     BRANCH IF NOT
         OI    COMMFLAG,X'80'          SET FLAG
         CLC   0(2,R02),=C'*/'         END OF COMMENT ?
         BNE   *+8                     BRANCH IF NOT
         NI    COMMFLAG,X'7F'          CLEAR FLAG
         TM    COMMFLAG,X'80'          COMMENT ?
         BO    COMMENT                 BRANCH IF YES
         CLC   0(2,R02),=C'  ' MEHRERE LEERZEICHEN HINTEREINANDER ?
         BE    MVCLOOP                 BRANCH IF YES
         EJECT
GOON     EQU   *
         LA    R05,1(,R05)   R05 ERHOEHEN
         CR    R05,R07       AUSGABETEXT UEBERSCHRITTEN ?
         BNL   MVLOOPOK                BRANCH IF YES
         CLI   0(R02),C' '   BLANK AN DIESER STELLE ?
         BE    LOOP1OK                 BRANCH IF YES
         CLI   0(R02),C')'   TRENNUNGSZEICHEN ')' AN DIESER STELLE ?
         BE    LOOP1OK                 BRANCH IF YES
         CLI   0(R02),C';'   TRENNUNGSZEICHEN, NEUES STATEMENT ?
         BE    LOOP1OK                 BRANCH IF YES
MVCBYTE  EQU   *
         MVC   0(1,R05),0(R02) ZEICHEN UEBERTRAGEN
         B     MVCLOOP                 BRANCH
LOOP1OK  EQU   *
         LR    R03,R02       ADRESSE DES TRENNUNGSZEICHENS LADEN
         LR    R06,R05       ADRESSE DES TRENNUNGSZEICHENS LADEN
         CLI   0(R02),C';'   TRENNUNGSZEICHEN  = ';' ?
         BE    PUTLOOP                 BRANCH IF YES
         B     MVCBYTE                 BRANCH
         SPACE 1
MVLOOPOK EQU   *
         LR    R02,R03       ADR. DES LETZTEN TRENNUNGSZEICHENS LADEN
         LR    R05,R06       R05 AUF DAS LETZTE GUELTIGE
         LA    R05,1(,R05)       ZEICHEN EINSTELLEN
         CR    R05,R07       AUSGABETEXT UEBERSCHRITTEN ?
         BNL   MVICFLAG                BRANCH IF YES
         SR    R07,R05       LAENGE DER ZULETZT UEBERTR. ZEICHEN
         BCTR  R07,0         R07 UM EINS VERMINDERN
         EX    R07,MVCBLANK  VERZW. ZUM LOESCHEN DER LETZTEN ZEICHEN
MVICFLAG EQU   *
         MVI   CONTFLAG,C'-' FORTSETZUNGSZEICHEN SETZEN
         B     PUTLOOP                 BRANCH
         SPACE 1
COMMENT  EQU   *
         LA    R05,1(,R05)             INCREASE ADDRESS IN OUTPUT AREA
         CR    R05,R07                 END OF OUTPUT AREA REACHED ?
         BNL   MVLOOPOK                BRANCH IF YES
         B     MVCBYTE                 BRANCH IF NOT
         SPACE 1
MVCBLANK EQU   *
         MVC   0(0,R05),BLANK ZULETZT UEBERTRAGENE ZEICHEN LOESCHEN
         SPACE 2
*
*      SYSIN SCHLIESSEN.
*
         SPACE 1
CLOSYSIN EQU   *
         MVI   ADCBADDR,X'80' OPTION BYTE MODIFIZIEREN
         LA    R01,ADCBADDR            LOAD ADDRESS OF DCB ADDR.
         SVC   20            VERZW. ZUM SCHLIESSEN DER DATEI
         EJECT
***********************************************************************
*                                                                     *
*      AUFRUF DES UTILITIES 'IDCAMS'.                                 *
*                                                                     *
***********************************************************************
         SPACE 3
         LA    R01,PARMADDR  ADRESSE DER PARAMETERLISTE LADEN
         LINK  EP=IDCAMS     VERZW. ZUM UTILITY 'IDCAMS'
         EJECT
***********************************************************************
*                                                                     *
*      VERARBEITUNG DER IDCAMS-NACHRICHTEN.                           *
*                                                                     *
***********************************************************************
        SPACE 3
*
*      SYSPRINT EROEFFNEN.
*
         SPACE 1
         LA    R01,EDCBADDR            LOAD ADDRESS OF DCB ADDR.
         SVC   19            VERZW. ZUM EROEFFNEN DER DATEI
         MVI   EOF,X'00'     EOF-BYTE LOESCHEN
         SR    R05,R05       LINE COUNT LOESCHEN
WTOMSG06 EQU   *
         L     R00,REG4                LOAD UCM ID.
         WTO   MF=(E,MSG06)  NACHRICHTENZEILE AUSGEBEN
         SPACE 2
*
*      AUSGABE DER IDCAMS-NACHRICHTEN.
*
         SPACE 1
         MVI   FLAGBYTE,X'00' FLAG BYTE LOESCHEN
LOOP2OK  EQU   *
         MVC   WTO(LENMSG01),MSG01 NACHRICHTENZEILE UEBERTRAGEN
         LA    R02,10        R02 INITIALISIEREN
LOOP2    EQU   *
         GET   EIN           EINGABEBEREICH ZUR VERFUEGUNG STELLEN
         LA    R05,1(,R05)   LINE COUNT ERHOEHEN
         LR    R09,R01       LAUFENDE ADRESSE LADEN
         MVC   WTOTEXT,BLANK TEXT LOESCHEN
         SR    R03,R03       R03 LOESCHEN
         ICM   R03,3,TEXTLEN LAENGE DES TEXTES LADEN
         S     R03,=F'6'     R03 VERMINDERN
         EX    R03,MVCETEXT  VERZW. ZUM UEBERTR. DES TEXTES
         BAL   R14,PRUEFTXT  VERZW. ZUM PRUEFEN DER NACHRICHTEN
         MVI   FLAGBYTE,X'00' FLAG BYTE LOESCHEN
         L     R00,REG4                LOAD UCM ID.
         WTO   MF=(E,WTO)    NACHRICHTENZEILE AUSGEBEN
         BCT   R02,LOOP2               BRANCH
         BAL   R14,NXTWTOR             BRANCH
         B     LOOP2OK                 BRANCH
         EJECT
*
*      SYSPRINT SCHLIESSEN.
*
         SPACE 1
ENDFILE  EQU   *
         L     R00,REG4                LOAD UCM ID.
         WTO   MF=(E,MSG07)  NACHRICHTENZEILE AUSGEBEN
         CLC   REPLY,=XL8'0' NOCH KEIN REPLY AUSGEGEBEN ?
         BE    CLOSEPRT                BRANCH IF YES
         MVI   EOF,X'FF'     ENDFILE SPEZIFIZIEREN
         BAL   R14,NXTWTOR             BRANCH
CLOSEPRT EQU   *
         LA    R01,EDCBADDR            LOAD ADDRESS OF DCB ADDR.
         SVC   20            VERZW. ZUM SCHLIESSEN DER DATEI
         B     ABSCHLUS                BRANCH
         SPACE 2
MVCETEXT EQU   *
         MVC   WTOTEXT(0),ETEXT EINGABETEXT UEBERTRAGEN
         EJECT
***********************************************************************
*                                                                     *
*      NACHRICHTENAUSGABE MIT REPLY.                                  *
*                                                                     *
***********************************************************************
         SPACE 3
NXTWTOR  EQU   *
         XC    ECB,ECB       EVENT CONTROL BLOCK LOESCHEN
         XC    REPLY,REPLY   REPLY LOESCHEN
         L     R00,REG4                LOAD UCM ID.
         LA    R02,ECB       ADRESSE DES EVENT CONTROL BLOCK LADEN
         LA    R03,REPLY     ADRESSE DES REPLY LADEN
         MVC   WTO(LENMSG04),MSG04 NACHRICHTENZEILE UEBERTRAGEN
         WTOR  ,(R03),8,(R02),MF=(E,WTO)
         SPACE 1
         WAIT  ECB=ECB
         CLI   REPLY,C'Y'    REPLY = YES ?
         BER   R14                     BRANCH IF YES
         CLI   REPLY,C'N'    REPLY = NO ?
         BE    CLOSEPRT                BRANCH IF YES
         CLI   EOF,X'FF'     ENDE DER DATEI ERREICHT ?
         BNE   ZEROZWF                 BRANCH IF NOT
         CLI   REPLY,C'-'    REPLY = LINE COUNT INCR. MIT NEG. VZ. ?
         BNE   CLOSEPRT                BRANCH IF NOT
         EJECT
***********************************************************************
*                                                                     *
*      ROUTINE FUER REPLY = LINE COUNT INCREMENT.                     *
*                                                                     *
***********************************************************************
         SPACE 3
ZEROZWF  EQU   *
         MVC   ZWFELD,=15C'0' ZWFELD LOESCHEN
         LA    R06,ZWFELD+14 ADRESSE DES LETZTEN BYTES LADEN
         LA    R07,REPLY+7   ADRESSE DES LETZTEN BYTES LADEN
         LA    R08,REPLY     ADRESSE DES REPLY LADEN
         SPACE 2
*
*      PRUEFUNG UND UEBERTRAGUNG EINZELNER BYTES.
*
         SPACE 1
MVCREPLP EQU   *
         CR    R07,R08       ERSTES BYTE DES REPLY ERREICHT ?
         BL    ENDREPLP      VERZW., DA SCHON ALLE BYTES UEBERTR.
         BH    PRFBYTE                 BRANCH IF NOT
         CLI   REPLY,C'+'    REPLY = LINE COUNT INCR. MIT VZ. ?
         BE    ENDREPLP                BRANCH IF YES
         CLI   REPLY,C'-'    REPLY = LINE COUNT INCR. MIT VZ. ?
         BNE   PRFBYTE                 BRANCH IF NOT
         NI    ZWFELD+14,X'DF' NEGATIVES VORZEICHEN SPEZIFIZIEREN
         B     ENDREPLP                BRANCH
PRFBYTE  EQU   *
         CLI   0(R07),X'00'  ZEICHEN = LEERZEICHEN ?
         BE    SRR07                   BRANCH IF YES
         CLI   0(R07),C'0'   ZEICHEN GUELTIG ?
         BL    NXTWTOR                 BRANCH IF NOT
         CLI   0(R07),C'9'   ZEICHEN GUELTIG ?
         BH    NXTWTOR                 BRANCH IF NOT
         MVC   0(1,R06),0(R07) ZEICHEN UEBERTRAGEN
         BCTR  R06,0         ADRESSE DES NAECHSTEN ZEICHENS
SRR07    EQU   *
         BCTR  R07,0         ADRESSE DES NAECHSTEN ZEICHENS
         B     MVCREPLP                BRANCH
         EJECT
*
*      AUFBEREITUNG DES LINE COUNT INCREMENTS.
*
         SPACE 1
ENDREPLP EQU   *
         PACK  DBWORD,ZWFELD LINE COUNT INCR. PACKEN
         CVB   R06,DBWORD    UMWANDELN IN DUALZAHL
         BCTR  R06,0         R06 UM EINS VERMINDERN
         AR    R06,R05       R06 UM LINE COUNT ERHOEHEN
         CR    R06,R05       R06 > R05 ?
         BH    SRCHLOOP                BRANCH IF YES
         LA    R01,EDCBADDR            LOAD ADDRESS OF DCB ADDR.
         SVC   20            VERZW. ZUM SCHLIESSEN DER DATEI
         LA    R01,EDCBADDR            LOAD ADDRESS OF DCB ADDR.
         SVC   19            VERZW. ZUM OEFFNEN DER DATEI
         MVI   EOF,X'00'     EOF-BYTE LOESCHEN
         SR    R05,R05       LINE COUNT LOESCHEN
         LTR   R06,R06       R06 > 0 ?
         BP    SRCHLOOP                BRANCH IF YES
         SR    R06,R06       R06 LOESCHEN
         B     WTOMSG06                BRANCH
         SPACE 2
*
*      AUFSUCHEN DES GESUCHTEN SATZES.
*
         SPACE 1
SRCHLOOP EQU   *
         CR    R05,R06       R05 = R06 ?
         BE    LOOP2OK                 BRANCH IF YES
         GET   EIN           EINEN SATZ LESEN
         LA    R05,1(,R05)   LINE COUNT ERHOEHEN
         B     SRCHLOOP                BRANCH
         EJECT
***********************************************************************
*                                                                     *
*      ABSCHLUSSROUTINEN.                                             *
*                                                                     *
***********************************************************************
         SPACE 3
*
*      DEQ-SVC UND LAENGE DER
*      ARBEITSBEREICHE FESTSTELLEN.
*
         SPACE 1
ABSCHLUS EQU   *
         MVC   DEQLIST(12),DEQCLIST PARAMETERLISTE UEBERTRAGEN
         DEQ   ,MF=(E,DEQLIST) DEQ-SVC
         LA    R01,ABERL     LAENGE DES ARBEITSBEREICHS LADEN UND
         ST    R01,SAVEAREA      IM ERSTEN WORT DER SAVEAREA SPEICHERN
         SPACE 2
*
*      SPEICHERPLATZFREIGABE,
*      REINITIALISIERUNG DER REGISTER UND
*      RUECKSPRUNG ZUM AUFRUFENDEN PROGRAMM.
*
         SPACE 1
ENDE     EQU   *
         XRETURN ,R
         EJECT
***********************************************************************
*                                                                     *
*      PRUEFUNG DER IDCAMS-NACHRICHTEN.                               *
*                                                                     *
***********************************************************************
         SPACE 3
PRUEFTXT EQU   *
         CLC   WTOTEXT(23),=C'IDCAMS  SYSTEM SERVICES'
         BE    LOOP2
         CLC   WTOTEXT(3),=C'IDC'
         BE    MVCMSG
         CLC   WTOTEXT+29(20),=C'LISTING FROM CATALOG'
         BE    LOOP2
         CLC   WTOTEXT,BLANK
         BE    LOOP2
         CLC   WTOTEXT+9(10),=C'THE NUMBER'
         BNE   *+8
         MVI   FLAGBYTE,X'FF'
         CLC   WTOTEXT(9),BLANK
         BNER  R14
         CLI   FLAGBYTE,X'FF'
         BE    LOOP2
         BR    R14
         SPACE 1
MVCMSG   EQU   *
         LA    R04,WTOTEXT+119
         LA    R03,WTOTEXT
         SR    R07,R07
LOOP3    EQU   *
         CR    R04,R03
         BLR   R14
         CLC   0(2,R04),=C', '
         BE    LOOP3OK
         CLC   0(2,R04),=C'. '
         BE    LOOP3OK
         LA    R07,1(R07)
         BCT   R04,LOOP3
LOOP3OK  EQU   *
         BCTR  R07,0
         EX    R07,MVCWTOTX
         BR    R14
         SPACE 1
MVCWTOTX EQU   *
         MVC   WTOTEXT+9(0),2(R04)
         EJECT
***********************************************************************
*                                                                     *
*      FEHLERROUTINEN.                                                *
*                                                                     *
***********************************************************************
         SPACE 3
*
*      ROUTINE BEI UNGUELTIGEM SYSTEM.
*
         SPACE 1
FEHLSYS  EQU   *
         L     R00,REG4                LOAD UCM ID.
         WTO   MF=(E,MSG02)  NACHRICHTENZEILE AUSGEBEN
         B     ENDE                    BRANCH
         SPACE 2
*
*      ROUTINE BEI FEHLER IN DER PARAMETERKETTE.
*
         SPACE 1
FEHLPARM EQU   *
         L     R00,REG4                LOAD UCM ID.
         WTO   MF=(E,MSG03)  NACHRICHTENZEILE AUSGEBEN
         B     ABSCHLUS                BRANCH
         EJECT
***********************************************************************
*                                                                     *
*      REGISTER EQUATES.                                              *
*                                                                     *
***********************************************************************
         SPACE 3
R00      EQU   0             MACRO- UND-PARAMETER REGISTER
R01      EQU   1             MACRO- UND-PARAMETER REGISTER
R02      EQU   2             ARBEITSREGISTER
R03      EQU   3             ARBEITSREGISTER
R04      EQU   4             ARBEITSREGISTER
R05      EQU   5             ARBEITSREGISTER
R06      EQU   6             ARBEITSREGISTER
R07      EQU   7             ARBEITSREGISTER
R08      EQU   8             ARBEITSREGISTER
R09      EQU   9             BASISREG. FUER DSECT EINGABE
R10      EQU   10            BASISREG. FUER DSECT AUSGABE
R11      EQU   11            BASISREG. FUER DSECT PARMAREA
R12      EQU   12            BASISREG. FUER CSECT AMS
R13      EQU   13            BASISREG. FUER DSECT ABER
R14      EQU   14            RUECKSPRUNGADRESSEN
R15      EQU   15            CSECT-ADRESSEN UND RETURN CODES
         EJECT
***********************************************************************
*                                                                     *
*      DEFINITION DER KONSTANTEN-SPEICHER.                            *
*                                                                     *
***********************************************************************
         SPACE 3
         DS    0F
PARMADDR DC    AL1(128)
         DC    AL3(PARMINFO)
PARMINFO DC    H'0'
BLANK    DC    120C' '
QNAME    DC    C'XCNTRLVS'
RNAME    DC    C'SYSPRINT'
         SPACE 2
*
*      PARAMETERLISTE FUER ENQ-SVC (UNCONDITIONAL).
*
         SPACE 1
ENQULIST ENQ   (QNAME,RNAME,E,8,SYSTEMS),RET=NONE,MF=L
         SPACE 2
*
*      PARAMETERLISTE FUER ENQ-SVC (TEST).
*
         SPACE 1
ENQTLCON ENQ   (QNAME,RNAME,E,8,SYSTEMS),RET=TEST,MF=L
         EJECT
*
*      PARAMETERLISTE FUER DEQ-SVC.
*
         SPACE 1
DEQCLIST DEQ   (QNAME,RNAME,8,SYSTEMS),MF=L
         SPACE 2
*
*      DCB FUER SYSPRINT.
*
         SPACE 1
EINDCB   DCB   DDNAME=SYSPRINT,                                        *
               DSORG=PS,                                               *
               MACRF=(GL),                                             *
               EODAD=ENDFILE
EDCBLEN  EQU   *-EINDCB      LAENGE DES DCB
         SPACE 2
*
*      DCB FUER SYSIN.
*
         SPACE 1
AUSDCB   DCB   DDNAME=SYSIN,                                           *
               DSORG=PS,                                               *
               MACRF=(PL),                                             *
               RECFM=F,                                                *
               LRECL=80,                                               *
               BLKSIZE=80
ADCBLEN  EQU   *-AUSDCB      LAENGE DES DCB
         EJECT
***********************************************************************
*                                                                     *
*      DEFINITION DER AUSGABENACHRICHTEN.                             *
*                                                                     *
***********************************************************************
         SPACE 3
MSG01    WTO   'XAMS001                                                *
                      ',                                               *
               MF=L,MCSFLAG=(REG0)
LENMSG01 EQU   *-MSG01
         SPACE 1
MSG02    WTO   'XAMS002 FUNCTION SUPPORTED FOR OS/VS2 (MVS) ONLY',     *
               MF=L,MCSFLAG=(REG0)
         SPACE 1
MSG03    WTO   'XAMS003 INVALID PARAMETER LIST',                       *
               MF=L,MCSFLAG=(REG0)
         SPACE 1
MSG04    WTOR  'XAMS004 REPLY ''Y'' (YES), ''N'' (NO) OR LINE COUNT INC*
               REMENT',                                                *
               MF=L,MCSFLAG=(REG0)
LENMSG04 EQU   *-MSG04
         EJECT
MSG05    WTO   'XAMS005 COMMAND ''AMS'' OR ''BAY'' ACTIVE, WAIT FOR COM*
               PLETION',                                               *
               MF=L,MCSFLAG=(REG0)
         SPACE 1
MSG06    WTO   'XAMS000 TOP OF DATA SET',                              *
               MF=L,MCSFLAG=(REG0)
         SPACE 1
MSG07    WTO   'XAMS000 END OF DATA SET',                              *
               MF=L,MCSFLAG=(REG0)
         EJECT
***********************************************************************
*                                                                     *
*      DEFINITION DER ARBEITSBEREICHE.                                *
*                                                                     *
***********************************************************************
         SPACE 3
ABER     DSECT
SAVEAREA DS    18F           SAVEAREA FUER ALLGEMEINE REGISTER
DBWORD   DS    D             ZWISCHENSPEICHER FUER DEZIMALZAHLEN
ZWFELD   DS    CL15          ZWISCHENSPEICHER FUER DEZIMALZAHLEN
FLAGBYTE DS    C             FLAG BYTE
COMMFLAG DS    C             FLAG BYTE
REPLY    DS    CL8           BEREICH FUER REPLY
EOF      DS    C             FLAG BYTE FUER DATEIENDE
ECB      DS    F             EVENT CONTROL BLOCK
DEQLIST  DS    3F            PARAMETERLISTE FUER DEQ-SVC
EDCBADDR DS    F             DCB-ADRESSE FUER SYSPRINT
ADCBADDR DS    F             DCB-ADRESSE FUER SYSIN
EIN      DS    0F            DCB FUER SYPRINT
         ORG   *+EDCBLEN
AUS      DS    0F            DCB FUER SYSIN
         ORG   *+ADCBLEN
WTO      DS    0F            BEREICH FUER AUSGABENACHRICHTEN
         DS    CL12
WTOTEXT  DS    CL120         BEREICH FUER AUSGABETEXTE
         SPACE 2
*
*      PARAMETERLISTE FUER ENQ-SVC (TEST).
*
         SPACE 1
ENQTLIST DS    0F
         DS    CL3
ENQTRC   DS    C             RETURN CODE
         DS    CL8
         SPACE 1
ABERL    EQU   *-ABER        LAENGE DES ARBEITSBEREICHES
         SPACE 2
*
*      EINGABEBEREICH.
*
         SPACE 1
EINGABE  DSECT
TEXTLEN  DS    CL2           LAENGE DES EINGABETEXTES
         DS    CL2
         DS    C             STEUERZEICHEN
ETEXT    DS    CL120         EINGABETEXT
         EJECT
*
*      AUSGABEBEREICH.
*
         SPACE 1
AUSGABE  DSECT
AZEILE   DS    CL80          AUSGABEZEILE
         ORG   AUSGABE+1
ATEXT    DS    CL50          AUSGABETEXT
         DS    C
CONTFLAG DS    C             FORTSETZUNGSZEICHEN (' ' × '-')
         SPACE 2
*
*      PARAMETERBEREICH.
*
         SPACE 1
PARMAREA DSECT
REG4     DS    F             MCS-ID DER CONSOLE
         DS    CL4           = 'AMS,'
TEXT     DS    CL120
PARMENDE EQU   *
         END   AMS
./ ADD  NAME=ATT
ATT      START
         XSAVE R12,,ATT,WORKLEN
         USING WORK,R13
         MVI   SWITCH,X'00'
         LR    R11,R1
         USING PARMAREA,R11
         GETMAIN R,LV=EXLEN,SP=126
         LR    R10,R1
         USING EXECPARM,R10
         LA    R2,TEXT+4
         SR    R3,R3
         LA    R4,9
NEXTCHAR EQU   *
         LA    R5,0(R2,R3)
         CLI   0(R5),C','
         BE    ENDNM
         CLI   0(R5),C' '
         BNE   INCR
         OI    SWITCH,NOPRM
         B     ENDNM
INCR     EQU   *
         LA    R3,1(R3)
         BCT   R4,NEXTCHAR
ERROR    EQU   *
         MVC   WTO(MESS5-MESS4),MESS4
         L     R0,REG4
         WTO   MF=(E,WTO)
         B     RETURN
ENDNM    EQU   *
         LTR   R3,R3
         BZ    ERROR
         BCTR  R3,0
         MVC   MODULENM,=CL8' '
         EX    R3,MVCEX1
         TM    SWITCH,NOPRM
         BNO   PARMDA
         SR    R3,R3
         STH   R3,LENGTH
         B     XCTL
PARMDA   EQU   *
         LA    R2,2(R2,R3)
         CLI   0(R2),C''''
         BNE   ERROR
         LA    R2,1(R2)
         SR    R3,R3
         LA    R4,101
NEXTPRM  EQU   *
         LA    R5,0(R2,R3)
         CLI   0(R5),C''''
         BE    ENDPRM
         LA    R3,1(R3)
         BCT   R4,NEXTPRM
         B     ERROR
ENDPRM   EQU   *
         LTR   R3,R3
         BZ    ERROR
         STH   R3,LENGTH
         BCTR  R3,0
         EX    R3,MVCEX2
         OC    PARMVAL,PARMBLNK
XCTL     EQU   *
         ST    R10,PARMR
         OI    PARMR,X'80'
         LA    R1,PARMR
         MVC   ATT,ATTACH
         XC    ECB,ECB
         ATTACH  EPLOC=MODULENM,ECB=ECB,SF=(E,ATT),GSPV=126
         ST    R1,TCBADDR
         MVC   WTO(MESS2-MESS1),MESS1
         MVC   WTO+17(8),MODULENM
         L     R0,REG4
         WTO   MF=(E,WTO)
         MVC   REG4W,REG4
         WAIT  ECB=ECB
         DETACH TCBADDR
         MVC   WTO(MESS3-MESS2),MESS2
         MVC   WTO+17(8),MODULENM
         L     R0,REG4W
         WTO   MF=(E,WTO)
RETURN   EQU   *
         XRETURN ,R
MESS1    WTO   'XATT001 TASK XXXXXXXX STARTED',MF=L,                   *
               MCSFLAG=(REG0)
MESS2    WTO   'XATT002 TASK XXXXXXXX ENDED ',MF=L,                    *
               MCSFLAG=(REG0)
MESS3    DS    0H
MESS4    WTO   'XATT003 ERROR IN PARAMETER',MCSFLAG=REG0,MF=L
MESS5    DS    0H
NOPRM    EQU   X'80'
MVCEX1   MVC   MODULENM(0),0(R2)
MVCEX2   MVC   PARMVAL(0),0(R2)
ATTACH   ATTACH SF=L
         REG
PARMBLNK DC    CL100' '
WORK     DSECT
SVA      DS    18F
ECB      DS    F
REG4W    DS    F
ATT      DS    CL36
WTO      DS    CL70
SWITCH   DS    X
MODULENM DS    CL8
TCBADDR  DS    F
PARMR    DS    F
WORKLEN  EQU   *-WORK
         XPARM
EXECPARM DSECT
LENGTH   DS    H
PARMVAL  DS    CL100
EXLEN    EQU   *-EXECPARM
         END   ATT
./ ADD  NAME=AVR
AVR      CSECT
***********************************************************************
*                                                                     *
* AUTHOR. EBELING.                                                    *
* DATE-WRITTEN. 23.10.72.                                             *
* INSTALLATION. BAYER AG, LEVERKUSEN, RECHENZENTRUM.                  *
* REMARKS.                                                            *
*     DAS PROGRAMM DURCHSUCHT DIE UCB'S UND GIBT NACH BEDARF ZWEI     *
*     LISTEN MIT BANDEINHEITEN ADRESSEN AUS.                          *
*     DIE ERSTE LISTE ENTHAELT ALLE ADRESSEN, DIE ONLINE NOT RAEDY    *
*     SIND. DIE ZWEITE ALLE ADRESSEN, DIE ONLINE ABER NICHT ALLOCATED *
*     SIND UND BEI DENEN DIE VOLUME SERIAL NUMMER NOCH NICHT GELESEN  *
*     WURDE.                                                          *
*     DAS PROGRAMM IST REENTERABLE UND REUSEABLE.                     *
*     BENUTZTE MACROS: WTO FREEMAIN REG XSAVE                         *
*                                                                     *
***********************************************************************
         XSAVE R12,,AVR,WORKL
         USING WORK,R13
         USING PARMAREA,R11
         LR    R11,R1
*        INIT MESSAGES
         MVC   WTO2(MESS2L),MESSAGE2
         MVC   WTO4(MESS4L),MESSAGE4
         LA    R10,WTO2+WTO2DYN
         ST    R10,WTO2D
         MVI   WTOSTAT,WTO2INIT+WTO4INIT
         LA    R10,WTO4+WTO4DYN
         ST    R10,WTO4D
*        UCB ADDRESS LIST IN UCB LOOKUP TABLE
         LA    R1,VEKTOR
         ST    R1,VEKADDR
         MVI   VEKADDR,X'80'
         LA    R1,VEKADDR
         LINK  EP=GETUCBS
         MVC   VEKEND,=X'FFFF'
         LA    R7,VEKTOR
         SR    R5,R5
LOADUCB  EQU   *
         CLC   0(2,R7),VEKEND
         BE    ENDLIST
         ICM   R5,3,0(R7)
         LA    R7,2(R7)            NEXT LIST ELEMENT
         B     LOADUCB
ENDLIST  EQU   *
         ST    R7,SAVE7
AGAIN    EQU   *
         LA    R3,VEKTOR
         L     R7,SAVE7
         SR    R5,R5
NEXTADDR EQU   *
         BCTR  R7,0
         BCTR  R7,0                LIST ELEMENT BEFOR LAST ONE
         ICM   R5,3,0(R7)
         B     WORKUCB             VALID ADDR
NEXTUCB  EQU   *
         CR    R7,R3               WAS THAT THE FIRST ONE
         BNH   LASTUCB
         B     NEXTADDR
*        TEST THE UCB
WORKUCB  EQU   *
         TM    2(R5),X'FF'
         BNO   BRETURN
         TM    3(R5),X'80'         ONLINE
         BNO   NEXTUCB
         TM    3(R5),X'40'         CHANGE TO OFFLINE
         BO    NEXTUCB
         TM    16(R5),X'04'        MODELL
         BNO   NEXTUCB
         CLI   18(R5),X'80'        MAGNETIC TAPE
         BNE   NEXTUCB
         CLI   19(R5),X'01'        2400 SERIES
         BE    TAPE
         CLI   19(R5),X'03'      3400 SERIES
         BNE   NEXTUCB
TAPE     EQU   *
         TM    3(R5),X'08'         ALLOCATED
         BO    NEXTUCB
         LR    R2,R4
         TM    6(R5),X'40'         NOT READY
         BO    WMESS2
         CLI   28(R5),X'00'        VOLSER
         BE    WMESS4
         B     NEXTUCB
*        INSERT UCB ADDR INTO OUTPUT MESSAGES
WMESS2   EQU   *
         TM    WTOSTAT,WTO4ONLY    SECOND LOOP
         BO    NEXTUCB
         L     R10,WTO2D           LOAD NEXT PLACE
         L     R9,12(R5)           LOAD UCB ADDR
         ST    R9,0(R10)           STORE INTO MESSAGE
         MVI   0(R10),X'40'        INSERT BLANK
         OI    WTOSTAT,WTO2FILL    SET FILLED INDICATOR
         LA    R10,4(R10)          NEXT PLACE
         ST    R10,WTO2D
         LA    R9,WTO2+WTO2L
         CR    R10,R9              MESSAGE FILLED
         BL    NEXTUCB
         BAL   R8,WMESS21
         B     NEXTUCB
WMESS4   EQU   *
         TM    WTOSTAT,WTO4FULL    WTO4 ALLREADY FULL
         BO    WMESS40
         L     R10,WTO4D           LOAD NEXT PLACE
         L     R9,12(R5)           LOAD UCB ADDR
         ST    R9,0(R10)           STORE INTO MESSAGE
         MVI   0(R10),X'40'        INSERT BLANK
         OI    WTOSTAT,WTO4FILL    SET FILLED INDICATOR
         LA    R10,4(R10)          NEXT PLACE
         ST    R10,WTO4D
         LA    R9,WTO4+WTO4L
         CR    R10,R9              MESSAGE FILLED
         BL    NEXTUCB
         BAL   R8,WMESS41
         B     NEXTUCB
WMESS40  EQU   *
         OI    WTOSTAT,WTO4OVFL    TRY IT IN THE NEXT LOOP
         B     NEXTUCB
*        SEND PREPARED MESSAGES
WMESS21  EQU   *
         TM    WTOSTAT,WTO2INIT    FIRST TIME
         BNO   WMESS22
         L     R0,REG4             SET CONSOLE ID
         WTO   MF=(E,MESSAGE1)
WMESS22  EQU   *
         NI    WTOSTAT,WTOALL-WTO2INIT-WTO2FILL
         L     R0,REG4             INSERT CONSOLE ID
         WTO   MF=(E,WTO2)
         MVC   WTO2(MESS2L),MESSAGE2
         LA    R10,WTO2+WTO2DYN    FIRST FREE SPACE
         ST    R10,WTO2D
         BR    R8                  RETURN
WMESS41  EQU   *
         TM    WTOSTAT,WTO4ONLY    SECOND LOOP
         BO    WMESS42
         OI    WTOSTAT,WTO4FULL    WTO4 TOTALY FILLED
         BR    R8
WMESS42  EQU   *
         TM    WTOSTAT,WTO4INIT+WTO4FILL MESSAGEE3 NESS
         BNO   WMESS43
         L     R0,REG4             LOAD CONSOLE ID
         WTO   MF=(E,MESSAGE3)
WMESS43  EQU   *
         NI    WTOSTAT,WTOALL-WTO4INIT-WTO4FILL
         L     R0,REG4             INSERT CONSOLE ID
         WTO   MF=(E,WTO4)
         MVC   WTO4(MESS4L),MESSAGE4
         LA    R10,WTO4+WTO4DYN    FIRST FREE SPACE
         ST    R10,WTO4D
         BR    R8                  RETURN
*        TEST FOR RETURN
LASTUCB  EQU   *
TEST1    EQU   *
         TM    WTOSTAT,WTO4ONLY    SECONDLOOP
         BO    TEST2
         TM    WTOSTAT,WTO2FILL
         BO    GEF1
         TM    WTOSTAT,WTO2INIT    ONCE FILLED
         BNO   TEST2
         MVC   WTO2+WTO2DYN(5),=C' NONE'
         LA    R10,WTO2+WTO2DYN+5
         ST    R10,WTO2D
GEF1     EQU   *
         BAL   R8,WMESS21
TEST2    EQU   *
         OI    WTOSTAT,WTO4ONLY
         TM    WTOSTAT,WTO4OVFL    NEED SECOND LOOP
         BO    RETRY2
         TM    WTOSTAT,WTO4FILL
         BNO   RETURN
         BAL   R8,WMESS41
         B     RETURN
RETRY2   EQU   *
         MVI   WTOSTAT,X'00'
         OI    WTOSTAT,WTO4ONLY+WTO4INIT
         MVC   WTO4(MESS4L),MESSAGE4
         LA    R10,WTO4+WTO4DYN    RESET ADDRESS
         ST    R10,WTO4D
         B     AGAIN
BRETURN  EQU   *
         MVC   WTO5(MESS5L),MESSAGE5
         LR    R4,R5               UCB ADDR
         LA    R4,0(R4)
         LA    R10,WTO5+WTO5DYN+5
NEXTLETR EQU   *
         SRDL  R4,4
         SRL   R5,28
         IC    R9,TAB1(R5)
         STC   R9,0(R10)
         BCTR  R10,0
         LTR   R4,R4
         BNZ   NEXTLETR
         L     R0,REG4             INSERT CONSOLE ID
         WTO   MF=(E,WTO5)
RETURN   EQU   *
         XRETURN ,R
         LTORG
TAB2     DC    X'000A0B0C0D0E0F000000000000000000'
TAB1     DC    C'0123456789ABCDEF'
MESSAGE1 WTO   'XAVR001 TAPE UNIT(S) AVAILABLE FOR AVR MOUNT',         *
               MCSFLAG=(REG0),MF=L
MESSAGE2 WTO   'XAVR002                                                *
                      ',                                               *
               MCSFLAG=(REG0),MF=L
MESS2L   EQU   *-MESSAGE2
MESSAGE3 WTO   'XAVR003 TAPE UNIT(S) ONLINE NO VOLSER',                *
               MCSFLAG=(REG0),MF=L
MESSAGE4 WTO   'XAVR004                                                *
                      ',                                               *
               MCSFLAG=(REG0),MF=L
MESS4L   EQU   *-MESSAGE4
MESSAGE5 WTO   'XAVR005 INVALID UCB FOUND AT ADDRESS 000000 ',         *
               MCSFLAG=(REG0),MF=L
MESS5L   EQU   *-MESSAGE5
WTO2L    EQU   63
WTO4L    EQU   63
WTO2DYN  EQU   11
WTO4DYN  EQU   11
WTO5DYN  EQU   41
         REG
         XPARM
WORK     DSECT
SVA      DS    18F
SAVE3    DS    F
SAVE7    DS    F
HEX      DS    F
WTO2D    DS    F
WTO4D    DS    F
WTO2     DS    CL72
WTO4     DS    CL72
WTO5     DS    CL54
WTOSTAT  DS    XL1
WTO2INIT EQU   128                   INIT MESSAGE2
WTO4INIT EQU   64                    INIT MESSAGE4
WTO2FILL EQU   32                  MESSAGE2 FILLED
WTO4FILL EQU   16                  MESSAGE4 FILLED
WTO4FULL EQU   8                   MESSAGE4 FULL
WTO4OVFL EQU   4                   SECOND LOOP
WTO4ONLY EQU   2                   FIRST LOOP DONE
WTOALL   EQU   255
VEKADDR  DS    F
VEKTOR   DS    1024H
VEKEND   DS    H
WORKL    EQU   *-WORK
         END
./ ADD  NAME=BAY
         TITLE 'XBAY                            X-COMMAND BAY'
BAY      CSECT
         SPACE 3
***********************************************************************
*                                                                     *
*      PROGRAM-ID. BAY.                                               *
*      AUTHOR. EHNERT.                                                *
*      INSTALLATION. BAYER AG, LEVERKUSEN, RECHENZENTRUM.             *
*      DATE-WRITTEN. 29. 4. 1975.                                     *
*      REMARKS.                                                       *
*                                                                     *
*          DAS X-COMMAND 'BAY' DIENT ALS INTERFACE ZWISCHEN DER       *
*          SYSTEM-TASK 'XCNTRLVS' UND DEM PROGRAMM 'BAYPROGM'.        *
*                                                                     *
*          DIE 120-STELLIGE PARAMETERLISTE WIRD ALS SYSIN-DATEI       *
*          AN DAS PROGRAMM UEBERGEBEN UND MUSS SOMIT DEN DAFUER       *
*          GELTENDEN REGELN GENUEGEN.                                 *
*                                                                     *
*          DER INHALT DER SYSPRINT-DATEI WIRD IN INTERVALLEN MIT      *
*          JE 10 NACHRICHTENZEILEN AUSGEGEBEN. NACH JEDEM INTER-      *
*          VALL KANN DIE ANLISTUNG ABGEBROCHEN ODER AN EINER BE-      *
*          LIEBIGEN STELLE DER DATEI FORTGEFUEHRT WERDEN.             *
*                                                                     *
***********************************************************************
         EJECT
***********************************************************************
*                                                                     *
*      BEGINN DER VERARBEITUNG.                                       *
*                                                                     *
***********************************************************************
         SPACE 3
*
*      SICHERN DER REGISTER,
*      SPEICHERPLATZANFORDERUNG FUER ARBEITSBEREICHE,
*      ZUORDNUNG DER BASISREGISTER.
*
         SPACE 1
         XSAVE R12,,BAY,ABERL
         SPACE 1
         LR    R11,R1        BASISREG. FUER DSECT PARMAREA INITIALIS.
         USING EINGABE,R9    BASISREG. FUER DSECT EINGABE ZUORDNEN
         USING AUSGABE,R10   BASISREG. FUER DSECT AUSGABE ZUORDNEN
         USING PARMAREA,R11  BASISREG. FUER DSECT PARMAREA ZUORDNEN
         USING ABER,R13      BASISREG. FUER DSECT ABER ZUORDNEN
         EJECT
*
*     PRUEFUNG AUF VORHANDENE AKTIVITAET
*     DER COMMANDS 'BAY' ODER 'AMS',
*     WARTEN, BIS DIESE INAKTIV SIND.
*
         SPACE 1
         MVC   ENQTLIST(12),ENQTLCON PARAMETERLISTE UEBERTRAGEN
         ENQ   ,MF=(E,ENQTLIST) ENQ-SVC (TEST)
         LTR   R15,R15       RETURN CODE = 0 ?
         BZ    *+14          JA, VERZWEIGEN
         L     R0,REG4       MCS-ID DER CONSOLE LADEN
         WTO   MF=(E,MSG04)  NACHRICHTENZEILE AUSGEBEN
         ENQ   ,MF=(E,ENQULIST) ENQ-SVC (UNCONDITIONAL)
         SPACE 2
*
*      INITIALISIERUNG DER SPEICHER.
*
         SPACE 1
INIT     EQU   *
         MVC   EIN(EDCBLEN),PRTDCB DCB FUER SYSPRINT UEBERTRAGEN
         MVC   AUS(ADCBLEN),AUSDCB DCB FUER SYSIN UEBERTRAGEN
         LA    R2,EIN        ADRESSEN DER
         LA    R3,AUS            DCB'S LADEN
         STM   R2,R3,EDCBADDR    UND SPEICHERN
         MVI   EDCBADDR,X'80' OPTION BYTE SETZEN
         MVI   ADCBADDR,X'8F' OPTION BYTE SETZEN
         XC    REPLY,REPLY   REPLY LOESCHEN
         SPACE 2
*
*      PRUEFUNG DER PARAMETERKETTE.
*
         SPACE 1
         CLC   TEXT,BLANK    TEXT = BLANK ?
         BNE   OPENSIN       NEIN, VERZWEIGEN
         L     R0,REG4       MCS-ID DER CONSOLE LADEN
         WTO   MF=(E,MSG02)  FEHLERNACHRICHT AUSGEBEN
         B     ABSCHLUS      VERZWEIGEN
         EJECT
***********************************************************************
*                                                                     *
*      VERARBEITUNG DER PARAMETERKETTE.                               *
*                                                                     *
***********************************************************************
         SPACE 3
*
*      SYSIN EROEFFNEN.
*
         SPACE 1
OPENSIN  EQU   *
         LA    R1,ADCBADDR   ADRESSE DER DCB-ADRESSE LADEN
         SVC   19            VERZW. ZUM EROEFFNEN DER DATEI
         SPACE 2
*
*      PARAMETERKETTE UEBERTRAGEN.
*
         SPACE 1
         LA    R2,TEXT-1     ADRESSE DES PARAMETERTEXTES LADEN
         LR    R3,R2         ADRESSE DES PARAMETERTEXTES LADEN
         LA    R4,PARMENDE   ENDADRESSE DES PARAMETERBEREICHS LADEN
PUTLOOP  EQU   *
         PUT   AUS           AUSGABEBEREICH ZUR VERFUEGUNG STELLEN
         LR    R10,R1        LAUFENDE ADRESSE LADEN
         MVC   AZEILE,BLANK  AUSGABEZEILE LOESCHEN
         LA    R5,ATEXT-1    ADRESSE DES AUSGABETEXTES LADEN
         LR    R6,R5         ADRESSE DES AUSGABETEXTES LADEN
         LA    R7,ATEXT+70   ENDADRESSE DES AUSGABETEXTES LADEN
MVCLOOP  EQU   *
         LA    R2,1(R2)      R2 ERHOEHEN
         CR    R2,R4         PARAMETERBEREICH UEBERSCHRITTEN
         BNL   CLOSESIN      JA, VERZWEIGEN
         LA    R8,1(R2)      R8 INITIALISIEREN
         CR    R8,R4         ENDE DES PARAMETERBEREICHS ?
         BNL   *+14          JA, VERZWEIGEN
         CLC   0(2,R2),BLANK MEHRERE LEERZEICHEN HINTEREINANDER ?
         BE    MVCLOOP       JA, VERZWEIGEN
         LA    R5,1(R5)      R5 ERHOEHEN
         CR    R5,R7         AUSGABETEXT UEBERSCHRITTEN ?
         BNL   MVLOOPOK      JA, VERZWEIGEN
         CLI   0(R2),C' '    BLANK AN DIESER STELLE ?
         BE    LOOP1OK       JA, VERZWEIGEN
         CLI   0(R2),C')'    TRENNUNGSZEICHEN ')' AN DIESER STELLE ?
         BE    LOOP1OK       JA, VERZWEIGEN
         CLI   0(R2),C','    TRENNUNGSZEICHEN, NEUES STATEMENT ?
         BE    LOOP1OK       JA, VERZWEIGEN
         EJECT
MVCBYTE  EQU   *
         MVC   0(1,R5),0(R2) ZEICHEN UEBERTRAGEN
         B     MVCLOOP       VERZWEIGEN
LOOP1OK  EQU   *
         LR    R3,R2         ADRESSE DES TRENNUNGSZEICHENS LADEN
         LR    R6,R5         ADRESSE DES TRENNUNGSZEICHENS LADEN
         CLI   0(R2),C','    TRENNUNGSZEICHEN  = ',' ?
         BE    PUTLOOP       JA, VERZWEIGEN
         B     MVCBYTE       VERZWEIGEN
         SPACE 1
MVLOOPOK EQU   *
         LR    R2,R3         ADR. DES LETZTEN TRENNUNGSZEICHENS LADEN
         LR    R5,R6         R5 AUF DAS LETZTE GUELTIGE
         LA    R5,1(R5)          ZEICHEN EINSTELLEN
         CR    R5,R7         AUSGABETEXT UEBERSCHRITTEN ?
         BNL   PUTLOOP       JA, VERZWEIGEN
         SR    R7,R5         LAENGE DER ZULETZT UEBERTR. ZEICHEN
         BCTR  R7,0          R7 UM EINS VERMINDERN
         EX    R7,MVCBLANK   VERZW. ZUM LOESCHEN DER LETZTEN ZEICHEN
         B     PUTLOOP       VERZWEIGEN
         SPACE 1
MVCBLANK EQU   *
         MVC   0(0,R5),BLANK ZULETZT UEBERTRAGENE ZEICHEN LOESCHEN
         SPACE 2
*
*      SYSIN SCHLIESSEN.
*
         SPACE 1
CLOSESIN EQU   *
         MVI   ADCBADDR,X'80' OPTION BYTE MODIFIZIEREN
         LA    R1,ADCBADDR   ADRESSE DER DCB-ADRESSE LADEN
         SVC   20            VERZW. ZUM SCHLIESSEN DER DATEI
         EJECT
***********************************************************************
*                                                                     *
*      AUFRUF DES PROGRAMMS 'BAYPROGM'.                               *
*                                                                     *
***********************************************************************
         SPACE 3
         LA    R1,PARMADDR   ADRESSE DER PARAMETERLISTE LADEN
         LINK  EP=BAYPROGM   VERZW. ZUM PROGRAMM 'BAYPROGM'
         EJECT
***********************************************************************
*                                                                     *
*      VERARBEITUNG DER BAYPROGM-NACHRICHTEN.                         *
*                                                                     *
***********************************************************************
        SPACE 3
*
*      SYSPRINT EROEFFNEN.
*
         SPACE 1
OPENPRT  EQU   *
         LA    R1,EDCBADDR   ADRESSE DER DCB-ADRESSE LADEN
         SVC   19            VERZW. ZUM EROEFFNEN DER DATEI
         MVI   EOF,X'00'     EOF-BYTE LOESCHEN
         SR    R5,R5         LINE COUNT LOESCHEN
WTOMSG05 EQU   *
         L     R0,REG4       MCS-ID DER CONSOLE LADEN
         WTO   MF=(E,MSG05)  NACHRICHTENZEILE AUSGEBEN
         SPACE 2
*
*      AUSGABE DER BAYPROGM-NACHRICHTEN.
*
         SPACE 1
LOOP2OK  EQU   *
         MVC   WTO(LENMSG01),MSG01 NACHRICHTENZEILE UEBERTRAGEN
         L     R0,REG4       MCS-ID DER CONSOLE LADEN
         WTO   MF=(E,MSG01)  UEBERSCHRIFT AUSGEBEN
         LA    R2,10         LOOP COUNT INITIALISIEREN
LOOP2    EQU   *
         GET   EIN           EINGABEBEREICH ZUR VERFUEGUNG STELLEN
         LA    R5,1(R5)      LINE COUNT REHOEHEN
         LR    R9,R1         LAUFENDE ADRESSE LADEN
         BAL   R14,PRUEFTXT  VERZW. ZUM PRUEFEN DER NACHRICHTEN
         BAL   R14,MVCETEXT  VERZW. ZUM UEBERTR. DER NACHRICHTEN
         L     R0,REG4       MCS-ID DER CONSOLE LADEN
         WTO   MF=(E,WTO)    NACHRICHTENZEILE AUSGEBEN
EOFLOOP2 EQU   *
         CLC   EINDSN(7),=C'BAY005I' ENDE DER INFORMATION-NACHRICHTEN ?
         BE    ENDFILE       JA, VERZWEIGEN
         BCT   R2,LOOP2      VERZWEIGEN
         BAL   R14,NXTWTOR   VERZWEIGEN
         B     LOOP2OK       VERZWEIGEN
         EJECT
*
*      SYSPRINT SCHLIESSEN.
*
         SPACE 1
ENDFILE  EQU   *
         L     R0,REG4       MCS-ID DER CONSOLE LADEN
         WTO   MF=(E,MSG06)  NACHRICHTENZEILE AUSGEBEN
         CLC   REPLY,=XL8'0' NOCH KEIN REPLY AUSGEGEBEN ?
         BE    CLOSEPRT      JA, VERZWEIGEN
         MVI   EOF,X'FF'     ENDFILE SPEZIFIZIEREN
         BAL   R14,NXTWTOR   VERZWEIGEN
CLOSEPRT EQU   *
         LA    R1,EDCBADDR   ADRESSE DER DCB-ADRESSE LADEN
         SVC   20            VERZW. ZUM SCHLIESSEN DER DATEI
         B     ABSCHLUS      VERZWEIGEN
         EJECT
***********************************************************************
*                                                                     *
*      NACHRICHTENAUSGABE MIT REPLY.                                  *
*                                                                     *
***********************************************************************
         SPACE 3
NXTWTOR  EQU   *
         XC    ECB,ECB       EVENT CONTROL BLOCK LOESCHEN
         XC    REPLY,REPLY   REPLY LOESCHEN
         L     R0,REG4       MCS-ID DER CONSOLE LADEN
         LA    R2,ECB        ADRESSE DES EVENT CONTROL BLOCK LADEN
         LA    R3,REPLY      ADRESSE DES REPLY LADEN
         MVC   WTO(LENMSG03),MSG03 NACHRICHTENZEILE UEBERTRAGEN
         WTOR  ,(R3),8,(R2),MF=(E,WTO)
         SPACE 1
         WAIT  ECB=ECB
         CLI   REPLY,C'Y'    REPLY = YES ?
         BER   R14           JA, VERZWEIGEN
         CLI   REPLY,C'N'    REPLY = NO ?
         BE    CLOSEPRT      JA, VERZWEIGEN
         CLI   EOF,X'FF'     DATEIENDE ERREICHT ?
         BNE   ZEROZWF       NEIN, VERZWEIGEN
         CLI   REPLY,C'-'    REPLY = LINE COUNT INCR. MIT BEG. VZ. ?
         BNE   CLOSEPRT      NEIN, VERZWEIGEN
         EJECT
***********************************************************************
*                                                                     *
*      ROUTINE FUER REPLY = LINE COUNT INCREMENT.                     *
*                                                                     *
***********************************************************************
         SPACE 3
ZEROZWF  EQU   *
         MVC   ZWFELD,=15C'0' ZWFELD LOESCHEN
         LA    R6,ZWFELD+14  ADRESSE DES LETZTEN BYTES LADEN
         LA    R7,REPLY+7    ADRESSE DES LETZTEN BYTES LADEN
         LA    R8,REPLY      ADRESSE DES REPLY LADEN
         SPACE 2
*
*      PRUEFUNG UND UEBERTRAGUNG EINZELNER BYTES.
*
         SPACE 1
MVCREPLP EQU   *
         CR    R7,R8         ERSTES BYTE DES REPLY ERREICHT ?
         BL    ENDREPLP      VERZW., DA SCHON ALLE BYTES UEBERTR.
         BH    PRFBYTE       NEIN, VERZWEIGEN
         CLI   REPLY,C'+'    REPLY = LINE COUNT INCR. MIT VZ. ?
         BE    ENDREPLP      JA, VERZWEIGEN
         CLI   REPLY,C'-'    REPLY = LINE COUNT INCR. MIT VZ. ?
         BNE   PRFBYTE       NEIN, VERZWEIGEN
         NI    ZWFELD+14,X'DF' NEGATIVES VORZEICHEN SPEZIFIZIEREN
         B     ENDREPLP      VERZWEIGEN
PRFBYTE  EQU   *
         CLI   0(R7),X'00'   ZEICHEN = LEERZEICHEN ?
         BE    SRR7          JA, VERZWEIGEN
         CLI   0(R7),C'0'    ZEICHEN GUELTIG ?
         BL    NXTWTOR       NEIN, VERZWEIGEN
         CLI   0(R7),C'9'    ZEICHEN GUELTIG ?
         BH    NXTWTOR       NEIN, VERZWEIGEN
         MVC   0(1,R6),0(R7) ZEICHEN UEBERTRAGEN
         BCTR  R6,0          ADRESSE DES NAECHSTEN ZEICHENS IN ZWFELD
SRR7     EQU   *
         BCTR  R7,0          ADRESSE DES NAECHSTEN ZEICHENS IN REPLY
         B     MVCREPLP      VERZWEIGEN
         EJECT
*
*      AUFBEREITUNG DES LINE COUNT INCREMENTS.
*
         SPACE 1
ENDREPLP EQU   *
         PACK  DBWORD,ZWFELD LINE COUNT INCR. PACKEN
         CVB   R6,DBWORD     UMWANDELN IN DUALZAHL
         BCTR  R6,0          R6 UM EINS VERMINDERN
         AR    R6,R5         R6 UM LINE COUNT ERHOEHEN
         CR    R6,R5         R6 > R5 ?
         BH    SRCHLOOP      JA, VERZWEIGEN
         LA    R1,EDCBADDR   ADRESSE DER DCB-ADRESSE LADEN
         SVC   20            VERZW. ZUM SCHLIESSEN DER DATEI
         LA    R1,EDCBADDR   ADRESSE DER DCB-ADRESSE LADEN
         SVC   19            VERZW. ZUM OEFFNEN DER DATEI
         MVI   EOF,X'00'     EOF-BYTE LOESCHEN
         SR    R5,R5         LINE COUNT LOESCHEN
         LTR   R6,R6         R6 > 0 ?
         BP    SRCHLOOP      JA, VERZWEIGEN
         SR    R6,R6         R6 LOESCHEN
         B     WTOMSG05      VERZWEIGEN
         SPACE 2
*
*      AUFSUCHEN DES GESUCHTEN SATZES.
*
         SPACE 1
SRCHLOOP EQU   *
         CR    R5,R6         R5 = R6 ?
         BE    LOOP2OK       JA, VERZWEIGEN
         GET   EIN           EINEN SATZ LESEN
         LA    R5,1(R5)      LOOP COUNT ERHOEHEN
         B     SRCHLOOP      VERZWEIGEN
         EJECT
***********************************************************************
*                                                                     *
*      ABSCHLUSSROUTINEN.                                             *
*                                                                     *
***********************************************************************
         SPACE 3
*
*      DEQ-SVC.
*
         SPACE 1
ABSCHLUS EQU   *
         MVC   DEQLIST(12),DEQCLIST PARAMETERLISTE UEBERTRAGEN
         DEQ   ,MF=(E,DEQLIST) DEQ-SVC
         SPACE 2
*
*      SPEICHERPLATZFREIGABE,
*      REINITIALISIERUNG DER REGISTER UND
*      RUECKSPRUNG ZUM AUFRUFENDEN PROGRAMM.
*
         SPACE 1
ENDE     EQU   *
         XRETURN ,R
         EJECT
***********************************************************************
*                                                                     *
*      PRUEFUNG DER BAYPROGM-NACHRICHTEN.                             *
*                                                                     *
***********************************************************************
         SPACE 3
PRUEFTXT EQU   *
         CLC   ETEXT,BLANK   LEERZEILE ?
         BE    LOOP2         JA, VERZWEIGEN
         CLC   ETEXT+41(35),=C'SYSTEM SUPPORT UTILITIES - BAYPROGM'
         BE    LOOP2         JA, VERZWEIGEN
         CLC   EINDSN(18),=C'------------------' UEBERSCHRIFT ?
         BE    LOOP2         JA, VERZWEIGEN
         CLC   EINDSN(4),=C'BAY0' BAYPROGM-NACHRICHT ?
         BNER  R14           NEIN, VERZWEIGEN
         MVC   WTO+8(116),ETEXT+4 BAYPROGM-NACHRICHT UEBERTRAGEN
         L     R0,REG4       MCS-ID DER CONSOLE LADEN
         WTO   MF=(E,WTO)    NACHRICHTENZEILE AUSGEBEN
         MVC   WTO(LENMSG01),MSG01 NACHRICHTENZEILE UEBERTRAGEN
         B     EOFLOOP2      VERZWEIGEN
         EJECT
***********************************************************************
*                                                                     *
*      UEBERTRAGEN DER BAYPROGM-NACHRICHTEN.                          *
*                                                                     *
***********************************************************************
         SPACE 3
MVCETEXT EQU   *
         MVC   WTOTEXT,BLANK AUSGABEZEILE LOESCHEN
         CLC   EINDSN(4),BLANK INFO. UEBER ALLOC O. FREE TRACKS ?
         BE    MVCAFTRK      JA, VERZWEIGEN
         CLC   EINDSN(2),BLANK INFO. UEBER ACTION ?
         BE    MVCHDLN       JA, VERZWEIGEN
         MVC   WTOACT,EINACT ACTION UEBERTRAGEN
         MVC   WTOEXT,EINEXT ANZ. DER EXTENTS UEBERTRAGEN
         MVC   WTODSN,EINDSN DSNAME UEBERTRAGEN
         MVC   WTOTRKS,EINTRKS ANZ. ALLOC. TRACKS UEBERTRAGEN
         MVC   WTOUSED,EINUSED ANZ. USED TRACKS UEBERTRAGEN
         MVC   WTODSORG,EINDSORG DS ORGANISATION UEBERTRAGEN
         B     ENDMVCTX      VERZWEIGEN
         SPACE 1
MVCAFTRK EQU   *
         MVC   WTODSN(40),EINDSN+4 TEXT UEBERTRAGEN
         MVC   WTOTRKS,EINTRKS ANZ. TRACKS UEBERTRAGEN
         B     ENDMVCTX      VERZWEIGEN
         SPACE 1
MVCHDLN  EQU   *
         MVC   WTODSN(42),EINDSN+2 TEXT UEBERTRAGEN
         SPACE 1
ENDMVCTX EQU   *
         CLI   WTOACT,C' '   ACTION ANGEGEBEN ?
         BNER  R14           JA, VERZWEIGEN
         MVI   WTOACT,C'I'   ACTION SPEZIFIZIEREN
         BR    R14           VERZWEIGEN
         EJECT
***********************************************************************
*                                                                     *
*      REGISTER EQUATES.                                              *
*                                                                     *
***********************************************************************
         SPACE 3
R0       EQU   0             MACRO- UND-PARAMETER REGISTER
R1       EQU   1             MACRO- UND-PARAMETER REGISTER
R2       EQU   2             ARBEITSREGISTER
R3       EQU   3             ARBEITSREGISTER
R4       EQU   4             ARBEITSREGISTER
R5       EQU   5             ARBEITSREGISTER
R6       EQU   6             ARBEITSREGISTER
R7       EQU   7             ARBEITSREGISTER
R8       EQU   8             ARBEITSREGISTER
R9       EQU   9             BASISREG. FUER DSECT EINGABE
R10      EQU   10            BASISREG. FUER DSECT AUSGABE
R11      EQU   11            BASISREG. FUER DSECT PARMAREA
R12      EQU   12            BASISREG. FUER CSECT BAY
R13      EQU   13            BASISREG. FUER DSECT ABER
R14      EQU   14            RUECKSPRUNGADRESSEN
R15      EQU   15            CSECT-ADRESSEN UND RETURN CODES
         EJECT
***********************************************************************
*                                                                     *
*      DEFINITION DER KONSTANTEN-SPEICHER.                            *
*                                                                     *
***********************************************************************
         SPACE 3
         DS    0F
PARMADDR DC    AL1(128)
         DC    AL3(PARMINFO)
PARMINFO DC    H'0'
BLANK    DC    120C' '
QNAME    DC    C'XCNTRLVS'
RNAME    DC    C'SYSPRINT'
         SPACE 2
*
*      PARAMETERLISTE FUER ENQ-SVC (UNCONDITIONAL).
*
         SPACE 1
ENQULIST ENQ   (QNAME,RNAME,E,8,SYSTEMS),RET=NONE,MF=L
         SPACE 2
*
*      PARAMETERLISTE FUER ENQ-SVC (TEST).
*
         SPACE 1
ENQTLCON ENQ   (QNAME,RNAME,E,8,SYSTEMS),RET=TEST,MF=L
         EJECT
*
*      PARAMETERLISTE FUER DEQ-SVC.
*
         SPACE 1
DEQCLIST DEQ   (QNAME,RNAME,8,SYSTEMS),MF=L
         SPACE 2
*
*      DCB FUER SYSPRINT.
*
         SPACE 1
PRTDCB   DCB   DDNAME=SYSPRINT,                                        *
               DSORG=PS,                                               *
               MACRF=(GL),                                             *
               RECFM=FBA,                                              *
               LRECL=121,                                              *
               BLKSIZE=1210,                                           *
               EODAD=ENDFILE
EDCBLEN  EQU   *-PRTDCB      LAENGE DES DCB
         SPACE 2
*
*      DCB FUER SYSIN.
*
         SPACE 1
AUSDCB   DCB   DDNAME=SYSIN,                                           *
               DSORG=PS,                                               *
               MACRF=(PL),                                             *
               RECFM=F,                                                *
               LRECL=80,                                               *
               BLKSIZE=80
ADCBLEN  EQU   *-AUSDCB      LAENGE DES DCB
         EJECT
***********************************************************************
*                                                                     *
*      DEFINITION DER AUSGABENACHRICHTEN.                             *
*                                                                     *
***********************************************************************
         SPACE 3
MSG01    WTO   'XBAY00I TRKS USED EX DO ----------------DSNAME---------*
               -------',                                               *
               MF=L,MCSFLAG=(REG0)
LENMSG01 EQU   *-MSG01
         SPACE 1
MSG02    WTO   'XBAY84I INVALID PARAMETER LIST',                       *
               MF=L,MCSFLAG=(REG0)
         SPACE 1
MSG03    WTOR  'XBAY06D REPLY ''Y'' (YES), ''N'' (NO) OR LINE COUNT INC*
               REMENT',                                                *
               MF=L,MCSFLAG=(REG0)
LENMSG03 EQU   *-MSG03
         EJECT
MSG04    WTO   'XBAY07I COMMAND ''BAY'' OR ''AMS'' ACTIVE, WAIT FOR COM*
               PLETION',                                               *
               MF=L,MCSFLAG=(REG0)
         SPACE 1
MSG05    WTO   'XBAY000 TOP OF DATA SET',                              *
               MF=L,MCSFLAG=(REG0)
         SPACE 1
MSG06    WTO   'XBAY000 END OF DATA SET',                              *
               MF=L,MCSFLAG=(REG0)
***********************************************************************
*                                                                     *
*      DEFINITION DER ARBEITSBEREICHE.                                *
*                                                                     *
***********************************************************************
         SPACE 3
ABER     DSECT
SAVEAREA DS    18F           SAVEAREA FUER ALLGEMEINE REGISTER
DBWORD   DS    D             ZWISCHENSPEICHER FUER DEZIMALZAHLEN
ZWFELD   DS    CL15          ZWISCHENSPEICHER FUER DEZIMALZAHLEN
EOF      DS    C             FLAG BYTE FUER DATEIENDE
EDCBADDR DS    F             DCB-ADRESSE FUER SYSPRINT
ADCBADDR DS    F             DCB-ADRESSE FUER SYSIN
EIN      DS    0F            DCB FUER SYPRINT
         ORG   *+EDCBLEN
AUS      DS    0F            DCB FUER SYSIN
         ORG   *+ADCBLEN
REPLY    DS    CL8           BEREICH FUER REPLY
ECB      DS    F             EVENT CONTROL BLOCK
DEQLIST  DS    3F            PARAMETERLISTE FUER DEQ-SVC
         SPACE 2
*
*      PARAMETERLISTE FUER ENQ-SVC (TEST).
*
         SPACE 1
ENQTLIST DS    0F
         DS    CL3
ENQTRC   DS    C             RETURN CODE
         DS    CL8
         SPACE 2
*
*      BEREICH FUER WTO-NACHRICHTEN.
*
         SPACE 1
WTO      DS    0F
         DS    CL10
WTOACT   DS    C             ACTION
         DS    C
WTOTRKS  DS    CL4           NUMBER OF ALLOCATED TRACKS
         DS    C
WTOUSED  DS    CL4           NUMBER OF USED TRACKS
         DS    C
WTOEXT   DS    CL2           NUMBER OF SEPERATE EXTENTS
         DS    C
WTODSORG DS    CL2           DATA SET ORGANISATION
         DS    C
WTODSN   DS    CL44          DATA SET NAME
         ORG   WTO+12
WTOTEXT  DS    CL120         NACHRICHTENTEXT
         SPACE 1
ABERL    EQU   *-ABER        LAENGE DES ARBEITSBEREICHES
         EJECT
*
*      EINGABEBEREICH.
*
         SPACE 1
EINGABE  DSECT
         DS    C             ANSI CONTROL CARACTER
EINDSN   DS    CL48          DATA SET NAME
EINTRKS  DS    CL7           NUMBER OF ALLOCATED TRACKS
EINUSED  DS    CL8           NUMBER OF USED TRACKS
EINEXT   DS    CL6           NUMBER OF SEPERATE EXTENTS
EINDSORG DS    CL21          DATA SET ORGANISATION
EINACT   DS    CL30          ACTION
         ORG   EINGABE+1
ETEXT    DS    CL120         EINGABETEXT
         SPACE 3
*
*      AUSGABEBEREICH.
*
         SPACE 1
AUSGABE  DSECT
AZEILE   DS    CL80          AUSGABEZEILE
         ORG   AUSGABE+1
ATEXT    DS    CL70          AUSGABETEXT
         DS    CL9
         EJECT
*
*      PARAMETERBEREICH.
*
         SPACE 1
PARMAREA DSECT
REG4     DS    F             MCS-ID DER CONSOLE
         DS    CL4           = 'BAY,'
TEXT     DS    CL120
PARMENDE EQU   *
         SPACE 1
         END   BAY
./ ADD  NAME=BAYPROGM
SCR0     TITLE 'MAGNETPLATTENSPEICHER-SCRATCH-PROGRAMM VERSION 1'
         ISEQ  73,80
***********************************************************************
*                                                                     *
*      PROGRAMM-NAME. BAYPROGM.                                       *
*      AUTOR. UNBEKANNT, A. FUCHS, EHNERT.                            *
*      INSTALLATION. BAYER AG,                                        *
*                    5090 LEVERKUSEN-BAYERWERK,                       *
*                    RECHENZENTRUM.                                   *
*      SCHREIBDATUM. SEPTEMBER 1971, MAI 1973, 1975, JUNI 1976.       *
*                                                                     *
*      BEMERKUNGEN.                                                   *
*                                                                     *
*          DAS PROGRAMM 'BAYPROGM' LISTET, LOESCHT UND ENT-           *
*      KATALOGISIERT DATEIEN AUF EXTERNEN SPEICHERN MIT DIREKTEM      *
*      ZUGRIFF (DASD-SPEICHER) ENTSPRECHEND DER SPEZIFIZIERTEN        *
*      PARAMETER (GENAUERES SIEHE PROGRAMMBESCHREIBUNG):              *
*      LIST, LIST=ALL             => LIST                             *
*      LIST=STORAGE               => LIST                             *
*      LIST=PRIVATE               => LIST                             *
*      LIST=PUBLIC                => LIST                             *
*      LIST=<VOLID>               => LIST                             *
*      OLD                        => SCRATCH                          *
*      OLD=<DATUM>                => SCRATCH (<DATUM>: JJTTT)         *
*      ALL                        => SCRATCH                          *
*      SYSDA                      => SCRATCH                          *
*      SYS                        => SCRATCH                          *
*      SCRATCH=<VOLID>            => SCRATCH                          *
*      PURGE=<VOLID>              => SCRATCH (BEDINGUNGSLOS)          *
*      PURGE=(<VOLID>/<DSN>)      => SCRATCH                          *
*      TEST=<VOLID>               => SCRATCH (REPLY 'YES', 'Y')       *
*      INDEX=<DSN BIS 1. PUNKT>   => SCRATCH                          *
*      ANMERKUNG: '*' IN <VOLID> GILT ALS DON'T CARE.                 *
*                                                                     *
*          DIE PARAMETER-EINGABE IST MOEGLICH PER PARM-PARAMETER IN   *
*      DER EXEC-KARTE, UEBER SYSIN UND KONSOL. DIE PARAMETER-STEUERUNG*
*      ERFOLGT DURCH FOLGENDE PARAMETER:                              *
*      PARM      - PARM-PARAMETER BIS STEUERPARAMETER × PARM-ENDE     *
*      SYSIN     - SYSIN-EINGABE BIS STEUERPARAMETER × SYSIN-ENDE     *
*      CON(SOLE) - WTO-REPLY BIS STEUERPARAMETER                      *
*      END       - JOBENDE                                            *
*      DIE STEUERUNG GEHT VOM PARM-PARAMETER AUS; WENN DIESER NICHT   *
*      SPEZIFIZIERT IST, WIRD MIT DER SYSIN-VERARBEITUNG BEGONNEN.    *
*      KONSOL-EINGABE WIRD NUR DURCH DEN STEUERPARAMETER 'CON' IN DER *
*      PARM-PARAMETER-EINGABE ODER DER SYSIN-EINGABE MOEGLICH.        *
*      DIE PARAMETER MUESSEN IM PARM-PARAMETER UND IM WTO-REPLY DURCH *
*      KOMMA GETRENNT SEIN.                                           *
*      DIE SYSIN-PARAMETER KOENNEN VON SPALTE 1 - 71 (KOMMA AUCH      *
*      IN SPALTE 72) GELOCHT SEIN, EINE BESTIMMTE ANFANGSSPALTE IST   *
*      NICHT VORGESCHRIEBEN.                                          *
*          DIE AUSGABE-DD-ANWEISUNGEN HEISSEN SYSPRINT (LISTAUSGABE)  *
*      UND SYSDIAG (DASD-FEHLERPROTOKOLL). HIERFUER GELTEN DIE        *
*      DCB-ANGABEN RECFM=FBA UND LRECL=121.                           *
*          DIE TABELLE DER GESCHUETZTEN 1. INDIZES IM PROGRAMM (SYS1.,*
*      IMS., IMS2., BAYER.) KANN ERWEITERT WERDEN. DAZU IST EINE DATEI*
*      IM FORMAT DER OBEN BESCHRIEBENEN SYSIN-EINGABE ZU ERSTELLEN,   *
*      DIE IN DER DD-ANWEISUNG PARMLIB DEFINIERT SEIN MUSS.           *
*                                                                     *
*          RUECKKEHRKODE, NACHRICHTEN UND FEHLERNACHRICHTEN SIND IM   *
*      FOLGENDEN AUFGEFUEHRT.                                         *
*      RC=0:  BAY001I FUNCTION: <PARAMETER>                           *
*             BAY002D ENTER PARAMETER OR 'END'                        *
*             BAY003D DSN=<DSN>                                       *
*             BAY004I END OF PARAMETER                                *
*             BAY005I PROCESSING COMPLETED - RC=<99>                  *
*                                                                     *
*      RC=4:  BAY041I SYSDIAG NOT SPECIFIED                           *
*             BAY042I WARNING-REPLY NOT 'GO'                          *
*             BAY043I ACTION INVALID - ENTER 'YES', 'NO' OR 'EOT'     *
*                     (BAY003D WIRD WIEDERHOLT)                       *
*                                                                     *
*      RC=8:  BAY081I PARAMETER INVALID: <PARAMETER, BIS 93 STELLEN>  *
*             BAY082I PARMLIB-PARAMETER INVALID: <PRM, BIS 9 STELLEN> *
*             BAY083I TOO MANY PARMLIB-PARAMETERS                     *
*                                                                     *
*      RC=12: BAY121I OBTAIN -RC=<99>                                 *
*             BAY121I SCRATCH-RC=<99>                                 *
*             BAY122I 1. DSCB NOT FORMAT 4                            *
*             BAY123I DSCB-FORMAT NOT 2 × 3 AT EXTENT-OBTAIN          *
*             BAY124I DSCB-5 INCORRECT (SYSDIAG)                      *
*                                                                     *
*      RC=16: BAY161I SYSPRINT NOT SPECIFIED (KONSOL)                 *
*             BAY162I NEITHER PARM-PARAMETER NOR SYSIN SPECIFIED.     *
*             BAY163I PARMLIB NOT SPECIFIED                           *
*                                                                     *
*      BEI DEN RUECKKEHRKODES 4 (BAY042I) UND 8 (BAY081/2I) WIRD DIE  *
*      VERARBEITUNG MIT DEM NAECHSTEN PARAMETER FORTGESETZT, BEI      *
*      RUECKKEHRKODE 16 WIRD DAS PROGRAMM SOFORT BEENDET.             *
*      BEI RUECKKEHRKODE 4 (BAY041I) GEHT DIE VERARBEITUNG WEITER,    *
*      OHNE DASS DIE LISTE SYSDIAG (DASD-SPEICHER MIT FALSCHEM DSCB5) *
*      ERSTELLT WIRD.                                                 *
*      BEI RUECKKEHRKODE 8 (BAY083I) MUSS DIE GROESSE DER TABELLE     *
*      TABRETN2 UEBERPRUEFT WERDEN - DIE UEBERZAEHLIGEN PARMLIB-      *
*      PARAMETER WERDEN IGNORIERT.                                    *
*      BEI RUECKKEHRKODE 12 WIRD VOM NAECHSTMOEGLICHEN AUFSATZPUNKT   *
*      WEITER VERARBEITET:                                            *
*      BAY121I OBTAIN1 - LESEN NAECHSTEN DSCB => DSCB UEBERGANGEN     *
*      BAY121I OBTAIN2, SCRATCH - 'WEITER' => DATEIZEILE FALSCH       *
*      BAY122I - ENDPMWRK (WENN HAEUFIGER VORK. AENDERN FUER NXTVOL)  *
*      BAY123I - 'WEITER' => DATEIZEILE FEHLERHAFT                    *
*      BAY124I - 'WEITER'.                                            *
*                                                                     *
***********************************************************************
         EJECT
BAYPROGM CSECT
         SPACE 3
***********************************************************************
*                                                                     *
*      ZUORDNUNGSTABELLE DER BASIS- UND ALLGEMEINEN REGISTER.         *
*                                                                     *
***********************************************************************
         SPACE 3
R0       EQU   00       OS MAKRO- UND PARAMETERREGISTER
R1       EQU   01       OS MAKRO- UND PARAMETERREGISTER
R2       EQU   02       ARBEITSREGISTER
R3       EQU   03       ARBEITSREGISTER
R4       EQU   04       ARBEITSREGISTER
R5       EQU   05       ARBEITSREGISTER
R6       EQU   06       BASISREGISTER 2 DSECTS
R7       EQU   07       LFD. INDEX TRKLOOP1/2, SCHLFS1
R8       EQU   08       BASISREGISTER 1 DSECTS
R9       EQU   09       BASISREGISTER 1 DES PROGRAMMS
R10      EQU   10       BASISREGISTER 2 DES PROGRAMMS
R11      EQU   11       BASISREGISTER 3 DES PROGRAMMS
R12      EQU   12       BASISREGISTER 4 DES PROGRAMMS
R13      EQU   13       ADRESSE DER JEWEILIGEN AKTUELLEN SAVEAREA
R14      EQU   14       OS LINK- UND RUECKKEHRREGISTER
R15      EQU   15       OS LINK- UND RUECKKEHRREGISTER
         EJECT
***********************************************************************
*                                                                     *
*      INITIALISIERUNGS- UND ABSCHLUSSTEIL.                           *
*                                                                     *
***********************************************************************
         SPACE 3
         SAVE  (14,12),T,*
         LR    R9,R15
         USING BAYPROGM,R9,R10,R11,R12     INITIALISIEREN
         LR    R10,R9                      BASISREGISTER
         AH    R10,KON4096
         LR    R11,R10
         AH    R11,KON4096
         LR    R12,R11
         AH    R12,KON4096
         ST    R13,SAVEAREA+4
         LR    R14,R13                 SAVE-AREA-KETTUNG OS
         LA    R13,SAVEAREA
         ST    R13,8(R14)
         B     ANFANG
         SPACE 1
SAVEAREA DC    18F'0'
KON4096  DC    H'4096'       BASISKONSTANTE
         SPACE 1
ENDE     EQU   *
         PACK  DBLWORD,RC              RC ->
         CVB   R15,DBLWORD                 HEXADEZIMALWERT
         L     13,SAVEAREA+4
         RETURN (14,12),RC=(15)
         EJECT
***********************************************************************
*                                                                     *
*      VORBEREITUNGSROUTINE.                                          *
*                                                                     *
***********************************************************************
         SPACE 3
*
*   PRUEFUNG PARM-PARAMETER VORHANDEN
*
         SPACE 1
ANFANG   EQU   *
         L     R1,0(R1)                ADRESSE PARM-PARAMETER
         ICM   R2,3,0(R1)              PARM-LAENGE = 0
         BZ    PRFSYSIN                JA - PARM-PARAMETER NICHT SPEZ.
         OI    PRMDA,X'01'             NEIN - SETZEN SCHALTER PARM VORH
         ST    R1,PARMADDR             SICHERN ADRESSE PARM-PARAMETER
         SPACE 2
*
*   PRUEFUNG SYSIN-SPEZIFIZIERT
*
         SPACE 1
PRFSYSIN EQU   *
         EXTRACT TIOTADDR,FIELDS=(TIOT)
         L     R8,TIOTADDR             R8 = ADRESSE TIOT
         USING TIOT,R8
         SR    R3,R3
DDSCHLF  EQU   *
         CLI   TIOELNGH,X'00'          TIOT-ENDE
         BE    DROP1R8                 JA
         CLC   TIOEDDNM,=C'SYSIN   '   SYSIN SPEZIFIZIERT
         BE    OPNSYSIN                JA
         IC    R3,TIOELNGH             NAECHSTER
         AR    R8,R3                       DD-ENTRY
         B     DDSCHLF
OPNSYSIN EQU   *
         OI    PRMDA,X'02'             SETZEN SCHALTER SYSIN VORHANDEN
         OPEN  (SYSIN,(INPUT))
DROP1R8  EQU   *
         DROP  R8
         EJECT
*
*   MERKEN TAGESDATUM HEXADEZIMAL
*
         SPACE 1
         TIME  DEC                     => R1 = 00JJTTTF
         LR    R2,R1                   R2 = 00JJTTTF
         SRA   R2,12
         XC    DBLWORD,DBLWORD
         STH   R2,DBLWORD+6            0JJT
         OI    DBLWORD+7,X'0F'         0JJF
         CVB   R2,DBLWORD
         STC   R2,DATE                 => HEXA-JAHR IM 1. BYTE DATE
         STH   R1,DBLWORD+6            TTTF
         CVB   R1,DBLWORD
         STH   R1,DBLWORD+6
         MVC   DATE+1(2),DBLWORD+6     => HEXA-TAG IM 2. BYTE DATE
         SPACE 2
*
*   MERKEN UCB LOOKUP TABLE POINTER
*
         SPACE 1
         GETMAIN R,LV=VEKLEN,SP=125
         ST    R1,UCBLOOKA
         MVI   UCBLOOKA,X'80'
         LA    R1,UCBLOOKA
         LINK  EP=GETUCBS
         L     R1,UCBLOOKA
         MVC   2048(2,R1),=X'FFFF'
         EJECT
*
*   MERKEN JOBNAME UND SYSJJJTT
*
         SPACE 1
         L     R8,TIOTADDR             (AUS EXTRACT)
         USING TIOT,R8                 R8 = ADRESSE TIOT
         MVC   JOBNAME,TIOCNJOB        SPEICHERN JOBNAME
         DROP  R8
         MVC   DBLWORD(3),DATE         HEXA-DATUM
         BAL   14,DATEXC                   DRUCKAUFBEREITEN
         MVC   JOBDATUM+3(2),DBLWORD+6
         MVC   JOBDATUM+5(3),DBLWORD+3
         MVC   ZDATE(2),DBLWORD+6          UND
         MVI   ZDATE+2,C'.'                EINSETZEN
         MVC   ZDATE+3(3),DBLWORD+3        IN UEBERSCHRIFT-1
         SPACE 2
*
*   OPEN SYSOUT
*
         SPACE 1
         OPEN  (SYSOUT,(OUTPUT))
         TM    SYSOUT+48,X'10'         OPEN SYSPRINT ERFOLGREICH
         BO    OPNPLIB                 JA
         WTO   'BAY161I SYSPRINT NOT SPECIFIED',                       *
               ROUTCDE=(1,2,4),DESC=6
         B     FEHLRC16
         EJECT
*
*   OPEN PARMLIB
*
         SPACE 1
OPNPLIB  EQU   *
         OPEN  (PARMLIB,(INPUT))
         TM    PARMLIB+48,X'10'        OPEN PARMLIB ERFOLGREICH
         BO    OPNSFEHL                JA
         MVC   ZLINE+1(29),=C'BAY163I PARMLIB NOT SPECIFIED'
         BAL   14,PRINT                BENUTZEN ZLINE FUER BAY163I
FEHLRC16 EQU   *
         MVC   RC,=C'16'               RC = 16
         B     ENDE                    PROGRAMMABBRUCH
         SPACE 2
*
*   OPEN SYSFEHL
*
         SPACE 1
OPNSFEHL EQU   *
         OPEN  (SYSFEHL,(OUTPUT))
         TM    SYSFEHL+48,X'10'        OPEN SYSFEHL ERFOLGREICH
         BO    SFEHLKPF                JA
         MVI   SFEHLDA,X'00'           LOESCHEN SCHALTER SYSFEHL
         MVC   ZLINE+1(29),=C'BAY041I SYSDIAG NOT SPECIFIED'
         BAL   14,PRINT                BENUTZEN ZLINE FUER BAY041I
         MVC   RC,=C'04'               RC = 4
         B     VRBTABI
SFEHLKPF EQU   *
         PUT   SYSFEHL,XKOPF
         EJECT
VRBTABI  EQU   *
         MVI   ZUSTAND,C'I'            ZUSTAND I SETZEN
NAETBSTZ EQU   *
         GET   PARMLIB,KART0171        LESEN TABSATZ
         OI    PMFLAG,PMLIB
         LA    R2,KART0171             R2 = ADRESSE SATZ INDEX-TABELLE
         LA    R3,71                   R3 = LAENGE TABSATZ
         LA    R4,80                   R4 = AUSGABELAENGE
         LA    R14,NAETBSTZ            RETURN ADDRESS
         B     GETPARM
         SPACE 1
NXTTBENT EQU   *
         BCTR  R1,0                    R1 = PARAMETER-LAENGE - 1
         LA    R3,9                    R3 = MAX. PARAMTERLAENGE
         CR    R1,R3                   PARAMETER > 9 STELLEN
         BL    TPRMPRF2                NEIN
         LA    R1,8                    PARAMETER-LAENGENSCHL. 8 SETZEN
NACHR082 EQU   *
         MVC   PLPRM,BLANKS            BAY082I-PARAMETER LOESCHEN
         EX    R1,MVC1INDF             PARAMETER -> BAY082I
         CLI   ZVORS,C'0'
         BNE   *+8
         MVI   ZVORS,C' '
         MVC   ZLINE+1(107),PLMSG+4
MSG82OUT EQU   *
         BAL   14,PRINT                BEN. ZLINE FUER BAY082I, BAY083I
         MVI   ZVORS,C'0'
         CLC   RC,=C'08'               RC >= 8
         BNL   TSTPMEND                JA
         MVC   RC,=C'08'               NEIN - RC = 8
         B     TSTPMEND
TPRMPRF2 EQU   *
         LA    R5,0(R2,R1)
         CLI   0(R5),C'.'              LETZTES PARAMETER-ZEICHEN = '.'
         BNE   NACHR082                NEIN
         TM    PMFLAG,PMTABEND         FREIE RESERVEN
         BO    TSTPMEND                NEIN
         LM    R3,R4,ADDRRES1          RESERVE-ADRESSEN
         CR    R3,R4                   KEINE RESERVE MEHR
         BNH   TPRMSP                  NOCH RESERVEN VORHANDEN
         OI    PMFLAG,PMTABEND         SIGN. RESERVEN ENDE
         MVC   ZLINE(36),=C'0BAY083I TOO MANY PARMLIB-PARAMETERS'
         B     MSG82OUT
         EJECT
TPRMSP   EQU   *
         STC   R1,0(R3)                LAENGENSCHL. -> TABRETN2
         EX    R1,MVC1INDT             PARAMETER -> TABRETN2
         LA    R3,10(,R3)              ERHOEHEN DISPL. TABRETN2
         ST    R3,ADDRRES1             WEGSPEICHERN ADR. NAE. RESERVE
         B     TSTPMEND
TABIENDE EQU   *                       DATEIENDE PARMLIB-TABELLE
         TM    PMFLAG,PMLIB
         BZ    *+10
         ZAP   LINENO,=P'80'           SETZEN SEITENWECHSEL
         CLOSE (PARMLIB)
         EJECT
***********************************************************************
*                                                                     *
*      HAUPTPROGRAMM UND ABSCHLUSS.                                   *
*                                                                     *
***********************************************************************
         SPACE 3
*
*   ANFANG PARM-PARAMETER
*
         SPACE 1
VRBPARM  EQU   *
         TM    PRMDA,X'01'             PARM-PARAMETER VORHANDEN
         BNO   VRBSYSIN                NEIN
         MVI   ZUSTAND,C'P'            ZUSTAND P SETZEN
         L     R2,PARMADDR             R2 = ADRESSE PARM-PARAMETER
         LH    R3,0(,R2)               R3 = LAENGE PARM-PARAMETER
         LA    R2,2(,R2)               R2 = ADRESSE PARAMETERLISTE
         LA    R4,100                  MAX. AUSGABELAENGE
         CR    R3,R4                   PARM-LAENGE < AUSGABELAENGE
         BNL   *+6                     NEIN
         LR    R4,R3                   JA
         LA    R14,PRMENDE             RETURN ADDRESS
         B     GETPARM
         SPACE 2
*
*   ANFANG SYSIN
*
         SPACE 1
VRBSYSIN EQU   *
         TM    PRMDA,X'02'             SYSIN SPEZIFIZIERT
         BZ    NOPARMS                 NEIN
         MVI   ZUSTAND,C'S'            ZUSTAND S SETZEN
NAEKARTE EQU   *
         GET   SYSIN,KART0171          LESEN SYSIN-KARTE
         LA    R2,KART0171             R2 = ADRESSE SYSIN-KARTE
         LA    R3,71                   R3 = LAENGE SYSIN-KARTE
         LA    R4,80                   R4 = AUSGABELAENGE
         LA    R14,NAEKARTE            RETURN ADDRESS
         B     GETPARM
NOPARMS  EQU   *
         MVC   ZLINE+1(50),=C'BAY162I NEITHER PARM-PARAMETER NOR SYSIN *
               SPECIFIED'
         LA    R14,FEHLRC16            RETURN ADDRESS
         B     PRINT
         EJECT
*
*   PARAMETER AUS KONSOL-EINGABE
*
         SPACE 1
VRBCON   EQU   *
         XC    WTORECB,WTORECB
         MVC   ANTWORT,BLANKS          LOESCHEN REPLY-BEREICH
         WTOR  'BAY002D ENTER PARAMETER OR ''END''',ANTWORT,115,       *
               WTORECB,ROUTCDE=(1,2,4),DESC=6
         WAIT  ECB=WTORECB
         OI    PRMDA,X'04'             SETZEN SCHALTER JOBENDE-ZEILE
         OC    ANTWORT,BLANKS          -> GROSSBUCHSTABEN
         LA    R2,ANTWORT              R2 = ADRESSE KONSOL-EINGABE
         LA    R3,115                  R3 = LAENGE KONSOL-EINGABE
         LA    R4,100                  R4 = MAX. AUSGABELAENGE
         LA    R14,VRBCON              RETURN ADDRESS
         B     GETPARM
         EJECT
*
*   ABARBEITEN PARAMETERKETTE
*
         SPACE 1
GETPARM  EQU   *
         ST    R14,PMRETADR            SICHERN RETURN ADDRESS
         STM   R2,R4,PMSTAADR          SICHERN PARM-ADR. UND LAENGEN
         BAL   R14,PUTPARM
         CLI   0(R2),C'*'              KOMMENTAR
         BE    PMRETURN                JA
         L     R3,PMWRKLEN             R3 = LAENGE DER PARAMETERKETTE
FND1PARM EQU   *
         CLI   0(R2),C' '              SUCHEN 1. ZEICHEN UNGLEICH BLANK
         BNE   FRSTPARM                GEFUNDEN
         LA    R2,1(,R2)               NAECHSTES ZEICHEN
         BCT   R3,FND1PARM             NICHT GEFUNDEN
         B     PMRETURN
FRSTPARM EQU   *
         OI    PMFLAG,PM1PARM          SETZEN BIT FUER GEFUNDEN
NEXTPARM EQU   *
         STM   R2,R3,PMSTAADR          SICHERN PARM-ADR. UND LAENGE
         LR    R5,R2                   R5 = ADRESSE PARAMETERKETTE
         LR    R4,R3                   R4 = LAENGE PARAMETERKETTE
         BCTR  R4,0                    R4 = LAENGENSCHLUESSEL TRT
         EX    R4,TRTKOMMA             SUCHEN KOMMA ODER BLANK
         BNZ   GETPMLEN                GEFUNDEN
         IC    R2,BLANKS               ANZEIGEN ENDE DER PARM-KETTE
         LA    R1,0(R3,R5)             R1 = ADR. DES KETTEN-ENDES
GETPMLEN EQU   *
         STC   R2,PMFDCHAR             GEFUNDENES ZEICHEN AUS TABKOMMA
         SR    R1,R5                   R1 = LAENGE PARAMETER
         ST    R1,PMOUTLEN             SICHERN PARAMETER-LAENGE
         BZ    TSTPMEND                DUMMY PARAMETER
         L     R2,PMSTAADR             R2 = ADRESSE PARAMETER
         CLI   ZUSTAND,C'I'            PARMLIB-PARAMETER
         BE    NXTTBENT                JA
         NI    PMFLAG,PMN1PARM         LOESCHEN ANZEIGE
         L     R1,PMOUTLEN             R1 = LAENGE PARAMETER
         EJECT
*
*   AUSWERTEN VORGELEGTEN PARAMETER (R1 - LAENGE, R2 - ADRESSE)
*
         SPACE 1
PRMAUSW  EQU   *
         USING UCB,R8                  R8 = UCB-ADR. (INIT. IN NXTVOL)
         MVC   UCBLOOK,UCBLOOKA        INIT. UCB LOOKUP TABLE POINTER
         SPACE 1
*   DROP R8 IN DEVICEOK (SRTESTAB, SRTEVOLI BZW. UCBNAME WERDEN FUER
*   JEDE FUNKTION ZWISCHEN CALL-NXTVOL UND CALL-DEVICEOK BENUTZT).
*   BEI UCB-ENDE NEUINITIALISIERUNG R8 IN NXTVOL.
         SPACE 1
         MVC   DISPLBYT,0(R2)          1. ZEICHEN PARAMETER
         TR    DISPLBYT,TABCHAR
         CLI   DISPLBYT,X'FF'          BEGINNT PRM MIT VORGES. BUCHST.
         BE    PRMUNGLT                NEIN
         SR    R3,R3
         IC    R3,DISPLBYT
         B     BMARKE(R3)
         SPACE 1
ENDPMWRK EQU   *
         BAL   R14,VOLFUSS
         MVC   ZLINE(24),=C'0BAY004I END OF FUNCTION'
         BAL   R14,PRINT
         ZAP   LINENO,=P'80'           SETZEN SEITENWECHSEL
TSTPMEND EQU   *
         CLI   PMFDCHAR,C' '           ENDE PARAMETERKETTE
         BE    PMRETURN                JA
         LM    R2,R4,PMSTAADR          LADEN PARM-ADRESSE U. LAENGEN
         LA    R4,1(,R4)               PARM-LAENGE + LAENGE TRENNZ.
         AR    R2,R4                   ADRESSE NAECHSTER PARAMETER
         SR    R3,R4                   MAX. LAENGE DER PARAMETERKETTE
         BP    NEXTPARM                VERARB. NAECHSTEN PARAMETER
PMRETURN EQU   *
         L     R14,PMRETADR            LADEN RETURN ADDRESS
         BR    R14                     RETURN
         EJECT
PRMUNGLT EQU   *
         MVC   UNPRM,BLANKS            LOESCHEN AUF BLANKS
         CH    R1,=H'93'               PARAMETER-LAENGE > 93
         BNH   BERECHNL                NEIN
         LH    R3,=H'92'               => PARAMETER-LAENGE = 93
         B     MOVEPRM
BERECHNL EQU   *
         LR    R3,R1                   LAENGENSCHLUESSEL
         BCTR  R3,0                        MVC
MOVEPRM  EQU   *
         EX    R3,MVCPRM2              EINTRAGEN PARAMETER IN BAY081I
         MVC   ZLINE+1(120),UNMSG+4    BENUTZEN ZLINE FUER
         CLI   ZVORS,C'0'
         BNE   *+8
         MVI   ZVORS,C' '
         BAL   14,PRINT                   BAY081I
         MVI   ZVORS,C'0'
         CLI   ZUSTAND,C'C'            ZUSTAND = C (CON)
         BNE   SETZRC08                NEIN
         LA    R1,UNMSG                KONSOL-AUSGABE
         WTO   MF=(E,(R1))                 BAY081I
SETZRC08 EQU   *
         CLC   RC,=C'08'               RC >= 8
         BNL   TSTPMEND                JA
         MVC   RC,=C'08'               NEIN - RC = 8
         B     TSTPMEND
BMARKE   EQU   *
         B     MARKEA
         B     MARKEC
         B     MARKED
         B     MARKEE
         B     MARKEI
         B     MARKEL
         B     MARKEO
         B     MARKEP
         B     MARKES
         B     MARKET
         B     MARKEU
         EJECT
*
*   AUSGABE DER PARAMETER-KETTE UND EINZELNER PARAMETER
*
         SPACE 1
PUTPARM  EQU   *
         ST    R14,PMRETAD1
         MVC   ZLINE+1(120),BLANKS
         L     R2,PMSTAADR
         L     R3,PMOUTLEN
         BCTR  R3,0
         EX    R3,PMMVCOUT
         BAL   R14,PRINT
         MVC   ZLINE,BLANKS
         L     R14,PMRETAD1
         BR    R14
         SPACE 1
PMMVCOUT MVC   ZLINE+9(0),0(R2)
         SPACE 1
PRMENDE  EQU   *
         MVI   ZUSTAND,C'E'
         B     ENDJOB
         EJECT
*
*   PARAMETER BEGINNT MIT A
*
         SPACE 1
MARKEA   EQU   *
         CLC   0(3,R2),=C'ALL'         PARAMETER = 'ALL'
         BNE   PRMUNGLT                NEIN
         CH    R1,=H'3'                LAENGE = 3
         BNE   PRMUNGLT                NEIN
         SPACE 1
*   PARAMETER = 'ALL'
         SPACE 1
         BAL   14,EDTPLINE             AUSGEBEN BAY001I AUF NEUER SEITE
         BAL   14,WARNING              KONSOL-WARNUNG
ANXTVOL  EQU   *
         BAL   14,NXTVOL               NAECHSTE EINHEIT WIRD VORGELEGT
         CLC   UCBADDR+2(2),=X'FFFF'   UCB-ENDE
         BE    ENDPMWRK                JA
         TM    SRTESTAB,X'08'          PUBLIC VOLUME
         BNO   ANXTVOL                 NEIN
         CLI   SRTEVOLI,C'0'           WORK VOLUME
         BL    ANXTVOL                 NEIN
         BAL   14,DEVICEOK             VOL-AUSGANGSBEDINGUNGEN
ANXTDSCB EQU   *
         BAL   14,NXTDSCB              NAECHSTER DSCB 1 WIRD VORGELEGT,
*                                          DSCB 4, 5 WERDEN AUSGEWERTET
         CLI   DSCBENDE,X'01'          DSCB-ENDE
         BE    ANXTVOL                 JA
         BAL   14,VRBDSCB1             AUSWERTEN DSCB 1
         CLI   RETAINSW,X'01'          DATEI GESCHUETZT
         BE    ANXTDSCB                JA
         BAL   14,SCRATCH              AUSGEBEN DATEIZ., LOESCHEN DATEI
         B     ANXTDSCB                NAECHSTER DSCB
         EJECT
*
*   PARAMETER BEGINNT MIT C
*
         SPACE 1
MARKEC   EQU   *
         CH    R1,=H'3'                LAENGE = 3
         BE    PCON                    JA - PRUEFUNG AUF 'CON'
         CH    R1,=H'7'                LAENGE = 7
         BE    PCONSOLE                JA - PRUEFUNG AUF 'CONSOLE'
         B     PRMUNGLT                LAENGE WEDER 3 NOCH 7
PCON     EQU   *
         CLC   0(3,R2),=C'CON'         PARAMETER = 'CON'
         BE    SZTDCON                 JA
         B     PRMUNGLT                NEIN
PCONSOLE EQU   *
         CLC   0(7,R2),=C'CONSOLE'     PARAMETER = 'CONSOLE'
         BNE   PRMUNGLT                NEIN
         SPACE 1
*   PARAMETER = 'CON(SOLE)'
         SPACE 1
SZTDCON  EQU   *
         MVI   ZUSTAND,C'C'            ZUSTAND C
         B     VRBCON
         EJECT
*
*   PARAMETER BEGINNT MIT D
*
         SPACE 1
MARKED   EQU   *
         CLC   0(4,R2),=C'DAY='        PARAMETER BEGINNT MIT 'DAY='
         BNE   PRMUNGLT                NEIN
         CH    R1,=H'9'                LAENGE = 9
         BNE   PRMUNGLT                NEIN
         MVC   DBLWORD(5),4(R2)        WEGSPEICHERN
         BAL   14,DATECX                   DATE
         MVC   SPEZDATE,DBLWORD            DAY-PRM
         SPACE 1
*   PARAMETER = 'DAY='
         SPACE 1
         BAL   14,EDTPLINE             AUSGEBEN BAY001I AUF NEUER SEITE
DNXTVOL  EQU   *
         BAL   14,NXTVOL               NAECHSTE EINHEIT WIRD VORGELEGT
         CLC   UCBADDR+2(2),=X'FFFF'   UCB-ENDE
         BE    ENDPMWRK                JA - SPEZ VOL NICHT GEFUNDEN
         TM    SRTESTAB,X'08'          PUBLIC VOLUME
         BNO   DNXTVOL                 NEIN
         BAL   14,DEVICEOK             VOL-AUSGANGSBEDINGUNGEN
DNXTDSCB EQU   *
         BAL   14,NXTDSCB              NAECHSTER DSCB 1 WIRD VORGELEGT,
*                                          DSCB 4, 5 WERDEN AUSGEWERTET
         CLI   DSCBENDE,X'01'          DSCB-ENDE
         BE    DNXTVOL                 JA
         CLC   DS1CREDT,SPEZDATE       VGL. ERSTELLDATUM / PRM-WERT
         BE    DSCRATCH                GLEICH
         BAL   14,GETTRKS              ERSTELLEN LINETRKS, LINEEXTS
         MVC   ZACTION,=C'NONE   '     DRUCKAUFBEREITEN
         BAL   14,EDTZLINE                 UND AUSGEBEN
         BAL   14,PRINT                    DATEIZEILE
         B     DNXTDSCB                NAECHSTER DSCB
DSCRATCH EQU   *
         BAL   14,VRBDSCB1             AUSWERTEN DSCB 1
         CLI   RETAINSW,X'01'          DATEI GESCHUETZT
         BE    DNXTDSCB                JA
         BAL   14,SCRATCH              AUSGEBEN DATEIZ., LOESCHEN DATEI
         B     DNXTDSCB                NAECHSTER DSCB
         EJECT
*
*   PARAMETER BEGINNT MIT E
*
         SPACE 1
MARKEE   EQU   *
         CLC   0(3,R2),=C'END'         PARAMETER = 'END'
         BNE   PRMUNGLT                NEIN
         CH    R1,=H'3'                LAENGE = 3
         BNE   PRMUNGLT                NEIN
         SPACE 1
*   PARAMETER = 'END'
         SPACE 1
         MVI   ZUSTAND,C'E'            ZUSTAND E
         B     ENDJOB
         EJECT
*
*   PARAMETER BEGINNT MIT I
*
         SPACE 1
MARKEI   EQU   *
         CLC   0(6,R2),=C'INDEX='      PARAMETER BEGINNT MIT 'INDEX='
         BNE   PRMUNGLT                NEIN
         CH    R1,=H'7'                LAENGE < 7
         BL    PRMUNGLT                JA
         CH    R1,=H'14'               LAENGE > 14
         BH    PRMUNGLT                JA
         MVC   INDEXNM,BLANKS          LOESCHEN INDEXNM AUF BLANKS
         LR    R3,R1                   LAENGE PARAMETER
         SH    R3,=H'7'                    - 7 => LAENGENSCHL. INDEXNM
         STH   R3,INDEXLNG             WEGSPEICHERN
         EX    R3,MVCINDNM             UEBERTRAGEN INDEX
         LA    R4,INDEXNM              R4 = ADRESSE INDEXNM
         LA    R4,1(R4,R3)                 + INDEXLNG + 1
         MVI   0(R4),C'.'              PUNKT NACH INDEX
         SPACE 1
*   PARAMETER = 'INDEX=<DSN BIS ZUM 1. PUNKT>'
         SPACE 1
         BAL   14,EDTPLINE             AUSGEBEN BAY001I AUF NEUER SEITE
         BAL   14,WARNING              KONSOL-WARNUNG
INXTVOL  EQU   *
         BAL   14,NXTVOL               NAECHSTE EINHEIT WIRD VORGELEGT
         CLC   UCBADDR+2(2),=X'FFFF'   UCB-ENDE
         BE    ENDPMWRK                JA
         BAL   14,DEVICEOK             VOL-AUSGANGSBEDINGUNGEN
INXTDSCB EQU   *
         BAL   14,NXTDSCB              NAECHSTER DSCB 1 WIRD VORGELEGT,
*                                          DSCB 4, 5 WERDEN AUSGEWERTET
         CLI   DSCBENDE,X'01'          DSCB-ENDE
         BE    INXTVOL                 JA
         LH    R3,INDEXLNG             LAENGENSCHLUESSEL INDEXNM
         LA    R3,1(R3)                    EINSCHLIESSLICH PUNKT
         EX    R3,CLCINDNM             SOLL DATEI GELOESCHT WERDEN
         BE    ISCRATCH                JA
         BAL   14,GETTRKS              ERSTELLEN LINETRKS, LINEEXTS
         MVC   ZACTION,=C'NONE   '     DRUCKAUFBEREITEN
         BAL   14,EDTZLINE                 UND AUSGEBEN
         BAL   14,PRINT                    DATEIZEILE
         B     INXTDSCB                NAECHSTER DSCB
ISCRATCH EQU   *
         BAL   14,VRBDSCB1             AUSWERTEN DSCB 1
         CLI   RETAINSW,X'01'          DATEI GESCHUETZT
         BE    INXTDSCB                JA
         BAL   14,SCRATCH              AUSGEBEN DATEIZ., LOESCHEN DATEI
         B     INXTDSCB                NAECHSTER DSCB
         EJECT
*
*   PARAMETER BEGINNT MIT L
*
         SPACE 1
MARKEL   EQU   *
         CLC   0(4,R2),=C'LIST'        PARAMETER BEGINNT MIT 'LIST'
         BNE   PRMUNGLT                NEIN
         CH    R1,=H'4'                LAENGE = 4
         BH    LLNGEG4                 LAENGE IST GROESSER 4
LISTX01  EQU   *
         MVI   LISTPRM,X'01'           LAENGE IST 4 - PARAMETER 'LIST'
         B     PRMLIST
LLNGEG4  EQU   *
         CH    R1,=H'8'                LAENGE = 8
         BNE   LLNGEG8                 NEIN
         CLC   4(4,R2),=C'=ALL'        PARAMETER 'LIST=ALL'
         BE    LISTX01                 JA
         BNE   PRMUNGLT                NEIN
LLNGEG8  EQU   *
         CH    R1,=H'11'               LAENGE = 11
         BNE   LLNGEG11                NEIN
         CLC   4(7,R2),=C'=PUBLIC'     PARAMETER 'LIST=PUBLIC'
         BNE   LISTX02                 NEIN
         MVI   LISTPRM,X'08'           JA
         B     PRMLIST
LISTX02  EQU   *
         MVI   LISTPRM,X'02'           PARAMETER 'LIST=<VOLID>'
         MVC   SPEZVOL,5(R2)           WEGSPEICHERN VOLID LIST-PRM
         B     PRMLIST
LLNGEG11 EQU   *
         CH    R1,=H'12'               LAENGE = 12
         BNE   PRMUNGLT                LAENGE NICHT 4, 8, 11, 12
         CLC   4(8,R2),=C'=STORAGE'    PARAMETER 'LIST=STORAGE'
         BNE   PRFLPRIV                NEIN
         MVI   LISTPRM,X'04'
         B     PRMLIST
PRFLPRIV EQU   *
         CLC   4(8,R2),=C'=PRIVATE'    PARAMETER 'LIST=PRIVATE'
         BNE   PRMUNGLT                NEIN
         MVI   LISTPRM,X'10'           JA
         EJECT
*   PARAMETER = 'LIST'
         SPACE 1
PRMLIST  EQU   *
         BAL   14,EDTPLINE             AUSGEBEN BAY001I AUF NEUER SEITE
         OI    LISTSW1+1,X'F0'         (LISTSW1: B)
         NI    LISTSW2+1,X'0F'         (LISTSW2: NOP)
LNXTVOL  EQU   *
         BAL   14,NXTVOL               NAECHSTE EINHEIT WIRD VORGELEGT
         CLC   UCBADDR+2(2),=X'FFFF'   UCB-ENDE
         BE    LUCBENDE                JA
         CLI   LISTPRM,X'01'           LIST × LIST=ALL
         BE    LBALDVO1                JA
         CLI   LISTPRM,X'02'           LIST=<VOLID>
         BE    LPRFVOL                 JA
         IC    R3,LISTPRM              MASKE STORAGE × PUBLIC × PRIVATE
         EX    R3,TMSTATUS             PRUEFEN AUF GEFORDERTEN STATUS
         BZ    LNXTVOL                 LIEGT NICHT VOR
         B     LBALDVOK
LPRFVOL  EQU   *
         BAL   14,PRFVOLID             PRUEFEN SPEZIFIZIERTES VOLID
         LTR   R15,R15                 LIEGT SPEZ. VOLID VOR
         BP    LNXTVOL                 NEIN
LBALDVOK EQU   *
         BAL   14,DEVICEOK             VOL-AUSGANGSBEDINGUNGEN
LNXTDSCB EQU   *
         BAL   14,NXTDSCB              NAECHSTER DSCB 1 WIRD VORGELEGT,
*                                          DSCB 4, 5 WERDEN AUSGEWERTET
         CLI   DSCBENDE,X'01'          DSCB-ENDE
         BE    LNXTVOL                 JA
         BAL   14,VRBDSCB1             AUSWERTEN DSCB 1
         B     LNXTDSCB                BEI LIST IMMER RETAIN
LUCBENDE EQU   *
         NI    LISTSW1+1,X'0F'         (-> NOP RETAIN5, S. VRBDSCB1)
         OI    LISTSW2+1,X'F0'         (-> B ACTIONOK, S. VRBDSCB1)
         B     ENDPMWRK                NAECHSTER PARAMETER
         SPACE 1
*   NICHT UNTER EX-MARKEN, DA R8 BASISREGISTER
TMSTATUS TM    SRTESTAB,X'00'          VERGLEICHEN LIST-PARAMETER-
*                                          -STATUS MIT VOLUME-STATUS
LBALDVO1 EQU   *
         TM    UCB+17,X'08'            VIRTUAL DEVICE ?
         BO    LUCBENDE                JA
         B     LBALDVOK                NEIN
         EJECT
*
*   PARAMETER BEGINNT MIT O
*
         SPACE 1
MARKEO   EQU   *
         CLC   0(3,R2),=C'OLD'         PARAMETER BEGINNT MIT 'OLD'
         BNE   PRMUNGLT                NEIN
         CH    R1,=H'3'                LAENGE = 3
         BNE   OLNGEG3                 JA
         ICM   R3,7,DATE               MOVE DATE
         BCTR  R3,0                        OF
         STCM  R3,7,SPEZDATE               YESTERDAY
         B     PRMOLD
OLNGEG3  EQU   *
         CH    R1,=H'9'                LAENGE = 9
         BNE   PRMUNGLT                NEIN
         MVC   DBLWORD(5),4(R2)        WEGSPEICHERN
         BAL   14,DATECX                   DATE
         MVC   SPEZDATE,DBLWORD            OLD-PRM
         SPACE 1
*   PARAMETER = 'OLD'
         SPACE 1
PRMOLD   EQU   *
         BAL   14,EDTPLINE             AUSGEBEN BAY001I AUF NEUER SEITE
         OI    OLDSW+1,X'F0'           (OLDSW: B)
ONXTVOL  EQU   *
         BAL   14,NXTVOL               NAECHSTE EINHEIT WIRD VORGELEGT
         CLC   UCBADDR+2(2),=X'FFFF'   UCB-ENDE
         BE    OUCBENDE                JA
         TM    SRTESTAB,X'08'          PUBLIC VOLUME
         BNO   ONXTVOL                 NEIN
         CLI   SRTEVOLI,C'0'           WORK VOLUME
         BL    ONXTVOL                 NEIN
         BAL   14,DEVICEOK             VOL-AUSGANGSBEDINGUNGEN
ONXTDSCB EQU   *
         BAL   14,NXTDSCB              NAECHSTER DSCB 1 WIRD VORGELEGT,
*                                          DSCB 4, 5 WERDEN AUSGEWERTET
         CLI   DSCBENDE,X'01'          DSCB-ENDE
         BE    ONXTVOL                 JA
         CLC   DS1CREDT,SPEZDATE       VGL. ERSTELLDATUM / PRM-WERT
         BL    OSCRATCH                ERSTELLDATUM KLEINER
         BAL   14,GETTRKS              ERSTELLEN LINETRKS, LINEEXTS
         MVC   ZACTION,=C'NONE    '    DRUCKAUFBEREITEN
         BAL   14,EDTZLINE                 UND AUSGEBEN
         BAL   14,PRINT                    DATEIZEILE
         B     ONXTDSCB                NAECHSTER DSCB
OSCRATCH EQU   *
         BAL   14,VRBDSCB1             AUSWERTEN DSCB 1
         CLI   RETAINSW,X'01'          DATEI GESCHUETZT
         BE    ONXTDSCB                JA
         BAL   14,SCRATCH              AUSGEBEN DATEIZ., LOESCHEN DATEI
         B     ONXTDSCB                NAECHSTER DSCB
OUCBENDE EQU   *
         NI    OLDSW+1,X'0F'           (-> NOP, S. VRBDSCB1)
         B     ENDPMWRK
         EJECT
*
*   PARAMETER BEGINNT MIT P (ZWEIDEUTIG)
*
         SPACE 1
MARKEP   EQU   *
         CH    R1,=H'4'                LAENGE = 4
         BNE   PRFPRGE                 NEIN
         CLC   0(4,R2),=C'PARM'        PARAMETER = 'PARM'
         BNE   PRMUNGLT                NEIN
         SPACE 1
*** PARAMETER = 'PARM'
         SPACE 1
         TM    PRMDA,X'01'             PARM-PARAMETER VORHANDEN
         BNO   PRMUNGLT                NEIN
         MVI   ZUSTAND,C'P'            ZUSTAND P
         B     VRBPARM
         SPACE 1
*   PRUEFEN AUF 'PURGE'
         SPACE 1
PRFPRGE  EQU   *
         CLC   0(6,R2),=C'PURGE='
         BNE   PRMUNGLT                PARAMETER UNGUELTIG
         CH    R1,=H'12'               LAENGE = 12
         BNE   PRGFMT2A                NEIN - PURGE-FORMAT 2
         MVC   SPEZVOL,6(R2)           WEGSPEICHERN VOLID FORMAT 1
         MVI   SPEZDSN,X'00'           SPEZDSN-KENNZ. FORMAT 1
         B     PURGEANF
PRGFMT2A EQU   *
         CLI   6(R2),C'('              PURGE-FORMAT 2 - 7. ZEICH. = '('
         BNE   PRMUNGLT                NEIN
         CLI   13(R2),C'/'             14. ZEICHEN PRM = '/'
         BNE   PRMUNGLT                NEIN
         CH    R1,=H'59'               LAENGE > 59
         BH    PRMUNGLT                JA
         MVC   SPEZDSN,BLANKS          LOESCHEN SPEZDSN
         LR    R3,R1                   LAENGE PARAMETER
         SH    R3,=H'16'                   - 16 => LAENGENSCHL. DSN
         EX    R3,MVCDSN               UEBERTRAGEN DSN AUS PRM
         LA    R4,0(R1,R2)             R4 = R1 + R2
         BCTR  R4,0                        - 1
         CLI   0(R4),C')'              LETZTES ZEICHEN KLAMMER-ZU
         BNE   PRMUNGLT                NEIN
         MVC   SPEZVOL,7(R2)           WEGSPEICHERN VOLID FORMAT 2
         EJECT
*   PARAMETER = 'PURGE='
         SPACE 1
PURGEANF EQU   *
         BAL   14,EDTPLINE             AUSGEBEN BAY001I AUF NEUER SEITE
PNXTVOL  EQU   *
         BAL   14,NXTVOL               NAECHSTE EINHEIT WIRD VORGELEGT
         CLC   UCBADDR+2(2),=X'FFFF'   UCB-ENDE
         BE    ENDPMWRK                JA - SPEZ VOL NICHT GEFUNDEN
         BAL   14,PRFVOLID             PRUEFEN SPEZIFIZIERTES VOLID
         LTR   R15,R15                 LIEGT SPEZ. VOLID VOR
         BP    PNXTVOL                 NEIN
         BAL   14,DEVICEOK             VOL-AUSGANGSBEDINGUNGEN
PNXTDSCB EQU   *
         BAL   14,NXTDSCB              NAECHSTER DSCB 1 WIRD VORGELEGT,
*                                          DSCB 4, 5 WERDEN AUSGEWERTET
         CLI   DSCBENDE,X'01'          DSCB-ENDE
         BE    ENDPMWRK                JA - NAECHSTER PARAMETER
         BAL   14,GETTRKS              ERSTELLEN LINETRKS, LINEEXTS
         CLI   SPEZDSN,X'00'           PURGE-FORMAT 1
         BNE   PRGFMT2B                NEIN
         CLC   DS1DSNAM+23(5),JOBNAME  JOBNAME MUST BE GREATER THAN 4
*                                          VERGLEICH JOBNAME ST. 1-5
         BNE   PSCRATCH                UNGLEICH
         CLC   DS1DSNAM(8),JOBDATUM    VERGLEICH SYS<JJTTT>
         BNE   PSCRATCH                UNGLEICH
         MVC   ZREASON,=C'ACTIVE &&&&DATASET    '
         MVC   ZACTION,=C'NONE   '
         B     PDATEIZL
PRGFMT2B EQU   *
         CLC   SPEZDSN,DS1DSNAM        DSCB 1 ZU SPEZ. DSNAME
         BE    PSCRATCH                JA
         MVC   ZACTION,=C'NONE   '     DRUCKAUFBEREITEN
PDATEIZL EQU   *
         BAL   14,EDTZLINE                 UND AUSGEBEN
         BAL   14,PRINT                    DATEIZEILE
         B     PNXTDSCB                NAECHSTER DSCB
PSCRATCH EQU   *
         BAL   14,SCRATCH              AUSGEBEN DATEIZ., LOESCHEN DATEI
         B     PNXTDSCB                NAECHSTER DSCB
         EJECT
*
*   PARAMETER BEGINNT MIT S (VIERDEUTIG)
*
         SPACE 1
MARKES   EQU   *
         CLC   0(5,R2),=C'SYSIN'       PARAMETER = 'SYSIN'
         BNE   PRFSCR                  NEIN
         CH    R1,=H'5'                LAENGE = 5
         BNE   PRMUNGLT                NEIN
         SPACE 1
*** PARAMETER = 'SYSIN'
         SPACE 1
         TM    PRMDA,X'02'             SYSIN SPEZIFIZIERT
         BNO   PRMUNGLT                NEIN
         MVI   ZUSTAND,C'S'            ZUSTAND S
         B     VRBSYSIN
         SPACE 1
*   PRUEFEN AUF 'SCRATCH'
         SPACE 1
PRFSCR   EQU   *
         CLC   0(8,R2),=C'SCRATCH='    PARAMETER BEGINNT MIT 'SCRATCH='
         BNE   PRFSYSDA                NEIN
         CH    R1,=H'14'               LAENGE = 14
         BNE   PRMUNGLT                NEIN
         MVC   SPEZVOL,8(R2)           WEGSPEICHERN VOLID
         SPACE 1
*** PARAMETER = 'SCRATCH=<VOLID>'
         SPACE 1
         BAL   14,EDTPLINE             AUSGEBEN BAY001I AUF NEUER SEITE
         OI    VOLSW+1,X'F0'           (VOLSW: B)
VNXTVOL  EQU   *
         BAL   14,NXTVOL               NAECHSTE EINHEIT WIRD VORGELEGT
         CLC   UCBADDR+2(2),=X'FFFF'   UCB-ENDE
         BE    VPRMEND                 JA - SPEZ. VOL NICHT GEFUNDEN
         BAL   14,PRFVOLID             PRUEFEN SPEZIFIZIERTES VOLID
         LTR   R15,R15                 LIEGT SPEZ. VOLID VOR
         BP    VNXTVOL                 NEIN
         BAL   14,DEVICEOK             VOL-AUSGANGSBEDINGUNGEN
VNXTDSCB EQU   *
         BAL   14,NXTDSCB              NAECHSTER DSCB 1 WIRD VORGELEGT,
*                                          DSCB 4, 5 WERDEN AUSGEWERTET
         CLI   DSCBENDE,X'01'          DSCB-ENDE
         BE    VPRMEND                 JA - VOL ABGEARBEITET
         BAL   14,VRBDSCB1             AUSWERTEN DSCB 1
         CLI   RETAINSW,X'01'          DATEI GESCHUETZT
         BE    VNXTDSCB                JA
         BAL   14,SCRATCH              AUSGEBEN DATEIZ., LOESCHEN DATEI
         B     VNXTDSCB                NAECHSTER DSCB
VPRMEND  EQU   *
         NI    VOLSW+1,X'0F'           (-> NOP, S. VRBDSCB1)
         B     ENDPMWRK                NAECHSTER PARAMETER
         EJECT
*   PRUEFEN AUF 'SYSDA'
         SPACE 1
PRFSYSDA EQU   *
         CLC   0(5,R2),=C'SYSDA'       PARAMETER = 'SYSDA'
         BNE   PRFSYS                  NEIN, VERZWEIGEN
         CH    R1,=H'5'                LAENGE = 5 ?
         BNE   PRMUNGLT                NEIN, VERZWEIGEN
         SPACE 1
*   PARAMETER = 'SYSDA'
         SPACE 1
         BAL   14,EDTPLINE             AUSGEBEN BAY001I AUF NEUER SEITE
         BAL   14,WARNING              KONSOL-WARNUNG
MNXTVOL  EQU   *
         BAL   14,NXTVOL               NAECHSTE EINHEIT VORLEGEN
         CLC   UCBADDR+2(2),=X'FFFF'   ENDE DER UCB-ADRESSEN ?
         BE    ENDPMWRK                JA, VERZWEIGEN
         TM    SRTESTAB,X'08'          PUBLIC VOLUME ?
         BNO   MNXTVOL                 NEIN, VERZWEIGEN
         CLI   SRTEVOLI,C'0'           WORK VOLUME
         BL    MNXTVOL                 NEIN, VERZWEIGEN
         LA    R14,MNXTVOL             RUECKSPRUNGADRESSE BEI
         ST    R14,SAVE2R14                TABELLENENDE
         BAL   R14,PRFUCBN             UCBNAME PRUEFEN
MBALDVOK EQU   *
         BAL   14,DEVICEOK             VOL-AUSGANGSBEDINGUNGEN
MNXTDSCB EQU   *
         BAL   14,NXTDSCB              NAECHSTER DSCB 1 WIRD VORGELEGT,
*                                          DSCB 4, 5 WERDEN AUSGEWERTET
         CLI   DSCBENDE,X'01'          ENDE DER DSCBS ?
         BE    MNXTVOL                 JA, VERZWEIGEN
         BAL   14,SCRATCH              AUSGEBEN DATEIZ., LOESCHEN DATEI
         B     MNXTDSCB                NAECHSTER DSCB
         EJECT
*   PRUEFEN AUF 'SYS'
         SPACE 1
PRFSYS   EQU   *
         CLC   0(3,R2),=C'SYS'         PARAMETER BEGINNT MIT 'SYS'
         BNE   PRMUNGLT                NEIN
         CH    R1,=H'3'                LAENGE = 3
         BH    SLNGEG3                 LAENGE IST GROESSER 3
         MVC   SPEZVOL,=C'******'      PARAMETER 'SYS' ('SYS=******')
         B     PRMSYS
SLNGEG3  EQU   *
         CH    R1,=H'10'               LAENGE = 10
         BNE   PRMUNGLT                NEIN
         MVC   SPEZVOL,4(R2)           'SYS=<VOLID>': WEGSP. VOLID
         SPACE 1
*   PARAMETER = 'SYS='
         SPACE 1
PRMSYS   EQU   *
         BAL   14,EDTPLINE             AUSGEBEN BAY001I AUF NEUER SEITE
         BAL   14,WARNING              KONSOL-WARNUNG
SNXTVOL  EQU   *
         BAL   14,NXTVOL               NAECHSTE EINHEIT WIRD VORGELEGT
         CLC   UCBADDR+2(2),=X'FFFF'   UCB-ENDE
         BE    ENDPMWRK                JA
         TM    SRTESTAB,X'08'          PUBLIC VOLUME
         BNO   SNXTVOL                 NEIN
         CLI   SRTEVOLI,C'0'           WORK VOLUME
         BL    SNXTVOL                 NEIN
         LA    R14,SNXTVOL             RUECKSPRUNGADRESSE BEI
         ST    R14,SAVE2R14                TABELLENENDE
         BAL   R14,PRFUCBN             UCBNAME PRUEFEN
SPRFVOL  EQU   *
         BAL   14,PRFVOLID             PRUEFEN AUF SPEZIFIZIERTES VOLID
         LTR   R15,R15                 LIEGT SPEZ. VOLID VOR
         BP    SNXTVOL                 NEIN
         BAL   14,DEVICEOK             VOL-AUSGANGSBEDINGUNGEN
SNXTDSCB EQU   *
         BAL   14,NXTDSCB              NAECHSTER DSCB1 WIRD VORGELEGT,
*                                          DSCB 4, 5 WERDEN AUSGEWERTET
         CLI   DSCBENDE,X'01'          DSCB-ENDE
         BE    SNXTVOL                 JA
         CLC   DS1DSNAM(3),=C'SYS'     DSNAME = 'SYS*****
         BNE   SPRFDSN2                NEIN
         CLC   DS1DSNAM+8(2),=C'.T'        .T******
         BNE   SPRFDSN2                NEIN
         CLI   DS1DSNAM+16,C'.'            .' ...
         BE    SSCRATCH       '        JA
         EJECT
SPRFDSN2 EQU   *
         CLC   DS1DSNAM(7),=C'*.SYSUT' DSNAME = '*.SYSUT' ...
         BE    SSCRATCH                JA
         BAL   14,GETTRKS              ERSTELLEN LINETRKS, LINEEXTS
         MVC   ZACTION,=C'NONE   '     DRUCKAUFBEREITEN
         BAL   14,EDTZLINE                 UND AUSGEBEN
         BAL   14,PRINT                    DATEIZEILE
         B     SNXTDSCB                NAECHSTER DSCB
SSCRATCH EQU   *
         BAL   14,VRBDSCB1             AUSWERTEN DSCB 1
         CLI   RETAINSW,X'01'          DATEI GESCHUETZT
         BE    SNXTDSCB                JA
         BAL   14,SCRATCH              AUSGEBEN DATEIZ., LOESCHEN DATEI
         B     SNXTDSCB
         EJECT
*
*   PARAMETER BEGINNT MIT T
*
         SPACE 1
MARKET   EQU   *
         CLC   0(5,R2),=C'TEST='       PARAMETER BEGINNT MIT 'TEST='
         BNE   PRMUNGLT                NEIN
         CH    R1,=H'11'               LAENGE = 11
         BNE   PRMUNGLT
         CLI   ZUSTAND,C'C'            ZUSTAND C
         BNE   PRMUNGLT                NEIN - NUR IM ZUSTAND CON GUELTG
         MVC   SPEZVOL,5(R2)           WEGSPEICHERN VOLID
         SPACE 1
*   PARAMETER = 'TEST=<VOLID>'
         SPACE 1
         BAL   14,EDTPLINE             AUSGEBEN BAY001I AUF NEUER SEITE
         MVI   EOT,X'00'               LOESCHEN SCHALTER EOT
TNXTVOL  EQU   *
         BAL   14,NXTVOL               NAECHSTE EINHEIT WIRD VORGELEGT
         CLC   UCBADDR+2(2),=X'FFFF'   UCB-ENDE
         BE    ENDPMWRK                JA - SPEZ. VOL NICHT GEFUNDEN
         BAL   14,PRFVOLID             PRUEFEN SPEZIFIZIERTES VOLID
         LTR   R15,R15                 LIEGT SPEZ. VOLID VOR
         BP    TNXTVOL                 NEIN
         BAL   14,DEVICEOK             VOL-AUSGANGSBEDINGUNGEN
TNXTDSCB EQU   *
         BAL   14,NXTDSCB              NAECHSTER DSCB 1 WIRD VORGELEGT,
*                                          DSCB 4, 5 WERDEN AUSGEWERTET
         CLI   DSCBENDE,X'01'          DSCB-ENDE
         BE    ENDPMWRK                JA - NAECHSTER PARAMETER
         BAL   14,GETTRKS              ERSTELLEN LINETRKS, LINEEXTS
         CLI   EOT,X'01'               END OF PRM 'TEST'
         BNE   NBAY003D                NEIN
         MVC   ZREASON,=CL20'S.O.'
         B     PRMTEOT
NBAY003D EQU   *
         XC    WTORECB,WTORECB
         MVC   TESTANTW+1(2),BLANKS    LOESCHEN 2./3. STELLE TESTANTW
         MVC   TTDSN,DS1DSNAM          DSNAME FUER WTOR
         LA    R1,TTMSG-8              ADRESSE BAY003D
         WTOR  ,TESTANTW,3,WTORECB,MF=(E,(R1))
         EJECT
         WAIT  ECB=WTORECB
         OC    TESTANTW,BLANKS         -> GROSSBUCHSTABEN
         MVC   ZREASON(6),=C'REPLY='
         MVC   ZREASON+6(3),TESTANTW   REPLY -> ZREASON
         MVC   ZREASON+9(11),BLANKS
         CLC   TESTANTW(3),=C'YES'     REPLY = 'YES'
         BE    PRMTSCR
         CLC   TESTANTW(3),=C'Y  '
         BE    PRMTSCR
         CLC   TESTANTW(3),=C'EOT'     REPLY = 'EOT'
         BE    PRMTEOT
         CLC   TESTANTW(3),=C'T  '
         BE    PRMTEOT
         MVC   ZACTION,=C'NONE   '     FUER REPLY 'NO'
         CLC   TESTANTW(3),=C'NO '     REPLY = 'NO '
         BE    TDATEIZL
         CLC   TESTANTW(3),=C'N  '
         BE    TDATEIZL
         WTO   'BAY043I ACTION INVALID - ENTER ''YES'', ''NO'' OR ''EOT*
               ''',ROUTCDE=(1,2,4),DESC=6
         B     NBAY003D
PRMTEOT  EQU   *
         MVC   ZACTION,=C'NONE   '
         MVI   EOT,X'01'               SETZEN SCHALTER EOT
TDATEIZL EQU   *
         BAL   14,EDTZLINE             AUSGEBEN
         BAL   14,PRINT                    DATEIZEILE
         B     TNXTDSCB                NAECHSTER DSCB
PRMTSCR  EQU   *
         BAL   14,SCRATCH              AUSGEBEN DATEIZ., LOESCHEN DATEI
         B     TNXTDSCB                NAECHSTER DSCB
         EJECT
*
*   PARAMETER BEGINNT MIT U
*
         SPACE 1
MARKEU   EQU   *
*** ACHTUNG: ENTKATALOGISIEREN ZUR ZEIT NICHT GUELTIG =>
         B     PRMUNGLT
*    BZW. SCR0K200 - SCR0K500 GANZ RAUSNEHMEN
         CLC   0(8,R2),=C'UNCATLG='    PARAMETER BEGINNT MIT 'UNCATLG='
         BNE   PRMUNGLT                NEIN
         CH    R1,=H'9'                LAENGE < 9
         BL    PRMUNGLT                JA
         CH    R1,=H'52'               LAENGE > 52
         BH    PRMUNGLT                JA
         MVC   SPEZDSN,BLANKS          LOESCHEN SPEZDSN
         LR    R3,R1                   LAENGE PARAMETER
         SH    R3,=H'9'                    - 9 => LAENGENSCHL. DSN
         EX    R3,MVCUDSN              UEBERTRAGEN DSN AUS PRM
         SPACE 1
*   PARAMETER = 'UNCATLG=<DSN>'
         SPACE 1
         BAL   14,EDTPLINE             AUSGEBEN BAY001I AUF NEUER SEITE
         MVC   DSNAME,SPEZDSN          UEBERTRAGEN DSNAME
         CATALOG CAMCAT                UNCATALOG
         MVI   ZLINE,C'0'              VORSCHUB LEERZ. NACH BAY001I
         LTR   R15,R15                 RC = 0
         BZ    URCNULL                 JA
         MVC   ZACTION,=C'NONE   '
         MVC   ZREASON(3),=C'RC='
         CVD   R15,DBLWORD             DRUCKAUFBEREITEN
         UNPK  ZREASON+3(2),DBLWORD        RUECKKEHRKODE
         OI    ZREASON+4,X'F0'
         B     UDATEIZL
URCNULL  EQU   *
         MVC   ZACTION,=C'UNCATLG'
         MVC   ZREASON,=CL20'USER''S REQUEST'
UDATEIZL EQU   *
         MVC   ZDSNAME,SPEZDSN         DRUCKAUFBEREITEN UND
         BAL   14,PRINT                    AUSGEBEN DATEIZEILE
         B     ENDPMWRK                NAECHSTER PARAMETER
         EJECT
*
*   ABSCHLUSS
*
         SPACE 1
ENDJOB   EQU   *
         BAL   14,VOLFUSS              AUSGEBEN VOL-FUSSZEILEN
         MVC   ENDWTO+42(2),RC         EINSETZEN RC IN JOBENDE-NACHR.
         TM    PRMDA,X'04'             SCHALTER KONSOL-EINGABE GESETZT
         BZ    ENDPUT                  NEIN
ENDWTO   WTO   'BAY005I PROCESSING COMPLETED - RC=99',                 *
               ROUTCDE=(1,2,4),DESC=6
ENDPUT   EQU   *
         MVC   ZLINE+1(36),ENDWTO+8    BENUTZEN ZLINE FUER
         BAL   14,PRINT                    JOBENDE-NACHRICHT
         L     R1,LFDVPIND              LFD VP INDEX LADEN
         LA    R0,L'VOLPAGE             LAENGE EINER EINTRAGUNG
         CR    R1,R0                    MIND. 2 NUMMERN VORHANDEN?
         BNH   VOLSORT4                 WENN NICHT - SPRUNG
         LA    R1,VOLPAGE(R1)           ADRESSE DER LETZTEN EINTRAGUNG
         SR    R1,R0                    - DER VORLETZTEN
         AR    R0,R1                    - DER LETZTEN
         LA    R14,VOLPAGE              - DER ERSTEN
         EJECT
VOLSORT1 EQU   *
         LA    R15,L'VOLPAGE(,R14)      - DER (I+1)TEN
VOLSORT2 EQU   *
         CLC   0(6,R14),0(R15)          VERGLEICH I. MIT J. VOLSERNR
         BL    VOLSORT3                 RICHTIGE REIHENFOLGE - OKAY
         XC    0(L'VOLPAGE,R14),0(R15)  VERTAUSCHEN
         XC    0(L'VOLPAGE,R15),0(R14)    I. MIT J.
         XC    0(L'VOLPAGE,R14),0(R15)          VOLSERNR
VOLSORT3 EQU   *
         LA    R15,L'VOLPAGE(,R15)      J = J + 1
         CR    R15,R0                   J >= N?
         BL    VOLSORT2                 WENN NICHT - WEITER
         LA    R14,L'VOLPAGE(,R14)      I = I + 1
         CR    R14,R1                   I >= N - 1?
         BL    VOLSORT1                 WENN NICHT - WEITER
VOLSORT4 EQU   *
         L     R3,LFDVPIND              ANZAHL VOLSERNR
         LA    R0,L'VOLPAGE             LAENGE EINER EINTRAGUNG
         CR    R3,R0                    ANZAHL > 1?
         BNH   VOLSORTE                 WENN NICHT - SPRUNG
         SR    R2,R2                    R2 LOESCHEN FUER DIV
         DR    R2,R0                    ANZAHL EINTRAGUNGEN
         LR    R2,R3                    UMLADEN
         MVC   ZLINE(66),=CL66'-BAY006I THE REQUESTED VOLUMES ARE LISTE*
               D ON THE FOLLOWING PAGES -'
         BAL   14,PRINT                 DRUCKEN
         LA    R3,VOLPAGE               ADRESSE DER 1. EINTRAGUNG
VOLSORT5 EQU   *
         LA    R4,ZLINE+4               ADRESSE IN DER AUSGABE-ZEILE
         LA    R5,9                     ANZAHL EINTRAGUNGSN PRO ZEILE
VOLSORT6 EQU   *
         MVC   0(6,R4),0(R3)            UEBERTRAGEN VOLSERNR
         MVC   7(4,R4),6(R3)            UEBERTRAGEN SEITENNR
         LA    R3,L'VOLPAGE(,R3)        ADRESSE NAECHSTE NR
         LA    R4,13(,R4)               ADRESSE NAECHSTE NR (AUSGABE)
         BCT   R2,*+8                   BCT
         B     *+8                      UEBERSPRINGEN NAECHSTEN BEFEHL
         BCT   R5,VOLSORT6              BCT
         BAL   14,PRINT                 DRUCKEN
         LTR   R2,R2                    LETZTE EINTRAGUNG?
         BP    VOLSORT5                 WENN NICHT - WEITER
         EJECT
VOLSORTE EQU   *
         CLOSE (SYSOUT,,SYSFEHL,,SYSIN)
         FREEMAIN R,SP=125            VEKTOR MIT UCB-ADRESSEN FREIGEBEN
         B     ENDE
         EJECT
***********************************************************************
*                                                                     *
*      NEXT DIRECT ACCESS STORAGE DEVICE.                             *
*                                                                     *
***********************************************************************
         SPACE 3
NXTVOL   EQU   *
         ST    R14,SAVE1R14
         L     R2,UCBLOOK              R2 = ADRESSE UCB LOOKUP TBL POI.
LOOKUCB  EQU   *
         SR    R8,R8
         ICM   R8,3,0(R2)              INITIALISIEREN R8 (UCB-ADR.)
         CLC   0(2,R2),=X'FFFF'        UCB-ENDE
         BE    NOUCB                   JA
         CLI   UCBTYP+2,X'20'          DIRECT ACCESS STORAGE
         BNE   NEXTUCB                 NEIN - NEXT UCB
         CLC   SRTEVOLI(6),=XL6'0'     VOLID VORHANDEN
         BE    NEXTUCB                 NEIN - NEXT UCB
         TM    SRTESTAT,X'80'          EINHEIT ON-LINE
         BNO   NEXTUCB                 NEIN
         TM    SRTESTAT,X'10'          EINHEIT IM UNLOAD
         BO    NEXTUCB                 JA
         LA    R2,2(R2)                UPDATE POINTER
         ST    R2,UCBLOOK              => UCBLOOK NEXT CALL
NOUCB    EQU   *
         ST    R8,UCBADDR              WEGSPEICHERN ACTUAL UCB-ADDRESS
         L     R14,SAVE1R14
         BR    14
         SPACE 1
NEXTUCB  EQU   *
         LA    R2,2(R2)                UPDATE POINTER
         B     LOOKUCB                 NEXT DEVICE
         EJECT
***********************************************************************
*                                                                     *
*      UCBNAME PRUEFEN.                                               *
*                                                                     *
***********************************************************************
         SPACE 3
SAVE1R2  DC    F'0'                    SAVEAREA FUER R2
         SPACE 1
PRFUCBN  EQU   *
         ST    R14,SAVE1R14            RUECKSPRUNGADRESSE SICHERN
         ST    R2,SAVE1R2              R2 SICHERN
         L     R2,16                   ADRESSE DER CVT LADEN
         L     R2,196(R2)              ADRESSE DER SMCA LADEN
         LA    R3,TABANLGE-8           ADRESSE DER ANLAGEN-TABELLE
ANLGLOOP EQU   *
         LA    R3,8(R3)                NAECHSTES TABELLEN-ELEMENT
         CLC   0(8,R3),TABENDE         ENDE DER TABELLE ?
         BE    PRFLOOP                 JA, VERZWEIGEN
         CLC   0(4,R3),16(R2)          GESUCHTE ANLAGE ?
         BNE   ANLGLOOP                NEIN, NAECHSTE ANLAGE
         L     R3,4(R3)                ADRESSE DER TABELLE LADEN
PRFLOOP  EQU   *
         CLC   0(4,R3),TABENDE         ENDE DER TABELLE ?
         BE    PRFLPE1                 JA, VERZWEIGEN
         CLC   UCBNAME,0(R3)           UCBNAME = TAB-ADRESSE ?
         BE    PRFLPE2                 JA, VERZWEIGEN
         LA    R3,4(R3)                NAECHSTES TABELLENELEMENT
         B     PRFLOOP                 VERZWEIGEN
PRFLPE1  EQU   *
         L     R14,SAVE2R14            RUECKSPRUNGADRESSE LADEN
         B     PRFUCBNE                VERZWEIGEN
PRFLPE2  EQU   *
         L     R14,SAVE1R14            RUECKSPRUNGADRESSE LADEN
PRFUCBNE EQU   *
         L     R2,SAVE1R2              R2 REINITIALISIEREN
         BR    R14                     VERZWEIGEN
         EJECT
***********************************************************************
*                                                                     *
*      DEVICE OK - VOL-ALT: FUSS, VOL: KOPF & DATEIANFANGSBEDINGUNGEN *
*      DEVICE OK - VOL-ALT: FUSS, VOL: KOPF & DATEIANFANGSBEDINGUNGEN *
*                                                                     *
***********************************************************************
         SPACE 3
DEVICEOK EQU   *
         ST    R14,SAVE1R14
*        USING UCB,R8                  R8 = UCB-ADR. (INIT. IN NXTVOL)
         BAL   14,VOLFUSS              AUSGEBEN VOL-FUSSZEILEN
         MVC   VOLUMSER,SRTEVOLI       SPEICHERN VOLID
         MVC   SVUNIT,UCBNAME          SPEICHERN UNIT ADDR
         MVC   DUNIT,SVUNIT            AUFBEREITEN
         MVC   DVOLID,VOLUMSER             VOLKOPF
         SR    R4,R4
         IC    R4,UCBTYP+3             DEVICE CODE (X'01'-X'09')
         STC   R4,DVTYP                SPEICHERN DEVICE TYPE
         SLA   R4,2                        => DISPL. UNITTYP-TAB
         LA    R3,UNITTYP-4(R4)        EINTRAGEN
         MVC   DUNITTYP,0(R3)              EINHEITENTYP
         MVC   ZLINE,DLINE             AUSGEBEN
         BAL   14,PRINT                    VOL-KOPFZEILE
         L     R14,LFDVPIND             LFD VP INDEX
         LA    R15,VOLPAGE(R14)         ADRESSE LFD EINTRAGUNG
         MVC   0(6,R15),DVOLID          UEBERTRAGEN LFD VOLSERNR
         MVC   6(4,R15),ZPAGENO         UEBERTRAGEN LFD SEITENNR
         LA    R14,L'VOLPAGE(,R14)      ERHOEHEN LFD VP INDEX
         LA    R15,MAXVPIND             VERGLEICHEN MIT MAX
         CR    R14,R15                  LFD < MAX?
         BNL   *+8                      WENN NICHT - NICHT SPEICHERN
         ST    R14,LFDVPIND             LFD VP INDEX SPEICHERN
         MVI   VOLKPFDA,X'01'          SETZEN SCHALTER VOLKOPF VORH.
         LH    R2,SRTEFSCT             VTOC-ADDRESS (TTR ABSOLUTE)
         EJECT
         L     R1,X'10'                CVT ADRESSE LADEN
         TM    X'74'(R1),X'01'         MVS SYSTEM?
         BZ    *+8                     WENN NICHT - WEITER
         LH    R2,UCBVTOC              SPUR ADRESSE VTOC LADEN
         SLA   R4,1                    DEVICE CODE => DISPL. TCANDCAP
         SRDA  R2,32
         D     R2,TCANDCAP-8(R4)       DIVID. TT/SPECIFIC TRKS/CYL
         STH   R2,TRACKNO              => STARTING TRACK
         STH   R2,CCHHR+2              => HH -ADDRESS OF VTOC
         STH   R3,CYLNO                => STARTING CYL
         STH   R3,CCHHR                => CC -ADDRESS OF VTOC
         MVI   CCHHR+4,X'01'           RECORD NUMBER
         MVI   RECNO+1,X'01'           R-ADDRESS OF VTOC
         XC    TRKCNTSU,TRKCNTSU
         XC    FREETRKS,FREETRKS
         MVI   DSCB4DA,X'00'           LOESCHEN SCHALTER DSCB4
         MVI   DSCBENDE,X'00'          LOESCHEN SCHALTER DSCB-ENDE
         DROP  R8
         L     R14,SAVE1R14
         BR    14
         EJECT
***********************************************************************
*                                                                     *
*      LESEN DSCB'S - AUSWERTEN FORMAT 4, 5 UND VORLEGEN FORMAT 1.    *
*                                                                     *
***********************************************************************
         SPACE 3
NXTDSCB  EQU   *
         ST    R14,SAVE1R14
         CLI   DSCB4DA,X'01'           FORMAT 4 DSCB SCHON GELESEN
         BNE   FRSTDSCB                NEIN - CCHHR NICHT ERHOEHEN
READVTOC EQU   *
         LH    R2,RECNO                LFD. SATZ-NUMMER
         LA    R2,1(R2)                ERHOEHEN
         CH    R2,MRECNO               SPUR UEBERSCHRITTEN
         BNH   RECOK                   NEIN - NEUE CCHHR-ADRESSE
         LH    R2,TRACKNO              JA - LFD. SPUR-NUMMER
         LA    R2,1(R2)                ERHOEHEN
         CH    R2,MTRACKNO             ZYLINDER UEBERSCHRITTEN
         BL    TRACKOK                 NEIN - NEUE CCHHR-ADRESSE
         LH    R2,CYLNO                JA - LFD. ZYLINDER-NUMMER
         LA    R2,1(R2)                ERHOEHEN
         STH   R2,CYLNO                SPEICHERN
         STH   R2,CCHHR                    NEUE ZYLINDER-ADRESSE
         LA    R2,0                    R2 = 0
TRACKOK  EQU   *
         STH   R2,TRACKNO              SPEICHERN
         STH   R2,CCHHR+2                  NEUE SPUR-ADRESSE
         LA    R2,1                    R2 = 1
RECOK    EQU   *
         STH   R2,RECNO                SPEICHERN
         STC   R2,CCHHR+4                  NEUE SATZ-ADRESSE
         CLC   CCHHR,DS4HPCHR          DSCB-ENDE
         BH    DSCBEND                 JA
FRSTDSCB EQU   *
         OBTAIN CAMOBT                 READ NEXT DSCB
         LTR   R15,R15                 RC = 0
         BZ    OBTN1OK                 JA
         MVC   FMAKRO,=C'OBTAIN '
         BAL   14,EDITRC               DRUCKAUFB RC & AUSGEBN NACHRICHT
         BAL   14,SETZRC12             RC = 12
         B     READVTOC
         EJECT
OBTN1OK  EQU   *
         CLI   DSCB4DA,X'01'           DSCB 4 SCHON GELESEN
         BE    DSCBOK                  JA
         CLI   WORKFLD+44,C'4'         NEIN - FORMT 4 (1. DSCB IN VTOC)
         BE    FORMAT4                 JA - VERARBEITEN DSCB 4
         MVC   ZLINE+1(28),=C'BAY122I 1. DSCB NOT FORMAT 4'
         BAL   14,PRINT                BENUTZEN ZLINE FUER BAY122I
         BAL   14,SETZRC12             RC = 12
         NI    LISTSW1+1,X'0F'         (-> NOP RETAIN5, S. VRBDSCB1)
         OI    LISTSW2+1,X'F0'         (-> B ACTIONOK, S. VRBDSCB1)
         NI    OLDSW+1,X'0F'           (-> NOP OLDONLY, S. VRBDSCB1)
         NI    VOLSW+1,X'0F'           (-> NOP DBPRFEND, S. VRBDSCB1)
         B     ENDPMWRK                NAECHSTER PARAMETER
DSCBOK   EQU   *
         CLI   WORKFLD+44,C'1'         FORMAT 1
         BNE   FRGDSCB5                NEIN
         MVC   DSCB1,WORKFLD           SPEICHERN DSCB1
         B     RTRNNXTD
FRGDSCB5 EQU   *
         CLI   WORKFLD+44,C'5'         FORMAT 5
         BE    FORMAT5
         B     READVTOC
         SPACE 1
*   FORMAT 4 DSCB (EINMAL PRO VOL)
         SPACE 1
FORMAT4  EQU   *
         MVC   DSCB4,WORKFLD           SPEICHERN DSCB 4
         MVC   MTRACKNO,DS4DEVSZ+2     SPEICHERN MAX. SPUR-ADRESSE
         MVC   MRECNO+1(1),DS4DEVDT    SPEICHERN MAX. SATZ-ADRESSE
         MVI   DSCB4DA,X'01'           SETZEN SCHALTER DSCB 4
         B     READVTOC                READ NEXT DSCB
         EJECT
*   FORMAT 5 DSCB
         SPACE 1
FORMAT5  EQU   *
         MVC   DSCB5,WORKFLD           SPEICHERN DSCB5
         LA    R8,DS5AVEXT
         USING DS5AVEXT,R8             R8 = ADRESSE 1. EXTENT
         MVC   DS5FMTID(90),DS5FMTID+1 TRENNUNG EXTENT 1-8 VON 9-26
*                                          DURCH FORMAT-ID AUFGEHOBEN
         LA    R7,26
         LH    R2,FREETRKS             R2 = ZAEHLER FREE TRKS
TRKLOOP2 EQU   *
         SR    R4,R4
         IC    R4,DVTYP                EINHEITENTYP VOL
         SLA   R4,3                        * 8 => TCANDCAP-TAB
         L     R3,TCANDCAP-8(R4)       TRKS PRO CYL
         MVC   HALBWORT,DS5AVEXT+2         * FREE CYL AUS EXTENT
         MH    R3,HALBWORT                 => FREE CYLS IN TRKS
         AR    R2,R3                   ERHOEHEN ZAEHLER FREE TRKS
         SR    R4,R4
         IC    R4,DS5AVEXT+4           FREE TRACKS AUS EXTENT
         AR    R2,R4                   ERHOEHEN ZAEHLER FREE TRKS
         LA    R8,5(R8)                R8 = ADRESSE NAECHSTER EXTENT
         BCT   R7,TRKLOOP2
         DROP  R8
         STH   R2,FREETRKS             WEGSPEICHERN FREE TRKS
         B     READVTOC                NEXT DSCB
DSCBEND  EQU   *
         MVI   DSCBENDE,X'01'          SETZEN SCHALTER DSCB-ENDE
RTRNNXTD EQU   *
         L     R14,SAVE1R14
         BR    14
         EJECT
***********************************************************************
*                                                                     *
*      VERARBEITEN DSCB 1 (SCHUTZPRUEFUNGEN).                         *
*                                                                     *
***********************************************************************
         SPACE 3
VRBDSCB1 EQU   *
         ST    R14,SAVE1R14
         MVI   RETAINSW,X'00'          LOESCHEN SCHALTER RETAIN
         BAL   14,GETTRKS              ERSTELLEN LINETRKS, LINEEXTS
         SPACE 2
*
*   PRUEFUNG AUF &&-DATEIEN
*
         SPACE 1
OLDSW    EQU   *
         NOP   OLDONLY                 (-> B, S. PRM 'OLD')
         CLC   DS1DSNAM+23(5),JOBNAME  JOBNAME MUST BE GREATER THAN 4
*                                          VERGLEICH JOBNAME ST. 1-5
         BNE   PRFINDEX
OLDONLY  EQU   *
         CLC   DS1DSNAM(8),JOBDATUM    VERGLEICH SYS<JJTTT>
         BE    RETAIN1
         SPACE 1
*
*   PRUEFEN AUF GESCHUETZTE INDIZES
*
         SPACE 1
PRFINDEX EQU   *
         LA    R2,TABRETN2             R2 = ADRESSE GESCHUETZTE INDIZES
PRFRETN2 EQU   *
         IC    R3,0(R2)                R3 = INDEX-LAENGE
         CLI   0(R2),X'00'             LAENGE 0 (RESERVE × TAB-ENDE)
         BE    PRFCATLG                JA - NAECHSTE PRUEFUNG
         EX    R3,VGL1INDX             VERGL. DSN-ANFANG / GESCH. INDEX
         BE    RETAIN2                 INDEX IST GESCHUETZT
         LA    R2,10(R2)               R2 = ADRESSE NAE. INDEX-LAENGE
         B     PRFRETN2
         SPACE 1
*   DSNAME 'SYSCTLG' IST GESCHUETZT
         SPACE 1
PRFCATLG EQU   *
         CLC   DS1DSNAM(7),=C'SYSCTLG'
         BE    RETAIN4
         EJECT
*   PRUEFUNG VOL=SER=DBXXXX
         SPACE 1
VOLSW    EQU   *
         NOP   DBPRFEND                (-> B, S. PRM 'VOL')
         CLC   VOLUMSER(2),=C'DB'
         BE    RETAIN8
DBPRFEND EQU   *
         SPACE 1
*   PRUEFUNG PASSWORD SECURITY
         SPACE 1
         TM    DS1DSIND,X'10'          SECURITY BIT
         BO    RETAIN6
         SPACE 1
*   PRUEFUNG EXPIRATION DATE
         SPACE 1
         CLC   DS1EXPDT,DATE           EXPIRATION DATE / TAGESDATUM
         BH    RETAIN3
         SPACE 1
*   PRUEFUNG MODEL DSCB
         SPACE 1
         CLC   LINETRKS,=C'  0000'     ZERO ALLOC.
         BNE   LISTSW1                 NEIN
*        CLI   DS1DSNAM,C'*'           TEST AUF IEHMOVE GARBAGE
*        BNE   RETAIN7
LISTSW1  EQU   *
         NOP   RETAIN5                 (-> B, S. PRM 'LIST')
         B     RTRNVRB1
         SPACE 1
*   DATEI IST GESCHUETZT
         SPACE 1
RETAIN1  EQU   *
         MVC   ZREASON,=C'ACTIVE &&&&DATASET    '
         MVC   ZACTION,=C'NONE   '
         B     RETAIN
RETAIN2  EQU   *
         MVC   ZREASON,=C'FIRST INDEX LEVEL   '
         MVC   ZACTION,=C'NONE   '
         B     RETAIN
RETAIN3  EQU   *
         MVC   ZREASON,=C'PURGE DATE          '
         MVC   ZACTION,=C'NONE   '
         B     RETAIN
RETAIN4  EQU   *
         MVC   ZREASON,=C'CATALOG DATASET     '
         MVC   ZACTION,=C'NONE   '
         B     RETAIN
         EJECT
RETAIN5  EQU   *
         MVC   ZREASON,BLANKS
         MVC   ZACTION,=C'LIST   '
         B     RETAIN
RETAIN6  EQU   *
         MVC   ZREASON,=C'SECURITY PROTECTION '
         MVC   ZACTION,=C'NONE   '
         B     RETAIN
RETAIN7  EQU   *
         MVC   ZREASON,=C'ALLOC 0 - MODEL DSCB'
         MVC   ZACTION,=C'NONE   '
         B     RETAIN
RETAIN8  EQU   *
         MVC   ZREASON,=C'VOL=SER=DBXXXX      '
         MVC   ZACTION,=C'NONE   '
RETAIN   EQU   *
         MVI   RETAINSW,X'01'          SETZEN SCHALTER RETAIN
LISTSW2  EQU   *
         B     ACTIONOK                (-> NOP, S. PRM 'LIST')
         MVC   ZACTION,=C'LIST   '     JA - ACTION = LIST
ACTIONOK EQU   *
         BAL   14,EDTZLINE             DRUCKAUFBEREITEN ZLINE
         BAL   14,PRINT
RTRNVRB1 EQU   *
         L     R14,SAVE1R14
         BR    14
         EJECT
***********************************************************************
*                                                                     *
*      BERECHNEN ALLOCATED TRACKS UND EXTENTS (EV. READ DSCB 2 × 3)   *
*                                                                     *
***********************************************************************
         SPACE 3
GETTRKS  EQU   *
         ST    R14,SAVE2R14
         LA    R8,DS1EXT1
         USING DS1EXT1,R8              R8 = ADRESSE 1. EXTENT
         XC    TRKCNT,TRKCNT           LOESCHEN ZAEHLER ALLOC. TRKS,
         XC    EXTCNT,EXTCNT               ZAEHLER EXTENTS
         LA    R7,3                    ANFANGSINDEX 1. SCHLEIFE
TRKLOOP1 EQU   *
         CLI   DS1EXT1,X'00'           EXTENT VORHANDEN
         BE    RTRNGETT                NEIN
         MVC   DBLWORD,DS1EXT1+2       EINGABE UP EXTTRKS
         BAL   R14,EXTTRKS             BERECHNEN EXTENT-TRACKS
         AH    R3,TRKCNT               R3 = AUSGABE EXTTRKS
         STH   R3,TRKCNT
         LH    R3,EXTCNT               ERHOEHEN
         LA    R3,1(R3)                    EXTENT-ZAEHLER
         STH   R3,EXTCNT
         LA    R8,10(R8)               R8 = ADRESSE NAECHSTER EXTENT
         BCT   R7,TRKLOOP1
         DROP  R8
         CLI   DURCHLF,C'2'            2. DURCHLAUF
         BE    RTRNGETT                JA - RETURN
         CLC   DS1PTRDS,=XL6'0'        DSCB3-POINTER BEI MEHR ALS 3 EXT
*                                      DSCB2-POINTER BEI ORGANIZ. IS
         BE    RTRNGETT                NICHT VORHANDEN
         MVC   SVCCHHR,CCHHR           SPEICHERN CCHHR-DSCB1 (F. SCR)
         MVC   CCHHR,DS1PTRDS          DSCB 2 × 3 PINTER
OBTAIN2  EQU   *
         OBTAIN CAMOBT                 READ DSCB FORMAT 2 × 3
         LTR   R15,R15                 RC = 0
         BZ    OBTN2OK                 JA
         MVC   FMAKRO,=C'OBTAIN '
         BAL   14,EDITRC               DRUCKAUFB RC & AUSGEBN NACHRICHT
         BAL   14,SETZRC12             RC = 12
         B     ENDDSCB2
         EJECT
OBTN2OK  EQU   *
         CLI   WORKFLD+44,C'3'         DSCB FORMAT 3
         BE    DSCB3OK                 JA
         CLI   WORKFLD+44,C'2'         DSCB FORMAT 2
         BE    DSCB2OK                 JA
         MVC   ZLINE+1(46),=C'BAY123I DSCB-FORMAT NOT 2 × 3 AT EXTENT-O*
               BTAIN'
         BAL   14,PRINT                BENUTZEN ZLINE FUER BAY123I
         BAL   14,SETZRC12             RC = 12
         B     ENDDSCB2
         EJECT
DSCB3OK  EQU   *
         MVC   DSCB3,WORKFLD           SPEICHERN DSCB3
         MVC   CCHHR,SVCCHHR           CCHHR = CCHHR-DSCB1
         MVC   DS3FMTID(90),DS3FMTID+1 TRENNUNG EXTNT 1-4 VON 5-13
*                                      DURCH FORMAT-ID AUFGEHOBEN
         LA    R8,DS3EXTNT             R8 = ADRESSE 4. EXTENT
         LA    R7,13                   ANFANGSINDEX FUER 2. SCHLEIFE
         MVI   DURCHLF,C'2'            SETZEN SCHALTER 2. DURCHLAUF
         B     TRKLOOP1
         SPACE 1                                                      *
DSCB2OK  EQU   *
         MVC   DSCB2,WORKFLD           SPEICHERN DSCB2
         CLC   DS2PTRDS,=XL6'0'        POINTER DSCB3 VORHANDEN
         BE    ENDDSCB2                NEIN
         MVC   CCHHR,DS2PTRDS          POINTER DSCB 3
         B     OBTAIN2
ENDDSCB2 EQU   *
         MVC   CCHHR,SVCCHHR           CCHHR = CCHHR-DSCB1
RTRNGETT EQU   *
         MVI   DURCHLF,C'1'            SETZEN SCHALTER 1. DURCHLAUF
         LH    R2,TRKCNT               DRUCKAUFBEREITEN
         CVD   R2,DBLWORD                  TRKCNT
         MVC   LINETRKS,TRKMASK        => LINETRKS
         ED    LINETRKS,DBLWORD+5
         AH    R2,TRKCNTSU             ERHOEHEN
         STH   R2,TRKCNTSU                 ALLOCATED TRACKS
         LH    R2,EXTCNT               DRUCKAUFBEREITEN
         CVD   R2,DBLWORD                  EXTCNT
         UNPK  LINEEXTS,DBLWORD            => LINEEXTS
         OI    LINEEXTS+1,X'F0'
         L     R14,SAVE2R14
         BR    14
         EJECT
*** ACHTUNG: BZW. SCR0P288 - SCR0P580 GANZ RAUSNEHMEN
*    S. AUCH ZUGEHOERIGE DEFINITIONEN
***********************************************************************
*                                                                     *
*      ENTKATALOGISIEREN DSNAME.                                      *
*                                                                     *
***********************************************************************
         SPACE 3
UNCATLG  EQU   *
         ST    R14,SAVE1R14
         MVC   DSNAME,DS1DSNAM         DSNAME AUS DSCB 1
         CATALOG CAMCAT                UNCATALOG
         LTR   R15,R15                 RC = 0
         BZ    DISPDEL                 JA
         B     RTRNUNCT
         SPACE 1
*        WENN BAY121I WIEDER BEI CATALOG-MAKRO-FEHLER AUSGEGEBEN WIRD,*
*        AUCH CATALOG-MAKRO UNTER 'MARKEU' BERUECKSICHTIGEN.          *
         SPACE 1
         MVC   FMAKRO,=C'CATALOG'
         MVC   FR0TEXT,=C', R0='
         ST    R0,KETTE5               KETTE5 STELLE 1-4 = R0 HEX
         UNPK  FR0(9),KETTE5           UEBERLAPPTES ENTPACKEN
         TR    FR0,TRTAB-240               => DRUCKBARER HEXWERT R0
         MVC   FR1TEXT,=C', R1='
         ST    R1,KETTE5               KETTE5 STELLE 1-4 = R1 HEX
         UNPK  FR1(9),KETTE5           UEBERLAPPTES ENTPACKEN
         TR    FR1,TRTAB-240               => DRUCKBARER HEXWERT R1
         BAL   14,EDITRC               DRUCKAUFB RC & AUSGEBN NACHRICHT
         MVC   FR0TEXT(26),BLANKS      LOESCHEN FR0TEXT BIS FR1
         BAL   14,SETZRC12             RC = 12
DISPDEL  EQU   *
         MVC   ZACTION,=C'DELETE '
RTRNUNCT EQU   *
         L     R14,SAVE1R14
         BR    14
         EJECT
***********************************************************************
*                                                                     *
*      DATEIZEILE AUSGEBEN, DATEI LOESCHEN.                           *
*                                                                     *
***********************************************************************
         SPACE 3
SCRATCH  EQU   *
         ST    R14,SAVE1R14
         CLC   ZACTION,=C'DELETE '     SCHON EINGETRAGEN
         BE    DISPRSN                 JA
         MVC   ZACTION,=C'SCRATCH'
DISPRSN  EQU   *
         CLC   ZREASON(6),=C'REPLY='   SCHON EINGETRAGEN
         BE    SCRTRKS                 JA
         MVC   ZREASON,=C'USER''S REQUEST             '
SCRTRKS  EQU   *
         LH    R3,TRKCNTSU             ERNIEDRIGEN
         SH    R3,TRKCNT                   ALLOCATED TRACKS
         STH   R3,TRKCNTSU                 UM SCRATCHED
         LH    R3,FREETRKS             ERHOEHEN
         AH    R3,TRKCNT                   FREE TRACKS
         STH   R3,FREETRKS                 UM SCRATCHED
         BAL   14,EDTZLINE             DRUCKAUFBEREITEN UND
         BAL   14,PRINT                    AUSGEBEN DATEIZEILE
         L     R8,UCBADDR
         USING UCB,R8                  R8 = ADRESSE CURRENT UCB
         MVC   DSNAME,DS1DSNAM         DSNAME AUS DSCB 1
         MVC   VOLIST+6(6),SRTEVOLI    VOLUME SER AUS DSCB 1
         MVC   VOLIST+2(4),UCBTYP      DEVICE TYPE AUS DSCB 1
         DROP  R8
         SR    0,0                     LOESCHEN R0 FUER SCRATCH-MAKRO
         SCRATCH CAMSCR                SCRATCH MIT OVRD
         LTR   15,15                   RC = 0
         BZ    RTRNSCR                 JA
         MVC   FMAKRO,=C'SCRATCH'
         BAL   14,EDITRC
         BAL   14,SETZRC12             RC = 12
RTRNSCR  EQU   *
         L     R14,SAVE1R14
         BR    14
         EJECT
***********************************************************************
*                                                                     *
*      UNTERPROGRAMM BERECHNEN TRACKS PRO EXTENT.                     *
*                                                                     *
***********************************************************************
         SPACE 3
EXTTRKS  EQU   *
         LH    R3,DBLWORD              DBLWORD - EINGABEPARAMETER (EXT)
         MH    R3,MTRACKNO
         AH    R3,DBLWORD+2
         STH   R3,TRKA
         LH    R3,DBLWORD+4
         MH    R3,MTRACKNO
         AH    R3,DBLWORD+6
         STH   R3,TRKB
         SH    R3,TRKA
         LA    R3,1(R3)                R3 - AUSGABEPARAMETER (TRKS)
         BR    14
         SPACE 3
***********************************************************************
*                                                                     *
*      UNTERPROGRAMM KONVERTIEREN DATUM X'JJ0TTT' -> C'TTTJJ'.        *
*                                                                     *
***********************************************************************
         SPACE 3
DATEXC   EQU   *
         L     R2,DBLWORD              DBLWORD - EINGABEPARAMETER (JTT)
         SRDL  R2,24
         CVD   R2,DBLWORD1
         UNPK  DBLWORD+6(2),DBLWORD1   -> JJ
         SRL   R3,16
         CVD   R3,DBLWORD1
         UNPK  DBLWORD+3(3),DBLWORD1   -> TTT
         OI    DBLWORD+5,X'F0'
         OI    DBLWORD+7,X'F0'         DBLWORD - AUSGABEPARAM (TTTJJ)
         BR    14
         EJECT
***********************************************************************
*                                                                     *
*      UNTERPROGRAMM KONVERTIEREN DATUM C'JJTTT' -> X'JJ0TTT'.        *
*                                                                     *
***********************************************************************
         SPACE 3
DATECX   EQU   *
         PACK  DBLWORD1,DBLWORD(2)     DBLWORD - EINGABEPARAM (JJTTT)
         CVB   R4,DBLWORD1             JJ
         PACK  DBLWORD1,DBLWORD+2(3)
         CVB   R5,DBLWORD1             TTT
         SLL   R5,8
         ST    R5,DBLWORD
         STC   R4,DBLWORD              DBLWORD AUSGABEPARAM (JTT)
         BR    14
         EJECT
***********************************************************************
*                                                                     *
*      UNTERPROGRAMM DRUCKAUFBEREITEN ZLINE.                          *
*                                                                     *
***********************************************************************
         SPACE 3
EDTZLINE EQU   *
         ST    R14,SAVE2R14
         MVC   ZDSNAME,DS1DSNAM
         MVC   ZTRACKS,LINETRKS
         CLC   DS1LSTAR(5),=XL6'0'     LAST BLOCK POINTER (TTRLL) NULL
         BNE   PRFLBP                  NEIN
         MVC   ZUSED+2(4),=C'----'
         B     MOVEEXTS
PRFLBP   EQU   *
         LH    R2,DS1LSTAR             TRKS AUS LAST BLOCK POINTER
         CLI   DS1LSTAR+2,X'00'        RECNO AUS LAST BLOCK POINTER
         BE    CONVTRKS                    IST NULL
         LA    R2,1(R2)                ERHOEHEN TRACKS UM 1
CONVTRKS EQU   *
         CVD   R2,DBLWORD                  DRUCKAUFBEREITEN
         MVC   ZUSED,TRKMASK               USED
         ED    ZUSED,DBLWORD+5             TRACKS
MOVEEXTS EQU   *
         MVC   ZEXTENTS,LINEEXTS
         TM    DS1DSORG,X'80'          ORGANIZATION INDEXED SEQ.
         BZ    PRFORGPS                NEIN
         MVC   ZTYP,=C'IS'
         B     EDTCREDT
PRFORGPS EQU   *
         TM    DS1DSORG,X'40'          ORGANIZATION PHYSICAL SEQ.
         BZ    PRFORGDA                NEIN
         MVC   ZTYP,=C'PS'
         B     EDTCREDT
PRFORGDA EQU   *
         TM    DS1DSORG,X'20'          ORGANIZATION DIRECT
         BZ    PRFORGPO
         MVC   ZTYP,=C'DA'
         B     EDTCREDT
PRFORGPO EQU   *
         TM    DS1DSORG,X'02'          ORGANIZATION PARTIONED
         BZ    ORGU
         MVC   ZTYP,=C'PO'
         B     EDTCREDT
         EJECT
ORGU     EQU   *
         MVC   ZTYP,=C'--'             ORGANIZ. NICHT IS, PS, DA, PO
EDTCREDT EQU   *
         MVC   DBLWORD(3),DS1CREDT
         BAL   14,DATEXC
         MVC   ZCREDAT+0(2),DBLWORD+6
         MVI   ZCREDAT+2,C'.'
         MVC   ZCREDAT+3(3),DBLWORD+3
         MVC   DBLWORD(3),DS1EXPDT
         BAL   14,DATEXC
         CLC   DBLWORD+3(5),=C'00000'
         BE    HYPHEN
         MVC   ZPURDAT+0(2),DBLWORD+6
         MVI   ZPURDAT+2,C'.'
         MVC   ZPURDAT+3(3),DBLWORD+3
         B     NOHPH
HYPHEN   EQU   *
         MVC   ZPURDAT,=C'------'
NOHPH    EQU   *
         L     R14,SAVE2R14
         BR    14
         EJECT
***********************************************************************
*                                                                     *
*      UNTERPROGRAMM DRUCKAUFBEREITEN UND AUSGEBEN VOL-FUSSZEILEN.    *
*                                                                     *
***********************************************************************
         SPACE 3
VOLFUSS  EQU   *
         ST    R14,SAVE2R14
         CLI   VOLKPFDA,X'01'          VOLKOPF GESCHRIEBEN
         BNE   RTRNVOLF                NEIN - VOLFUSS UEBERFLUESSIG
         LA    R6,DS4VTOCE             VTOC-EXTENT
         USING DS1EXT1,R6                  (WIE DS1EXT1)
         MVC   DBLWORD,DS1EXT1+2       EINGABE UP EXTTRKS
         BAL   R14,EXTTRKS             BERECHNEN EXTENT-TRACKS
         DROP  R6
         CVD   R3,DBLWORD              DRUCKAUFBEREITEN VTOCTRKS
         MVC   ZTRACKS,TRKMASK         => LINEVTOC
         ED    ZTRACKS,DBLWORD+5
         MVC   ZDSNAME,=CL44'FORMAT4.DSCB(VTOC)' DRUCKAUFBEREITEN
         BAL   14,PRINT                    UND AUSGEBEN DATEIZEILE
         MVC   DBLWORD,DS4VTOCE+2      VTOC-EXTENT
         BAL   14,EXTTRKS              BERECHNEN EXTENT-TRACKS
         AH    R3,TRKCNTSU             ERHOEHEN TRKCNTSU
         STH   R3,TRKCNTSU                 UM VTOC-EXTENT =>
         CVD   R3,DBLWORD              ALLOCATED TRACKS
         UNPK  TTRACKS,DBLWORD             DRUCKAUFBEREITEN
         OI    TTRACKS+4,X'F0'
         MVC   XALLOC,TTRACKS          ALLOC. TRKS -> DSCB5-FEHLERZEILE
         CLI   TTRACKS,C'0'            TTRACKS <= 9999
         BNE   AUSGTXT1                NEIN
         MVI   TTRACKS,C' '            LOESCHEN 1. FUEHRENDE NULL
AUSGTXT1 EQU   *
         MVC   TTEXT,=C'ALLOCATED TRACKS'
         PUT   SYSOUT,TLINE            AUSGEBEN VOL-FUSSZEILE 1
         SR    R4,R4
         IC    R4,DVTYP                EINHEITENTYP VOL-ALT
         SLA   R4,3                        * 8 => DISPL. TCANDCAP-TAB
         L     R2,TCANDCAP-4(R4)       CAPACITY IN TRACKS
         SH    R2,TRKCNTSU                 - ALLOCATED TRACKS
         LH    R3,FREETRKS             FREE TRKS AUS DSCBS FORMAT 5
         SR    R2,R3                   FREE TRKS/ERRECHNET - /DSCBS 5
         CH    R2,=H'1'                DIFFERENZ 1 - VOL-LABEL SPACE
         BE    AUFBTTRK                JA - NORMALFALL
         CH    R2,=H'2'                DIFFERENZ 2
         BNE   TRKSTERN                NEIN - FALSCHER DSCB 5
         CLI   DVTYP,X'01'             EINHEITENTYP 2311
         BE    AUFBTTRK                JA - SONDERFALL
         EJECT
TRKSTERN EQU   *
         MVI   TSTERN1A,C'*'           KENNZEICHNEN FREE TRKS
         MVI   TSTERN2,C'*'                ALS FEHLERHAFT
         MVC   XUNITTYP,DUNITTYP       UNIT TYPE -> DSCB5-FEHLERZEILE
         MVC   XVOLID,DVOLID           VOLID -> DSCB5-FEHLERZEILE
AUFBTTRK EQU   *
         CVD   R3,DBLWORD              FREE TRACKS DSCB 5
         UNPK  TTRACKS,DBLWORD             DRUCKAUFBEREITEN
         OI    TTRACKS+4,X'F0'
         MVC   XFREE,TTRACKS           FREE TRKS -> DSCB5-FEHLERZEILE
         CLI   TTRACKS,C'0'            TTRACKS <= 9999
         BNE   AUSGTXT2                NEIN
         MVI   TTRACKS,C' '            LOESCHEN 1. FUEHRENDE NULL
         MVC   TSTERN1A+1(1),TSTERN1A      UND SCHIFTEN
         MVI   TSTERN1A,C' '               EVENTUELLER FEHLER-STERN1
AUSGTXT2 EQU   *
         MVC   TTEXT,=C'FREE TRACKS     '
         PUT   SYSOUT,TLINE            AUSGEBEN VOL-FUSSZEILE 2
         CLI   TSTERN2,C'*'            DSCB5 FALSCH
         BNE   VOLFZ3                  NEIN
         CLI   SFEHLDA,X'01'           SYSFEHL SPEZIFIZIERT
         BNE   SFEHLNDA                NEIN
         AH    R3,TRKCNTSU             R3 = FREE TRKS + ALLOC. TRKS
         CVD   R3,DBLWORD              DRUCKAUFBEREITEN
         UNPK  XSUM,DBLWORD                SUMME FREE + ALLOC.
         OI    XSUM+4,X'F0'                TRACKS
         L     R2,TCANDCAP-4(R4)       CAPACITY IN TRACKS
         BCTR  R2,0                        - 1
         CVD   R2,DBLWORD              DRUCKAUFBEREITEN
         UNPK  XCAP,DBLWORD                CAPACITY
         OI    XCAP+4,X'F0'                IN TRACKS
         SR    R2,R3                   CAPACITY - SUMME FREE / ALLOC.
         BM    DUPLCUSE                    IST KLEINER NULL
         MVC   XTEXT,=CL16'TRACKS LOST.'
         B     SFHLLINE
DUPLCUSE EQU   *
         MVC   XTEXT,=C'DUPLICATE USAGE.'
SFHLLINE EQU   *
         PUT   SYSFEHL,XLINE           DSCB5-FEHLERZEILE
         EJECT
SFEHLNDA EQU   *
         BAL   14,SETZRC12             RC = 12
         MVC   TSTERN1A(2),BLANKS      LOESCHEN TSTERN1A/B,
         MVI   TSTERN2,C' '                TSTERN2
VOLFZ3   EQU   *
         LH    R3,DS4DSREC             ANZAHL BLANK DSCBS
         CVD   R3,DBLWORD                  DRUCKAUFBEREITEN
         UNPK  TTRACKS,DBLWORD
         OI    TTRACKS+4,X'F0'
         CLI   TTRACKS,C'0'            TRACKS <= 9999
         BNE   AUSGTXT3                NEIN
         MVI   TTRACKS,C' '            LOESCHEN 1. FUEHRENDE NULL
AUSGTXT3 EQU   *
         MVC   TTEXT,=C'FREE DSCBS      '
         PUT   SYSOUT,TLINE            AUSGEBEN VOL-FUSSZEILE 3
         AP    LINENO,=P'3'            ERHOEHEN ZEILENZAEHLER UM 3
         MVI   VOLKPFDA,X'00'          LOESCHEN SCHALTER VOLKOPF VORH.
RTRNVOLF EQU   *
         L     R14,SAVE2R14
         BR    14
         EJECT
***********************************************************************
*                                                                     *
*      UNTERPROGRAMM AUSGEBEN BAY001I AUF NEUER SEITE.                *
*                                                                     *
***********************************************************************
         SPACE 3
EDTPLINE EQU   *
         ST    R14,SAVE1R14
         TM    PMFLAG,PM1PARM          ERSTER PARAMETER
         BZ    *+10                    NEIN
         ZAP   LINENO,=P'80'           SETZEN SEITENWECHSEL
         MVC   ZLINE(19),=C'0BAY001I FUNCTION: '
         LR    R3,R1                   LAENGENSCHLUESSEL
         BCTR  R3,0                        MVC
         EX    R3,MVCPRM               EINTRAGEN PARAMETER NACH BAY001I
         BAL   14,PRINT                BENUTZEN ZLINE FUER BAY001I
         L     R14,SAVE1R14
         BR    14
         SPACE 3
***********************************************************************
*                                                                     *
*      UNTERPROGRAMM DRUCKAUFB. RC UND AUSGEBEN FLINE.                *
*                                                                     *
***********************************************************************
         SPACE 3
EDITRC   EQU   *
         ST    R14,SAVE3R14
         CVD   R15,DBLWORD             DRUCKAUFBEREITEN
         UNPK  FRC,DBLWORD                 RUECKKERKODE
         OI    FRC+1,X'F0'
         MVC   ZLINE+1(120),FLINE+1    FEHLERNACHRICHT
         BAL   14,PRINT                    AUSGEBEN
         L     R14,SAVE3R14
         BR    14
         EJECT
***********************************************************************
*                                                                     *
*      UNTERPROGRAMM SETZEN RC = 12.                                  *
*                                                                     *
***********************************************************************
         SPACE 3
SETZRC12 EQU   *
         ST    R14,SAVE3R14
         CLC   RC,=C'12'               RC >= 12
         BNL   RTRNRC12                JA
         MVC   RC,=C'12'               NEIN - RC = 12
RTRNRC12 EQU   *
         L     R14,SAVE3R14
         BR    14
         EJECT
***********************************************************************
*                                                                     *
*      WARNUNG BEI PARAMETERN 'ALL', 'SYSDA' , 'INDEX' UND 'SYS'.     *
*                                                                     *
***********************************************************************
         SPACE 3
WARNING  EQU   *
         ST    R14,SAVE1R14
         WTO   '        ******************************************',   *
               ROUTCDE=(1,2,4),DESC=6
         WTO   '        *  WARNING --- SUPERSCRATCH --- WARNING  *',   *
               ROUTCDE=(1,2,4),DESC=6
         XC    WTORECB,WTORECB
         WTOR  '      ******************************************',     *
               WRNGANTW,2,WTORECB,                                     *
               ROUTCDE=(1,2,4),DESC=6
         EJECT
         WAIT  ECB=WTORECB
         OC    WRNGANTW,BLANKS         -> GROSSBUCHSTABEN
         CLC   WRNGANTW,=C'GO'         REPLY = 'GO'
         BE    RTRNWRNG                JA
         MVC   ZLINE+1(30),=C'BAY042I WARNING-REPLY NOT ''GO'''
         BAL   14,PRINT                BENUTZEN ZLINE FUER BAY042I
         CLC   RC,=C'04'               RC >= 4
         BNL   ENDPMWRK                JA
         MVC   RC,=C'04'               NEIN - RC = 4
         B     ENDPMWRK                NAECHSTER PARAMETER
RTRNWRNG EQU   *
         L     R14,SAVE1R14
         BR    14
         EJECT
***********************************************************************
*                                                                     *
*      UNTERPROGRAMM NACHRICHTEN-AUSGABE.                             *
*                                                                     *
***********************************************************************
         SPACE 3
PRINT    EQU   *
         ST    R14,SAVE4R14
         CP    LINENO,=P'58'           ZEILENZAEHLER > 58
*                                      P'58' IST SO BEMESSEN, DASS BEI
*                                      VOLID-WECHSEL & SEITENENDE DIE
*                                      3 VOL-FUSSZEIL. NOCH PLATZ HABEN
         BNH   DRKZLINE                NEIN
         AP    PAGENO,=P'1'            JA - NEUE SEITE
         UNPK  ZPAGENO,PAGENO          DRUCKAUFBEREITEN
         OI    ZPAGENO+3,X'F0'             SEITENNUMMER
         PUT   SYSOUT,KLINE            UEBERSCHRIFT-1
         PUT   SYSOUT,BLINE            UEBERSCHRIFT-2
         ZAP   LINENO,=P'4'            ZEILENZAEHLER = 4
         MVI   ZVORS,C'0'
DRKZLINE EQU   *
         AP    LINENO,=P'1'            ERHOEHEN ZEILENZAEHLER UM 1
         CLI   ZLINE,C'0'              LEERZEILE VORM DRUCKEN
         BNE   PRINTZ                  NEIN - ZEILENZ BLEIBT UM 1 ERH.
         AP    LINENO,=P'1'            JA - ZEILENZ. IST UM 2 ERHOEHT
PRINTZ   EQU   *
         PUT   SYSOUT,ZLINE            DATEIZEILE
         MVC   ZLINE,BLANKS            LOESCHEN ZLINE
         L     R14,SAVE4R14
         BR    14
         EJECT
***********************************************************************
*                                                                     *
*      UNTERPROGRAMM VOLID-PRUEFUNG.                                  *
*                                                                     *
***********************************************************************
         SPACE 3
PRFVOLID EQU   *
         USING UCB,R8
         TM    UCB+17,X'08'            VIRTUAL DEVICE ?
         BO    PRFVVOL                 JA
         LA    R2,6                    INDEX
         LA    R3,SPEZVOL              ADRESSE SPEZIFIZIERTES VOLID
         LA    R4,SRTEVOLI             ADRESSE UCB VOLID
VOLSCHLF EQU   *
         CLI   0(R3),C'*'              LFD. STELLE SPEZ. VOL = D'C
         BE    VOLIERH                 JA
         CLC   0(1,R3),0(R4)           VERGL. LFD. ST. VOL SPEZ. / UCB
         BNE   VOLRC4                  UNGLEICH
VOLIERH  EQU   *
         LA    R3,1(R3)                ADRESSEN
         LA    R4,1(R4)                    NAECHSTE STELLE
         BCT   R2,VOLSCHLF             SCHLEIFE ABGEARBEITET
         SR    R15,R15                 JA - RC = 0 (GLEICH)
         B     VOLRTRN
PRFVVOL  EQU   *
         SR    R15,R15                 JA - RC = 0 (GLEICH)
         CLC   SPEZVOL,SRTEVOLI        VERGL. VOLID'S
         BE    VOLRTRN
VOLRC4   EQU   *
         LA    R15,4                   RC = 4 (UNGLEICH)
VOLRTRN  EQU   *
         BR    14
         DROP  R8
         EJECT
***********************************************************************
*                                                                     *
*      ARBEITSSPEICHERBEREICH.                                        *
*                                                                     *
***********************************************************************
         SPACE 3
PMSTAADR DC    F'0'          PARAMETER CHAIN START ADDRESS
PMWRKLEN DC    F'0'          PARAMETER CHAIN WORK LENGTH
PMOUTLEN DC    F'0'          PARAMETER CHAIN OUTPUT LENGTH
PMRETADR DC    F'0'          SAVE AREA RETURN ADDRESS
PMRETAD1 DC    F'0'          SAVE AREA RETURN ADDRESS
PMFDCHAR DC    C' '          CHARACTER FROM TRTKOMMA
PMFLAG   DC    X'00'         FLAG BYTE
PM1PARM  EQU   B'10000000'   FIRST PARAMETER
PMN1PARM EQU   B'01111111'   NOT FIRST PARAMETER
PMLIB    EQU   B'01000000'   PARMLIB
PMTABEND EQU   B'00100000'   ENDE TABRETN2
HALBWORT DC    H'0'          ZW-WERT
DBLWORD  DC    D'0'          ZW-WERT ALLGEMEIN, PARAMETER UP CONV1
DBLWORD1 DC    D'0'          ZW-WERT UP CONV1
PARMADDR DS    F             ADRESSE PARM-PARAMETER
TIOTADDR DS    F             ADRESSE TASK I/O-TABLE
UCBADDR  DC    F'0'          CURRENT UCB
UCBLOOKA DS    F             UCB LOOKUP TABLE POINTER- AUSGANGSST.
UCBLOOK  DS    F             LFD. UCB LOOKUP TABLE POINTER
SAVE1R14 DS    F             SAVE R14 (NXTVOL, DEVICEOK, NXTDSCB,
*                                      VRBDSCB1, DISP, SCRATCH,
*                                      EDTPLINE)
SAVE2R14 DS    F             SAVE R14 (GETTRKS, EDTZLINE, VOLFUSS)
SAVE3R14 DS    F             SAVE R14 (EDITRC, SETZRC12)
SAVE4R14 DS    F             SAVE R14 (PRINT)
DATE     DC    F'0'          DATUM BINAER (JTTX)
JOBNAME  DC    CL8' '        JOBNAME
JOBDATUM DC    CL8'SYS'      SYSJJTTT
         SPACE 1
PRMDA    DC    XL1'00'       SCHALTER STEUERPARAMETER:
*                                X'01' - PARM-ANGABE VORHANDEN
*                                X'02' - SYSIN SPEZIFIZIERT
*                                X'04' - KONSOL-EINGABE IST ERFOLGT
         SPACE 1
ZUSTAND  DC    CL1'A'        A - JOBANFANG
*                            P - PARM
*                            S - SYSIN
*                            C - CON
*                            E - JOBENDE
*                            I - INDEX-TABELLE
         SPACE 1
SPEZDSN  DC    CL44' '       DSNAME SPEZIFIZIERT IN PARAMETER
SPEZVOL  DC    CL6' '        VOLID SPEZIFIZIERT IN PARAMETER
SPEZDATE DC    CL3' '        DATE SPEZ. IN PRM UMGEWANDELT IN X'JJ0TTT'
         EJECT
INDEXLNG DC    H'0'          LAENGE INDEX
INDEXNM  DS    CL9           DSN AUS INDEX-PARAMETER + PUNKT
         SPACE 1
LISTPRM  DC    XL1'00'       X'01' - LIST × LIST=ALL
*                            X'02' - LIST=<VOLID>
*                            X'04' - LIST=STORAGE (MASKE TM SRTESTAB)
*                            X'08' - LIST=PUBLIC  (MASKE TM SRTESTAB)
*                            X'10' - LIST=PRIVATE (MASKE TM SRTESTAB)
         SPACE 1
KART0171 DS    CL71          SYSIN-KARTE SPALTE 1 - 71
SPALTE72 DS    CL1               SPALTE 72
         DS    CL8               REST SYSIN-KARTE
         SPACE 1
ANTWORT  DS    CL115         KONSOL-EINGABE
WRNGANTW DS    CL2           ANTWORT AUF WARNING
TESTANTW DS    CL3           ANTWORT AUF BAY0002D (PARAMETER TEST)
EOT      DC    XL1'00'       SCHALTER EOT (END OF PARAMETER 'TEST')
VOLKPFDA DC    XL1'00'       SCHALTER VOLKOPF VORHANDEN => VOLFUSS
DISPLBYT DS    CL1           DISPLACEMENT FUER B BMARKE
DSCBENDE DC    XL1'00'       SCHALTER DSCB-ENDE
RETAINSW DC    XL1'00'       SCHALTER RETAIN
DSCB4DA  DC    XL1'00'       SCHALTER DSCB 4
DURCHLF  DC    CL1'1'        SCHALTER DURCHLAUF
SFEHLDA  DC    XL1'01'       SCHALTER SYSFEHL VORHANDEN (GESETZT)
RC       DC    CL02'00'      RUECKKEHRKODE FUER JOBENDE-NACHRICHT
SVCCHHR  DC    CL5' '        SAVE CCHHR
SVUNIT   DC    CL3'   '      SAVE UNIT
DVTYP    DC    CL1' '        EINHEITENTYP
         EJECT
TRKCNT   DC    H'0'          SPUR-ZAEHLER
TRKA     DC    H'0'          SPUR-VON
TRKB     DC    H'0'          SPUR-BIS
EXTCNT   DC    H'0'          EXTENT-ZAEHLER
TRKCNTSU DC    H'0'          ALLOCATED TRACKS
FREETRKS DC    H'0'          ZAEHLER FREE TRACKS (MAX. 19600)
         SPACE 1
KETTE5   DS    F             5 BYTES AUF WORTGRENZE
         DC    XL1'04'           FUER DRUCKEN R0, R1
BLANKS   DC    CL121' '      121 LEERZEICHEN
         SPACE 1
CYLNO    DC    H'0'          ZYLINDER-NUMMER
TRACKNO  DC    H'0'          SPUR-NUMMER
RECNO    DC    H'0'          SATZ-NUMMER
MTRACKNO DC    H'0'          DS4DEVSZ+2 (MAX TRACK ADDR)
MRECNO   DC    H'0'          DS4DEVT (MAX RECORD ADDR)
         SPACE 1
LINENO   DC    PL4'99'       ZEILENZAEHLER
PAGENO   DC    PL4'0'        SEITENZAEHLER
LINETRKS DC    CL6'  0000'   SPUR-ZAEHLER DRUCKAUFB. (ZLINE ZW-BEREICH)
LINEEXTS DC    CL2'00'       EXTENT-ZAEHLER DRUCKAUFB. (ZLINE ZW-BER.)
TRKMASK  DC    XL6'402120202020' MASKE FUER LINETRKS, ZUSED
WTORECB  DC    F'0'          ECB FOR WTOR
         EJECT
TCANDCAP DS    0F            TRACKS PER CYLINDER AND CAPACITY IN TRACKS
         DC    A(10,2000)    01-2311   DISK STORAGE DEVICE
         DC    A(8,200)      02-2301   PARALLEL DRUM
         DC    A(10,800)     03-2303   SERIAL DRUM
         DC    A(46,11316)   04-2302   DISK STORAGE
         DC    A(20,19600)   05-2321   DATA CELL DRIVE
         DC    A(8,384)      06-2305/1 FIXED HEAD STORAGE / MODEL 1
         DC    A(8,768)      07-2305/2 FIXED HEAD STORAGE / MODEL 2
         DC    A(20,4000)    08-2314   DISK STORAGE FACILITY
         DC    A(19,7676)    09-3330/1 DISK STORAGE / MODEL 1
         DC    A(12,8352)    0A-3340   DISK STORAGE
         DC    A(30,16650)   0B-3350   DISK STORAGE
         DC    A(0,0)        0C-RESERVED
         DC    A(19,15352)   0D-3330/11 DISK STORAGE / MODEL 11
         SPACE 1
UNITTYP  EQU   *             EINHEITENTYPEN (S. AUCH TCANDCAP)
         DC    CL4'2311'     01
         DC    CL4'2301'     02
         DC    CL4'2303'     03
         DC    CL4'2302'     04
         DC    CL4'2321'     05
         DC    CL4'2305'     06
         DC    CL4'2305'     07
         DC    CL4'2314'     08
         DC    CL4'3330'     09
         DC    CL4'3340'     0A
         DC    CL4'3350'     0B
         DC    CL4'XXXX'     0C
         DC    CL4'3330'     0D
         EJECT
TABRETN2 DS    0F            GESCHUETZTE FIRST INDEX LEVEL
         DC    AL1(5),CL9'BAYER.'
         DC    AL1(3),CL9'CMD.'
         DC    AL1(3),CL9'IMS.'
         DC    AL1(5),CL9'IMSVS.'
         DC    AL1(6),CL9'IMSVS1.'
         DC    AL1(5),CL9'IMS0P.'
         DC    AL1(3),CL9'OCR.'
         DC    AL1(8),CL9'PASSWORD.'
         DC    AL1(3),CL9'SMP.'
         DC    AL1(4),CL9'SYS1.'
         DC    AL1(3),CL9'TSO.'
RESERVE1 DC    AL1(0),CL9' ' RESERVE 1
         DC    AL1(0),CL9' ' RESERVE 2
         DC    AL1(0),CL9' ' RESERVE 3
         DC    AL1(0),CL9' ' RESERVE 4
         DC    AL1(0),CL9' ' RESERVE 5
         DC    AL1(0),CL9' ' RESERVE 6
         DC    AL1(0),CL9' ' RESERVE 7
         DC    AL1(0),CL9' ' RESERVE 8
         DC    AL1(0),CL9' ' RESERVE 9
         DC    AL1(0),CL9' ' RESERVE 10
         DC    AL1(0),CL9' ' RESERVE 11
         DC    AL1(0),CL9' ' RESERVE 12
         DC    AL1(0),CL9' ' RESERVE 13
         DC    AL1(0),CL9' ' RESERVE 14
         DC    AL1(0),CL9' ' RESERVE 15
         DC    AL1(0),CL9' ' RESERVE 16
         DC    AL1(0),CL9' ' RESERVE 17
         DC    AL1(0),CL9' ' RESERVE 18
         DC    AL1(0),CL9' ' RESERVE 19
RESERVEX DC    AL1(0),CL9' ' RESERVE 20
         DC    AL1(0)        TABELLEN-ENDE, WENN RESERVE 1 - 20 BENUTZT
         SPACE 1
ADDRRES1 DC    A(RESERVE1)
ADDRRESX DC    A(RESERVEX)
         EJECT
***********************************************************************
*                                                                     *
*      ANLAGEN-TABELLE UND TABELLE MIT WORK-DASD ADRESSEN.            *
*                                                                     *
***********************************************************************
         SPACE 3
TABANLGE DS    0F
         DC    C'A168',A(TABA168)
         DC    C'B168',A(TABB168)
         DC    C'C168',A(TABC168)
         DC    C'E158',A(TABE158)
         DC    C'M168',A(TABM168)
TABENDE  DC    C'XXXX',A(0)  TABELLEN-ENDE
         SPACE 1
TABA168  EQU   *
TABB168  EQU   *
         DC    C'100 101 102 103 108 109 10A 10B '
         DC    C'150 151 152 153 158 159 15A 15B '
         DC    C'190 191 192 193 198 199 19A 19B '
         DC    C'1C0 1C1 1C2 1C3 1C8 1C9 1CA 1CB '
         DC    C'2C0 2C1 2C2 2C3 2C8 2C9 2CA 2CB '
         DC    C'2E0 2E1 2E2 2E3 2E8 2E9 2EA 2EB '
         DC    C'6E0 6E1 6E2 6E3 6E8 6E9 6EA 6EB '
         DC    C'7C0 7C1 7C2 7C3 7C8 7C9 7CA 7CB '
         DC    C'XXXX'       TABELLEN-ENDE
TABC168  EQU   *
TABE158  EQU   *
         DC    C'104 105 10C 10D '
         DC    C'154 155 15C 15D '
         DC    C'194 195 19C 19D '
         DC    C'1C4 1C5 1CC 1CD '
         DC    C'2C4 2C5 2CC 2CD '
         DC    C'2E4 2E5 2EC 2ED '
         DC    C'6E4 6E5 6EC 6ED '
         DC    C'7C4 7C5 7CC 7CD '
         DC    C'8E4 8E5 8EC 8ED '
         DC    C'XXXX'       TABELLEN-ENDE
TABM168  EQU   *
         DC    C'XXXX'       TABELLEN-ENDE
         EJECT
TRTAB    DC    CL16'0123456789ABCDEF' TR-TABELLE FUER HEXA-DRUCKEN
         SPACE 2
TABKOMMA DS    0CL256
         DC    64X'00'
         DC    C' '
         DC    42X'00'
         DC    C','
         DC    148X'00'
         SPACE 2
TABCHAR  DS    0CL256
         DC    193X'FF'
         DC    X'00'         BUCHSTABE A - B BMARKE
         DC    X'FF'
         DC    X'04'         BUCHSTABE C - B BMARKE+4
         DC    X'08'         BUCHSTABE D - B BMARKE+8
         DC    X'0C'         BUCHSTABE E - B BMARKE+12
         DC    3X'FF'
         DC    X'10'         BUCHSTABE I - B BMARKE+16
         DC    9X'FF'
         DC    X'14'         BUCHSTABE L - B BMARKE+20
         DC    2X'FF'
         DC    X'18'         BUCHSTABE O - B BMARKE+24
         DC    X'1C'         BUCHSTABE P - B BMARKE+28
         DC    10X'FF'
         DC    X'20'         BUCHSTABE S - B BMARKE+32
         DC    X'24'         BUCHSTABE T - B BMARKE+36
         DC    X'28'         BUCHSTABE U - B BMARKE+40
         DC    27X'FF'
         EJECT
***********************************************************************
*                                                                     *
*      EX-MARKEN.                                                     *
*                                                                     *
***********************************************************************
         SPACE 3
TRTKOMMA TRT   0(0,R5),TABKOMMA        SUCHEN NACH KOMMA
MVCDSN   MVC   SPEZDSN(0),14(R2)       UEBERTRAGEN DSN AUS PURGE-PRM
MVCINDNM MVC   INDEXNM(0),6(R2)        UEBERTRAGEN DSN-ANFANG AUS
*                                          INDEX-PARAMETER
MVCUDSN  MVC   SPEZDSN(0),8(R2)        UEBERTRAGEN DSNAME AUS UNCATLG-
*                                          PARAMETER
MVCPRM   MVC   ZLINE+19(0),0(R2)       EINTRAGEN PARAMETER NACH BAY001I
MVCPRM2  MVC   UNPRM(0),0(R2)          EINTRAGEN PARAMETER IN BAY081I
MVC1INDT MVC   1(0,R3),0(R2)           1. INDEX PARMLIB -> TABRETN2
MVC1INDF MVC   PLPRM(0),0(R2)          1. INDEX PARMLIB -> FEHLERNACHR.
CLCINDNM CLC   INDEXNM(0),DS1DSNAM     SOLL DATEI GELOESCHT WERDEN
VGL1INDX CLC   DS1DSNAM(0),1(R2)       VERGLEICHEN DSN-ANFANG MIT
*                                          GESCHUETZTEM INDEX
         EJECT
***********************************************************************
*                                                                     *
*      DCB-DEFINITIONEN.                                              *
*                                                                     *
***********************************************************************
         SPACE 3
SYSIN    DCB   DDNAME=SYSIN,MACRF=(GM),EODAD=PRMENDE,DSORG=PS,         *
               RECFM=FB,LRECL=80
PARMLIB  DCB   DDNAME=PARMLIB,MACRF=(GM),EODAD=TABIENDE,DSORG=PS,      *
               RECFM=FB,LRECL=80
SYSOUT   DCB   DDNAME=SYSPRINT,MACRF=(PM),DSORG=PS,                    *
               EXLST=EXITLIST,                                         *
               RECFM=FBA,LRECL=121
SYSFEHL  DCB   DDNAME=SYSDIAG,MACRF=(PM),DSORG=PS,                     *
               EXLST=EXITLIST,                                         *
               RECFM=FBA,LRECL=121
         SPACE 4
***********************************************************************
*                                                                     *
*      DCB EXIT-ROUTINE.                                              *
*                                                                     *
***********************************************************************
         SPACE 3
EXITLIST DS    0F                      DCB EXIT LISTE
         DC    XL01'85'
         DC    AL03(DCBEXIT)
SAVE1R4  DC    3F'0'                   SAVEAREA FUER R4, R5, R6
         SPACE 1
DCBEXIT  EQU   *                       ROUTINE ZUM ERGAENZEN DES DCB
         STM   R4,R6,SAVE1R4           R4, R5, R6 SICHERN
         LH    R4,62(R1)               BLKSIZE LADEN
         LTR   R4,R4                   BLKSIZE = 0 ?
         BZ    SETBLKSZ                JA, VERZWEIGEN
         SRDA  R4,32                   R4 --> R5
         LH    R6,82(R1)               LRECL LADEN
         DR    R4,R6                   DIV. BLKSIZE / LRECL
         LTR   R4,R4                   BLKSIZE = X * LRECL ?
         BZ    EXITRTN                 JA, VERZWEIGEN
SETBLKSZ EQU   *
         MVC   62(2,R1),82(R1)         BLKSIZE = LRECL
EXITRTN  EQU   *
         LM    R4,R6,SAVE1R4           R4, R5, R6 REINITIALISIEREN
         BR    14                      RUECKKEHR ZUR OPENROUTINE
         EJECT
***********************************************************************
*                                                                     *
*      DSCB-DEFINITIONEN.                                             *
*                                                                     *
***********************************************************************
         SPACE 3
*
*   FORMAT 1
*
         SPACE 1
         DS    0D
DSCB1    DS    0CL140
DS1DSNAM DS    CL44          DATA SET NAME
DS1FMTID DS    CL1           DSCB FORMAT
         DS    CL8
DS1CREDT DS    CL3           CREATION DATE
DS1EXPDT DS    CL3           EXPIRATION DATE
         DS    CL23
DS1DSORG DS    CL2           DATA SET ORGANIZATION
         DS    CL9
DS1DSIND DS    CL1           DATA SET INDICATORS
         DS    CL4
DS1LSTAR DS    CL3           LAST BLOCK POINTER (TTR
DS1TRBAL DS    CL2                               LL)
         DS    CL2
DS1EXT1  DS    3CL10         EXTENT DESCRIPTIONS 1 - 3
*              BYTE 1   :    DATA SET EXTENT TYPE INDICATOR
*              BYTE 2   :    EXTENT SEQUENCE NUMBER
*              BYTE 3-6 :    CCHH - LOWER LIMIT OF THIS EXTENT
*              BYTE 7-10:    CCHH - UPPER LIMIT OF THIS EXTENT
DS1PTRDS DS    CL5           DIRECT-ACCESS ADDRESS OF NEXT DSCB
         SPACE 2
*
*   FORMAT 2
*
         SPACE 1
         DS    0D
DSCB2    DS    0CL140
         DS    CL44
DS2FMTID DS    CL1           DSCB FORMAT
         DS    CL90
DS2PTRDS DS    CL5           POINTER TO DSCB 3 IF ONE IS NEEDED
         EJECT
*
*   FORMAT 3
*
         SPACE 1
         DS    0D
DSCB3    DS    0CL140
         DS    CL4
DS3EXTNT DS    4CL10         4 EXTENT DESCRIPTIONS
DS3FMTID DS    CL1           DSCB FORMAT
         DS    CL95
         SPACE 2
*
*   FORMAT 4
*
         SPACE 1
         DS    0D
DSCB4    DS    0CL140
         DS    CL45
DS4HPCHR DS    CL5           HIGHEST DISK ADDRESS OF DSCB
DS4DSREC DS    CL2           AVAILABLE FORMAT 0 DSCBS IN VTOC
         DS    CL10
DS4DEVSZ DS    CL4           NO. OF LOGICAL CYLINDERS OR NO. OF TRACKS
         DS    CL8
DS4DEVDT DS    CL1           NO. OF DSCB'S ON A TRACK
         DS    CL30
DS4VTOCE DS    CL10          VTOC EXTENT
         DS    CL25
         SPACE 2
*
*   FORMAT 5
*
         SPACE 1
         DS    0D
DSCB5    DS    0CL140
         DS    CL4
DS5AVEXT DS    CL5
*              BYTE 1-2 :    RELATIVE TRACK ADDRESS
*              BYTE 3-4 :    EMPTY CYLINDERS
*              BYTE 5   :    UNUSED TRACKS
DS5EXTAV DS    7CL5          EXTENT 2 - 8
DS5FMTID DS    CL1           FORMAT ID
DS5MAVET DS    18CL5         EXTENT 9 - 26
DS5PTRDS DS    CL5           CCHHR ADDRESS OF NEXT DSCB 5
         EJECT
***********************************************************************
*                                                                     *
*      CAMLIST-MAKROS.                                                *
*                                                                     *
***********************************************************************
         SPACE 3
*
*   OBTAIN
*
         SPACE 1
CAMOBT   CAMLST SEEK,CCHHR,VOLUMSER,WORKFLD
CCHHR    DC    XL5'0'
VOLUMSER DC    CL6' '
         DS    0D
WORKFLD  DS    2CL175
*        RC=4  THE REQUIRED VOLUME WAS NOT MOUNTED
*        RC=8  THE DSCB WAS NOT FOUND IN THE VTOC OF THE SPEC. VOLUME
*        RC=12 A PERMANENT I/O ERROR WAS FOUND WHEN PROCESSING THE
*              SPECIFIED VOLUME
*        RC=16 INVALID WORK AREA POINTER
*        RC=20 CCHH NOT WITHIN BOUNDERIES OF VTOC EXTENT
         EJECT
*
*   UNCATALOG
*
         SPACE 1
CAMCAT   CAMLST UNCAT,DSNAME
*        RC=4  REQUIRED CONTROL VOLUME NOT MOUNTED OR SPECIFIED
*              VOLUME DOES NOT CONTAIN SYSCTLG
*        RC=8  THE EXISTING CATALOG STRUCTURE IS INCONSISTENT WITH THE
*              OPERATION PERFORMED
*        RC=12 NOT USED WITH THE CATALOG MACRO
*        RC=16 THE INDEX STRUCTURE NECESSARY TO CATALOG THE DATA SET
*              DOES NOT EXIST
*       (RC=20 SPACE IS NOT AVAILABLE ON THE SPECIFIED CONTROL VOLUME)
*        RC=24 AN ATTEMPT WAS MADE TO CATALOG AN IMPROPERLY NAMED
*              GENERATION DATA SET
*        RC=28 A PERMANENT I/O ERROR WAS FOUND WHEN PROCESSING THE
*              CATALOG
         EJECT
*
*   SCRATCH
*
         SPACE 1
CAMSCR   CAMLST SCRATCH,DSNAME,,VOLIST,,OVRD
DSNAME   DS    CL44
VOLIST   DC    H'1'
         DC    X'00000000'   DEVICE TYPE
         DC    CL6' '        VOLUME SERIAL NUMBER
         DC    H'0'
*        RC=4  NO VOLUMES CONTAINING ANY PART OF THE DATA SET WERE
*              MOUNTED, NOR WAS A UCB ADDRESS CONTAINED IN R0
*        RC=8  AN UNUSUAL CONDITION WAS ENCOUNTERED ON 1 OR MORE VOLS
         EJECT
***********************************************************************
*                                                                     *
*      NACHRICHTEN-DEFINITIONEN.                                      *
*                                                                     *
***********************************************************************
         SPACE 3
*
*   VOL-KOPFZEILE
*
         SPACE 1
DLINE    DS    0CL121
         DC    CL01'0'
         DC    CL02' '
         DC    CL05'UNIT='
DUNIT    DS    CL03
         DC    CL05',VOL='
DUNITTYP DS    CL04
         DC    CL01'='
DVOLID   DS    CL06
         DC    CL94' '
         SPACE 2
*
*   DATEIZEILE
*
         SPACE 1
ZLINE    DS    0CL121
         DC    121C' '
         ORG   ZLINE
ZVORS    DS    CL01
ZDSNAME  DS    CL44
         DS    CL02
ZTRACKS  DS    CL06          (BERECHNET IM FELD LINETRKS)
         DS    CL01
ZUSED    DS    CL06
         DS    CL04
ZEXTENTS DS    CL02
         DS    CL04
ZTYP     DS    CL02
         DS    CL02
ZCREDAT  DS    CL06
         DS    CL03
ZPURDAT  DS    CL06
         DS    CL02
ZACTION  DS    CL07
         DS    CL03
ZREASON  DS    CL20
         EJECT
*
*   VOL-FUSSZEILEN
*
         SPACE 1
TLINE    DS    0CL121
         DC    CL01' '
         DC    CL04' '
TTEXT    DS    CL16          ALLOC. TRACKS / FREE TRACKS / FREE DSCBS
         DC    CL26' '
TSTERN1A DC    CL01' '
TTRACKS  DS    CL05
TSTERN2  DC    CL01' '
         DC    CL67' '
         SPACE 2
*
*   SYSFEHL-LISTENKOPF
*
         SPACE 1
XKOPF    DS    0CL121
         DC    CL01'1'
         DC    CL40'DIAGNOSTICS: WARNING - INFORMATION MAY B'
         DC    CL40'E MEANINGLESS DUE TO MULTIPROGRAMMING IN'
         DC    CL40' PROGRESS.'
         SPACE 2
*
*   DSCB5-FEHLERZEILE
*
         SPACE 1
XLINE    DS    0CL121
         DC    CL01'0'
         DC    CL08'BAY124I '
         DC    CL04'VOL='
XUNITTYP DS    CL04
         DC    CL01'='
XVOLID   DS    CL06
         DC    CL29' DSCB-5 INCORRECT. ALLOCATED '
XALLOC   DS    CL05
         DC    CL07', FREE '
XFREE    DS    CL05
         DC    CL06', SUM '
XSUM     DS    CL05
         DC    CL02' ('
XCAP     DS    CL05
         DC    CL05'). - '
XTEXT    DS    CL16          TRACKS LOST. / DUPLICATE USAGE.
         DC    CL12' '
         EJECT
*
*   FEHLERNACHRICHT BAY121I
*
         SPACE 1
FLINE    DS    0CL121
         DC    CL01' '
         DC    CL08'BAY121I '
FMAKRO   DS    CL07
         DC    CL04'-RC='
FRC      DS    CL02
FR0TEXT  DC    CL05' '       CATALOG: ', R0='
FR0      DC    CL08' '       CATALOG: R0-INHALT HEX-DRUCKAUFBEREITET
FR1TEXT  DC    CL05' '       CATALOG: ', R1='
FR1      DC    CL08' '       CATALOG: R1-INHALT HEX-DRUCKAUFBEREITET
         DC    CL73' '
         SPACE 2
*
*   FEHLERNACHRICHT BAY081I
*
         SPACE 1
         DS    0F
UNMSG    EQU   *
UNLAENGE DC    AL02(UNMSGEND-UNMSG)
         DC    XL02'8000'    MCSFLAG FIELD
         DC    CL27'BAY081I PARAMETER INVALID: '
UNPRM    DS    CL93
UNMSGEND EQU   *
UNDRCODE DC    XL04'0400D000' DESC=6,ROUTCDE=(1,2,4)
         SPACE 2
*
*   FEHLERNACHRICHT BAY082I
*
         SPACE 1
         DS    0F
PLMSG    EQU   *
PLLAENGE DC    AL02(PLMSGEND-PLMSG)
         DC    XL02'8000'    MCSFLAG FIELD
         DC    CL35'BAY082I PARMLIB-PARAMETER INVALID: '
PLPRM    DS    CL72
PLMSGEND EQU   *
PLDRCODE DC    XL04'0400D000' DESC=6,ROUTCDE=(1,2,4)
         EJECT
*
*   UEBERSCHRIFT-1
*
         SPACE 1
KLINE    DS    0CL121
         DC    CL01'1'
ZDATE    DS    CL06
         DC    35C' '
         DC    CL35'SYSTEM SUPPORT UTILITIES - BAYPROGM'
         DC    35C' '
         DC    CL05'PAGE '
ZPAGENO  DS    CL04
         SPACE 2
*
*   UEBERSCHRIFT-2
*
         SPACE 1
BLINE    DS    0CL121
         DC    CL01'-'
         DC    CL40'------------------ DSNAME --------------'
         DC    CL40'----   TRACKS  USED EXTENTS TYPE CREATED'
         DC    CL40'   PURGE  ACTION    ------ REASON ------'
         SPACE 2
*
*   WTOR-MESSAGE FUER PARAMETER 'TEST'
*
         SPACE 1
         DS    2F
TTMSG    EQU   *
TTLAENGE DC    AL02(TTMSGEND-TTMSG)
         DC    XL02'8000'    MCSFLAGS FIELD
         DC    CL12'BAY003D DSN='
TTDSN    DS    CL44
TTMSGEND EQU   *
TTDRCODE DC    XL04'0400D000' DESC=6,ROUTCDE=(1,2,4)
         EJECT
         LTORG
         SPACE 4
LFDVPIND DC    F'0'                     LAUFENDER VP INDEX
VOLPAGE  DS    256CL10                  SPEICHER FUER VOLSER & SEITENNR
MAXVPIND EQU   (*-VOLPAGE)              MAX FUER VP INDEX
         EJECT
***********************************************************************
*                                                                     *
*      SONSTIGE KONTROLLBLOECKE (DSECTS).                             *
*                                                                     *
***********************************************************************
         SPACE 3
*
*   COMMUNICATION VECTOR TABLE
*
         SPACE 1
CVT      DSECT
CVTTCBP  DS    F             POINTER TO ADDRESS FOR NEXT & CURRENT TCB
         DS    9F
CVTILK2  DS    F             ADDR OF UCB ADDR LIST PORTION IN UCB LKUPT
         DS    3F
CVTDATE  DS    F             CURRENT DATE IN PACKED DECIMAL
         DS    CL156
         SPACE 2
*
*   TASK I/O - TABLE
*
         SPACE 1
TIOT     DSECT
TIOCNJOB DS    CL8           JOB NAME
         DS    CL16
TIOELNGH DS    CL1           LAENGE DD-ENTRY
         DS    CL3
TIOEDDNM DS    CL8           DD-NAME
         EJECT
*
*   DASD - UNIT CONTROL BLOCK
*
         SPACE 1
UCB      DSECT
         DS    CL3
SRTESTAT DS    CL1           STATUS BYTE A
         DS    CL9
UCBNAME  DS    CL3           UNIT NAME
UCBTYP   DS    CL4           DEVICE TYPE
         DS    CL4
UCBVTOC  DS    CL4           VTOC ADRESSE (MVS)
SRTEVOLI DS    CL6           VOLUME SERIAL NUMBER
SRTESTAB DS    CL1           STATUS BYTE B
         DS    CL1
SRTEFSCT DS    CL4           RELATIVE ADDR OF VTOC FOR THIS VOL (TTR0)
         DS    CL100
         SPACE 2
*
*   VEKTOR MIT GUELTIGEN UCB-ADRESSEN
*
         SPACE 1
VEKTOR   DSECT
         DS    1024H
VEKEND   DS    H             =X'FFFF'
VEKLEN   EQU   *-VEKTOR
         SPACE 2
         END   BAYPROGM
./ ADD  NAME=BEGIN
         MACRO
&NAME    BEGIN &BASE=3,&TYPE=HAPRO,&EXIT=NOT,&EQU=YES,                //
               &FLPR=NOT,&MASK='00001111',&ID=YES,&SAVE=DEFAULT,       /
               &PL1=NOT,&ENTRY=NOT,&STAE=NOT
.*
.*       USER WRITTEN MACRO
.*       PROGRAM START ROUTINE
.*
         GBLA  &CNT
         GBLB &SUBROUT,&PRVEXIT,&FLPSAVE
         GBLB  &SASTATC,&BEGIN,&PL1PROG
         GBLB  &NPREG
         LCLA  &LV,&BRG#,&I
         LCLB  &B13
         LCLC  &B(3),&NDX
&PL1PROG SETB  ('&PL1(1)' EQ 'YES')
&BRG#    SETA  N'&BASE
&SASTATC SETB  ('&SAVE' EQ 'DEFAULT' AND NOT &PL1PROG)
&SASTATC SETB  (&SASTATC OR '&SAVE' EQ 'STATIC')
&SUBROUT SETB  ('&TYPE' NE 'HAPRO' OR &BEGIN OR &PL1PROG)
&FLPSAVE SETB  ('&FLPR' EQ 'YES')
         AIF   (&PL1PROG).PL1SETB
&PRVEXIT SETB  ('&EXIT' NE 'SPIETEST' AND '&EXIT' NE 'NOT')
         AGO   .ASS
.PL1SETB ANOP
         AIF   (&FLPSAVE).PL1MN
&PRVEXIT SETB  (N'&PL1 EQ 2)
         AIF   (NOT &PRVEXIT).ASS
         AIF   ('&PL1(2)' EQ 'SPIE').ASS
&PRVEXIT SETB  0
         MNOTE 8,'PL1=&PL1 INVALID OPERAND'
         AGO   .ASS
.PL1MN   MNOTE 8,'FLPR=YES NOT ALLOWED WITH PL1=YES'
.ASS     ANOP
         AIF   ('&CNT' GT '9').CNT0
&NDX     SETC  '0'.'&CNT'
         AGO   .CNT1
.CNT0    ANOP
&NDX     SETC  '&CNT'
.CNT1    ANOP
&CNT     SETA  &CNT+1
.*
.*       CHECK FORMAT OF CSECT NAME
.*
         AIF   (T'&NAME EQ 'O').CS0
&NAME    CSECT
         AGO   .CS1
.CS0     MNOTE 8,'CSECT NAME OMITTED'
$PRIVATE CSECT
.CS1     AIF   (NOT &PL1PROG).CSX
.*
*        THIS CSECT WILL BE USED AS A SUBROUTINE TO PL1
.*
IHEQSLA  DXD   A      DECLARE EXTERNAL DUMMY SECTION FOR IHEQSLA PRV
.CSX     AIF   ('&ENTRY' EQ 'NOT').CS2
         ENTRY &ENTRY
&ENTRY  EQU   *
.CS2    AIF   (&BEGIN).C0
&BEGIN   SETB  1
.C       AIF   ('&EQU' EQ 'NOT').C0
&NPREG   SETB  1
.*
*        REGISTER EQUATES
.*
         SPACE
R0       EQU   0
R1       EQU   1
R2       EQU   2
R3       EQU   3
R4       EQU   4
R5       EQU   5
R6       EQU   6
R7       EQU   7
R8       EQU   8
R9       EQU   9
R10      EQU   10
R11      EQU   11
R12      EQU   12
R13      EQU   13
R14      EQU   14
R15      EQU   15
         SPACE 2
.*
.*       SET   BASE REGISTERS
.*
.C0      ANOP
&I       SETA  0
         AIF   ('&BRG#' LE '3').C1
         MNOTE 12,'MORE THAN 3 BASE REGISTERS SPECIFIED, MACRO IGNORED'
         USING *,3,4,5 PROVIDE ADDRESSABILITY FOR ASSEMBLY ONLY
         MEXIT
.PL1BAS  ANOP
&B(1)    SETC  'R10'
         AGO   .IDTEST
.C1      AIF   ('&BASE' EQ '3' AND &PL1PROG).PL1BAS
&I       SETA  &I+1
         AIF   ('&BASE(&I)' GE '2' AND '&BASE(&I)' LT '13').BOK
         AIF   ('&BASE(&I)' NE '13').BN13
         AIF   (&SASTATC).B13
         MNOTE 12,'BASE=13 IMPOSSIBLE WITH DYNAMIC SAVEAREA'
         AGO   .BOK
.B13     AIF   ('&I' GT '1').B13N
&B13     SETB  1
         AGO   .BOK
.B13N    MNOTE 8,'REG 13 AS A BASE REGISTER MUST BE SPECIFIED AS FIRST /
               OPERAND E.G. BASE=(13,2,3)'
         AGO   .BOK
.BN13    MNOTE 8,'REGISTER &BASE(&I) SHOULD NOT BE USED AS A BASE REGIS/
               TER'
.BOK     AIF   (NOT &PL1PROG).BOK1
         AIF   ('&BASE(&I)' NE '12').BOK1
         MNOTE 8,'REGISTER 12 SHOULD NOT BE USED IN A SUBROUTINE TO PL1/
               '
.BOK1    ANOP
&B(&I)   SETC  'R'.'&BASE(&I)'
         AIF   ('&I' LT '&BRG#').C1
.*
.*       SAVE GENERAL REGISTERS AND INITIATE BASE REGISTERS
.*
         AIF   (NOT &B13).IDTEST
         USING *,R15
.IDTEST  AIF   ('&ID' NE 'YES').ENT1
         BC    15,14(,R15) BRANCH AROUND IDENTIFIER
         DC    AL1(8) LENGTH
         AIF   (T'&NAME EQ 'O').ENTN
         DC    CL8'&NAME' CSECT NAME
         DS    0H
        AGO   .ENT1
.ENTN    DC    CL8'$PRIVATE'
         DS    0H
.ENT1    AIF   (&PL1PROG).PL1A
         STM   R14,R12,12(R13) SAVE GENERAL REGISTERS
         AGO   .ENT2
.PL1A    STM   R14,R11,12(R13) SAVE GENERAL REGISTERS
.ENT2    LR    R14,R13 SAVE OLD SAVEAREA ADDRX
         AIF   (&B13).B130
         BALR  &B(1),0 INITIATE BASE REGISTER
         USING *,&B(1) ESTABLISH ADDRESSABILITY
BASIS&NDX  DS   0H
.B130    ANOP
&LV      SETA  72
         AIF   (NOT &FLPSAVE).C2
&LV      SETA  &LV+32
.C2      AIF   (NOT &SUBROUT OR NOT &PRVEXIT).C3
&LV      SETA  &LV+4
.C3      AIF   (NOT &PL1PROG).C3X
&LV      SETA  &LV+4
.C3X     AIF   (&SASTATC).SASTAT
.*
.*       ALLOCATE SAVEAREA - DYNAMIC -
.*
         LA    R0,&LV LOAD SAVEAREA LENGTH
         BAL   R1,*+4 INDICATE GETMAIN
         SVC   10 ISSUE GETMAIN SVC
         LR    R13,R1 PROVIDE SAVEAREA ADDRESSABILITY
         XC    0(&LV,R13),0(R13) CLEAR SAVEAREA
         AGO   .SASTAT1
.*
.*       DEFINE SAVEAREA - STATIC -
.*
.SASTAT  AIF   (&FLPSAVE).CNOP48
         CNOP  0,4
         AGO   .B13AIF
.CNOP48  CNOP  4,8
.B13AIF  AIF   (&B13).B131
         B     *+4+&LV BRANCH AROUND SAVEAREA
&I       SETA  &LV/4
SAVEAR&NDX DC  &I.F'0' SAVEAREA
         LA    R13,SAVEAR&NDX LOAD SAVEAREA ADDRESS
         AGO   .SASTAT1
.B131    ANOP
         BAL   R13,*+4+&LV BRANCH AROUND SAVEAREA
         DROP  R15
BASIS&NDX  DS   0H
         USING *,R13 ESTABLISH ADDRESSABILITY
&I       SETA  &LV/4
SAVEAR&NDX DC  &I.F'0' SAVEAREA
.*
.*      SAVEAREA CHAIN AND FURTHER BASE REGISTERS
.*
.SASTAT1 AIF   (NOT &FLPSAVE).C30
         OI    0(R13),255 INDICATE EXTENDED SAVEAREA
.C30      AIF  (NOT &PL1PROG).C3Y
         MVI   0(R13),128 SET PL1 FLAGS
         MVI   3(R13),72 IN 1ST WORD OF SA
.C3Y     ST    R14,4(,R13) PROVIDE SAVE-
         ST    R13,8(,R14) AREA CHAINING
         AIF   ('&BRG#' EQ '1').C5
         LA    R1,2048 INITIATE FURTHER BASE REGISTERS
&I       SETA  1
.C4      LA    &B(&I+1),2048(R1,&B(&I))
         USING BASIS&NDX+(4096*&I),&B(&I+1)
&I       SETA &I+1
        AIF   ('&I' LT '&BRG#').C4
.C5      AIF   (NOT &PL1PROG).C5X
.*
.*       UPDATE PRV IHEQSLA
.*
         LA    R1,0(R12,0) NOW
         ORG   *-2 UPDATE
         DC    QL2(IHEQSLA) PRV
         ST    R13,0(,R1) IHEQSLA
&LV      SETA  &LV-4
         ST    R1,&LV.(,R13) SAVE PRV POINTER
.C5X     AIF   ('&EXIT' EQ 'NOT').C6
         AIF   (&SUBROUT AND NOT &PRVEXIT).C6
.*
.*       ISSUE SPIE SVC
.*
         CNOP  2,4
         LA    R1,*+12 LOAD BRANCH ADDRESS
         BALR  R1,R1 BRANCH AROUND PICA
         DC    B&MASK PROGRAM MASK BITS
         AIF   ('&EXIT'(1,1) EQ '(').C50
         DC    VL3(&EXIT) EXIT ROUTINE ADDRESS
         AGO   .C51
.C50     DC    AL3&EXIT EXIT ROUTINE ADDRESS
.C51     DC    B'01111111' INTERRUPTION
         DC    B'11111111' MASK BITS
         SVC   14 ISSUE SPIE SVC
         AIF   (NOT &SUBROUT OR NOT &PRVEXIT).C6
&LV      SETA  &LV-4
         ST    R1,&LV.(,R13) SAVE OLD PICA ADDRESS
.C6      AIF   (&SUBROUT OR '&STAE' EQ 'NO' OR '&STAE' EQ 'NOT').C66
IHB&SYSNDX BC  0,IHB&SYSNDX.A
         OI    IHB&SYSNDX+1,X'F0'
         EXTRN STAEROUT
         STAE  STAEROUT
IHB&SYSNDX.A DS  0H
         AGO   .C7
.C66     AIF   (NOT &FLPSAVE OR NOT &SUBROUT).C7
.*
.*       SAVE FLOATING POINT REGISTERS
.*
         TM    0(R14),255 TEST FOR EXTENDED SAVEAREA
         BC    1,*+10 IF OK BRANCH AROUND
         LA    R1,4095 ABEND U4095 ISSUED
         SVC   13 IF NO EXTENSION IN HSA
         STD   0,72(,R14) SAVE
         STD   2,80(,R14) FLOATING
         STD   4,88(,R14) POINT
         STD   6,96(,R14) REGISTERS
.C7      LM    R14,R1,12(R14) RESTORE PARAM REGISTERS
          SPACE  3
         MEND
./ ADD  NAME=BSPCORR
BSPCORR  START
*
*
*        BACKSPACE CORRECTION ROUTINE
*
*
* INPUT  R1    ADDR OF VARIABLE LENGTH RECORD
* OUTPUT R0    RESIDUAL RECORD LENGTH
*        R15   RETURNCODE
*              0   NORMAL COMPLETION
*              4   RECORD LENGTH INVALID OR DATA LENGTH GONE TO ZERO
*
*              THIS ROUTINE HANDLES BACKSPACE CHARACTERS EMBEDDED IN
*              INPUT RECORDS ACCORDING TO THE FOLLOWING RULES
*                  INPUT DATA LENGTH LESS THAN OR EQUAL TO 256
*                  BACKSPACE REMOVES PRECEEDING CHARACTER (IF ANY)
*                  BLANKS ARE SUPPLIED FOR VACATED POSITIONS
*              THE BACKSPACE CHARACTER MAY OPTIONALLY BE SPECIFIED
*              IN BYTE THREE OF THE RECORD DESCRIPTOR WORD
*
*        PROCESSING EXAMPLE
*                          B  BBB    B
*              INPUT   0FXXSABSSSCDEFS
*                          P  PPP    P
*
*                             SSSSSSSS
*              OUTPUT  0FXXCDEPPPPPPPP
*                             AAAAAAAA
*                      R0  7
*                      R15 0
*
*
*        REGISTER EQUATES
*
R0       EQU   0
R1       EQU   1
R2       EQU   2
R3       EQU   3
R4       EQU   4
R5       EQU   5
R6       EQU   6
R12      EQU   12
R13      EQU   13
R14      EQU   14
R15      EQU   15
* REGISTERS                            MAIN USE
RL       EQU   R3                      NUMBER OF CHARS TO CHECK
RN       EQU   R4                      NEXT CHAR TO CHECK
RC       EQU   R5                      LAST NON BACKSPACE CHARACTER
RS       EQU   R6                      START OF DATA CHARACTERS
*
BSP      EQU   X'16'                   EBCDIC BACKSPACE
         EJECT
BSPCORR  CSECT
         B     12(0,R15)
         DC    X'07'
         DC    CL7'BSPCORR'
         STM   R14,R12,12(R13)
         USING BSPCORR,R15
         SR    R0,R0
         IC    R0,0(0,R1)              GET RECORD LENGTH
         SLL   R0,8
         IC    R0,1(0,R1)
         LA    RL,260
         CR    R0,RL                   AND CHECK MAX
         BH    EXIT4                   INVALID
         LA    RL,4
         LNR   RL,RL
         AR    RL,R0                   COMPUTE NUMBER OF DATA CHARS
         BNP   EXIT4                   INVALID
         LR    R0,RL                   SAVE INIT NUMBER OF DATA CHARS
         CLI   3(R1),X'00'             'BSP' CHAR SPECIFIED
         BNE   ALTBSP
         MVI   3(R1),BSP               STORE BSP FOR COMPARE
ALTBSP   EQU   *
         LA    RS,4(0,R1)              GET START OF DATA
         LR    RN,RS                   GET ADDR OF BSP
         LR    RC,RN
         BCTR  RC,0                    GET PRECEEDING CHAR ADDR
         SR    R2,R2
*
*   SCAN LOOP ORIGIN
NEXTCHAR EQU   *
         LTR   RL,RL                   MORE CHARACTERS TO BE TESTED
         BZ    DONE
         BCTR  RL,0                    DECREASE COUNT
         CLC   0(1,RN),3(R1)           TEST CHAR
         BE    REMOVE
         OI    0(RN),X'40'             TRANSLATE TO UPPER CASE
         LTR   R2,R2                   PREVIOUS BSP DETECTED
         BNZ   OVERLAY                 YES, CONDENSE RECORD
         LA    RC,1(0,RC)              UPDATE POINTERS
         LA    RN,1(0,RN)
         B     NEXTCHAR
OVERLAY  EQU   *
         SR    R2,R2                   RESET INDICATOR
         EX    RL,MVCINST              SHIFT REMAINDER OF RECORD
         LA    RC,1(0,RC)              NEXT CHAR NOT BSP
         LA    RN,1(0,RC)              GET NEXT ONE TO CHECK
         B     NEXTCHAR
REMOVE   EQU   *
         LA    R2,4                    INDICATE BSP FOUND
         LA    RN,1(0,RN)              GET NEXT ONE TO TEST
         CR    RC,RS                   REACHED START OF DATA
         BL    NEXTCHAR                YES, DO NOT STORE INTO COUNT
         BCTR  RC,0                    MARK CURRENT CHAR FOR DELETION
         B     NEXTCHAR
*
*   RECORD SCANNED, COMPUTE NUMBER OF SPACES TO BE INSERTED
DONE     EQU   *
         LR    RL,R0                   GET INIT NUMBER OF CHARS
         LA    R0,1(0,RC)              COMPUTE NUMBER OF CHARACTERS
         SR    R0,RS                     LEFT IN RECORD
         SR    RL,R0                   COMPUTE NUMBER OF SPACES
         BZ    NOSPACE
         LA    RC,1(0,RC)              GET LOC FOR FIRST SPACE
         MVI   0(RC),X'40'             INSERT SPACE
         BCT   RL,FILL
SETCOUNT EQU   *
         LTR   R0,R0                   ANY CHARACTER LEFT
         BZ    EMPTY
NOSPACE  EQU   *
         LA    RL,4
         AR    R0,RL                   ADD LENGTH OF COUNT FIELD
EXIT0    EQU   *
         L     R14,12(0,R13)           RELOAD RETURN ADDR
         LA    R15,0                   LOAD CODE
         LM    R1,R12,24(R13)          RESTORE REGS
         BR    14                      RETURN
FILL     EQU   *
         BCTR  RL,0                    ADJUST FOR EX
         LR    RN,RC                   SET UP FOR MOVE
         EX    RL,MVCINST              BLANK OUT REMAINDER OF RECORD
         B     SETCOUNT
EMPTY    EQU   *
         LA    R0,4                    INDICATE COUNT FIELD ONLY
EXIT4    EQU   *
         L     R14,12(0,R13)           RELOAD RETURN ADDR
         LA    R15,4                   LOAD CODE
         LM    R1,R12,24(R13)          RESTORE REGS
         BR    14                      RETURN
*
*
MVCINST  MVC   1(0,RC),0(RN)
         END
./ ADD  NAME=CATLG
CATLG    START
         REG
         XSAVE R12,,CATLG,WORKL
         LR    R11,R1
         USING WORK,R13
         USING PARMAREA,R11
         MVC   UNCLIST,UNCLISTS
         LA    R2,DSNAME
         ST    R2,UNCLIST+4
         LA    R2,VOLNO
         ST    R2,UNCLIST+12
         MVC   SEQNO,=C'0001'
         MVI   DSNAME,C' '
         MVC   DSNAME+1(43),DSNAME
         MVC   UNIT(6),=CL6' '
         MVC   CVOL,=CL6' '
         XC    VOLNO,VOLNO
         LA    R8,TEXT+6
         LA    R3,100
         LR    R4,R8
         LA    R5,100(R8)
DSN1     EQU   *
         CLC   0(2,R4),=CL2'D='
         BNE   DSN3
         LA    R4,2(R4)
         B     DSN5
DSN3     EQU   *
         LA    R4,1(R4)
         BCT   R3,DSN1
         MVC   WTO(LENMSG01),MSG01
GIVEWTO  EQU   *
         L     R0,REG4
         WTO   MF=(E,WTO)
         B     RETURN
DSN5     EQU   *
         LR    R7,R5
         SR    R7,R4
         EX    R7,TCOMMA
         BNZ   DSN6
         LA    R1,1(R5)
DSN6     EQU   *
         SR    R1,R4
         BCTR  R1,0
         LTR   R1,R1
         BNM   DSN8
DELERROR EQU   *
         MVC   WTO(LENMSG02),MSG02
         B     GIVEWTO
DSN8     EQU   *
         EX    R1,MOVEDSN
         LR    R4,R8
         LA    R3,100
UNIT1    EQU   *
         CLC   0(2,R4),=CL2'U='
         BE    UNIT2
         LA    R4,1(R4)
         BCT   R3,UNIT1
         MVC   WTO(LENMSG01),MSG01
         MVC   WTO+40(2),=CL2'U='
         B     GIVEWTO
UNIT2    EQU   *
         LA    R4,2(R4)
         LR    R7,R5
         SR    R7,R4
         EX    R7,TCOMMA
         BNZ   UNIT5
         LA    R1,1(R5)
UNIT5    EQU   *
         SR    R1,R4
         BCTR  R1,0
         LTR   R1,R1
         BM    DELERROR
         EX    R1,MOVEUNT
         CLC   UNIT(2),=CL2'24'
         BE    XXX
         CLC   UNIT(2),=CL2'34'
         BE    XXX
         CLC   UNIT(4),=C'TAPE'
         BNE   SEQ7
XXX      EQU   *
         LR    R4,R8
         LA    R3,100
SEQ1     EQU   *
         CLC   0(2,R4),=CL2'S='
         BE    SEQ2
         LA    R4,1(R4)
         BCT   R3,SEQ1
         B     VOL1
SEQ7     EQU   *
         MVI   SEQNO+3,C'0'
         B     VOL1
SEQ2     EQU   *
         LA    R4,2(R4)
         LR    R7,R5
         SR    R7,R4
         EX    R7,TCOMMA
         BNZ   SEQ5
         LA    R1,1(R5)
SEQ5     EQU   *
         SR    R1,R4
         BCTR  R1,0
         LTR   R1,R1
         BM    DELERROR
         EX    R1,TNUM
         BZ    SEQ6
         MVC   WTO(LENMSG01),MSG01
         MVC   WTO+40(2),=CL2'S='
         B     GIVEWTO
SEQ6     EQU   *
         LA    R9,SEQNO+3
         SR    R9,R1
         EX    R1,MOVESEQ
VOL1     EQU   *
         LR    R4,R8
         LA    R3,100
CVOL1    EQU   *
         CLC   0(2,R4),=CL2'C='
         BE    CVOL2
         LA    R4,1(R4)
         BCT   R3,CVOL1
         B     CVOLEND
CVOL2    EQU   *
         LA    R4,2(R4)
         LR    R7,R5
         SR    R7,R4
         EX    R7,TCOMMA
         BNZ   CVOL3
         LA    R1,1(R5)
CVOL3    EQU   *
         SR    R1,R4
         BCTR  R1,0
         LTR   R1,R1
         BM    DELERROR
         EX    R1,MOVECVOL
CVOLEND  EQU   *
         LR    R4,R8
         LA    R3,100
VOL2     EQU   *
         CLC   0(2,R4),=CL2'V='
         BE    VOL3
         LA    R4,1(R4)
         BCT   R3,VOL2
         MVC   WTO(LENMSG01),MSG01
         MVC   WTO+40(2),=CL2'V='
         B     GIVEWTO
VOL3     EQU   *
         LA    R4,2(R4)
         LA    R8,DEVTAB
         LA    R6,11
         LA    R7,DEVEND-11
VOL6     EQU   *
         CLC   4(6,R8),UNIT
         BE    VOL7
         BXLE  R8,R6,VOL6
         MVC   WTO(LENMSG03),MSG03
         B     GIVEWTO
VOL7     EQU   *
         LH    R2,VOLNO
         LA    R9,VOLIST
         LA    R3,VOLIST+240
         CLI   0(R4),C'('
         BE    VOL11
         LR    R7,R5
         SR    R7,R4
         ST    R2,ALIST
         EX    R7,TCOMMA
         L     R2,ALIST
         BNZ   VOL8
         LA    R1,1(R5)
VOL8     EQU   *
         SR    R1,R4
         CH    R1,=H'6'
         BNH   VOL9
         MVC   WTO(LENMSG04),MSG04
         B     GIVEWTO
VOL9     EQU   *
         MVC   0(4,R9),0(R8)
         BCTR  R1,0
         MVI   4(R9),X'40'
         MVC   5(5,R9),4(R9)
         EX    R1,MOVESER
         PACK  D,SEQNO
         CVB   R1,D
         STH   R1,10(R9)
         LA    R2,1(R2)
VOL10    EQU   *
         STH   R2,VOLNO
         B     ENDRT2
VOL11    EQU   *
         PACK  D,SEQNO
         CVB   R1,D
VOL12    EQU   *
         LA    R4,1(R4)
         STM   R1,R2,WTO
         LR    R7,R5
         SR    R7,R4
         EX    R7,TKLAM
         BZ    DELERROR
         SR    R1,R4
         LR    R6,R1
         LM    R1,R2,WTO
         BCTR  R6,0
         MVI   4(R9),X'40'
         MVC   5(5,R9),4(R9)
         EX    R6,MOVESER
         MVC   0(4,R9),0(R8)
         LA    R4,1(R6,R4)
         STH   R1,10(R9)
         LA    R2,1(R2)
         CLI   0(R4),C')'
         BE    VOL10
         LA    R9,12(R9)
         CR    R9,R3
         BL    VOL12
         MVC   WTO(LENMSG05),MSG05
         B     GIVEWTO
ENDRT2   EQU   *
         CLC   CVOL,=CL6' '
         BE    NOCVOL
         LA    R1,CVOL
         ST    R1,UNCLIST+8
         OI    UNCLIST,X'80'
NOCVOL   EQU   *
         CATALOG UNCLIST
         LA    R9,ERRTAB
         SLA   R15,2
         AR    R9,R15
         L     R15,0(R9)
         L     R9,4(R9)
         BCTR  R9,0
         EX    R9,MVCWTO
         B     GIVEWTO
RETURN   EQU   *
         XRETURN ,R
ERRTAB   DS    0F
         DC    A(MSG06),A(LENMSG06)
         DC    A(MSG07),A(LENMSG07)
         DC    A(MSG08),A(LENMSG08)
         DC    A(0),A(0)
         DC    A(MSG09),A(LENMSG09)
         DC    A(MSG10),A(LENMSG10)
         DC    A(MSG11),A(LENMSG11)
         DC    A(MSG12),A(LENMSG12)
UNCLISTS CAMLST CATBX,ERRTAB,,ERRTAB
TKLAM    TRT   0(0,R4),TTAB
TTAB     DC    93X'00',X'FF',13X'00',X'FF',148X'00'
TCOMMA   TRT   0(0,R4),TRTTAB
TRTTAB   DC    64X'00',X'FF',42X'00',X'FF',148X'00'
MOVEDSN  MVC   DSNAME(0),0(R4)
MOVEUNT  MVC   UNIT(0),0(R4)
MVCWTO   MVC   WTO(0),0(R15)
TNUM     TRT   0(0,R4),NUMTAB
NUMTAB   DC    240X'FF',10X'00',6X'FF'
MOVESEQ  MVC   0(0,R9),0(R4)
MOVESER  MVC   4(0,R9),0(R4)
MOVECVOL MVC   CVOL(0),0(R4)
DEVTAB   DC    X'30008001'
         DC    C'2400  4'
         DC    X'30808001'
         DC    C'2400-16'
         DC    X'30C08001'
         DC    C'2400-26'
         DC    X'34008001'
         DC    C'2400-36'
         DC    X'34208001'
         DC    C'2400-46'
         DC    X'34008003'
         DC    C'3400-36'
         DC    X'34008003'
         DC    C'TAPE  4'
         DC    X'34008003'
         DC    C'BAND  4'
         DC    X'30002001'
         DC    C'2311  4'
         DC    X'30402002'
         DC    C'2301  4'
         DC    X'30002004'
         DC    C'2302  4'
         DC    X'30002003'
         DC    C'2303  4'
         DC    X'30C02008'
         DC    C'2314  4'
         DC    X'30002005'
         DC    C'2321  4'
         DC    X'30502007'
         DC    C'2305-26'
         DC    X'30502007'
         DC    C'DRUM  4'
         DC    X'30502006'
         DC    C'2305-16'
         DC    X'30502009'
         DC    C'3330  4'
         DC    X'30502009'
         DC    C'DISK  4'
         DC    X'3050200A'
         DC    C'3340  4'
         DC    X'3050200D'
         DC    C'3330  4'
DEVEND   EQU   *
MSG01    WTO   'XCATLG0 INVALID OR MISSING KEYWORD: D=.',MCSFLAG=REG0, *
               MF=L
LENMSG01 EQU   *-MSG01
MSG02    WTO   'XCATLG1 DELIMITER ERROR',MCSFLAG=REG0,MF=L
LENMSG02 EQU   *-MSG02
MSG03    WTO   'XCATLG2 INVALID UNIT NAME',MCSFLAG=REG0,MF=L
LENMSG03 EQU   *-MSG03
MSG04    WTO   'XCATLG3 INVALID VOLSER',MCSFLAG=REG0,MF=L
LENMSG04 EQU   *-MSG04
MSG05    WTO   'XCATLG4 MORE THAN 20 VOLSERS',MCSFLAG=REG0,MF=L
LENMSG05 EQU   *-MSG05
MSG06    WTO   'XCATLG5 SPECIFIED DSNAME NOW CATALOGED',MCSFLAG=REG0,  *
               MF=L
LENMSG06 EQU   *-MSG06
MSG07    WTO   'XCATLG5 CATALOG VOLUME NOT MOUNTED',MCSFLAG=REG0,MF=L
LENMSG07 EQU   *-MSG07
MSG08    WTO   'XCATLG5 INCONSISTENT INDEX STRUCTURE',MCSFLAG=REG0,    *
               MF=L
LENMSG08 EQU   *-MSG08
MSG09    WTO   'XCATLG5 INDEX STRUCTURE DOES NOT EXIST',MCSFLAG=REG0,  *
               MF=L
LENMSG09 EQU   *-MSG09
MSG10    WTO   'XCATLG5 NO SPACE AVAILABLE IN THE CATALOG DATA SET',   *
               MCSFLAG=REG0,MF=L
LENMSG10 EQU   *-MSG10
MSG11    WTO   'XCATLG5 INPROPERLY NAMED GENERATION DATA GROUP',       *
               MCSFLAG=REG0,MF=L
LENMSG11 EQU   *-MSG11
MSG12    WTO   'XCATLG5 PERM. I/O ERROR',MCSFLAG=REG0,MF=L
LENMSG12 EQU   *-MSG12
         LTORG
WORK     DSECT
SVA      DS    18F
WTO      DS    CL108
         DS    0F
UNCLIST  DS    CL16
DSNAME   DS    CL44
         CNOP  2,4
VOLNO    DS    H
VOLIST   DS    20CL12
SEQNO    DS    CL4
UNIT     DS    CL6
CVOL     DS    CL6
D        DS    D
ALIST    DS    F
WORKL    EQU   *-WORK
         XPARM
         END   CATLG
./ ADD  NAME=CMD
CMD      START
         REG
         XSAVE R12,,CMD,WORKEND-WORK
         USING WORK,R13
         LR    R11,R1
         USING PARMAREA,R11
         LA    R2,TEXT
         MVI   COMMAND,X'40'
         XC    ZERO,ZERO
         MVC   LENGTH,=H'74'
         CLI   TEXT+4,X'40'
         BE    ERROR
         CLI   TEXT+4,C'X'
         BE    ERROR
         MVC   COMMAND+1(69),4(R2)
         L     R2,16         CVT ADDRESS
         TM    116(R2),X'01' SYSTEM = OS/VS2 (MVS) ?
         BZ    SVCALL        NO, LINK TO SVC
         MODESET KEY=ZERO    SET KEY ZERO
SVCALL   EQU   *
         LA    R1,LENGTH
         L     R0,REG4       UCM-ID
         SVC   34
         TM    116(R2),X'01' SYSTEM = OS/VS2 (MVS) ?
         BZ    FREE          NO, LINK TO XRETURN
         MODESET KEY=NZERO   SET KEY NOZERO
FREE     EQU   *
         XRETURN 0,R
ERROR    EQU   *
         MVC   WTO(LENMSG01),MSG01
         L     R0,REG4
         WTO   MF=(E,WTO)
         B     FREE
MSG01    WTO   'XCMD001 ERROR IN PARAMETER',MCSFLAG=(REG0),MF=L
LENMSG01 EQU   *-MSG01
         XPARM
WORK     DSECT
SVA      DS    18F
LENGTH   DS    H
ZERO     DS    H
COMMAND  DS    CL70
         DS    0F
WTO      DS    CL40
WORKEND  EQU   *
         END   CMD
./ ADD  NAME=CONV
LUXCONV  START
         REG
         XSAVE R12,,LUXCONV,WORKL
         USING WORK,R13
         USING PARMAREA,R11
         LR    R11,R1
         XC    DBLWD,DBLWD
         XC    SWITCH,SWITCH
         TRT   TEXT+5(11),TRTTAB
         BZ    ERROR
         LA    R10,TEXT+5
         CR    R10,R1
         BE    ERROR
         LR    R9,R1
         SR    R9,R10
         BCTR  R9,0
         MVC   WTO,MESS3
         LA    R8,WTO+12
         EX    R9,MVCEX1
         LA    R8,2(R9,R8)
         LA    R7,1(R9)
         CLI   1(R1),C'X'
         BNE   DECCONV
         MVC   0(8,R8),=C'(HEX)  ='
         LA    R8,10(R8)
KHEX     EQU   *
         EX    R9,TREX1
         EX    R9,TRTEX1
         BNZ   INVNUM
         EX    R7,PACKEX1
         L     R6,DBLWD
         LTR   R6,R6
         BNZ   INVNUM
         L     R6,DBLWD+4
         CVD   R6,DBLWD
         UNPK  0(10,R8),DBLWD
         OI    9(R8),X'F0'
         MVC   11(5,R8),=C'(DEC)'
         B     WTOROUT
DECCONV  EQU   *
         CLI   1(R1),C'D'
         BNE   KCONV
         MVC   0(8,R8),=C'(DEC)  ='
         LA    R8,10(R8)
KDEC     EQU   *
         EX    R9,TREX2
         EX    R9,TRTEX2
         BNZ   INVNUM
         EX    R7,PACKEX1
         MVO   ZWI,DBLWD
         NI    ZWI+7,X'F0'
         OI    ZWI+7,X'0C'
         CP    ZWI,PMAX
         BH    INVNUM
         CVB   R6,ZWI
         TM    SWITCH,X'80'
         BNO   DECOK
         SLL   R6,10
DECOK    EQU   *
         ST    R6,ZWI
         UNPK  0(9,R8),ZWI(5)
         MVC   8(6,R8),=C' (HEX)'
         TR    0(8,R8),CCTAB-240
         TM    SWITCH,X'80'
         BO    CONT1K
         B     WTOROUT
KCONV    EQU   *
         CLI   1(R1),C'K'
         BNE   ERROR
         C     R7,=F'5'
         BH    INVNUM
         MVC   0(4,R8),=C'K  ='
         LA    R8,6(R8)
         OI    SWITCH,X'80'
         B     KDEC
CONT1K   EQU   *
         MVC   ZWI2,0(R8)
         LA    R10,ZWI2
         MVI   16(R8),C'='
         LA    R8,19(R8)
         LA    R9,7
         LA    R7,8
         B     KHEX
RETURN   EQU   *
         XRETURN 0,R
ERROR    EQU   *
         MVC   WTO,MESS2
WTOROUT  EQU   *
         L     R0,REG4
         WTO   MF=(E,WTO)
         B     RETURN
INVNUM   EQU   *
         MVC   WTO,MESS1
         B     WTOROUT
MVCEX1   MVC   0(0,R8),0(R10)
TREX1    TR    0(0,R10),TRTAB
ZEROES   DC    16XL1'00'
TRTAB    DS    0CL256
         DC    193XL1'FF'
         DC    XL6'0A0B0C0D0E0F'
         DC    41XL1'FF'
         DC    X'00010203040506070809'
         DC    6XL1'FF'
TRTEX1   TRT   0(0,R10),ZEROES
PACKEX1  PACK  DBLWD(9),0(0,R10)
TREX2    TR    0(0,R10),TRTAB1
ZERO     DC    10XL1'00'
TRTAB1   DS    0CL256
         DC    240XL1'FF'
         DC    X'00010203040506070809'
         DC    6XL1'FF'
TRTEX2   TRT   0(0,R10),ZERO
PMAX     DC    XL8'000002147483647C'
CCTAB    DC    CL16'0123456789ABCDEF'
TRTTAB   DC    256XL1'00'
         ORG   TRTTAB+107
         DC    C','
         ORG
MESS1    WTO   'XCONV01 INVALID NUMERICS',MCSFLAG=REG0,MF=L
MESS2    WTO   'XCONV02 ERROR IN PARAMETER',MCSFLAG=REG0,MF=L
MESS3    WTO   'XCONV03                                                *
                       ',                                              *
               MCSFLAG=REG0,MF=L
         XPARM
WORK     DSECT
SVA      DS    18F
DBLWD    DS    D
ZWI      DS    D
ZWI2     DS    CL8
WTO      DS    CL80
SWITCH   DS    X
WORKL    EQU   *-WORK
         END
./ ADD  NAME=CONVXE
CONVXE   START 0
         REG
         XSAVE R12,,CONVXE
         LR    R2,R1     UMLADEN ADRESSZEIGER
         LR    R3,R0     SICHERN LAENGE
         UNPK  WORK+00(9),00(5,R2)
         UNPK  WORK+08(9),04(5,R2)
         UNPK  WORK+16(9),08(5,R2)
         UNPK  WORK+24(9),12(5,R2)
         UNPK  WORK+32(9),16(5,R2)
         UNPK  WORK+40(9),20(5,R2)
         UNPK  WORK+48(9),24(5,R2)
         UNPK  WORK+56(9),28(5,R2)
         UNPK  WORK+64(9),32(5,R2)
         UNPK  WORK+72(9),36(5,R2)
         UNPK  WORK+80(9),40(5,R2)
         UNPK  WORK+88(9),44(5,R2)
         UNPK  WORK+96(9),48(5,R2)
         UNPK  WORK+104(9),52(5,R2)
         UNPK  WORK+112(9),56(5,R2)
         UNPK  WORK+120(9),60(5,R2)
         SLL   R3,1              R3 = R3 * 2
         BCTR  R3,0              R3 = R3 - 1
         EX    R3,TR             UMWANDELN NACH HEXADEZIMAL
         EX    R3,MOVE           UEBERTRAGEN GEWUENSCHTE LAENGE
         XRETURN 0,R
         SPACE 2
TR       TR    WORK(0),CCTAB-240 TR-GERUEST FUER EX
MOVE     MVC   0(0,R2),WORK     MVC-GERUEST FUER EX
WORK     DS    CL256
CCTAB    DC    CL16'0123456789ABCDEF'
         SPACE 2
         END
./ ADD  NAME=CPUPAG
CPUPAG   TITLE 'CPU-WAIT-TIME AND PAGING'
         PRINT GEN
CPUPAG   CSECT
         XSAVE 12,,CPUPAG,LENGTH
REG0     EQU   0
         USING PARMAREA,11
         USING WORK,13
         LR    11,1
         L     10,16                    10 = CVT
         TM    116(10),X'01'            CVTDCB
         BZ    NOMVS                    NOT A MVS-SYSTEM
         XC    WTOR,WTOR
         MODESET KEY=ZERO
         TS    LOCK                     TEST
         BNZ   INUSE                    ALREADY IN USE
         B     A1
LOCK     DC    X'00'                    LOCK-BYTE
A1       MODESET KEY=NZERO
         MVC   CONSOLID,REG4
         PACK  INTVSEC,=P'300'          300 SECONDS DEFAULT
         CLI   10(11),C','
         BNE   INTDEF                   NO INTERVAL SPECIFIED
         LA    2,5
         XR    3,3
         LA    4,11(11)
A2       CLI   0(4),C'0'
         BL    AEND
         CLI   0(4),C'9'
         BH    AEND
         LA    3,1(3)
         LA    4,1(4)
         BCT   2,A2
AEND     LTR   3,3
         BZ    ININV
         BCTR  3,0
         EX    3,PACKINT
         B     CHECKINT
PACKINT  PACK  INTVSEC,11(0,11)
CHECKINT CP    INTVSEC,=P'10'
         BL    ININV
         CP    INTVSEC,=P'600'
         BH    ININV
         B     INITINT                  INTIALIZE INTERVAL
         SPACE 3
ININV    EQU   *                        INVALID INTERVAL
         L     0,CONSOLID
         WTO   MF=(E,WTOININV)
INTDEF   PACK  INTVSEC,=C'300'
         SPACE 5
INITINT  ZAP   HELP,INTVSEC
         XR    2,2
         CVB   3,HELP
         M     2,=F'100'
         ST    3,BININTVL
         TM    WTORSW,X'FF'
         BNZ   I1
         XC    WTORECB,WTORECB
         LA    4,7(11)
         MVC   WTORL1,WTORL
         L     0,CONSOLID
         WTOR  ,WTORREPL,4,WTORECB,MF=(E,WTORL1)
         ST    1,WTORID
         OI    WTORSW,X'01'
         SPACE 2
I1       EQU   *
         LA    10,OLD                   CVT
         BAL   9,SAVEVAL                CVTLCCAT
         STCK  OTOD      STORE CLOCK BEFORE MEASUREMENT-INTERVAL
*
*
         STIMER WAIT,BINTVL=BININTVL
*
*
         STCK  NTOD      STORE CLOCK AFTER MEASUREMENT-INTERVAL
         LA    10,NEW
         BAL   9,SAVEVAL
         MVC   WTOLINE1,WTOSK1          MOVE WTO-SKELETONS TO
         MVC   WTOLINE2,WTOSK2          WORK-AREA
         MVC   WTOL1+34(4),=X'40202120'
         ED    WTOL1+34(4),INTVSEC+6
         CLC   NWTIM,OWTIM
         BNL   B1
B0       L     0,REG4
         WTO   MF=(E,CHANGE)
         B     WTORTEST
B1       EQU   *
         LM    2,3,NWTIM
         SL    3,OWTIM+4                SUBTRACT OLD WAIT-TIME
         BC    3,*+8
         SL    2,=F'1'
         SL    2,OWTIM                  WAIT-TIME IN INTERVAL
         LM    4,5,NTOD
         SL    5,OTOD+4
         BC    3,*+8
         SL    4,=F'1'
         SL    4,OTOD                   LENGTH OF INTERVAL IN TOD
         STM   4,5,TODINTV              SAVE INTERVAL-LENGTH
         SRDL  2,24
         SRDL  4,24
         D     2,NCPUNUM
         XR    2,2
         M     2,=F'1000'
         DR    2,5
         CVD   3,HELP
         MVC   WTOL1+17(7),=X'40202021204B20'
         ED    WTOL1+17(7),HELP+5
*
         LM    4,5,TODINTV
         SRDL  4,12                     MICRO-SECONDS
         D     4,=F'1000000'            SECONDS
         ST    5,SEC
         LA    1,OPAGIN
         LA    2,NPAGIN
         LA    3,6
B5       CLC   0(4,2),0(1)              PAGE-COUNT CHANGED ?
         BL    B0                       YES
         LA    1,4(1)
         LA    2,4(2)
         BCT   3,B5
         XR    2,2
         L     3,NVIOIN
         A     3,NVIOOUT
         S     3,OVIOIN
         S     3,OVIOOUT
         M     2,=F'10'
         D     2,SEC
         CVD   3,HELP
         MVC   WTOL2+22(5),=X'4021204B20'
         ED    WTOL2+22(5),HELP+6       PAGE VIO
         XR    2,2
         L     3,NSWAPIN
         A     3,NSWAPOUT
         S     3,OSWAPIN
         S     3,OSWAPOUT
         M     2,=F'10'
         D     2,SEC
         CVD   3,HELP
         MVC   WTOL2+33(5),=X'4021204B20'
         ED    WTOL2+33(5),HELP+6       PAGE SWAP
         XR    2,2
         XR    3,3
         LA    4,NPAGIN
         LA    5,6
         A     3,0(4)
         LA    4,4(4)
         BCT   5,*-8
         LA    4,OPAGIN
         LA    5,6
         S     3,0(4)
         LA    4,4(4)
         BCT   5,*-8
         M     2,=F'10'
         D     2,SEC
         CVD   3,HELP
         MVC   WTOL2+45(5),=X'4021204B20'
         ED    WTOL2+45(5),HELP+6
*
         L     0,REG4                   DISPLAY
         WTO   MF=(E,WTOLINE1)
         L     0,REG4
         WTO   MF=(E,WTOLINE2)
*
WTORTEST OC    WTORECB,WTORECB
         BZ    INITINT                  INITIALIZE NEXT INTERVAL
         CLC   WTORREPL,=C'STOP'
         BE    RETURN
         XC    WTORSW,WTORSW
         LA    1,WTORREPL
         LA    2,4
         XR    3,3
C0       CLI   0(1),X'00'
         BE    C9                       END OF REPLY
         CLI   0(1),C'0'
         BL    C8
         CLI   0(1),C'9'
         BH    C8
         LA    3,1(3)
         LA    1,1(1)
         BCT   2,C0
         B     C9
C8       L     0,REG4
         WTO   MF=(E,WTOINV)
         B     INITINT
C9       BCTR  3,0
         EX    3,C91
         B     INITINT
C91      PACK  INTVSEC,WTORREPL(0)
         SPACE 5
RETURN   XRETURN 0,R
         EJECT
SAVEVAL  L     1,16
         L     2,X'300'(1)              CVTLCCAT
         XR    4,4
         XR    5,5
         XR    7,7
         LA    6,16                     MAX. NUMBER OF CPUS
S1       L     3,0(2)                   LCCA
         C     3,=F'0'
         BE    S2                       NO LCCA, NO CPU
         LA    7,1(7)                   CPU-COUNT + 1
         AL    5,620(3)
         BC    12,*+8
         AL    4,=F'1'
         AL    4,616(3)
S2       LA    2,4(2)                   NEXT  CPU
         BCT   6,S1
         STM   4,5,0(10)                WAIT-TIME OF ALL CPU
         ST    7,32(10)                 NUMBER OF CPU'S
         SPACE
         L     2,X'164'(1)              PAGE VECTOR TABLE PVT
         MVC   8(4,10),X'E8'(2)         PVTNPIN
         MVC   12(4,10),X'EC'(2)        PVTNPOUT
         MVC   16(4,10),X'F0'(2)        PVTVAMI
         MVC   20(4,10),X'F4'(2)        PVTVAMO
         MVC   24(4,10),X'FC'(2)        PVTSPIN
         MVC   28(4,10),X'100'(2)       PVTSPOUT
         BR    9
         EJECT
INUSE    L     0,REG4
         WTO   MF=(E,WINUSE)
         MODESET KEY=NZERO
         B     RETURN
         SPACE 5
NOMVS    L     0,REG4
         WTO   MF=(E,WNOMVS)
         B     RETURN
         EJECT
WTOININV WTO   'XCPUPAG1 DEFAULT INTERVAL USED -300 SECONDS',          *
               MCSFLAG=REG0,MF=L
WTORL    WTOR  'XCPUPAG2 SPECIFY NEW INTERVAL OR ENTER ''STOP''',      *
               MCSFLAG=REG0,MF=L
WTOSK1   WTO   'XCPUPAG0 CPU-WAIT XXXX.X% INTERVAL XXX SECONDS',       *
               MCSFLAG=REG0,MF=L
WTOSK2   WTO   'XCPUPAG0 PAGE/SEC. VIO XX.X  SWAP XX.X  TOTAL XX.X',   *
               MCSFLAG=REG0,MF=L
CHANGE   WTO   'XCPUPAG9 VALUES ARE CHANGED',MCSFLAG=REG0,MF=L
WTOINV   WTO   'XCPUPAG8 INVALID REPLY',MCSFLAG=REG0,MF=L
WINUSE   WTO   'XCPUPAG7 CPUPAG ALREADY IN USE',MCSFLAG=REG0,MF=L
WNOMVS   WTO   'XCPUPAG6 NO MVS-SYSTEM',MCSFLAG=REG0,MF=L
         LTORG
         EJECT
XPARM    XPARM
         SPACE 5
WORK     DSECT
SAVEAREA DS    18F
CONSOLID DS    F
INTVSEC  DS    D
HELP     DS    D
BININTVL DS    F
WTOR     DS    0CL10
         DS    CL1
WTORECB  DS    F
WTORSW   DS    1C
WTORREPL DS    CL4
WTORID   DS    F
         DS    0D
OLD      DS    0CL36
OWTIM    DS    D                        WAIT-TIME FROM LCCA OF EACH CPU
OPAGIN   DS    F
OPAGOUT  DS    F
OVIOIN   DS    F
OVIOOUT  DS    F
OSWAPIN  DS    F
OSWAPOUT DS    F
OCPUNUM  DS    F
         DS    0D
NEW      DS    0CL36
NWTIM    DS    D
NPAGIN   DS    F
NPAGOUT  DS    F
NVIOIN   DS    F
NVIOOUT  DS    F
NSWAPIN  DS    F
NSWAPOUT DS    F
NCPUNUM  DS    F
OTOD     DS    D
NTOD     DS    D
WTOLINE1 DS    CL80
WTOLINE2 DS    CL80
WTOL1    EQU   WTOLINE1+4
WTOL2    EQU   WTOLINE2+4
TODINTV  DS    D
SEC      DS    F
WTORL1   DS    CL70
LENGTH   EQU   *-WORK
         END
./ ADD  NAME=DA
XDA1     TITLE 'DISPLAY ACTIVITIES'
         SPACE 5
***********************************************************************
*                                                                     *
*        AUTHOR. KEHR.                                                *
*        INSTALLATION. BAYER AG, LEVERKUSEN, RECHENZENTRUM.           *
*        DATE-WRITTEN. 29.10.1972.                                    *
*        REMARKS.                                                     *
*              DURCH DEN MODUL 'DA' WERDEN DIE AKTIVEN TASKS DES      *
*              SYSTEMS ANGEZEIGT. ALS INFORMATION WIRD AUSGEGEBEN:    *
*              NAME DES INITIATORS, JOB-NAME, STEP-NAME, PROCSTEP-NAME*
*              PROTEKTION KEY, REGION GROESSE, DISPATCHING PRIORITAET *
*              UND DER WAIT-COUNT DES LETZTEN ANGEHANGENEN REQUEST    *
*              BLOCKS.                                                *
*                                                                     *
*              DURCH ANGABE DES PARAMETERS 'T' WIRD AN STELLE DIESER  *
*              INFORMATIONEN FOLGENDES AUSGEGEBEN:                    *
*              NAME DES INITIATORS, HEXADEZIMALER ABZUG DER FELDER    *
*              TCBPKF, TCBFLGS, TCBCMP UND TCBDAR, TCBNDSP.           *
*              DIE ANGABE DES PARAMETERS 'A' BEWIRKT EINE AUSGABE     *
*              BEIDER INFORMATIONEN.                                  *
*                                                                     *
*        DER MODUL HAT DIE ATTRIBUTE: REUSABLE, REENTERABLE.          *
*                                                                     *
*        BENUTZTE MAKROS:                                             *
*              REG, RETURN, FREEMAIN, XPARM, XSAVE                    *
*                                                                     *
***********************************************************************
         SPACE 4
*---------------------------------------------------------------------*
*                                                                     *
*        MODIFICATIONS. G.FUCHS.                                      *
*        DATE-WRITTEN. 9.7.1974.                                      *
*        REMARKS.                                                     *
*            'DA' IST ERWEITERT WORDEN, UND VERKRAFTET NUN AUCH       *
*            EINEN AUFRUF UNTER EINEM MVS SYSTEM.                     *
*                                                                     *
*---------------------------------------------------------------------*
         EJECT
DA       CSECT
         XSAVE R12,,DA,WORKL
         USING WORK,R13
         USING PARMAREA,R11
         SPACE
         LR    R11,R1                  ESTABLISH ADDRESS OF XPARM
         SPACE 2
*      TEST FOR MVS SYSTEM
         L     R3,CVTPTR               LOAD CVT ADDRESS
         TM    CVTDCB(R3),CVTMVS2      MVS SYSTEM?
         BO    MVSDATA                 BR IF YES
*
         SPACE 2
         L     R0,REG4                 GET MCS CONSOLE ID
XDA1     WTO   'XDA0001 INITIATOR PK JOB-NAME STEP-NAME PROC-NAME REGIO*
               N DPRTY WCT',                                           *
               MCSFLAG=REG0
         SPACE
         MVC   XDA2(XDA2L),XDA2DS      INITIALIZE XDA0002 MESSAGE
         MVC   XDA3(XDA3L),XDA3DS      INITIALIZE XDA0003 MESSAGE
         SPACE
         LA    R3,CVTPTR               GET ADDRESS OF CVT-POINTER
         L     R3,0(R3)                GET CVT-ADDRESS
         L     TCBR,CVTHEAD(R3)        POINT TO FIRST TCB IN SYSTEM
         L     TCBR,TCBOTC(TCBR)       ORIGINATING TCB IS MAST. SCHED.
         L     OTCBR,TCBLTC(TCBR)      GET LAST CHAINED MOTHER-TCB
         LA    R10,32                  ESTABLISH LOOP CONTROL
DA1      EQU   *
         BAL   R9,DATCB                CALL PROCESSOR OF TCB
         L     OTCBR,TCBNTC(OTCBR)     GET PREVIOUS MOTHER-TCB
         LTR   OTCBR,OTCBR             IS IT FIRST
         BZ    DA2                     YES, JOB DONE, RETURN
         BCT   R10,DA1                 PROCESS NEXT MOTHER-TCB
         EX    1,*                     LOOP LIMIT EXCEEDED *ABEND*
DA2      EQU   *
         XRETURN 0,R
         SPACE 4
*      'DISPLAY ACTIVES' FOR MVS SYSTEMS
MVSDATA  EQU   *
         MVI   FUNCIND,0               CLEAR FUNCTION INDICATOR
         LA    R1,TEXT+2               START ADDRESS OF DA OPTIONS
OPTLP    CLI   0(R1),C','              END OF OPTIONS?
         BNE   OPTLPE                  BR IF YES
         LA    R1,1(,R1)               ADDRESS OF NEXT BYTE
         LA    R0,ANZDOPT              LOAD # OF VALID OPTIONS
         LA    R15,DISPOPT             LOAD ADDRESS OF FIRST OPTION
         SR    R14,R14                 CLEAR R14
OPT1LP   IC    R14,0(,R15)             INSERT LENGTH OF CURRENT OPT
         BCTR  R14,0                   DECREMENT BY 1 FOR EX CLC
         EX    R14,CLCOPT              COMPARE
         BE    OPT1LPE                 BR IF EQUAL
         LA    R15,L'DISPOPT(,R15)     ADDRESS OF NEXT OPTION
         BCT   R0,OPT1LP               BCT
         B     OPTLPE
OPT1LPE  OC    FUNCIND,9(R15)          OR
         LA    R1,1(R14,R1)            ADDRESS OF NEXT BYTE
         B     OPTLP                   PROCESS NEXT OPTION
CLCOPT   CLC   0(0,R1),1(R15)          COMPARE OPTIONS
OPTLPE   TM    FUNCIND,X'F0'           ANY OPTION GIVEN?
         BNZ   DAINIT                  BR IF YES
         TM    FUNCIND,DISPPAGE        PAGING STATISTICS TO BE DISPL.?
         BO    DAINIT                  BR IF YES
         OI    FUNCIND,DISPDFLT        IF NO - ASSUME DEFAULT
*
DAINIT   MVI   HEADSW,C'N'             INDICATE HEADLINE NOT WRITTEN
         L     R4,CVTASVT(R3)          LOAD ADDRESS OF ASVT
         LA    R5,ASVTENTY(R4)         LOAD ADDRESS OF FIRST ENTRY
         L     R1,ASVTMAXU(R4)         LOAD MAXIMUM NUMBER OF ASCB'S
         ST    R1,NOADRSPC                 AND STORE IT
         TM    FUNCIND,DISPPAGE        FUNCTION INDICATOR = PAGE?
         BO    PAGEPROC                BR IF YES
         TM    FUNCIND,DISPTIME        FUNCTION INDICATOR = TIME?
         BZ    SLOTPROC                BR IF NO
         LA    R7,TIMEBLK-8            LOAD ADDRESS OF TIME WKAREA
         BAL   R9,TIMELP1              SAVE TIMER VALUES
         STCK  TOD1                    SAVE TOD-CLOCK
*
         NI    FUNCIND,255-DISPSUPP    SET BIT TO ZERO
         STIMER WAIT,BINTVL=ONESECND   WAIT FOR 1 SECOND
*
         LA    R5,ASVTENTY(R4)         LOAD ADDRESS OF FIRST ASVT ENTRY
         L     R1,ASVTMAXU(R4)         LOAD MAXIMUM NUMBER OF ASCB'S
         ST    R1,NOADRSPC                 AND STORE IT
         LA    R7,TIMEBLK              LOAD ADDRESS OF TIMER WKAREA
         SR    R10,R10                 ZERO TIMER SUM
         BAL   R9,TIMELP1              SAVE TIMER VALUES
         STCK  TOD2                    SAVE TOD-CLOCK
         BAL   R2,BTODDIFF             BUILD TOD DIFFERENCE
         LTR   R10,R10                 SUM OF ALL TIMERS = 0?
         BNZ   *+8                     BR IF NO
         LA    R10,1                   SET SUM TO NONZERO
         ST    R10,TIMESUM             STORE IT
*
         LA    R5,ASVTENTY(R4)         LOAD ADDRESS OF FIRST ASVT ENTRY
         L     R1,ASVTMAXU(R4)         LOAD MAXIMUM NUMBER OF ASCB'S
         ST    R1,NOADRSPC                 AND STORE IT
SLOTPROC LA    R10,TIMEBLK             LOAD ADDRESS OF TIMER WKAREA
         SR    R2,R2                   CLEAR R2 (INIT COUNT)
         SR    R3,R3                   CLEAR R3 (TS USER COUNT)
ASVTLOOP TM    0(R5),ASVTAVAL          ASID ASSIGNED?
         BO    NXTENTY                 BR IF NO
         L     R6,0(,R5)               LOAD ADDRESS OF ASCB
         BAL   R9,DAASCB               CALL PROCESSOR OF ASCB
NXTENTY  LA    R5,4(,R5)               ADDRESS OF NEXT ASCB PTR
         L     R1,NOADRSPC             LOAD MAXIMUM NUMBER OF ASCB'S
         BCTR  R1,0                        AND SUBTRACT IT BY ONE
         ST    R1,NOADRSPC                 AND STORE IT
         LTR   R1,R1                   ALL ASCB'S PROCESSED ?
         BZ    DA2                     BRANCH IF YES
         LA    R10,L'TIMEBLK(R10)      ADDRESS OF NEXT TIME ELEMENT
         CLC   1(3,R5),=X'000000'      LAST ENTRY?
         BNE   ASVTLOOP                BR IF NO
         B     DA2                     RETURN
         EJECT
PAGEPROC EQU   *
         LA    R7,PAGEBLK-12           LOAD ADDRESS OF PAGE WKAREA
         BAL   R9,PAGELP1              SAVE PAGING VALUES
         STCK  TOD1                    SAVE TOD CLOCK VALUE
*
         NI    FUNCIND,255-DISPSUPP    SET BIT TO ZERO
         STIMER WAIT,BINTVL=THREESEC   WAIT FOR 3 SECONDS
*
         LA    R5,ASVTENTY(R4)         LOAD ADDRESS OF FIRST ASVT ENTRY
         L     R1,ASVTMAXU(R4)         LOAD MAXIMUM NUMBER OF ASCB'S
         ST    R1,NOADRSPC                 AND STORE IT
         LA    R7,PAGEBLK              LOAD ADDRESS OF PAGE WKAREA
         BAL   R9,PAGELP1              SAVE PAGER VALUES
         STCK  TOD2                    SAVE TOD CLOCK VALUE
         TM    FUNCIND,X'F0'           ANY OPTIONS GIVEN?
         BNZ   PAGEOPTD                BR IF YES
         BAL   R2,BTODDIFF             BUILD TOD DIFFERENCE
         L     R0,REG4                 LOAD CONSOLE-ID
         WTO   MF=(E,XDA5DS)           WRITE TO OPERATOR
         L     R15,TODDIFF             LOAD TOD DIFFERENCE
         MVC   XDA6,XDA6DS             MOVE MSG SKELETON
         MVC   XDA6TYPE,=C'DEMAND '    MOVE TYPE
         L     R1,PAGEVAL2+0           PAGE-IN, 2. VALUE
         L     R14,PAGEVAL1+0          PAGE-IN, 1. VALUE
         BAL   R8,BPAGEVAL             BUILD PAGE-IN/SEC
         MVC   XDA6IN,MASKAREA+1       MOVE TO MSG
         ZAP   SPAGEIN,DOPWORT         SAVE VALUE
         ZAP   SPAGEIO,DOPWORT         SAVE VALUE
         L     R1,PAGEVAL2+4           PAGE-OUT, 2. VALUE
         L     R14,PAGEVAL1+4          PAGE-OUT, 1. VALUE
         BAL   R8,BPAGEVAL             BUILD PAGE-OUT/SEC
         MVC   XDA6OUT,MASKAREA+1      MOVE TO MSG
         ZAP   SPAGEOUT,DOPWORT        SAVE VALUE
         AP    SPAGEIO,DOPWORT         SAVE VALUE
         L     R1,PAGEVAL2+28          PAGE-REC, 2. VALUE
         L     R14,PAGEVAL1+28         PAGE-REC, 1. VALUE
         BAL   R8,BPAGEVAL             BUILD PAGE-REC/SEC
         MVC   XDA6REC,MASKAREA+1      MOVE TO MSG
         ZAP   SPAGEREC,DOPWORT        SAVE VALUE
         ZAP   SPAGETOT,DOPWORT        SAVE VALUE
         ZAP   DOPWORT,SPAGEIO         PAGE-IO/SEC VALUE
         BAL   R8,BPAGEVL1             EDIT VALUE
         MVC   XDA6PGIO,MASKAREA+1     MOVE TO MSG
         AP    DOPWORT,SPAGETOT        TOTAL PAGE/SEC VALUE
         BAL   R8,BPAGEVL1             EDIT VALUE
         MVC   XDA6PAGE,MASKAREA+1     MOVE TO MSG
         L     R0,REG4                 LOAD CONSOLE-ID
         WTO   MF=(E,XDA6)             WRITE TO OPERATOR
*
         L     R15,TODDIFF             LOAD TOD DIFFERENCE
         MVC   XDA6TYPE,=C'VIO    '    MOVE TYPE
         L     R1,PAGEVAL2+8           PAGE-IN, 2. VALUE
         L     R14,PAGEVAL1+8          PAGE-IN, 1. VALUE
         BAL   R8,BPAGEVAL             BUILD PAGE-IN/SEC
         MVC   XDA6IN,MASKAREA+1       MOVE TO MSG
         AP    SPAGEIN,DOPWORT         SAVE VALUE
         ZAP   SPAGEIO,DOPWORT         SAVE VALUE
         L     R1,PAGEVAL2+12          PAGE-OUT, 2. VALUE
         L     R14,PAGEVAL1+12         PAGE-OUT, 1. VALUE
         BAL   R8,BPAGEVAL             BUILD PAGE-OUT/SEC
         MVC   XDA6OUT,MASKAREA+1      MOVE TO MSG
         AP    SPAGEOUT,DOPWORT        SAVE VALUE
         AP    SPAGEIO,DOPWORT         SAVE VALUE
         L     R1,PAGEVAL2+16          PAGE-REC, 2. VALUE
         L     R14,PAGEVAL1+16         PAGE-REC, 1. VALUE
         BAL   R8,BPAGEVAL             BUILD PAGE-REC/SEC
         MVC   XDA6REC,MASKAREA+1      MOVE TO MSG
         AP    SPAGEREC,DOPWORT        SAVE VALUE
         ZAP   SPAGETOT,DOPWORT        SAVE VALUE
         ZAP   DOPWORT,SPAGEIO         PAGE-IO/SEC VALUE
         BAL   R8,BPAGEVL1             EDIT VALUE
         MVC   XDA6PGIO,MASKAREA+1     MOVE TO MSG
         AP    DOPWORT,SPAGETOT        TOTAL PAGE/SEC VALUE
         BAL   R8,BPAGEVL1             EDIT VALUE
         MVC   XDA6PAGE,MASKAREA+1     MOVE TO MSG
         L     R0,REG4                 LOAD CONSOLE-ID
         WTO   MF=(E,XDA6)             WRITE TO OPERATOR
*
         L     R15,TODDIFF             LOAD TOD DIFFERENCE
         MVC   XDA6TYPE,=C'SWAP   '    MOVE TYPE
         L     R1,PAGEVAL2+20          PAGE-IN, 2. VALUE
         L     R14,PAGEVAL1+20         PAGE-IN, 1. VALUE
         BAL   R8,BPAGEVAL             BUILD PAGE-IN/SEC
         MVC   XDA6IN,MASKAREA+1       MOVE TO MSG
         AP    SPAGEIN,DOPWORT         SAVE VALUE
         ZAP   SPAGEIO,DOPWORT         SAVE VALUE
         L     R1,PAGEVAL2+24          PAGE-OUT, 2. VALUE
         L     R14,PAGEVAL1+24         PAGE-OUT, 1. VALUE
         BAL   R8,BPAGEVAL             BUILD PAGE-OUT/SEC
         MVC   XDA6OUT,MASKAREA+1      MOVE TO MSG
         AP    SPAGEOUT,DOPWORT        SAVE VALUE
         AP    SPAGEIO,DOPWORT         SAVE VALUE
         SR    R1,R1                   PAGE-REC, 2. VALUE
         SR    R14,R14                 PAGE-REC, 1. VALUE
         BAL   R8,BPAGEVAL             BUILD PAGE-REC/SEC
         MVC   XDA6REC,MASKAREA+1      MOVE TO MSG
         AP    SPAGEREC,DOPWORT        SAVE VALUE
         ZAP   SPAGETOT,DOPWORT        SAVE VALUE
         ZAP   DOPWORT,SPAGEIO         PAGE-IO/SEC VALUE
         BAL   R8,BPAGEVL1             EDIT VALUE
         MVC   XDA6PGIO,MASKAREA+1     MOVE TO MSG
         AP    DOPWORT,SPAGETOT        TOTAL PAGE/SEC VALUE
         BAL   R8,BPAGEVL1             EDIT VALUE
         MVC   XDA6PAGE,MASKAREA+1     MOVE TO MSG
         L     R0,REG4                 LOAD CONSOLE-ID
         WTO   MF=(E,XDA6)             WRITE TO OPERATOR
         MVC   XDA6TYPE,=C'*TOTAL*'    MOVE TYPE
         ZAP   DOPWORT,SPAGEIN         MOVE VALUE
         BAL   R8,BPAGEVL1             BUILD PAGE-IN/SEC
         MVC   XDA6IN,MASKAREA+1       MOVE TO MSG
         ZAP   DOPWORT,SPAGEOUT        MOVE VALUE
         BAL   R8,BPAGEVL1             BUILD PAGE-OUT/SEC
         MVC   XDA6OUT,MASKAREA+1      MOVE TO MSG
         ZAP   DOPWORT,SPAGEREC        MOVE VALUE
         BAL   R8,BPAGEVL1             BUILD PAGE-REC/SEC
         MVC   XDA6REC,MASKAREA+1      MOVE TO MSG
         ZAP   DOPWORT,SPAGEIN         COMPUTE
         AP    DOPWORT,SPAGEOUT          PAGE-IO/SEC VALUE
         BAL   R8,BPAGEVL1             EDIT VALUE
         MVC   XDA6PGIO,MASKAREA+1     MOVE TO MSG
         AP    DOPWORT,SPAGEREC        TOTAL PAGE/SEC VALUE
         BAL   R8,BPAGEVL1             EDIT VALUE
         MVC   XDA6PAGE,MASKAREA+1     MOVE TO MSG
         L     R0,REG4                 LOAD CONSOLE-ID
         WTO   MF=(E,XDA6)             WRITE TO OPERATOR
         B     DA2
*
PAGEOPTD LA    R5,ASVTENTY(R4)         LOAD ADDRESS OF FIRST ASVT ENTRY
         L     R1,ASVTMAXU(R4)         LOAD MAXIMUM NUMBER OF ASCB'S
         ST    R1,NOADRSPC                 AND STORE IT
         LA    R10,PAGEBLK             LOAD ADDRESS OF PAGER WKAREA
         SR    R2,R2                   CLEAR R2 (INIT COUNT)
         SR    R3,R3                   CLEAR R3 (TS USER COUNT)
ASVTPGLP TM    0(R5),ASVTAVAL          ASID ASSIGNED?
         BO    NXTPGENT                BR IF NO
         L     R6,0(,R5)               LOAD ADDRESS OF ASCB
         BAL   R9,DAASCB               CALL PROCESSOR OF ASCB
NXTPGENT LA    R5,4(,R5)               ADDRESS OF NEXT ASCB PTR
         L     R1,NOADRSPC             LOAD MAXIMUM NUMBER OF ASCB'S
         BCTR  R1,0                        AND SUBTRACT IT BY ONE
         ST    R1,NOADRSPC                 AND STORE IT
         LTR   R1,R1                   ALL ASCB'S PROCESSED ?
         BZ    DA2                     BRANCH IF YES
         LA    R10,L'PAGEBLK(R10)      ADDRESS OF NEXT PAGE ELEMENT
         CLC   1(3,R5),=X'000000'      LAST ENTRY?
         BNE   ASVTPGLP                BR IF NO
         B     DA2                     RETURN
         EJECT
PAGELP1  EQU   *                       PROCESS PAGER VALUES
         TM    FUNCIND,X'F0'           ANY OPTION GIVEN?
         BNZ   PAGELP1S                BR IF YES
         L     R6,CVTPVTP(,R3)         LOAD PVT ADDRESS
         TM    FUNCIND,DISPSUPP        FIRST ENTRY?
         BO    PAGELP11                BR IF YES
         MVC   PAGEVAL2(32),PVTNPIN(R6) SAVE PAGING COUNTER
         BR    R9                      RETURN
PAGELP11 MVC   PAGEVAL1(32),PVTNPIN(R6) SAVE PAGING COUNTER
         BR    R9                      RETURN
PAGELP1S LA    R8,ANZTBLK              LOAD NUMBER OF PAGE ELEMENTS
         C     R8,ASVTMAXU(R4)         > MAX. NUMBER OF ADDRESS SP.?
         BNH   *+8                     BR IF NO
         L     R8,ASVTMAXU(R4)         SET IT TO THIS NUMBER
PAGELP1A TM    0(R5),ASVTAVAL          ASID ASSIGNED?
         BO    PAGELP1E                BR IF NO
         L     R6,0(,R5)               LOAD ASCB ADDRESS
         L     R6,ASCBOUXB(,R6)        LOAD OUXB ADDRESS
         STCK  TODVALUE                STORE TOD CLOCK
         MVC   PAGEVAL1(32),OUXBPIN(R6) SAVE PAGING COUNTER
         L     R14,PAGEVAL1+00         COMPUTE
         A     R14,PAGEVAL1+12           TOTAL
         A     R14,PAGEVAL1+24             PAGE-IN
         ST    R14,12(,R7)                   OP'S
         L     R15,PAGEVAL1+04         COMPUTE
         A     R15,PAGEVAL1+16           PAGE-OUT
         ST    R15,16(,R7)                 OP'S
         L     R0,PAGEVAL1+08          COMPUTE
         A     R0,PAGEVAL1+20            TOTAL
         A     R0,PAGEVAL1+28              RECLAIM
         ST    R0,20(,R7)                    OP'S
         TM    FUNCIND,DISPSUPP        FIRST ENTRY TO THIS LOOP?
         BZ    PAGELP1T                BR IF NO
         MVC   36(8,R7),TODVALUE       MOVE TOD-VALUE
         B     PAGELP1E
PAGELP1T LM    R0,R1,24(R7)            LOAD FIRST TOD VALUE
         LM    R14,R15,TODVALUE        LOAD SECOND TOD VALUE
         BAL   R2,BTODDIF2             BUILD TOD DIFFERENCE
         ST    R15,24(,R7)             STORE TOD DIFFERENCE
PAGELP1E LA    R7,L'PAGEBLK(,R7)       PROCEED TO NEXT PAGE ELEMENT
         LA    R5,4(,R5)               PROCEED TO NEXT ASCB
         BCT   R8,PAGELP1A             PROCESS NEXT ASVT ENTRY
         BR    R9                      RETURN
         EJECT
TIMELP1  EQU   *                       PROCESS TIMER VALUES
         LA    R8,ANZTBLK              LOAD NUMBER OF TIMER AREAS
         C     R8,ASVTMAXU(R4)         > MAX. NUMBER OF ADDRESS SP.?
         BNH   *+8                     BR IF NO
         L     R8,ASVTMAXU(R4)         SET IT TO THIS NUMBER
TIMELP1A TM    0(R5),ASVTAVAL          ASID ASSIGNED?
         BO    TIMELP1Z                BR IF NO
         L     R6,0(,R5)               LOAD ASCB ADDRESS
         LM    R14,R15,ASCBEJST(R6)    LOAD JOB STEP TIME
         LM    R0,R1,ASCBSRBT(R6)      LOAD SRB TIME
         SRDA  R14,22                  R15, BIT 31 = 1024 MICROSEC
         SLDA  R0,10                   R0, BIT 31 = 1024 MICROSEC
         TM    FUNCIND,DISPSUPP        FIRST ENTRY TO THIS LOOP?
         BO    TIMELP1S                BR IF YES
         L     R1,0(,R7)               LOAD PREVIOUS CPU TIMER
         CR    R15,R1                  IS CURRENT < PREVIOUS?
         BL    TIMELP1D                BR IF YES
         SR    R1,R15                  COMPUTE DIFFERENCE (NEG)
         S     R0,4(,R7)               COMPUTE DIFF. OF SRB TIMER
         SR    R0,R1                   COMPUTE TOTAL DIFFERENCE
         AR    R10,R0                  ADD IT TO TIMER SUM
         B     TIMELP1R
TIMELP1Z SR    R15,R15                 SET CPU TIMER TO ZERO
TIMELP1D SR    R0,R0                   SET SRB TIMER TO ZERO
TIMELP1R TM    FUNCIND,DISPSRBT        ARE SRB TIMER TO BE DISPL.?
         BZ    TIMELP1S                BR IF NO
         LM    R14,R15,ASCBSRBT(R6)    LOAD SRB TIMER VALUE
         SRDA  R14,22                  R15, BIT 31 = 1024 MICROSEC
TIMELP1S STM   R15,R0,8(R7)            SAVE CPU & SRB TIMER VALUES
         LA    R7,L'TIMEBLK(,R7)       PROCEED TO NEXT TIME ELEMENT
         LA    R5,4(,R5)               PROCEED TO NEXT ASCB
         BCT   R8,TIMELP1A             PROCESS NEXT ASVT ENTRY
         BR    R9                      RETURN
*
         EJECT
DATCB    EQU   *
         SPACE
*        SUBROUTINE TO PROCESS TCB'S
*        R9 - RETURN ADDRESS
         SPACE 2
         STM   R2,R10,DASAVE           SAVE REGISTERS
         L     TCBR,TCBLTC(OTCBR)      GET FIRST SUBTASK TCB
         LTR   TCBR,TCBR               IS THERE ANY
         BZ    DATCBE                  NO, GO BACK
         SR    R8,R8                   CLEAR WORK-REGISTER
         IC    R8,TCBPKF(TCBR)         GET PROTECTION KEY
         SRL   R8,4                    ALIGN IT TO RIGHT HALFWORD
         IC    R8,HEXTAB(R8)           TRANSLATE TO EBCDIC
         STC   R8,XDA2PKF              STORE INTO MSG
         L     R7,TCBTIO(TCBR)         GET TASK I/O TABLE ADDRESS
         ST    R7,SAVETIO              SAVE TIOT ADDR FOR LATER COMP.
         MVC   XDA3INIT(8),0(R7)       PUT IN INITIATOR NAME
         MVC   XDA2INIT(8),0(R7)       PUT IN INITIATOR NAME
         MVC   XDA2JOB(8),8(R7)        PUT IN JOB-NAME
         MVC   XDA2STEP(8),16(R7)      PUT IN STEP-NAME
         MVC   XDA2PROC(8),=CL8' '     BLANK PROC-NAME
         MVC   XDA2RSI(17),MASK        INITIALIZE MASK FIELDS
         LR    R7,TCBR                 SAVE TCB-REGISTER
DATCB1   EQU   *
         LR    TCBR,R7                 SET LOWER TCB ADDRESS
         L     R7,TCBLTC(TCBR)         STEP DOWN TO LOWER TCB
         LTR   R7,R7                   IS THERE ANY LOWER TCB
         BNZ   DATCB1                  YES, SEARCH FOR NEXT
         L     R7,TCBTIO(TCBR)         GET TASK I/O TABLE ADDRESS
         C     R7,SAVETIO              SAME TCB AS BEFORE
         BE    DATCB11                 YES DO NOT PUT IN STEP-NAME
         MVC   XDA2STEP(8),8(R7)       PUT IN STEP-NAME
         MVC   XDA2PROC(8),16(R7)      PUT IN PROC-NAME
DATCB11  EQU   *
         IC    R8,TCBDSP(TCBR)         GET DISPATCHING PRTY
         CVD   R8,DOPWORT              CONVERT IT AND
         ED    XDA2DSP,DOPWORT+6       EDIT IT INTO MSG
         L     R7,TCBRBP(TCBR)         GET LAST CHAINED RB
         IC    R8,RBWCF(R7)            GET WAIT COUNT FIELD
         CVD   R8,DOPWORT              CONVERT IT AND
         ED    XDA2WCT,DOPWORT+6       EDIT IT INTO MSG
         SR    R8,R8                   CLEAR WORK-REGISTER
         L     R6,TCBPQE(TCBR)         POINT TO DUMMY PQE - 8
         LTR   R6,R6                   IS THERE ANY
         BZ    DATCB3                  NO, GO ON
         L     R7,8(R6)                ADDRESS OF FIRST PQE
DATCB2   EQU   *
         A     R8,PQESIZE(R7)          ADD REGION-SIZE OF PQE
         L     R7,PQEFPQE(R7)          ADDRESS OF NEXT PQE
         LTR   R7,R7                   IS THERE ANY
         BNZ   DATCB2                  YES, PROCESS IT
         SRL   R8,10                   CONVERT SIZE TO K-BOUNDARY
DATCB3   EQU   *
         CVD   R8,DOPWORT              CONVERT SIZE AND
         ED    XDA2RSI,DOPWORT+5       EDIT IT INTO MSG
         SPACE
         CLI   TEXT+3,C'T'             TEST OPTION
         BE    DATST                   YES
         SPACE
         L     R0,REG4                 GET MCS CONSOLE ID
         WTO   MF=(E,XDA2)
         SPACE
         CLI   TEXT+3,C'A'             TEST AND NORMAL OPTION
         BE    DATST                   YES DO BOTH
         SPACE
DATCBE   EQU   *
         LM    R2,R10,DASAVE           RESTORE REGISTERS
         BR    R9                      RETURN
         EJECT
DATST    EQU   *
*        TEST FLAGS
         SPACE
         LA    R1,TCBPKF(TCBR)         SHOW TCBFLAGS I
         BAL   R14,HEXBYTE
         MVC   XDA3FLG1,0(R15)
         BAL   R14,HEXBYTE             SHOW TCBFLAGS II
         MVC   XDA3FLG2,0(R15)
         LA    R1,TCBDAR(TCBR)         SHOW TCBDAR FLAGS
         BAL   R14,HEXBYTE
         MVC   XDA3DAR,0(R15)
         LA    R1,TCBCMP(TCBR)         SHOW COMPLETION CODES
         BAL   R14,HEXBYTE
         MVC   XDA3CMP,0(R15)
         SPACE
         L     R0,REG4                 GET MCS CONSOLE ID
         WTO   MF=(E,XDA3)
         SPACE
         B     DATCBE
         SPACE 3
HEXBYTE  EQU   *
         SPACE
*        CONVERT  X'0123ABCD'  --> C'0123ABCD'
         SPACE
         MVO   BYTES,0(4,R1)
         UNPK  DOPWORT,BYTES
         MVZ   DOPWORT,=8X'00'
         TR    DOPWORT,HEXTAB
         LA    R1,4(R1)
         LA    R15,DOPWORT
         BR    R14
         EJECT
DAASCB   EQU   *
         SPACE
*      SUBROUTIINE TO PROCESS ASCB'S
*      R2 - INIT COUNT
*      R6 - ASCB ADDRESS
*      R9 - RETURN ADDRESS
         SPACE
         MVC   XDA4,XDA4DS             MOVE HEADER TO E-FIELD
         LM    R7,R8,ASCBJBNI(R6)      LOAD ADDRESSES OF JOBNAMES
         CLC   0(8,R8),=CL8'INIT'      SECOND JOBNAME = 'INIT'?
         BNE   NOTINIT                 BR IF NO
         LA    R2,1(,R2)               INCREMENT INIT COUNT
         LTR   R7,R7                   ADDR OF FIRST = 0?
         BNZ   JOBDISP                 BR IF NO
         TM    FUNCIND,DISPSYS         ARE SYS ENTRIES TO BE DISPL.?
         BO    NOTINIT                 BR IF YES
         BR    R9
JOBDISP  TM    FUNCIND,DISPJOB         ARE JOBS TO BE DISPLAYED?
         BCR   8,R9                    BR IF NO
         MVC   XDA4TYP,=CL3'JOB'       MOVE TYPE
         LA    R0,8                    R0 = 8
         SLR   R7,R0                   R7 = ADDR (CSCB)
         MVC   XDA4JOBN,CHKEY(R7)      MOVE JOBNAME
         MVC   XDA4STPN,CHSTEP(R7)     MOVE STEPNAME
         MVC   XDA4PRCN,CHPROCSN(R7)   MOVE PROCSTEPNAME
         B     DPRTYEDT
NOTINIT  L     R7,ASCBCSCB(R6)         LOAD CSCB ADDR
         CLI   0(R8),C'*'              '*MASTER*' OR '*AUXSTM*'?
         BNE   NOTSYS                  BR IF NO
         TM    FUNCIND,DISPSYS         ARE 'SYS'-ENTRIES TO BE DISPL.?
         BCR   8,R9                    BR IF NO
         MVC   XDA4JOBN,0(R8)          MOVE JOBNAME
         B     DPRTYEDT
NOTSYS   CLI   CHTRKID(R7),CHTSID      TSU ID?
         BE    TSUSAVE                 BR IF YES
         CLI   CHTRKID(R7),CHJOBID     JOB ID?
         BE    STCDISP                 BR IF NO
         CLI   CHTRKID(R7),CHINITID    INIT ID?
         BCR   7,R9                    BR IF NO
         TM    FUNCIND,DISPSYS         ARE 'SYS'-ENTRIES TO BE DISPL.?
         BO    SYSDISP                 BR IF YES
         BR    R9
STCDISP  TM    FUNCIND,DISPSTC         ARE STC'S TO BE DISPLAYED?
         BCR   8,R9                    BR IF NO
         MVC   XDA4TYP,=CL3'STC'       MOVE TYPE
SYSDISP  MVC   XDA4JOBN,CHCLS(R7)      MOVE JOBNAME
         MVC   XDA4STPN,CHKEY(R7)      MOVE STEPNAME
         MVC   XDA4PRCN,CHPROCSN(R7)   MOVE PROCSTEPNAME
DPRTYEDT SR    R0,R0                   CLEAR R0
         IC    R0,ASCBDP(R6)           INSERT DISP PRIORITY
         CVD   R0,DOPWORT              CONVERT TO DEC
         OI    DOPWORT+7,X'0F'         SIGN = F
         UNPK  XDA4DP,DOPWORT          UNPK DISP PRTY
         LH    R0,ASCBFMCT(R6)         LOAD ALLOC. PAGE FRAME COUNT
         SLA   R0,2
         CVD   R0,DOPWORT              CONVERT TO DEC
         MVC   MASKAREA,=X'402020202120'  MOVE MASK
         ED    MASKAREA,DOPWORT+5      ED FRAME COUNT
         MVC   XDA4REAL(4),MASKAREA+2  MOVE FRAME COUNT
         MVI   XDA4REAL+4,C'K'         MOVE 'K'
         TM    ASCBRCTF(R6),ASCBOUT    ADDRESS SPACE CONSIDERED OUT?
         BZ    *+10                    BR IF NO
         MVC   XDA4REAL,=CL5' SWAP'    MOVE TEXT
*
         TM    FUNCIND,DISPPAGE        DISPLAY PAGE?
         BO    PGDISP                  BR IF YES
         TM    FUNCIND,DISPTIME        DISPLAY TIME?
         BZ    SCDISP                  BR IF NO
         L     R1,12(,R10)             LOAD TIMER DIFF.
         M     R0,=F'400'              MULTIPLY WITH 400
         D     R0,TIMESUM              DIVIDE BY TIMER SUM
         LA    R1,2(,R1)               ROUND
         SRA   R1,2                    DIVIDE BY 4
         CVD   R1,DOPWORT              CONVERT TO DECIMAL
         MVC   XDA4CPU-1(4),=X'40202120'  MOVE ED MASK
         ED    XDA4CPU-1(4),DOPWORT+6  ED
         MVI   XDA4P100,C'%'           MOVE '%'
*
         L     R0,8(,R10)              LOAD TCB CPU TIMER VALUE
         SRDA  R0,22                   VALUE IN MICROSEC
         D     R0,=F'1000000'          VALUE IN SECONDS
         MVI   XDA4SM,C'"'             MOVE SEC SIGN
         SR    R0,R0                   CLEAR R0 FOR DIV
         D     R0,=F'60'               VALUE IN CENTIMIN
         MH    R1,=H'100'              SHIFT MINUTES
         AR    R1,R0                   R1 = MIN * 100 + SEC
         CVD   R1,DOPWORT              CONVERT TO DECIMAL
         MVC   MASKAREA-1(7),=X'402020207D2120'  MOVE ED MASK
         ED    MASKAREA-1(7),DOPWORT+5 ED TIMER VALUE
         MVC   XDA4CPUT,MASKAREA       MOVE TO MSG
         B     OUTPUT
*
PGDISP   L     R1,12(,R10)             LOAD 2. PAGE-IN VALUE
         L     R14,0(,R10)             LOAD 1. PAGE-IN VALUE
         L     R15,24(,R10)            LOAD TOD DIFFERENCE
         BAL   R8,BPAGEVAL             BUILD PAGE/SEC VALUE
         MVC   XDA4PIN,MASKAREA+1      MOVE TO MSG
         L     R1,16(,R10)             LOAD 2. PAGE-OUT VALUE
         L     R14,4(,R10)             LOAD 1. PAGE-OUT VALUE
         BAL   R8,BPAGEVAL             BUILD PAGE/SEC VALUE
         MVC   XDA4POUT,MASKAREA+1     MOVE TO MSG
         L     R1,20(,R10)             LOAD 2. PAGE-REC VALUE
         L     R14,8(,R10)             LOAD 1. PAGE-REC VALUE
         BAL   R8,BPAGEVAL             BUILD PAGE/SEC VALUE
         MVC   XDA4PREC,MASKAREA+1     MOVE TO MSG
         B     OUTPUT
*
SCDISP   LH    R0,ASCBNVSC(R6)         LOAD ALLOC. AUX. SLOT COUNT
*                                          (NON-VAM)
         CVD   R0,DOPWORT              CONVERT TO DEC
         OI    DOPWORT+7,X'0F'         SIGN = F
         UNPK  XDA4NVSC,DOPWORT        UNPK SLOT COUNT
         LH    R0,ASCBVSC(R6)          LOAD ALLOC. AUX. SLOT COUNT
*                                          (VAM)
         CVD   R0,DOPWORT              CONVERT TO DEC
         OI    DOPWORT+7,X'0F'         SIGN = F
         UNPK  XDA4VSC,DOPWORT         UNPK SLOT COUNT
         MVI   XDA4SM,C' '
*
OUTPUT   EQU   *
         CLI   HEADSW,C'Y'             HAS HEADLINE BEEN WRITTEN?
         BE    OUTMESS4                BR IF YES
         MVI   HEADSW,C'Y'             SET SWITCH
         L     R0,REG4                 LOAD CONSOLE ID
         TM    FUNCIND,DISPTIME        TIME DISPLAY
         BO    OUTMESS1                BR IF YES
         TM    FUNCIND,DISPPAGE        PAGE DISPLAY
         BO    OUTMESS2                BR IF YES
         WTO   MF=(E,XDA1S)            WRITE TO OPERATOR
         B     OUTMESS4
OUTMESS1 WTO   MF=(E,XDA1T)            WRITE TO OPERATOR
         B     OUTMESS4
OUTMESS2 WTO   MF=(E,XDA1P)            WRITE TO OPERATOR
OUTMESS4 L     R0,REG4                 LOAD CONSOLE ID
         WTO   MF=(E,XDA4)             WRITE TO OPERATOR
         BR    R9
*
TSUSAVE  EQU   *                       SAVE TS USER ID
         LA    R3,1(,R3)               INCREMENT TS USER COUNT
         TM    FUNCIND,DISPTSU         FUNCTION = TSU?
         BCR   14,R9                   BR IF NO
         MVC   XDA4TYP,=CL3'TSU'       MOVE TYPE
         MVC   XDA4JOBN,CHKEY(R7)      MOVE JOBNAME
         MVC   XDA4PRCN,CHCLS(R7)      MOVE PROCNAME
         B     DPRTYEDT
         EJECT
BTODDIFF LM    R0,R1,TOD1              LOAD TOD-CLOCK VAL 1
BTODDIF1 LM    R14,R15,TOD2            LOAD TOD-CLOCK VAL 2
BTODDIF2 SLR   R15,R1                  SUBTRACT 2. WORDS
         LA    R1,1                    PREPARE FOR NO CARRY
         BC    3,*+6                   BR IF CARRY
         SLR   R14,R1                  SUB ONE - NO CARRY
         SLR   R14,R0                  SUBTRACT 1. WORDS
         SRDA  R14,22                  R15, BIT 31 = 1024 MICROSEC
         ST    R15,TODDIFF             STORE TOD-CLOCK DIFFERENCE
         BR    R2                      RETURN
*
BPAGEVAL SR    R1,R14                  DIFFERENCE OF PAGE VALUES
         BNM   *+6                     BR IF >= 0
         SR    R1,R1                   SET TO ZERO IF NEGATIVE
         M     R0,=F'10240'            MULTIPLY BY SEC/10 * 1024
         DR    R0,R15                  DIVIDE BY TOD DIFFERENCE
         CVD   R1,DOPWORT              CONVERT TO DECIMAL
BPAGEVL1 MVC   MASKAREA-1(7),=X'40202021204B20' MOVE ED MASK
         ED    MASKAREA-1(7),DOPWORT+5 ED PG/SEC VALUE
         BR    R8
*
ONESECND DC    F'100'                  100 CENTISECONDS
THREESEC DC    F'300'                  300 CENTISECONDS
DISPOPT  DS    0CL10
         DC    AL1(3),CL8'JOB',AL1(DISPJOB)
         DC    AL1(3),CL8'STC',AL1(DISPSTC)
         DC    AL1(3),CL8'TSU',AL1(DISPTSU)
         DC    AL1(3),CL8'ALL',AL1(DISPALL)
         DC    AL1(3),CL8'SYS',AL1(DISPSYS)
         DC    AL1(4),CL8'TIME',AL1(DISPTME1)
         DC    AL1(7),CL8'SRBTIME',AL1(DISPSRB1)
         DC    AL1(4),CL8'PAGE',AL1(DISPPAG1)
ANZDOPT  EQU   (*-DISPOPT)/L'DISPOPT
HEXTAB   DC    C'0123456789ABCDEF'     HEXADECIMAL TRANSLATE TABLE
MASK     DC    X'402020202120D240404020212040202120'
         SPACE
         SPACE
XDA1S    WTO   'XDA0001 TYP JOB-NAME STEPNAME PROCNAME DPRTY REAL NVSC *
               VIOSC ',MCSFLAG=REG0,MF=L
         SPACE
XDA1T    WTO   'XDA0001 TYP JOB-NAME STEPNAME PROCNAME DPRTY REAL CPU% *
               JSTIME',MCSFLAG=REG0,MF=L
         SPACE
XDA1P    WTO   'XDA0001 TYP JOB-NAME STEPNAME PROCNAME DPRTY REAL  IN O*
               UT REC',MCSFLAG=REG0,MF=L
         SPACE
XDA2DS   WTO   'XDA0002                                                *
                           ',                                          *
               MCSFLAG=REG0,MF=L
XDA2L    EQU   *-XDA2DS
         SPACE
XDA3DS   WTO   'XDA0003           PK-FLG                   CMP         *
                DAR         ',                                         *
               MCSFLAG=REG0,MF=L
XDA3L    EQU   *-XDA3DS
         SPACE
XDA4DS   WTO   'XDA0004                                                *
                     ',MCSFLAG=REG0,MF=L
XDA4L    EQU   *-XDA4DS
         SPACE
XDA5DS   WTO   'XDA0005 -TYPE-   -IN- -OUT- -REC-    -I/O- TOTAL',     *
               MCSFLAG=REG0,MF=L
XDA5L    EQU   *-XDA5DS
         SPACE
XDA6DS   WTO   'XDA0006 XXXXXXX ZZ9.9 ZZ9.9 ZZ9.9    ZZ9.9 ZZ9.9',     *
               MCSFLAG=REG0,MF=L
XDA6L    EQU   *-XDA6DS
         SPACE
         LTORG
         EJECT
*        EQUATES
         SPACE
*CVT
CVTPTR   EQU   X'10'                   CVT - POINTER
CVTDCB   EQU   X'74'                   ADDRESS OF OPERATING SYSTEM
CVTMVS2  EQU     B'00000001'           MULTIPLE MEMORY OPTION OF
*                                          OS/VS2 IS PRESENT
CVTHEAD  EQU   X'A0'                   ADDRESS OF FIRST TCB IN SYSTEM
CVTPVTP  EQU   X'164'                  ADDRESS OF PVT
*                                        (PAGE VECTOR TABLE)
CVTASVT  EQU   X'22C'                  ADDRESS OF ASVT
*                                        (ADDRESS SPACE VECTOR TABLE)
         SPACE
*TCB
TCBR     EQU   4                       TCB IN PROCESS REGISTER
OTCBR    EQU   5                       ORIGINATING TCB REGISTER
TCBRBP   EQU   X'00'                   ADDRESS OF REQUEST BLOCK
TCBTIO   EQU   X'0C'                   ADDRESS OF TASK I/O TABLE
TCBCMP   EQU   X'10'                   TASK COMLPETION CODE
TCBPKF   EQU   X'1C'                   PROTECTION KEY
TCBFLGS  EQU   X'1D'                   TASK END, ... FLAGS
TCBDSP   EQU   X'23'                   DISPATCHING PRIORITY
TCBNTC   EQU   X'80'                   ADDR OF PREVIOUS TCB ON SUBTASK
TCBOTC   EQU   X'84'                   ADDR OF ORIGINATING TCB
TCBLTC   EQU   X'88'                   ADDR OF LAST TCB ON SUBT. QUEUE
TCBPQE   EQU   X'98'                   ADDR OF DUMMY PQE MINUS 8
TCBDAR   EQU   X'AC'                   DAR FLAGS ×× SEC. NONDISP. BUTS
         SPACE
*RB
RBWCF    EQU   X'1C'                   WAIT COUNT FIELD
         SPACE
*PQE
PQEFPQE  EQU   X'08'                   ADDR OF NEXT PQE
PQESIZE  EQU   X'14'                   SIZE OF REG IN 2K MULTIPLES
         SPACE
*PVT
PVTNPIN  EQU   X'E8'                   # PAGE-IN, EXCL. SWAP AND VIO
PVTNPOUT EQU   X'EC'                   # PAGE-OUT, EXCL. SWAP AND VIO
PVTVAMI  EQU   X'F0'                   # VIO PAGE-IN, EXCL. SWAP
PVTVAMO  EQU   X'F4'                   # VIO PAGE-OUT, EXCL. SWAP
PVTVAMR  EQU   X'F8'                   # VIO RECLAIMS
PVTSPIN  EQU   X'FC'                   # PAGES SWAPPED IN
PVTSPOUT EQU   X'100'                  # PAGES SWAPPED OUT
PVTNPREC EQU   X'104'                  # PAGES RECLAIMED
PVTNSWPS EQU   X'108'                  # SWAP-IN
PVTCAIN  EQU   X'10C'                  # CA NON-VIO PAGE-IN
PVTCAOUT EQU   X'110'                  # CA NON-VIO PAGE-OUT
PVTCAREC EQU   X'114'                  # CA NON-VIO RECLAIM
PVTCAVI  EQU   X'118'                  # CA VIO PAGE-IN
PVTCAVO  EQU   X'11C'                  # CA VIO PAGE-OUT
PVTCAVR  EQU   X'120'                  # CA VIO RECLAIM
         SPACE
*OUXB
OUXBPIN  EQU   X'10'                   INTV PAGE-IN ACCU
OUXBPOUT EQU   X'14'                   INTV PAGE-OUT ACCU
OUXBPREC EQU   X'18'                   INTV RECLAIM ACCU
OUXBVAMI EQU   X'1C'                   INTV VIO PAGE-IN ACCU
OUXBVAMO EQU   X'20'                   INTV VIO PAGE-OUT ACCU
OUXBVAMR EQU   X'24'                   INTV VIO RECLAIM ACCU
OUXBCAPI EQU   X'28'                   INTV CA PAGE-IN ACCU
OUXBCAPR EQU   X'2C'                   INTV CA RECLAIM ACCU
         EJECT
*ASVT
ASVTMAXU EQU   X'204'                  MAX. NUMBER OF ADDRESS SPACES
ASVTENTY EQU   X'210'                  ENTRY FOR EACH POSSIBLE ASID
*                                          IF ASSIGNED: A(ASCB)
*                                          IF ^: A(NEXT AV. ASID)
ASVTAVAL EQU   B'10000000'             ASID AVAILABLE BIT
*                                          IF ASSIGNED: 0
*                                          IF ^: 1
         SPACE 2
*ASCB
ASCBASID EQU   X'24'                   ASID (ADDRESS SPACE IDENTIFIER)
ASCBSEQN EQU   X'26'                   SEQUENCE NUMBER
*                                          ASCB'S POSITION ON THE
*                                          DISPATCHING QUEUE
ASCBDP   EQU   X'2B'                   DISPATCHING PRIORITY
ASCBCSCB EQU   X'38'                   ADDRESS OF CSCB
ASCBEJST EQU   X'40'                   ELAPSED JOB STEP TIMING
ASCBRCTF EQU   X'66'                   FLAGS FOR RCT
ASCBOUT  EQU     B'00000100'               ADDRESS SPACE SWAPPED OUT
ASCBTMLW EQU     B'00000010'               MEMORY IS IN A LONG WAIT
ASCBFLG1 EQU   X'67'                   FLAG FIELD
ASCBSTND EQU     B'00000100'               TCB'S NON-DISPATCHABLE
ASCBVSC  EQU   X'78'                   ALLOC. AUX. SLOT COUNT (VAM)
ASCBNVSC EQU   X'7A'                   ALLOC. AUX. SLOT COUNT (NON-VAM)
ASCBOUXB EQU   X'94'                   SRM USER EXT BLOCK PTR
ASCBFMCT EQU   X'98'                   ALLOCATED PAGE FRAME COUNT
ASCBJBNI EQU   X'AC'                   POINTER TO JOBNAME FIELD FOR
*                                          INITIATED PROGRAMS OR ZERO
ASCBJBNS EQU   X'B0'                   POINTER TO JOBNAME FIELD FOR
*                                          START/MOUNT/LOGON OR ZERO
ASCBSRBT EQU   X'C8'                   ACCUMULATED SRB TIME
         SPACE 2
*CSCB
CHKEY    EQU   X'08'                   1. ID OF A STARTED TASK
*                                  (THIS ID IS THE TASK'S STEPNAME)
*                                      2. JOBNAME OF AN EXECUTED JOB
*
CHCLS    EQU   X'10'                   1. PROCNAME OF A STARTED TASK
*                                  (THE PROCNAME IS THE TASK'S JOBNAME)
*                                      2. JOBNAME OF AN EXECUTED JOB
*                                          (SAME AS CHKEY)
CHUNIT   EQU   X'18'                   UNITNAME (SET FOR STARTED TASKS)
CHTRKID  EQU   X'1C'                   DISPLAY/TRACK IDENTIFIER
CHTSID   EQU     X'01'                     TSU IDENTIFIER
CHJOBID  EQU     X'02'                     JOB IDENTIFIER
CHINITID EQU     X'03'                     INITIATOR IDENTIFIER
CHASID   EQU   X'1E'                   ASID
CHPROCSN EQU   X'20'                   PROCEDURE STEP NAME
CHSTEP   EQU   X'40'                   STEP NAME
         EJECT
         REG
         SPACE 2
         XPARM
         SPACE 2
WORK     DSECT
SAVEAREA DS    18F                     SAVEAREA I
DASAVE   DS    9F                      SAVEAREA II
SAVETIO  DS    F                       SAVEAREA FOR TIOT ADDRESS
NOADRSPC DS    F                       MAXIMUM NUMBER OF ASCB'S
DOPWORT  DS    D                       D-WORD FOR CVD
BYTES    DS    CL5                     WORK-BYTES FOR HEXBYTE
MASKAREA DS    CL6                     WORKAREA FOR ED-MASK
*
FUNCIND  DS    CL1                     FUNCTION INDICATOR
DISPJOB  EQU     X'80'                     DISPLAY JOBS
DISPSTC  EQU     X'40'                     DISPLAY STC
DISPTSU  EQU     X'20'                     DISPLAY TSU
DISPSYS  EQU     X'10'                     DISPLAY SYS
DISPDFLT EQU     X'C0'                     DEFAULT (JOB, STC)
DISPALL  EQU     X'E0'                     DISPLAY ALL
DISPTIME EQU     X'08'                     DISPLAY TIME
DISPSUPP EQU     X'01'                     FIRST ENTRY INDICATOR
DISPSRBT EQU     X'02'                     DISPLAY SRBTIME
DISPPAGE EQU     X'04'                     DISPLAY PAGING ACTIVITY
DISPPAG1 EQU     X'05'                     DISPLAY PAGING, FIRST ENTRY
DISPSRB1 EQU     X'0B'                     DISPLAY SRBTIME, FIRST ENTRY
DISPTME1 EQU     X'09'                     DISPLAY TIME, FIRST ENTRY
*
SPAGEIN  DS    PL4                     PAGE-IN/SEC COUNTER
SPAGEOUT DS    PL4                     PAGE-OUT/SEC COUNTER
SPAGEREC DS    PL4                     PAGE-REC/SEC COUNTER
SPAGEIO  DS    PL4                     PAGE-IO/SEC COUNTER
SPAGETOT DS    PL4                     TOTAL PAGING/SEC COUNTER
*
         DS    0F
XDA2     DS    0C                      START OF XDA0002 MESSAGE
         DS    CL12                    MSG-LENGTH, MCSFLAGS MSG-ID
XDA2INIT DS    CL8                     INITIATOR NAME
         DS    CL3
XDA2PKF  DS    C                       PROTECTION KEY
         DS    C
XDA2JOB  DS    CL8                     JOB-NAME
         DS    C
XDA2STEP DS    CL8                     STEP-NAME
         DS    CL2
XDA2PROC DS    CL8                     PROC-NAME
         DS    C
XDA2RSI  DS    CL6                     REGION SIZE
         DS    CL3
XDA2DSP  DS    CL4                     DISPATCHING PRTY
XDA2WCT  DS    CL4                     WAIT COUNT
         DS    C
XDA2STAT DS    CL10                    STATUS
         DS    CL6                     DESCRIPTOR CODE, ...
         DS    0F
XDA3     DS    0C                      START OF XDA0003 MESSAGE
         DS    CL12
XDA3INIT DS    CL8                     INITIATOR NAME
         DS    CL9
XDA3FLG1 DS    CL8                     PK-FLG I
         DS    C
XDA3FLG2 DS    CL8                     FLG II
         DS    CL5
XDA3CMP  DS    CL8                     TCB COMPL. CODES
         DS    CL5
XDA3DAR  DS    CL8                     DAR FLAGS
         DS    CL6                     DESCRIPTOR CODE, ...
         ORG   XDA2
*
XDA4     DS    0CL(XDA4L)
         DS    CL12                    L OF MSG, FLAGS, 'XDA0004 '
XDA4TYP  DS    CL3                     TYPE (JOB, STC, TSU)
         DS    CL1
XDA4JOBN DS    CL8                     JOBNAME
         DS    CL1
XDA4STPN DS    CL8                     STEPNAME
         DS    CL1
XDA4PRCN DS    CL8                     PROC STEP NAME
         DS    CL2
XDA4DP   DS    CL3                     DISP PRIORITY
         DS    CL1
XDA4REAL DS    CL5                     ALLOCATED PAGE FRAME COUNT
*                                          (9999K)
         DS    CL1
XDA4NVSC DS    CL4                     ALLOCATED AUX. SLOT COUNT
*                                          (NON-VAM)
         DS    CL1
XDA4VSC  DS    CL5                     ALLOCATED AUX. SLOT COUNT (VAM)
         ORG   XDA4NVSC
XDA4CPU  DS    CL3                     CPU USAGE IN %
XDA4P100 DS    CL1                     '%'
XDA4CPUT DS    CL6                     TCB CPU TIME (ZZZ.99)
XDA4SM   DS    CL1                     " × ' × ' '
         ORG   XDA4NVSC
XDA4PIN  DS    CL3                     PAGE-IN/SEC (ZZ9)
         DS    CL1
XDA4POUT DS    CL3                     PAGE-OUT/SEC (ZZ9)
         DS    CL1
XDA4PREC DS    CL3                     PAGE-REC/SEC (ZZ9)
*
         DS    CL3
         ORG   XDA2
*
XDA6     DS    0CL(XDA6L)
         DS    CL12                    L OF MSG, FLAGS, 'XDA0006 '
XDA6TYPE DS    CL7                     TYPE (DEMAND×VIO×SWAP×*TOTAL*)
         DS    CL1
XDA6IN   DS    CL5                     PAGE-IN/SEC (ZZ9.9)
         DS    CL1
XDA6OUT  DS    CL5                     PAGE-OUT/SEC (ZZ9.9)
         DS    CL1
XDA6REC  DS    CL5                     RECLAIM/SEC (ZZ9.9)
         DS    CL4
XDA6PGIO DS    CL5                     PAGE-IO/SEC (ZZ9.9)
         DS    CL1
XDA6PAGE DS    CL5                     TOTAL PAGING RATE (ZZ9.9)
         ORG
*
PAGEVAL1 DS    8F                      PAGING STATISTICS (1. ENTRY)
PAGEVAL2 DS    8F                      PAGING STATISTICS (2. ENTRY)
*
ANZTBLK  EQU   64
         DS    0D
TIMEBLK  DS    0CL16
TIMECPU1 DS    F                       TCB CPU TIMER VALUE 1
TIMESRB1 DS    F                       SRB CPU TIMER VALUE 1
TIMECPU2 DS    F                       TCB CPU TIMER VALUE 2
TIMEDIFF DS    F                       VALUES 2 - VALUES 1
*
         DS    (ANZTBLK-1)CL(L'TIMEBLK) SPACE FOR THE REM. TIMEBLK'S
*
TIMESUM  DS    F                       SUM OF ALL TIME DIFFERENCES
PAGESUM  DS    F                       SUM OF ALL PAGE-IO DIFFERENCES
TOD1     DS    D                       TOD-CLOCK VALUE 1
TOD2     DS    D                       TOD-CLOCK VALUE 2
TODVALUE DS    D                       TOD-CLOCK VALUE
TODDIFF  DS    F                       DIFF OF TOD-CLOCK VALUES
HEADSW   DS    CL1                     "Y" INDICATES "HEADLINE WRITTEN"
         DS    CL3                     RESERVED
*
PAGEBLK  DS    0CL32
PAGEIN1  DS    F                       COUNT OF PAGE-IN 1
PAGEOUT1 DS    F                       COUNT OF PAGE-OUT 1
PAGEREC1 DS    F                       COUNT OF PAGE-REC 1
PAGEIN2  DS    F                       COUNT OF PAGE-IN 2
PAGEOUT2 DS    F                       COUNT OF PAGE-OUT 2
PAGEREC2 DS    F                       COUNT OF PAGE-REC 2
PAGETODD DS    0F                      TOD DIFFERENCE
PAGETOD1 DS    D                       TOD-VALUE 1
*
         DS    (ANZTBLK-1)CL(L'PAGEBLK) SPACE FOR THE REM. PAGEBLK'S
*
         DS    0D
WORKL    EQU   *-WORK                  WORK-AREA LENGTH
         SPACE 2
         END   DA
./ ADD  NAME=DBLDL
DBLDL    START
         REG
         XSAVE R12,,DBLDL,WORKL
         USING WORK,R13
         LR    R11,R1
         USING PARMAREA,R11
         MVI   SWITCH,X'00'
         L     R4,16
         L     R2,32(R4)
         TM    116(R4),X'01'     VS2 REL2.0?
         BNO   NOTMVS1
         SH    R2,=H'64'     /*  DISPLACEMENT MUST BE CHANGED
NOTMVS1  EQU   *                 FOR EVERY RELEASE OF MVS  */
         SH    R2,=H'8'
PROCSVC  EQU   *
         L     R2,0(R2)
         LA    R2,0(R2)
         LTR   R2,R2
         BZ    NTFND
         LH    R3,2(R2)
         LH    R4,0(R2)
         LA    R2,4(R2)
NXTENTRY EQU   *
         CLC   0(8,R2),TEXT+6
         BE    FOUND
         LA    R2,0(R3,R2)
         BCT   R4,NXTENTRY
NTFND    EQU   *
         TM    SWITCH,X'80'
         BO    NOTFNDX
         OI    SWITCH,X'80'
         L     R4,16
         L     R2,32(R4)
         TM    116(R4),X'01'     VS2 REL2.0?
         BNO   NOTMVS2
         SH    R2,=H'72'     /*  DISPLACEMENT MUST BE CHANGED
NOTMVS2  EQU   *                 FOR EVERY RELEASE OF MVS  */
         SH    R2,=H'4'
         B     PROCSVC
NOTFNDX  EQU   *
         MVC   WTO(WTO2-WTO1),WTO1
         MVC   WTO+19(8),TEXT+6
RETURN   EQU   *
         L     R0,REG4
         WTO   MF=(E,WTO)
         XRETURN 0,R
FOUND    EQU   *
         MVC   WTO(CCTAB-WTO2),WTO2
         MVC   WTO+19(8),TEXT+6
         ST    R2,TEXT
         UNPK  WTO+54(7),TEXT+1(4)
         MVI   WTO+60,X'40'
         TR    WTO+54(6),CCTAB-240
         B     RETURN
WTO1     WTO   'XDBLDL1 MODULE 12345678 NOT FOUND IN BLDL',            *
               MCSFLAG=REG0,MF=L
WTO2     WTO   'XDBLDL2 MODULE 12345678 FOUND IN BLDL AT LOCATION 12345*
               6 ',MCSFLAG=REG0,MF=L
CCTAB    DC    C'0123456789ABCDEF'
         XPARM
WORK     DSECT
SVA      DS    18F
WTO      DS    CL100
SWITCH   DS    X
WORKL    EQU   *-WORK
         END
./ ADD  NAME=DDS
XDDS     CSECT
***********************************************************************
*                                                                     *
*      REGISTER EQUATES.                                              *
*                                                                     *
***********************************************************************
         SPACE 3
R0       EQU   0             WORK/MACRO- UND-PARAMETER REGISTER
R1       EQU   1             MACRO- UND-PARAMETER REGISTER
R2       EQU   2             BASISREG
R3       EQU   3
R4       EQU   4
R5       EQU   5
R6       EQU   6
R7       EQU   7
R8       EQU   8
R9       EQU   9
R10      EQU   10
R11      EQU   11            BASISREG. FUER DSECT PARMAREA
R12      EQU   12
R13      EQU   13
R14      EQU   14            RUECKSPRUNGADRESSEN
R15      EQU   15            CSECT-ADRESSEN UND RETURN CODES
*
***********************************************************************
***                                                                 ***
***    DUMPSHOW          ***    VERSION NOVEMBER 1975               ***
***    DISPLAY DUMP STATUS  * FUER SYS1.DUMPXX DATEIEN UNTER MVS    ***
***                                                                 ***
***                                                                 ***
***    AUTHOR : A.CHASSELOUP IBM GERMANY    SE-DVD K+V              ***
***             X-COMM.-ATTACHMENT: R.ZINGSHEIM IBM SE              ***
***                                                                 ***
***********************************************************************
         SPACE 3
         STM   14,12,12(13)
         BALR  2,0
         USING *,2
         ST    13,SAVE+4
         LA    13,SAVE
         LR    R11,R1                  LOAD PARMAREA-ADDRESS
         USING PARMAREA,R11
         MVI   ENDE+1,X'00'
         LA    5,16      PIC UP CVT ADDR.
         L     5,0(5)   PIC UP CVT
         LA    3,4
         SR    5,3  PIC UP RELAESE NUMBER
         MVC   WTO+31(2),0(5)
         MVC   WTO+34(2),2(5)
         LA    5,576(5)    PIC UP RTCT ADDR
         L     5,0(5)   PIC UP RTCT
         LA    5,36(5)    FIRST DUMP D.S. ENTRY
         LA    3,TABDC
         LA    4,1     NO. OF WTO BUFFERS
IFEND    CLI   2(5),X'00' IF END FROM RTMCT
         BE    ENDE OF TABLE RTCT
         MVC   11(2,3),0(5)
         TM    3(5),X'20' IF DUMP TO DASDR
         BNO   S99999     NO, THIS IS TO TAPE
         TM    3(5),X'80'  IF DUMP FULL
         BNO   DSEMP    NO , THIS DUMP D. S. IS EMPTY
         MVC   14(5,3),=C'FULL '
         MVC   20(7,3),=C'TITLE= '
         MVC   DDNAME(2),0(R5)         MODIFY DD-NAME BY ACTUAL DUMPDS
         MVC   DDXX(2),0(R5)              MODIFY DYNALC REQLIST
         MVC   DSNXX(2),0(R5)             MODIFY DYNALC REQLIST
DYNALC   LA    R1,REQBPTR
         SVC   99
         LH    R15,ERR                 LOAD ERROR CODE FIELD
         LTR   R15,R15                 DYNALLOC SUCCESSFUL
         BNZ   FEHLDYNA                NO
OPEN     OPEN  DUMP
NEWGET   GET   DUMP                                        06/01/76
         CLC   0(2,1),=X'FFFF'   IF TITLE RECORD           06/01/76
         BNE   NEWGET            NO                        06/01/76
         MVC   27(42,3),20(1)
         CLOSE DUMP
SWITCH   DS    0H
         MVI   ENDE+1,X'F0'
         B     DSEMP+12
DSEMP    MVC   14(5,3),=C'EMPTY'
         MVC   20(50,3),19(3)
         LA    5,12(5)
         LA    3,74(3)
         LA    4,1(4)
         B     IFEND
ENDE     BC    0,S01050
         L     R0,REG4
         WTO   'XDDS00 ** ALL DUMP DATASETS EMPTY',MCSFLAG=(REG0)
         B     S99999
S01050   STC   4,WTO+45
         LA    1,WTO
         L     R0,REG4
         WTO   MF=(E,(1))
S99999   L     13,SAVE+4
         LM    14,12,12(13)
         XR    15,15
         BR    14
* ENDE OF DUMP
EOF      CLOSE DUMP
         B     DSEMP
FEHLDYNA DS    0H
         MVC   ERRORMSG+23(2),0(R5)
*        TRX   ERR,2
*        MVC   ERRORMSG+52(4),0(R1)
         L     R0,REG4
         WTO   MF=(E,ERRORMSG)
         B     SWITCH
         SPACE 3
ERRORMSG WTO 'XDDS01 ** SYS1.DUMPXX ALLOCATION FAILURE,REASON XXXX',   *
               MF=L,MCSFLAG=(REG0)
*
* DEFINITIONEN
*
SAVE     DS    18F
         LTORG
** DCB FOR ALL SYS1.DUMP DATA SET
*
DUMP     DCB   DSORG=PS,DDNAME=DUMP,RECFM=F,BLKSIZE=4104,LRECL=4104,   *
               EODAD=EOF,MACRF=(GL),BUFNO=1
DDNAME   EQU   DUMP+44
*
WTO      WTO   ('XDDS00     DUMP STATUS VS2-  .  **'),                 *
               ('*                                                 '), *
               DESC=4,MF=L,MCSFLAG=(REG0)
         ORG   WTO+46
         DC    AL2(74),XL2'2000'
TABDC    DC    CL70'* SYS1.DUMPXX FULL',AL2(74),XL2'2000'
         DC    CL70'* SYS1.DUMPXX FULL',AL2(74),XL2'2000'
         DC    CL70'* SYS1.DUMPXX FULL',AL2(74),XL2'2000'
         DC    CL70'* SYS1.DUMPXX FULL',AL2(74),XL2'2000'
         DC    CL70'* SYS1.DUMPXX FULL',AL2(74),XL2'2000'
         DC    CL70'* SYS1.DUMPXX FULL',AL2(74),XL2'2000'
         DC    CL70'* SYS1.DUMPXX FULL',AL2(74),XL2'2000'
         DC    CL70'* SYS1.DUMPXX FULL',AL2(74),XL2'2000'
         DC    CL70'* SYS1.DUMPXX FULL',AL2(74),XL2'2000'
         DC    CL70'* SYS1.DUMPXX FULL'  10. AND LAST WTO
REQLIST  DS    0F
RQPTRID  DC    CL4'REQP'
REQBPTR  DC    X'80'
         DC    AL3(REQBLOK)
REQBLID  DC    CL4'RQBL'
REQBLOK  DS    0F
RBLENG   DC    AL1(20)
RBVERB   DC    AL1(1)
RBFLAGS1 DC    H'0'
RBERR    DC    H'0'
ERR      EQU   RBERR
RBINFO   DC    H'0'
RBTXTPRT DC    AL4(TEXTS)
         DC    F'0'
RBFLAGS2 DC    F'0'
TEXTID   DC    CL4'TXTS'
TEXTS    DC    A(TEXT01)
         DC    A(TEXT02)
         DC    A(TEXT04)
         DC    X'80'
         DC    AL3(TEXT1C)
TEXT01   DS    0H
         DC    XL6'000100010008'
         DC    CL8'DUMPXX'             DDNAME
DDXX     EQU   *-4
TEXT02   DS    0H
         DC    XL6'00020001000B'
         DC    CL11'SYS1.DUMPXX'       DSNAME
DSNXX    EQU   *-2
TEXT04   DS    0H
         DC    XL7'00040001000108'     SHR
TEXT1C   DS    0H
         DC    XL4'001C0000'           FREE = CLOSE
REQLEN   EQU   *-REQLIST
PARMAREA DSECT
REG4     DS    F
TEXT     DS    CL124
PRMLEN   EQU   *-PARMAREA
PARMENDE EQU   *
         END
./ ADD  NAME=DEL
***********************************************************************
*                                                                     *
*        INITIAL PROCESSING.                                          *
*                                                                     *
***********************************************************************
         SPACE 2
XDEL     CSECT
         XSAVE R12,,XDEL,WORKLEN
         USING WORK,R13                 ALLOC. BASE REG. OF WORKAREA
         USING PARMAREA,R11             ALLOC. BASE REG. OF PARMAREA
         LR    R11,R01                  INIT. BASE REG. OF PARMAREA
INIT     EQU   *
         XC    TRTTAB(256),TRTTAB       CLEAR TRANSLATE TABLE
         MVI   MEMBER,C' '              INITIALIZE
         MVC   MEMBER+1(7),MEMBER       MEMBER NAME
         MVI   DSNAME,C' '              INITIALIZE
         MVC   DSNAME+1(43),DSNAME      DSNAME
         MVI   VOLSER,C' '              INITIALIZE
         MVC   VOLSER+1(5),VOLSER       VOLSER
         MVI   PO,X'00'                 INIT. FLAG BYTE FOR PO DATAS.
         MVI   VOL,X'00'                INIT. FLAG BYTE FOR VOL. SPEC.
         MVI   PURGE,X'00'              INIT. FLAG BYTE FOR PUR. SPEC.
         MVI   VOLPURGE,X'00'           INIT. FLAG BYTE FOR VOL×PUR SP.
*
*   SCAN PARAMETERS
*
         CLI   TEXT+3,C','              LOOK FOR FIRST SEPERATOR
         BNE   ERROR                    BRANCH IF NOT FOUND
         MVI   KOMMA,C','               MOVE SEPARATOR TO TRANSL. TAB.
         TRT   TEXT+4(119),TRTTAB       LOOK FOR NEXT SEPERATOR
         BZ    DSNPO                    IF NONE, ONLY DSN. SPECIFIED
         LR    R5,R1                    LOAD ADRESS FOR SECOND SEPERAT.
         OI    VOLPURGE,X'80'           SET FLAG FOR VOL × PURGE SPEC.
DSNPO    EQU   *
         MVI   KOMMA,X'00'              CLEAR TRANSLATE TABLE AGAIN
         MVI   LPAN,C'('                MOVE LEFT PARENTHESIS TO TABLE
         TRT   TEXT(124),TRTTAB         LOOK FOR LEFT PARENTHESIS
         BZ    NOTPO                    IF NONE,SEQUENTIAL DATASET
         LR    R3,R1                    SAVE ADDRESS OF LEFT PAREN.
         MVI   LPAN,X'00'               CLEAR TRANSLATE TABLE AGAIN
         MVI   RPAN,C')'                MOVE RIGHT PARENTHESIS TO TABLE
         TRT   TEXT(124),TRTTAB         LOOK FOR RIGHT PARENTHESIS
         BZ    ERROR                    IF NONE, SYNTAXERROR
         MVI   RPAN,X'00'               CLEAR TRANSLATE TABLE
         LR    R4,R1                    SAVE ADDRESS OF RIGHT PAREN.
         SR    R1,R3                    MEMBERLENGTH+2
         BM    ERROR                    IF NEGATIVE, BRANCH ERROR
         OI    PO,X'80'                 SET FLAG BYTE FOR PO DATASET
         BCTR  R1,0                     DECREASE BY
         BCTR  R1,0                     TWO
         EX    R1,MOVEMEM               BRANCH TO MOVE MEMBER NAME
         LA    R1,TEXT+4                LOAD ADDRESS OF DSN
         LR    R2,R3                    SAVE ADDRESS OF LEFT PAREN.
         SR    R2,R1                    COMPUT LENGTH OF DSN
         BCTR  R2,0                     DECREASE BY ONE
         EX    R2,MOVEDSN               BRANCH TO MOVE DSN
         TM    VOLPURGE,X'80'           TEST FOR VOL × PURGE SPEC.
         BO    VOLUME                   IF SECIFIED, BRANCH
         B     SCRATCH                  ELSE BRANCH TO ASK FOR SCRATCH
NOTPO    EQU   *
         TM    VOLPURGE,X'80'           TEST FOR VOL × PURGE SPEC.
         BO    NAME                     IF SPECIFIED, BRANCH
         MVC   DSNAME(44),TEXT+4        ELSE MOVE DSN
         B     SCRATCH                  BRANCH TO ASK FOR SCRATCH
NAME     EQU   *
         LA    R1,TEXT+4                LOAD ADDRESS OF DSN
         LR    R2,R5                    SAVE ADDRESS OF SECOND SEPERAT.
         SR    R2,R1                    COMPUTE LENGTH OF DSN
         BCTR  R2,0                     DECREASE BY ONE
         EX    R2,MOVEDSN               BRANCH TO MOVE DSN
VOLUME   EQU   *
         CLC   1(5,R5),=C'PURGE'        PURGE SPECIFIED ?
         BNE   VOLFIRST                 IF NOT, VOL FIRST SPECIFIED
         OI    PURGE,X'80'              SET FLAG FOR PURGE
         CLI   6(R5),C','               ANOTHER SEPARETOR ?
         BNE   SCRATCH                  IF NOT, BRANCH TO ASK FOR SCR.
         MVC   VOLSER(6),7(R5)          ELSE MOVE VOLSER
         OI    VOL,X'80'                SET FLAG FOR VOLSER
         B     SCRATCH                  BRANCH TO ASK FOR SCRATCH
VOLFIRST EQU   *
         LA    R2,TEXT+123              LOAD ADDRESS OF TEXTEND
         SR    R2,R5                    COMPUTE LENGTH OF REMAINDER
         BCTR  R2,0                     DECRAESE BY ONE
         MVI   KOMMA,C','               MOVE KOMMA TO TRANSLATE TABLE
         EX    R2,TRT                   BRANCH TO LOOK FOR NEXT SEP.
         BZ    VOLONLY                  IF NONE, BRANCH
         LR    R6,R1                    ELSE SAVE ADDRESS OF THIRD SEP.
         MVI   KOMMA,C' '               CLEAR TRANSLATE TABLE
         SR    R1,R5                    COMPUTE LENGTH OF VOLSER
         BCTR  R1,0                     DECREASE BY
         BCTR  R1,0                     TWO
         EX    R1,MOVEVOL               BRANCH TO MOVE VOLSER
         OI    VOL,X'80'                SET FLAG FOR VOLSER
         CLC   1(5,R6),=C'PURGE'        COMPARE REMAINDER WITH PURGE
         BNE   ERROR                    IF NOT, BRANCH ERROR
         OI    PURGE,X'80'              ELSE SET FLAG FOR PURGE
         B     SCRATCH                  BRANCH TO ASK FOR SCRATCH
VOLONLY  EQU   *
         MVC   VOLSER(6),1(R5)          MOVE VOLSER
         OI    VOL,X'80'                SET FLAG FOR VOLUME SPECIF.
         EJECT
**********************************************************************
*                                                                    *
*        ASK FOR SCRATCH.                                            *
*                                                                    *
**********************************************************************
         SPACE 2
SCRATCH  EQU   *
         MVC   WTO(LMSG05),MSG05        MOVE MESSAGE SKELETON
         LA    R2,ECB                   LOAD ADDRESS OF ECB
         LA    R3,REPLY                 LOAD ADDRESS OF REPLY
         L     R0,REG4                  LOAD UCM-ID.
         TM    PO,X'80'                 TEST FOR PO DATASET
         BO    MOVMEMB                  IF YES, BRANCH TO MEMEBERNAME
         MVC   WTO+71(44),DSNAME        ELSE MOVE DSN TO MESSAGE
         B     M1                       BRANCH AROUND MEMBERNAME
MOVMEMB  EQU   *
         MVC   WTO+71,=C' '             CLEAR MESSAGE
         MVC   WTO+72(43),WTO+70        AREA
         MVC   WTO+63(7),=C'MEMBER '    MOVE CONSTANT TO MSG
         MVC   WTO+70(8),MEMBER         MOVE MEMBERNAME TO MSG
M1       EQU   *
         XC    ECB,ECB                  CLEAR ECB
         WTOR  ,(R3),3,(R2),MCSFLAG=(REG4),MF=(E,WTO)
         WAIT  ECB=ECB                   WAIT FOR REPLY
         CLI   REPLY,C'N'                REPLY=NO?
         BE    UNCATLG                   IF NO,BRANCH TO ASK FOR UNCAT
         CLI   REPLY,C'Y'                REPLY=YES?
         BNE   M1                        IF NOT, BRANCH TO ASK AGAIN
         TM    VOL,X'80'                 ELSE TEST FOR VOLUME SPEC.
         BO    LOOKDEVT                  IF YES, BRANCH TO UCB PROC.
         EJECT
**********************************************************************
*                                                                    *
*        RETRIEVE CATALOG INFORMATION.                               *
*                                                                    *
**********************************************************************
         SPACE 2
         MVC   LOCLIST(16),LOCLISTX      MOVE LOCATELIST SKELETON
         LA    R2,DSNAME                 LOAD ADDRESS OF DSN
         LA    R3,LOCAREA                LOAD ADDRESS OF LOCATE AREA
         ST    R2,LOCLIST+4              STORE ADDRESS OF DSN TO LOCL.
         ST    R3,LOCLIST+12             STORE ADDR. OF LOCAREA TO LOC.
         LOCATE LOCLIST                  RETRIEVE CATALOG INF.
         LTR   R15,R15                   RETURNCODE=0 ?
         BZ    SCRATCHD                  IF YES, BRANCH TO SCRATCH
         CVD   R15,DOPPELW               CONVERT RC TO DECIMAL
         UNPK  RC,DOPPELW                UNPACK RC
         OI    RC+3,X'F0'                MODIFY SIGN
         MVC   WTO(LMSG06),MSG06         MOVE MESSAGE SKELETON
         MVC   WTO+40(2),RC+2            MOVE RC TO MSG
         MVC   WTO+47(44),DSNAME         MOVE DSN TO MSG
         L     R0,REG4                   MOVE UCM-ID.
         WTO   MF=(E,WTO)                EXECUTE MSG
         B     RETURN                    BRANCH RETURN
         EJECT
***********************************************************************
*                                                                     *
*        PROCESSING OF UCB LOOKUP-TABLE.                              *
*                                                                     *
***********************************************************************
         SPACE 2
LOOKDEVT EQU   *
         L     R1,16                     LOAD CVT ADDRESS
         L     R2,40(R1)                 LOAD UCB LOOKUP-TABLE ADDR.
         SR    R4,R4                     CLEAR R4
LOOP     EQU   *
         CLC   0(2,R2),=X'FFFF'          END OF UCB LOOKUP-TABLE ?
         BE    NODEV                     IF YES, NO DEVICE FOUND
         ICM   R4,3,0(R2)                SAVE UCB ADDRESS
         CLC   28(6,R4),VOLSER           COMPARE VOLSER
         BE    MOVEDEV                   IF EQUAL, DEVICE FOUND
         LA    R2,2(,R2)                 LOAD ADDRESS OF NEXT UCB-ADDR.
         B     LOOP                      BRANCH FOR NEXT UCB
NODEV    EQU   *
         MVC   WTO(LMSG07),MSG07          MOVE MESSAGE SKELETON
         MVC   WTO+19(6),VOLSER           MOVE VOLSER TO MSG
         L     R0,REG4                    MOVE UCM-ID.
         WTO   MF=(E,WTO)                 EXECUTE MSG
         B     UNCATLG                    BRANCH TO ASK FOR UNCATLG
MOVEDEV  EQU   *
         XC    LOCAREA(256),LOCAREA      CLEAR LOCATE AREA
         XC    LOCAREA+256(9),LOCAREA+256
         MVC   LOCAREA+6(6),VOLSER        MOVE VOLSER TO LOCATE AREA
         MVC   LOCAREA+2(4),16(R4)        MOVE DEVICETYPE TO LOC. AREA
         LA    R1,1(,0)                   LOAD VOLUME COUNT
         STH   R1,LOCAREA                 STORE VOLUME COUNT TO LOC. A.
         EJECT
**********************************************************************
*                                                                    *
*        SCRATCH PROCESSING FOR SEQUENTIAL DATASETS.                 *
*                                                                    *
**********************************************************************
         SPACE 2
SCRATCHD EQU   *
         TM    PO,X'80'                   DATASET PARTITIONED ?
         BO    SCRATCHM                   IF YES, BRANCH TO SCR. MEM.
         SR    R0,R0                      CLEAR R0
         TM    PURGE,X'80'                PURGE SPECIFIED ?
         BZ    NOPURGE                    IF NOT, SCR. WITHOUT EXPIRAT.
         MVC   DELISTP(16),DELISTXP       MOVE SCRATCHLIST SKELETON
         LA    R6,DSNAME                  LOAD ADDRESS OF DSN
         ST    R6,DELISTP+4               STORE ADDR.OF DSN TO LIST
         LA    R6,LOCAREA                 LOAD ADDRESS OF LOCATE AREA
         ST    R6,DELISTP+12              STORE ADDR. OF LOCAREA
         SCRATCH DELISTP                  SCRATCH DATASET
         LTR   R15,R15                    RETURNCODE=0 ?
         BNZ   SCRERROR                   IF NOT,BRANCH ERROR HANDLING
         B     PUTMSG8                    ELSE PUT MSG
NOPURGE  EQU   *
         MVC   DELIST(16),DELISTX         MOVE SCRATCHLIST SKELETON
         LA    R6,DSNAME                  LOAD ADDRESS OF DSN
         ST    R6,DELIST+4                STORE ADDRESS OF DSN TO LIST
         LA    R6,LOCAREA                 LOAD ADDR. OF LOCATE AREA
         ST    R6,DELIST+12               STORE ADDR. OF LOCATE AREA
         SCRATCH DELIST                   SCRATCH DATASET WITHOUT EXPI.
         LTR   R15,R15                    RETURNCODE=0 ?
         BNZ   SCRERROR                   IF NOT, BRANCH ERROR HANDLING
PUTMSG8  EQU   *
         MVC   WTO(LMSG08),MSG08          MOVE MESSAGE SKELETON
         MVC   WTO+35(44),DSNAME          MOVE DSN TO MSG
         L     R0,REG4                    MOVE UCM-ID.
         WTO   MF=(E,WTO)                 EXECUTE MSG
         B     UNCATLG                    BRANCH TO ASK FOR UNCATLG
SCRERROR EQU   *
         MVC   WTO(LMSG09),MSG09          MOVE MESSAGE SKELETON
         CVD   R15,DOPPELW                CONVERT TO DECIMAL
         UNPK  RC,DOPPELW                 UNPACK RETURNCODE
         OI    RC+3,X'F0'                 MODIFY SIGN
         MVC   WTO+23(2),RC+2             MOVE RETURNCODE TO MSG
         MVC   WTO+30(44),DSNAME          MOVE DSN TO MSG
         L     R0,REG4                    MOVE UCM-ID.
         WTO   MF=(E,WTO)                 EXECUTE MSG
         SR    R4,R4                      CLEAR R4
         LH    R4,LOCAREA                 LOAD VOLUME COUNT
         LA    R2,LOCAREA+2               LOAD ADDRESS DEVICETYPE
VOLLOOP  EQU   *
         CLC   11(1,R2),=X'00'            SCRATCHCODE=0 ?
         BNE   PUTMSG10                   IF NOT, PUT MESSAGE
         MVC   WTO(LMSG15),MSG15          MOVE  MESSAGE SKELETON
         MVC   WTO+35(6),4(R2)            MOVE VOLSER TO MSG
         MVC   WTO+41(2),=C'  '
         L     R0,REG4                    MOVE UCM-ID.
         WTO   MF=(E,WTO)                 EXECUTE MSG
         B     CONTINUE                   BRANCH NEXT VOLUME
PUTMSG10 EQU   *
         MVC   WTO(LMSG10),MSG10          MOVE MESSAGE SKELETON
         SR    R6,R6                      CLEAR R6
         IC    R6,11(R2)                  SAVE SCRATCHCODE
         CVD   R6,DOPPELW                 CONVERT SCRATCHCODE TO DEC.
         UNPK  RC+3(1),DOPPELW            UNPACK SCRATCHCODE
         OI    RC+3,X'F0'                 MODIFY SIGN
         MVC   WTO+25(1),RC+3             MOVE SCRATCHCODE TO MSG
         MVC   WTO+31(6),4(R2)            MOVE VOLSER TO MSG
         L     R0,REG4                    MOVE UCM-ID.
         WTO   MF=(E,WTO)                 EXECUTE MSG
CONTINUE EQU   *
         LA    R2,12(R2)                  LOAD ADDR. NEXT LOCAREA ENTRY
         BCT   R4,VOLLOOP                 DECREASE R4, BRANCH IF R4^=0
         B     UNCATLG                    BRANCH TO ASK FOR UNCATLG
         EJECT
**********************************************************************
*                                                                    *
*        SCRATCH PROCESSING FOR MEMBERS.                             *
*                                                                    *
**********************************************************************
         SPACE 2
*        DYNALLOC
SCRATCHM EQU   *
         LA    R1,DYNAREA                 LOAD ADDRESS OF DYNAREA
         LA    R2,S99RB                   LOAD ADDRESS OF REQUEST BLOCK
         ST    R2,S99RBPTR                STORE RB-ADDR. TO RBPTR
         OI    S99RBPTR,X'80'             MODIFY HIGH ORDER BYTE
         XC    S99RB(RBLEN),S99RB         CLEAR REQUEST BLOCK
         MVI   S99RBLN,RBLEN              MOVE LENGTH TO RB
         MVI   S99VERB,X'01'              SET FLAG BYTE
         MVI   S99FLG11,X'00'             SET FLAG BYTE
         MVI   S99FLG12,X'00'             SET FLAG BYTE
         LA    R2,S99TUPT1                LOAD ADDRESS FIRST TXTUNITPTR
         ST    R2,S99TXTPP                STORE ADDRESS TO RB
         MVI   S99FLG21,X'D9'             SET FLAG BYTE
         MVI   S99FLG22,X'00'             SET FLAG BYTE
         MVI   S99FLG23,X'00'             SET FLAG BYTE
         MVI   S99FLG24,X'00'             SET FLAG BYTE
         LA    R3,S99TUKE1                LOAD ADDRESS FIRST TEXTUNIT
         ST    R3,S99TUPT1                STORE ADDRESS TO TXTUNITPTR
         LA    R4,4(,0)                   GET THE STATUS KEY
         STH   R4,S99TUKE1                STORE KEY TO TEXTUNIT
         LA    R4,1(,0)                   GET NUMBER AND LENGTH OF
         STH   R4,S99TUNU1                PARAMETER AND STORE IT TO
         STH   R4,S99TULN1                THE TEXTUNIT
         MVI   S99TUPA1,X'01'             MOVE PARAMETER
         LA    R3,S99TUKE2                LOAD ADDRESS OF NEXT TEXTUNIT
         ST    R3,S99TUPT2                STORE ADDR. TO NEXT TXTUNITPT
         LA    R4,5(,0)                   GET THE KEY FOR NORMAL DISP.
         STH   R4,S99TUKE2                STORE KEY TO TEXTUNIT
         LA    R4,1(,0)                   GET NUMBER AND LENGTH OF
         STH   R4,S99TUNU2                PARAMETER AND STORE IT TO
         STH   R4,S99TULN2                THE TEXTUNIT
         MVI   S99TUPA2,X'08'             MOVE PARAMETER TO TEXTUNIT
         LA    R3,S99TUKE3                LOAD ADDRESS OF NEXT TEXTUNIT
         ST    R3,S99TUPT3                STORE ADDR. TO NEXT TXTUNITPT
         LA    R4,6(,0)                   GET THE KEY FOR COND. DISP.
         STH   R4,S99TUKE3                STORE THE KEY TO TEXTUNIT
         LA    R4,1(,0)                   GET NUMBER AND LENGTH OF
         STH   R4,S99TUNU3                PARAMETER AND STORE IT TO
         STH   R4,S99TULN3                THE TEXTUNIT
         MVI   S99TUPA3,X'08'             MOVE PARAMETER TO TEXTUNIT
         LA    R3,S99TUKE4                LOAD ADDRESS OF NEXT TEXTUNIT
         ST    R3,S99TUPT4                STORE ADDR. TO NEXT TXTUNITPT
         MVC   S99TUKE4,=X'001C'          STORE THE KEY TO TEXTUNIT
         LA    R4,0(,0)                   GET NUMBER OF PARAMETER
         STH   R4,S99TUNU4                AND STORE IT TO TEXTUNIT
         LA    R3,S99TUKE5                LOAD ADDRESS OF NEXT TEXTUNIT
         ST    R3,S99TUPT5                STORE ADDR. TO NEXT TXTUNITPT
         MVC   S99TUKE5,=X'0055'          STORE KEY TO TEXTUNIT
         LA    R4,1(0)                    GET NUMBER OF PARAMETER
         STH   R4,S99TUNU5                AND STORE IT TO TEXTUNIT
         LA    R4,8(0)                    GET LENGTH OF PARAMETER
         STH   R4,S99TULN5                AND STORE IT TO TEXTUNIT
         MVC   S99TUPA5(8),=CL8' '        MOVE PARAMETER TO TEXTUNIT
         LA    R3,S99TUKE6                LOAD ADDRESS OF NEXT TEXTUNIT
         ST    R3,S99TUPT6                STORE ADDR. TO NEXT TXTUNITPT
         LA    R4,2(,0)                   GET KEY FOR DSNAME ALLOCATION
         STH   R4,S99TUKE6                STORE KEY TO TEXTUNIT
         LA    R4,1(,0)                   GET NUMBER OF PARAMETER
         STH   R4,S99TUNU6                AND STORE IT TO TEXTUNIT
         LA    R4,44(,0)                  GET LENGTH OF PARAMETER
         STH   R4,S99TULN6                AND STORE IT TO TEXTUNIT
         MVC   S99TUPA6(44),DSNAME        MOVE PARAMETER TO TEXTUNIT
         LA    R3,S99TUKE7                LOAD ADDRESS OF NEXT TEXTUNIT
         ST    R3,S99TUPT7                STORE ADDR. TO NEXT TXTUNITPT
         MVC   S99TUKE7,=X'0010'          STORE KEY TO TEXTUNIT
         LA    R4,1(,0)                   GET NUMBER OF PARAMETER
         STH   R4,S99TUNU7                AND STORE IT TEXTUNIT
         LA    R4,6(,0)                   GET LENGTH OF PARAMETER
         STH   R4,S99TULN7                STORE IT TO TEXTUNIT
         MVC   S99TUPA7(6),LOCAREA+6      MOVE PARAMETER TO TEXTUNIT
         LA    R3,S99TUKE8                LOAD ADDRESS OF NEXT TEXTUNIT
         ST    R3,S99TUPT8                STORE ADDR. TO NEXT TXTUNITPT
         MVC   S99TUKE8,=X'0015'          STORE KEY TO TEXTUNIT
         LA    R4,1(,0)                   GET NUMBER OF PARAMETER
         STH   R4,S99TUNU8                AND STORE IT TO TEXTUNIT
         LA    R4,8(,0)                   GET LENGTH OF PARAMETER
         STH   R4,S99TULN8                AND STORE IT TO TEXTUNIT
         LA    R5,DEVTAB                  LOAD ADDR. DEV.TABLE(EBCDIC)
DEVLOOP  EQU   *
         CLC   0(2,R5),=X'FFFF'           END OF DEV.TABLE(EBCDIC) ?
         BE    PUTMSG11                   IF YES, BRANCH TO PUT MSG
         CLC   0(2,R5),LOCAREA+4          IF DEV.TYPE IN DEV.TABLE
         BE    MOVUNIDS                   (EBCDIC), BRANCH TO MOVE TYPE
         LA    R5,12(,R5)                 LOAD ADDR. NEXT TABLE ENTRY
         B     DEVLOOP                    BRANCH TO LOOK AGAIN
PUTMSG11 EQU   *
         MVC   WTO(LMSG11),MSG11          MOVE MESSAGE SKELETON
         MVC   WTO+47(44),DSNAME          MOVE DSN TO MSG
         L     R0,REG4                    MOVE UCM-ID.
         WTO   MF=(E,WTO)                 EXECUTE MSG
         B     RETURN                     BRANCH TO RETURN
MOVUNIDS EQU   *
         TM    LOCAREA+3,X'08'            VIRTUEL DEVICE ?
         BNO   REAL                       IF NOT, BRANCH TO MOVE REAL D
         MVC   S99TUPA8(10),=C'3330V     '   MOVE VIRTUEL DEVICE TYPE
         OI    S99TUPT8,X'80'             SET IND. FOR LAST TEXTUNITPTR
         B     ALLOC                      BRANCH ALLOCATION
REAL     EQU   *
         MVC   S99TUPA8(10),2(R5)         MOVE REAL DEV.TYPE TO TEXTUN.
         OI    S99TUPT8,X'80'             SET IND. FOR LAST TEXTUNITPTR
ALLOC    EQU   *
         DYNALLOC                         DYNAMIC ALLOCATION
         LTR   R15,R15                    RETURNCODE = 0 ?
         BZ    OBTAIN                     IF YES, LOOK FOR DSCB1
PUTMSG12 EQU   *
         CVD   R15,DOPPELW                CONVERT RC TO DECIMAL
         UNPK  RC,DOPPELW                 UNPACK RC
         OI    RC+3,X'F0'                 MODIFY SIGN
         MVC   WTO(LMSG12),MSG12          MOVE MESSAGE SKELETON
         MVC   WTO+24(2),RC+2             MOVE RC TO MSG
         LA    R4,S99RB                   LOAD ADDR. OF REQUEST BLOCK
         UNPK  DOPPELW,4(3,R4)            UNPACK ERROR REASON CODE
         TR    DOPPELW+3(4),TRTAB         TRANSLATE  RIGHT PORTION
         MVC   WTO+40(4),DOPPELW+3        MOVE ERROR REASON CODE TO MSG
         UNPK  DOPPELW,6(3,R4)            UNPACK INFORMATIONAL CODE
         TR    DOPPELW+3(4),TRTAB         TRANSLATE RIGHT PORTION
         MVC   WTO+31(4),DOPPELW+3        MOVE INF. CODE TO MSG
         L     R0,REG4                    MOVE UCM-ID.
         WTO   MF=(E,WTO)                 EXECUTE MSG
         B     RETURN                     BRANCH TO RETURN
*
*    LOOK FOR DSCB1
*
OBTAIN   EQU   *
         MVC   DSCB(16),DSCBX             MOVE CAMLIST SKELETON
         LA    R2,DSNAME                  LOAD ADDR. OF DSNAME
         ST    R2,DSCB+4                  STORE ADDR. TO DSCB
         LA    R2,LOCAREA+6               LOAD ADDR. OF VOLSER
         ST    R2,DSCB+8                  STORE ADDR. TO DSCB
         LA    R2,DSCBAREA                LOAD ADDR. OF AREA
         ST    R2,DSCB+12                 STORE ADDR. TO DSCB
         OBTAIN DSCB                      LOOK FOR DSCB1
         LTR   R15,R15                    RETURNCODE = 0 ?
         BZ    OPEN                       IF YES, BRANCH TO OPEN DATAS.
PUTMSG16 EQU   *
         MVC   WTO(LMSG16),MSG16          MOVE MESSAGE SKELETON
         MVC   WTO+29(44),DSNAME          MOVE DSN TO MSG
         CVD   R15,DOPPELW                CONVERT RC TO DECIMAL
         UNPK  RC,DOPPELW                 UNPACK RC
         OI    RC+3,X'F0'                 MODIFY SIGN
         MVC   WTO+22(2),RC+2             MOVE RC TO MSG
         L     R0,REG4                    MOVE UCM-ID.
         WTO   MF=(E,WTO)                 EXECUTE MSG
         B     UNCATLG                    BRANCH TO ASK FOR UNCATLG
*
*   OPEN DATASET
*
OPEN     EQU   *
         MVC   DCB(DCBLEN),DCBX           MOVE DCB SKELETON
         MVC   DCB+40(8),S99TUPA5         MOVE DDNAME TO DCB
         LA    R4,DCB                     LOAD ADDRESS OF DCB
         ST    R4,DCBADDR                 STORE ADDRESS
         LA    R1,DCBADDR                 LOAD ADDR. OF DCBADDR.
         MVI   0(R1),X'8F'                SET INDICATOR
         SVC   19                         OPEN
         TM    DCB+48,X'10'               OPEN OK ?
         BO    STOW                       IF YES, BRANCH TO DEL. MEMBER
PUTMSG13 EQU   *
         MVC   WTO(LMSG13),MSG13          MOVE MESSAGE SKELETON
         MVC   WTO+28(44),DSNAME          MOVE DSN TO MSG
         L     R0,REG4                    MOVE UCM-ID.
         WTO   MF=(E,WTO)                 EXECUTE MSG
         B     RETURN                     BRANCH TO RETURN
*
*   DELETE THE MEMBER
*
STOW     EQU   *
         LA    R4,DCB                     LOAD ADDRESS OF DCB
         LA    R6,MEMBER                  LOAD ADDRESS OF  MEMBER
         STOW  (R4),(R6),D                STOW
         LTR   R15,R15                    RETURNCODE = 0 ?
         BNZ   PUTMSG14                   IF NOT, BRANCH TO PUT MSG
         MVC   WTO(LMSG15),MSG15          MOVE MESSAGE SKELETON
         MVC   WTO+35(8),MEMBER           MOVE MEMBER TO MSG
         L     R0,REG4                    MOVE UCM-ID.
         WTO   MF=(E,WTO)                 EXECUTE MSG
         LA    R1,DCBADDR                 LOAD ADDRESS  OF DCBADDR
         MVI   0(R1),X'80'                SET INDICATOR
         SVC   20                         CLOSE
         B     RETURN                     BRANCH TO RETURN
PUTMSG14 EQU   *
         MVC   WTO(LMSG14),MSG14          MOVE MESSEAGE SKELETON
         ST    R15,RC                     STORE R15 TO RETURNCODE
         UNPK  DOPPELW,RC+3(2)            UNPACK RC
         TR    DOPPELW+5(2),TRTAB         TRANSLATE RIGHT PORTION
         MVC   WTO+27(2),DOPPELW+5        MOVE RC TO MSG
         ST    R0,RC                      ST R0 TO RETURNCODE
         UNPK  DOPPELW,RC+3(2)            UNPACK RC
         TR    DOPPELW+5(2),TRTAB         TRANSLATE RIGHT PORTION
         MVC   WTO+38(2),DOPPELW+5        MOVE RC TO MSG
         MVC   WTO+45(8),MEMBER           MOVE MEMBERNAME TO MSG
         L     R0,REG4                    MOVE UCM-ID. TO MSG
         WTO   MF=(E,WTO)                 EXECUTE MSG
         LA    R1,DCBADDR                 LOAD ADDR. OF DCBADDR.
         MVI   0(R1),X'80'                SET INDICATOR
         SVC   20                         CLOSE
         B     RETURN                     BRANCH TO RETURN
         EJECT
***********************************************************************
*                                                                     *
*        ASK FOR UNCATLG.                                             *
*                                                                     *
***********************************************************************
         SPACE 2
UNCATLG  EQU   *
         TM    PO,X'80'                   PO DATASET ?
         BO    RETURN                     IF YES, BRANCH TO RETURN
         MVC   WTO(LMSG02),MSG02          MOVE MESSAGE SKELETON
         MVC   WTO+71(44),DSNAME          MOVE DSN TO MSG
WTOUNCAT EQU   *
         XC    ECB,ECB                    CLEAR ECB
         XC    REPLY,REPLY                CLEAR REPLY
         LA    R2,ECB                     LOAD ADDRESS OF ECB
         LA    R3,REPLY                   LOAD ADDRESS OF REPLY
         L     R0,REG4                    LOAD UCM-ID.
         WTOR  ,(R3),3,(R2),MF=(E,WTO)    EXECUTE MSG
         WAIT  ECB=ECB                    WAIT FOR REPLY
         CLI   REPLY,C'N'                 REPLY = NO ?
         BE    RETURN                     BRANCH TO RETURN
         CLI   REPLY,C'Y'                 REPLY = YES ?
         BNE   WTOUNCAT                   IF NOT, ASK AGAIN
         EJECT
***********************************************************************
*                                                                     *
*        UNCATLG PROCESSING.                                          *
*                                                                     *
***********************************************************************
         SPACE 2
         MVC   CATLIST(12),UNCATX         MOVE UNCAT LIST
         LA    R2,DSNAME                  LOAD ADDRESS OF DSN
         ST    R2,CATLIST+4               STORE IT TO UNCAT LIST
         CATALOG CATLIST                  UNCATLG
         LTR   R15,R15                    RETURNCODE = 0 ?
         BZ    UNCATOK                    IF YES, BRANCH TO UNCATLG
         MVC   WTO(LMSG03),MSG03          MOVE MESSAGE SKELETON
         MVC   WTO+30(44),DSNAME          MOVE DSN TO MSG
         CVD   R15,DOPPELW                CONVERT RC TO DECIMAL
         UNPK  RC,DOPPELW                 UNPACK RC
         OI    RC+3,X'F0'                 MODIFY SIGN
         MVC   WTO+23(2),RC+2             MOVE RC TO MSG
         L     R0,REG4                    MOVE UCM-ID.
         WTO   MF=(E,WTO)                 EXECUTE MSG
         B     RETURN                     BRANCH TO RETURN
UNCATOK  EQU   *
         MVC   WTO(LMSG04),MSG04          MOVE MESSAGE SKELETON
         MVC   WTO+35(44),DSNAME          MOVE DSN TO MSG
         L     R0,REG4                    MOVE UCM-ID.
         WTO   MF=(E,WTO)                 EXECUTE MSG
         B     RETURN                     BRANCH TO RETURN
         EJECT
*
*   ERROR PROCESSING.
*
ERROR    EQU   *
         L     R0,REG4
         WTO   'XDEL001 SYNTAX ERROR IN PARMLIST',MCSFLAG=(REG0)
*
*   FREEMAIN WORKAREA AND RETURN
*
RETURN   EQU   *
         XRETURN
         EJECT
***********************************************************************
*                                                                     *
*        MESSAGE SKELETONS.                                           *
*                                                                     *
***********************************************************************
         SPACE 2
MSG03    WTO   'XDEL003 UNCATLG RC=99 FOR XXXXXXXXXXXXXXXXXXXXXXXXXXXXX*
               XXXXXXXXXXXXXXX',MCSFLAG=(REG0),MF=L
LMSG03   EQU   *-MSG03
MSG04    WTO   'XDEL004 UNCATLG SUCCESSFUL FOR XXXXXXXXXXXXXXXXXXXXXXXX*
               XXXXXXXXXXXXXXXXXXXX',MCSFLAG=(REG0),MF=L
LMSG04   EQU   *-MSG04
MSG02    WTOR  'XDEL002 REPLY ''Y'' (YES) OR ''N'' (NO) TO UNCATLG THE *
               DATASET XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX',  *
               MCSFLAG=(REG0),MF=L
LMSG02   EQU   *-MSG02
MSG05    WTOR  'XDEL005 REPLY ''Y'' (YES) OR ''N'' (NO) TO SCRATCH THE *
               DATASET XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX',  *
               MCSFLAG=(REG0),MF=L
LMSG05   EQU   *-MSG05
MSG06    WTO   'XDEL006 CATALOG FAILURE (LOCATE) RC=99 FOR XXXXXXXXXXXX*
               XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX',MCSFLAG=(REG0),MF=L
LMSG06   EQU   *-MSG06
MSG07    WTO   'XDEL007 VOLUME XXXXXX NOT AVAILABLE',MCSFLAG=(REG0),   *
               MF=L
LMSG07   EQU   *-MSG07
MSG08    WTO   'XDEL008 SCRATCH SUCCESSFUL FOR XXXXXXXXXXXXXXXXXXXXXXXX*
               XXXXXXXXXXXXXXXXXXXX',MCSFLAG=(REG0),MF=L
LMSG08   EQU   *-MSG08
MSG09    WTO   'XDEL009 SCRATCH RC=99 FOR XXXXXXXXXXXXXXXXXXXXXXXXXXXXX*
               XXXXXXXXXXXXXXX',MCSFLAG=(REG0),MF=L
LMSG09   EQU   *-MSG09
MSG10    WTO   'XDEL010 SCRATCH CODE=X FOR VOLSER',                    *
               MCSFLAG=(REG0),MF=L
LMSG10   EQU   *-MSG10
MSG11    WTO   'XDEL011 DEVICETYPE NOT IN PROGRAMTABLE FOR XXXXXXXXXXXX*
               XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX',MCSFLAG=(REG0),MF=L
LMSG11   EQU   *-MSG11
MSG12    WTO   'XDEL012 DYNALLOC RC=99, IC=9999, EC=9999',             *
               MCSFLAG=(REG0),MF=L
LMSG12   EQU   *-MSG12
MSG13    WTO   'XDEL013 OPEN FAILED FOR XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX*
               XXXXXXXXXXXXX',MCSFLAG=(REG0),MF=L
LMSG13   EQU   *-MSG13
MSG14    WTO   'XDEL014 STOW FAILED RC=99, REASON=99 FOR XXXXXXXX',    *
               MCSFLAG=(REG0),MF=L
LMSG14   EQU   *-MSG14
MSG15    WTO   'XDEL015 SCRATCH SUCCESSFUL FOR XXXXXXXX',              *
               MCSFLAG=(REG0),MF=L
LMSG15   EQU   *-MSG15
MSG16    WTO   'XDEL016 OBTAIN RC=99 FOR XXXXXXXXXXXXXXXXXXXXXXXXXXXXXX*
               XXXXXXXXXXXXX',MCSFLAG=(REG0),MF=L
LMSG16   EQU   *-MSG16
         EJECT
***********************************************************************
*                                                                     *
*        DECLARATIONS.                                                *
*                                                                     *
***********************************************************************
         SPACE 2
DEVTAB   DC    X'2005'
         DC    C'2305-1    '
         DC    X'2007'
         DC    C'2305-2    '
         DC    X'2008'
         DC    C'2314      '
         DC    X'2009'
         DC    C'3330      '
         DC    X'200A'
         DC    C'3340      '
         DC    X'200B'
         DC    C'3350      '
         DC    X'200D'
         DC    C'3330-11   '
         DC    X'FFFF'
         DC    C'XXXXXXXXXX'
TRTAB    DC    240C'?'
         DC    C'0123456789ABCDEF'
DCBX     DCB   DSORG=PO,MACRF=(W),DDNAME=SYSXXXXX
DCBLEN   EQU   *-DCBX
LOCLISTX CAMLST NAME,0,,0
DELISTXP CAMLST SCRATCH,0,,0,,OVRD
DELISTX  CAMLST SCRATCH,0,,0
UNCATX   CAMLST UNCAT,0
DSCBX    CAMLST SEARCH,0,0,0
         EJECT
***********************************************************************
*                                                                     *
*        COMMANDS FOR EXECUTE STATEMENTS.                             *
*                                                                     *
***********************************************************************
         SPACE 2
MOVEMEM  MVC   MEMBER(0),1(R3)
MOVEDSN  MVC   DSNAME(0),0(R1)
TRT      TRT   1(0,R5),TRTTAB
MOVEVOL  MVC   VOLSER(0),1(R5)
         EJECT
***********************************************************************
*                                                                     *
*        EQUATES.                                                     *
*                                                                     *
***********************************************************************
         SPACE 2
R0       EQU   0
R00      EQU   0
R1       EQU   1
R01      EQU   1
R2       EQU   2
R02      EQU   2
R3       EQU   3
R03      EQU   3
R4       EQU   4
R04      EQU   4
R5       EQU   5
R05      EQU   5
R6       EQU   6
R06      EQU   6
R7       EQU   7
R07      EQU   7
R8       EQU   8
R08      EQU   8
R9       EQU   9
R09      EQU   9
R10      EQU   10
R11      EQU   11
R12      EQU   12
R13      EQU   13
R14      EQU   14
R15      EQU   15
RBLEN    EQU   20
         EJECT
***********************************************************************
*                                                                     *
*        PARMAREA.                                                    *
*                                                                     *
***********************************************************************
         SPACE 2
         XPARM
         EJECT
***********************************************************************
*                                                                     *
*        WORKAREA.                                                    *
*                                                                     *
***********************************************************************
         SPACE 2
WORK     DSECT
SAVEAREA DS    18F'0'
TRTTAB   DS    77C
LPAN     DS    C
         DS    15C
RPAN     DS    C
         DS    13C
KOMMA    DS    C
         DS    148C
PO       DS    C
         DS    0F
MEMLENG  DS    F
MEMBER   DS    CL8
CATLIST  DS    CL12
DSNAME   DS    CL44
VOLSER   DS    CL6
VOL      DS    C
PURGE    DS    C
VOLPURGE DS    C
WTO      DS    34F
ECB      DS    F
REPLY    DS    CL3
DOPPELW  DS    0D
         DS    2F
RC       DS    F
LOCAREA  DS    0D
         DS    265C
LOCLIST  DS    0F
         DS    CL16
DELISTP  DS    0F
         DS    CL16
DELIST   DS    0F
         DS    CL16
DCB      DS    CL96
DYNAREA  DS    0F
S99RBPTR DS    F
S99RB    DS    0F
S99RBLN  DS    CL1
S99VERB  DS    CL1
S99FLG11 DS    CL1
S99FLG12 DS    CL1
S99ERROR DS    H
S99INFO  DS    H
S99TXTPP DS    F
S99RSV01 DS    F
S99FLG21 DS    CL1
S99FLG22 DS    CL1
S99FLG23 DS    CL1
S99FLG24 DS    CL1
S99TUPT1 DS    F
S99TUPT2 DS    F
S99TUPT3 DS    F
S99TUPT4 DS    F
S99TUPT5 DS    F
S99TUPT6 DS    F
S99TUPT7 DS    F
S99TUPT8 DS    F
S99TUKE1 DS    H
S99TUNU1 DS    H
S99TULN1 DS    H
S99TUPA1 DS    CL1
S99TUKE2 DS    H
S99TUNU2 DS    H
S99TULN2 DS    H
S99TUPA2 DS    CL1
S99TUKE3 DS    H
S99TUNU3 DS    H
S99TULN3 DS    H
S99TUPA3 DS    CL1
S99TUKE4 DS    H
S99TUNU4 DS    H
S99TUKE5 DS    H
S99TUNU5 DS    H
S99TULN5 DS    H
S99TUPA5 DS    CL8
S99TUKE6 DS    H
S99TUNU6 DS    H
S99TULN6 DS    H
S99TUPA6 DS    CL44
S99TUKE7 DS    H
S99TUNU7 DS    H
S99TULN7 DS    H
S99TUPA7 DS    CL6
S99TUKE8 DS    H
S99TUNU8 DS    H
S99TULN8 DS    H
S99TUPA8 DS    CL8
DCBADDR  DS    F
DSCB     DS    CL16
DSCBAREA DS    CL140
WORKLEN  EQU   *-WORK
         SPACE 3
         END   XDEL
./ ADD  NAME=DET
DET      START
         XSAVE R12,,DET,WORKLEN
         USING WORK,R13
         USING TCB,R3
         LR    R11,R1
         USING PARMAREA,R11
         USING RB,R6
         MVC   MODULENM,=CL8' '
         LA    R2,TEXT+4
         SR    R3,R3
         LA    R4,9
NEXTCHAR EQU   *
         LA    R5,0(R2,R3)
         CLI   0(R5),C' '
         BE    ENDNM
         LA    R3,1(R3)
         BCT   R4,NEXTCHAR
ERROR    EQU   *
         MVC   WTO(LENMESS1),MESS1
         L     R0,REG4
         WTO   MF=(E,WTO)
         B     RETURN
ENDNM    EQU   *
         LTR   R3,R3
         BZ    ERROR
         BCTR  R3,0
         EX    R3,MVCEX1
         L     R3,16
         L     R3,0(R3)
         L     R3,4(R3)   CURRENT TCB
         L     R3,TCBOTC
         LR    R0,R3
         SR    R1,R1
NEXTCB   EQU   *
         BAL   R14,SCANTCB
         B     NOTFND
         LR    R3,R1
         BAL   R14,SRCHCDE
         B     NEXTCB
NOTFND   EQU   *
         MVC   WTO(LENMESS2),MESS2
         MVC   WTO+19(8),MODULENM
         L     R0,REG4
         WTO   MF=(E,WTO)
         B     RETURN
NODET    EQU   *
         MVC   WTO(LENMESS3),MESS3
         MVC   WTO+19(8),MODULENM
         L     R0,REG4
         WTO   MF=(E,WTO)
         B     RETURN
SRCHCDE  EQU   *
         L     R6,TCBRBP
TESTPRB  EQU   *
         TM    RBSTAB,PRB
         BNZ   NEXTRB
         L     R7,RBCDE
         CLC   MODULENM,8(R7)
         BE    MODFOUND
NEXTRB   EQU   *
         L     R6,RBLINK
         LA    R6,0(R6)
         LA    R3,0(R3)
         CR    R3,R6
         BNE   TESTPRB
         BR    R14
MODFOUND EQU   *
         MVC   PTTRN,PTTRNC
         NC    PTTRN,29(R3)
         BNZ   NODET
         LR    R0,R3
         LA    R1,318
         SLL   R1,12
         L     R3,16
         L     R15,52(R3)
         BALR  R14,R15
RETURN   EQU   *
         XRETURN ,R
         SCANTCB NOSYM
MESS1    WTO   'XDET001 ERROR IN PARAMETER',MCSFLAG=REG0,MF=L
LENMESS1 EQU   *-MESS1
MESS2    WTO   'XDET002 MODULE XXXXXXXX NOT FOUND',MF=L,               *
               MCSFLAG=(REG0)
LENMESS2 EQU   *-MESS2
MESS3    WTO   'XDET003 MODULE 12345678 CANNOT BE DETACHED',MF=L,      *
               MCSFLAG=REG0
LENMESS3 EQU   *-MESS3
PTTRNC   DC    XL5'C4000000F0'
MVCEX1   MVC   MODULENM(0),0(R2)
PRB      EQU   X'C0'
R0       EQU   0
R1       EQU   1
R2       EQU   2
R3       EQU   3
R4       EQU   4
R5       EQU   5
R6       EQU   6
R7       EQU   7
R8       EQU   8
R9       EQU   9
R10      EQU   10
R11      EQU   11
R12      EQU   12
R13      EQU   13
R14      EQU   14
R15      EQU   15
TCB      DSECT
TCBRBP   DS    F ADDRESS OF RB
         DS    30F
TCBJSTCB DS    F ADDRESS OF 1. TCB FOR JOB STEP
TCBNTC   DS    F ADDRESS OF PREVIOUS TCB
TCBOTC   DS    F ADDRESS OF ORIGINATING TCB
TCBLTC   DS    F ADDRESS OF LAST TCB
         DS    11F
         XPARM
RB       DSECT
         DS    CL10
RBSTAB   DS    H STATUS AND ATTR. BITS
RBCDE    DS    F ADDRESS OF CONTENTS DIRECTORY ENTRY
         DS    3F
RBLINK   DS    F ADDRESS OF PREVIOUS RB
WORK     DSECT
SVA      DS    18F
WTO      DS    CL50
MODULENM DS    CL8
PTTRN    DS    CL5
WORKLEN  EQU   *-WORK
         END   DET
./ ADD  NAME=DEVTAB
DEVTAB   DC    X'30008001'
         DC    C'2400  4'
         DC    X'30808001'
         DC    C'2400-16'
         DC    X'30C08001'
         DC    C'2400-26'
         DC    X'34008001'
         DC    C'2400-36'
         DC    X'34208001'
         DC    C'2400-46'
         DC    X'34008003'
         DC    C'3400-36'
         DC    X'34008003'
         DC    C'TAPE  4'
         DC    X'34008003'
         DC    C'BAND  4'
         DC    X'30002001'
         DC    C'2311  4'
         DC    X'30402002'
         DC    C'2301  4'
         DC    X'30002004'
         DC    C'2302  4'
         DC    X'30002003'
         DC    C'2303  4'
         DC    X'30C02008'
         DC    C'2314  4'
         DC    X'30002005'
         DC    C'2321  4'
         DC    X'30702007'
         DC    C'2305-26'
         DC    X'30702007'
         DC    C'DRUM  4'
         DC    X'30702006'
         DC    C'2305-16'
         DC    X'30702009'
         DC    C'3330  4'
         DC    X'30502009'
         DC    C'DISK  4'
DEVEND   EQU   *
./ ADD  NAME=DLPA
DLPA     START
         REG
         XSAVE R12,,DLPA,WORKL
         USING WORK,R13
         LR    R11,R1
         USING PARMAREA,R11
         L     R3,16           CVT-PTR
         L     R4,188(R3)      LPA CDE QUEUE
         LA    R4,0(R4)        CLEAR HIGH-ORDER BYTE
NEXTCDE  EQU   *
         CLC   8(8,R4),TEXT+5
         BE    FOUND
         ICM   R4,7,1(R4)      NEXT CDE ON CDE QUEUE
         BNZ   NEXTCDE
         TM    116(R3),X'02'   DAT?
         BZ    NOTFOUND
         ICM   R0,15,TEXT+5    R0 = LEFT HALF OF NAME
         ICM   R1,15,TEXT+9    R1 = RIGHT HALF OF NAME
         L     R15,352(R3)     ADDR OF IEAVVSMR
         LA    R5,LPDEFND      BRANCH ADDR LPDE TYPE
         BALR  R14,R15         SEARCH LPA DIRECTORY
*      RETURN FROM IEAVVSMR:
*          B  0(R14) MODULE FOUND; R0 CONTAINS LPDE ADDR
*          B  4(R14) MODULE NOT FOUND
         LR    R4,R0           R4 = LPDE ADDR
         BR    R5              BRANCH TO LPDEFND
NOTFOUND MVC   WTO,MESS1
         L     R0,REG4
         MVC   WTO+19(8),TEXT+5
         WTO   MF=(E,WTO)
         B     RETURN
FOUND    EQU   *
LPDEFND  EQU   *
         MVC   WTO,MESS2
         MVC   WTO+19(8),TEXT+5
         UNPK  WTO+48(7),17(4,R4)
         ST    R4,TEXT
         TR    WTO+48(6),CCTAB-240
         L     R0,REG4
         WTO   MF=(E,WTO)
RETURN   EQU   *
         XRETURN ,R
MESS1    WTO   'XDLPA01 MODULE AAAAAAAA NOT IN LPA',MCSFLAG=REG0,MF=L
MESS2    WTO   'XDLPA02 MODULE AAAAAAAA FOUND IN LPA AT LOC XXXXXX',   *
               MCSFLAG=REG0,MF=L
CCTAB    DC    C'0123456789ABCDEF'
         XPARM
WORK     DSECT
SVA      DS    18F
WTO      DS    CL56
WORKL    EQU   *-WORK
         END   DLPA
./ ADD  NAME=DUMP
DUMP     CSECT
         REG
         XSAVE R12,,DUMP,WORKL
         USING WORKAREA,R13
         LR    R11,R1
         USING PARMAREA,R11
         LA    R2,TEXT
* TEST FOR MVS SYSTEM
         L     R3,X'10'(0,0)        LOAD ADDRESS OF CVT
         TM    X'74'(R3),X'01'      MVS SYSTEM?
         BO    MVSSYSTM             BR IF YES
         MVI   FULLWD,X'00'
         MVC   FULLWD+1(40),FULLWD
         XC    ECB,ECB
AGAIN    EQU   *
         LR    R5,R2
         LA    R5,4(R5)
         LA    R4,0
NEXTCHAR EQU   *
         LA    R5,1(R5)
         CLI   0(R5),C','
         BE    PAREND
         CLI   0(R5),C' '
         BE    PAREND
         LA    R4,1(R4)
         B     NEXTCHAR
PAREND   EQU   *
         LR    R6,R4
         SRL   R6,1
         SLL   R6,1
         CR    R6,R4
         BE    NOER
         MVC   ZWI,5(R2)
         MVI   5(R2),X'F0'
         MVC   6(20,R2),ZWI
         B     AGAIN
ERROR    EQU   *
         MVC   WTOBER,ER
RETURN   EQU   *
         L     R0,REG4
         WTO   MF=(E,WTOBER)
         XRETURN ,R
NOER     EQU   *
         LA    R6,4(R2)
         CH    R4,=H'8'
         BH    ERROR
         CH    R4,=H'0'
         BNH   ERROR
         LR    R7,R4
CONTNI   EQU   *
         LA    R6,1(R6)
         NI    0(R6),X'3F'
         BCT   R7,CONTNI
GOON     EQU   *
         LA    R6,5(R2)
         BCTR  R4,0
         EX    R4,TREX
         EX    R4,TRTEX
         BNZ   ERROR
         LA    R4,1(R4)
         LA    R7,4
         SLL   R7,4
         OR    R7,R4
         EX    R7,PCKEX
         LA    R8,1
         LA    R8,8
         LA    R6,5(R4,R2)
         CLI   0(R6),C','
         BNE   LINK
         CLI   1(R6),C','
         BE    CPUID
         LA    R6,1(R6)
         NI    0(R6),X'0F'
         CLC   0(1,R6),=X'08'
         BH    CPUID
         CLI   0(R6),X'00'
         BNH   CPUID
         IC    R8,0(R6)
CPUID    EQU   *
         CLI   1(R6),C','
         BNE   LINK
         CLI   2(R6),C'A'
         BE    SETRPLY
         CLI   2(R6),C'B'
         BNE   LINK
SETRPLY  EQU   *
         MVC   REPLY,2(R6)
         MVI   ECB,X'FF'
LINK     EQU   *
         L     R10,16
         L     R10,164(R10)   R10 = HIGHEST STORAGE-ADDRESS
         LR    R9,R8
         SLL   R9,2
         SR    R10,R9
         LA    R10,1(R10)
         C     R10,FULLWD
         BNH   ERROR
         L     R1,16
         TM    116(R1),X'14'   MP?
         BNO   NOMP
         CLI   ECB,X'FF'
         BE    OKCPUID
         SR    R15,R15
         CLI   687(R15),X'00'
         BNE   NOMP
         CLC   FULLWD,=F'4095'
         BH    NOMP
         MVC   WTOBER,ASK
WTOR     EQU   *
         XC    ECB,ECB
         LA    1,WTOBER
         LA    0,REPLY
         ST    0,0(1,0)
         MVI   0(1),1
         LA    R14,ECB
         ST    14,4(1,0)
         L     R0,REG4
         SVC   35
         WAIT  ECB=ECB
         OI    REPLY,X'40'
         CLI   REPLY,C'A'
         BE    OKCPUID
         CLI   REPLY,C'B'
         BNE   WTOR
OKCPUID  EQU   *
         SR    R15,R15
         CLC   REPLY(1),696(R15)
         BE    NOMP
         L     R14,FULLWD
         A     R14,688(R15)
         ST    R14,FULLWD
NOMP     EQU   *
         MVI   WTOBER,X'40'
         MVC   WTOBER+1(125),WTOBER
         MVC   WTOBER(4),=X'007AE000'
         MVC   WTOBER+122(4),=X'00000000'
         MVI   WTOBER+87,C'*'
         MVI   WTOBER+120,C'*'
         NI    FULLWD+3,X'FC'   FORCE FULLWORD-BOUNDARY
         UNPK  WTOBER+4(9),FULLWD(5)
         TR    WTOBER+4(8),CCTAB-240
         MVI   WTOBER+12,C' '
         LA    R10,WTOBER+15
         LA    R3,WTOBER+88
         L     R9,FULLWD
LOOP     EQU   *
         MVC   FULLWD,0(R9)
         TR    FULLWD,TABLE
         MVC   0(4,R3),FULLWD
         MVC   PARM(4),0(R9)
         BAL   4,CONVXE
         MVC   0(9,R10),PARM
         LA    R9,4(R9)
         LA    R10,9(R10)
         LA    R3,4(R3)
         BCT   R8,LOOP
         B     RETURN
CONVXE   EQU   *
         UNPK  PARM(9),PARM(5)
         TR    PARM(8),CCTAB-240
         MVI   PARM+8,C' '
         BR    4
         EJECT
*---------------------------------------------------------------------*
*                                                                     *
*    'DUMP' PROCESSING FOR MVS SYSTEMS                                *
*                                                                     *
*---------------------------------------------------------------------*
MVSSYSTM EQU   *
* SCAN THE ENTERED COMMAND
*        CLC   TEXT(5),=C'DUMP,'   FIRST 5 BYTES ARE TO BE CONSTANT
*        BNE   PARMERR             IF NOT - ERROR
         MVI   SCANINF,C'S'        SET 'START OF INPUT SCAN'
         MVI   ADDRTYPE,C'V'       SET ADDRESS TYPE TO 'VIRTUAL'
*
         LA    R2,TEXT+5           SET UP ADDRESS OF FIRST BYTE OF
*                                     EXPECTED ADDRESS
ADDRLPS  LA    R0,6                MAX. NUMBER OF CHARACTERS
         SR    R10,R10             R10 IS TO CONTAIN THE GIVEN ADDRESS
*
ADDRLP   CLI   0(R2),C'A'          EXAMINE EACH CHARACTER
         BL    ADDRLPE             BR IF < 'A'
         SLL   R10,4               SHIFT 4 BITS TO LEFT
         IC    R15,0(,R2)          INSERT THE CURRENT CHARACTER
         N     R15,=F'15'          CLEAR ALL BUT THE LAST FOUR BITS
         CLI   0(R2),C'F'          HEXADEC. CHARACTER?
         BH    ADDRLP1             BR IF > 'F'
         LA    R15,9(,R15)         C'A' -> X'A'
         B     ADDRLP2             GO ON
ADDRLP1  CLI   0(R2),C'0'          HEXADEC. CHARACTER?
         BL    PARMERR             BR IF NO
         CLI   0(R2),C'9'          HEXADEC. CHARACTER?
         BH    PARMERR             BR IF NO
ADDRLP2  OR    R10,R15             INSERT NEXT 4 BITS OF ADDRESS
         LA    R2,1(,R2)           ADDRESS OF NEXT CHARACTER
         BCT   R0,ADDRLP           BCT
*
ADDRLPE  CLI   SCANINF,C'S'        START OF INPUT SCAN?
         BE    DIRADDR             BR IF YES
         CLI   SCANINF,C'+'        ADDRESS TO BE MODIFIED?
         BE    ADDADDR             BR IF YES
         CLI   SCANINF,C'-'        ADDRESS TO BE MODIFIED?
         BE    SUBADDR             BR IF YES
         B     PARMERR             BR
DIRADDR  CLI   0(R2),C','          DELIMITER?
         BE    SAVEADDR            BR IF YES
         CLI   0(R2),C' '          END OF INPUT?
         BNE   TESTINDA            BR IF NO
         MVI   SCANINF,C'E'        SET 'ALL INPUT SCANNED'
         B     SAVEADDR            BR
* TEST FOR INDIRECT ADDRESS
TESTINDA CLI   0(R2),C'%'          INDIRECT ADDRESS?
         BNE   TESTMODA            BR IF NO
         LA    R0,3                TEST FOR
         NR    R0,R10                FULLWORD
         BNZ   INDAERR                 BOUNDARY
*
         MODESET KEY=ZERO,MODE=SUP KEY ZERO, SUPERVISOR STATE
         LR    R4,R10              LOAD ADDRESS TO BE TESTED
         BAL   R6,ADDRTEST         GO TEST ADDRESS AVAILABILITY
         L     R10,0(,R10)         LOAD ADDRESS OF ADDRESS
         MODESET KEY=NZERO,MODE=PROB  OLD KEY, PROBLEM STATE
*
         LA    R2,1(,R2)           ADDRESS OF NEXT BYTE
         B     ADDRLPE             BR
* TEST FOR ADDRESS TO BE MODIFIED
TESTMODA ST    R10,PARMADDR        STORE ADDRESS
         CLI   0(R2),C'+'          ADDRESS TO BE MODIFIED?
         BE    ADDRADD             BR IF YES
         CLI   0(R2),C'-'          ADDRESS TO BE MODIFIED?
         BNE   PARMERR             BR IF NO
         MVI   SCANINF,C'-'        SET INDICATOR
         LA    R2,1(,R2)           ADDRESS OF NEXT BYTE
         B     ADDRLPS             BR
ADDRADD  MVI   SCANINF,C'+'        SET INDICATOR
         LA    R2,1(,R2)           ADDRESS OF NEXT BYTE
         B     ADDRLPS             BR
*
ADDADDR  A     R10,PARMADDR        ADD TO GIVEN ADDRESS
         MVI   SCANINF,C'S'        SET INDICATOR
         B     DIRADDR             BR
SUBADDR  L     R15,PARMADDR        SUBTRACT
         SR    R15,R10               FROM
         LR    R10,R15                 GIVEN ADDRESS
         MVI   SCANINF,C'S'        SET INDICATOR
         B     DIRADDR             BR
*
SAVEADDR ST    R10,PARMADDR        SAVE GIVEN ADDRESS,
         SRL   R10,4                 GET THE NEXT LOWER MULTIPLE
         SLL   R10,4                   OF 16
         ST    R10,DUMPADDR        AND SAVE IT
*
         EJECT
* LOOK FOR NUMBER OF FULLWORDS TO BE DUMPED
         LA    R0,4                DEFAULT NUMBER OF BYTES
         ST    R0,PARMNMBR                                *
         CLI   SCANINF,C'E'        ALL INPUT SCANNED?
         BE    TESTNMBR            BR IF YES
SKIPZERO LA    R2,1(,R2)           ADDRESS OF NEXT CHARACTER
         CLI   0(R2),C'0'          SKIP LEADING ZEROES
         BE    SKIPZERO              -
         BL    TESTNMBR            BR IF CHARACTER < '0'
         CLI   1(R2),C','          1 BYTE OF LENGTH INFORMATION?
         BE    PACK1               BR IF YES
         CLI   1(R2),C' '          1 BYTE OF LENGTH INFORMATION?
         BNE   TEST2               BR IF NO
         MVI   SCANINF,C'E'        SET 'ALL INPUT SCANNED'
         B     PACK1
TEST2    CLI   1(R2),C'0'          NUMERIC CHARACTER?
         BL    PARMERR             BR IF NO
         CLI   2(R2),C','          2 BYTES OF LENGTH INFORMATION?
         BE    PACK2               BR IF YES
         CLI   2(R2),C' '          2 BYTES OF LENGTH INFORMATION?
         BNE   PARMERR             BR IF NO
         MVI   SCANINF,C'E'        SET 'ALL INPUT SCANNED'
         B     PACK2
PACK1    PACK  DBLWD,0(1,R2)       PACK ONE DIGIT
         LA    R2,2(,R2)           ADDRESS OF NEXT BYTE
         B     CVBNMBR             GO ON
PACK2    PACK  DBLWD,0(2,R2)       PACK TWO DIGITS
         LA    R2,3(,R2)           ADDRESS OF NEXT BYTE
         B     CVBNMBR             GO ON
*
CVBNMBR  CVB   R0,DBLWD            CONVERT TO BINARY
         LA    R15,40              MAX. VALUE
         CR    R0,R15              COMPARE TO MAX
         BNH   *+6                 IF > MAX :
         LR    R0,R15                SET TO MAX
         SLA   R0,2                MULTIPLY BY 4 -> NUMBER OF BYTES
         ST    R0,PARMNMBR         SAVE THIS NUMBER
*
TESTNMBR TM    PARMADDR+3,X'03'    TEST FOR ALIGNMENT
         BZ    NEXTPARM            FULLWORD - OK
         L     R0,PARMNMBR         LOAD NUMBER OF BYTES TO BE DUMPED
         BO    SUB3NMBR            RIGHTMOST BYTE - SUBTRACT 3
         TM    PARMADDR+3,X'02'    HALFWORD ALIGNMENT?
         BO    SUB2NMBR            YES - SUBTRACT 2
         CLI   PARMNMBR+3,4        IS ONE WORD TO BE DUMPED?
         BNE   SUB1NMBR            BR IF NO
SUB3NMBR BCTR  R0,0                SUBTRACT 1
SUB2NMBR BCTR  R0,0                SUBTRACT 1
SUB1NMBR BCTR  R0,0                SUBTRACT 1
         ST    R0,PARMNMBR         STORE NUMBER OF BYTES TO BE DUMPED
*
         EJECT
* LOOK FOR MORE PARAMETER
NEXTPARM CLI   SCANINF,C'E'        ALL INPUT SCANNED?
         BE    GODUMP              BR IF YES
*
         CLC   0(4,R2),=C'REAL'    ARE REAL ADDRESSES TO BE GIVEN?
         BNE   *+8                 BR IF NO
         MVI   ADDRTYPE,C'R'       SET INDICATOR
*
*
         EJECT
GODUMP   EQU   *
* DUMP THE SPECIFIED ADDRESS RANGE
         L     R4,DUMPADDR         ADDRESS IN MSG
         L     R5,PARMADDR         ADDRESS OF FIRST BYTE TO BE DUMPED
DUMPLP1  MVC   WTODUMP,WTODUMPL    MOVE MSG SKELETON
* PROCESSING FOR AVOIDING A 0C4
         MODESET MODE=SUP,KEY=ZERO SET SUPERVISOR STATE
         BAL   R6,ADDRTEST         GO TEST ADDRESS AVAILABILITY
*
         LR    R7,R5
         SR    R7,R4
         LA    R8,16
         SR    R8,R7               NUMBER OF CHARACTERS
         L     R0,PARMNMBR         LOAD NUMBER OF BYTES
         CR    R8,R0               COMPARE TO NUMBER OF BYTES
         BNH   *+6                 BR IF ^>
         LR    R8,R0               LOAD NUMBER OF BYTES
         SR    R0,R8               SUBTRACT
         ST    R0,PARMNMBR           AND STORE NUMBER OF BYTES LEFT
         LA    R7,WTOCHAR(R7)      ADDRESS OF FIRST CHARACTER
         LR    R9,R5
         SR    R9,R4
         SLA   R9,1
         ST    R9,HELPWORD
         SRA   R9,3
         A     R9,HELPWORD
         LA    R9,WTOHEX(R9)       ADDRESSE OF FIRST HEXADEC. DIGIT
*
DUMPLP2  MVC   0(1,R7),0(R5)       MOVE CHARACTER
         UNPK  HELPWORD(3),0(2,R7) UNPK CHARACTER
         MVC   0(2,R9),HELPWORD    MOVE 2 HEX DIGITS
         TR    0(2,R9),CCTAB-240   TRANSLATE
         TR    0(1,R7),TABLE       TRANSLATE
         LA    R5,1(,R5)           ADDR OF NEXT BYTE
         LA    R7,1(,R7)            "
         LA    R9,2(,R9)            "
         ST    R5,DUMPADDR         STORE ADDR OF CURR. BYTE
         TM    DUMPADDR+3,X'03'    WORD BOUNDARY?
         BNZ   *+8                 BR IF NO
         LA    R9,1(,R9)           SKIP ONE BYTE IN MSG
         BCT   R8,DUMPLP2          BCT
*
         LR    R9,R4               LOAD VIRTUAL ADDRESS
         CLI   ADDRTYPE,C'R'       IS REAL ADDRESS TO BE WRITTEN?
         BNE   *+8                 BR IF NO
         LRA   R9,0(,R4)           LOAD REAL ADDRESS
         ST    R9,HELPWORD         STORE THIS ADDRESS
         UNPK  WTOADDR(7),HELPWORD+1(4)  UNPK THIS ADDRESS
         TR    WTOADDR,CCTAB-240   TRANSLATE TO 0-F
         MVI   WTOSPC1,C' '        MOVE BLANK
*
         MODESET MODE=PROB,KEY=NZERO  RETURN TO PROB STATE
*
         L     R0,PARMNMBR         LOAD NUMBER OF BYTES LEFT
         LTR   R0,R0               IS NUMBER = 0?
         BNP   RETURN              BR IF YES
*
         L     R0,REG4             LOAD CONSOLE ID
         WTO   MF=(E,WTODUMP)      WRITE TO OPERATOR
*
         LA    R4,16(,R4)          INCREMENT DUMP ADDRESS
         B     DUMPLP1               AND PREPARE NEXT LINE
*
         EJECT
* TEST AN ADDRESS FOR DAT-ERROR
ADDRTEST EQU   *
         SR    R1,R1               CLEAR R1 (IS TO CONTAIN THE CC)
         LRA   R9,0(,R4)           GET REAL ADDRESS
         BCR   8,R6                CC = 0: OKAY
         BC    4,DATCC1            CC = 1: SEGMENT-TABLE ENTRY INVALID
         BC    2,DATCC2            CC = 2: PAGE-TABLE ENTRY INVALID
         BC    1,DATCC3            CC = 3: SEGMENT- OR PAGE-TABLE
*                                            LENGTH VIOLATION
DATCC3   LA    R1,1(,R1)           ADD 1 TO R1
DATCC2   LA    R1,1(,R1)           ADD 1 TO R1
DATCC1   LA    R1,1(,R1)           ADD 1 TO R1
         STH   R1,DATCC            STORE THE CC
         CLI   DATCC+1,2           CC = 2?
         BNE   DATERROR
* EXAMINE GETMAIN-BIT IN PTE
         L     R1,=A(X'00FFF000')  LOAD BIT MASK
         NR    R1,R9               COMPUTE
         SRL   R1,8                  OFFSET IN PFT
         L     R15,X'164'(,R3)     PVTP
         L     R15,X'0C'(,R15)     PFT ORIGIN
         LA    R15,0(R1,R15)       ADDRESS OF PFTE
         SR    R14,R14             CLEAR R14 FOR ICM
         ICM   R14,6,2(R15)        INSERT VBN
         LA    R0,X'00000FFF'      LOAD BIT MASK
         NR    R9,R0               CLEAR CORR BITS
         OR    R9,R14              GET VIRT ADDRESS OF PTE
         TM    1(R9),X'01'         GETMAIN-BIT ON?
         BZ    DATERROR            BR IF NO
         BR    R6                  OKAY
*
PARMERR  B     ERROR
*
DATERROR EQU   *                   DYNAMIC ADDRESS TRANSLATION ERROR
         MODESET MODE=PROB,KEY=NZERO  RESET TO PROBLEM STATE
         MVC   WTOCCMSG,DATCCMSG  MOVE MSG SKELETON
         MVC   WTOCC,DATCC+1      MOVE CC
         OI    WTOCC,X'F0'        SET ZONE
         ST    R4,HELPWORD        STORE VIRTUAL ADDRESS
         UNPK  WTOCCADR(7),HELPWORD+1(4)  UNPK ADDRESS
         TR    WTOCCADR,CCTAB-240 CONVERT TO 0-F
         B     RETURN
*
INDAERR  EQU   *                  ADDRESS ERROR ROUTINE
         MODESET KEY=NZERO        RETURN TO OLD KEY
         MVC   INDAMSG,INDAMSGL   MOVE MSG SKELETON
         ST    R10,HELPWORD       STORE ADDRESS
         UNPK  INDAADDR(7),HELPWORD+1(4)  UNPK ADDRESS
         TR    INDAADDR,CCTAB-240 TRANSLATE TO 0-F
         MVI   INDAADDR+6,C' '    MOVE BLANK
         B     RETURN
         EJECT
ER       WTO   'XDUMP01 ERROR IN PARAMETER',MCSFLAG=REG0,MF=L
ASK      WTOR  'XDUMP02 REPLY CPU-ID (''A'' OR ''B'').',               *
               MCSFLAG=(REG0),MF=L
WTODUMPL WTO   'ABCDEF  ........ ........ ........ ........ *          C
                     *',MCSFLAG=REG0,MF=L
DATCCMSG WTO   'XDUMP04 LRA CC=0,VIRTUAL ADDRESS=      ',              *
               MCSFLAG=REG0,MF=L
INDAMSGL WTO   'XDUMP05 ADDRESS ABCDEF DOES NOT CONTAIN AN ADDRESS',   *
               MCSFLAG=REG0,MF=L
TREX     TR    0(1,R6),TRTAB
PCKEX    PACK  FULLWD(0),0(0,R6)
TRTEX    TRT   0(0,R6),ZEROES
MVCEX    MVC   0(0,R4),DBLWD
TRTAB    DS    0CL64
         DC    X'FF0A0B0C0D0E0F'
         DC    41XL1'FF'
         DC    X'00010203040506070809'
         DC    6XL1'FF'
         DC    0F'0'
ZEROES   DC    16XL1'0'
TABLE    DC    0F'0'
         DC    C'................'
         DC    C'................'
         DC    C'................'
         DC    C'................'
         DC    C' .........Ö.<(+×'
         DC    C'&&.........!$*);^'
         DC    C'-/.........,%_>?'
         DC    C'..........:#@''="'
         DC    C'................'
         DC    C'................'
         DC    C'................'
         DC    C'................'
         DC    C'.ABCDEFGHI......'
         DC    C'.JKLMNOPQR......'
         DC    C'..STUVWXYZ......'
         DC    C'0123456789......'
CCTAB    DC    C'0123456789ABCDEF'
         EJECT
WORKAREA DSECT
SVA      DS    18F
FULLWD   DS    F
         DS    X
DBLWD    DS    D
         DS    X
PARM     DS    0F
         DS    CL9
         DS    0F
WTOBER   DS    CL126
ECB      DS    F
REPLY    DS    X
ZWI      DS    CL20
*
PARMADDR DS    F                   DUMP ADDRESS
DUMPADDR DS    F                   NEXT LOWER MULTIPLE OF 16
PARMNMBR DS    F                   NUMBER OF BYTES TO BE DUMPED
HELPWORD DS    F                   RESERVED
DATCC    DS    H                   CONDITION CODE AFTER LRA
ADDRTYPE DS    CL1                 ADDRESS TYPE INFORMATION
SCANINF  DS    CL1                 'INPUT SCAN' INFORMATION
         ORG   WTOBER
WTODUMP  DS    0CL66               DUMP AREA
         DS    F                   RDW
WTOADDR  DS    CL6
WTOSPC1  DS    CL2
WTOHEX   DS    4CL9
WTOSPC2  DS    CL1
WTOCHAR  DS    CL16
WTOSPC3  DS    CL1
         ORG   WTOBER
WTOCCMSG DS    0CL43               DAT ERROR MSG AREA
         DS    F
         DS    CL15                'XDUMP04 LRA CC='
WTOCC    DS    CL1                 LRA CC
         DS    CL17                ',VIRTUAL ADDRESS='
WTOCCADR DS    CL6                 VIRTUAL ADDRESS
         ORG   WTOBER
INDAMSG  DS    0CL54               IND ADDR ERROR MSG AREA
         DS    F
         DS    CL16                'XDUMP05 ADDRESS '
INDAADDR DS    CL6                 ADDRESS
         DS    CL28                ' DOES NOT CONTAIN AN ADDRESS'
         ORG
WORKL    EQU   *-WORKAREA
         XPARM
         END   DUMP
./ ADD  NAME=DVOL
         TITLE 'XDVOL                             X-COMMAND DVOL'
DVOL     CSECT
         SPACE 3
***********************************************************************
*                                                                     *
*      PROGRAM-ID. DVOL.                                              *
*      AUTHOR. EHNERT.                                                *
*      INSTALLATION. BAYER AG, LEVERKUSEN, RECHENZENTRUM.             *
*      DATE-WRITTEN. 7. 10. 1975.                                     *
*      REMARKS.                                                       *
*                                                                     *
*          DAS X-COMMAND 'DVOL' GIBT INFORMATIONEN UEBER DEN          *
*          STATUS DER ALS PARAMETER SPEZIFIZIERTEN VOLUMES AUS.       *
*                                                                     *
*          ALS PARAMETER KOENNEN BIS ZU ZEHN VOLSER- ODER ADRESS-     *
*          MASKEN ANGEGEBEN WERDEN, MIT DEREN HILFE EINE AUSWAHL      *
*          GETROFFEN WIRD. DABEI STEHT '*' FUER JEDES ZEICHEN AN      *
*          DIESER STELLE.                                             *
*          ALS WEITERE AUSWAHL-PARAMETER KOENNEN DEVICE-TYPEN (DASD,  *
*          MSS, TAPE, UR, TP, GRAPHIC) UND DEVICE-STATUS (ONLINE,     *
*          OFFLINE, READY) ANGEGEBEN WERDEN.                          *
*                                                                     *
*          WIRD DAS PROGRAMM UNTER DEM NAMEN 'DVOL' AUFGERUFEN,       *
*          SO GELTEN DIE SPEZIFIZIERTEN PARAMETER ALS VOLSER-         *
*          MASKEN, WIRD ES UNTER DEM NAMEN 'UNIT' AUFGERUFEN,         *
*          SO GELTEN DIE SPEZIFIZIERTEN PARAMETER ALS ADRESS-         *
*          MASKEN.                                                    *
*                                                                     *
***********************************************************************
         EJECT
***********************************************************************
*                                                                     *
*      INITIAL PROCESSING.                                            *
*                                                                     *
***********************************************************************
         SPACE 3
*
*      SAVE REGISTER CONTENTS,
*      GETMAIN FOR WORK AREAS,
*      ALLOCATION OF BASE REGISTERS.
*
         SPACE 1
         XSAVE R12,,DVOL,WKAREALN
         SPACE 1
         LR    R11,R01                 INITIALIZE BASE REG. OF PARMAREA
         USING UCB,R03                 ALLOC. BASE REG. OF UCB
         USING UCBCMEXT,R09            ALLOC. BASE REG. OF UCB EXTENT
         USING MESSAGE,R10             ALLOC. BASE REG. OF MESSAGE
         USING PARMAREA,R11            ALLOC. BASE REG. OF PARMAREA
         USING WKAREA,R13              ALLOC. BASE REG. OF WKAREA
         EJECT
*
*      INITIALIZE WORK AREAS.
*
         SPACE 1
         MVI   VOLBYTE,X'00'           CLEAR FLAG BYTE
         MVI   VOLBYTE,X'00'           CLEAR FLAG BYTE
         MVI   WTORBYTE,X'FF'          SET FLAG
         LA    R02,ENDTAB1             LOAD ADDRESSES OF
         LA    R03,ENDTPVOL                TABLE ENDS AND
         STM   R02,R03,ADDRETB1            STORE THEM
         MVC   UCMID,REG4              MOVE UCM ID. OF CALLER
         MVC   PNAME,TEXT              MOVE NAME OF PROGRAM
         MVC   HEADER(LENMSG01),MSG01  MOVE HEAD LINE
         LA    R10,HEADER              INITIALIZE BASE REG. OF MESSAGE
         MVC   MSGNAME,PNAME           MOVE NAME OF PROGRAM
         MVC   WTOR(LENMSG05),MSG05    MOVE WTOR MESSAGE
         LA    R10,WTOR                INITIALIZE BASE REG. OF MESSAGE
         MVC   WTORNAME,PNAME          MOVE PROGRAM NAME
         MVI   CPUBYTE,X'00'           CLEAR FLAG BYTE
         MVI   PRMFLAGS,X'00'
         MVC   PRMFLAGS+1(PFLAGLEN-1),PRMFLAGS
         MVI   WTOBYTE,X'00'           CLEAR FLAG BYTE
         LA    R02,PJOBNAME            LOAD ADDRESS OF JOB NAME
         LA    R03,PSTEPNME            LOAD ADDRESS OF STEP NAME
         STM   R02,R03,PJNMEADR        STORE ADDRESSES
         OI    PSNMEADR,X'80'          INDICATE LAST ENTRY
         SPACE 2
*
*      SET FLAG BYTES IN MESSAGE AREA.
*
         SPACE 1
         LA    R10,MSGTAB              LOAD ADDRESS OF TABLE
         ST    R10,SAVE1R10                AND STORE IT
         L     R03,ADDRETB1            LOAD ADDRESS OF TABLE END
CLEARMSS EQU   *
         MVC   MSGFLAG,=X'FFFF'        SET FLAGS
         LA    R10,68(R10)             LOAD ADDRESS OF NEXT ENTRY
         CR    R10,R03                 TABLE END ?
         BL    CLEARMSS                BRANCH IF NOT
         SPACE 1
         L     R02,16                  LOAD ADRESSE OF CVT
         TM    116(R02),X'10'          SYSTEM = MVS ?
         BZ    GETPARM                 BRANCH IF NOT
         L     R02,764(R02)            LOAD ADRESSE OF PCCAVT
         LTR   R02,R02                 PCCAVT AVAILABLE ?
         BZ    GETPARM                 BRANCH IF NOT
         CLC   0(4,R02),=XL6'0'        CPU 0 AVAILABLE ?
         BE    *+8                     BRANCH IF NOT
         OI    CPUBYTE,X'F0'           SET FLAGS
         CLC   4(4,R02),=XL6'0'        CPU 1 AVAILABLE ?
         BE    GETPARM                 BRANCH IF NOT
         OI    CPUBYTE,X'0F'           SET FLAGS
         EJECT
***********************************************************************
*                                                                     *
*      INPUT PARAMETER PROCESSING.                                    *
*                                                                     *
***********************************************************************
         SPACE 3
GETPARM  EQU   *
         CLC   TEXT(4),=C'DVOL'        VOLUMES SPECIFIED ?
         BNE   *+8                     BRANCH IF NOT
         MVI   VOLBYTE,X'FF'           SET FLAG
         LA    R04,TEXT+4              LOAD ADDRESS OF PARAMETER CHAIN
         LA    R08,PARMEND             LOAD ADDRESS OF PARAMETER END
         LA    R06,TABPVOL1            LOAD ADDRESS OF VOLUME TABLE
         CLI   0(R04),C','             PARAMETERS SPECIFIED ?
         BNE   NOPARM                  BRANCH IF NOT
NEXTPARM EQU   *
         SR    R05,R05                 ZERO LENGTH COUNT
         LR    R07,R04                 LOAD ADDRESS OF SEPERATOR
NXTBYTE  EQU   *
         LA    R04,1(R04)              LOAD ADDRESS OF NEXT CHARACTER
         CR    R04,R08                 END OF PARAMETER CHAIN ?
         BNL   PRMERROR                IF YES, BRANCH TO ERROR ROUTINE
         CLI   0(R04),C','             END OF PARAMETER ?
         BE    NEXTPVOL                BRANCH IF YES
         CLI   0(R04),X'00'            END OF PARAMETER CHAIN ?
         BE    NEXTPVOL                BRANCH IF YES
         CLI   0(R04),C' '             END OF PARAMETER CHAIN ?
         BE    NEXTPVOL                BRANCH IF YES
         LA    R05,1(R05)              INCREASE LENGTH COUNT
         CLI   0(R04),C'*'             DON'T CARE CHARACTER ?
         BNE   NXTBYTE                 BRANCH IF NOT
         MVI   0(R04),X'FF'            TRANSLATE CHARACTER
         B     NXTBYTE                 BRANCH
         EJECT
NEXTPVOL EQU   *
         BAL   R14,SETFLAGS            BRANCH TO SET FLAGS
         C     R06,ADDRETPV            END OF TABLE ?
         BNL   PRMERROR                IF YES, BRANCH TO ERROR ROUTINE
         C     R05,=F'6'               VALID LENGTH ?
         BH    PRMERROR                IF NOT, BRANCH TO ERROR ROUTINE
         LTR   R05,R05                 VALID LENGTH ?
         BZ    PRMERROR                IF NOT, BRANCH TO ERROR ROUTINE
         BCTR  R05,0                   MODIFY FOR EX COMMAND
         EX    R05,MOVEPVOL            BRANCH TO MOVE VOLSER NUMBER
         STC   R05,0(R06)              STORE LENGTH
         LA    R06,7(R06)              LOAD ADDRESS OF NEXT ENTRY
         CLI   0(R04),C','             MORE PARAMETERS IN CHAIN ?
         BE    NEXTPARM                BRANCH IF YES
         SPACE 2
*
*      END OF PARAMETER PROCESSING.
*
         SPACE 1
ENDPARM  EQU   *
         MVI   0(R06),X'80'            INDICATE END OF TABLE
         MVC   TABPVOL2,TABPVOL1       COPY TABLE
         LA    R06,TABPVOL2-1          LOAD ADDRESS OF TABLE
NEXTFF   EQU   *
         LA    R06,1(R06)              LOAD ADDRESS OF NEXT CHARACTER
         CLI   0(R06),X'80'            END OF TABLE ?
         BE    GETFASID                BRANCH IF YES
         CLI   0(R06),X'FF'            CHARACTER = X'FF' ?
         BNE   NEXTFF                  BRANCH IF NOT
         MVI   0(R06),X'00'            TRANSLATE CHARACTER
         B     NEXTFF                  BRANCH
         SPACE 1
NOPARM   EQU   *
         MVI   NOPMFLAG,X'FF'          SET FLAG
         B     ENDPARM                 BRANCH
         EJECT
***********************************************************************
*                                                                     *
*      SET PARAMETER FLAGS.                                           *
*                                                                     *
***********************************************************************
         SPACE 3
SETFLAGS EQU   *
         LA    R01,PRMTABLE-10         LOAD ADDRESS OF TABLE
         LA    R02,PRMFLAGS            LOAD ADDRESS OF FLAG BYTES
         SR    R03,R03                 ZERO FOR IC COMMAND
SETFLGLP EQU   *
         LA    R01,10(R01)             LOAD ADDRESS OF NEXT ENTRY
         LA    R02,1(R02)              LOAD ADRESS OF NEXT FLAG BYTE
         CLI   0(R01),X'FF'            END OF TABLE ?
         BER   R14                     RETURN IF YES
         IC    R03,0(R01)              INSERT LENGTH
         EX    R03,CLCPARM             BRANCH TO COMPARE PARAMETERS
         BNE   SETFLGLP                BRANCH IF NOT EQUAL
         MVI   PARMFLAG,X'FF'          SET FLAGS
         MVI   0(R02),X'FF'            SET FLAGS
         CLI   0(R04),C','             MORE PARAMETERS IN CHAIN ?
         BE    NEXTPARM                BRANCH IF YES
         B     ENDPARM                 BRANCH
         SPACE 2
GETFASID EQU   *
         LOAD  EP=FASID                LOAD ENTRY POINT ADDRESS
         ST    R00,FASIDADR                AND STORE IT
         EJECT
***********************************************************************
*                                                                     *
*      PROCESSING OF UCB INFORMATION.                                 *
*                                                                     *
***********************************************************************
         SPACE 3
GETUCB   EQU   *
         DROP  R11                     FREE BASE REG. OF PARMAREA
         GETMAIN R,LV=UCBTBLEN,SP=125
         LR    R11,R01                 INITIALIZE BASE REG. OF UCBADTAB
         USING UCBADTAB,R11            ALLOC. BASE REG. OF UCBADTAB
         ST    R11,UCBADDR             STORE ADDRESS OF TABLE
         MVI   UCBADDR,X'80'           SET OPTION BYTE
         LA    R01,UCBADDR             LOAD ADDRESS OF PARAMETER
         LINK  EP=GETUCBS              LINK TO SUBROUTINE
         LA    R02,UCBADTAB            LOAD ADDRESS OF TABLE
         SR    R03,R03                 ZERO FOR ICM COMMAND
         MVC   UCBTBEND,=X'FFFF'       SPECIFY END OF TABLE
         S     R02,=F'2'               DECREASE ADDRESS
NEXTUCB  EQU   *
         LA    R02,2(R02)              LOAD ADDRESS OF NEXT ENTRY
         CLC   0(2,R02),=X'FFFF'       END OF TABLE ?
         BE    ENDPROC                 BRANCH IF YES
         ICM   R03,3,0(R02)            LOAD ADDRESS OF UCB
         SPACE 1
         MVI   FNDBYTE,X'FF'           SET FLAGS
         TM    PARMFLAG,X'FF'          SELECT PARAMETERS ?
         BZ    *+8                     BRANCH IF NOT
         BAL   R14,TSTFLAGS            BRANCH TO TEST FLAGS
         TM    FNDBYTE,X'FF'           TEST OK ?
         BZ    NEXTUCB                 BRANCH IF NOT
         EJECT
*
*      COMPARISON OF UCB ADDRESSES OR VOLSER NUMBERS.
*
         SPACE 1
         SR    R05,R05                 ZERO FOR IC COMMAND
         LA    R06,TABPVOL1-7          LOAD ADDRESS OF TABLE
         LA    R07,TABPVOL2-7          LOAD ADDRESS OF TABLE
NXTVOLID EQU   *
         LA    R06,7(R06)              LOAD ADDRESS OF NEXT ENTRY
         LA    R07,7(R07)              LOAD ADDRESS OF NEXT ENTRY
         TM    0(R06),X'80'            END OF TABLE ?
         BO    TESTADDR                BRANCH IF YES
         IC    R05,0(R06)              INSERT LENGTH
         CLI   VOLBYTE,X'FF'           VOLSER NUMBERS SPECIFIED ?
         BNE   NEXTADR                 BRANCH IF NOT
         TM    UCBDVCLS,X'A0'          TAPE OR DIRECT ACCESS ?
         BZ    NEXTUCB                 BRANCH IF NOT
         CLC   UCBVOLI,=XL6'0'         VOLSER NUMBER ?
         BE    NEXTUCB                 BRANCH IF NOT
         MVC   ZWVOLID1,UCBVOLI        MOVE VOLSER NUMBER
         MVC   ZWVOLID2,UCBVOLI        MOVE VOLSER NUMBER
EXMVC    EQU   *
         EX    R05,NCVOLID1            BRANCH TO TRANSLATE VOLID
         EX    R05,OCVOLID2            BRANCH TO TRANSLATE VOLID
         CLC   ZWVOLID1,ZWVOLID2       VOLID VALID ?
         BNE   NXTVOLID                BRANCH IF NOT
         MVC   VOLSERNO,UCBVOLI        MOVE VOLSER NUMBER
         B     MVCMSG                  BRANCH
         SPACE 1
NEXTADR  EQU   *
         MVC   ZWVOLID1,UCBNAME        MOVE UNIT NAME
         MVC   ZWVOLID2,UCBNAME        MOVE UNIT NAME
         B     EXMVC                   BRANCH
         SPACE 1
TESTADDR EQU   *
         TM    TABPVOL1,X'80'          ADDRESSES OR VOLUMES SPEC. ?
         BZ    NEXTUCB                 BRANCH IF YES
         TM    VOLBYTE,X'FF'           VOLSER NUMBERS SPECIFIED ?
         BZ    MVCMSG                  BRANCH IF NOT
         TM    UCBDVCLS,X'A0'          TAPE OR DIRECT ACCESS ?
         BZ    NEXTUCB                 BRANCH IF NOT
         EJECT
***********************************************************************
*                                                                     *
*      EDIT MESSAGE LINES.                                            *
*                                                                     *
***********************************************************************
         SPACE 3
MVCMSG   EQU   *
         L     R10,SAVE1R10            INITIALIZE BASE REG. OF MESSAGE
         MVC   MESSAGE(LENMSG02),MSG02 MOVE MESSAGE SKELETON
         MVC   MSGNAME,PNAME           MOVE NAME OF PROGRAM
         MVC   MSGADR,UCBNAME          MOVE NAME OF UNIT
         STCM  R03,3,MSGUCBAD          STORE ADDRESS OF UNIT
         UNPK  MSGUCBAD(5),MSGUCBAD(3) UNPACK ADDRESS
         MVI   MSGUCBAD+4,C' '
         TR    MSGUCBAD,TABHEXA-240    TRANSLATE ADDRESS
         SPACE 1
         TM    UCBSTAT,UCBONLI         DEVICE ONLINE ?
         BO    TESTSYS                 BRANCH IF YES
         MVC   MSGLINE,=C'OFF'         SPECIFY OFFLINE
         B     TESTALOC                BRANCH
TESTSYS  EQU   *
         TM    CPUBYTE,X'FF'           SYSTEM = MVS ?
         BZ    TESTALOC                BRANCH IF NOT
         TM    UCBFL5,UCBALTPH         ALTERNATE PATH ?
         BNZ   TESTCPU0                BRANCH IF YES
         MVC   MSGPATH0(5),=C' N/A '   NOT APPLICATABLE
         B     TESTALOC                BRANCH
TESTCPU0 EQU   *
         TM    CPUBYTE,X'F0'           CPU 0 AVAILABLE ?
         BZ    TESTCPU1                BRANCH IF NOT
         MVC   MSGPATH0,=C'**'
         TM    UCBCHM,UCBPPA           PRIMARY PATH FROM CPU 0 ?
         BNZ   *+8                     BRANCH IF NOT
         MVI   MSGPATH0,C'1'
         TM    UCBCHM,UCBSPA           SECONDARY PATH FROM CPU 0 ?
         BNZ   TESTCPU1                BRANCH IF NOT
         MVI   MSGPATH0+1,C'1'
TESTCPU1 EQU   *
         TM    CPUBYTE,X'0F'           CPU 1 AVAILABLE ?
         BZ    TESTALOC                BRANCH IF NOT
         MVC   MSGPATH1,=C'**'
         TM    UCBCHM,UCBPPB           PRIMARY PATH FROM CPU 1 ?
         BNZ   *+8                     BRANCH IF NOT
         MVI   MSGPATH1,C'1'
         TM    UCBCHM,UCBSPB           SECONDARY PATH FROM CPU 1 ?
         BNZ   TESTALOC                BRANCH IF NOT
         MVI   MSGPATH1+1,C'1'
         EJECT
TESTALOC EQU   *
         TM    UCBSTAT,UCBALOC         DEVICE ALLOCATED ?
         BZ    TESTNRDY                BRANCH IF NOT
         MVC   MSGALLOC,=8C'.'         INITIALIZE MESSAGE AREA
         MVC   PJOBNAME,=CL8' '        CLEAR JOB NAME
         L     R09,UCBEXTPT            LOAD ADDRESS OF COMMON UCB EXT.
         LA    R09,UCBASID             LOAD ADDRESS OF ASID
         ST    R09,PASIDADR                AND STORE IT
         LA    R01,PARMLIST            LOAD ADDRESS OF PARAMETER LIST
         L     R15,FASIDADR            LOAD ADDRESS OF SUBROUTINE
         BALR  R14,R15                 BRANCH TO SUBROUTINE
         LTR   R15,R15                 VALID JOB NAME ?
         BNZ   TESTNRDY                BRANCH IF NOT
         MVC   MSGALLOC,PJOBNAME       MOVE JOB NAME
TESTNRDY EQU   *
         TM    UCBFLA,UCBNRY           DEVICE READY ?
         BZ    TSTCUBSY                BRANCH IF YES
         MVC   MSGREADY,=C'NR'         INDICATE NOT READY
TSTCUBSY EQU   *
         TM    UCBFLA,UCBCUB           CONTROL UNIT BUSY ?
         BZ    TSTDVBSY                BRANCH IF NOT
         MVC   MSGSTAT(4),=C'CUBS'     MOVE TEXT
         B     TSTDVRES                BRANCH
TSTDVBSY EQU   *
         TM    UCBFLA,UCBBSY           DEVICE BUSY ?
         BZ    TSTMOUNT                BRANCH IF NOT
         MVC   MSGSTAT(4),=C'BUSY'     MOVE TEXT
         B     TSTDVRES                BRANCH
TSTMOUNT EQU   *
         TM    UCBDMCT,UCBMOUNT        MOUNT PENDING ?
         BZ    TSTIOREC                BRANCH IF NOT
         MVC   MSGSTAT(5),=C'MOUNT'    MOVE TEXT
         EJECT
TSTIOREC EQU   *
         TM    UCBFLA,UCBQISCE         IO RECOVERY ACTIVE ?
         BZ    TSTDVRES                BRANCH IF NOT
         MVC   MSGSTAT(5),=C'IOREC'    MOVE TEXT
         B     TESTVOLI                BRANCH
TSTDVRES EQU   *
         TM    UCBFLB,UCBRESVH         DEVICE RESERVED ?
         BZ    TESTVOLI                BRANCH IF NOT
         MVC   MSGSTAT+4(2),=C'-R'     MOVE TEXT
TESTVOLI EQU   *
         TM    UCBDVCLS,X'A0'          TAPE OR DIRECT ACCESS ?
         BZ    TESTDFLT                BRANCH IF NOT
         CLC   UCBVOLI,=XL6'0'         VOLID ?
         BE    TESTSTOR                BRANCH IF NOT
         MVC   MSGVOLID,UCBVOLI        MOVE VOLSER NUMBER
TESTSTOR EQU   *
         TM    UCBSTAB,UCBBSTR         STORAGE VOLUME ?
         BZ    TESTPUB                 BRANCH IF NOT
         MVC   MSGATTR1,=C'STG/RMV'    SPECIFY STORAGE VOLUME
TESTPUB  EQU   *
         TM    UCBSTAB,UCBBPUB         PUBLIC VOLUME ?
         BZ    TESTPRV                 BRANCH IF NOT
         MVC   MSGATTR1,=C'PUB/RMV'    SPECIFY PUBLIC VOLUME
TESTPRV  EQU   *
         TM    UCBSTAB,UCBBPRV         PRIVATE VOLUME ?
         BZ    TESTRES                 BRANCH IF NOT
         MVC   MSGATTR1,=C'PRV/RMV'    SPECIFY PRIVATE VOLUME
TESTRES  EQU   *
         TM    UCBSTAT,UCBPRES         VOLUME RESIDENT ?
         BZ    TESTRSV                 BRANCH IF NOT
         MVC   MSGATTR2,=C'RES'        SPECIFY RESIDENT VOLUME
TESTRSV  EQU   *
         TM    UCBSTAT,UCBRESV         VOLUME RESERVED ?
         BZ    TESTDFLT                BRANCH IF NOT
         MVC   MSGATTR2,=C'RSV'        SPECIFY RESERVED VOLUME
TESTDFLT EQU   *
         CLI   NOPMFLAG,X'FF'          DEFAULT OUTPUT ?
         BNE   MSGOK                   BRANCH IF NOT
         CLC   MSGSTAT,=CL8' '         STATUS INFORMATION ?
         BE    NEXTUCB                 BRANCH IF NOT
         CLC   MSGSTAT(5),=C'MOUNT'    MOUNT PENDING ?
         BE    NEXTUCB                 BRANCH IF NOT
MSGOK    EQU   *
         MVI   WTOBYTE,X'FF'           SET FLAGS
         LA    R14,NEXTUCB             LOAD RETURN ADDRESS
         MVC   MSGFLAG,=XL6'0'         CLEAR FLAG BYTES
         LA    R10,68(R10)             LOAD ADDRESS OF NEXT ENTRY
         C     R10,ADDRETB1            END OF TABLE
         BNL   PUTMSG                  BRANCH IF YES
         ST    R10,SAVE1R10            SAVE CURRENT ADDRESS
         BR    R14                     RETURN
         EJECT
***********************************************************************
*                                                                     *
*      FINAL PROCESSING.                                              *
*                                                                     *
***********************************************************************
         SPACE 3
ENDPROC  EQU   *
         FREEMAIN R,SP=125             FREE TABLE AREA
         MVI   WTORBYTE,X'00'          CLEAR FLAG BYTE
         TM    WTOBYTE,X'FF'           MESSAGE OUTPUT ?
         BNZ   PUTOPMSG                BRANCH IF YES
         LA    R10,MSGTAB              LOAD ADDRESS OF TABLE
         MVC   MESSAGE(LENMSG03),MSG03 MOVE MESSAGE
         CLI   VOLBYTE,X'FF'           PROGRAM = X-DVOL ?
         BE    *+10                    BRANCH IF YES
         MVC   MSGNAME,PNAME           MOVE NAME OF PROGRAM
         L     R00,UCMID               LOAD UCM ID. OF CALLER
         WTO   MF=(E,MESSAGE)          DISPLAY MESSAGE
         B     RETURN                  BRANCH
         SPACE 2
*
*      DISPLAY OF OPEN MESSAGES.
*
         SPACE 1
PUTOPMSG EQU   *
         LA    R10,MSGTAB              LOAD ADDRESS OF TABLE
         CLC   MSGFLAG,=XL6'0'         ALL MESSAGES DISPLAYED ?
         BNE   RETURN                  BRANCH IF NOT
         BAL   R14,PUTMSG              IF YES, BR. TO MESSAGE OUTPUT
         EJECT
*
*      FREE WORK AREAS,
*      RELOAD REGISTER CONTENTS,
*      RETURN.
*
         SPACE 1
RETURN   EQU   *
         XRETURN ,R
         SPACE 3
***********************************************************************
*                                                                     *
*      PARAMETER ERROR ROUTINE.                                       *
*                                                                     *
***********************************************************************
         SPACE 3
PRMERROR EQU   *
         LA    R10,MSGTAB              LOAD ADDRESS OF MESSAGE TABLE
         MVC   MESSAGE(LENMSG04),MSG04 MOVE MESSAGE
         MVC   MSGNAME,PNAME           MOVE NAME OF PROGRAM
         L     R00,UCMID               LOAD UCM ID. OF CALLER
         WTO   MF=(E,MESSAGE)          DISPLAY MESSAGE
         B     RETURN                  BRANCH
         EJECT
***********************************************************************
*                                                                     *
*      TEST DEVICES FOR SPECIFIED STATUS.                             *
*                                                                     *
***********************************************************************
         SPACE 3
TSTFLAGS EQU   *
         CLC   TAPEFLAG(5),=XL6'0'     DEVICES TYPE(S) SPECIFIED ?
         BE    TSTMSS                  BRANCH IF NOT
         LA    R04,PRMTABLE-10         LOAD ADDRESS OF TABLE
         LA    R05,PRMFLAGS            LOAD ADDRESS OF FLAG BYTES
TSTDEVLP EQU   *
         LA    R04,10(R04)             LOAD ADDRESS OF NEXT ENTRY
         CLI   1(R04),X'FF'            END OF TABLE ?
         BE    CLEARFLG                BRANCH IF YES
         LA    R05,1(R05)              LOAD ADDRESS OF NEXT FLAG BYTE
         TM    0(R05),X'FF'            FLAG ON ?
         BZ    TSTDEVLP                BRANCH IF NOT
         CLC   UCBDVCLS,1(R04)         SPECIFIED DEVICE TYPE ?
         BNE   TSTDEVLP                BRANCH IF NOT
         SPACE 1
TSTMSS   EQU *
         TM    MSSFLAG,X'FF'           VIRTUAL DEVICES SPECIFIED ?
         BZ    TSTNOMSS                BRANCH IF NOT
         TM    UCBDVCLS,UCB3DACC       DIRECT ACCESS ?
         BZ    TSTMSC                  BRANCH IF NOT
         TM    UCBTBYT2,UCBRVDEV       VIRTUAL DEVICE ?
         BZ    CLEARFLG                BRANCH IF NOT
         B     TSTPLINE                BRANCH
TSTNOMSS EQU   *
         TM    UCBDVCLS,UCB3DACC       DIRECT ACCESS ?
         BZ    TSTNOMSC                BRANCH IF NOT
         TM    UCBTBYT2,UCBRVDEV       VIRTUAL DEVICE ?
         BO    CLEARFLG                BRANCH IF YES
         B     TSTPLINE                BRANCH
TSTNOMSC EQU   *
         TM    UCBUNTYP,UCBDSM         MSC ?
         BO    CLEARFLG                BRANCH IF YES
         EJECT
TSTPLINE EQU   *
         CLC   ONLFLAG(2),=XL6'0'      ON/OFFLINE DEVICES SPECIFIED ?
         BE    TSTREADY                BRANCH IF NOT
         TM    UCBSTAT,UCBONLI         DEVICE ONLINE ?
         BZ    TSTPOFFL                BRANCH IF NOT
         TM    ONLFLAG,X'FF'           ONLINE DEVICES SPECIFIED ?
         BZ    CLEARFLG                BRANCH IF NOT
         B     TSTREADY                BRANCH
TSTPOFFL EQU   *
         TM    OFFLFLAG,X'FF'          OFFLINE DEVICES SPECIFIED ?
         BZ    CLEARFLG                BRANCH IF NOT
         SPACE 1
TSTREADY EQU   *
         TM    RDYFLAG,X'FF'           READY DEVICES SPECIFIED ?
         BZ    TSTFLGOK                BRANCH IF NOT
         TM    UCBSFLS,UCBNRY          DEVICE READY ?
         BO    CLEARFLG                BRANCH IF NOT
         SPACE 1
TSTFLGOK EQU   *
         BR    R14                     RETURN
         SPACE 2
CLEARFLG EQU   *
         MVI   FNDBYTE,X'00'           CLEAR FLAG BYTE
         BR    R14                     RETURN
TSTMSC   EQU   *
         TM    UCBUNTYP,UCBDSM         MSC ?
         BNO   CLEARFLG                BRANCH IF NOT
         B     TSTPLINE                BRANCH IF YES
         EJECT
***********************************************************************
*                                                                     *
*      MESSAGE DISPLAY.                                               *
*                                                                     *
***********************************************************************
         SPACE 3
PUTMSG   EQU   *
         ST    R14,SAVE1R14            SAVE RETURN ADDRESS
         L     R00,UCMID               LOAD UCM ID. OF CALLER
         WTO   MF=(E,HEADER)           DISPLAY HEAD LINE
         LA    R10,MSGTAB-68           LOAD ADDRESS OF TABLE
         L     R09,ADDRETB1            LOAD ADDRESS OF TABLE END
         BAL   R14,DISPLAY             BRANCH TO DISPLAY
         LA    R10,MSGTAB              LOAD ADDRESS OF TABLE
         ST    R10,SAVE1R10                AND STORE IT
         L     R14,SAVE1R14            LOAD RETURN ADDRESS
         CLI   WTORBYTE,X'FF'          FLAG ON ?
         BNER  R14                     RETURN IF NOT
NXTREPLY EQU   *
         XC    ECB,ECB                 CLEAR EVENT CONTROL BLOCK
         MVI   REPLY,C' '              CLEAR REPLY AREA
         L     R00,UCMID               LOAD UCM ID. OF CALLER
         LA    R04,ECB                 LOAD ADDRESS OF ECB
         LA    R05,REPLY               LOAD ADDRESS OF REPLY
         WTOR  ,(R05),1,(R04),MF=(E,WTOR)
         SPACE 1
         WAIT  ECB=ECB                 WAIT FOR COMPLETION
         CLI   REPLY,C'N'              REPLY = NO ?
         BE    RETURN                  BRANCH IF YES
         CLI   REPLY,C'Y'              REPLY = YES ?
         BNE   NXTREPLY                BRANCH IF NOT
         L     R14,SAVE1R14            LOAD RETURN ADDRESS
         BR    R14                     RETURN
         EJECT
*
*      DISPLAY SINGLE MESSAGE LINES.
*
         SPACE 1
DISPLAY  EQU   *
         ST    R14,SAVE2R14            SAVE RETURN ADDRESS
NEXTMSG  EQU   *
         LA    R10,68(R10)             LOAD ADDRESS OF NEXT ENTRY
         CR    R10,R09                 END OF TABLE ?
         BNL   ENDMSG                  BRANCH IF YES
         CLC   MSGFLAG,=X'FFFF'        FLAGS ON ?
         BE    ENDMSG                  BRANCH IF YES
         MVC   MSGFLAG,=X'FFFF'        SET FLAGS
         L     R00,UCMID               LOAD UCM ID. OF CALLER
         WTO   MF=(E,MESSAGE)          DISPLAY ONE MESSAGE
         B     NEXTMSG                 BRANCH
ENDMSG   EQU   *
         L     R14,SAVE2R14            LOAD RETURN ADDRESS
         BR    R14                     RETURN
         SPACE 3
***********************************************************************
*                                                                     *
*      COMMANDS VIA EXECUTE COMMAND.                                  *
*                                                                     *
***********************************************************************
         SPACE 3
MOVEPVOL EQU   *
         MVC   1(0,R06),1(R07)         MOVE VOLID TO TABLE
NCVOLID1 EQU   *
         NC    ZWVOLID1(0),1(R06)      TRANSLATE VOLID
OCVOLID2 EQU   *
         OC    ZWVOLID2(0),1(R07)      TRANSLATE VOLID
CLCPARM  EQU   *
         CLC   2(0,R01),1(R07)         PARAMETER = TABLE ENTRY ?
         EJECT
***********************************************************************
*                                                                     *
*      REGISTER EQUATES.                                              *
*                                                                     *
***********************************************************************
         SPACE 3
R00      EQU   0                       MACRO AND PARAMETER REGISTER
R01      EQU   1                       MACRO AND PARAMETER REGISTER
R02      EQU   2                       PTR. IN CVT / UCB LOOKUP TABLE
R03      EQU   3                       POINTER TO UCB
R04      EQU   4                       WORK REGISTER
R05      EQU   5                       WORK REGISTER
R06      EQU   6                       WORK REGISTER
R07      EQU   7                       WORK REGISTER
R08      EQU   8                       WORK REGISTER
R09      EQU   9                       BASE OF COMMON UCB EXTENSION
R10      EQU   10                      POINTER IN MESSAGE TABLE
R11      EQU   11                      BASE OF PARMAREA / UCBADTAB
R12      EQU   12                      BASE OF CSECT DVOL
R13      EQU   13                      BASE OF WKAREA
R14      EQU   14                      RETURN ADDRESSES
R15      EQU   15                      CSECT ADRESSES AND RETURN CODES
         EJECT
***********************************************************************
*                                                                     *
*      TRANSLATE TABLE.                                               *
*                                                                     *
***********************************************************************
         SPACE 2
TABHEXA  DC    C'0123456789ABCDEF'
         SPACE 3
***********************************************************************
*                                                                     *
*      PARAMETER TABLE.                                               *
*                                                                     *
***********************************************************************
         SPACE 2
PRMTABLE EQU   *
         DC    X'03',X'80',CL8'TAPE'
         DC    X'03',X'20',CL8'DASD'
         DC    X'01',X'08',CL8'UR'
         DC    X'01',X'40',CL8'TP'
         DC    X'06',X'10',CL8'GRAPHIC'
         DC    X'02',X'FF',CL8'MSS'
         DC    X'05',X'FF',CL8'ONLINE'
         DC    X'06',X'FF',CL8'OFFLINE'
         DC    X'04',X'FF',CL8'READY'
         DC    X'FF',X'FF',CL8' '      TABLE END
         EJECT
***********************************************************************
*                                                                     *
*      MESSAGE CONSTANTS.                                             *
*                                                                     *
***********************************************************************
         SPACE 3
MSG01    WTO   'XDVOL01 VOLSER ADR LNE -ALLOC-- -STATUS-- PATHS -ATTR--*
                UCB ',                                                 *
               MF=L,MCSFLAG=(REG0)
LENMSG01 EQU   *-MSG01
         SPACE 1
MSG02    WTO   'XDVOL02        ADR ON      NO   RD        ../..   N/A  *
                9999',                                                 *
               MF=L,MCSFLAG=(REG0)
LENMSG02 EQU   *-MSG02
         SPACE 1
MSG03    WTO   'XDVOL03 NO OUTPUT PRODUCED',                           *
               MF=L,MCSFLAG=(REG0)
LENMSG03 EQU   *-MSG03
         SPACE 1
MSG04    WTO   'XDVOL04 INVALID PARAMETER LIST',                       *
               MF=L,MCSFLAG=(REG0)
LENMSG04 EQU   *-MSG04
         EJECT
MSG05    WTOR  'XDVOL05 REPLY ''Y'' (YES) OR ''N'' (NO) TO CONTINUE',  *
               MF=L,MCSFLAG=(REG0)
LENMSG05 EQU   *-MSG05
         SPACE 3
         LTORG
         EJECT
***********************************************************************
*                                                                     *
*      WORK AREAS.                                                    *
*                                                                     *
***********************************************************************
         SPACE 3
WKAREA   DSECT
SAVEAREA DS    18F                     SAVEAREA OF GENERAL REGISTERS
         SPACE 2
*
*      ADRESSEN-SPEICHER.
*
         SPACE 1
ADDRETB1 DS    F                       END ADDRESS OF MESSAGE TABLE
ADDRETPV DS    F                       END ADDRESS OF VOLUME TABLE
SAVE1R10 DS    F                       SAVEAREA1 OF R10
SAVE1R14 DS    F                       SAVEAREA1 OF R14
SAVE2R14 DS    F                       SAVEAREA2 OF R14
UCBADDR  DS    F                       ADDRESS OF UCB TABLE
FASIDADR DS    F                       ADDRESS OF SUBROUTINE 'FASID'
UCMID    DS    F                       UCM ID. OF CALLER
         SPACE 2
*
*      WORK AREAS.
*
         SPACE 1
ECB      DS    F                       EVENT CONTROL BLOCK
FNDBYTE  DS    C                       FLAG
VOLBYTE  DS    C                       FLAG OF SPECIFIED VOLUMES
CPUBYTE  DS    C                       FLAG BYTE OF CPU'S
WTOBYTE  DS    C                       FLAG OF WTO
WTORBYTE DS    C                       FLAG OF WTOR
REPLY    DS    C                       REPLY AREA
VOLSERNO DS    CL6                     VOLSER NUMBER
ZWVOLID1 DS    CL6                     VOLSER NUMBER
ZWVOLID2 DS    CL6                     VOLSER NUMBER
PNAME    DS    CL4                     NAME OF PROGRAM
         SPACE 2
*
*      PARAMETER LIST OF 'FASID'.
*
         SPACE 1
PARMLIST DS    0F
PASIDADR DS    F                       ADDRESS OF ASID
PJNMEADR DS    F                       ADDRESS OF JOB NAME
PSNMEADR DS    F                       ADDRESS OF STEP NAME
PJOBNAME DS    CL8                     JOB NAME
PSTEPNME DS    CL8                     STEP NAME
         EJECT
*
*      PARAMETER FLAGS.
*
         SPACE 1
PRMFLAGS DS    0CL8
PARMFLAG DS    C                       FLAG BYTE OF PARAMETER
TAPEFLAG DS    C                       FLAG BYTE OF TAPE SELECT.
DASDFLAG DS    C                       FLAG BYTE OF DASD SELECT.
URFLAG   DS    C                       FLAG BYTE OF UR SELECT.
TPFLAG   DS    C                       FLAG BYTE OF TP SELECT.
GRAPFLAG DS    C                       FLAG BYTE OF GRAPHIC SELECT.
MSSFLAG  DS    C                       FLAG BYTE OF MSS SELECT.
ONLFLAG  DS    C                       FLAG BYTE OF ONLINE SELECT.
OFFLFLAG DS    C                       FLAG BYTE OF OFFLINE SELECT.
RDYFLAG  DS    C                       FLAG BYTE OF READY SELECT.
NOPMFLAG DS    C                       FLAG BYTE OF DEFAULT DISPLAY
PFLAGLEN EQU   *-PRMFLAGS              LENGTH OF FLAG BYTES
         SPACE 2
*
*      TABLE WITH PARAMETER ADDRESSES OR VOLSER NUMBERS.
*
*      BYTE1 - LENGTH OF PARAMETER OR X'80'
*      BYTES2-7 - PARAMETER VALUE(S)
*
         SPACE 1
TABPVOL1 DS    10CL7                   TABLE 1
ENDTPVOL EQU   *
         DS    CL7
TABPVOL2 DS    CL77                    TABLE 2
         SPACE 2
*
*      MESSAGE AREA.
*
*      BYTE1-66: WTO MESSAGE LINE
*      BYTE67-68: X'0000', IF MESSAGE LINE AVAILABLE
*
         SPACE 1
         DS    0F
MSGTAB   DS    10CL68
ENDTAB1  EQU   *
HEADER   DS    17F                     HEAD LINE
WTOR     DS    15F                     WTOR LINE
         SPACE 1
WKAREALN EQU   *-WKAREA                LENGTH OF WORK AREAS
         EJECT
***********************************************************************
*                                                                     *
*      MESSAGE AREA.                                                  *
*                                                                     *
***********************************************************************
         SPACE 3
MESSAGE  DSECT
         ORG   MESSAGE+5
MSGNAME  DS    CL4                     PROGRAM NAME
         DS    CL3
MSGVOLID DS    CL6                     VOLUME SERIAL NUMBER
         DS    CL1
MSGADR   DS    CL3                     UNIT ADDRESS
         DS    CL1
MSGLINE  DS    CL3                     ON/OFF LINE
         DS    CL1
MSGALLOC DS    CL8                     UNIT ALLOC
         DS    CL1
MSGREADY DS    CL2                     UNIT READY
         DS    CL1
MSGSTAT  DS    CL6                     UNIT STATUS
         DS    CL1
MSGPATH0 DS    CL2                     PATHS FROM CPU 0
         DS    CL1
MSGPATH1 DS    CL2                     PATHS FROM CPU 1
         DS    CL1
MSGATTR1 DS    CL7                     ATTRIBUTES
         ORG   *-3
MSGATTR2 DS    CL3                     ATTRIBUTES
         DS    CL1
MSGUCBAD DS    CL4                     UCB ADDRESS
         ORG   MESSAGE+13
WTORNAME DS    CL4                     PROGRAM NAME
         ORG   MESSAGE+66
MSGFLAG  DS    CL2                     FLAG BYTES
         EJECT
***********************************************************************
*                                                                     *
*      INPUT PARAMETER AREA.                                          *
*                                                                     *
***********************************************************************
         SPACE 3
         XPARM
PARMEND  EQU   *
         SPACE 3
***********************************************************************
*                                                                     *
*      UCB ADDRESS TABLE.                                             *
*                                                                     *
***********************************************************************
         SPACE 3
UCBADTAB DSECT
         DS    1024H
UCBTBEND DS    H             =X'FFFF'
UCBTBLEN EQU   *-UCBADTAB
         EJECT
***********************************************************************
*                                                                     *
*      UCB-DEFINITIONEN.                                              *
*                                                                     *
***********************************************************************
         SPACE 2
UCB      DSECT
         IEFUCBOB LIST=YES
         END   DVOL
./ ADD  NAME=DYNALC
         TITLE 'DYNALC                             DYNAMIC ALLOCATION'
DYNALC   CSECT
         SPACE 3
***********************************************************************
*                                                                     *
*      IDENTIFICATION DIVISION.                                       *
*                                                                     *
*      PROGRAM-ID. DYNALC.                                            *
*      AUTHOR. EHNERT.                                                *
*      INSTALLATION. BAYER AG, LEVERKUSEN, RECHENZENTRUM.             *
*      DATE-WRITTEN. 17. 12. 1974.                                    *
*      REMARKS.                                                       *
*          DAS PROGRAMM 'DYNALC' IST EIN UNTERPROGRAMM UND FUEHRT     *
*          DIE DYNAMIC ALLOCATION UND DIE DYNAMIC UNALLOCATION        *
*          DURCH.                                                     *
*                                                                     *
*          IN REGISTER 1 WIRD DIE ADRESSE EINES PARAMETERBEREICHS MIT *
*          FOLGENDEM AUFBAU ERWARTET:                                 *
*                                                                     *
*          01) ADRESSE EINES DREI-VOLLWORT-BEREICHS, IN DEN           *
*              A)  DER RUECKKEHRCODE DES DYNALLOC-MACROS,             *
*              B)  DER ERROR REASON CODE UND                          *
*              C)  DER INFORMATION REASON CODE DES DYNALLOC-MACROS    *
*              GESPEICHERT WERDEN                                     *
*              (BEDEUTUNG DER CODES: SIEHE 'OS/VS2 SYSTEM PROGRAMMING *
*              LIBRARY: JOB MANAGEMENT, SUPERVISOR, AND TSO',         *
*              APPENDIX A),                                           *
*          02) ADRESSE EINES 8-BYTE-FELDES FUER DEN DYNALLOC-TYP      *
*              A)  'DSALLOC': DATA SET NAME ALLOCATION,               *
*              B)  'UNALLOC': DYNAMIC UNALLOCATION,                   *
*              C)  'CONCAT': DYNAMIC CONCATENATION,                   *
*              D)  'DECONCAT': DYNAMIC DECONCATENATION,               *
*              E)  'REMOVE': REMOVAL OF THE IN-USE ATTRIBUTE,         *
*              F)  'DDALLOC': DDNAME ALLOCATION,                      *
*              G)  'RETRIEVE': DYNAMIC INFORMATION RETRIEVAL,         *
*              UND EINES 4-BYTE-FELDES, DAS IM FALLE EINES WAIT       *
*              'WAIT' ENTHALTEN MUSS.                                 *
*          03) ADRESSE EINES 8-BTYE-FELDES FUER DEN DDNAME,           *
*          04) ADRESSE EINES 44-BYTE-FELDES FUER DEN DSNAME,          *
*          05) ADRESSE EINES 8-BYTE-FELDES FUER DEN MEMBERNAMEN       *
*              EINER PO-ORGANISIERTEN DATEI,                          *
*          06) ADRESSE EINES DREI-BYTE-FELDES FUER DEN STATUS DER     *
*              DATEI (SHR, NEW, MOD, OLD, DEFAULT: NEW),              *
*          07) ADRESSE EINES 7-BYTE-FELDES FUER DIE NORM. DISPOSITION *
*              (KEEP, DELETE, CATLG, UNCATLG, DEFAULT: DELETE),       *
*          08) ADRESSE EINES 7-BYTE-FELDES FUER DIE COND. DISPOSITION *
*              (KEEP, DELETE, CATLG, UNCATLG, DEFAULT: DELETE),       *
*          09) ADRESSE EINES DREI-BYTE-FELDES FUER DEN SPACE TYPE     *
*              ('CYL', 'TRK' ODER BLOCKGROESSE (BINAER GESPEICHERT)), *
*          10) ADRESSE EINES DREI-BYTE-FELDES FUER DIE PRIMARY SPACE  *
*              QUANTITY (BINAER GESPEICHERT),                         *
*          11) ADRESSE EINES 3-BYTE-FELDES FUER DIE SECONDARY SPACE   *
*              QUANTITY (BINAER GESPEICHERT),                         *
*          12) ADRESSE EINES 3-BYTE-FELDES FUER DIE DIRECTORY BLOCK   *
*              QUANTITY (BINAER GESPEICHERT),                         *
         EJECT
*          13) ADRESSE EINES 4-BYTE-FELDES, DAS 'RLSE' ENTHAELT, WENN *
*              UNGENUTZTER SPEICHERPLATZ FREIGEGEBEN WERDEN SOLL,     *
*          14) ADRESSE EINES 6-BYTE-FELDES FUER DAS FORMAT DES ALLO-  *
*              KIERTEN SPEICHERPLATZES (CONTIG, MXIG, ALX),           *
*          15) ADRESSE EINES 5-BYTE-FELDES, DAS 'ROUND' ENTHAELT,     *
*              FALLS GANZE ZYLINDER ALLOKIERT WERDEN SOLLEN,          *
*          16) ADRESSE EINES 6-BYTE-FELDES FUER DIE VOLSER NUMBER,    *
*          17) ADRESSE EINES 7-BYTE-FELDES, DAS 'PRIVATE' ENTHAELT,   *
*              FALLS DER DATENTRAEGER PRIVAT IST,                     *
*          18) ADRESSE EINES 2-BYTE-FELDES FUER DIE VOLUME SEQUENCE   *
*              NUMBER (BINAER GESPEICHERT),                           *
*          19) ADRESSE EINES EIN-BYTE-FELDES FUER DEN VOLUME COUNT    *
*              (BINAER GESPEICHERT),                                  *
*          20) ADRESSE EINES 8-BYTE-FELDES FUER DIE VOLUME REFERENCE, *
*          21) ADRESSE EINES 8-BYTE-FELDES FUER DEN DEVICE TYPE,      *
*          22) ADRESSE EINES EIN-BYTE-FELDES FUER DEN UNIT COUNT      *
*              (BINAER GESPEICHERT),                                  *
*          23) ADRESSE EINES ZWEI-BYTE-FELDES FUER DIE BLOCK SIZE     *
*              (BINAER GESPEICHERT),                                  *
*          24) ADRESSE EINES VIER-BYTE-FELDES FUER DIE DATA SET       *
*              ORGANISATION,                                          *
*          25) ADRESSE EINES ZWEI-BYTE-FELDES FUER DIE RECORD LENGTH  *
*              (BINAER GESPEICHERT),                                  *
*          26) ADRESSE EINES VIER-BYTE-FELDES FUER DAS SATZFORMAT,    *
*          27) ADRESSE EINES 7-BYTE-FELDES, DAS 'UNALLOC', FALLS      *
*              DIE UNALLOCATION AT CLOSE DURCHGEFUEHRT WERDEN SOLL,   *
*              ODER 'NOUNALC' ENTHAELT, SOLL KEINE UNALLOCATION AT    *
*              CLOSE ERFOLGEN. DEFAULTMAESSIG GILT BEI DER DATA SET   *
*              NAME ALLOCATION 'UNALLOC'.                             *
*                                                                     *
*          SOLLEN PARAMETER AUSGELASSEN ODER DEFAULT-WERTE ANGENOMMEN *
*          WERDEN, SO IST DIE ENTSPRECHENDE ADRESSE AUF NULL ZU       *
*          SETZEN. DIE ADRESSE DES LETZTEN PARAMETERS MUSS DURCH      *
*          SETZEN DES ERSTEN BITS ALS LEZTE PARAMETERADRESSE SPEZIFI- *
*          ZIERT WERDEN.                                              *
*                                                                     *
***********************************************************************
         EJECT
***********************************************************************
*                                                                     *
*      BEGINN DER VERARBEITUNG.                                       *
*                                                                     *
***********************************************************************
         SPACE 3
*
*      SICHERN DER REGISTER,
*      SPEICHERPLATZANFORDERUNG FUER DEN ARBEITSBEREICH UND
*      ZUORDNUNG DER BASISREGISTER.
*
         SPACE 1
         XSAVE R12,,DYNALC,ABERL
         SPACE 1
         USING DYNALC,R12    BASISREG. FUER CSECT DYNALC ZUORDNEN
         USING ABER,R13      BASISREG. FUER DSECT ABER ZUORDNEN
         LR    R11,R1        ADRESSE DES PARAMETERBEREICHS SICHERN
         EJECT
*
*      INITIALISIERUNG DES PARAMETERBEREICHS FUER DYNALLOC-MACRO.
*
         SPACE 1
         MVC   RQBLK(20),S99RB REQUEST BLOCK UEBERTRAGEN
         LA    R2,RQBLK      ADRESSE DES REQUEST BLOCKS LADEN
         ST    R2,RQBLKPTR       UND SICHERN
         OI    RQBLKPTR,X'80' LETZTEN PARAMETER SPEZIFIZIEREN
         LA    R2,TEXTPTR    ADRESSE DER TEXT POINTER LADEN
         ST    R2,RQTXTPTR       UND SICHERN
         LA    R4,TEXTUNIT   ADRESSEN DER
         LA    R6,S99TUNIT       TEXT UNITS LADEN
         LA    R5,S99TULEN   LAENGE DER TEXT UNITS LADEN
         LR    R7,R5         LAENGE DER TEXT UNITS LADEN
         MVCL  R4,R6         TEXT UNITS UEBERTRAGEN
         EJECT
***********************************************************************
*                                                                     *
*      VERARBEITUNG DER EINGABEPARAMETER.                             *
*                                                                     *
***********************************************************************
         SPACE 3
         LA    R4,0          R4 LOESCHEN
         LR    R2,R1         ADRESSE DES PARAMETERBEREICHS UMLADEN
         LA    R3,TEXTPTR-4  ADRESSE DER TEXT POINTER LADEN
         SPACE 2
*
*      GET DYNALLOC TYPE.
*
         SPACE 1
         TM    0(R2),X'80'   LETZTER PARAMETER ERREICHT ?
         BO    ENDPARM       JA, VERZWEIGEN
         LA    R2,4(R2)      R2 ERHOEHEN
         ICM   R4,7,1(R2)    ADRESSE DES DYNALLOC-TYPS LADEN
         BZ    GETDDNAM      VERZW., WENN ADRESSE = 0
         BAL   R14,CLCTYPE   VERZW. ZUR TYPPRUEFUNG
         MVC   RQVERB,0(R9)  VERB CODE UEBERTRAGEN
         CLC   8(4,R4),=C'WAIT'        WAIT REQUESTED ?
         BNE   GETDDNAM                BRANCH IF NOT
         OI    RQFLAGS2,B'11010001'    ELSE SET FLAGS
         EJECT
*
*      GET DDNAME.
*
         SPACE 1
GETDDNAM EQU   *
         LA    R10,ENDPARM   RUECKSPRUNGADRESSE LADEN
         LA    R15,NXTPTR    RUECKSPRUNGADRESSE LADEN
         LA    R5,WKTU0001   ADRESSE DER TEXT UNIT LADEN
         BAL   R14,GETPARM   VERZW. ZUR PARAMETERPRUEFUNG
         LTR   R4,R4         PARAMETERADRESSE = 0 ?
         BZ    RETDDNAM      JA, VERZWEIGEN
         MVC   DDNAME,0(R4)  NEIN, DDNAME UEBERTRAGEN
         CLI   DDNAME,C' '   DDNAME ANGEGEBEN ?
         BE    RETDDNAM      NEIN, VERZWEIGEN
         B     GETDSNAM      JA, VERZWEIGEN
         SPACE 2
*
*      RETURN DDNAME.
*
         SPACE 1
RETDDNAM EQU   *
         LA    R5,WKTU0055   ADRESSE DER TEXT UNIT LADEN
         ST    R5,0(R3)          UND ALS TEXT POINTER SPEICHERN
         SPACE 2
*
*      GET DATA SET NAME.
*
         SPACE 1
GETDSNAM EQU   *
         LA    R15,GETMEMBN  RUECKSPRUNGADRESSE LADEN
         LA    R5,WKTU0002   ADRESSE DER TEXT UNIT LADEN
         BAL   R14,GETPARM   VERZW. ZUR PARAMETERPRUEFUNG
         MVC   DSNAME,0(R4)  DSNAME UEBERTRAGEN
         SPACE 2
*
*      GET MEMBER NAME.
*
         SPACE 1
GETMEMBN EQU   *
         LA    R15,GETSTAT   RUECKSPRUNGADRESSE LADEN
         LA    R5,WKTU0003   ADRESSE DER TEXT UNIT LADEN
         BAL   R14,GETPARM   VERZW. ZUR PARAMETERPRUEFUNG
         MVC   MEMBNAME,0(R4) MEMBERAME UEBERTRAGEN
         EJECT
*
*      GET DATA SET STATUS.
*
         SPACE 1
GETSTAT  EQU   *
         LA    R15,NXTPTR    RUECKSPRUNGADRESSE LADEN
         LA    R5,WKTU0004   ADRESSE DER TEXT UNIT LADEN
         BAL   R14,GETPARM   VERZW. ZUR PARAMETERPRUEFUNG
         LTR   R4,R4         PARAMETERADRESSE = 0 ?
         BZ    GETNDISP      JA, VERZWEIGEN
         BAL   R14,CLCSTAT   VERZW. ZUR STATUSPRUEFUNG
         MVC   STATUS,0(R9)  STATUS BYTE SETZEN
         SPACE 2
*
*      GET DATA SET NORMAL DISPOSITION
*
         SPACE 1
GETNDISP EQU   *
         LA    R5,WKTU0005   ADRESSE DER TEXT UNIT LADEN
         BAL   R14,GETPARM   VERZW. ZUR PARAMETERPRUEFUNG
         LTR   R4,R4         PARAMETERADRESSE = 0 ?
         BZ    GETCDISP      JA, VERZWEIGEN
         BAL   R14,CLCDISP   VERZW.ZUR DISPOSITIONPRUEFUNG
         MVC   NDISP,0(R9)   NORM. DISP. BYTE SETZEN
         SPACE 2
*
*      GET DATA SET CONDITIONAL DISPOSITION.
*
         SPACE 1
GETCDISP EQU   *
         LA    R5,WKTU0006   ADRESSE DER TEXT UNIT LADEN
         BAL   R14,GETPARM   VERZW. ZUR PARAMETERPRUEFUNG
         LTR   R4,R4         PARAMETERADRESSE = 0 ?
         BZ    GETSPTYP      JA, VERZWEIGEN
         BAL   R14,CLCDISP   VERZW.ZUR DISPOSITIONPRUEFUNG
         MVC   CDISP,0(R9)   COND. DISP. BYTE SETZEN
         EJECT
*
*      GET SPACE TYPE.
*
         SPACE 1
GETSPTYP EQU   *
         LA    R15,GETPRMSP  RUECKSPRUNGADRESSE LADEN
         LA    R5,WKTU0009   ADRESSE DER TEXT UNIT LADEN
         BAL   R14,GETPARM   VERZW. ZUR PARAMETERPRUEFUNG
         CLC   0(3,R4),=C'TRK' SPACE TYPE = TRK ?
         BNE   *+16          NEIN, VERZWEIGEN
         LA    R5,WKTU0007   ADRESSE DER TEXT UNIT LADEN
         ST    R5,0(R3)      TEXT POINTER SPEICHERN
         B     GETPRMSP      VERZWEIGEN
         CLC   0(3,R4),=C'CYL' SPACE TYPE = CYL ?
         BNE   *+16          NEIN, VERZWEIGEN
         LA    R5,WKTU0008   ADRESSE DER TEXT UNIT LADEN
         ST    R5,0(R3)      TEXT POINTER SPEICHERN
         B     GETPRMSP      VERZWEIGEN
         MVC   BLKSPACE,0(R4) BLOCKGROESSE UEBERTRAGEN
         SPACE 2
*
*      GET PRIMARY SPACE QUANTITY.
*
         SPACE 1
GETPRMSP EQU   *
         LA    R15,GETSECSP  RUECKSPRUNGADRESSE LADEN
         LA    R5,WKTU000A   ADRESSE DER TEXT UNIT LADEN
         MVC   PRMSPACE,0(R4) PRIMARY SPACE QUANTITY UEBERTRAGEN
         BAL   R14,GETPARM   VERZW. ZUR PARAMETERPRUEFUNG
         SPACE 2
*
*      GET SECONDARY SPACE QUANTITY.
*
         SPACE 1
GETSECSP EQU   *
         LA    R15,GETDIBLK  RUECKSPRUNGADRESSE LADEN
         LA    R5,WKTU000B   ADRESSE DER TEXT UNIT LADEN
         BAL   R14,GETPARM   VERZW. ZUR PARAMETERPRUEFUNG
         MVC   SECSPACE,0(R4) SECONDARY SPACE QUANTITY UEBERTRAGEN
         SPACE 2
*                                                                     *
*      GET DIRECTORY BLOCK QUANTITY.
*
         SPACE 1
GETDIBLK EQU   *
         LA    R15,GETRLSE   RUECKSPRUNGADRESSE LADEN
         LA    R5,WKTU000C   ADRESSE DER TEXT UNIT LADEN
         BAL   R14,GETPARM   VERZW. ZUR PARAMETERPRUEFUNG
         MVC   DIRBLOCK,0(R4) DIRECTORY BLOCK QUANTITY UEBERTRAGEN
         EJECT
*
*      GET UNUSED SPACE RELEASE SPECIFICATION.
*
         SPACE 1
GETRLSE  EQU   *
         LA    R15,GETFALSP  RUECKSPRUNGADRESSE LADEN
         LA    R5,WKTU000D   ADRESSE DER TEXT UNIT LADEN
         BAL   R14,GETPARM   VERZW. ZUR PARAMETERPRUEFUNG
         CLC   0(4,R4),=C'RLSE' PARAMETER GUELTIG ?
         BER   R15           JA, VERZWEIGEN
         MVI   3(R5),X'FF'   NEIN, TEXT UNIT UNGUELTIG SETZEN
         SPACE 2
*
*      GET FORMAT OF ALLOCATED SPACE.
*
         SPACE 1
GETFALSP EQU   *
         LA    R15,GETROUND  RUECKSPRUNGADRESSE LADEN
         LA    R5,WKTU000E   ADRESSE DER TEXT UNIT LADEN
         BAL   R14,GETPARM   VERZW. ZUR PARAMETERPRUEFUNG
         BAL   R14,CLCFALSP  VERZW. ZUR FORMATPRUEFUNG
         MVC   FORMALSP,0(R9) FORMAT OF ALLOCATED SPACE BYTE SETZEN
         SPACE 2
*
*      GET WHOLE CYLINDER ALLOCATION SPECIFICATION.
*
         SPACE 1
GETROUND EQU   *
         LA    R15,GETVOLI   RUECKSPRUNGADRESSE LADEN
         LA    R5,WKTU000F   ADRESSE DER TEXT UNIT LADEN
         BAL   R14,GETPARM   VERZW. ZUR PARAMETERPRUEFUNG
         CLC   0(5,R4),=C'ROUND' PARAMETER GUELTIG ?
         BER   R15           JA, VERZWEIGEN
         MVI   3(R5),X'FF'   NEIN, TEXT UNIT UNGUELTIG SETZEN
         EJECT
*
*      GET VOLUME SERIAL NUMBER.
*
         SPACE 1
GETVOLI  EQU   *
         LA    R15,GETPVSP   RUECKSPRUNGADRESSE LADEN
         LA    R5,WKTU0010   ADRESSE DER TEXT UNIT LADEN
         BAL   R14,GETPARM   VERZW. ZUR PARAMETERPRUEFUNG
         MVC   VOLSERNO,0(R4) VOLSER NUMBER UEBERTRAGEN
         SPACE 2
*
*      GET PRIVATE VOLUME SPECIFICATION.
*
         SPACE 1
GETPVSP  EQU   *
         LA    R15,GETVOLSQ  RUECKSPRUNGADRESSE LADEN
         LA    R5,WKTU0011   ADRESSE DER TEXT UNIT LADEN
         BAL   R14,GETPARM   VERZW. ZUR PARAMETERPRUEFUNG
         CLC   0(7,R4),=C'PRIVATE' PARAMETER GUELTIG ?
         BER   R15           JA, VERZWEIGEN
         MVI   3(R5),X'FF'   NEIN, TEXT UNIT UNGUELTIG SETZEN
         SPACE 2
*
*      GET VOLUME SEQUENCE NUMBER.
*
         SPACE 1
GETVOLSQ EQU   *
         LA    R15,GETVOLCT  RUECKSPRUNGADRESSE LADEN
         LA    R5,WKTU0012   ADRESSE DER TEXT UNIT LADEN
         BAL   R14,GETPARM   VERZW. ZUR PARAMETERPRUEFUNG
         MVC   VOLSEQNO,0(R4) VOLUME SEQUENCE NUMBER UEBERTRAGEN
         SPACE 2
*
*      GET VOLUME COUNT.
*
         SPACE 1
GETVOLCT EQU   *
         LA    R15,GETVOLRF  RUECKSPRUNGADRESSE LADEN
         LA    R5,WKTU0013   ADRESSE DER TEXT UNIT LADEN
         BAL   R14,GETPARM   VERZW. ZUR PARAMETERPRUEFUNG
         MVC   VOLCOUNT,0(R4) VOLUME COUNT UEBERTRAGEN
         EJECT
*
*      GET VOLUME REFERENCE TO A DATA SET NAME.
*
         SPACE 1
GETVOLRF EQU   *
         LA    R15,GETUNDCP  RUECKSPRUNGADRESSE LADEN
         LA    R5,WKTU0014   ADRESSE DER TEXT UNIT LADEN
         BAL   R14,GETPARM   VERZW. ZUR PARAMETERPRUEFUNG
         MVC   VOLREF,0(R4)  VOLUME REFERENCE UEBERTRAGEN
         SPACE 2
*
*      GET UNIT DESCRIPTION.
*
         SPACE 1
GETUNDCP EQU   *
         LA    R15,GETUNCT   RUECKSPRUNGADRESSE LADEN
         LA    R5,WKTU0015   ADRESSE DER TEXT UNIT LADEN
         BAL   R14,GETPARM   VERZW. ZUR PARAMETERPRUEFUNG
         MVC   UNIT,0(R4)    UNIT DESCRIPTION UEBERTRAGEN
         SPACE 2
*
*      GET UNIT COUNT.
*
         SPACE 1
GETUNCT  EQU   *
         LA    R15,GETPLMNT  RUECKSPRUNGADRESSE LADEN
         LA    R5,WKTU0016   ADRESSE DER TEXT UNIT LADEN
         BAL   R14,GETPARM   VERZW. ZUR PARAMETERPRUEFUNG
         MVC   UNITCNT,0(R4) UNIT COUNT UEBERTRAGEN
         SPACE 2
GETPLMNT EQU   *
         SPACE 2
*
*     GET BLOCK SIZE.
*
         SPACE 1
GETBLKSZ EQU   *
         LA    R15,GETDSORG  RUECKSPRUNGADRESSE LADEN
         LA    R5,WKTU0030   ADRESSE DER TEXT UNIT LADEN
         BAL   R14,GETPARM   VERZW. ZUR PARAMETERPRUEFUNG
         MVC   BLKSIZE,0(R4) BLOCK SIZE UEBERTRAGEN
         EJECT
*
*     GET DATA SET ORGANISATION.
*
         SPACE 1
GETDSORG EQU   *
         LA    R15,GETLRECL  RUECKSPRUNGADRESSE LADEN
         LA    R5,WKTU003C   ADRESSE DER TEXT UNIT LADEN
         BAL   R14,GETPARM   VERZW. ZUR PARAMETERPRUEFUNG
         BAL   R14,CLCDSORG  VERZW. ZUR DSORG-UEBERPRUEFUNG
         MVC   DSORG,0(R9)   DSORG BYTE SETZEN
         SPACE 2
*
*     GET LOGICAL RECORD LENGTH.
*
         SPACE 1
GETLRECL EQU   *
         LA    R5,WKTU0042   ADRESSE DER TEXT UNIT LADEN
         LA    R15,GETRECFM  RUECKSPRUNGADRESSE LADEN
         BAL   R14,GETPARM   VERZW. ZUR PARAMETERPRUEFUNG
         MVC   LRECL,0(R4)   RECORD LENGTH UEBERTRAGEN
         SPACE 2
*
*     GET RECORD FORMAT.
*
         SPACE 1
GETRECFM EQU   *
         LA    R5,WKTU0049   ADRESSE DER TEXT UNIT LADEN
         LA    R15,ENDPARM   RUECKSPRUNGADRESSE LADEN
         BAL   R14,GETPARM   VERZW. ZUR PARAMETERPRUEFUNG
         BAL   R14,CLCRECFM  VERZW. ZUR RECFM-UEBERPRUEFUNG
         EJECT
***********************************************************************
*                                                                     *
*      ENDE DER PARAMETERVERARBEITUNG.                                *
*                                                                     *
***********************************************************************
         SPACE 3
ENDPARM  EQU   *
         LA    R3,4(R3)      R3 ERHOEHEN
         LA    R5,0          R5 LOESCHEN
         ST    R5,0(R3)      TEXT POINTER SPEICHERN
         OI    0(R3),X'80'   ENDE DER TEXT POINTER SPEZIFIZIEREN
         CLI   RQVERB,X'01'  DATA SET NAME ALLOCATION ?
         BNE   DYNALLOC      NEIN, VERZWEIGEN
         LA    R5,WKTU001C   ADRESSE DER TEXT UNIT (UNALLOCATION AT
         ST    R5,0(R3)          CLOSE) LADEN UND SPEICHERN
         OI    0(R3),X'80'   ENDE DER TEXT POINTER SPEZIFIZIEREN
         TM    0(R2),X'80'   ENDE DER PARAMETERKETTE ?
         BO    DYNALLOC      JA, VERZWEIGEN
         LA    R2,4(R2)      R2 ERHOEHEN
         ICM   R4,7,1(R2)    ADRESSE DES NAECHSTEN PARAMETERS LADEN
         BZ    DYNALLOC      VERZW., WENN ADRESSE = 0
         CLC   0(7,R4),=C'NOUNALC' NO UNALLOCATION AT CLOSE ?
         BNE   DYNALLOC      NEIN, VERZWEIGEN
         XC    1(3,R3),1(R3) TEXT POINTER LOESCHEN
         EJECT
***********************************************************************
*                                                                     *
*      DYNAMIC ALLOCATION.                                            *
*                                                                     *
***********************************************************************
         SPACE 3
DYNALLOC EQU   *
         LA    R1,RQBLKPTR   ADRESSE DES RQBLK POINTERS LADEN
         DYNALLOC
         SPACE 1
         L     R2,8(R11)     ADRESSE DES DDNAME LADEN
         LA    R2,0(R2)      ERSTES BYTE IN R2 LOESCHEN
         LTR   R2,R2         ADRESSE DES DDNAME SPEZIFIZIERT ?
         BZ    LHRC          NEIN, VERZWEIGEN
         L     R3,TEXTPTR    TEXT POINTER LADEN
         LA    R4,WKTU0055   ADRESSE DER TEXT UNIT LADEN
         CR    R3,R4         TEXT POINTER = ADR.DER TEXT UNIT WKTU0055?
         BNE   LHRC          NEIN, VERZWEIGEN
         IC    R3,DDNLRET    LAENGE LADEN
         BCTR  R3,0          R3 VERMINDERN
         EX    R3,MVCDDNAM   VERZW. ZUR UEBERGABE DES DDNAME
LHRC     EQU   *
         LH    R0,RQEC       ERROR REASON CODE LADEN
         LH    R1,RQIC       INFORMATION REASON CODE LADEN
         LA    R10,0         R10 LOESCHEN
         ICM   R10,7,1(R11)  ADRESSE DES RC-BEREICHS LADEN
         BZ    ABSCHLUS      VERZW., WENN ADRESSE = 0
         STM   R15,R1,0(R10) RETURN CODES SPEICHERN
         EJECT
***********************************************************************
*                                                                     *
*      ABSCHLUSSROUTINE.                                              *
*                                                                     *
***********************************************************************
         SPACE 3
ABSCHLUS EQU   *
         XRETURN ,R
         EJECT
***********************************************************************
*                                                                     *
*      PRUEFUNG DER EINZELPARAMETER.                                  *
*                                                                     *
***********************************************************************
         SPACE 3
GETPARM  EQU   *
         TM    0(R2),X'80'   LETZTER PARAMETER ERREICHT ?
         BOR   R10           JA, VERZWEIGEN
         LA    R2,4(R2)      R2 ERHOEHEN
         ICM   R4,7,1(R2)    ADRESSE DES NAECHSTEN PARAMETERS LADEN
         BZR   R15           VERZW., WENN ADRESSE = 0
NXTPTR   EQU   *
         LA    R3,4(R3)      R3 ERHOEHEN
         ST    R5,0(R3)      TEXT POINTER SPEICHERN
         BR    R14           VERZWEIGEN
         EJECT
***********************************************************************
*                                                                     *
*      DURCHLAUFEN DER TABELLEN.                                      *
*                                                                     *
***********************************************************************
         SPACE 3
*
*      DURCHLAUFEN DER STATUS-TABELLE.
*
         SPACE 1
CLCSTAT  EQU   *
         LA    R9,TABSTAT-4  ADRESSE DER STATUS-TABELLE LADEN
NXTSTAT  EQU   *
         LA    R9,4(R9)      R9 ERHOEHEN
         CLI   0(R9),X'FF'   TABELLENENDE ERREICHT ?
         BER   R14           JA, VERZWEIGEN
         CLC   1(3,R9),0(R4) VORGEGEBENER STATUS GEFUNDEN ?
         BNE   NXTSTAT       NEIN, VERZWEIGEN
         BR    R14           JA, VERZWEIGEN
         SPACE 2
*
*      DURCHLAUFEN DER DISPOSITION-TABELLE.
*
         SPACE 1
CLCDISP  EQU   *
         LA    R9,TABDISP-8  ADRESSE DER DISPOSITION-TABELLE LADEN
NXTDISP  EQU   *
         LA    R9,8(R9)      R9 ERHOEHEN
         CLI   0(R9),X'FF'   TABELLENENDE ERREICHT ?
         BER   R14           JA, VERZWEIGEN
         CLC   1(7,R9),0(R4) VORGEGEBENE DISPOSITION GEFUNDEN ?
         BNE   NXTDISP       NEIN, VERZWEIGEN
         BR    R14           JA, VERZWEIGEN
         SPACE 2
*
*      DURCHLAUFEN DER FORMAT-TABELLE.
*
         SPACE 1
CLCFALSP EQU   *
         LA    R9,TABFALSP-7 ADRESSE DER FORMAT-TABELLE LADEN
NXTFALSP EQU   *
         LA    R9,7(R9)      R9 ERHOEHEN
         CLI   0(R9),X'FF'   TABELLENENDE ERREICHT ?
         BER   R14           JA, VERZWEIGEN
         CLC   1(6,R9),0(R4) VORGEGEBENES FORMAT GEFUNDEN ?
         BNE   NXTFALSP      NEIN, VERZWEIGEN
         BR    R14           JA, VERZWEIGEN
         EJECT
*
*      DURCHLAUFEN DER TYP-TABELLE FUER DYNALLOC-TYP.
*
         SPACE 1
CLCTYPE  EQU   *
         LA    R9,TABTYPE-9  ADRESSE DER TYP-TABELLE LADEN
NXTTYPE  EQU   *
         LA    R9,9(R9)      R9 ERHOEHEN
         CLI   0(R9),X'FF'   TABELLENENDE ERREICHT ?
         BER   R14           JA, VERZWEIGEN
         CLC   1(8,R9),0(R4) VORGEGEBENER DYNALLOC-TYP GEFUNDEN ?
         BNE   NXTTYPE       NEIN, VERZWEIGEN
         BR    R14           JA, VERZWEIGEN
         SPACE 2
*
*      DURCHLAUFEN DER DSORG-TABELLE.
*
         SPACE 1
CLCDSORG EQU   *
         LA    R9,TABDSORG-6 ADRESSE DER TABELLE LADEN
NXTDSORG EQU   *
         LA    R9,6(R9)      R9 ERHOEHEN
         CLI   0(R9),X'FF'   ENDE DER TABELLE ERREICHT ?
         BER   R14           JA, VERZWEIGEN
         CLC   2(4,R9),0(R4) VORGEGEBENE DSORG GEFUNDEN ?
         BNE   NXTDSORG      NEIN, VERZWEIGEN
         BR    R14           VERZWEIGEN
         SPACE 2
*
*      DURCHLAUFEN DER RECFM-TABELLE.
*
         SPACE 1
CLCRECFM EQU   *
         LA    R9,TABRECFM-2 ADRESSE DER TABELLE LADEN
NXTRECFM EQU   *
         LA    R9,2(R9)      R9 ERHOEHEN
         CLI   0(R9),X'FF'   ENDE DER TABELLE ERREICHT ?
         BE    OCRECFM       JA, VERZWEIGEN
         CLC   1(1,R9),0(R4) VORGEGEBENES RECORD FORMAT ?
         BNE   NXTRECFM      NEIN, VERZWEIGEN
OCRECFM  EQU   *
         OC    RECFM,0(R9)   RECFM BYTE MODIFIZIEREN
         CLI   1(R4),C' '    ENDE DES PARAMETERS ERREICHT ?
         BER   R14           JA, VERZWEIGEN
         LA    R4,1(R4)      R4 ERHOEHEN
         B     CLCRECFM      VERZWEIGEN
         EJECT
***********************************************************************
*                                                                     *
*      BEFEHLE, DIE MIT HILFE DES EXECUTE-BEFEHLS AUSGEFUEHRT WERDEN. *
*                                                                     *
***********************************************************************
         SPACE 3
MVCDDNAM EQU   *
         MVC   0(0,R2),DDNAMRET DDNAME UEBERGEBEN
         SPACE 3
***********************************************************************
*                                                                     *
*      REGISTER EQUATES.                                              *
*                                                                     *
***********************************************************************
         SPACE 3
R0       EQU   0             MACRO- UND PARAMETER-REGISTER
R1       EQU   1             MACRO- UND PARAMETER-REGISTER
R2       EQU   2             POINTER AUF ADRESSE DES LFD. PARAMETERS
R3       EQU   3             POINTER AUF TEXT POINTER
R4       EQU   4             POINTER AUF LAUFENDEN PARAMETER
R5       EQU   5             POINTER AUF TEXT UNIT
R6       EQU   6
R7       EQU   7
R8       EQU   8
R9       EQU   9             POINTER IN TABELLEN
R10      EQU   10            RUECKSPRUNGADRESSE BEI LETZTEM PARAMETER
R11      EQU   11            POINTER AUF PARAMETER-BEREICH
R12      EQU   12            BASISREG. FUER CSECT DYNALC
R13      EQU   13            BASISREG. FUER DSECT ABER
R14      EQU   14            RUECKSPRUNGADRESSEN
R15      EQU   15            RUECKSPRUNGADRESSE BEI PARAMETERADRESSE =0
         EJECT
***********************************************************************
*                                                                     *
*      DEFINITION DER KONSTANTEN-SPEICHER.                            *
*                                                                     *
***********************************************************************
         SPACE 3
*
*      STATUS-TABELLE.
*
         SPACE 1
TABSTAT  EQU   *
         DC    X'08',C'SHR'
         DC    X'04',C'NEW'
         DC    X'02',C'MOD'
         DC    X'01',C'OLD'
         DC    X'FF',CL3' '  TABELLENENDE
         SPACE 2
*
*      DISPOSITION-TABELLE.
*
         SPACE 1
TABDISP  EQU   *
         DC    X'08',CL7'KEEP'
         DC    X'04',CL7'DELETE'
         DC    X'02',CL7'CATLG'
         DC    X'01',CL7'UNCATLG'
         DC    X'FF',CL7' '  TABELLENENDE
         SPACE 2
*
*      FORMAT-TABELLE (FUER ALLOCATED SPACE).
*
         SPACE 1
TABFALSP EQU   *
         DC    X'08',CL6'CONTIG'
         DC    X'04',CL6'MXIG'
         DC    X'02',CL6'ALX'
         DC    X'FF',CL6' '  TABELLENENDE
         EJECT
*
*      DSORG-TABELLE.
*
         SPACE 1
TABDSORG EQU   *
         DC    X'4100',C'PSU '
         DC    X'4000',C'PS  '
         DC    X'2100',C'DAU '
         DC    X'2000',C'DA  '
         DC    X'1000',C'CX  '
         DC    X'0800',C'CQ  '
         DC    X'0400',C'MQ  '
         DC    X'0300',C'POU '
         DC    X'0200',C'PO  '
         DC    X'0080',C'GS  '
         DC    X'0040',C'TX  '
         DC    X'0020',C'TQ  '
         DC    X'0008',C'VSAM'
         DC    X'0004',C'3705'
         DC    X'FFFF',C'    ' TABELLENENDE
         SPACE 2
*
*      RECFM-TABELLE.
*
         SPACE 1
TABRECFM EQU   *
         DC    X'C0',C'U'
         DC    X'80',C'F'
         DC    X'40',C'V'
         DC    X'20',C'D'
         DC    X'20',C'T'
         DC    X'10',C'B'
         DC    X'08',C'S'
         DC    X'04',C'A'
         DC    X'04',C'G'
         DC    X'02',C'M'
         DC    X'02',C'R'
         DC    X'FF',C' '    TABELLENENDE
         EJECT
*
*      TYP-TABELLE FUER DYNALLOC-TYP.
*
         SPACE 1
TABTYPE  EQU   *
         DC    X'01',C'DSALLOC ' DATA SET NAME ALLOCATION
         DC    X'02',C'UNALLOC ' DYNAMIC UNALLOCATION
         DC    X'03',C'CONCAT  ' DYNAMIC CONCATENATION
         DC    X'04',C'DECONCAT' DYNAMIC DECONCATENATION
         DC    X'05',C'REMOVE  ' REMOVAL OF THE IN-USE ATTRIBUTE
         DC    X'06',C'DDALLOC ' DDNAME ALLOCATION
         DC    X'07',C'RETRIEVE' DYNAMIC INFORMATION RETRIEVAL
         DC    X'FF',CL8' '  TABELLENENDE
         SPACE 2
*
*      PARAMETERSTRUKTUR FUER DYNALLOC-MACRO (KONSTANTEN).
*
         SPACE 1
*S99RBPTR DC   X'80'         REQUEST BLOCK POINTER
*        DC    AL3(S99RB)    ADRESSE DES REQUEST BLOCK
         SPACE 1
S99RB    DS    5F            REQUEST BLOCK
         ORG   S99RB
S99RBLN  DC    AL1(20)       LAENGE DES REQUEST BLOCK
S99VERB  DC    X'01'         VERB CODE
S99FLAG1 DC    H'0'          FLAGS 1
S99ERROR DC    H'0'          ERROR REASON CODE
S99INFO  DC    H'0'          INFORMATION REASON CODE
S99TXTPP DC    A(0)          ADRESSE DER TEXT POINTER
         DC    F'0'          RESERVED
S99FLAG2 DC    F'0'          FLAGS 2
         EJECT
*
*      DATA SET NAME ALLOCATION TEXT UNITS (KONSTANTEN).
*
         SPACE 1
S99TUNIT EQU   *
TU0001   DC    X'00010001'   DDNAME SPECIFICATION
         DC    X'0008'
         DC    CL8' '
TU0002   DC    X'00020001'   DATA SET NAME SPECIFICATION
         DC    AL2(44)
         DC    CL44' '
TU0003   DC    X'00030001'   MEMBER NAME SPECIFICATION
         DC    X'0008'
         DC    CL8' '
TU0004   DC    X'00040001'   DATA SET STATUS SPECIFICATION
         DC    X'0001'
         DC    X'04'         DEFAULT: NEW
TU0005   DC    X'00050001'   DS NORMAL DISPOSITION SPECIFICATION
         DC    X'0001'
         DC    X'04'         DEFAULT: DELETE
TU0006   DC    X'00060001'   DS CONDITIONAL DISPOSITION SPECIFICATION
         DC    X'0001'
         DC    X'04'         DEFAULT: DELETE
TU0007   DC    X'00070000'   TRACK SPACE TYPE (TRK) SPECIFICATION
TU0008   DC    X'00080000'   CYLINDER SPACE TYPE (CYL) SPECIFICATION
TU0009   DC    X'00090001'   BLOCK SPACE TYPE SPECIFICATION
         DC    X'0003'
         DC    XL3'0'
TU000A   DC    X'000A0001'   PRIMARY SPACE QUANTITY SPECIFICATION
         DC    X'0003'
         DC    XL3'0'
TU000B   DC    X'000B0001'   SECONDARY SPACE QUANTITY SPECIFICATION
         DC    X'0003'
         DC    XL3'0'
TU000C   DC    X'000C0001'   DIRECTORY BLOCK SPECIFICATION
         DC    X'0003'
         DC    XL3'0'
TU000D   DC    X'000D0000'   UNUSED SPACE RELEASE (RLSE) SPECIFICATION
TU000E   DC    X'000E0001'   FORMAT OF ALLOCATED SPACE SPECIFICATION
         DC    X'0001'
         DC    X'00'
TU000F   DC    X'000F0000'   WHOLE CYLINDER ALLOCATION (ROUND) SPEC.
TU0010   DC    X'00100001'   VOLUME SERIAL SPECIFICATION
         DC    X'0006'
         DC    CL6' '
TU0011   DC    X'00110000'   PRIVATE VOLUME SPECIFICATION
TU0012   DC    X'00120001'   VOLUME SEQUENCE NUMBER SPECIFICATION
         DC    X'0002'
         DC    X'0000'
TU0013   DC    X'00130001'   VOLUME COUNT SPECIFICATION
         DC    X'0001'
         DC    X'00'
         EJECT
TU0014   DC    X'00140001'   VOLUME REFERENCE TO A DSNAME SPECIFICATION
         DC    X'0008'
         DC    CL8' '
TU0015   DC    X'00150001'   UNIT DESCRIPTION SPECIFICATION
         DC    X'0008'
         DC    CL8' '
TU0016   DC    X'00160001'   UNIT COUNT SPECIFICATION
         DC    X'0001'
         DC    X'00'
TU0017   DC    X'00170000'   PARALLEL MOUNT SPECIFICATION
TU0018   DC    X'00180001'   SYSOUT SPECIFICATION
         DC    X'0001'
         DC    X'00'
TU0019   DC    X'00190001'   SYSOUT PROGRAM NAME SPECIFICATION
         DC    X'0008'
         DC    CL8' '
TU001A   DC    X'001A0001'   SYSOUT FORM NUMBER SPECIFICATION
         DC    X'0004'
         DC    CL4' '
TU001B   DC    X'001B0001'   SYSOUT OUTPUT LIMIT SPECIFICATION
         DC    X'0003'
         DC    XL3'0'
TU001C   DC    X'001C0000'   UNALLOCATION AT CLOSE SPECIFICATION
TU001D   DC    X'001D0001'   SYSOUT COPIES SPECIFICATION
         DC    X'0001'
         DC    X'00'
TU0030   DC    X'00300001'   BLKSIZE SPECIFICATION
         DC    X'0002'
         DC    XL2'0'
TU003C   DC    X'003C0001'   DSORG SPECIFICATION
         DC    X'0002'
         DC    XL2'0'
TU0042   DC    X'00420001'   LRECL SPECIFICATION
         DC    X'0002'
         DC    XL2'0'
TU0049   DC    X'00490001'   RECFM SPECIFICATION
         DC    X'0001'
         DC    X'00'
TU0055   DC    X'00550001'   DDNAME RETURN SPECIFICATION
         DC    X'0008'
         DC    CL8' '
         SPACE 1
S99TULEN EQU   *-S99TUNIT    GESAMTLAENGE DER TEXT UNITS
         EJECT
***********************************************************************
*                                                                     *
*      DEFINITION DER ARBEITSBEREICHE.                                *
*                                                                     *
***********************************************************************
         SPACE 3
ABER     DSECT
SAVEAREA DS    18F           SAVEAREA FUER ALLGEMEINE REGISTER
TEXTPTR  DS    100F          TEXT POINTERS
         SPACE 2
*
*      PARAMETERSTRUKTUR FUER DYNALLOC-MACRO (ARBEITSBEREICH).
*
         SPACE 1
RQBLKPTR DS    F             REQUEST BLOCK POINTER
         SPACE 1
RQBLK    DS    5F            REQUEST BLOCK
         ORG   RQBLK
         DS    C
RQVERB   DS    CL1           VERB CODE
RQFLAGS1 DS    H                       FLAGS 1
RQEC     DS    H             ERROR REASON CODE
RQIC     DS    H             INFORMATION REASON CODE
RQTXTPTR DS    F             ADRESSE DER TEXT POINTER
         DS    F                       RESERVED
RQFLAGS2 DS    H                       FLAGS 2
         DS    H                       RESERVED
         EJECT
*
*      DATA SET NAME ALLOCATION TEXT UNITS (ARBEITSBEREICH).
*
         SPACE 1
TEXTUNIT EQU   *
WKTU0001 DS    CL6           DDNAME SPECIFICATION
DDNAME   DS    CL8
WKTU0002 DS    CL6           DATA SET NAME SPECIFICATION
DSNAME   DS    CL44
WKTU0003 DS    CL6           MEMBER NAME SPECIFICATION
MEMBNAME DS    CL8
WKTU0004 DS    CL6           DATA SET STATUS SPECIFICATION
STATUS   DS    C
WKTU0005 DS    CL6           DS NORMAL DISPOSITION SPECIFICATION
NDISP    DS    C
WKTU0006 DS    CL6           DS CONDITIONAL DISPOSITION SPECIFICATION
CDISP    DS    C
WKTU0007 DS    CL4           TRACK SPACE TYPE (TRK) SPECIFICATION
WKTU0008 DS    CL4           CYLINDER SPACE TYPE (CYL) SPECIFICATION
WKTU0009 DS    CL6           BLOCK SPACE TYPE SPECIFICATION
BLKSPACE DS    CL3
WKTU000A DS    CL6           PRIMARY SPACE QUANTITY SPECIFICATION
PRMSPACE DS    CL3
WKTU000B DS    CL6           SECONDARY SPACE QUANTITY SPECIFICATION
SECSPACE DS    CL3
WKTU000C DS    CL6           DIRECTORY BLOCK SPECIFICATION
DIRBLOCK DS    CL3
WKTU000D DS    CL4           UNUSED SPACE RELEASE (RLSE) SPECIFICATION
WKTU000E DS    CL6           FORMAT OF ALLOCATED SPACE SPECIFICATION
FORMALSP DS    C
WKTU000F DS    CL4           WHOLE CYLINDER ALLOCATION (ROUND) SPEC.
WKTU0010 DS    CL6           VOLUME SERIAL SPECIFICATION
VOLSERNO DS    CL6
WKTU0011 DS    CL4           PRIVATE VOLUME SPECIFICATION
WKTU0012 DS    CL6           VOLUME SEQUENCE NUMBER SPECIFICATION
VOLSEQNO DS    CL2
WKTU0013 DS    CL6           VOLUME COUNT SPECIFICATION
VOLCOUNT DS    C
WKTU0014 DS    CL6           VOLUME REFERENCE TO A DSNAME SPECIFICATION
VOLREF   DS    CL8
         EJECT
WKTU0015 DS    CL6           UNIT DESCRIPTION SPECIFICATION
UNIT     DS    CL8
WKTU0016 DS    CL6           UNIT COUNT SPECIFICATION
UNITCNT  DS    C
WKTU0017 DS    CL4           PARALLEL MOUNT SPECIFICATION
WKTU0018 DS    CL6           SYSOUT SPECIFICATION
SOUTCLS  DS    C
WKTU0019 DS    CL6           SYSOUT PROGRAM NAME SPECIFICATION
SOUTNAME DS    CL8
WKTU001A DS    CL6           SYSOUT FORM NUMBER SPECIFICATION
SOUTFORM DS    CL4
WKTU001B DS    CL6           SYSOUT OUTPUT LIMIT SPECIFICATION
SOUTLIM  DS    CL3
WKTU001C DS    CL4           UNALLOCATION AT CLOSE SPECIFICATION
WKTU001D DS    CL6           SYSOUT COPIES SPECIFICATION
COPIES   DS    C
WKTU0030 DS    CL6           BLKSIZE SPECIFICATION
BLKSIZE  DS    CL2
WKTU003C DS    CL6           DSORG SPECIFICATION
DSORG    DS    CL2
WKTU0042 DS    CL6           LRECL SPECIFICATION
LRECL    DS    CL2
WKTU0049 DS    CL6           RECFM SPECIFICATION
RECFM    DS    C
WKTU0055 DS    CL5           DDNAME RETURN SPECIFICATION
DDNLRET  DS    C             LAENGE DES DDNAME
DDNAMRET DS    CL8           DDNAME
         SPACE 1
ABERL    EQU   *-ABER        LAENGE DER ARBEITSBEREICHE
         EJECT
         END   DYNALC
./ ADD  NAME=FASID
         TITLE 'FASID                            FIND ASID OR JOBNAME'
FASID    CSECT
         SPACE 3
***********************************************************************
*                                                                     *
*      IDENTIFICATION DIVISION.                                       *
*                                                                     *
*      PROGRAM-ID. FASID.                                             *
*      AUTHOR. EHNERT.                                                *
*      INSTALLATION. BAYER AG, LEVERKUSEN, RECHENZENTRUM.             *
*      DATE-WRITTEN. 8.7.1974.                                        *
*      REMARKS.                                                       *
*          DAS PROGRAMM FASID IST EIN UNTERPROGRAMM ZU DEN X-COMMANDS.*
*          ES SUCHT ZU EINEM VORGEGEBENEN JOBNAMEN DIE ADRESS-SPACE-  *
*          IDENTIFICATION UNTER DER VORAUSSETZUNG, DASS DAS DAFUER    *
*          VORGESEHENE FELD = X'0000' IST.                            *
*              SOLLEN JOB- UND STEPNAMEN ZU EINER VORGEGEBENEN ASID   *
*          GESUCHT WERDEN, SO MUSS DER BEREICH FUER DEN JOBNAMEN      *
*          BLANKS ENTHALTEN.                                          *
*                                                                     *
*              DAS PROGRAMM ERWARTET IN REGISTER 1 DIE ADRESSE EINES  *
*          PARAMETERBEREICHES MIT FOLGENDEM AUFBAU:                   *
*          1)  DIE 4-BYTE-ADRESSE EINES HALBWORTS FUER DIE ASID       *
*          2)  DIE 4-BYTE-ADRESSE EINES 8-BYTE-BEREICHES FUER DEN     *
*              JOBNAMEN                                               *
*          3)  DIE 4-BYTE-ADRESSE EINES 8-BYTE-BEREICHES FUER DEN     *
*              STEPNAMEN. DAS ERSTE BIT DIESES ADRESSENBEREICHES MUSS *
*              GESETZT SEIN, UM DIE ADRESSE DES STEPNAMEN ALS LETZTEN *
*              PARAMETER IDENTIFIZIEREN ZU KOENNEN.                   *
*                                                                     *
*              DAS PROGRAMM WIRD MIT FOLGENDEN RETURN-CODES BEENDET:  *
*          RC = 0:  DIE VERARBEITUNG WURDE ERFOLGREICH BEENDET.       *
*          RC = 8:  GESUCHTE JOB- UND STEPNAMEN ODER GESUCHTE ASID    *
*                   WURDEN NICHT GEFUNDEN, ODER DAS SYSTEM IST NICHT  *
*                   VS2,REL2.                                         *
*          RC = 16: EIN FEHLER IN DER PARAMETERKETTE ODER BEI DER     *
*                   ADRESSIERUNG WURDE ENTDECKT.                      *
*                                                                     *
***********************************************************************
         EJECT
***********************************************************************
*                                                                     *
*      PROCEDURE DIVISION.                                            *
*                                                                     *
***********************************************************************
         SPACE 3
*
*      SICHERN DER REGISTER UND ZUORDNUNG DES BASISREGISTERS.
*
         SPACE 2
         SAVE  (14,12),,*    REGISTER SICHERN
         LR    R12,R15       BASISREGISTER INITIALISIEREN
         USING FASID,R12     BASISREGISTER ZUORDNEN
         SPACE 3
*
*      PARAMETERLISTE PRUEFEN.
*
         SPACE 2
         TM    0(R1),X'80'   ERSTER PARAMETER = LETZTE ADRESSE ?
         BO    RETURN16      JA, VERZWEIGEN ZUM ABSCHLUSS
         TM    4(R1),X'80'   ZWEITER PARAMETER = LETZTE ADRESSE ?
         BO    RETURN16      JA, VERZWEIGEN ZUM ABSCHLUSS
         TM    8(R1),X'80'   DRITTER PARAMETER = LETZTE ADRESSE ?
         BNO   RETURN16      NEIN, VERZWEIGEN ZUM ABSCHLUSS
         SPACE 1
         LM    R2,R4,0(R1)   ADRESSEN DER PARAMETER LADEN
         SPACE 1
         LTR   R2,R2         ADRESSE DER ASID GUELTIG ?
         BZ    RETURN16      NEIN, VERZWEIGEN ZUM ABSCHLUSS
         LTR   R3,R3         ADRESSE DES JOBNAMEN GUELTIG ?
         BZ    RETURN16      NEIN, VERZWEIGEN ZUM ABSCHLUSS
         LA    R4,0(R4)      ERSTES BYTE IN R4 LOESCHEN
         LTR   R4,R4         ADRESSE DES STEPNAMEN GUELTIG ?
         BZ    RETURN16      NEIN, VERZWEIGEN ZUM ABSCHLUSS
         EJECT
*
*      GUELTIGKEIT DER PARAMETER PRUEFEN.
*
         SPACE 2
         LH    R7,0(R2)      ASID LADEN
         LTR   R7,R7         ASID VORGEGEBEN ?
         BZ    GJN           NEIN, VERZWEIGEN
         SPACE 1
         CLC   0(8,R3),=CL8' ' JOBNAME VORGEGEBEN ?
         BNE   RETURN16      JA, VERZW., DA ASID UND JOBN. GEGEBEN
         SPACE 1
         B     FASVT         VERZW. ZUM AUFSUCHEN DER ASVT
         SPACE 1
GJN      EQU   *
         CLC   0(8,R3),=CL8' ' JOBNAME VORGEGEBEN ?
         BE    RETURN16      NEIN, VERZW.,DA ASID & JOBN. NICHT GEGEBEN
         SPACE 3
*
*      AUFSUCHEN DER ASVT.
*
         SPACE 2
FASVT    EQU   *
         L     R5,16         ADRESSE DER CVT LADEN
         TM    116(R5),X'01' SYSTEM = MVS ?
         BZ    RETURN16      NEIN, VERZW. ZUM ABSCHLUSS
         SPACE 1
         L     R5,556(R5)    ADRESSE DER ASVT LADEN
         CLC   512(4,R5),=CL4'ASVT' ASVT ?
         BNE   RETURN16      NEIN, VERZW. ZUM ABSCHLUSS
         SPACE 1
         L     R11,516(R5)   MAXIMALE ASCB-ANZAHL LADEN
         LA    R5,524(R5)    POINTER AUF ASCB-ADRESSEN LADEN
         EJECT
*
*      DURCHLAUFEN DER ASCB-KETTE.
*
         SPACE 2
SCHLEIFE EQU   *
         LA    R5,4(R5)      POINTER AUF NAECHSTE ASCB-ADRESSE LADEN
         BCTR  R11,0         ASCB-ANZAHL - 1
         LTR   R11,R11       ALLE ASCBS VERARBEITET ?
         BZ    RETURN8       BEI ENDE DER ASCB'S ZUM ABSCHLUSS VERZW.
         SR    R6,R6         R6 LOESCHEN
         ICM   R6,7,1(R5)    ADRESSE DES ASCB LADEN
         BZ    RETURN8       BEI ENDE DER ASCB'S ZUM ABSCHLUSS VERZW.
         SPACE 1
         TM    0(R5),X'80'   ASID VERFUEGBAR ?
         BO    SCHLEIFE      NEIN, VERZWEIGEN
         SPACE 1
         CLC   0(4,R6),=CL4'ASCB' ASCB ?
         BNE   RETURN16      NEIN, VERZW. ZUM ABSCHLUSS
         SPACE 1
         LM    R8,R9,172(R6) ADRESSEN DER JOBNAMEN LADEN
         CH    R7,36(R6)     ASID'S GLEICH ?
         BE    MAS           JA, VERZWEIGEN
         SPACE 1
         CLC   0(8,R8),0(R3) JOBNAME = 1.JOBNAME ?
         BE    STASID        JA, VERZW. ZUM UEBERTRAGEN DER ASID
         SPACE 1
         CLC   0(8,R9),0(R3) JOBNAME = 2.JOBNAME ?
         BNE   SCHLEIFE      NEIN, VERZW. ZUR SCHLEIFE
         SPACE 3
*
*      ASID UEBERTRAGEN.
*
         SPACE 2
STASID   EQU   *
         LH    R7,36(R6)     ASID LADEN
         ST    R6,24(R13)    ASCB ADRESSE SPEICHERN
         STH   R7,0(R2)      ASID SPEICHERN
         EJECT
*
*      ROUTINE BEI MASTER-SCHEDULER.
*
         SPACE 2
MAS      EQU   *
         CLI   0(R9),C'*'    '*MASTER*' ODER '*AUXSTM*' ?
         BNE   NOMAS         NEIN, VERZW. ZU WEITEREN ABFRAGEN
         SPACE 1
         MVC   0(8,R3),0(R9) NAME UEBERTRAGEN
         MVC   0(8,R4),=CL8' ' STEPNAME = ' '
         B     RETURN0       VERZWEIGEN ZUM ABSCHLUSS
         SPACE 3
*
*      ROUTINE BEI INITIATOR.
*
         SPACE 2
NOMAS    EQU   *
         L     R10,56(R6)    ADRESSE DES CSCB LADEN
         CLI   28(R10),X'03' INITIATOR ?
         BNE   NOINIT        NEIN, VERZW. ZU WEITEREN ABFRAGEN
         SPACE 1
         LTR   R8,R8         ERSTE ADRESSE = 0 ?
         BZ    RETURN8       JA, VERZW. ZUM ABSCHLUSS
         SPACE 1
         MVC   0(8,R3),0(R8) JOBNAME UEBERTRAGEN
         LA    R0,8          R0 = 8
         SLR   R8,R0         R8 ZEIGT AUF CSCB
         CLC   32(8,R8),=CL8' ' PROCSTEPNAME = ' ' ?
         BE    *+14          JA, VERZWEIGEN
         SPACE 1
         MVC   0(8,R4),32(R8) PROCSTEPNAME UEBERTRAGEN
         B     RETURN0       VERZWEIGEN ZUM ABSCHLUSS
         SPACE 1
         MVC   0(8,R4),64(R8) STEPNAME UEBERTRAGEN
         B     RETURN0       VERZWEIGEN ZUM ABSCHLUSS
         EJECT
*
*      ROUTINE BEI STARTED TASK.
*
         SPACE 2
NOINIT   EQU   *
         CLI   28(R10),X'02' STARTED TASK ?
         BNE   NOTASK        NEIN, VERZW. ZU WEITEREN ABFRAGEN
         SPACE 1
         MVC   0(8,R3),16(R10) TASKNAME UEBERTRAGEN
         CLC   32(8,R10),=CL8' ' PROCSTEPNAME = ' ' ?
         BE    *+14          JA, VERZWEIGEN
         SPACE 1
         MVC   0(8,R4),32(R10) PROCSTEPNAME UEBERTRAGEN
         B     RETURN0       VERZWEIGEN ZUM ABSCHLUSS
         SPACE 1
         MVC   0(8,R4),8(R10) STEPNAME UEBERTRAGEN
         B     RETURN0       VERZWEIGEN ZUM ABSCHLUSS
         SPACE 3
*
*      ROUTINE BEI TSO-USER.
*
         SPACE 2
NOTASK   EQU   *
         CLI   28(R10),X'01' TSO USER ?
         BNE   RETURN16      NEIN, VERZW. ZUM ABSCHLUSS
         SPACE 1
         MVC   0(8,R3),8(R10) TSO-USERID UEBERTRAGEN
         MVC   0(8,R4),16(R10) PROCNAME UEBERTRAGEN
         EJECT
*
*      ABSCHLUSS.
*
         SPACE 2
RETURN0  EQU   *
         RETURN (14,12),RC=0
         SPACE 1
RETURN8  EQU   *
         RETURN (14,12),RC=8
         SPACE 1
RETURN16 EQU   *
         RETURN (14,12),RC=16
         EJECT
*
*      REGISTER EQUATES.
*
         SPACE 2
R0       EQU   0
R1       EQU   1             ENTHAELT ADRESSE DES PARAMETERBEREICHES
R2       EQU   2             ENTHAELT ADRESSE DER ASID
R3       EQU   3             ENTHAELT ADRESSE DES JOBNAMEN
R4       EQU   4             ENTHAELT ADRESSE DES STEPNAMEN
R5       EQU   5             ENTHAELT ADRESSE DER ASCB-ADRESSE
R6       EQU   6             ENTHAELT ADRESSE DES ASCB
R7       EQU   7             ENTHAELT ASID
R8       EQU   8             ENTHAELT ADRESSE DES ERSTEN JOBNAMEN
R9       EQU   9             ENTHAELT ADRESSE DES ZWEITEN JOBNAMEN
R10      EQU   10            ENTHAELT ADRESSE DES CSCB
R11      EQU   11
R12      EQU   12            BASISREGISTER FUER CSECT FASID
R13      EQU   13
R14      EQU   14
R15      EQU   15
         END   FASID
./ ADD  NAME=FIND
         TITLE 'XFIND                            X-COMMAND FIND'
FIND     CSECT
         SPACE 3
***********************************************************************
*                                                                     *
*      IDENTIFICATION DIVISION.                                       *
*                                                                     *
*      PROGRAM-ID. FIND.                                              *
*      AUTHOR. EHNERT.                                                *
*      INSTALLATION. BAYER AG, LEVERKUSEN, RECHENZENTRUM.             *
*      DATE-WRITTEN. 11. 12. 1974.                                    *
*      REMARKS.                                                       *
*                                                                     *
*          DAS X-COMMAND 'FIND' GIBT INFORMATIONEN UEBER DAS ALS      *
*          PARAMETER SPEZIFIZIERTE MITGLIED PO-ORGANISIERTER DATEIEN  *
*          AUS.                                                       *
*                                                                     *
*          ZUSAETZLICH KOENNEN BIS ZU ZEHN VOLUME-MASKEN ANGE-        *
*          GEBEN WERDEN, MIT DEREN HILFE EINE AUSWAHL DER VOLUMES GE- *
*          TROFFEN WIRD, DIE DAS X-COMMAND NACH DEM SPEZIFIZIERTEN    *
*          MEMBER DURCHSUCHT. DABEI STEHT '*' FUER JEDES ZEICHEN AN   *
*          DIESER STELLE. SIND KEINE MASKEN ANGEGEBEN, SO WERDEN      *
*          STANDARDMAESSIG ALLE ONLINE LIBRARYS DURCHSUCHT.           *
*                                                                     *
*          WIRD ZUDEM DER PARAMETER 'TEST' ANGEGEBEN, SO WERDEN ALLE  *
*          FEHLERNACHRICHTEN AUSGEGEBEN, DIE BEIM FEHLEN DES PARAME-  *
*          TERS STANDARDMAESSIG UNTERDRUECKT WERDEN.                  *
*                                                                     *
*          DURCH DIE ZUM AUFSUCHEN DES MEMBERS NOTWENDIGE DYNAMIC     *
*          ALLOCATION, DIE IM EXTERNEN UNTERPROGRAMM 'DYNALC' DURCH-  *
*          GEFUEHRT WIRD, KANN DAS X-COMMAND 'FIND' NUR IM SYSTEM     *
*          OS/VS2 (MVS) VERWNDET WERDEN.                              *
*                                                                     *
***********************************************************************
         EJECT
***********************************************************************
*                                                                     *
*      BEGINN DER VERARBEITUNG.                                       *
*                                                                     *
***********************************************************************
         SPACE 3
*
*      SICHERN DER REGISTER,
*      SPEICHERPLATZANFORDERUNG FUER ARBEITSBEREICHE,
*      ZUORDNUNG DER BASISREGISTER.
*
         SPACE 1
         XSAVE R12,,FIND,ABERL
         SPACE 1
         LR    R11,R1        BASISREG. FUER DSECT PARMAREA INITIALIS.
         USING UCB,R3        BASISREG. FUER DSECT UCB ZUORDNEN
         USING MESSAGE,R10   BASISREG. FUER DSECT MESSAGE ZUORDNEN
         USING PARMAREA,R11  BASISREG. FUER DSECT PARMAREA ZUORDNEN
         USING ABER,R13      BASISREG. FUER DSECT ABER ZUORDNEN
         EJECT
*
*      ABFRAGE DES SYSTEMS.
*
         SPACE 1
         L     R2,16         ADRESSE DER CVT LADEN
         TM    116(R2),X'01' SYSTEM = OS/VS2 (MVS) ?
         BZ    FEHLSYS       NEIN, VERZWEIGEN ZUR FEHLERROUTINE
*
*      INITIALISIERUNG DER SPEICHER.
*
         SPACE 1
         MVC   BLDLFF,=H'1'  ANZ. DER MEMBER ENTRIES FUER BLDL EINTR.
         MVC   BLDLLL,=H'14' ENTRY-LAENGE FUER BLDL EINTRAGEN
         MVI   FOUNDBIT,X'00' SCHALTER FUER GEFUNDENE MEMBER LOESCHEN
         MVI   TESTBYTE,X'00' SCHALTER FUER TEST LOESCHEN
         MVC   CAMOBT(CAMLEN),CAMCON CAMLIST-MACRO UEBERTRAGEN
         LA    R4,CCHHR      ADRESSE VON CCHHR LADEN
         ST    R4,CADRCCHH       UND SPEICHERN
         LA    R4,CAMWKFLD   ADRESSE VON CAMWKFLD LADEN
         ST    R4,CADRCAMW       UND SPEICHERN
         LA    R4,EIN        ADRESSE DES DCB LADEN
         ST    R4,DCBADDR        UND SPEICHERN
         MVI   DCBADDR,X'80' ENDE DER PARAMETERLISTE SPEZIFIZIEREN
         SPACE 2
*
*      PARAMETERLISTE FUER 'DYNALC' UEBERTRAGEN.
*
         SPACE 1
         LA    R4,DALPCON    ADRESSEN DER
         LA    R6,DALPWKS        PARAMETERLISTEN LADEN
         LA    R5,DALPLEN    LAENGE DER
         LR    R7,R5             PARAMETERLISTEN LADEN
         MVCL  R6,R4         PARAMETERLISTE UEBERTRAGEN
         LA    R4,RETCODE    ADRESSE DER RETURNCODE-BEREICHE LADEN
         LA    R5,DALTYPE    ADRESSE DES DYNALLOC-TYPS LADEN
         STM   R4,R5,ADDRRC  ADRESSEN IN DER PARAMETERLISTE SPEICHERN
         LA    R4,DALDDNAM   ADRESSE DES DDNAME LADEN
         ST    R4,ADDRDDN        UND SPEICHERN
         LA    R4,DALUNIT    ADRESSE DES EINHEITENTYPS LADEN
         STCM  R4,7,ADDRUNIT+1   UND SPEICHERN
         MVC   DALDDNAM,DCBDDNAM
         MVC   DALTYPE,=CL8'DSALLOC' DYNALLOC-TYP SPEZIFIZIEREN
         MVC   DALWAIT,=CL8' ' ERASE WAIT REQUEST INDICATOR
         EJECT
*
*      ADRESSEN-SPEICHER INITIALISIEREN.
*
         SPACE 1
         LA    R3,ENDTAB1    ADRESSE DES TABELLENENDES LADEN
         LA    R4,ENDTPVOL   ADRESSE DES TABELLENENDES LADEN
         LA    R5,PARMENDE   ADRESSE DES ENDES DES PARAMETERBER. LADEN
         STM   R3,R5,ADDRETB1 ADRESSEN SPEICHERN
         MVC   UCMID,REG4    UCM-ID. DES AUFRUFERS UEBERTRAGEN
         SPACE 2
*
*      FLAG BYTS IN NACHRICHTENBEREICHEN SETZEN.
*
         SPACE 1
         LA    R10,TABNACHR  ADRESSE DER INFORMATIONSNACHRICHTEN-
         ST    R10,SAVE1R10      TABELLE LADEN UND SPEICHERN
         LA    R10,TABNACHR-72 ADRESSE DER NACHRICHTEN-TABELLEN LADEN
CLEARMSS EQU   *
         LA    R10,72(R10)   R10 ERHOEHEN
         C     R10,ADDRETB1  TABELLENENDE ERREICHT ?
         BNL   GETSADDR      JA, VERZW. ZUR ABFRAGE DES SYSTEMS
         MVC   MESSFLAG,=X'FFFF' FLAG BYTES SETZEN
         B     CLEARMSS      VERZWEIGEN
         SPACE 2
GETSADDR EQU   *
         LOAD  EP=DYNALC               LOAD ENTRY POINT OF SUBROUTINE
         ST    R0,DYNADDR                  AND STORE IT
         EJECT
***********************************************************************
*                                                                     *
*      VERARBEITUNG DER EINGABEPARAMETER.                             *
*                                                                     *
***********************************************************************
         SPACE 3
*
*      VERARBEITUNG DES MEMBER NAME.
*
         SPACE 1
GETPARM  EQU   *
         LA    R4,TEXT+4     R4 INITIALISIEREN
         SR    R5,R5         R5 LOESCHEN
         MVC   MEMBNAME,=CL8' ' ZWISCHENSPEICHER LOESCHEN
         CLI   0(R4),C','    PARAMETER ANGEGEBEN ?
         BNE   FEHLPARM      NEIN, VERZW. ZUR FEHLERROUTINE
NXTPNAM  EQU   *
         LA    R4,1(R4)      R4 ERHOEHEN
         C     R4,ADDREPRM   PARAMETERBEREICH UEBERSCHRITTEN ?
         BNL   FEHLPARM      JA, VERZW. ZUR FEHLERROUTINE
         CLI   0(R4),C'*'    1. PARAMETER = MEMBER NAME ?
         BE    FEHLPARM      NEIN, VERZW. ZUR FEHLERROUTINE
         CLI   0(R4),C','    ENDE DES MEMBER NAME ERREICHT ?
         BE    ENDPNAM       JA, VERZWEIGEN
         CLI   0(R4),X'00'   ENDE DER PARAMETERKETTE ERREICHT ?
         BE    ENDPNAM       JA, VERZWEIGEN
         CLI   0(R4),C' '    ENDE DER PARAMETERKETTE ERREICHT ?
         BE    ENDPNAM       JA, VERZWEIGEN
         LA    R5,1(R5)      R5 ERHOEHEN
         B     NXTPNAM       VERZWEIGEN
ENDPNAM  EQU   *
         C     R5,=F'8'      LAENGE DES MEMBER NAME GUELTIG ?
         BH    FEHLPARM      NEIN, VERZW. ZUR FEHLERROUTINE
         LTR   R5,R5         MEMBER NAME ANGEGEBEN ?
         BZ    FEHLPARM      NEIN, VERZW. ZUR FEHLERROUTINE
         BCTR  R5,0          R5 UM EINS VERMINDERN
         EX    R5,MOVEPNAM   VERZW. ZUR UEBERTR. DES MEMBER NAME
         CLI   MEMBNAME,C' ' MEMBER NAME GUELTIG ?
         BE    FEHLPARM      NEIN, VERZW. ZUR FEHLERROUTINE
         EJECT
*
*      VERARBEITUNG DER VOLUME SERIAL NUMBERS.
*
         SPACE 1
         LA    R6,TABPVOL1   ADRESSE DER VOLSER-TABELLE LADEN
NXTPVOLI EQU   *
         CLI   0(R4),X'00'   ENDE DER PARAMETERKETTE ERREICHT ?
         BE    ENDPARM       JA, VERZWEIGEN
         CLI   0(R4),C' '    ENDE DER PARAMETERKETTE ERREICHT ?
         BE    ENDPARM       JA, VERZWEIGEN
         SR    R5,R5         R5 LOESCHEN
         LR    R7,R4         ADRESSE UMLADEN
NXTPVOL  EQU   *
         LA    R4,1(R4)      R4 ERHOEHEN
         C     R4,ADDREPRM   PARAMETERBEREICH UEBERSCHRITTEN ?
         BNL   FEHLPARM      JA, VERZW. ZUR FEHLERROUTINE
         CLI   0(R4),C','    ENDE DER VOLID ERREICHT ?
         BE    ENDPVOL       JA, VERZWEIGEN
         CLI   0(R4),X'00'   ENDE DER PARAMETERKETTE ERREICHT ?
         BE    ENDPVOL       JA, VERZWEIGEN
         CLI   0(R4),C' '    ENDE DER PARAMETERKETTE ERREICHT ?
         BE    ENDPVOL       JA, VERZWEIGEN
         CLI   0(R4),C'*'    BELIEBIGES ZEICHEN AN DIESER STELLE ?
         BNE   *+8           NEIN, VERZWEIGEN
         MVI   0(R4),X'FF'   ZEICHEN UMSETZEN
         LA    R5,1(R5)      R5 ERHOEHEN
         B     NXTPVOL       VERZWEIGEN
ENDPVOL  EQU   *
         C     R5,=F'4'      LAENGE DES PARAMETERS = 4 ?
         BNE   *+22          NEIN, VERZWEIGEN
         CLC   1(4,R7),=C'TEST' PARAMETER = TEST ?
         BNE   *+12          NEIN, VERZWEIGEN
         MVI   TESTBYTE,X'FF' FLAG BYTE SETZEN
         B     NXTPVOLI      VERZWEIGEN
         C     R5,=F'6'      LAENGE DER VOLID GUELTIG ?
         BH    FEHLPARM      NEIN, VERZW. ZUR FEHLERROUTINE
         LTR   R5,R5         VOLID ANGEGEBEN ?
         BZ    ALLVOL        NEIN, VERZWEIGEN
         BCTR  R5,0          R5 UM EINS VERMINDERN
         EX    R5,MOVEPVOL   VERZW. ZUR UEBERTR. DER VOLSER NUMBER
         STC   R5,0(R6)      LAENGENANGABE IN TABELLE EINTRAGEN
         LA    R6,7(R6)      R6 ERHOEHEN
         C     R6,ADDRETPV   ENDE DER VOLSER-TABELLE ERREICHT ?
         BNL   ENDPARM       JA, VERZWEIGEN
         B     NXTPVOLI      VERZWEIGEN
ALLVOL   EQU   *
         LA    R6,TABPVOL1   ADRESSE DER VOLSER-TABELLE LADEN
         EJECT
ENDPARM  EQU   *
         MVI   0(R6),X'80'   TABELLENENDE SPEZIFIZIEREN
         MVC   TABPVOL2,TABPVOL1 VOLSER-TABELLE KOPIEREN
         LA    R6,TABPVOL2-1 ADRESSE DER VOLSER-TABELLE LADEN
NXTBYTE  EQU   *
         LA    R6,1(R6)      R6 ERHOEHEN
         CLI   0(R6),X'80'   ENDE DER TABELLE ERREICHT ?
         BE    GETUCB        JA, VERZWEIGEN
         CLI   0(R6),X'FF'   ZEICHEN IN DER TABELLE = X'FF' ?
         BNE   NXTBYTE       NEIN, VERZWEIGEN
         MVI   0(R6),X'00'   ZEICHEN UMSETZEN
         B     NXTBYTE       VERZWEIGEN
         EJECT
***********************************************************************
*                                                                     *
*      VERARBEITUNG DES UCB-VEKTORS.                                  *
*                                                                     *
***********************************************************************
         SPACE 3
GETUCB   EQU   *
         DROP  R11           R11 FREIGEBEN
         GETMAIN R,LV=VEKLEN,SP=125
         LR    R11,R1        BASISREG. FUER DSECT VEKTOR INIT.
         USING VEKTOR,R11    BASISREG. FUER DSECT VEKTOR ZUORDNEN
         ST    R11,UCBADDR   VEKTOR-ADRESSE SPEICHERN
         MVI   UCBADDR,X'80' OPTION BYTE SETZEN
         LA    R1,UCBADDR    ADRESSE DER VEKTOR-ADRESSE LADEN
         LINK  EP=GETUCBS              LINK TO SUBROUTINE
         LA    R2,VEKTOR     ADRESSE DES VEKTORS LADEN
         BCTR  R2,0          R2 UM EINS VERMINDERN
         BCTR  R2,0          R2 UM EINS VERMINDERN
         SR    R3,R3         R3 LOESCHEN
         MVC   VEKEND,=X'FFFF' VEKTOR-ENDE SPEZIFIZIEREN
         EJECT
***********************************************************************
*                                                                     *
*      VERARBEITUNG DER UCB-INFORMATIONEN.                            *
*                                                                     *
***********************************************************************
         SPACE 3
NEXTUCB  EQU   *
         LA    R2,2(R2)      R2 ERHOEHEN
         CLC   0(2,R2),=X'FFFF' ENDE DES VEKTORS ERREICHT ?
         BE    ABSCHLUS      JA, VERZW. ZUM ABSCHLUSS DER VERARBEITUNG
         ICM   R3,3,0(R2)    ADRESSE DES UCB LADEN
         CLI   UCBDVCLS,X'20' DEVICE = DASD ?
         BNE   NEXTUCB       NEIN, VERZWEIGEN
         TM    DEVSTAT,X'80' EINHEIT ONLINE ?
         BZ    NEXTUCB       NEIN, VERZWEIGEN
         TM    DEVSTAT,X'10' EINHEIT IM UNLOAD ?
         BO    NEXTUCB       JA, VERZWEIGEN
         CLC   UCBVOLI,=XL6'0' VOLID VORHANDEN ?
         BE    NEXTUCB       NEIN, VERZWEIGEN
         TM    UCB+17,X'08'           VIRTUAL DEVICE ?
         BO    TSTVVOL                BRANCH IF YES
         SR    R5,R5         R5 LOESCHEN
         TM    TABPVOL1,X'80'          TABLES FILLED ?
         BO    MVCVOLID                BRANCH IF NOT
         LA    R6,TABPVOL1-7 ADRESSE DER VOLSER-TABELLE LADEN
         LA    R7,TABPVOL2-7 ADRESSE DER VOLSER-TABELLE LADEN
NXTVOLID EQU   *
         LA    R6,7(R6)      R6 ERHOEHEN
         LA    R7,7(R7)      R7 ERHOEHEN
         TM    0(R6),X'80'   TABELLENENDE ERREICHT ?
         BO    NEXTUCB       JA, VERZWEIGEN
         IC    R5,0(R6)      LAENGENANGABE LADEN
         MVC   ZWVOLID1,UCBVOLI VOLSER NUMBER UEBERTRAGEN
         MVC   ZWVOLID2,UCBVOLI VOLSER NUMBER UEBERTRAGEN
         EX    R5,NCVOLID1   VERZW. ZUR UEBERLAGERUNG DER VOLID
         EX    R5,OCVOLID2   VERZW. ZUR UEBERLAGERUNG DER VOLID
         CLC   ZWVOLID1,ZWVOLID2 VOLID = AUSGEW. VOLID ?
         BNE   NXTVOLID      VERZW., WENN VOLID ^= AUSGEW. VOLID
         B     MVCVOLID
         SPACE 2
TSTVVOL  EQU   *
         LA    R6,TABPVOL1-7 ADRESSE DER VOLSER-TABELLE LADEN
NXTVVOL  EQU   *
         LA    R6,7(R6)      R6 ERHOEHEN
         TM    0(R6),X'80'   TABELLENENDE ERREICHT ?
         BO    NEXTUCB       JA, VERZWEIGEN
         CLC   UCBVOLI,1(R6) VOLID = AUSGEW. VOLID ?
         BNE   NXTVVOL       VERZW., WENN VOLID ^= AUSGEW. VOLID
MVCVOLID EQU   *
         LA    R4,UCBVOLI    ADRESSE DER
         ST    R4,ADDRVOLS       VOLSER NUMBER LADEN UND
         ST    R4,CADRUCBV       SPEICHERN
         EJECT
***********************************************************************
*                                                                     *
*      CCHHR DER VTOC BERECHNEN.                                      *
*                                                                     *
***********************************************************************
         SPACE 3
         SR    R4,R4         R4 LOESCHEN
         IC    R4,DEVCODE    DEVICE CODE LADEN
         SLA   R4,2          DEVICE CODE * 4
         LA    R5,TABTCAP    ADRESSE DER TABTCAP-TABELLE LADEN
         AR    R5,R4         ADRESSE DES TABELLENELEMENTS
         CLI   0(R5),X'80'   DEVICE RESERVED ?
         BE    FEHLDEVC      JA, VERZW. ZUR FEHLERROUTINE
         LH    R6,UCBVTOC    REL. ADRESSE DER VTOC LADEN
         SRDA  R6,32         R6 --> R7
         D     R6,0(R5)      DIV. TT / SPECIFIC TRACKS/CYLINDER
         STH   R7,CCHHR      CC-ADRESSE DER VTOC SPEICHERN
         STH   R6,CCHHR+2    HH-ADRESSE DER VTOC SPEICHERN
         MVI   CCHHR+4,X'01' R-ADRESSE DER VTOC
         SR    R5,R5         R5 LOESCHEN
         IC    R5,UCBVTOC+2  R-ADRESSE DER VTOC LADEN
         STH   R5,LFDRECNO   LAUFENDE SATZNUMMER SPEICHERN
         STH   R6,LFDTRKNO   LAUFENDE SPURNUMMER SPEICHERN
         STH   R7,LFDCYLNO   LAUFENDE ZYLINDERNUMMER SPEICHERN
         LA    R5,TABUNIT    ADRESSE DER EINHEITENTYPEN-TABELLE LADEN
         AR    R5,R4
         MVC   DALUNIT,=CL8' ' ZWISCHENSPEICHER LOESCHEN
         MVC   DALUNIT(4),0(R5) EINHEITENTYP UEBERTRAGEN
         EJECT
***********************************************************************
*                                                                     *
*      DSCB4 LESEN UND AUSWERTEN.                                     *
*                                                                     *
***********************************************************************
         SPACE 3
         OBTAIN CAMOBT       DSCB LESEN
         LTR   R15,R15       RC = 0 ?
         BNZ   FEHLOBT       NEIN, VERZW. ZUR FEHLERROUTINE
         CLI   DS4FMTID,X'F4' 1. DSCB = DSCB4 ?
         BNE   FEHLDSCB      NEIN, VERZW. ZUR FEHLERROUTINE
         MVC   MTRKNO,DS4DEVSZ+2 MAX.SPURADRESSE SPEICHERN
         MVI   MRECNO,X'00'
         MVC   MRECNO+1(1),DS4DEVT MAX. SATZADRESSE SPEICHERN
         MVC   MDS1ADDR(4),DS4HPCR HOECHSTE ADRESSE
         MVI   MDS1R,X'00'             VON DSCB1
         MVC   MDS1R+1(1),DS4HPCR+4    SPEICHERN
         EJECT
***********************************************************************
*                                                                     *
*      DSCB1 LESEN UND AUSWERTEN,                                     *
*      AUFRUF DES UNTERPROGRAMMS 'DYNALC'.                            *
*                                                                     *
***********************************************************************
         SPACE 3
NXTDSCB  EQU   *
         LH    R4,LFDRECNO   LAUFENDE SATZNUMMER LADEN
         LA    R4,1(R4)      R4 ERHOEHEN
         CH    R4,MRECNO     SPUR UEBERSCHRITTEN ?
         BNH   NXTREC        NEIN, VERZWEIGEN
         LH    R4,LFDTRKNO   LAUFENDE SPURNUMMER LADEN
         LA    R4,1(R4)      R4 ERHOEHEN
         CH    R4,MTRKNO     ZYLINDER UEBERSCHRITTEN ?
         BL    NXTTRK        NEIN, VERZWEIGEN
         LH    R4,LFDCYLNO   LAUFENDE ZYLINDERNUMMER LADEN
         LA    R4,1(R4)      R4 ERHOEHEN
         STH   R4,LFDCYLNO   NEUE ZYLINDERNUMMER
         STH   R4,CCHHR      SPEICHERN
         SR    R4,R4         R4 LOESCHEN
NXTTRK   EQU   *
         STH   R4,LFDTRKNO   NEUE SPURADRESSE
         STH   R4,CCHHR+2        SPEICHERN
         LA    R4,1          R4 = 1
NXTREC   EQU   *
         STH   R4,LFDRECNO   NEUE SATZADRESSE
         STC   R4,CCHHR+4        SPEICHERN
         CLC   LFDADDR(6),MDS1ADDR ENDE DER DSCB1 ERREICHT ?
         BH    NEXTUCB       JA, VERZW. ZUM LESEN DES NAECHSTEN UCB
         OBTAIN CAMOBT       NAECHSTEN DSCB LESEN
         LTR   R15,R15       RC = 0 ?
         BNZ   FEHLOBT       NEIN, VERZW. ZUR FEHLERROUTINE
         CLI   DS1FMTID,C'1' DSCB = DSCB1 ?
         BNE   NXTDSCB       NEIN, VERZW. ZUM LESEN DES NAECHSTEN DSCB
         TM    DS1DSORG,X'02' DATA SET PARTITIONED ?
         BZ    NXTDSCB       NEIN, VERZW. ZUM LESEN DES NAECHSTEN DSCB
         LA    R5,DS1DSNAM   ADRESSE DES DSNAME LADEN
         ST    R5,ADDRDSN        UND SPEICHERN
DYNALLOC EQU   *
         MVC   DALDDNAM,=CL8' ' DDNAME LOESCHEN
         LA    R1,DALPWKS    ADR. DER PARAMETERLISTE F. 'DYNALC' LADEN
         L     R15,DYNADDR   ADRESSE DES UNTERPROGRAMMS 'DYNALC' LADEN
         BALR  R14,R15       VERZW. ZUM UNTERPROGRAMM 'DYNALC'
*                            (DATA SET NAME ALLOCATION)
         L     R15,SAVE1R15  RC LADEN
         LTR   R15,R15       RC = 0 ?
         BNZ   FEHLDYNA      NEIN, VERZW. ZUR FEHLERROUTINE
         MVC   EIN(DCBLEN),EINCONST DCB UEBERTRAGEN
         MVC   DCBDDNAM,DALDDNAM DDNAME UEBERTRAGEN
         EJECT
***********************************************************************
*                                                                     *
*      MEMBER NAME IN DER DIRECTORY AUFSUCHEN.                        *
*                                                                     *
***********************************************************************
         SPACE 3
         LA    R1,DCBADDR    ADRESSE DER PARAMETERLISTE LADEN
         SVC   19            DATEI EROEFFNEN
         TM    DCBOFLGS,X'10' DATEI EROEFFNET ?
         BZ    FEHLOPEN      NEIN, VERZW. ZUR FEHLERROUTINE
         SPACE 1
         BLDL  EIN,BLDLLIST  ENTRY LIST FUELLEN
         ST    R15,SAVE1R15  RC SPEICHERN
         SPACE 1
         LA    R1,DCBADDR    ADRESSE DER PARAMETERLISTE LADEN
         SVC   20            DATEI SCHLIESSEN
         SPACE 1
         L     R15,SAVE1R15  BLDL-RC LADEN
         LTR   R15,R15       RC = 0 ?
         BZ    NXTMESS       JA, VERZW. ZUR NACHRICHTENROUTINE
         C     R15,=F'8'     RC = 8 ?
         BE    FEHLBLDL      JA, VERZW. ZUR FEHLERROUTINE
         B     NXTDSCB       VERZW. ZUM LESEN DES NAECHSTEN DSCB
         EJECT
***********************************************************************
*                                                                     *
*      AUFBEREITEN DER INFORMATIONSNACHRICHT.                         *
*                                                                     *
***********************************************************************
         SPACE 3
NXTMESS  EQU   *
         L     R10,SAVE1R10  R10 INITIALISIEREN
         MVC   MESSFLAG,=XL6'0' FLAG BYTES LOESCHEN
         MVC   MESSAGE(LENMSG03),MSG03 NACHRICHTENZEILE UEBERTRAGEN
         MVC   MS3DSN,DS1DSNAM DSNAME UEBERTRAGEN
         MVC   MS3VOLS,UCBVOLI VOLSER NUMBER UEBERTRAGEN
         MVC   MS3UNIT,UCBNAME UNIT NAME UEBERTRAGEN
         UNPK  MS3TTR(7),BLDLTTR(4) TTR DES MEMBER UEBERTRAGEN
         TR    MS3TTR,TABHEXA-240 TTR AUFBEREITEN
         LA    R9,MS3INFO    ADRESSE DES INFORMATIONS-FELDES LADEN
         TM    DS1RECFM,X'C0' RECFM = U ?
         BNO   *+12          NEIN, VERZWEIGEN
         MVI   0(R9),C'U'    RECFM = U SPEZIFIZIEREN
         B     RECFMBLK      VERZWEIGEN
         TM    DS1RECFM,X'80' RECFM = F ?
         BNO   *+12          NEIN, VERZWEIGEN
         MVI   0(R9),C'F'    RECFM = F SPEZIFIZIEREN
         B     RECFMBLK      VERZWEIGEN
         MVI   0(R9),C'V'    RECFM = V SPEZIFIZIEREN
RECFMBLK EQU   *
         LA    R9,1(R9)      R9 ERHOEHEN
         TM    DS1RECFM,X'10' RECFM = BLOCKED ?
         BZ    *+12          NEIN, VERZWEIGEN
         MVI   0(R9),C'B'    RECFM = BLOCKED SPEZIFIZIEREN
         LA    R9,1(R9)      R9 ERHOEHEN
         TM    DS1RECFM,X'08' SPANNED, STANDARD ?
         BZ    *+12          NEIN, VERZWEIGEN
         MVI   0(R9),C'S'    SPANNED, STANDARD SPEZIFIZIEREN
         LA    R9,1(R9)      R9 ERHOEHEN
         TM    DS1RECFM,X'06' CONTROL CARACTER ?
         BZ    NOCONTC       NEIN, VERZWEIGEN
         TM    DS1RECFM,X'04' CONTROL CARACTER = A ?
         BZ    *+12          NEIN, VERZWEIGEN
         MVI   0(R9),C'A'    CONTROL CARACTER = A SPEZIFIZIEREN
         B     *+8           VERZWEIGEN
         MVI   0(R9),C'M'    CONTROL CARACTER = M SPEZIFIZIEREN
         LA    R9,1(R9)      R9 ERHOEHEN
         EJECT
NOCONTC  EQU   *
         MVI   0(R9),C','    KOMMA EINTRAGEN
         SR    R8,R8         R8 LOESCHEN
         ICM   R8,3,DS1BLKL  BLOCKLAENGE LADEN
         BAL   R14,CONVLEN   VERZW. ZUR UMWANDLUNG DER BLOCKLAENGE
         MVI   0(R9),C','    KOMMA EINTRAGEN
         CLI   MS3INFO,C'U'  RECFM = U ?
         BNE   *+12          NEIN, VERZWEIGEN
         MVI   1(R9),C'*'    RECL = 0 SPEZIFIZIEREN
         B     *+12          VERZWEIGEN
         ICM   R8,3,DS1RECL  SATZLAENGE LADEN
         BAL   R14,CONVLEN   VERZW. ZUR UMWANDLUNG DER SATZLAENGE
         LA    R14,NXTDSCB   RUECKSPRUNGADRESSE LADEN
         LA    R10,72(R10)   R10 ERHOEHEN
         C     R10,ADDRETB1  TABELLENENDE ERREICHT ?
         BNL   WTONACHR      JA, VERZW. ZUR AUSGABE DER NACHRICHTEN
         ST    R10,SAVE1R10  LAUFENDE ADRESSE SPEICHERN
         B     NXTDSCB       VERZW. ZUR VERARB. DES NAECHSTEN DSCB
         SPACE 2
*
*      BLOCK- UND SATZLAENGEN IN DEZIMALZAHLEN UMWANDELN.
*
         SPACE 1
CONVLEN  EQU   *
         CVD   R8,DBWORD     LAENGE UMWANDELD
         UNPK  ZWFELD,DBWORD DEZIMALZAHL ENTPACKEN
         OI    ZWFELD+14,C'0' VORZEICHEN MODIFIZIEREN
         LA    R6,ZWFELD-1   ADRESSE VON ZWFELD LADEN
         LA    R7,ZWFELD+14  ADRESSE DES LETZTEN BYTES LADEN
CONVSCHL EQU   *
         LA    R6,1(R6)      R6 ERHOEHEN
         CR    R6,R7         ZWFELD UEBERSCHRITTEN ?
         BNL   LENOK         JA, VERZWEIGEN
         CLI   0(R6),C'0'    FUEHRENDE NULL ?
         BE    CONVSCHL      JA, VERZWEIGEN
LENOK    EQU   *
         SR    R7,R6         NEIN, LAENGE DER ZAHL FESTSTELLEN
         EX    R7,MOVELEN    VERZW. ZUR UEBERTR. DER LAENGE
         AR    R9,R7         R9 ERHOEHEN
         LA    R9,2(R9)      R9 ERHOEHEN
         BR    R14           VERZWEIGEN
         EJECT
***********************************************************************
*                                                                     *
*      ABSCHLUSSROUTINEN.                                             *
*                                                                     *
***********************************************************************
         SPACE 3
ABSCHLUS EQU   *
         FREEMAIN R,SP=125   SPEICHERPLATZ FREIGEBEN
         LA    R10,TABNACHR  ADRESSE DER NACHRICHTEN-TABELLE LADEN
         CLC   MESSFLAG,=XL6'0' SIND NOCH NACHRICHTEN OFFEN ?
         BNE   *+8           NEIN, VERZWEIGEN
         BAL   R14,WTONACHR  VERZW. ZUR AUSGABE DER NACHRICHTEN
         TM    FOUNDBIT,X'80' MEMBER GEFUNDEN ?
         BO    ENDE          JA, VERZWEIGEN
         MVC   MESSAGE(LENMSG04),MSG04 MSG04 UEBERTRAGEN
         MVC   MS1NAME,MEMBNAME MEMBER NAME UEBERTRAGEN
         L     R0,UCMID      UCM-ID. DES AUFRUFERS LADEN
         WTO   MF=(E,MESSAGE) NACHRICHT AUSGEBEN
         SPACE 1
ENDE     EQU   *
         XRETURN ,R
         EJECT
***********************************************************************
*                                                                     *
*      NACHRICHTENAUSGABE.                                            *
*                                                                     *
***********************************************************************
         SPACE 3
WTONACHR EQU   *
         ST    R14,SAVE1R14  RUECKSPRUNGADRESSE SPEICHERN
         LA    R10,MSG01ZW   ADRESSE DER NACHRICHTENZEILE SPEICHERN
         MVC   MSG01ZW(LENMSG01),MSG01 NACHRICHTENZEILE UEBERTRAGEN
         MVC   MS1NAME,MEMBNAME MEMBER NAME UEBERTRAGEN
         L     R0,UCMID      UCM-ID. DES AUFRUFERS LADEN
         WTO   MF=(E,MSG01ZW) NACHRICHT AUSGEBEN
         L     R0,UCMID      UCM-ID. DES AUFRUFERS LADEN
         WTO   MF=(E,MSG02)  NACHRICHT AUSGEBEN
         LA    R10,TABNACHR-72 ADRESSE DER NACHRICHTEN-TAB. LADEN
NXTINMSS EQU   *
         LA    R10,72(R10)   R10 ERHOEHEN
         C     R10,ADDRETB1  TABELLENENDE ERREICHT ?
         BNL   RETINMSS      JA, VERZWEIGEN
         CLC   MESSFLAG,=X'FFFF' FLAG BYTES GESETZT ?
         BE    RETINMSS      JA, VERZWEIGEN
         MVC   MESSFLAG,=X'FFFF' FLAG BYTES SETZEN
         L     R0,UCMID      UCM-ID. DES AUFRUFERS LADEN
         WTO   MF=(E,MESSAGE) NACHRICHT AUSGEBEN
         B     NXTINMSS      VERZWEIGEN
RETINMSS EQU   *
         LA    R10,TABNACHR  ADRESSE DER NACHRICHTEN-TAB. LADEN
         ST    R10,SAVE1R10      UND SPEICHERN
         MVI   FOUNDBIT,X'80' BIT FUER GEFUNDENES MEMBER SETZEN
         L     R14,SAVE1R14  RUECKSPRUNGADRESSE LADEN
         BR    R14           VERZWEIGEN
         EJECT
***********************************************************************
*                                                                     *
*      FEHLERROUTINEN.                                                *
*                                                                     *
***********************************************************************
         SPACE 3
*
*      ROUTINE BEI UNGUELTIGEM SYSTEM.
*
         SPACE 1
FEHLSYS  EQU   *
         L     R0,UCMID      UCM-ID. DES AUFRUFERS LADEN
         WTO   MF=(E,MSG05)  NACHRICHT AUSGEBEN
         B     ENDE          VERZWEIGEN
         SPACE 2
*
*      ROUTINE BEI FEHLER IN DER PARAMETERKETTE.
*
         SPACE 1
FEHLPARM EQU   *
         L     R0,UCMID      UCM-ID. DES AUFRUFERS LADEN
         WTO   MF=(E,MSG06)
         B     ENDE          VERZWEIGEN
         SPACE 2
*
*      ROUTINE BEI DYNALC-FEHLER (RC ^= 0).
*
         SPACE 1
FEHLDYNA EQU   *
         LA    R10,TABFNACH  R10 INITIALISIEREN
         MVC   MESSAGE(LENMSG07),MSG07 MSG07 UEBERTRAGEN
         MVC   MS7VOLS,UCBVOLI VOLSER NUMBER UEBERTRAGEN
         MVC   MS7DSN,DS1DSNAM DSNAME UEBERTRAGEN
         LA    R14,NXTDSCB   RUECKSPRUNGADRESSE LADEN
         B     RETFEHL       VERZW. ZUM AUSGANG DER FEHLERROUTINEN
         EJECT
*
*      ROUTINE BEI BLDL-FEHLER (RC = 8).
*
         SPACE 1
FEHLBLDL EQU   *
         LA    R10,TABFNACH  R10 INITIALISIEREN
         MVC   MESSAGE(LENMSG08),MSG08 MSG08 UEBERTRAGEN
         MVC   MS8DSN,DS1DSNAM DSNAME UEBERTRAGEN
         MVC   MS8VOLS,UCBVOLI VOLSER NUMBER UEBERTRAGEN
         LA    R14,NXTDSCB   RUECKSPRUNGADRESSE LADEN
         B     RETFEHL       VERZW. ZUM AUSGANG DER FEHLERROUTINEN
         SPACE 2
*
*      ROUTINE BEI OBTAIN-FEHLER (RC ^= 0).
*
         SPACE 1
FEHLOBT  EQU   *
         LA    R10,TABFNACH  R10 INITIALISIEREN
         MVC   MESSAGE(LENMSG09),MSG09 MSG09 UEBERTRAGEN
         MVC   MS9VOLS,UCBVOLI VOLSER NUMBER UEBERTRAGEN
         ST    R15,SAVE1R15  RC SPEICHERN
         UNPK  MS9RC(3),SAVE1R15+3(2) RC UEBERTRAGEN
         MVI   MS9RC+2,C','
         TR    MS9RC,TABHEXA-240 RC AUFBEREITEN
         LA    R14,NXTDSCB   RUECKSPRUNGADRESSE LADEN
         B     RETFEHL       VERZW. ZUM AUSGANG DER FEHLERROUTINEN
         EJECT
*
*      ROUTINE BEI DSCB-FEHLER (1. DSCB NICHT FORMAT 4).
*
         SPACE 1
FEHLDSCB EQU   *
         LA    R10,TABFNACH  R10 INITIALISIEREN
         MVC   MESSAGE(LENMSG10),MSG010 NACHRICHTENZEILE UEBERTRAGEN
         MVC   MS10VOLS,UCBVOLI VOLSER NUMBER UEBERTRAGEN
         LA    R14,NEXTUCB   RUECKSPRUNGADRESSE LADEN
         B     RETFEHL       VERZWEIGEN
         SPACE 2
*
*      ROUTINE BEI RESERVED DEVICES.
*
         SPACE 1
FEHLDEVC EQU   *
         LA    R10,TABFNACH  R10 INITIALISIEREN
         MVC   MESSAGE(LENMSG11),MSG011 NACHRICHTENZEILE UEBERTRAGEN
         UNPK  MS11DEVC(3),DEVCODE(2) DEVICE CODE UEBERTRAGEN
         TR    MS11DEVC,TABHEXA-240 DEVICE CODE AUFBEREITEN
         LA    R14,NEXTUCB   RUECKSPRUNGADRESSE LADEN
         B     RETFEHL       VERZWEIGEN
         EJECT
*
*      ROUTINE BEI OPEN-FEHLER.
*
         SPACE 1
FEHLOPEN EQU   *
         LA    R10,TABFNACH  R10 INITIALISIEREN
         MVC   MESSAGE(LENMSG12),MSG012 NACHRICHTENZEILE UEBERTRAGEN
         MVC   MS8DSN,DS1DSNAM DSNAME UEBERTRAGEN
         MVC   MS8VOLS,UCBVOLI VOLSER NUMBER UEBERTRAGEN
         LA    R14,RETFOPEN  RUECKSPRUNGADRESSE LADEN
         LA    R10,72(R10)   R10 ERHOEHEN
         B     RETFEHL       VERZWEIGEN
RETFOPEN EQU   *
         MVC   DALTYPE,=CL8'UNALLOC' DYNALLOC-TYP SPEZIFIZIEREN
         OI    ADDRDSN,X'80' ENDE DER PARAMETERKETTE SPEZIFIZIEREN
         LA    R1,DALPWKS    ADR. DER PARAMETERKETTE F. 'DYNALC' LADEN
         L     R15,DYNADDR   ADRESSE DES UNTERPROGRAMMS 'DYNALC' LADEN
         BALR  R14,R15       VERZW. ZUM UNTERPROGRAMM 'DYNALC'
*                            (DYNAMIC UNALLOCATION)
         NI    ADDRDSN,X'7F' ENDE DER PARAMETERKETTE ZURUECKSETZEN
         MVC   DALTYPE,=CL8'DSALLOC' DYNALLOC-TYP NEU SPEZIFIZIEREN
         L     R15,SAVE1R15  RC LADEN
         LTR   R15,R15       RC = 0 ?
         BNZ   FEHLDYNA      NEIN, VERZW. ZUR FEHLERROUTINE
         SPACE 2
*
*      AUSGANG DER FEHLERROUTINEN.
*
         SPACE 1
RETFEHL  EQU   *
         CLI   TESTBYTE,X'FF' FLAG BYTE GESETZT ?
         BNER  R14           NEIN, VERZWEIGEN
         L     R0,UCMID      UCM-ID. DES AUFRUFERS LADEN
         WTO   MF=(E,MESSAGE) NACHRICHTENZEILE AUSGEBEN
         BR    R14           VERZWEIGEN
         EJECT
***********************************************************************
*                                                                     *
*      BEFEHLE, DIE MIT HILFE DES EXECUTE-BEFEHLS AUSGEFUEHRT WERDEN. *
*                                                                     *
***********************************************************************
         SPACE 3
MOVEPNAM EQU   *
         MVC   MEMBNAME(0),9(R11) MEMBER NAME UEBERTRAGEN
MOVEPVOL EQU   *
         MVC   1(0,R6),1(R7) VOLID IN TABELLE UEBERTRAGEN
NCVOLID1 EQU   *
         NC    ZWVOLID1(0),1(R6) VOLID UEBERLAGERN
OCVOLID2 EQU   *
         OC    ZWVOLID2(0),1(R7) VOLID UEBERLAGERN
MOVELEN  EQU   *
         MVC   1(0,R9),0(R6) LAENGE UEBERTRAGEN
         SPACE 3
***********************************************************************
*                                                                     *
*      REGISTER EQUATES.                                              *
*                                                                     *
***********************************************************************
         SPACE 3
R0       EQU   0             MACRO- UND-PARAMETER REGISTER
R1       EQU   1             MACRO- UND-PARAMETER REGISTER
R2       EQU   2             POINTER IN CVT / UCB LOOKUP TABLE
R3       EQU   3             POINTER FUER UCB
R4       EQU   4             ARBEITSREGISTER
R5       EQU   5             ARBEITSREGISTER
R6       EQU   6             ARBEITSREGISTER
R7       EQU   7             ARBEITSREGISTER
R8       EQU   8             ARBEITSREGISTER
R9       EQU   9             ARBEITSREGISTER
R10      EQU   10            POINTER IN NACHRICHTEN-TABELLEN
R11      EQU   11            BASISREG. FUER DSECT PARMAREA / VEKTOR
R12      EQU   12            BASISREG. FUER CSECT FIND
R13      EQU   13            BASISREG. FUER DSECT ABER
R14      EQU   14            RUECKSPRUNGADRESSEN
R15      EQU   15            CSECT-ADRESSEN UND RETURN CODES
         EJECT
***********************************************************************
*                                                                     *
*      DEFINITION DER KONSTANTEN-SPEICHER.                            *
*                                                                     *
***********************************************************************
         SPACE 3
*
*      PARAMETERLISTE FUER 'DYNALC' (KONSTANTEN).
*
         SPACE 1
DALPCON  DS    0F
         DC    A(0)          ADRESSE VON RETCODE
         DC    A(0)          ADRESSE DES DYNALLOC-TYPS
         DC    A(0)          ADRESSE DES DDNAME
         DC    A(0)          ADRESSE DES DSNAME
         DC    A(0)
         DC    A(DALSTATS)   ADRESSE DES DS STATUS
         DC    A(DALNDISP)   ADRESSE DER DS NORM. DISPOSITION
         DC    A(DALCDISP)   ADRESSE DER DS COND. DISPOSITION
         DC    7A(0)
         DC    A(0)          ADRESSE DER VOLSER NUMBER
         DC    4A(0)
         DC    X'80'         ENDE DER PARAMETERKETTE
         DC    AL3(0)        ADRESSE DER UNIT SPECIFICATION
DALPLEN  EQU   *-DALPCON     LAENGE DER PARAMETERLISTE
DALSTATS DC    C'SHR'        DATA SET STATUS
DALNDISP DC    CL7'KEEP'     DATA SET NORMAL DISPOSITION
DALCDISP DC    CL7'KEEP'     DATA SET CONDITIONAL DISPOSITION
         SPACE 2
*
*      CAMLIST-MACRO (KONSTANTEN).
*
         SPACE 1
CAMCON   CAMLST SEEK,0,0,0
CAMLEN   EQU   *-CAMCON      LAENGE DES CAMLIST-MACROS
         EJECT
*
*      TABELLE FUER AUFBEREITUNG VON HEXADEZIMALZAHLEN.
*
         SPACE 1
TABHEXA  DC    C'0123456789ABCDEF'
         SPACE 2
*
*      DCB-DEFINITION FUER DIE EINGABEDATEI.
*
         SPACE 1
EINCONST DCB   DDNAME=EIN00000,DSORG=PO,MACRF=(R)
DCBLEN   EQU   *-EINCONST    LAENGE DES DCB
         EJECT
***********************************************************************
*                                                                     *
*      TABELLEN FUER EINHEITENTYPEN UND KAPAZITAETEN.                 *
*                                                                     *
*      DEVICE CODES:                                                  *
*      01 - 2311    DISK STORAGE DEVICE                               *
*      02 - 2301    PARALLEL DRUM                                     *
*      03 - 2303    SERIAL DRUM                                       *
*      04 - 2302    DISK STORAGE                                      *
*      05 - 2321    DATA CELL DRIVE                                   *
*      06 - 2305/1  FIXED HEAD STORAGE / MODEL 1                      *
*      07 - 2305/2  FIXED HEAD STORAGE / MODEL 2                      *
*      08 - 2314    DISK STORAGE FACILITY                             *
*      09 - 3330/1  DISK STORAGE / MODEL 1                            *
*      0A - 3340    DISK STORAGE                                      *
*      0B - 3350    DISK STORAGE                                      *
*      0C - RESERVED                                                  *
*      0D - 3330/11 DISK STORAGE / MODEL 11                           *
*      0E - RESERVED                                                  *
*      0F - RESERVED                                                  *
*                                                                     *
***********************************************************************
         SPACE 3
*
*      EINHEITENTYPEN.
*
         SPACE 1
TABUNIT  EQU   *
         DC    C'    '
         DC    C'2311'       01
         DC    C'2301'       02
         DC    C'2303'       03
         DC    C'2302'       04
         DC    C'2321'       05
         DC    C'2305'       06
         DC    C'2305'       07
         DC    C'2314'       08
         DC    C'3330'       09
         DC    C'3340'       0A
         DC    C'3350'       0B
         DC    C'    '       0C
         DC    C'3330'       0D
         DC    C'    '       0E
         DC    C'    '       0F
         EJECT
*
*      TRACKS / CYLINDER.
*
         SPACE 1
TABTCAP  DS    0F
         DC    X'80',XL3'0'  00
         DC    F'10'         01
         DC    F'08'         02
         DC    F'10'         03
         DC    F'46'         04
         DC    F'20'         05
         DC    F'08'         06
         DC    F'08'         07
         DC    F'20'         08
         DC    F'19'         09
         DC    F'12'         0A
         DC    F'30'         0B
         DC    X'80',XL3'0'  0C
         DC    F'19'         0D
         DC    X'80',XL3'0'  0E
         DC    X'80',XL3'0'  0F
         EJECT
***********************************************************************
*                                                                     *
*      DEFINITION DER AUSGABENACHRICHTEN.                             *
*                                                                     *
***********************************************************************
         SPACE 3
MSG01    WTO   'XFIND01 MEMBER 12345678 FOUND IN:',                    *
               MF=L,MCSFLAG=(REG0)
LENMSG01 EQU   *-MSG01
         SPACE 1
MSG02    WTO   'XFIND02 -----DSNAME------ VOLSER UNIT DSCB1-INFORMATION*
                -TTR--',                                               *
               MF=L,MCSFLAG=(REG0)
LENMSG02 EQU   *-MSG02
         SPACE 1
MSG03    WTO   'XFIND03                   123456 123                   *
                123456',                                               *
               MF=L,MCSFLAG=(REG0)
LENMSG03 EQU   *-MSG03
         SPACE 1
MSG04    WTO   'XFIND04 MEMBER 12345678 NOT FOUND',                    *
               MF=L,MCSFLAG=(REG0)
LENMSG04 EQU   *-MSG04
         EJECT
MSG05    WTO   'XFIND05 FUNCTION SUPPORTED FOR OS/VS2 (MVS) ONLY',     *
               MF=L,MCSFLAG=(REG0)
LENMSG05 EQU   *-MSG05
         SPACE 1
MSG06    WTO   'XFIND06 ERROR IN PARAMETER LIST',                      *
               MF=L,MCSFLAG=(REG0)
LENMSG06 EQU   *-MSG06
         SPACE 1
MSG07    WTO   'XFIND07 VOLSER=123456,DSN=12345678901234567 ALLOCATION *
               FAILURE',                                               *
               MF=L,MCSFLAG=(REG0)
LENMSG07 EQU   *-MSG07
         SPACE 1
MSG08    WTO   'XFIND08 VOLSER=123456,DSN=12345678901234567890123 BLDL *
               FAILURE',                                               *
               MF=L,MCSFLAG=(REG0)
LENMSG08 EQU   *-MSG08
         EJECT
MSG09    WTO   'XFIND09 ERROR DURING EXECUTING OBTAIN, RC=99, VOLSER=12*
               3456',                                                  *
               MF=L,MCSFLAG=(REG0)
LENMSG09 EQU   *-MSG09
         SPACE 1
MSG010   WTO   'XFIND10 1. DSCB NOT FORMAT 4, VOLSER=123456',          *
               MF=L,MCSFLAG=(REG0)
LENMSG10 EQU   *-MSG010
         SPACE 1
MSG011   WTO   'XFIND11 NO INFORMATION ABOUT DEVICE AVAILABLE, DEVCODE=*
               99',                                                    *
               MF=L,MCSFLAG=(REG0)
LENMSG11 EQU   *-MSG011
         SPACE 1
MSG012   WTO   'XFIND12 VOLSER=123456,DSN=12345678901234567890123 OPEN *
               FAILURE',                                               *
               MF=L,MCSFLAG=(REG0)
LENMSG12 EQU   *-MSG012
         EJECT
***********************************************************************
*                                                                     *
*      DEFINITION DER ARBEITSBEREICHE.                                *
*                                                                     *
***********************************************************************
         SPACE 3
ABER     DSECT
SAVEAREA DS    18F           SAVEAREA FUER ALLGEMEINE REGISTER
DBWORD   DS    D             ZWISCHENSPEICHER FUER DEZIMALZAHLEN
ZWFELD   DS    CL15          ZWISCHENSPEICHER FUER DEZIMALZAHLEN
ZWVOLID1 DS    CL6           ZWISCHENSPEICHER FUER VOLID
ZWVOLID2 DS    CL6           ZWISCHENSPEICHER FUER VOLID
FOUNDBIT DS    C             SCHALTER FUER GEFUNDENE MEMBER
TESTBYTE DS    C             SCHALTER FUER TEST
CLCBYTE  DS    C             SCHALTER ZUR ABFRAGE DER VOLSER NUMBER
ADDRETB1 DS    F             ADRESSE DES ENDES VON TABNACHR
ADDRETPV DS    F             ADRESSE DES ENDES VON TABPVOL
ADDREPRM DS    F             ADRESSE DES ENDES DES PARAMETERBEREICHS
UCBADDR  DS    F             ADRESSE DES UCB-VEKTORS
DYNADDR  DS    F
UCMID    DS    F             UCM-ID. DES AUFRUFERS
MDS1ADDR DS    3H            HOECHSTE ADRESSE VON DSCB1
         ORG   MDS1ADDR
MDS1CC   DS    H             MAX. ZYLINDERNUMMER (DS4HPCR)
MDS1HH   DS    H             MAX. SPURNUMMER (DS4HPCR+2)
MDS1R    DS    H             MAX. SATZNUMMER (DS4HPCR+4)
MLFDADDR DS    2H            HOECHSTE LFD. ADRESSE
         ORG   MLFDADDR
MTRKNO   DS    H             MAX. SPURNUMMER (DS4DEVSZ+2)
MRECNO   DS    H             MAX. SATZNUMMER (DS4DEVT)
LFDADDR  DS    3H            LAUFENDE ADRESSE
         ORG   LFDADDR
LFDCYLNO DS    H             LAUFENDE ZYLINDERNUMMER
LFDTRKNO DS    H             LAUFENDE SPURNUMMER
LFDRECNO DS    H             LAUFENDE SATZNUMMER
SAVE1R10 DS    F             SAVEAREA FUER R10
SAVE1R14 DS    F             SAVEAREA FUER R14
         SPACE 2
EIN      DS    10F           DCB DER EINGABEDATEI
DCBDDNAM DS    CL8           DDNAME
DCBOFLGS DS    C             FLAG BYTE
         ORG   EIN+DCBLEN
DCBADDR  DS    F             ADRESSE DES DCB
         EJECT
*
*      CAMLIST-MACRO.
*
         SPACE 1
CAMOBT   DS    0F
         DS    C             AL1(192)
         DS    C             AL1(128)
         DS    C             AL1(0)
         DS    C             AL1(0)
CADRCCHH DS    F             A(CCHHR)
CADRUCBV DS    F             A(UCBVOLI)
CADRCAMW DS    F             A(CAMWKFLD)
         DS    0H
CCHHR    DS    CL5           CCHHR-ADRESSE DES NAECHSTEN DSCB
         DS    0D
CAMWKFLD DS    CL148         WORK FIELD
         SPACE 2
*
*      DSCB-DEFINITIONEN.
*
         SPACE 1
         ORG   CAMWKFLD
DSCB1    DS    0CL140        DATA SET CONTROL BLOCK FORMAT 1
DS1DSNAM DS    CL44          DATA SET NAME
DS1FMTID DS    C             FORMAT IDENTIFIER (= C'1')
         DS    CL37
DS1DSORG DS    CL2           DATA SET ORGANISATION
DS1RECFM DS    C             DATA SET RECORD FORMAT
         DS    C
DS1BLKL  DS    CL2           DATA SET BLOCK LENGTH
DS1RECL  DS    CL2           DATA SET RECORD LENGTH
         DS    CL3
DS1DSIND DS    C             DATA SET INDICATORS
         ORG   CAMWKFLD
DSCB4    DS    0CL140        DATA SET CONTROL BLOCK FORMAT 4
         DS    CL44
DS4FMTID DS    C             FORMAT IDENTIFIER (= X'F4')
DS4HPCR  DS    CL5           HIGHEST DISK ADDRESS OF DSCB1 (CCHHR)
         DS    CL12
DS4DEVSZ DS    CL4           DEVICE SIZE
         DS    CL8
DS4DEVT  DS    C             NO.OF DSCB'S ON A TRACK
         ORG   CAMWKFLD+148
         EJECT
*
*      DIRECTORY ENTRY LIST FUER BLDL.
*
         SPACE 1
BLDLLIST DS    0F
BLDLFF   DS    H             ANZAHL DER MEMBER ENTRIES
BLDLLL   DS    H             LAENGE DER ENTRIES
MEMBNAME DS    CL8           MEMBER NAME (PARMNAME)
BLDLTTR  DS    CL3           REL. ADRESSE DES MEMBERS (TTR)
         DS    CL2
BLDLC    DS    C             MEMBER TYPE (X'80' - ALIAS)
         SPACE 2
*
*      PARAMETERLISTE FUER 'DYNALC' (ARBEITSBEREICH).
*
         SPACE 1
DALPWKS  DS    0F
ADDRRC   DS    F             ADRESSE VON RETCODE
ADDRTYPE DS    F             ADRESSE DES DYNALLOC-TYPS
ADDRDDN  DS    F             ADRESSE DES DDNAME
ADDRDSN  DS    F             ADRESSE DES DSNAME
         DS    11F
ADDRVOLS DS    F             ADRESSE DER VOLSER NUMBER
         DS    4F
ADDRUNIT DS    F             ADRESSE DER UNIT SPECIFICATION
         ORG   DALPWKS+DALPLEN
RETCODE  DS    0F            RETURN CODES VON 'DYNALC'
SAVE1R15 DS    F             RETURN CODE
SAVE1R0  DS    F             ERROR REASON CODE
SAVE1R1  DS    F             INFORMATION REASON CODE
DALDDNAM DS    CL8           DDNAME
DALUNIT  DS    CL8           UNIT SPECIFICATION
DALTYPE  DS    CL8           DYNALLOC-TYP
DALWAIT  DS    CL4           WAIT REQUEST INDICATOR
         EJECT
*
*      MASKEN-TABELLEN FUER VOLSER NUMBERS AUS DEM PARAMETERBEREICH.
*
*      AUFBAU DER TABELLE:
*      BYTE1 - LAENGE DES ANGEGEBENEN VOLSER-PARAMETERS ODER
*          X'80' BEI TABELLENENDE
*      BYTES2-7 - ANFANGSZEICHEN DER VOLSER NUMBER UND MASKENZEICHEN
*
         SPACE 1
TABPVOL1 DS    10CL7
ENDTPVOL EQU   *
         DS    CL7
TABPVOL2 DS    CL77
         SPACE 2
*
*      NACHRICHTEN-BEREICHE.
*
         SPACE 1
         DS    0F
TABNACHR DS    10CL72        TABELLE FUER NACHRICHTEN
ENDTAB1  EQU   *
TABFNACH DS    CL72          TABELLE FUER FEHLERNACHRICHTEN
MSG01ZW  DS    CL70          NACHRICHEN-ZEILE
ABERL    EQU   *-ABER        LAENGE DER ARBEITSBEREICHE
         EJECT
***********************************************************************
*                                                                     *
*      DEFINITIONEN FUER EINE NACHRICHTENZEILE.                       *
*                                                                     *
***********************************************************************
         SPACE 3
MESSAGE  DSECT
         DS    CL4
         SPACE 2
*
*      DEFINITIONEN FUER MSG01, MSG04.
*
         SPACE 1
         DS    CL15
MS1NAME  DS    CL8           MEMBER NAME
         SPACE 2
*
*      DEFINITIONEN FUER MSG03.
*
         SPACE 1
         ORG   MESSAGE+4
         DS    CL8
MS3DSN   DS    CL17          DATA SET NAME
         DS    C
MS3VOLS  DS    CL6           VOLSER NUMBER
         DS    C
MS3UNIT  DS    CL3           UNIT NAME
         DS    CL2
MS3INFO  DS    CL17          DSCB1-INFORMATION
         DS    C
MS3TTR   DS    CL6           REL. ADRESSE DES MEMBERS (TTR)
         SPACE 2
*
*      DEFINITIONEN FUER MSG07.
*
         SPACE 1
         ORG   MESSAGE+4
         DS    CL15
MS7VOLS  DS    CL6           VOLUME SERIAL NUMBER
         DS    CL5
MS7DSN   DS    CL17          DATA SET NAME
         EJECT
*
*      DEFINITIONEN FUER MSG08, MSG012.
*
         SPACE 1
         ORG   MESSAGE+4
         DS    CL15
MS8VOLS  DS    CL6           VOLUME SERIAL NUMBER
         DS    CL5
MS8DSN   DS    CL23
         SPACE 2
*
*      DEFINITIONEN FUER MSG09.
*
         SPACE 1
         ORG   MESSAGE+4
         DS    CL42
MS9RC    DS    CL2           RETURN CODE
         DS    CL9
MS9VOLS  DS    CL6           VOLSER NUMBER
         SPACE 2
*
*      DEFINITIONEN FUER MSG010.
*
         SPACE 1
         ORG   MESSAGE+4
         DS    CL37
MS10VOLS DS    CL6           VOLSER NUMBER
         SPACE 2
*
*      DEFINITIONEN FUER MSG011.
*
         SPACE 1
         ORG   MESSAGE+4
         DS    CL55
MS11DEVC DS    CL2           DEVICE CODE
         SPACE 2
         ORG   MESSAGE+70
MESSFLAG DS    CL2           FLAG BYTES
         EJECT
***********************************************************************
*                                                                     *
*      UCB-DEFINITIONEN.                                              *
*                                                                     *
***********************************************************************
         SPACE 3
UCB      DSECT
         DS    CL3
DEVSTAT  DS    C             DEVICE STATUS
         DS    CL9
UCBNAME  DS    CL3           UNIT NAME
UCBTYPE  DS    CL2           DEVICE TYPE
UCBDVCLS DS    C             DEVICE CLASS
DEVCODE  DS    C             DEVICE CODE
         DS    CL4
UCBVTOC  DS    CL4           REL. ADDR. OF VTOC FOR THIS VOL. (TTR0)
UCBVOLI  DS    CL6           VOLUME SERIAL NUMBER
UCBSTAB  DS    C             VOLUME STATUS
         SPACE 3
***********************************************************************
*                                                                     *
*      PARAMETERBEREICH.                                              *
*                                                                     *
***********************************************************************
         SPACE 3
         XPARM
PARMENDE EQU   *
         SPACE 3
***********************************************************************
*                                                                     *
*      VEKTOR MIT UCB-ADRESSEN.                                       *
*                                                                     *
***********************************************************************
         SPACE 3
VEKTOR   DSECT
         DS    1024H
VEKEND   DS    H             =X'FFFF'
VEKLEN   EQU   *-VEKTOR
         EJECT
         END   FIND
./ ADD  NAME=FREE
FREE     CSECT
         REG
         XSAVE R12,,FREE,WORKL
         USING WORK,R13
         LR    R3,R1
         USING PARMAREA,R3
         LA    R2,TEXT
         MVI   DSW,X'00'
         CLC   4(4,R2),=C',ALL'
         BNE   NORM
         OI    DSW,X'40'
NORM     EQU   *
         MVC   KMSGTEXT,KONS
         L     R1,16
         TM    116(R1),X'01'      MVS?
         BO    MVSDATA
         L     R8,200(R1)         SECONDARY CVT
         L     R8,108(R8)         A(GOVRFLB)
         L     R8,8(R8)           A(DUMMY PQE DES DYNAM. BEREICHS)
GOON     LM    R8,R9,8(R8)        A(PQE DES DYNAM. BEREICHS)
         STM   R8,R9,DPQE
         CLC   4(4,R2),=C',V=V'
         BNE   *+6
         LR    R8,R9
         CLC   4(4,R2),=C',V=R'
         BNE   *+6
         LR    R9,R8
         STM   R8,R9,PQEAD        STORE ADDR. OF DYNAMIC AREA
         L     R9,24(R8)          REGION BEGIN
         L     R10,20(R8)         REGION SIZE
         LA    R9,0(R9)           CLEAR HIGH ORDER BIS
         LA    R10,0(R10)         CLEAR HIGH ORDER BITS
         STM   R9,R10,DYNAVALS
         LA    R7,FBQETAB
         L     R8,PQEAD
PQE2     CLC   5(3,R8),PQEAD+1
         BE    DISARET
         ICM   R9,8,=X'08'
         C     R8,DPQE
         BE    *+8
         ICM   R9,8,=X'04'
         L     R8,04(R8)
         LA    R6,FBQEND
DISALOP  EQU   *
         L     R10,8(R8)
         LA    R10,0(R10)
         ICM   R9,7,13(R8)
         TM    116(R1),X'02'      DAT?
         BO    *+8
         LA    R9,0(R8)
         STM   R9,R10,0(R7)
         LA    R7,8(R7)
         CLC   5(3,R8),PQEAD+1    END OF FBQE'S?
         BE    DISARET
         CR    R7,R6              ENDE DER TABELLE?
         BNL   DISALOP1
         L     R8,4(R8)           NEXT FBQE
         B     DISALOP
DISALOP1 EQU   *
         OI    DSW,X'80'
DISARET  EQU   *
         ST    R7,FTABEND
         L     R8,PQEAD+4
         C     R8,PQEAD
         BE    PQE2E
         ST    R8,PQEAD
         B     PQE2
PQE2E    EQU   *
         TM    DSW,X'40'
         BNO   NTALL1
         TM    116(R1),X'02'
         BO    ALLVS
         MVC   WTO,MESS1
         L     R9,DYNAVALS+4
         LR    R1,R9
         SRA   R9,10
         CVD   R9,CON
         UNPK  WTO+40(4),CON
         OI    WTO+43,X'F0'
         L     R9,16
         L     R9,200(R9)
         L     R9,108(R9)
         LR    R11,R9
         L     R9,4(R9)
         L     R9,12(R9)
         LA    R9,0(R9)
         SRA   R9,10
         CVD   R9,CON
         UNPK  WTO+27(4),CON
         OI    WTO+30,X'F0'
         L     R9,4(R11)
         L     R9,8(R9)
         LA    R9,0(R9)
         SRA   R9,10
         CVD   R9,CON
         UNPK  WTO+16(4),CON
         OI    WTO+19,X'F0'
         L     R8,0(R11)
         LA    R8,0(R8)
         AR    R8,R1
         L     R9,16
         L     R9,164(R9)
         LA    R9,1(R9)
         SR    R9,R8
         SRA   R9,10
         CVD   R9,CON
         UNPK  WTO+51(4),CON
         OI    WTO+54,X'F0'
         L     R0,REG4
         WTO   MF=(E,WTO)
         B     NTALL1
ALLVS    EQU   *
         TM    116(R1),X'01'
         BO    ALLMVS
         MVC   WTO,MESS7
         L     R1,16
         L     R9,128(R1)        CVTPTR
         SRA   R9,10
         CVD   R9,CON
         UNPK  WTO+16(5),CON
         OI    WTO+20,X'F0'
         L     R8,DPQE
         L     R9,20(R8)
         SRA   R9,10
         CVD   R9,CON
         UNPK  WTO+27(5),CON
         OI    WTO+31,X'F0'
         L     R8,DPQE+4
         L     R9,20(R8)
         SRA   R9,10
         CVD   R9,CON
         UNPK  WTO+38(5),CON
         OI    WTO+42,X'F0'
         L     R8,200(R1)       CVTABEND (SEC.CVT)
         L     R7,112(R8)       COMM TASK TCB
         L     R7,152(R7)       DPQE-8
         L     R7,8(R7)         MS-PQE
         L     R9,20(R7)        REGION SIZE
         L     R7,24(R7)        REGION BEGIN
         LA    R7,0(R9,R7)      REGION END
         SRA   R9,10
         CVD   R9,CON
         UNPK  WTO+48(5),CON
         OI    WTO+52,X'F0'
         L     R6,108(R8)       GOVRFLB
         L     R6,4(R6)         SQA-DQE
         L     R9,8(R6)
         SR    R9,R7
         SRA   R9,10
         CVD   R9,CON
         UNPK  WTO+59(5),CON
         OI    WTO+63,X'F0'
         L     R9,12(R6)
         SRA   R9,10
         CVD   R9,CON
         UNPK  WTO+70(5),CON
         OI    WTO+74,X'F0'
         L     R0,REG4
         WTO   MF=(E,WTO)
         B     NTALL1
ALLMVS   EQU   *
         MVC   WTO,MESS8
         L     R9,X'80'(,R1)        LOWEST ADDRESS NOT IN THE NUCLEUS
         SRA   R9,10
         CVD   R9,CON
         UNPK  WTO+16(5),CON
         OI    WTO+20,X'F0'
         L     R4,X'230'(,R1)       ADDRESS OF GDA
         USING GDA,R4
         L     R9,PASIZE
         SRA   R9,10
         CVD   R9,CON
         UNPK  WTO+27(5),CON
         OI    WTO+31,X'F0'
         L     R5,CSAPQEP
         USING PQE,R5
         L     R9,PQESIZE
         SRA   R9,10
         CVD   R9,CON
         UNPK  WTO+38(5),CON
         OI    WTO+42,X'F0'
         L     R8,X'1A0'(,R1)         ADDRESS OF FIRST BYTE OF LPA
         L     R5,SQASPQEP
         L     R5,4(,R5)              ADDRESS OF FIRST DQE
         L     R9,8(,R5)
         SLR   R9,R8
         LA    R9,0(,R9)
         SRA   R9,10
         CVD   R9,CON
         UNPK  WTO+49(5),CON
         OI    WTO+53,X'F0'
         L     R9,12(,R5)             LENGTH OF SQA
         SRA   R9,10
         CVD   R9,CON
         UNPK  WTO+60(5),CON
         OI    WTO+64,X'F0'
         L     R0,REG4
         WTO   MF=(E,WTO)
NTALL1   EQU   *
*   FBQE-LOOP
         L     R7,FTABEND
         MVC   WTO,MESS3
         LA    R8,FBQETAB
         CR    R7,R8
         BE    NOFRECOR
         LA    R9,WTO
DRLOOP   EQU   *
         BAL   R11,CONVERT
         L     R0,REG4
         WTO   MF=(E,WTO)
         LA    R8,8(R8)           NEXT FBQE IN TABLE
         CR    R7,R8
         BE    DREND
         B     DRLOOP
NOFRECOR EQU   *
         MVC   WTO,MESS4
         L     R0,REG4
         WTO   MF=(E,WTO)
         B     RETURN
DREND    EQU   *
         TM    DSW,X'80'
         BNO   RETURN
         MVC   WTO,MESS5
         L     R0,REG4
         WTO   MF=(E,WTO)
RETURN   EQU   *
         TM    DSW,X'40'
         BNO   END
         L     R5,16      CVT
         TM    X'74'(R5),X'01'
         BO    MVSSQA
         L     R5,200(R5)     A(SEC. CVT)
         L     R5,108(R5)    A(GOOFIE)
         L     R5,4(R5)   A(DQE DES SQS)
MVSSQA   LA    R7,0
         SR    R4,R4
         L     R5,0(R5)    A(FIRST FQE)
         LA    R5,0(R5)  CLEAR HIGH ORDER BYTE
         LTR   R5,R5   END OF FQE-CHAIN?
         BZ    NONE
NEXTFQE  EQU   *
         L     R6,4(R5)
         LA    R6,0(R6)   CLEAR HIGH ORDER BYTE
         CR    R6,R7
         BNH   INCR
         LR    R7,R6
INCR     EQU   *
         AR    R4,R6
         L     R5,0(R5)
         LA    R5,0(R5)
         LTR   R5,R5
         BNZ   NEXTFQE
NONE     EQU   *
         MVC   WTO,MESS6
         CVD   R4,CON
         UNPK  WTO+12(6),CON
         OI    WTO+17,X'F0'
         CVD   R7,CON
         UNPK  WTO+59(6),CON
         OI    WTO+64,X'F0'
         L     R0,REG4
         WTO   MF=(E,WTO)
END      EQU   *
         XRETURN ,R
CONVERT  EQU   *
         SR    R10,R10
         IC    R10,0(R8)
         LA    R10,KMSGTEXT(R10)
         MVC   WTO+12(4),0(R10)
         ICM   R10,7,1(R8)
         SRA   R10,10
         CVD   R10,CON
         UNPK  WTO+39(5),CON
         OI    WTO+43,X'F0'
         L     R0,4(R8)
         SRA   R0,10
         CVD   R0,CON
         UNPK  WTO+58(5),CON
         OI    WTO+62,X'F0'
         AR    R10,R0
         CVD   R10,CON
         UNPK  WTO+49(5),CON
         OI    WTO+53,X'F0'
         BR    R11
MVSDATA  EQU   *
         L     R8,X'230'(R1)      A(GLOBAL DATA AREA)
         MVC   KMSGTEXT+4(4),KMSGTEXT+8
         MVC   KMSGTEXT+8(4),=C'CSA '
         B     GOON
KONS     DC    C'MVT V=V V=R'
MESS1    WTO   'XFREE01 NUC=1234K, SQS=1234K, DYNAM=1234K, LPA=1234K', *
               MCSFLAG=REG0,MF=L
MESS3    WTO   'XFREE02 *** FREE STORAGE AREA FROM 12345K TO 12345K = 1*
               2345K',MCSFLAG=(REG0),MF=L    L
MESS4    WTO   'XFREE03 NO FREE STORAGE AREAS',MCSFLAG=REG0,           *
               MF=L
MESS5    WTO   'XFREE04 TABLE-OVERFLOW, MORE FREE AREAS ARE PRESENT',  *
               MCSFLAG=REG0,MF=L       MF=L
MESS6    WTO   'XFREE05 123456 UNUSED SQS-BYTES. LARGEST FREE AREA HAS *
               123456 BYTES',MCSFLAG=REG0,MF=L     MF=L
MESS7    WTO   'XFREE06 NUC=12345K,V=R=12345K,V=V=12345K,MS=12345K,LPA=*
               12345K,SQA=12345K',MCSFLAG=(REG0),MF=L
MESS8    WTO   'XFREE07 NUC=12345K,V=V=12345K,CSA=12345K,LPA=12345K,SQA*
               =12345K',MCSFLAG=REG0,MF=L
MESS9    WTO   'XFREE08                                                *
                      ',MCSFLAG=REG0,MF=L
WORK     DSECT
SVA      DS    18F
CON      DS    D
DYNAVALS DS    D
FBQETAB  DS    50D
FBQEND   EQU   *
FTABEND  DS    A
PQEAD    DS   2A
DPQE     DS   2A
KMSGTEXT DS    CL12
WTO      DS    CL100
DSW      DS    X
WORKL    EQU   *-WORK
         XPARM
*
GDA      DSECT ,                     GLOBAL DATA AREA,
*                                    POINTED TO BY CVT+X'230'
*                                    PRESENT ONLY IN MVS SYSTEMS
GDAFLAGS DS    BL1         GLOBAL FLAGS
GDARESV  DS    CL3
VRDREG   DS    F           DEFAULT V=R REGION SIZE
CSAPQEP  DS    A           CSA PQE POINTER
VRPQEP   DS    A           V=R PQE POINTER
PASTRT   DS    A           PRIVATE AREA START ADDRESS
PASIZE   DS    F           PRIVATE AREA SIZE
SQASPQEP DS    A           SQA SPQE POINTER
SQASPLFT DS    F           SQA SPACE LEFT UNALLOCATED
         DS    5F
CSASPQEP DS    A           FIRST CSA SPQE POINTER
*
*
PQE      DSECT ,                     PARTITION QUEUE ELEMENT,
*                                    POINTED TO BY:
PQEFFBQE DS    A           PTR TO FIRST FBQE OR, IF NONE, TO PQE
PQEBFBQE DS    A           PTR TO LAST FBQE OR, IF NONE, TO PQE
PQEFPQE  DS    A           ADDR NEXT PQE OR ZERO
PQEBPQE  DS    A           ADDR PREVIOUS PQE OR ZERO
PQETCB   DS    A           ADDR TCB FOR JOB STEP TO WHICH SPACE
*                          BELONGS
PQESIZE  DS    F           SIZE OF REGION DESCRIBED BY THIS PQE
PQEREGN  DS    A           ADDR FIRST BYTE OF REGION DESCRIBED BY
*                          THIS PQE
         DS    CL2
VMMFLGS  DS    BL1         FLAGS, SEVEN HIGH ORDER BITS ZERO
VVVRFLG  EQU   B'00000001' REAL OR VIRTUAL REGION FLAG
         DS    CL1
*
*
FBQE     DSECT ,                     FREE BLOCK QUEUE ELEMENT,
*                                    POINTED TO BY PQE
FBQFPTR  DS    A           PTR TO NEXT FBQE OR PQE
FBQBPTR  DS    A           PTR TO PREVIOUS FBQE OR PQE
FBQSIZE  DS    F           SIZE OF THIS FREE BLOCK
FBQAREA  DS    A           LOW ADDRESS OF FREE BLOCK
*
         END   FREE
./ ADD  NAME=GETUCBS
         TITLE 'GETUCBS                               GET UCB ADRESSES'
GETUCBS  CSECT
         SPACE 3
***********************************************************************
*                                                                     *
*      PROGRAM-ID. GETUCBS.                                           *
*      AUTHOR. EHNERT.                                                *
*      INSTALLATION. BAYER AG, LEVERKUSEN, RECHENZENTRUM.             *
*      DATE-WRITTEN. 18. 4. 1975.                                     *
*      REMARKS.                                                       *
*                                                                     *
*          DAS PROGRAMM 'GETUCBS' IST EIN UNTERPROGRAMM, DAS DIE      *
*          UCB LOOKUP TABLE NACH GUELTIGEN UCB-ADRESSEN DURCH-        *
*          SUCHT. ADRESSEN, DIE MEHRFACH VORHANDEN SIND, WERDEN       *
*          NUR EINMAL BRUECKSICHTIGT UND ADRESSEN VON DUMMY-UCB'S     *
*          DIE GUELTIGEN ADRESSEN WERDEN IN EINEM VEKTOR GESPEI-      *
*          CHERT.                                                     *
*                                                                     *
*          ALS EINGABEPARAMETER WIRD IN REGISTER 1 DIE ADRESSE        *
*          EINES VOLLWORTS MIT DER ADRESSE DES VEKTORS ERWARTET,      *
*          DER 1024 HALBWORTE ENTHALTEN SOLL.                         *
*          DAS ERSTE BIT DIESES VOLLWORTS MUSS GESETZT SEIN, UM       *
*          DAS ENDE DER PARAMETERKETTE ANZUZEIGEN.                    *
*                                                                     *
*          DAS ENDE DER GUELTIGEN ADRESSE IM VEKTOR WIRD DURCH        *
*          EIN HALBWORT MIT DEM INHALT X'FFFF' GEKENNZEICHNET.        *
*                                                                     *
***********************************************************************
         EJECT
*
*      SICHERN DER REGISTER,
*      SPEICHERPLATZANFORDERUNG FUER ARBEITSBEREICHE,
*      ZUORDNUNG DER BASISREGISTER.
*
         SPACE 1
         XSAVE R12,,GETUCBS,ABERL
         USING ABER,R13      BASISREG. FUER DSECT ABER ZUORDNEN
         SPACE 2
*
*      PRUEFUNG DER EINGABE.
*
         SPACE 1
         L     R1,0(R1)      ADRESSE DES VEKTORS LADEN
         LTR   R1,R1         NUR EIN PARAMETER ?
         BM    GETULT        JA, VERZWEIGEN
         MVC   0(2,R1),=X'FFFF' VEKTORENDE SPEZIFIZIEREN
         B     ENDE          VERZWEIGEN
         EJECT
*
*      AUFSUCHEN DER UCB LOOKUP TABLE.
*
         SPACE 1
GETULT   EQU   *
         L     R2,16         ADRESSE DER CVT LADEN
         L     R2,40(R2)     ADRESSE DER UCB LOOKUP TABLE LADEN
         SH    R2,=H'2'      R2 UM ZWEI VERMINDERN
         LR    R3,R1         ADRESSE DES VEKTORS LADEN
         SR    R4,R4         R4 LOESCHEN
         LA    R6,1024       LOOP CONTER INITIALISIEREN
         SPACE 2
*
*      VERARBEITUNG DER UCB-ADRESSEN.
*
         SPACE 1
NEXTUCB  EQU   *
         LA    R2,2(R2)      R2 ERHOEHEN
         ICM   R4,3,0(R2)    UCM-ADRESSE LADEN
         BZ    NEXTUCB       VERZW., WENN UCB = DUMMY-UCB
         STH   R4,0(R3)      UCM-ADRESSE SPEICHERN
         CLC   0(2,R3),=X'FFFF' ENDE DER UCB LOOKUP TABLE ERREICHT ?
         BE    ENDE          JA, VERZWEIGEN
         LR    R5,R1         ADRESSE DES VEKTORS LADEN
CLCLOOP  EQU   *
         CR    R5,R3         ALLE GUELTIGEN ADRESSEN VERGLICHEN ?
         BNL   UCBADROK      JA, VERZWEIGEN
         CLC   0(2,R5),0(R3) UCB-ADRESSE SCHON VORHANDEN ?
         BE    NEXTUCB       JA, VERZWEIGEN
         LA    R5,2(R5)      NAECHSTE ADRESSE IN DER TABELLE LADEN
         B     CLCLOOP       VERZWEIGEN
UCBADROK EQU   *
         LA    R3,2(R3)      NAECHSTE ADRESSE IN DER TABELLE LADEN
         BCT   R6,NEXTUCB    VERZWEIGEN
         EJECT
*
*      SPEICHERPLATZFREIGABE,
*      REINITIALISIERUNG DER REGISTER UND
*      RUECKSPRUNG ZUM AUFRUFENDEN PROGRAMM.
*
         SPACE 1
ENDE     EQU   *
         XRETURN ,R
         EJECT
***********************************************************************
*                                                                     *
*      DEFINITIONEN.                                                  *
*                                                                     *
***********************************************************************
         SPACE 3
R0       EQU   0
R1       EQU   1             POINTER AUF VEKTOR MIT UCB-ADRESSEN
R2       EQU   2             POINTER IN CVT / UCB LOOKUP TABLE
R3       EQU   3             POINTER IN UCB-VEKTOR
R4       EQU   4             ZWISCHENSPEICHER FUER UCB-ADRESSE
R5       EQU   5             POINTER IN UCB-VEKTOR
R6       EQU   6             LOOP COUNTER
R7       EQU   7
R8       EQU   8
R9       EQU   9
R10      EQU   10
R11      EQU   11
R12      EQU   12            BASISREG. FUER CSECT GETUCBS
R13      EQU   13            BASISREG. FUER DSECT ABER
R14      EQU   14            RUECKSPRUNGADRESSE
R15      EQU   15            CSECT-ADRESSE
         SPACE 2
ABER     DSECT
SAVEAREA DS    18F           SAVEAREA FUER ALLGEMEINE REGISTER
ABERL    EQU   *-ABER        LAENGE DER ARBEITSBEREICHE
         SPACE 2
         END   GETUCBS
./ ADD  NAME=HELP
         TITLE 'XHELP                            X-COMMAND HELP'
HELP     CSECT
         SPACE 3
***********************************************************************
*                                                                     *
*      PROGRAM-ID. HELP.                                              *
*      AUTHOR. EHNERT.                                                *
*      INSTALLATION. BAYER AG, LEVERKUSEN, RECHENZENTRUM.             *
*      DATE-WRITTEN. 3. 4. 1975.                                      *
*      REMARKS.                                                       *
*                                                                     *
*          DAS X-COMMAND 'HELP' GIBT INFORMATIONEN UEBER DAS ALS      *
*          PARAMETER SPEZIFIZIERTE X-COMMAND AUS.                     *
*                                                                     *
*          ZUSAETZLICH KOENNEN FOLGENDE PARAMETER SPEZIFIZIERT        *
*          WERDEN:                                                    *
*          A) 'HISTORY' / 'H': ES WERDEN INFORMATIONEN UEBER DIE      *
*          HISTORY,                                                   *
*          B) 'SYNTAX' / 'S': INFORMATIONEN UEBER DIE SYNTAX,         *
*          C) 'FUNCTION' / 'F': INFORMATIONEN UEBER DIE FUNCTION,     *
*          D) 'ALL' / 'A': INFORMATIONEN UEBER DIE HISTORY, SYNTAX    *
*          UND FUNCTION DES X-COMMANDS AUSGEGEBEN.                    *
*          NEBEN DER ANGABE DER PARAMETER IN KURZFORM KOENNEN         *
*          DIE PARAMETER IN FOLGENDER ART SPEZIFIZIERT WERDEN:        *
*          WIRD KEINE DER ANGABEN A) - D) GETROFFEN, SO WIRD B)       *
*          STANDARDMAESSIG ANGENOMMEN.                                *
*                                                                     *
*          WIRD KEIN COMMAND NAME ANGEGEBEN, SO WIRD EINE LISTE       *
*          ALLER VERFUEGBAREN COMMANDS AUSGEGEBEN.                    *
*                                                                     *
***********************************************************************
         EJECT
***********************************************************************
*                                                                     *
*      BEGINN DER VERARBEITUNG.                                       *
*                                                                     *
***********************************************************************
         SPACE 3
*
*      SICHERN DER REGISTER,
*      SPEICHERPLATZANFORDERUNG FUER ARBEITSBEREICHE,
*      ZUORDNUNG DER BASISREGISTER.
*
         SPACE 1
         XSAVE R12,,HELP,ABERL
         SPACE 1
         LR    R11,R1        BASISREG. FUER DSECT PARMAREA INITIALIS.
         USING PARMAREA,R11  BASISREG. FUER DSECT PARMAREA ZUORDNEN
         USING ABER,R13      BASISREG. FUER DSECT ABER ZUORDNEN
         EJECT
*
*      INITIALISIERUNG DER SPEICHER.
*
         SPACE 1
         MVC   DIRECTRY(DCBLEN),DCBDIRHL DCB FUER DIRECTORY UEBERT.
         MVC   INFO(DCBLEN1),DCBHELPL DCB FUER INFO-DATEI UEBERT.
         LA    R3,DIRECTRY   ADRESSEN DER
         LA    R2,INFO           DCBS LADEN
         STM   R2,R3,DCBADDR1    UND SPEICHERN
         MVI   DCBADDR1,X'80' OPTION BYTES
         MVI   DCBADDR2,X'80'    SETZEN
         MVC   HBYTE(3),=XL3'0' FLAG BYTES LOESCHEN
         MVC   CMDNAME,=CL8' ' COMMAND NAME LOESCHEN
         EJECT
***********************************************************************
*                                                                     *
*      VERARBEITUNG DER EINGABEPARAMETER.                             *
*                                                                     *
***********************************************************************
         SPACE 3
         CLI   TEXT+4,C' '   PARAMETER ANGEGEBEN ?
         BE    OPENDRKT      NEIN, VERZWEIGEN
         LA    R4,TEXT+4     ANFANGSADRESSE LADEN
         SR    R5,R5         LAENGENZAEHLER LOESCHEN
         LA    R8,PARMENDE   ENDADRESSE DES PARAMETERBEREICHS LADEN
         SPACE 2
*
*      VERARBEITUNG DES COMMAND NAME.
*
         SPACE 1
NXTCMDN  EQU   *
         LA    R4,1(R4)      ADRESSE DES NAECHSTEN BYTE LADEN
         CR    R4,R8         PARAMETERBEREICH UEBERSCHRITTEN ?
         BNL   FEHLPARM      JA, VERZWEIGEN
         CLI   0(R4),C','    ENDE DES COMMAND NAME ERREICHT ?
         BE    ENDCMDN       JA, VERZWEIGEN
         CLI   0(R4),C' '    ENDE DER PARAMETERKETTE ERREICHT ?
         BE    ENDCMDN       JA, VERZWEIGEN
         LA    R5,1(R5)      LAENGENZAEHLER ERHOEHEN
         B     NXTCMDN       VERZWEIGEN
         SPACE 1
ENDCMDN  EQU   *
         C     R5,=F'8'      LAENGE > 8 ?
         BH    FEHLPARM      JA, VERZW. ZUR FEHLERROUTINE
         LTR   R5,R5         LAENGE = 0 ?
         BZ    FEHLPARM      JA, VERZW. ZUR FEHLERROUTINE
         BCTR  R5,0          R5 UM EINS VERMINDERN
         EX    R5,MOVECMDN   VERZ. ZUM UEBERTR. DES COMMAND NAME
         CLI   0(R4),C','    NOCH WEITERE PARAMETER ANGEGEBEN ?
         BE    INFOPARM      JA, VERZWEIGEN
         B     ENDPARM       VERZW. ZUM ABSCHLUSS DER PARAM.-VERARB.
         SPACE 1
MOVECMDN EQU   *
         MVC   CMDNAME(0),TEXT+5 COMMAND NAME UEBERTRAGEN
         EJECT
*
*      VERARBEITUNG DER INFORMATION-PARAMETER.
*
         SPACE 1
INFOPARM EQU   *
         SR    R8,R8         LAENGE FUER MVCPARM
         CLI   1(R4),C'A'    PARAMETER = ALL ?
         BE    TESTA         JA, VERZWEIGEN
         CLI   1(R4),C'H'    PARAMETER = HISTORY ?
         BE    TESTH         JA, VERZWEIGEN
         CLI   1(R4),C'S'    PARAMETER = SYNTAX ?
         BE    TESTS         JA, VERZWEIGEN
         CLI   1(R4),C'F'    PARAMETER = FUNCTION ?
         BNE   FEHLPARM      NEIN, VERZW. ZUR FEHLERROUTINE
         SPACE 2
*
*      PRUEFUNG AUF GUELTIGKEIT.
*
         SPACE 1
TESTF    EQU   *
         LA    R5,FBYTE      ADRESSE DES FLAG BYTES LADEN
         LA    R6,CONFUNC1   ADRESSE DER KONSTANTEN LADEN
         LA    R7,7          LAENGE FUER CLCPARM
         B     TESTPARM      VERZWEIGEN
         SPACE 1
TESTS    EQU   *
         LA    R5,SBYTE      ADRESSE DES FLAG BYTES LADEN
         LA    R6,CONSYNT1   ADRESSE DER KONSTANTEN LADEN
         LA    R7,5          LAENGE FUER CLCPARM
         B     TESTPARM      VERZWEIGEN
         SPACE 1
TESTH    EQU   *
         LA    R5,HBYTE      ADRESSE DES FLAG BYTES LADEN
         LA    R6,CONHIST1   ADRESSE DER KONSTANTEN LADEN
         LA    R7,6          LAENGE FUER CLCPARM
         B     TESTPARM      VERZWEIGEN
         SPACE 1
TESTA    EQU   *
         LA    R5,HBYTE      ADRESSE DER FLAG BYTES LADEN
         LA    R6,CONALL     ADRESSE DER KONSTANTEN LADEN
         LA    R7,2          LAENGE FUER CLCPARM
         LR    R8,R7         LAENGE FUER MVCPARM
         EJECT
TESTPARM EQU   *
         CLI   2(R4),C' '    PARAMERTER GUELTIG ?
         BE    SETBYTE       JA, VERZWEIGEN
         CLI   2(R4),C','    PARAMERTER GUELTIG ?
         BE    SETBYTE       JA, VERZWEIGEN
         EX    R7,CLCPARM    VERZW. ZUM PRUEFEN DES PARAMETERS
         BNE   FEHLPARM      VERZW., WENN PARAMETER UNGUELTIG
SETBYTE  EQU   *
         EX    R8,MVCPARM    VERZW. ZUM SETZEN DER FLAG BYTES
         LA    R4,2(R4)      ADRESSE DES NAECHSTEN BYTE LADEN
PARMLOOP EQU   *
         CLI   0(R4),C' '    ENDE DER PARAMETERKETTE ?
         BE    OPENINFO      JA, VERZWEIGEN
         CLI   0(R4),C','    ENDE DES PARAMETERS ?
         BE    INFOPARM      JA, VERZWEIGEN
         LA    R4,1(R4)      ADRESSE DES NAECHSTEN BYTE LADEN
         B     PARMLOOP      VERZWEIGEN
         SPACE 2
*
*      ABSCHLUSS DER PARAMETERVERARBEITUNG.
*
         SPACE 1
ENDPARM  EQU   *
         MVI   SBYTE,X'FF'   DEFAULT (SYNTAX) SPEZIFIZIEREN
         B     OPENINFO      VERZWEIGEN
         SPACE 2
CLCPARM  EQU   *
         CLC   1(0,R4),0(R6) LANGER PARAMETER GUELTIG ?
MVCPARM  EQU   *
         MVC   0(0,R5),=X'FFFFFF' FLAG BYTE(S) SETZEN
         EJECT
***********************************************************************
*                                                                     *
*      AUSGABE DER INFORMATIONEN.                                     *
*                                                                     *
***********************************************************************
         SPACE 3
*
*      INFO-DATEI EROEFFNEN.
*
         SPACE 1
OPENINFO EQU   *
         LA    R1,DCBADDR1   ADRESSE DER DCB-ADRESSE LADEN
         SVC   19            VERZW. ZUM EROEFFNEN DER DATEI
         LA    R1,INFO       LOAD ADDRESS OF DCB
         TM    48(R1),X'10'  OPEN SUCCESSFUL ?
         BZ    NOHELPAV      BRANCH IF NOT
         SPACE 2
*
*      MEMBER ENTRY AUFSUCHEN.
*
         SPACE 1
         LA    R1,INFO       ADRESSE DES DCB LADEN
         LA    R0,CMDNAME    ADRESSE DES COMMAND NAME LADEN
         FIND  (R1),(R0),D   AUFSUCHEN DES ENTRY
         LTR   R15,R15       RETURN CODE = 0 ?
         BNZ   NOHELPAV      NEIN, VERZWEIGEN
         EJECT
*
*      ROUTINE BEI ANGEFORDERTER FUCTION INFORMATION.
*
         SPACE 1
FUNCINFO EQU   *
         CLI   FBYTE,X'FF'   FLAG BYTE GESETZT ?
         BNE   SYNTINFO      NEIN, VERZWEIGEN
         MVI   FBYTE,X'00'   FLAG BYTE LOESCHEN
         LA    R4,CONFUNC1   ADRESSEN DER
         LA    R5,CONFUNC2       KONSTANTEN LADEN
         B     GETWTOLP      VERZW. ZUR NACHRICHTENAUSGABE
         SPACE 2
*
*      ROUTINE BEI ANGEFORDERTER SYNTAX-INFORMATION.
*
         SPACE 1
SYNTINFO EQU   *
         CLI   SBYTE,X'FF'   FLAG BYTE GESETZT ?
         BNE   HISTINFO      NEIN, VERZWEIGEN
         MVI   SBYTE,X'00'   FLAG BYTE LOESCHEN
         LA    R4,CONSYNT1   ADRESSEN DER
         LA    R5,CONSYNT2       KONSTANTEN LADEN
         B     GETWTOLP      VERZW. ZUR NACHRICHTENAUSGABE
         SPACE 2
*
*      ROUTINE BEI ANGEFORDERTER HISTORY-INFORMATION.
*
         SPACE 1
HISTINFO EQU   *
         MVI   HBYTE,X'00'   FLAG BYTE LOESCHEN
         LA    R4,CONHIST1   ADRESSEN DER
         LA    R5,CONHIST2       KONSTANTEN LADEN
         EJECT
*
*      AUFBEREITEN DER UEBERSCHRIFT.
*
         SPACE 1
GETWTOLP EQU   *
         MVC   WTO(LENMSG03),MSG03 NACHRICHTENZEILE UEBERTRAGEN
         MVC   WTO+12(8),0(R4) KONSTANTE 1 UEBERTRAGEN
         MVC   WTO+24(8),CMDNAME COMMAND NAME UEBERTRAGEN
         MVI   FNDBYTE,X'00' FLAG BYTE LOESCHENN
         SPACE 2
*
*      AUFSUCHEN DES INFO-ENTRY.
*
         SPACE 1
SRCHINFO EQU   *
         BAL   R14,READINFO  VERZW. ZUM LESEN EINES BLOCKS
SRCHLOOP EQU   *
         CLI   0(R2),X'FF'   ENDE DER DATEI ERREICHT ?
         BE    CLOSINFO      JA, VERZWEIGEN
         CLC   0(11,R2),0(R5) INFORMATION-ENTRY GEFUNDEN ?
         BE    GETLPOK       JA, VERZWEIGEN
         LA    R2,80(R2)     ADRESSE DES NAECHSTEN SATZES LADEN
         BCT   R3,SRCHLOOP   VERZWEIGEN
         B     SRCHINFO      VERZWEIGEN
         EJECT
*
*      AUSGABE EINZELNER NACHRICHTENZEILEN.
*
         SPACE 1
GETINFO  EQU   *
         BAL   R14,READINFO  VERZW. ZUM LESEN EINES BLOCKS
GETLOOP  EQU   *
         CLI   0(R2),X'FF'   ENDE DER DATEI ERREICHT ?
         BE    CLOSINFO      JA, VERZWEIGEN
         CLC   0(2,R2),=C'%%' ENDE DER INFORMATION ?
         BE    CLOSINFO      JA, VERZWEIGEN
         MVC   WTO+12(54),0(R2) ZEILE UEBERTRAGEN
         MVI   FNDBYTE,X'FF' FLAG BYTE SETZEN
GETLPOK  EQU   *
         L     R0,REG4       UCM-ID DES AUFRUFERS LADEN
         WTO   MF=(E,WTO)    NACHRICHTENZEILE AUSGEBEN
         LA    R2,80(R2)     ADRESSE DES NAECHSTEN SATZES LADEN
         MVC   WTO(LENMSG04),MSG04 NACHRICHTENZEILE UEBERTRAGEN
         BCT   R3,GETLOOP    VERZWEIGEN
         B     GETINFO       VERZWEIGEN
         SPACE 2
*
*      SCHLIESSEN DER INFO-DATEI.
*
         SPACE 1
CLOSINFO EQU   *
         CLI   FNDBYTE,X'FF' INFORMATION GEFUNDEN ?
         BE    *+22          JA, VERZWEIGEN
         MVC   WTO(LENMSG06),MSG06 NACHRICHTENZEILE UEBERTRAGEN
         MVC   WTO+23(8),0(R4) KONSTANTE 1 UEBERTRAGEN
         MVC   WTO+35(8),CMDNAME COMMAND NAME UEBERTRAGEN
         CLC   WTO(LENMSG04),MSG04 LEERZEILE ?
         BE    CLOSE         JA, VERZWEIGEN
         L     R0,REG4       UCM-ID DES AUFRUFERS LADEN
         WTO   MF=(E,WTO)    NACHRICHTENZEILE AUSGEBEN
CLOSE    EQU   *
         LA    R1,DCBADDR1   ADRESSE DER DCB-ADRESSE LADEN
         SVC   20            VERZW. ZUM SCHLIESSEN DER DATEI
         SPACE 1
         CLC   HBYTE(3),=XL3'0' WEITERE INFORMATION ANGEFORDERT ?
         BE    ENDE          NEIN, VERZWEIGEN
         EJECT
*
*      AUSGABE DER NACHRICHTEN MIT REPLY.
*
         SPACE 1
WTORLOOP EQU   *
         XC    ECB,ECB       EVENT CONTROL BLOCK LOESCHEN
         L     R0,REG4       UCM-ID DES AUFRUFERS LADEN
         LA    R2,ECB        ADRESSE DES ECB LADEN
         LA    R3,REPLY      ADRESSE DES REPLY LADEN
         MVC   WTO(LENMSG08),MSG08 NACHRICHTENZEILE UEBERTRAGEN
         WTOR  ,(R3),1,(R2),                                           *
               MF=(E,WTO)
         SPACE 1
         WAIT  ECB=ECB
         CLI   REPLY,C'Y'    REPLY = YES ?
         BE    OPENINFO      JA, VERZWEIGEN
         CLI   REPLY,C'N'    REPLY = NO ?
         BE    ENDE          JA, VERZWEIGEN
         B     WTORLOOP      VERZWEIGEN
         EJECT
***********************************************************************
*                                                                     *
*      EINEN BLOCK LESEN.                                             *
*                                                                     *
***********************************************************************
         SPACE 3
READINFO EQU   *
         ST    R14,SAVE1R14  RUECKSPRUNGADRESSE SPEICHERN
         MVI   INFOBLK1,X'FF'          BEREICH FUER
         MVC   INFOBLK1+1,INFOBLK1         EINGABEBLOCK
         MVC   INFOBLK2+1(199),INFOBLK2    INITIALISIEREN
         XC    DECB,DECB     DATA EVENT CONTROL BLOCK LOESCHEN
         LA    R2,DECB       ADRESSE DES DECB LADEN
         LA    R3,INFO       ADRESSE DES DCB LADEN
         LA    R6,INFOBLK1   ADRESSE DES EINGABEBEREICHS LADEN
         READ  (R2),SF,(R3),(R6),                                      *
               'S',,,,MF=E
         SPACE 1
         LA    R1,DECB       ADRESSE DES DECB LADEN
         CHECK (R1)          CHECK FOR COMPLETION
         SPACE 1
         LA    R2,INFOBLK1   ADRESSE DES EINGABEBEREICHS LADEN
         LA    R3,5          LOOP COUNTER INITIALISIEREN
         L     R14,SAVE1R14  RUECKSPRUNGADRESSE LADEN
         BR    R14           VERZWEIGEN
         EJECT
***********************************************************************
*                                                                     *
*      ABSCHLUSSROUTINEN.                                             *
*                                                                     *
***********************************************************************
         SPACE 3
*
*      SPEICHERPLATZFREIGABE,
*      REINITIALISIERUNG DER REGISTER UND
*      RUECKSPRUNG ZUM AUFRUFENDEN PROGRAMM.
*
         SPACE 1
ENDE     EQU   *
         XRETURN ,R
         EJECT
***********************************************************************
*                                                                     *
*      FEHLERROUTINEN.                                                *
*                                                                     *
***********************************************************************
         SPACE 3
*
*      ROUTINE BEI FEHLER IN DER PARAMETERKETTE.
*
         SPACE 1
FEHLPARM EQU   *
         L     R0,REG4       UCM-ID DES AUFRUFERS LADEN
         WTO   MF=(E,MSG07)  NACHRICHTENZEILE AUSGEBEN
         B     ENDE          VERZWEIGEN
         SPACE 2
*
*      ROUTINE BEI FIND- UND READ-FEHLER.
*
         SPACE 1
NOHELPAV EQU   *
         MVC   HBYTE(3),=XL3'0' FLAG BYTES LOESCHEN
         MVI   FNDBYTE,X'FF' FLAG BYTE SETZEN
         MVC   WTO(LENMSG05),MSG05 NACHRICHTENZEILE UEBERTRAGEN
         MVC   WTO+31(8),CMDNAME COMMAND NAME UEBERTRAGEN
         B     CLOSINFO      VERZWEIGEN
         SPACE 2
*
*      ROUTINE BEI OPEN-FEHLER DER DIRECTORY.
*
         SPACE 1
OPDRKERR EQU   *
         MVC   WTO(LENMSG04),MSG04 NACHRICHTENZEILE UEBERTRAGEN
         MVC   WTO+12(33),=C'ERROR WHILE OPENING HELP DATA SET'
         L     R0,REG4       UCM-ID DES AUFRUFERS LADEN
         WTO   MF=(E,WTO)    NACHRICHTENZEILE AUSGEBEN
         B     ENDE          VERZWEIGEN
         EJECT
***********************************************************************
*                                                                     *
*      AUSGABE DER COMMAND-NAMEN.                                     *
*                                                                     *
***********************************************************************
         SPACE 3
*
*      DIRECTORY EROEFFNEN.
*
         SPACE 1
OPENDRKT EQU   *
         LA    R1,DCBADDR2   ADRESSE DER DCB-ADRESE LADEN
         SVC   19            VERZW. ZUM EROEFFNEN DER DATEI
         LA    R1,DIRECTRY   LOAD ADDRESS OF DCB
         TM    48(R1),X'10'  OPEN SUCCESSFUL ?
         BZ    OPDRKERR      BRANCH IF NOT
         LA    R14,GETBLKOK  VERZWEIGADRESSE LADEN
         ST    R14,SAVE1R14      UND SPEICHERN
         L     R0,REG4       UCM-ID DES AUFRUFERS LADEN
         WTO   MF=(E,MSG01)  UEBERSCHRIFT AUSGEBEN
         SPACE 2
*
*      DIRECTORY LESEN UND NACHRICHTEN AUSGEBEN.
*
         SPACE 1
GETDRKBL EQU   *
         GET   DIRECTRY      EINEN BLOCK LESEN
         LR    R10,R1        ADRESSE DES DIRECTORY-BLOCKS LADEN
         LH    R9,0(R10)     LAENGE DES DIRECTORY-BLOCKS LADEN
         AR    R9,R10        ENDADRESSE DES DIRECTORY-BLOCKS
         LA    R10,2(R10)    ADRESSE DES ERSTEN ENTRY LADEN
         L     R14,SAVE1R14  VERZWEIGADRESSE LADEN
         BR    R14               UND VERZWEIGEN
GETBLKOK EQU   *
         MVC   WTO(LENMSG01),MSG01 NACHRICHTENZEILE UEBERTRAGEN
         LA    R14,MVCLPOK   NEUE VERZWEIGADRESSE LADEN
         ST    R14,SAVE1R14      UND SPEICHERN
WTOLOOP  EQU   *
         MVC   WTO+12(54),WTO+11 NACHRICHTENZEILE LOESCHEN
         LA    R8,WTO+12     UEBERTRAGUNGSADRESSE LADEN
         LA    R7,6          LOOP COUNTER INITIALISIEREN
         EJECT
MVCLOOP  EQU   *
         CLI   0(R10),X'FF'  ENDE DER DIRECTORY ERREICHT ?
         BE    CLOSDRKT      JA, VERZWEIGEN
         MVC   0(8,R8),0(R10) MEMBER NAME UEBERTRAGEN
         LA    R8,9(R8)      NEUE UEBERTRAGUNGSADRESSE LADEN
         NI    11(R10),X'1F' LAENGENFELD MODIFIZIEREN
         SR    R6,R6         R6 LOESCHEN
         IC    R6,11(R10)    LAENGENFELD LADEN
         SLA   R6,1          LAENGE IN BYTES UMRECHNEN
         LA    R6,12(R6)     LAENGE DES ENTRY BERECHNEN
         AR    R10,R6        ADRESSE DES NAECHSTEN MEMBER NAME
         CR    R10,R9        ENDE DES DIRECTORY-BLOCKS ERREICHT ?
         BE    GETDRKBL      JA, VERZWEIGEN
MVCLPOK  EQU   *
         BCT   R7,MVCLOOP    VERZWEIGEN
         SPACE 1
         L     R0,REG4       UCM-ID DES AUFRUFERS LADEN
         WTO   MF=(E,WTO)    NACHRICHTENZEILE AUSGEBEN
         B     WTOLOOP       VERZWEIGEN
         SPACE 2
*
*      DIRECTORY SCHLIESSEN.
*
         SPACE 1
CLOSDRKT EQU   *
         LA    R1,DCBADDR2   ADRESSE DER DCB-ADRESSE LADEN
         SVC   20            VERZW. ZUM SCHLIESSEN DER DATEI
         SPACE 1
         LA    R9,WTO+12     UEBERTRAGUNGSADRESSE LADEN
         CR    R8,R9         IST NOCH EINE ZEILE AUSZUGEBEN ?
         BE    DIRENDE       NEIN, VERZWEIGEN
         L     R0,REG4       UCM-ID DES AUFRUFERS LADEN
         WTO   MF=(E,WTO)    NACHRICHTENZEILE AUSGEBEN
DIRENDE  EQU   *
         L     R0,REG4       UCM-ID DES AUFRUFERS LADEN
         WTO   MF=(E,MSG02)  NACHRICHTENZEILE AUSGEBEN
         B     ENDE          VERZWEIGEN
         EJECT
***********************************************************************
*                                                                     *
*      REGISTER EQUATES.                                              *
*                                                                     *
***********************************************************************
         SPACE 3
R0       EQU   0             MACRO- UND-PARAMETER REGISTER
R1       EQU   1             MACRO- UND-PARAMETER REGISTER
R2       EQU   2             ARBEITSREGISTER
R3       EQU   3             ARBEITSREGISTER
R4       EQU   4             ARBEITSREGISTER
R5       EQU   5             ARBEITSREGISTER
R6       EQU   6             ARBEITSREGISTER
R7       EQU   7             ARBEITSREGISTER
R8       EQU   8             ARBEITSREGISTER
R9       EQU   9             ARBEITSREGISTER
R10      EQU   10            ARBEITSREGISTER
R11      EQU   11            BASISREG. FUER DSECT PARMAREA
R12      EQU   12            BASISREG. FUER CSECT HELP
R13      EQU   13            BASISREG. FUER DSECT ABER
R14      EQU   14            RUECKSPRUNGADRESSEN
R15      EQU   15            CSECT-ADRESSEN UND RETURN CODES
         EJECT
***********************************************************************
*                                                                     *
*      DEFINITION DER KONSTANTEN-SPEICHER.                            *
*                                                                     *
***********************************************************************
         SPACE 3
CONHIST1 DC    C'HISTORY '
CONSYNT1 DC    C'SYNTAX  '
CONFUNC1 DC    C'FUNCTION'
CONALL   DC    C'ALL'
CONHIST2 DC    C'%%HISTORY. '
CONSYNT2 DC    C'%%SYNTAX.  '
CONFUNC2 DC    C'%%FUNCTION.'
         SPACE 3
*
*      DCB FUER DIE DIRECTORY DER DATEI 'HELPLIB'.
*
         SPACE 1
DCBDIRHL DCB   DDNAME=HELPLIB,                                         *
               DSORG=PS,                                               *
               MACRF=(GL),                                             *
               RECFM=F,                                                *
               LRECL=256,                                              *
               BLKSIZE=256
DCBLEN   EQU   *-DCBDIRHL    LAENGE DES DCB
         SPACE 3
*
*      DCB FUER DIE DATEI 'HELPLIB'.
*
         SPACE 1
DCBHELPL DCB   DDNAME=HELPLIB,                                         *
               DSORG=PO,                                               *
               MACRF=(R),                                              *
               RECFM=FB,                                               *
               LRECL=80,                                               *
               BLKSIZE=400,                                            *
               SYNAD=NOHELPAV,                                         *
               EODAD=CLOSINFO
DCBLEN1  EQU   *-DCBHELPL    LAENGE DES DCB
         EJECT
***********************************************************************
*                                                                     *
*      DEFINITION DER AUSGABENACHRICHTEN.                             *
*                                                                     *
***********************************************************************
         SPACE 3
MSG01    WTO   'XHELP01 THE FOLLOWING COMMANDS ARE AVAILABLE:          *
                      ',                                               *
               MF=L,MCSFLAG=(REG0)
LENMSG01 EQU   *-MSG01
         SPACE 1
MSG02    WTO   'XHELP02 FOR MORE HELP ENTER ''F X,HELP,HELP''',        *
               MF=L,MCSFLAG=(REG0)
         SPACE 1
MSG03    WTO   'XHELP03 FUNCTION OF ABCDEFGH',                         *
               MF=L,MCSFLAG=(REG0)
LENMSG03 EQU   *-MSG03
         SPACE 1
MSG04    WTO   'XHELP04                                                *
                      ',                                               *
               MF=L,MCSFLAG=(REG0)
LENMSG04 EQU   *-MSG04
         EJECT
MSG05    WTO   'XHELP05 HELP ABOUT COMMAND ABCDEFGH NOT AVAILABLE',    *
               MF=L,MCSFLAG=(REG0)
LENMSG05 EQU   *-MSG05
         SPACE 1
MSG06    WTO   'XHELP06 HELP ABOUT FUNCTION OF ABCDEFGH NOT AVAILABLE',*
               MF=L,MCSFLAG=(REG0)
LENMSG06 EQU   *-MSG06
         SPACE 1
MSG07    WTO   'XHELP07 INVALID PARAMETER LIST',                       *
               MF=L,MCSFLAG=(REG0)
         SPACE 1
MSG08    WTOR  'XHELP08 REPLY ''Y'' (YES) OR ''N'' (NO) TO CONTINUE',  *
               MF=L,MCSFLAG=(REG0)
LENMSG08 EQU   *-MSG08
         EJECT
***********************************************************************
*                                                                     *
*      DEFINITION DER ARBEITSBEREICHE.                                *
*                                                                     *
***********************************************************************
         SPACE 3
ABER     DSECT
         SPACE 2
*
*      ADRESSEN-SPEICHER.
*
         SPACE 1
SAVEAREA DS    18F           SAVEAREA FUER ALLGEMEINE REGISTER
SAVE1R14 DS    F             SPEICHER FUER RUECKSPRUNGADRESSEN
DCBADDR1 DS    F             ADRESSE DES DCB FUER INFO-DATEI
DCBADDR2 DS    F             ADRESSE DES DCB FUER DIRECTORY
         SPACE 2
*
*      ARBEITSSPEICHER.
*
         SPACE 1
INFO     DS    0F            DCB FUER DIE INFO-DATEI
         ORG   *+DCBLEN1
DIRECTRY DS    0F            DCB FUER DIE DIRECTORY
         ORG   *+DCBLEN
CMDNAME  DS    D             SPEICHER FUER COMMAND NAME
HBYTE    DS    C             FLAG BYTE FUER HISTORY
SBYTE    DS    C             FLAG BYTE FUER SYNTAX
FBYTE    DS    C             FLAG BYTE FUER FUNCTION
REPLY    DS    C             SPEICHER FUER REPLY
FNDBYTE  DS    C             FLAG BYTE FUER GEF. INFO.
ECB      DS    F             EVENT CONTROL BLOCK
         DS    0F            DATA EVENT
DECB     DS    CL20              CONTROL BLOCK
INFOBLK1 DS    CL200         SPEICHER FUER
INFOBLK2 DS    CL200             EINGABEBLOCK
         SPACE 2
*
*      NACHRICHTEN-BEREICHE.
*
         SPACE 1
WTO      DS    27F           AUSGABEZEILE
         SPACE 1
ABERL    EQU   *-ABER        LAENGE DER ARBEITSBEREICHE
         EJECT
***********************************************************************
*                                                                     *
*      PARAMETERBEREICH.                                              *
*                                                                     *
***********************************************************************
         SPACE 3
         XPARM
PARMENDE EQU   *
         SPACE 3
         END   HELP
./ ADD  NAME=IOS
IOS      TITLE 'X-CMD IOS'
WMMCCABE CSECT ,       CSECT NAME SET TO 'WMMCCABE' BECAUSE OF IOSGEN
*                      CSECT AUTHORIZATION CHECKING
*
         REG   ,                   PROVIDE REGISTER ADDRESSABILITY
         XSAVE R12,,DUMP,WORKL     SAVE REGS AND PROVIDE WORKAREA
         USING WORKAREA,R13        ESTABLISH ADRESSABIILITY OF WKAREA
         LR    R11,R1              ESTABLISH
         USING PARMAREA,R11         ADDRESSABILITY
* SCAN THE ENTERED COMMAND
         CLC   TEXT+4(8),=C'RELEASE,' RELEASE COMMAND?
         LA    R4,XRELEASE         SET
         LA    R3,TEXT+12           ADDRESSES
         BE    SCANUCB               IF YES
         CLC   TEXT+4(7),=C'SIMINT,' SIMULATE INTERRUPT COMMAND?
         LA    R4,XSIMINT          SET
         LA    R3,TEXT+11           ADDRESSES
         BE    SCANUCB               IF YES
         CLC   TEXT+4(9),=C'VARYPATH,' VARY PATH COMMAND?
         LA    R4,XVARY            SET
         LA    R3,TEXT+13           ADDRESSES
         BE    SCANUCB               IF YES
*
*
*
         L     R0,REG4             LOAD UCM-ID
         WTO   'XIOS001 FUNCTION NOT (YET?) PROVIDED',MCSFLAG=REG0
XRETURN  XRETURN ,R                RETURN TO CALLER
*
         EJECT
*
SCANUCB  EQU   *                   EXTRACT UCB INFORMATION
         MVI   SWITCH,C'1'         INITIALIZE SWITCH
         LA    R10,XIOSPRM1        INITIALIZE ADDRESS
         XC    0(2*L'XIOSPRM1,R10),0(R10) CLEAR AREAS
SCANUCB0 CLI   3(R3),C' '          DELIMITER BLANK?
         BE    SCANUCB2            BR IF YES
         CLI   3(R3),C','          DELIMITER KOMMA?
         BE    SCANUCB2            BR IF YES
         CLI   3(R3),C'-'          DELIMITER HYPHEN?
         BE    SCANUCB2            BR IF YES
PARMERR  L     R0,REG4             LOAD UCM-ID
         WTO   'XIOS002 ERROR IN PARAMETER',MCSFLAG=REG0
         B     XRETURN             RETURN TO CALLER
*
SCANUCB2 LA    R0,3                SET BCT COUNT 1
         SR    R6,R6               REG 6 IS TO CONTAIN THE DEVICE ADDR
SCANUCB3 LA    R1,16               SET BCT COUNT 2
         SR    R7,R7               SET COUNT REG TO ZERO
SCANUCB4 IC    R5,HEXCHAR(R7)      INSERT CURRENT HEX CHARACTER
         EX    R5,SCANUCBE         COMPARE TO CURRENT DEV ADDR CHAR
         BE    SCANUCB5            BR IF EQUAL
         LA    R7,1(,R7)           ELSE
         BCT   R1,SCANUCB4          CONTINUE SEARCH
         B     PARMERR             ERROR IF NOT FOUND
SCANUCB5 SLL   R7,28               SHIFT AND
         SLDL  R6,4                LOAD HEX VALUE
         LA    R3,1(,R3)           ADDRESS OF NEXT CHARACTER
         BCT   R0,SCANUCB3         CONTINUE SEARCH
*
         EJECT
         STH   R6,XIOSCUA-XIOSPRM1(,R10) SAVE HEX ADDR
UCBREG   EQU   7
         USING UCBOB,UCBREG
         BAL   R14,XUCBLOOK        VALIDATE UCB ADDRESS
         CLI   0(R3),C'-'          CURRENT DELIMITER HYPHEN?
         BNE   TESTSW2             BR IF NO
         CLI   SWITCH,C'1'         SWITCH IN INITIAL STATUS?
         BNE   PARMERR             BR IF NO
         MVI   SWITCH,C'2'         RESET SWITCH
         LA    R3,1(,R3)           PROCEED TO NEXT UCB ADDRESS
         LA    R10,XIOSPRM2        POINT TO NEXT PARAMETER AREA
         B     SCANUCB2            GO TO PROCESS NEXT UCB ADDRESS
TESTSW2  CLI   SWITCH,C'1'         FIRST CALL?
         BE    SUPSTATE            BR IF YES
         CLC   XIOSNAME(2),XIOSPRM2+XIOSNAME-XIOSPRM1 SAME CU?
         BNE   PARMERR             BR IF NO
         CLC   XIOSCUA,XIOSPRM2+XIOSCUA-XIOSPRM1 1ST < 2ND?
         BNL   PARMERR             BR IF NO
* ENTER SUPERVISOR STATE
SUPSTATE MODESET MODE=SUP          ENTER SUPERVISOR STATE
         MODESET SAVEKEY=(2)       GET CURRENT PSW KEY
         STC   R2,TCBPKF           STORE CURRENT PSW KEY
         BR    R4                  GO TO DESIRED FUNCTION
UCBERROR L     R0,REG4             LOAD UCM-ID
         WTO   'XIOS003 UCB NOT FOUND',MCSFLAG=REG0
         B     XRETURN             RETURN TO CALLER
*
         EJECT
***********************************************************************
*                                                                     *
*        TEST WHETHER RELEASE MAY BE ISSUED AGAINST DEVICE            *
*                                                                     *
***********************************************************************
         SPACE 1
XRELEASE EQU   *
         TM    UCBTBYT3,UCB3DACC   IS THIS A DA DEVICE?
         BZ    XRELSER1            EXIT IF NO
         TM    UCBTBYT2,UCBRR      IF SHARED DASD,
         BZ    XRELSER1            EXIT IF NO
         TM    UCBTBYT2,UCBRVDEV   IF VIRTUAL DEVICE,
         BO    XRELSER1            EXIT IF YES
         SLR   R0,R0               CLEAR FOR INSERT
         IC    R0,UCBSQC           DECREMENT
         BCTR  R0,0                 RESERVE
         LTR   R0,R0               IF RESERVE COUNT ZERO,
         BZ    XRELSEST             GO ISSUE STARTIO
XRELSETU CLC   0(7,R3),=C',UNCOND' UNCOND OPTION GIVEN?
         BNE   XRELSER1            EXIT IF NO
         SLR   R0,R0               CLEAR FOR INSERT
XRELSEST MODESET EXTKEY=ZERO       SET ZERO KEY
         STC   R0,UCBSQC           STORE RESERVE COUNT ZERO
         B     XSTARTIO            GO ISSUE STARTIO
XRELSER1 L     R0,REG4             LOAD UCM-ID
         WTO   'XIOS004 REQUEST CANNOT BE SATISFIED',MCSFLAG=REG0
         B     XRETURN
*
         EJECT
***********************************************************************
*                                                                     *
*        OBTAIN FIXED GLOBAL STORAGE FOR STARTIO-RELEASE SRB/IOSB     *
*                                                                     *
***********************************************************************
         SPACE 1
XSTARTIO GETMAIN R,LV=SRBSIZE+IOSEND-IOSB,SP=245  GET FIXED GLOBAL
         ST    R1,SP245WA           STORAGE FOR RELEASE SRB-IOSB
         XC    0(SRBSIZE+IOSEND-IOSB,R1),0(R1)  ZERO
         LA    R15,SRBSIZE(,R1)    GET IOSB ADDRESS
         ST    R15,SRBPARM-SRB(,R1)  STORE IN SRB
         USING IOSB,R15            IOSB ADDRESSABILITY
         L     R8,CVTPTR           LOAD CVT ADDRESS
         USING CVT,R8              ESTABLISH CVT ADDRESSABILITY
         LA    R9,CVTBRET          LOAD ADDRESS OF BR 14
         OI    IOSOPT,IOSBYP+IOSRELSE+IOSPSLL  SET IOS OPTION BITS
         MVI   IOSDVRID,IOSMISID   SET MISCELLANEOUS DRIVER ID
         MVI   IOSASID+1,1         SET ASID OF ONE
         ST    UCBREG,IOSUCB       SAVE VOLUME UCB ADDRESS
         ST    R9,IOSPGAD          POINT TERMINATION TO BR 14
         ST    R9,IOSNRM           POINT NORMAL EXIT TO BR 14
         ST    R9,IOSABN           POINT ABNORMAL EXIT TO BR 14
         SPACE 1
         DROP  R15                 KILL IOSB ADDRESSABILITY
*
         EJECT
***********************************************************************
*                                                                     *
*        ISSUE STAND-ALONE RELEASE COMMAND AGAINST DEVICE             *
*                                                                     *
***********************************************************************
         SPACE 1
         STM   R13,R12,8(R13)      SAVE REGISTERS THRU STARTIO
         LR    R9,R13              COPY R13
GETLOCL  SETLOCK OBTAIN,TYPE=LOCAL,MODE=UNCOND,RELATED=(FREELOCL)
GETCMSL  SETLOCK OBTAIN,TYPE=CMS,MODE=UNCOND,RELATED=(FREECMSL)
         LR    R13,R9              RELOAD R13
         L     R1,SP245WA          POINT TO SRB FOR STARTIO
         STARTIO SRB=(1)           REMOVE RESERVE ON SPECIFIED VOLUME
         LR    R9,R13              COPY R13
FREECMSL SETLOCK RELEASE,TYPE=CMS,RELATED=(GETCMSL)
FREELOCL SETLOCK RELEASE,TYPE=LOCAL,RELATED=(GETLOCL)
         LM    R13,R12,8(R9)       RESTORE REGISTERS
         EJECT
         MODESET EXTKEY=TCB,WORKREG=1  RETURN TO NZERO PROTECT KEY
         SPACE 1
         L     R0,REG4             LOAD UCM-ID
         WTO   'XIOS005 RELEASE HAS BEEN ISSUED',MCSFLAG=REG0
*
XRELSEWT STIMER WAIT,BINTVL=FIVESEC WAIT 5 SECONDS
         L     R9,SP245WA          LOAD ADDRESS OF SRB-IOSB
         USING IOSB-SRBSIZE,R9
         MVC   WTOAREA(XMSG006L),XMSG006 MOVE MSG SKELETON
         UNPK  WTOAREA+30(3),IOSCOD(2) UNPACK
         TR    WTOAREA+30(2),HEXCHAR-240 & EDIT IOSCOD
         L     R0,REG4             LOAD UCM-ID
         WTO   MF=(E,WTOAREA)      WRITE TO OPERATOR
         TM    IOSCOD,X'7F'        IO COMPLETE?
         BZ    XRELSEWT            BR IF NO
         BNO   XRETURN             BR IF IO COMPLETE BUT NOT SUCCESSFUL
         DROP  R9
         FREEMAIN R,A=(R9),LV=SRBSIZE+IOSEND-IOSB,SP=245 FREE SRB-IOSB
         B     XRETURN             EXIT
*
         EJECT
***********************************************************************
*                                                                     *
*        INVOKE "IOSGEN,SIMINT,UCB=(.),REG=(.)"                       *
*                                                                     *
***********************************************************************
         SPACE 1
XSIMINT  EQU   *
         MODESET EXTKEY=ZERO       SET ZERO KEY
         IOSGEN SIMINT,UCB=(R7),REG=(R9) INVOKE IOSGEN PROCEDURE
         MODESET EXTKEY=TCB,WORKREG=1  RETURN TO NZERO PROTECT KEY
         SPACE 1
         L     R0,REG4             LOAD UCM-ID
         WTO   'XIOS007 SIMINT HAS BEEN ISSUED',MCSFLAG=REG0
         B     XRETURN             EXIT
*
         EJECT
***********************************************************************
*                                                                     *
*        INVOKE "IOSGEN,VARY,TABLE=(.)"                               *
*                                                                     *
***********************************************************************
         SPACE 1
XVARY    EQU   *
         CLI   0(R3),C','          DELIMITER KOMMA?
         BNE   PARMERR             BR IF NO
         CLC   1(2,R3),=C'0,'      CPU 0 ADDRESSED?
         BE    XVARYNXT            BR IF YES
         CLC   1(2,R3),=C'1,'      CPU 1 ADDRESSED?
         BNE   XVARYPA             BR IF NO
         MVI   XIOSCPU,1           INDICATE CPU 1
XVARYNXT LA    R3,2(,R3)           ACCOUNT FOR CPU-ID
         B     XVARYOFF            GO TO PROCESS ON-OFF REQUEST
XVARYPA  MVC   XIOSCPU,X'205'(0)   GET PHYSICAL CPU ADDRESS FROM PSA
XVARYOFF CLC   1(3,R3),=C'OFF'     REQUEST VARY OFFLINE?
         BNE   XVARYONL            BR IF NO
         CLC   4(7,R3),=C',UNCOND' REQUEST UNCOND?
         BE    XVARYUNC            BR IF YES
         CLC   8(7,R3),=C',UNCOND' REQUEST UNCOND?
         BNE   XVARYINV            BR IF NO
XVARYUNC MVI   XIOSID,X'80'        INDICATE VARY OFFLINE,UNCOND
         B     XVARYINV
XVARYONL CLC   1(2,R3),=C'ON'      REQUEST VARY ONLINE?
         BNE   PARMERR             BR IF NO
         MVI   XIOSID,X'04'        INDICATE VARY ONLINE
XVARYINV LA    R10,XIOSPRM1        ADDRESS OF VARY TABLE
         MODESET EXTKEY=ZERO       GET KEY ZERO
         A     R13,=F'8'           VARY WOULD DESTROY SA ADDR
         IOSGEN VARY,TABLE=(R10)   INVOKE IOSGEN-VARY FUNCTION
         S     R13,=F'8'           SET TO OLD ADDRESS
         MODESET EXTKEY=TCB,WORKREG=1 RETURN TO NONZERO PROTECT KEY
         L     R1,MSGADDR(R15)     LOAD ADDRESS OF MSG TO BE SEND
         MVC   WTOAREA,0(R1)       MOVE MSG SKELETON
         UNPK  WTOAREA+22(4),XIOSCUA(3) UNPACK
         TR    WTOAREA+22(3),HEXCHAR-240 & EDIT PATH ADDRESS
         MVI   WTOAREA+25,C')'     REFRESH 4. CHARACTER
         L     R0,REG4             GET UCM-ID
         WTO   MF=(E,WTOAREA)      SEND LINE TO OPERATOR
         LH    R6,XIOSCUA          LOAD CHANNEL-UNIT ADDRESS
         LA    R6,1(,R6)           GET NEXT CUA
         CH    R6,XIOSPRM2+XIOSCUA-XIOSPRM1 COMPARE TO LAST PATH
         BH    XRETURN             BR IF HIGH
         STH   R6,XIOSCUA          SAVE NEW CUA
         BL    XVARYNPA            BR IF LOW
         MVC   XIOSNAME,XIOSPRM2+XIOSNAME-XIOSPRM1 MOVE EBCDIC ADDR
         B     XVARYINV            GO TO PROCESS VARY REQUEST
*
XVARYNPA BAL   R14,XUCBLOOK        VALIDATE NEXT UCB ADDRESS
         B     XVARYINV            GO TO PROCESS VARY REQUEST
*
         EJECT
XUCBLOOK A     R13,=F'8'           UCBLOOK WOULD DESTROY SA ADDRESS
         IOSGEN UCBLOOK            LOCATE THE UCB
         S     R13,=F'8'           SET TO OLD ADDRESS
         LTR   R15,R15             TEST RETURN CODE FROM UCBLOOK
         BNZ   UCBERROR            EXIT IF DEVICE ADDRESS INVALID
         MVC   XIOSNAME-XIOSPRM1(3,R10),UCBNAME SAVE EBCDIC ADDR
         BR    R14                 RETURN
         EJECT
HEXCHAR  DC    C'0123456789ABCDEF' HEXCHAR TAB
FIVESEC  DC    F'500'              500 UNITS OF .01 SEC
SCANUCBE CLI   0(R3),*-*           *** EXECUTE ONLY ***
XMSG006  WTO   'XIOS006 RELEASE POST CODE XX',MCSFLAG=REG0,MF=L
XMSG006L EQU   *-XMSG006           LENGTH OF MSG
MSGADDR  DC    A(XMSG010)          ADDRESS OF SUCCESSFUL VARY
         DC    A(XMSG011)          ADDRESS OF SUCCESSFUL VARY UNCOND
         DC    A(XMSG012)          ADDRESS OF UNSUCCESSFUL VARY OFF
         DC    A(XMSG013)          ADDRESS OF NOT A VALID PATH
         DC    A(0)                ADDRESS OF UCB CANNOT BE FOUND
         DC    A(XMSG014)          ADDRESS OF PATH IS RESERVED
XMSG010  WTO   'XIOS010 VARY PATH(...) SUCCESSFUL',MCSFLAG=REG0,MF=L
XMSG011  WTO   'XIOS011 VARY PATH(...) SUCCESSFUL - LAST PATH OFFLINE',X
               MCSFLAG=REG0,MF=L
XMSG012  WTO   'XIOS012 VARY PATH(...) DENIED, WOULD REMOVE LAST PATH',X
               MCSFLAG=REG0,MF=L
XMSG013  WTO   'XIOS013 VARY PATH(...) DENIED - NOT A VALID PATH',     X
               MCSFLAG=REG0,MF=L
XMSG014  WTO   'XIOS014 VARY PATH(...) DENIED - PATH RESERVED',        X
               MCSFLAG=REG0,MF=L
*
WORKAREA DSECT
SAVEAREA DS    18F                 18 WORD SAVEAREA
DWORD    DS    D                   WORK
FWORD    DS    F                   WORK
HWORD    DS    H                   WORK
SWITCH   DS    X                   WORK
TCBPKF   DS    X                   SAVE AREA FOR TCB PROTECT KEY
WTOAREA  DS    CL76                WTO AREA
SP245WA  DS    A                   ADDRESS OF STARTIO SRB-IOSB
XIOSPRM1 DS    0D                  UCB-1 PARAMETERS
XIOSCUA  DS    H                   CHANNEL-UNIT ADDRESS OF DEVICE
XIOSID   DS    X                   FUNCTION ID
XIOSCPU  DS    X                   ADDRESS OF CPU
XIOSRES  DS    X                   RESERVED
XIOSNAME DS    CL3                 UCB ADDRESS IN EBCDIC
XIOSPRM2 DS    D                   UCB-2 PARAMETERS
*
WORKL    EQU   *-WORKAREA
         XPARM
*
         PRINT NOGEN
         CVT   DSECT=YES
         IEFUCBOB
         IECDIOCM
         IECDIOCX
         IECDIOSB
         IHAPSA
         IHASRB
         END
./ ADD  NAME=KEYSCAN
         TITLE '*** KEYSCAN ***  GENERAL INFORMATION.'
* THIS PROGRAM ANALYSES A HEADER RECORD AND BUILDS UP
* A TABLE WHICH ADDRESS IS PASSED IN REGISTER 1.
* IT IS USED AS A SUBPROGRAM BY  :
*        CALL  KEYSCAN,(HEADER)
         SPACE 2
* FORM OF HEADER :  (ON A HALFWORD BOUNDARY)
         SPACE 1
* H1     DC    H'XX,0'   XX = LENGTH OF HEADER INCLUDING
*                             2 BYTES LENGTH, 2 BYTES ZEROES
*        DC    C'KEY1=PARM1,KEY2=PARM2,.....'
         SPACE 2
* FORM OF TABLE :   (ON A DOUBLEWORD BOUNDARY)
         SPACE 1
*        LLLL       LENGTH OF TABLE    (HEX)
*        LL         LENGTH OF KEYWORD  (HEX)
*        CC...      KEYWORD            (CHAR)
*        X'40'      ONLY IF KEYLENGTH WAS EVEN, OTHERWISE MISSING
*        YYYY       OFFSET OF KEYWORD IN HEADER  (HEX)
*        ZZZZ       LENGTH OF PARM    IN HEADER  (HEX)
*        ....
*        X'FFFF'    TABLE END SIGN
         SPACE 3
* EXAMPLE OF USE
         SPACE 2
* H1     DC    H'31,0'
*        DC    CL27'Q=ABC,D=''X=''Z'',F,R=(80,10)'
         SPACE 1
* AFTER CALLING KEYSCAN R1 POINTS AT THE FOLLOWING TABLE :
* X'001C01D9 00160007 01C60014 000001C4 000A0007 01D80004 0003FFFF'
         SPACE 3
* WHILE CREATING A HEADER THE USER SHOULD FOLLOW THE RULES OF THE JCL
* THE FOLLOWING RECORDS WOULD BE INCORRECT :
         SPACE 1
* X'00030000' C'X=1'                         WRONG LENGTH
* X'00120000' C'AB=(80,5)),B=C'              WRONG USE OF APOSTROPHEES
* X'00090000' C'R=A=4'                       = NOT INSIDE APOSTROPHEES
* X'00080000' C' X=1'                        1ST CHARACTER IS BLANK
*                   (A BLANK IS ALWAYS INTERPRETED AS END OF RECORD)
         SPACE 3
* AFTER RETURN REGISTER 15 SHOULD CONTAIN ZEROES :  ALL OK
* IF REGISTER 15 CONTAINS 4, AN ERROR WAS DETECTED
         TITLE '*** KEYSCAN ***  EQUATE SUYMBOLS, REGISTER USE'
KEYSCAN  CSECT
         SPACE 2
* EQUATE SYMBOLS
*        USE OF REGISTERS
         SPACE 1
* REG 12 USED AS BASE REGISTER FOR HDRSCANV
* REG 13 USED AS BASE REGISTER FOR DSECT
* REG 11 USED AS COUNTER FOR PARENTHESIS
* REG 9  USED AS COUNTER FOR NOAPS
* REG 5  USED AS VARIABLE LENGTH FOR TRT BY EX
         SPACE 1
H        EQU   3         POINTER THROUGH HEADER
T        EQU   4         POINTER THROUGH TABLE
W1       EQU   6         WORK REGISTER 1
W2       EQU   7         WORK REGISTER 2
W3       EQU   8         WORK REGISTER 3
LL       EQU   10        TABLE LENGTH
         SPACE 1
*        EXPLANATION OF BITS SET IN SW
         SPACE 1
PAR      EQU   X'01'     ON WHILE SCANNING A PARAMETER OF THE HEADER
KEY      EQU   X'02'     ON WHILE SCANNING A KEYWORD   OF THE HEADER
LPA      EQU   X'04'     ON WHEN LEFT PARENTHESIS OCCURED
RPA      EQU   X'08'     ON WHEN RIGHT PARENTHESIS OCCURED
FIN      EQU   X'10'     ON WHEN END OF HEADER WAS FOUND
         TITLE '*** KEYSCAN ***  CHAINING SAVE AREAS, START OF PROGRAM'
         XSAVE 12,,KEYSCAN,DUMEND-DUM
         USING DUM,13
         L     H,0(1)              LOAD HDR LENGTH ADDRESS
         LH    W1,0(H)             LOAD LENGTH
         SH    W1,=H'4'            IT MUST BE > 4, ELSE ERROR
         BNP   ERROR0
         ST    H,HSA               SAVE HDR START ADDRESS
         LA    H,4(H)              SET H ON 1ST KEYWORD
         ST    H,KEYADDR           SAVE H AS ADDR OF 1ST KEYWORD
         CLI   0(H),C' '           1ST CHAR BLANK ?
         BE    ERROR0
         LR    5,H
         AR    5,W1                FIND END OF HDR + 1
         BCTR  5,0                 (EX)
         ST    5,HEA               SAVE HEADER END ADDRESS
         MVI   SW,X'00'            CLEAR SWITCH
         OI    SW,KEY
         SPACE 2
         LH    T,=H'800'
         GETMAIN R,LV=(T)  GET MAX OF STORAGE THAT COULD BE REQUESTED
         ST    1,TABSTART          SAVE TABLE START ADDRESS
         AR    T,1                 FIND END OF TABLE
         SH    T,=H'2'             DECREASE T BY 2
         LA    LL,2                LL = 2
         MVC   0(2,T),=X'FFFF'     SET TABLE END SIGN
         XC    NOAP,NOAP           CLEAR NO. OF APOSTROPHEES
         SR    2,2                 CLEAR REG2 (BECAUSE OF TRT)
         SR    9,9                 CLEAP COUNTER FOR NOAP
         SR    11,11               CLEAR COUNTER FOR PARENTHESES
         TITLE '*** KEYSCAN ***  ANALYSING HEADER'
TRTSTART L     5,HEA               FIND LENGTH FOR TRT INSTRUCTION
         SR    5,H                 SUBTRACT TRT- START ADDR
         LTR   5,5
         BM    SETR1               IF MINUS, END OF HEADER FOUND
         EX    5,TRT              FIND NEXT BYTE OF TRTTAB NOT ZERO
         BZ    SETR1               NOTHING LEFT
         CLI   0(1),C'='
         BE    EQSIGN              T E S T
         CLI   0(1),C','               F O U N D
         BE    COMMA                       B Y T E
         CLI   0(1),C' '
         BE    BLANK
         TM    SW,KEY              IF NO = PROCESSING MUST BE IN
         BO    ERROR                                   PARMSTATE
         CLI   0(1),C''''
         BE    APOS
         CLI   0(1),C'('
         BE    LEFTPAR
         B     RIGPAR
         SPACE 2
EQSIGN   TM    NOAP+1,X'01'        = INSIDE APOSTROPHEES
         BO    SETH                IF YES SKIP SAVING KEY
         TM    SW,PAR              PROCESSING IN PARM STATE ?
         BO    ERROR               IF YES :  ERROR
         OI    SW,PAR              SET PARM BIT
         NI    SW,255-KEY          CLEAR KEY BIT
         SPACE 1
         ST    1,ADDREQ            SAVE ADDR OF EQ SIGN
         SR    1,H
         STH   1,KEYLEN            SAVE LENGTH OF THIS KEYWORD
         LA    H,1(1,H)            SET H ON FOUND ADDR + 1
         B     TRTSTART
         SPACE 1
APOS     LA    9,1(9)              APOSTROPH  FOUND, COUNTER + 1
         STH   9,NOAP              SAVE NUMBER
         B     SETH
         SPACE 1
LEFTPAR  EQU   *
         TM    NOAP+1,X'01'        IF NOAP UNEVEN LEFT PAREN
         BO    SETH                MAY BE CHAR INSIDE APOSTROPHEES
         LTR   11,11               TEST IF ( HAD OCCURED EARLIER
         BNZ   ADD1                IF YES SKIP NEXT TEST
         LR    W1,1
         BCTR  W1,0
         CLI   0(W1),C'='
         BNE   ERROR
         OI    SW,LPA              SET SW FOR LEFT PAREN
ADD1     LA    11,1(11)            R11 + 1
         B     SETH
         SPACE 1
RIGPAR   EQU   *
         TM    NOAP+1,X'01'        IF NOAP UNEVEN RIGHT PAREN
         BO    SETH                MAY BE INSIDE APOSTROPHEES
         TM    SW,LPA              IF NOT THERE MUST HAVE BEEN
         BZ    ERROR               A LEFT PAREN, ELSE :  ERROR
         OI    SW,RPA              SET RIGHT PAREN BIT
         BCTR  11,0                R11 - 1
         LTR   11,11               PROCESSING STILL INSIDE PARENS ?
         BNZ   SETH
         L     W1,HEA
         SR    W1,1                TEST, IF ) IS FOLLOWED BY ,
         BZ    *+12
         CLI   1(1),C','
         BNE   ERROR
         NI    SW,255-LPA          CLEAR LPA BIT
         SPACE 2
SETH     LA    H,1(1)              SET H
         TM    SW,FIN
         BO    ERROR
         B     TRTSTART
         SPACE 2
BLANK    BAL   W2,TESTLAST         BLANK FOUND :  END OF HEADER
         B     SETLAST
         SPACE 2
TESTLAST LR    W1,1
         BCTR  W1,0                TEST CHARACTER AT HEADER END
         CLI   0(W1),C','
         BE    ERROR
         CLI   0(W1),C'='
         BE    ERROR
         BR    W2
         TITLE '*** KEYSCAN *** END OF 1 PARM, FILLING TABLE '
SETR1    L     1,HEA               MAKE R1 POINT AT HEA + 1
         LA    1,1(1)
SETLAST  OI    SW,FIN              SET END OF HEADER BIT
COMMA    TM    SW,LPA              COMMA FOUND. END OF ONE PARM, IF
         BO    SETH                 IT IS NOT INSIDE OF PARENS
         TM    NOAP+1,X'01' NO OF APOS. IN PARM FIELD MUST BE EVEN
         BO    ERROR
         LTR   11,11               TEST IF NO. OF ( WAS EQUAL TO NO. OF
         BNZ   ERROR
         LA    H,1(1)              SET H
         TM    SW,FIN
         BZ    *+8
         BAL   W2,TESTLAST
         LR    W1,1                TEST IF ) WAS JUST BEFORE
         BCTR  W1,0                  COMMA
         CLI   0(W1),C','          TWO COMMAS ?
         BE    SVKEYAD             IF YES :  IGNORE ONE
         CLI   0(W1),C'='          = BEFORE ,
         BE    ERROR               IF YES :  ERROR
         TM    SW,RPA              WAS ) IN PARM ?
         BZ    GETOFF              IF NO SKIP NEXT STATEMENTS
         TM    SW,FIN
         BO    GETOFF
         CLI   0(W1),C')'          IF NOT: ERROR
         BNE   ERROR
GETOFF   EQU   *                   GET OFFSET
         L     W1,KEYADDR          LOAD ADDR OF KEYWORD
         S     W1,HSA              SUBTRACT HEADER START ADDR
         STH   W1,OFF              SAVE DIFFERENCE AS OFFSET
         TM    SW,KEY              PROCESSING STILL IN KEY STATE ?
         BO    NOPAR
         S     1,ADDREQ            R1 = LENGTH OF PARM
         BCTR  1,0                 OFF = OFFSET KEYWORD IN TABLE
         B     FILTAB
NOPAR    EQU   *                   HEADER WAS : ...,KEY,... (NO PARM)
         S      1,KEYADDR
         STH   1,KEYLEN
         SR    1,1                 PARM LENGTH IS ZERO
FILTAB   EQU   *
         TM    KEYLEN+1,X'01'      KEYLEN EVEN ?
         BO    *+10                --- IF NO SKIP
         BCTR  T,0                   ×  NEXT     STATEMENT
         LA    LL,1(LL)              ×
         SH    T,KEYLEN            <--  DECREASE T BY KEYLEN
         SH    T,=H'5'             2 OFFSET, 2 LEN PARM, 1 LEN KEY
         AH    LL,KEYLEN           ADD KEYLENGTH TO TABLE LENGTH
         LA    LL,5(LL)
         L     W1,KEYADDR          SET W1 ON KEYWORD
         LH    W3,KEYLEN           LOAD IT'S LENGTH
         STC   W3,0(T)             STORE IT INTO 1ST BYTE
         BCTR  W3,0                W3 = W3 - 1 (BECAUSE OF EX)
         EX    W3,MOVEKEY          MOVE KEYWORD INTO TABLE
         TM    KEYLEN+1,X'01'      WERE NO. OF CHAR EVEN ?
         BO    NOBLANK             ---  IF NO SKIP
         LR    W1,W3                 ×  FILLING ONE BYTE WITH A BLANK
         AR    W1,T                  ×
         MVI   2(W1),X'40'           ×
         LA    W3,1(W3)              ×
NOBLANK  LH    W1,OFF              <--
         STH   W1,2(W3,T)          STORE OFFSET INTO TABLE
         STH   1,4(W3,T)           STORE LENGTH INTO TABLE
SVKEYAD  ST    H,KEYADDR           SAVE ADDR OF  KEYWORD
         SPACE 1
         XC    NOAP,NOAP
         SR    9,9                 CLEAR COUNTER FOR NOAPS
         NI    SW,255-LPA-RPA-PAR  CLEAR BITS
         OI    SW,KEY              NOW AGAIN A KEYWORD IS TO BE FOUND
         TM    SW,FIN              WAS LAST PARM ?
         BZ    TRTSTART            IF NO, TRY TO FIND NEXT
         SH    T,=H'2'             DECREASE T BY 2
         LA    LL,2(LL)            LL + 2
         STH   LL,0(T)             SAVE IT AT BEGINNING OF TABLE
         SPACE 2
         STH   T,SHIFT             SAVE RIGHT HALF OF TABLE ADDRESS
         MVI   SHIFT,X'00'
         NI    SHIFT+1,X'07'       GET   0000 0XXX
         SH    T,SHIFT             SET T AT A DOUBLEWORD BOUNDARY
         LR    W1,T
         MVC   MOVETAB+5(1),SHIFT+1    STORE DIFFERENCE INTO MOVETAB
MOVETAB  MVC   0(1,W1),0(W1)           AS DISPL OF 2ND OPERAND
         LA    W1,1(W1)
         BCT   LL,MOVETAB          SHIFT LEFT WHOLE TABLE
         SPACE 1
         SR    15,15               CLEAR REG 15, ALL OK
GETBACK  EQU   *
         L     1,TABSTART          LA OF 1ST GETMAINED BYTE
         LR    0,T                 LOAD TABLE ADDR
         SR    0,1                 GET DIFFERENCE
         FREEMAIN R,LV=(0),A=(1)   FREE UNUSED AREA
         L     1,4(0,13)          GET HSA ADDR
         ST    T,24(0,1)     STORE TAB ADDR INTO SA AS REG 1
XRET     XRETURN (15),R
ERROR0   LA    15,4                ERROR, BUT NO FREMAIN
         B     XRET
ERROR    LA    15,4                ERROR FOUND. SET REG 15 ON 4
         B     GETBACK
         TITLE '*** KEYSCAN ***  TRANSLATE AND TEST TABLE, DSECT'
TRTTAB   DC    256X'00'
         ORG   TRTTAB+64
         DC    C' '                BLANK
         ORG   TRTTAB+77
         DC    C'('                LEFT PAREN  (
         ORG   TRTTAB+93
         DC    C')'                RIGHT PAREN )
         ORG   TRTTAB+107
         DC    C','                COMMA       ,
         ORG   TRTTAB+125
         DC    C'''='              APOSTROPHEE '  EQUAL SIGN =
         ORG   TRTTAB+256
         SPACE 2
MOVEKEY  MVC   1(0,T),0(W1)        MOVE KEYWORD INTO TABLE
TRT      TRT   0(0,H),TRTTAB       FIND NEXT BYTE IN TRTTAB NOT ZERO
         LTORG
         SPACE 2
DUM      DSECT
SAVEAREA DS    18F
HSA      DS    F                   HEADER START ADDRESS
HEA      DS    F                   HEADER END ADDRESS
TABSTART DS    F                   ADDR OF 1ST GETMAINED BYTE
ADDREQ   DS    F                   ADDR OF = BEHIND KEYWORD
KEYADDR  DS    F                   ADDR OF KEYWORD
OFF      DS    H                   OFFSET OF PARM IN HEADER
NOAP     DS    H                   NO. OF APOSTROPHEES
KEYLEN   DS    H                   LENGTH OF KEYWORD
SHIFT    DS    H                   USED FOR SHIFTING TABLE
SW       DS    CL1
DUMEND   EQU   *
         END
./ ADD  NAME=LIST
         TITLE 'XLIST                             X-COMMAND LIST'
LIST     CSECT
         SPACE 3
***********************************************************************
*                                                                     *
*      PROGRAM-ID. LIST.                                              *
*      AUTHOR. EHNERT.                                                *
*      INSTALLATION. BAYER AG, LEVERKUSEN, RECHENZENTRUM.             *
*      DATE-WRITTEN. 23. 4. 1975.                                     *
*      REMARKS.                                                       *
*                                                                     *
*          DAS X-COMMAND 'LIST' GIBT DEN INHALT DER ALS PARAMETER     *
*          SPEZIFIZIERTEN DATEI AUS, DIE SOWOHL SEQUENTIELL ALS       *
*          AUCH MEMBER EINER PO-ORGANISIERTEN DATEI SEIN KANN. DIE    *
*          LAENGE SOWIE DAS FORMAT DER SAETZE IST BELIEBIG.           *
*                                                                     *
*          ALS WEITERE PARAMETER KOENNEN ZUSAETZLICH 'L' ODER 'LONG'  *
*          SOWIE EINE VOLUME SERIAL NUMBER ANGEGEBEN WERDEN.          *
*          WIRD 'L' ODER 'LONG' ANGEGEBEN, SO WERDEN ALLE STELLEN     *
*          EINES DATENSATZES, ANDERENFALLS MAXIMAL 54 STELLEN AUS-    *
*          GEGEBEN. WIRD EINE VOLUME SERIAL NUMBER SPEZIFIZIERT, SO   *
*          WIRD DIE DATEI AUF DIESER PLATTE GESUCHT, ANDERENFALLS     *
*          GELTEN DIE INFORMATIONEN AUS DEM CATALOG.                  *
*                                                                     *
*          DAS PROGRAMM GIBT JEWEILS 10, BEIM PARAMETER 'LONG' MIN-   *
*          DESTENS 10 ZEILEN AUS. DANACH KANN DIE ANLISTUNG ABGE-     *
*          BROCHEN ODER AN EINER BELIEBIGEN STELLE DER DATEI FORT-    *
*          GEFUEHRT WERDEN.                                           *
*                                                                     *
*          DURCH DIE NOTWENDIGE DYNAMIC ALLOCATION , DIE IM EXTER-    *
*          NEN UNTERPROGRAMM 'DYNALC' DURCHGEFUEHRT WIRD, KANN DAS    *
*          X-COMMAND 'LIST' NUR IM SYSTEM OS/VS2 (MVS) VERWENDET      *
*          WERDEN.                                                    *
*                                                                     *
***********************************************************************
         EJECT
***********************************************************************
*                                                                     *
*      BEGINN DER VERARBEITUNG.                                       *
*                                                                     *
***********************************************************************
         SPACE 3
*
*      SICHERN DER REGISTER,
*      SPEICHERPLATZANFORDERUNG FUER ARBEITSBEREICHE,
*      ZUORDNUNG DER BASISREGISTER.
*
         SPACE 1
         XSAVE R12,,LIST,ABERL
         SPACE 1
         LR    R11,R1        BASISREG. FUER DSECT PARMAREA INIT.
         USING PARMAREA,R11  BASISREG. FUER DSECT PARMAREA ZUORDNEN
         USING ABER,R13      BASISREG. FUER DSECT ABER ZUORDNEN
         EJECT
*
*      ABFRAGE DES SYSTEMS.
*
         SPACE 1
         L     R2,16         ADRESSE DER CVT LADEN
         TM    116(R2),X'01' SYSTEM = OS/VS2 (MVS) ?
         BO    INIT          JA, VERZWEIGEN
         L     R0,REG4       MCS-ID DER CONSOLE LADEN
         WTO   MF=(E,MSG04)  FEHLERNACHRICHT AUSGEBEN
         B     ENDE          VERZW. ZUM ABSCHLUSS DER VERARBEITUNG
         SPACE 2
*
*      INITIALISIERUNG DER SPEICHER.
*
         SPACE 1
INIT     EQU   *
         MVI   DSNAME,C' '   SPEICHER FUER DATA SET NAME, MEMBER NAME
         MVC   DSNAME+1(57),DSNAME UND VOLUME SERIAL NUMBER LOESCHEN
         MVI   LONGBYTE,X'00' FLAG BYTE LOESCHEN
         LA    R2,54          MAX. UEBERTRAGUNGS-LAENGE LADEN
         ST    R2,RECLEN          UND SPEICHERN
         XC    REPLY,REPLY    REPLY LOESCHEN
         EJECT
***********************************************************************
*                                                                     *
*      VERARBEITUNG DER EINGABEPARAMETER.                             *
*                                                                     *
***********************************************************************
         SPACE 3
GETPARM  EQU   *
         CLI   TEXT+4,C','   PARAMETER ANGEGEBEN ?
         BNE   FEHLPARM      NEIN, VERZWEIGEN
         SPACE 2
*
*      VERARBEITUNG DES DATA SET NAME.
*
         SPACE 1
         LA    R2,TEXT+4     ADRESSE DES TRENNUNGSZEICHENS LADEN
         SR    R3,R3         LAENGENZAEHLER LOESCHEN
DSNLOOP  EQU   *
         LA    R2,1(R2)      ADRESSE DES NAECHSTEN ZEICHENS LADEN
         CLI   0(R2),C' '    ENDE DER PARAMETERKETTE ERREICHT ?
         BE    ENDDSNLP      JA, VERZWEIGEN
         CLI   0(R2),C','    ENDE DES DATA SET NAME ERREICHT ?
         BE    ENDDSNLP      JA, VERZWEIGEN
         CLI   0(R2),C'('    DATA SET = MEMBER EINER PO-DATEI ?
         BE    ENDDSNLP      JA, VERZWEIGEN
         LA    R3,1(R3)      LAENGENZAEHLER ERHOEHEN
         CH    R3,=H'44'     MAXIMALE LAENGE UEBERSCHRITTEN ?
         BH    FEHLPARM      JA, VERZWEIGEN
         B     DSNLOOP       VERZWEIGEN
         SPACE 1
ENDDSNLP EQU   *
         LTR   R3,R3         LAENGE DES DSNAME = 0 ?
         BZ    FEHLPARM      JA, VERZW. ZUR FEHLERROUTINE
         BCTR  R3,0          R3 UM EINS VERMINDERN
         EX    R3,MVCDSN     VERZW. ZUM UEBERTR. DES DSNAME
         EJECT
*
*      VERARBEITUNG DES MEMBER NAME.
*
         SPACE 1
         CLI   0(R2),C'('    MEMBER SPEZIFIZIERT ?
         BNE   GETNPARM      NEIN, VERZWEIGEN
         LA    R3,2(R3)      LAENGENZAEHLER ERHOEHEN
         SR    R4,R4         LAENGENZAEHLER LOESCHEN
         LR    R5,R2         ADRESSE DES TRENNUNGSZEICHENS LADEN
MBRLOOP  EQU   *
         LA    R2,1(R2)      ADRESSE DES NAECHSTEN ZEICHENS LADEN
         CLI   0(R2),C')'    ENDE DES MEMBER NAME ERREICHT ?
         BE    ENDMBRLP      JA, VERZWEIGEN
         LA    R4,1(R4)      LAENGENZAEHLER ERHOEHEN
         CH    R4,=H'8'      MAXIMALE LAENGE UEBERSCHRITTEN ?
         BH    FEHLPARM      JA, VERZW. ZUR FEHLERROUTINE
         LA    R3,1(R3)      LAENGENZAEHLER ERHOEHEN
         B     MBRLOOP       VERZWEIGEN
         SPACE 1
ENDMBRLP EQU   *
         LTR   R4,R4         LAENGE DES MEMBER NAME = 0 ?
         BZ    FEHLPARM      JA, VERZW. ZUR FEHLERROUTINE
         BCTR  R4,0          R4 UM EINS VERMINDERN
         EX    R4,MVCMBR     VERZW. ZUM UEBERTR. DES MEMBER NAME
         LA    R2,1(R2)      ADRESSE DES NAECHSTEN ZEICHENS LADEN
         EJECT
*
*      VERARBEITUNG DER VOLUME SERIAL NUMBER UND
*      DER PARAMETER 'L' ODER 'LONG'.
*
         SPACE 1
GETNPARM EQU   *
         CLI   0(R2),C','    WEITERE PARAMETER ANGEGEBEN ?
         BNE   ENDPARM       NEIN, VERZWEIGEN
         CLC   1(5,R2),=C'LONG ' PARAMETER = 'LONG' ?
         BE    SET1LB        JA, VERZWEIGEN
         CLC   1(5,R2),=C'LONG,' PARAMETER = 'LONG' ?
         BE    SET1LB        JA, VERZWEIGEN
         CLC   1(2,R2),=C'L ' PARAMETER = 'L' ?
         BE    SET2LB        JA, VERZWEIGEN
         CLC   1(2,R2),=C'L,' PARAMETER = 'L' ?
         BE    SET2LB        JA, VERZWEIGEN
         CLI   VOLSERNO,C' ' VOLSER NUMBER SCHON ANGEGEBEN ?
         BNE   FEHLPARM      JA, VERZW. ZUR FEHLERROUTINE
         MVC   VOLSERNO,1(R2) VOLSER NUMBER UEBERTRAGEN
         LA    R2,7(R2)      ADRESSE DES NAECHSTEN TRENNUNGSZEICHENS
         B     GETNPARM      VERZWEIGEN
         SPACE 1
SET1LB   EQU   *
         LA    R2,3(R2)      R2 ERHOEHEN
SET2LB   EQU   *
         CLI   LONGBYTE,X'FF' PARAMETER SCHON ANGEGEBEN ?
         BE    FEHLPARM      JA, VERZW. ZUR FEHLERROUTINE
         MVI   LONGBYTE,X'FF' FLAG BYTE SETZEN
         LA    R2,2(R2)      ADRESSE DES NAECHSTEN TRENNUNGSZEICHENS
         B     GETNPARM      VERZWEIGEN
         SPACE 2
*
*      ABSCHLUSS DER PARAMETERVERARBEITUNG.
*
         SPACE 1
ENDPARM  EQU   *
         MVC   HEADER(LENMSG01),MSG01 UEBERSCHRIFT UEBERTRAGEN
         EX    R3,MVCDSNLF   VERZW. ZUM UEBERTR. DES DSNAME
         B     GETCAT        VERZWEIGEN
         SPACE 1
MVCDSN   EQU   *
         MVC   DSNAME(0),TEXT+5 DSNAME UEBERTRAGEN
MVCMBR   EQU   *
         MVC   MBRNAME(0),1(R5) MEMBER NAME UEBERTRAGEN
MVCDSNLF EQU   *
         MVC   MS01DSN(0),TEXT+5 DSNAME, MEMBER NAME UEBERTRAGEN
         EJECT
***********************************************************************
*                                                                     *
*      VERARBEITUNG DER CATALOG-INFORMATIONEN.                        *
*                                                                     *
***********************************************************************
         SPACE 3
GETCAT   EQU   *
         CLI   VOLSERNO,C' ' VOLSER NUMBER ANGEGEBEN ?
         BNE   CALLDALC     JA, VERZW. ZUR DYNAMIC ALLOCATION
         XC    CAMLIST(16),CAMLIST CAMLIST-BEREICH LOESCHEN
         MVI   CAMLIST,X'44' FLAG BYTE SETZEN
         LA    R2,DSNAME     PARAMETER-ADRESSEN
         SR    R3,R3             LADEN
         LA    R4,CAMWKFLD       UND
         STM   R2,R4,CAMLIST+4   SPEICHERN
         LOCATE CAMLIST      CATALOG LESEN
         LTR   R15,R15       RETURN CODE = 0 ?
         BNZ   FEHLLOC       NEIN, VERZW. ZUR FEHLERROUTINE
         MVC   MESSAGE(LENMSG02),MSG02 NACHRICHTENZEILE UEBERTRAGEN
         MVC   MS02CVOL,CAMCVOL CVOL NUMBER UEBERTRAGEN
         MVC   MS02VOLI,CAMVOLI VOLSER NUMBER UEBERTRAGEN
         BAL   R14,WTOOUTP   VERZW. ZUR NACHRICHTENAUSGABE
         MVC   VOLSERNO,CAMVOLI VOLSER NUMBER UEBERTRAGEN
         EJECT
***********************************************************************
*                                                                     *
*      AUFRUF DES UNTERPROGRAMMS 'DYNALC'.                            *
*                                                                     *
***********************************************************************
         SPACE 3
CALLDALC EQU   *
         MVC   DALPWKS(DALPLEN),DALPCON PARAMETERLISTE UEBERTRAGEN
         LA    R2,DALPRC     ADRESSE DER RETURN CODES
         ST    R2,ADDRRC         LADEN UND SPEICHERN
         LA    R2,DALPDDN    ADRESSE DES DDNAME LADEN
         LA    R3,DSNAME     ADRESSE DES DSNAME LADEN
         STM   R2,R3,ADDRDDN ADRESSEN SPEICHERN
         LA    R2,VOLSERNO   ADRESSE DER VOLSER NUMBER
         STCM  R2,7,ADDRVOLI+1   LADEN UND SPEICHERN
         XC    DALPRC,DALPRC SPEICHER FUER RETURN CODE LOESCHEN
         MVC   DALPDDN,=CL8' ' SPEICHER FUER DDNAME LOESCHEN
         LOAD  EP=DYNALC               LOAD ENTRY POINT OF SUBROUTINE
         ST    R0,DYNADDR                  AND STORE IT
         LA    R1,DALPWKS    ADRESSE DER PARAMETERLISTE LADEN
         LR    R15,R0                  LOAD ENTRY POINT OF SUBROUTINE
         BALR  R14,R15       VERZW. INS UNTERPROGRAMM 'DYNALC'
         CLI   DALPRC+3,X'00' RETURN CODE = 0 ?
         BNE   FEHLDYNA      NEIN, VERZW. ZUR FEHLERROUTINE
         EJECT
***********************************************************************
*                                                                     *
*      DSCB1 LESEN UND AUSWERTEN.                                     *
*                                                                     *
***********************************************************************
         SPACE 3
GETDSCB1 EQU   *
         XC    CAMLIST(16),CAMLIST CAMLIST-BEREICH LOESCHEN
         MVI   CAMLIST,X'C1' FLAG BYTE SETZEN
         LA    R2,DSNAME     PARAMETER-ADRESSEN
         LA    R3,VOLSERNO       LADEN
         LA    R4,CAMWKFLD       UND
         STM   R2,R4,CAMLIST+4   SPEICHERN
         OBTAIN CAMLIST      DSCB1 DES DATA SET AUFSUCHEN
         LTR   R15,R15       RETURN CODE = 0 ?
         BNZ   FEHLOBT       NEIN, VERZW. ZUR FEHLERROUTINE
         CLC   DS1CCHHR,=XL8'0' DUMMY DSCB1 ?
         BE    FEHLOBT       JA, VERZW. ZUR FEHLERROUTINE
         TM    DS1DSORG,X'40' DSORG = PS ?
         BZ    *+16          NEIN, VERZWEIGEN
         CLI   MBRNAME,C' '  MEMBER NAME ANGEGEBEN ?
         BNE   FEHLORG       JA, VERZW. ZUR FEHLERROUTINE
         B     *+20          VERZWEIGEN
         TM    DS1DSORG,X'02' DSORG = PO ?
         BZ    FEHLORG       NEIN, VERZW. ZUR FEHLERROUTINE
         CLI   MBRNAME,C' '  MEMBER NAME ANGEGEBEN ?
         BE    FEHLORG       NEIN, VERZW. ZUR FEHLERROUTINE
         EJECT
*
*      PRUEFUNG DES SATZFORMATES.
*
         SPACE 1
         LA    R2,54         UEBERTRAGUNGS-LAENGE LADEN
         ST    R2,RECLEN         UND SPEICHERN
         TM    LONGBYTE,X'FF' 'LONG' SPEZIFIZIERT ?
         BZ    TSTMBRNM      NEIN, VERZWEIGEN
         XC    RECLEN,RECLEN UEBERTRAGUNGS-LAENGE = 0
         TM    DS1RECFM,X'C0' RECFM = U ?
         BO    TSTMBRNM      JA, VERZWEIGEN
         TM    DS1RECFM,X'40' RECFM = V ?
         BO    TSTMBRNM      JA, VERZWEIGEN
         LA    R1,200        MAX. SATZLAENGE LADEN
         ICM   R2,3,DS1RECL  SATZLAENGE LADEN
         CR    R2,R1         SATZLAENGE > 200 ?
         BNH   *+6           NEIN, VERZWEIGEN
         LR    R2,R1         MAX. SATZLAENGE LADEN
         ST    R2,RECLEN     UEBERTRAGUNGS-LAENGE SPEICHERN
TSTMBRNM EQU   *
         CLI   MBRNAME,C' '  MEMBER EINER PO-DATEI GESUCHT ?
         BE    OPEN          NEIN, VERZWEIGEN
         EJECT
***********************************************************************
*                                                                     *
*      PRUEFUNG BEI PO-DATEIEN UND NEUE ALLOCATION.                   *
*                                                                     *
***********************************************************************
         SPACE 3
*
*      PRUEFEN, OB MEMBER IN SPEZIFIZIERTER DATEI IST.
*
         SPACE 1
         MVC   EIN(PODATLEN),PODATEI DCB UEBERTRAGEN
         MVC   DCBDDN,DALPDDN DDNAME UEBERTRAGEN
         LA    R1,EIN        ADRESSE DES DCB LADEN
         ST    R1,DCBADDR        UND SPEICHERN
         MVI   DCBADDR,X'80' OPTION BYTE SETZEN
         LA    R1,DCBADDR    ADRESSE DER DCB-ADRESSE LADEN
         SVC   19            VERZW. ZUM EROEFFNEN DER DATEI
         TM    DCBOFLGS,X'10' DATEI EROEFFET ?
         BZ    FEHLOPEN      NEIN, VERZW. ZUR FEHLERROUTINE
         SPACE 1
         LA    R1,EIN        ADRESSE DES DCB LADEN
         LA    R0,MBRNAME    ADRESSE DES MEMBER NAME LADEN
         FIND  (R1),(R0),D   MEMBER AUFSUCHEN
         LTR   R15,R15       MEMBER GEFUNDEN ?
         BNZ   FEHLMBR       NEIN, VERZW. ZUR FEHLERROUTINE
         SPACE 1
         LA    R1,DCBADDR    ADRESSE DER DCB-ADRESSE LADEN
         SVC   20            VERZW. ZUM SCHLIESSEN DER DATEI
         SPACE 2
*
*      NEUE DYNAMIC ALLOCATION.
*
         SPACE 1
         BAL   R14,UNALLOC   VERZW. ZUR UNALLOCATION
         LA    R1,DALPTYPE   ADRESSE DES DYNALLOC-TYPS
         ST    R1,ADDRTYPE       LADEN UND SPEICHERN
         LA    R1,MBRNAME    ADRESSE DES MEMBER NAME LADEN
         ST    R1,ADDRMBRN       UND SPEICHERN
         XC    DALPRC,DALPRC SPEICHER FUER RETURN CODE LOESCHEN
         MVC   DALPDDN,=CL8' ' SPEICHER FUER DDNAME LOESCHEN
         LA    R1,DALPWKS    ADRESSE DER PARAMETERLISTE LADEN
         L     R15,DYNADDR             LOAD ENTRY POINT OF SUBROUTINE
         BALR  R14,R15       VERZW. ZUM UNTERPROGRAMM 'DYNALC'
         CLI   DALPRC+3,X'00' RETURN CODE = 0 ?
         BNE   FEHLDYNA      NEIN, VERZW. ZUR FEHLERROUTINE
         EJECT
***********************************************************************
*                                                                     *
*      DATEI VERARBEITEN.                                             *
*                                                                     *
***********************************************************************
         SPACE 3
*
*      DATEI EROEFFNEN.
*
         SPACE 1
OPEN     EQU   *
         MVC   EIN(DCBLEN),DCBCONST DCB UEBERTRAGEN
         MVC   DCBDDN,DALPDDN DDNAME UEBERTRAGEN
         LA    R1,EIN        ADRESSE DES DCB LADEN
         ST    R1,DCBADDR        UND SPEICHERN
         MVI   DCBADDR,X'80' OPTION BYTE SETZEN
         LA    R1,DCBADDR    ADRESSE DER DCB-ADRESSE LADEN
         SVC   19            VERZW. ZUM EROEFFNEN DER DATEI
         TM    DCBOFLGS,X'10' DATEI EROEFFNET ?
         BZ    FEHLOPEN      NEIN, VERZW. ZUR FEHLERROUTINE
         MVI   EOF,X'00'     EOF-BYTE LOESCHEN
         SR    R5,R5         LINE COUNT LOESCHEN
WTOMSG13 EQU   *
         L     R0,REG4       MCS-ID DER CONSOLE LADEN
         WTO   MF=(E,MSG13)  NACHRICHTENZEILE AUSGEBEN
         SPACE 2
*
*      DATEI LESEN.
*
         SPACE 1
MAINLOOP EQU   *
         L     R0,REG4       MCS-ID DER CONSOLE LADEN
         WTO   MF=(E,HEADER) UEBERSCHRIFT AUSGEBEN
         LA    R2,10         LOOP COUNT INITIALISIEREN
         MVC   MESSAGE(LENMSG03),MSG03 NACHRICHTENZEILE UEBERTRAGEN
GETLOOP  EQU   *
         GET   EIN           EINEN SATZ LESEN
         ST    R1,RECADDR    LFD. SATZADRESSE SPEICHERN
         LA    R5,1(R5)      LINE COUNT ERHOEHEN
         EJECT
*
*      SAETZE AUSGEBEN.
*
         SPACE 1
         L     R3,RECLEN     UEBERTRAGUNGS-LAENGE LADEN
         LTR   R3,R3         LAENGE = 0 ? (RECFM = U × V & 'LONG')
         BZ    MVCVREC       JA, VERZWEIGEN
         TM    DS1RECFM,X'C0' RECFM = U ?
         BNO   *+12          NEIN, VERZWEIGEN
         LH    R3,DCBLRECL   AKTUELLE SATZLAENGE LADEN
         B     COMPRECL      VERZWEIGEN
         TM    DS1RECFM,X'80' RECFM = F ?
         BNO   *+12          NEIN, VERZWEIGEN
         L     R3,RECLEN     MAX. UEBERTRAGUNGS-LAENGE LADEN
         B     MVCTEXT       VERZWEIGEN
         LH    R3,0(R1)      SATZLAENGE LADEN
         SH    R3,=H'4'      SATZLAENGE UM SDW VERMINDERN
         LA    R1,4(R1)      R1 ZEIGT AUF DATA FIELD
COMPRECL EQU   *
         C     R3,RECLEN     SATZLAENGE > UEBERTRAGUNGS-LAENGE ?
         BNH   MVCTEXT       NEIN, VERZWEIGEN
         L     R3,RECLEN     UEBERTRAGUNGSLAENGE LADEN
MVCTEXT  EQU   *
         BCTR  R3,0          R3 UM EINS VERMINDERN
         EX    R3,EXMVCTXT   VERZW. ZUM UEBERTR. DES TEXTES
         LA    R3,13(R3)     LAENGE DER WTO-NACHRICHT
         STH   R3,MESSAGE        SPEICHERN
         L     R0,REG4       MCS-ID DER CONSOLE LADEN
         WTO   MF=(E,MESSAGE) NACHRICHTENZEILE AUSGEBEN
         BCT   R2,GETLOOP    VERZWEIGEN
         BAL   R14,WTORLOOP  VERZW. ZUR NACHRICHTEN-AUSG. MIT REPLY
         B     MAINLOOP      VERZWEIGEN
         SPACE 2
EXMVCTXT EQU   *
         MVC   MS03TEXT(0),0(R1) DATEI-ZEILE UEBERTRAGEN
         EJECT
MVCVREC  EQU   *
         TM    DS1RECFM,X'C0' RECFM = U ?
         BNO   *+12          NEIN, VERZWEIGEN
         LH    R3,DCBLRECL   AKTUELLE SATZLAENGE LADEN
         B     STLRECL       VERZWEIGEN
         LH    R3,0(R1)      SATZLAENGE LADEN
         SH    R3,=H'4'      SATZLAENGE UM SDW VERMINDERN
         LA    R1,4(R1)      R1 ZEIGT AUF DATA FIELD
         ST    R1,RECADDR    SATZADRESSE SPEICHERN
STLRECL  EQU   *
         ST    R3,MAXRECL    SATZLAENGE SPEICHERN
         LA    R3,54         UEBERTRAGUNGS-LAENGE LADEN
         ST    R3,RECLEN         UND SPEICHERN
MVCVTEXT EQU   *
         CLC   MAXRECL,RECLEN SATZLAENGE > UEBERTRAGUNGS-LAENGE ?
         BNL   *+10          JA, VERZWEIGEN
         MVC   RECLEN,MAXRECL UEBERTRAGUNGS-LAENGE = SATZLAENGE
         L     R3,RECLEN     UEBERTRAGUNGS-LAENGE LADEN
         L     R1,RECADDR    SATZADRESSE LADEN
         BCTR  R3,0          R3 UM EINS VERMINDERN
         EX    R3,EXMVCTXT   VERZW. ZUM UEBERTR. DES TEXTES
         LA    R3,13(R3)     LAENGE DER WTO-NACHRICHT
         STH   R3,MESSAGE        SPEICHERN
         L     R0,REG4       MCS-ID DER CONSOLE LADEN
         WTO   MF=(E,MESSAGE) NACHRICHTENZEILE AUSGEBEN
         BCTR  R2,0          LOOP COUNT VERMINDERN
         L     R3,RECLEN     UEBERTRAGUNGS-LAENGE LADEN
         L     R1,RECADDR    SATZADRESSE LADEN
         AR    R1,R3             UND ERHOEHEN
         ST    R1,RECADDR        UND SPEICHERN
         L     R1,MAXRECL    SATZLAENGE LADEN
         SR    R1,R3             UND VERMINDERN
         ST    R1,MAXRECL        UND SPEICHERN
         LTR   R1,R1         SATZLAENGE = 0? (ALLE ZEICHEN UEBERTRAGEN)
         BNZ   MVCVTEXT      NEIN, VERZWEIGEN
         XC    RECLEN,RECLEN UEBERTRAGUNGS-LAENGE = 0
         LTR   R2,R2         LOOP COUNT > 0 ?
         BP    GETLOOP       JA, VERZWEIGEN
         BAL   R14,WTORLOOP  VERZW. ZUR NACHRICHTEN-AUSG. MIT REPLY
         B     MAINLOOP      VERZWEIGEN
         EJECT
*
*      DATEI SCHLIESSEN.
*
         SPACE 1
ENDFILE  EQU   *
         L     R0,REG4       MCS-ID DER CONSOLE LADEN
         WTO   MF=(E,MSG14)  NACHRICHTENZEILE AUSGEBEN
         CLC   REPLY,=XL8'0' NOCH KEIN REPLY AUSGEGEBEN ?
         BE    CLOSE         JA, VERZWEIGEN
         MVI   EOF,X'FF'     ENDFILE SPEZIFIZIEREN
         BAL   R14,WTORLOOP  VERZW. ZUR NACHRICHTENAUSGABE
CLOSE    EQU   *
         LA    R1,DCBADDR    ADRESSE DER DCB-ADRESSE LADEN
         SVC   20            VERZW. ZUM SCHLIESSEN DER DATEI
         BAL   R14,UNALLOC   VERZW. ZUR UNALLOCATION
         B     ENDE          VERZW. ZUM ABSCHLUSS
         EJECT
***********************************************************************
*                                                                     *
*      NACHRICHTENAUSGABE MIT REPLY.                                  *
*                                                                     *
***********************************************************************
         SPACE 1
WTORLOOP EQU   *
         XC    ECB,ECB       EVENT CONTROL BLOCK LOESCHEN
         XC    REPLY,REPLY   REPLY LOESCHEN
         L     R0,REG4       MCS-ID DER CONSOLE LADEN
         LA    R2,ECB        ADRESSE DES ECB LADEN
         LA    R3,REPLY      ADRESSE DES REPLY LADEN
         MVC   MESSAGE(LENMSG09),MSG09 NACHRICHTENZEILE UEBERTRAGEN
         WTOR  ,(R3),8,(R2),MF=(E,MESSAGE) NACHRICHTENZEILE AUSGEBEN
         SPACE 1
         WAIT  ECB=ECB       WAIT FOR REPLY
         CLI   REPLY,C'Y'    REPLY = YES ?
         BER   R14           JA, VERZWEIGEN
         CLI   REPLY,C'N'    REPLY = NO ?
         BE    CLOSE         JA, VERZW. ZUM SCHLIESSEN DER DATEI
         CLI   EOF,X'FF'     ENDE DER DATEI ERREICHT ?
         BNE   ZEROZWF       NEIN, VERZWEIGEN
         CLI   REPLY,C'-'    REPLY = LINE COUNT INCR. MIT NEG. VZ. ?
         BNE   CLOSE         NEIN, VERZW. ZUM SCHLIESSEN DER DATEI
         EJECT
***********************************************************************
*                                                                     *
*      ROUTINE FUER REPLY = LINE COUNT INCREMENT.                     *
*                                                                     *
***********************************************************************
         SPACE 3
ZEROZWF  EQU   *
         MVC   ZWFELD,=15C'0' ZWFELD LOESCHEN
         LA    R6,ZWFELD+14  ADRESSE DES LETZTEN BYTES LADEN
         LA    R7,REPLY+7    ADRESSE DES LETZTEN BYTES LADEN
         LA    R8,REPLY      ADRESSE DES REPLY LADEN
         SPACE 2
*
*      PRUEFUNG UND UEBERTRAGUNG EINZELNER BYTES.
*
         SPACE 1
MVCREPLP EQU   *
         CR    R7,R8         ERSTES BYTE DES REPLY ERREICHT ?
         BL    ENDREPLP      VERZW, DA SCHON ALLE BYTES UEBERTR.
         BH    PRFBYTE       NEIN, VERZWEIGEN
         CLI   REPLY,C'+'    REPLY = LINE COUNT INCR. MIT VZ. ?
         BE    ENDREPLP      JA, VERZWEIGEN
         CLI   REPLY,C'-'    REPLY = LINE COUNT INCR. MIT VZ. ?
         BNE   PRFBYTE       NEIN, VERZWEIGEN
         NI    ZWFELD+14,X'DF' NEGATIVES VORZEICHEN SPEZIFIZIEREN
         B     ENDREPLP      VERZWEIGEN
PRFBYTE  EQU   *
         CLI   0(R7),X'00'   ZEICHEN = LEERZEICHEN ?
         BE    SRR7          JA, VERZWEIGEN
         CLI   0(R7),C'0'    ZEICHEN GUELTIG ?
         BL    WTORLOOP      NEIN, VERZWEIGEN
         CLI   0(R7),C'9'    ZEICHEN GUELTIG ?
         BH    WTORLOOP      NEIN, VERZWEIGEN
         MVC   0(1,R6),0(R7) ZEICHEN UEBERTRAGEN
         BCTR  R6,0          ADRESSE DES NAECHSTEN ZEICHENS IN ZWFELD
SRR7     EQU   *
         BCTR  R7,0          ADRESSE DES NAECHSTEN ZEICHENS IN REPLY
         B     MVCREPLP      VERZWEIGEN
         EJECT
*
*      AUFBEREITUNG DES LINE COUNT INCREMENTS.
*
         SPACE 1
ENDREPLP EQU   *
         PACK  DBWORD,ZWFELD LINE COUNT INCR. PACKEN
         CVB   R6,DBWORD     UMWANDELN IN DUALZAHL
         BCTR  R6,0          R6 UM EINS VERMINDERN
         AR    R6,R5         R6 UM LINE COUNT ERHOEHEN
         CR    R6,R5         R6 > R5 ?
         BH    SRCHLOOP      JA, VERZWEIGEN
         LA    R1,DCBADDR    ADRESSE DER DCB-ADRESSE LADEN
         SVC   20            VERZW. ZUM SCHLIESSEN DER DATEI
         LA    R1,DCBADDR    ADRESSE DER DCB-ADRESSE LADEN
         SVC   19            VERZW. ZUM OEFFNEN DER DATEI
         TM    DCBOFLGS,X'10' DATEI EROEFFNET ?
         BZ    FEHLOPEN      NEIN, VERZW. ZUR FEHLERROUTINE
         MVI   EOF,X'00'     EOF-BYTE LOESCHEN
         SR    R5,R5         LINE COUNT LOESCHEN
         LTR   R6,R6         R6 > 0 ?
         BP    SRCHLOOP      JA, VERZWEIGEN
         SR    R6,R6         R6 LOESCHEN
         B     WTOMSG13      VERZWEIGEN
         SPACE 2
*
*      AUFSUCHEN DES ERSTEN GESUCHTEN SATZES.
*
         SPACE 1
SRCHLOOP EQU   *
         CR    R5,R6         R5 = R6 ?
         BE    MAINLOOP      JA, VERZWEIGEN
         GET   EIN           EINEN SATZ LESEN
         LA    R5,1(R5)      LINE COUNT ERHOEHEN
         B     SRCHLOOP      VERZWEIGEN
         EJECT
***********************************************************************
*                                                                     *
*      DYNAMIC UNALLOCATION.                                          *
*                                                                     *
***********************************************************************
         SPACE 3
UNALLOC  EQU   *
         ST    R14,RETADDR   RUECKSPRUNG-ADRESSE SICHERN
         LA    R2,=CL12'UNALLOC ' ADRESSE DES DYNALLOC-TYPS
         ST    R2,ADDRTYPE       LADEN UND SPEICHERN
         OI    ADDRDSN,X'80' ENDE DER PARAMETERKETTE SPEZIFIZIEREN
         LA    R1,DALPWKS    ADRESSE DER PARAMETERLISTE LADEN
         L     R15,DYNADDR             LOAD ENTRY POINT OF SUBROUTINE
         BALR  R14,R15       VERZW. ZUM UNTERPROGRAMM 'DYNALC'
         MVI   ADDRDSN,X'00' ENDE DER PARAMETERKETTE ZURUECKSETZEN
         CLI   DALPRC+3,X'00' RETURN CODE = 0 ?
         BNE   FEHLDYNA      NEIN, VERZW. ZUR FEHLERROUTINE
         L     R14,RETADDR   RUECKSPRUNG-ADRESSE LADEN
         BR    R14           VERZWEIGEN
         EJECT
***********************************************************************
*                                                                     *
*      ABSCHLUSSROUTINEN.                                             *
*                                                                     *
***********************************************************************
         SPACE 3
*
*     SPEICHERPLATZFREIGABE,
*     REINITIALISIERUNG DER REGISTER,
*     RUECKSPRUNG ZUM AUFRUFENDEN PROGRAMM.
*
         SPACE 1
ENDE     EQU   *
         XRETURN ,R
         EJECT
***********************************************************************
*                                                                     *
*      FEHLERROUTINEN.                                                *
*                                                                     *
***********************************************************************
         SPACE 3
*
*      ROUTINE BEI FEHLER IN DER PARAMETERKETTE.
*
         SPACE 1
FEHLPARM EQU   *
         L     R0,REG4       MCS-ID DER CONSOLE LADEN
         WTO   MF=(E,MSG05)  FEHLERNACHRICHT AUSGEBEN
         B     ENDE          VERZWEIGEN
         SPACE 2
*
*      ROUTINE BEI LOCATE-FEHLER.
*
         SPACE 1
FEHLLOC  EQU   *
         MVC   MESSAGE(LENMSG06),MSG06 NACHRICHTENZEILE UEBERTRAGEN
         BAL   R14,CONVDEC   VERZW. ZUM UMWANDELN IN DEZIMALZAHL
         MVC   MS06RC,ZWFELD+13 RETURN CODE UEBERTRAGEN
         LA    R14,ENDE      RUECKSPRUNGADRESSE LADEN
         B     WTOOUTP       VERZW. ZUR NACHRICHTENAUSGABE
         SPACE 2
*
*      ROUTINE BEI OBTAIN-FEHLER.
*
         SPACE 1
FEHLOBT  EQU   *
         MVC   MESSAGE(LENMSG07),MSG07 NACHRICHTENZEILE UEBERTRAGEN
         BAL   R14,CONVDEC   VERZW. ZUM UMWANDELN IN DEZIMALZAHL
         MVC   MS07RC,ZWFELD+13 RETURN CODE UEBERTRAGEN
         BAL   R14,WTOOUTP
         LA    R14,ENDE      RUECKSPRUNGADRESSE LADEN
         B     UNALLOC
         SPACE 2
*
*      ROUTINE BEI UNGUELTIGER DATEI.
*
         SPACE 1
FEHLORG  EQU   *
         MVC   MESSAGE(LENMSG08),MSG08 NACHRICHTENZEILE UEBERTRAGEN
         BAL   R14,WTOOUTP
         LA    R14,ENDE      RUECKSPRUNGADRESSE LADEN
         B     UNALLOC       VERZW. ZUR NACHRICHTENAUSGABE
         EJECT
*
*      ROUTINE BEI ALLOCATION-FEHLER.
*
         SPACE 1
FEHLDYNA EQU   *
         MVC   MESSAGE(LENMSG10),MSG10 NACHRICHTENZEILE UEBERTRAGEN
         L     R15,DALPRC    RETURN CODE LADEN
         BAL   R14,CONVDEC   VERZW. ZUM UMWANDELN IN DEZIMALZAHL
         MVC   MS10RC,ZWFELD+13 RETURN CODE UEBERTRAGEN
         UNPK  MS10EC(5),DALPEC+2(3) ERROR REASON CODE UEBERTRAGEN
         TR    MS10EC,TABHEXA-240 ERROR REASON CODE AUFBEREITEN
         MVI   MS10EC+4,C',' KOMMA EINTRAGEN
         UNPK  MS10IC(5),DALPIC+2(3) INFO. REASON CODE UEBERTRAGEN
         TR    MS10IC,TABHEXA-240 INFO. REASON CODE AUFBEREITEN
         LA    R14,ENDE      RUECKSPRUNGADRESSE LADEN
         B     WTOOUTP       VERZW. ZUR NACHRICHTENAUSGABE
         SPACE 2
*
*      ROUTINE BEI OPEN-FEHLER.
*
         SPACE 1
FEHLOPEN EQU   *
         MVC   MESSAGE(LENMSG11),MSG11 NACHRICHTENZEILE UEBERTRAGEN
         BAL   R14,WTOOUTP   VERZW. ZUR NACHRICHTENAUSGABE
         LA    R14,ENDE
         B     UNALLOC       VERZWEIGEN
         SPACE 2
*
*      ROUTINE BEI FIND-FEHLER.
*
         SPACE 1
FEHLMBR  EQU   *
         MVC   MESSAGE(LENMSG12),MSG12 NACHRICHTENZEILE UEBERTRAGEN
         LA    R14,CLOSE
         B     WTOOUTP       VERZW. ZUR NACHRICHTENAUSGABE
         EJECT
***********************************************************************
*                                                                     *
*      NACHRICHTENAUSGABE.                                            *
*                                                                     *
***********************************************************************
         SPACE 3
WTOOUTP  EQU   *
         L     R0,REG4       MCS-ID DER CONSOLE LADEN
         WTO   MF=(E,HEADER) UEBERSCHRIFT AUSGEBEN
         L     R0,REG4       MCS-ID DER CONSOLE LADEN
         WTO   MF=(E,MESSAGE) NACHRICHTENZEILE AUSGEBEN
         BR    R14           VERZWEIGEN
         SPACE 3
***********************************************************************
*                                                                     *
*      UMWANDLUNG VON DUALZAHLEN IN ENTPACKTE DEZIMALZAHLEN.          *
*                                                                     *
***********************************************************************
         SPACE 3
CONVDEC  EQU   *
         CVD   R15,DBWORD    DUALZAHL IN GEP. DEZIMALZAHL UMWANDELN
         UNPK  ZWFELD,DBWORD DEZIMALZAHL ENTPACKEN
         OI    ZWFELD+14,C'0' VORZEICHEN MODIFIZIEREN
         BR    R14           VERZWEIGEN
         EJECT
***********************************************************************
*                                                                     *
*      REGISTER EQUATES.                                              *
*                                                                     *
***********************************************************************
         SPACE 3
R0       EQU   0             MACRO- UND PARAMETER-REGISTER
R1       EQU   1             MACRO- UND PARAMETER-REGISTER
R2       EQU   2             ARBEITSREGISTER
R3       EQU   3             ARBEITSREGISTER
R4       EQU   4             ARBEITSREGISTER
R5       EQU   5             ARBEITSREGISTER
R6       EQU   6             ARBEITSREGISTER
R7       EQU   7             ARBEITSREGISTER
R8       EQU   8             ARBEITSREGISTER
R9       EQU   9             ARBEITSREGISTER
R10      EQU   10            ARBEITSREGISTER
R11      EQU   11            BASIS FUER DSECT PARMAREA
R12      EQU   12            BASIS FUER CSECT LIST
R13      EQU   13            BASIS FUER DSECT ABER
R14      EQU   14            RUECKSPRUNGADRESSEN
R15      EQU   15            CSECT-ADRESSEN UND RETURN CODES
         EJECT
***********************************************************************
*                                                                     *
*      DEFINITIONEN DER KONSTANTEN-SPEICHER.                          *
*                                                                     *
***********************************************************************
         SPACE 3
*
*      PARAMETERLISTE FUER 'DYNALC' (KONSTANTEN).
*
         SPACE 1
DALPCON  DS    0F
         DC    A(0)          ADRESSE DER RETURN CODES
         DC    A(DALPTYPE)   ADRESSE DES DYNALLOC-TYPS
         DC    A(0)          ADRESSE DES DDNAME
         DC    A(0)          ADRESSE DES DATA SET NAME
         DC    A(0)          ADRESSE DES MEMBER NAME
         DC    A(DALPSTAT)   ADRESSE DES DATA SET STATUS
         DC    A(DALPDISP)   ADRESSE DER NORM. DISPOSITION
         DC    A(DALPDISP)   ADRESSE DER COND. DISPOSITION
         DC    7A(0)
         DC    A(0)          ADRESSE DER VOLSER NUMBER
         DC    10A(0)
         DC    AL1(128)      ENDE DER PARAMETERKETTE
         DC    AL3(DALPNOUA)
DALPLEN  EQU   *-DALPCON     LAENGE DER PARAMETERKETTE
DALPSTAT DC    C'SHR'        DATA SET STATUS
DALPDISP DC    CL8'KEEP'     DATA SET DISPOSITION
DALPTYPE DC    C'DSALLOC '   DYNALLOC-TYP
DALPWAIT DC    C'WAIT'       WAIT REQUEST INDICATOR
DALPNOUA DC    C'NOUNALC'    NO UNALLOCATION AT CLOSE
         SPACE 2
*
*      TABELLE ZUM AUFBEREITEN VON HEXADEZIMALZAHLEN.
*
         SPACE 1
TABHEXA  DC    C'0123456789ABCDEF'
         EJECT
*
*      DCB DER EINGABEDATEI (KONSTANTEN).
*
         SPACE 1
DCBCONST DCB   DDNAME=EIN00000,                                        *
               DSORG=PS,                                               *
               MACRF=(GL),                                             *
               EODAD=ENDFILE
DCBLEN   EQU   *-DCBCONST    LAENGE DES DCB
         SPACE 2
*
*      DCB FUER PO-DATEIEN.
*
         SPACE 1
PODATEI  DCB   DDNAME=EIN00001,                                        *
               DSORG=PO,                                               *
               MACRF=(R),                                              *
               LRECL=80
PODATLEN EQU   *-PODATEI     LAENGE DES DCB
         EJECT
***********************************************************************
*                                                                     *
*      DEFINITION DER AUSGABENACHRICHTEN.                             *
*                                                                     *
***********************************************************************
         SPACE 3
MSG01    WTO   'XLIST01 DSN=                                           *
                      ',                                               *
               MF=L,MCSFLAG=(REG0)
LENMSG01 EQU   *-MSG01
         SPACE 1
MSG02    WTO   'XLIST02 CATALOG ON 123456 POINTS TO 123456',           *
               MF=L,MCSFLAG=(REG0)
LENMSG02 EQU   *-MSG02
         SPACE 1
MSG03    WTO   'XLIST03                                                *
                      ',                                               *
               MF=L,MCSFLAG=(REG0)
LENMSG03 EQU   *-MSG03
         SPACE 1
MSG04    WTO   'XLIST04 FUNCTION SUPPORTED FO OS/VS2 (MVS) ONLY',      *
               MF=L,MCSFLAG=(REG0)
         EJECT
MSG05    WTO   'XLIST05 ERROR IN PARAMETER LIST',                      *
               MF=L,MCSFLAG=(REG0)
         SPACE 1
MSG06    WTO   'XLIST06 DATA SET NOT FOUND IN CATALOG, LOCATE RC=99',  *
               MF=L,MCSFLAG=(REG0)
LENMSG06 EQU   *-MSG06
         SPACE 1
MSG07    WTO   'XLIST07 DATA SET NOT FOUND ON VOLUME, OBTAIN RC=99',   *
               MF=L,MCSFLAG=(REG0)
LENMSG07 EQU   *-MSG07
         SPACE 1
MSG08    WTO   'XLIST08 DATA SET INVALID FOR THIS COMMAND',            *
               MF=L,MCSFLAG=(REG0)
LENMSG08 EQU   *-MSG08
         SPACE 1
MSG09    WTOR  'XLIST09 REPLY ''Y'' (YES), ''N'' (NO) OR LINE COUNT INC*
               REMENT',                                                *
               MF=L,MCSFLAG=(REG0)
LENMSG09 EQU   *-MSG09
         EJECT
MSG10    WTO   'XLIST10 ALLOCATION FAILURE, RC=99, EC=9999, IC=9999',  *
               MF=L,MCSFLAG=(REG0)
LENMSG10 EQU   *-MSG10
         SPACE 1
MSG11    WTO   'XLIST11 OPEN FAILURE',                                 *
               MF=L,MCSFLAG=(REG0)
LENMSG11 EQU   *-MSG11
         SPACE 1
MSG12    WTO   'XLIST12 MEMBER NOT IN SPECIFIED DATASET',              *
               MF=L,MCSFLAG=(REG0)
LENMSG12 EQU   *-MSG12
         SPACE 1
MSG13    WTO   'XLIST00 TOP OF DATA SET',                              *
               MF=L,MCSFLAG=(REG0)
         SPACE 1
MSG14    WTO   'XLIST00 END OF DATA SET',                              *
               MF=L,MCSFLAG=(REG0)
         EJECT
***********************************************************************
*                                                                     *
*      DEFINITION DER ARBEITSBEREICHE.                                *
*                                                                     *
***********************************************************************
         SPACE 3
ABER     DSECT
SAVEAREA DS    18F           SAVEAREA FUER ALLGEMEINE REGISTER
DBWORD   DS    D             ZWISCHENSPEICHER FUER DEZIMALZAHLEN
ZWFELD   DS    CL15          ZWISCHENSPEICHER FUER DEZIMALZAHLEN
LONGBYTE DS    C             FLAG BYTE FUER LAENGE DER AUSGABE
EOF      DS    C             FLAG BYTE FUER DATEI ENDE
REPLY    DS    CL8           SPEICHER FUER REPLY
DSNAME   DS    CL44          DATA SET NAME
MBRNAME  DS    CL8           MEMBER NAME
VOLSERNO DS    CL6           VOLUME SERIAL NUMBER
RECLEN   DS    F             UEBERTRAGUNGS-LAENGE
MAXRECL  DS    F             MAX. SATZ-LAENGE
RECADDR  DS    F             LFD. SATZADRESSE
RETADDR  DS    F             RUECKSPRUNG-ADRESSE
DYNADDR  DS    F                       ENTRY POINT OF SUBROUTINE
ECB      DS    F             EVENT CONTROL BLOCK
         SPACE 2
*
*      DCB DER EINGABEDATEI.
*
         SPACE 1
EIN      DS    0F
         DS    10F
DCBDDN   DS    CL8           DDNAME
DCBOFLGS DS    C             FLAG BYTE
         DS    CL33
DCBLRECL DS    H             RECORD LENGTH
         ORG   EIN+DCBLEN
DCBADDR  DS    F             ADRESSE DES DCB
         EJECT
CAMLIST  DS    4F            BEREICH FUER CAMLIST-MACRO
         DS    0D
CAMWKFLD DS    0CL265        WORK FIELD
         SPACE 2
*
*      DEFINITIONEN DER VOLSER-LISTE.
*
         SPACE 1
         ORG   CAMWKFLD+6
CAMVOLI  DS    CL6           VOLSER NUMBER
         ORG   CAMWKFLD+259
CAMCVOL  DS    CL6           VOLSER NUMBER DES CATALOGS
         SPACE 2
*
*      DSCB1-DEFINITIONEN.
*
         SPACE 1
         ORG   CAMWKFLD
DS1FMTID DS    C             FORMAT IDENTIFIER (= C'1')
         DS    CL37
DS1DSORG DS    CL2           DATA SET ORGANISATION
DS1RECFM DS    C             DATA SET RECORD FORMAT
         DS    C
DS1BLKL  DS    CL2           DATA SET BLOCK LENGTH
DS1RECL  DS    CL2           DATA SET RECORD LENGTH
         DS    CL3
DS1DSIND DS    C             DATA SET INDICATORS
DS1CCHHR DS    CL5           CCHHR-ADRESSE DES DSCB1
         ORG   CAMWKFLD+265
         EJECT
*
*      PARAMETERLISTE FUER 'DYNALC' (ARBEITSBEREICH).
*
         SPACE 1
DALPWKS  DS    0F
ADDRRC   DS    F             ADRESSE VON RETCODE
ADDRTYPE DS    F             ADRESSE DES DYNALLOC-TYPS
ADDRDDN  DS    F             ADRESSE DES DDNAME
ADDRDSN  DS    F             ADRESSE DES DSNAME
ADDRMBRN DS    F             ADRESSE DES MEMBER NAME
         DS    10F
ADDRVOLI DS    F             ADRESSE DER VOLSER NUMBER
         ORG   DALPWKS+DALPLEN
         SPACE 1
DALPRC   DS    F             RETURN CODE
DALPEC   DS    F             ERROR REASON CODE
DALPIC   DS    F             INFORMATION REASON CODE
DALPDDN  DS    CL8           DDNAME
         EJECT
*
*      NACHRICHTEN-BEREICHE.
*
         SPACE 1
HEADER   DS    0F            UEBERSCHRIFTENZEILE
         ORG   HEADER+16
MS01DSN  DS    CL54          SPEZIFIZIERTER DSNAME
         SPACE 1
MESSAGE  DS    0F            NACHRICHTENZEILE
         ORG   MESSAGE+12
         DS    CL11
MS02CVOL DS    CL6           CVOL NUMBER
         DS    CL11
MS02VOLI DS    CL6           VOLSER NUMBER
         ORG   MESSAGE+12
MS03TEXT DS    CL54          TEXT DER EINGABEDATEI
         ORG   MESSAGE+12
         DS    CL41
MS06RC   DS    CL2           RETURN CODE
         ORG   MESSAGE+12
         DS    CL40
MS07RC   DS    CL2           RETURN CODE
         ORG   MESSAGE+12
         DS    CL23
MS10RC   DS    CL2           RETURN CODE
         DS    CL5
MS10EC   DS    CL4           ERROR REASON CODE
         DS    CL5
MS10IC   DS    CL4           INFORMATION REASON CODE
         ORG   MESSAGE+212
         SPACE 1
ABERL    EQU   *-ABER        LAENGE DER ARBEITSBEREICHE
         EJECT
***********************************************************************
*                                                                     *
*      PARAMETERBEREICH.                                              *
*                                                                     *
***********************************************************************
         SPACE 3
         XPARM
         SPACE 3
         END   LIST
./ ADD  NAME=LPDS
         TITLE 'XLPDS                             X-COMMAND LPDS'
LPDS     CSECT
         SPACE 3
***********************************************************************
*                                                                     *
*      PROGRAM-ID. LPDS.                                              *
*      AUTHOR. EHNERT.                                                *
*      PROGRAM-ID. LPDS.                                              *
*      DATE-WRITTEN. 11. 8. 1976.                                     *
*      REMARKS.                                                       *
*                                                                     *
*          DAS X-COMMAND 'LPDS' GIBT INFORMATIONEN UEBER DIE DIREC-   *
*          TORY DER DATEI AUS, DEREN NAME ALS ERSTER PARAMETER SPE-   *
*          ZIFIZIERT WERDEN MUSS.                                     *
*                                                                     *
*          FOLGENDE PARAMETER, DIE ZUSAETZLICH ANGEGEBEN WERDEN       *
*          KOENNEN, MUESSEN IN DER AUFGEFUEHRTEN REIHENFOLGE SPEZI-   *
*          FIZIERT WERDEN:                                            *
*          A)  DIE SERIAL NUMBER DER VOLUME, AUF DER DIE DATEI STEHT. *
*              WIRD SIE NICHT ANGEGEBEN, SO GILT DIE INFORMATION      *
*              DES CATALOGS.                                          *
*          B)  ANGABEN ZUR AUSWAHL DER MEMBER NAMEN: <VON>-<BIS>.     *
*              ES WERDEN NUR INFORMATIONEN UEBER DIE MEMBER AUSGE-    *
*              GEBEN, DEREN NAME IN DER SORTIERFOLGE ZWISCHEN DER     *
*              <VON>- UND DER <BIS>-ANGABE LIEGEN.                    *
*              Z. B.: A-ZZ     => <VON>='A       ', <BIS>='ZZ999999', *
*                     I        => <VON>='I       ', <BIS>='I9999999', *
*                     TEMP-    => <VON>='TEMP    ', <BIS>='99999999', *
*                     -TEMP    => <VON>='        ', <BIS>='TEMP9999', *
*                     TEMPNAME => <VON>='TEMPNAME', <BIS>='TEMPNAME'. *
*              WERDEN KEINE ANGABEN ZUR AUSWAHL GETROFFEN, SO GILT:   *
*              <VON>='        ', <BIS>='99999999'.                    *
*          C)  WIRD DER PARAMETER 'TEST' ANGEGEBEN, SO WIRD ZUSAETZ-  *
*              LICH EINE STATISTIK UEBER DIE ANZAHL DER ANGELEGTEN    *
*              UND UEBER DIE ANZAHL DER BENUTZTEN DIRECTORY BLOCKS    *
*              ERSTELLT.                                              *
*                                                                     *
*          DURCH DIE NOTWENDIGE DYNAMIC ALLOCATION , DIE IM EXTER-    *
*          NEN UNTERPROGRAMM 'DYNALC' DURCHGEFUEHRT WIRD, KANN DAS    *
*          X-COMMAND 'LPDS' NUR IM SYSTEM OS/VS2 (MVS) VERWENDET      *
*          WERDEN.                                                    *
*                                                                     *
***********************************************************************
         EJECT
***********************************************************************
*                                                                     *
*      INITIAL PROCESSING.                                            *
*                                                                     *
***********************************************************************
         SPACE 3
*
*      SAVE REGISTERS,
*      GET MAIN STORAGE AREAS,
*      ALLOCATION OF BASE REGISTERS.
*
         SPACE 1
         XSAVE R12,,LPDS,WKAREAL
         SPACE 1
         LR    R11,R1        INIT. BASE REGISTER OF DSECT PARMAREA
         USING PDS,R10       ALLOCATE BASE REGISTER OF DSECT PDS
         USING PARMAREA,R11  ALLOCATE BASE REGISTER OF DSECT PARMAREA
         USING WKAREA,R13    ALLOCATE BASE REGISTER OF DSECT WKAREA
         EJECT
*
*      TEST SYSTEM.
*
         SPACE 1
         L     R2,16         LOAD ADDRESS OF CVT
         TM    116(R2),X'01' SYSTEM = OS/VS2 (MVS) ?
         BO    INIT          IF YES, BRANCH TO INIT. WORK AREAS
         L     R0,REG4       LOAD MCS-ID.
         WTO   MF=(E,MSG04)  PUT ERROR MESSAGE
         B     STOPWORK      BRANCH TO FINAL PROCESSING
         SPACE 2
*
*      INITIALIZE WORK AREAS.
*
         SPACE 1
INIT     EQU   *
         MVC   HEADER(MSG01LEN),MSG01 MOVE MESSAGE SKELETON
         MVC   VOLSERNO,BLANK CLEAR VOLUME SERIAL NUMBER
         MVC   FROMNAME,BLANK CLEAR PARAMETER AREA
         MVC   TONAME,=8C'9' INITIALIZE PARAMETER AREA
         MVI   FLAGBYTE,X'00' CLEAR FLAG BYTE
         EJECT
***********************************************************************
*                                                                     *
*      INPUT PARAMETER PROCESSING.                                    *
*                                                                     *
***********************************************************************
         SPACE 3
         CLI   TEXT+4,C','   PARAMETERS SPECIFIED ?
         BNE   PRMERROR      IF NOT, BRANCH TO ERROR ROUTINE
         SPACE 2
*
*      DATA SET NAME PROCESSING.
*
         SPACE 1
         LA    R2,TEXT+4     LOAD ADDRESS OF SEPERATOR
         SR    R3,R3         ZERO LENGTH COUNT
DSNLOOP  EQU   *
         LA    R2,1(,R2)     LOAD ADDRESS OF NEXT CHARACTER
         CLI   0(R2),C' '    END OF PARAMETERS ?
         BE    ENDDSNLP      IF YES, BRANCH TO LOOP END
         CLI   0(R2),C','    END OF DATA SET NAME ?
         BE    ENDDSNLP      IF YES, BRANCH TO LOOP END
         LA    R3,1(,R3)     INCREASE LENGTH COUNT
         CH    R3,=H'44'     VALID LENGTH ?
         BH    PRMERROR      IF NOT, BRANCH TO ERROR ROUTINE
         B     DSNLOOP       BRANCH TO LOOP
         SPACE 1
ENDDSNLP EQU   *
         LTR   R3,R3         DATA SET NAME SPECIFIED ?
         BZ    PRMERROR      IF NOT, BRANCH TO ERROR ROUTINE
         BCTR  R3,0          MODIFY FOR EX COMMAND
         EX    R3,MVCDSN     BRANCH TO MOVE DATA SET NAME
         CLI   0(R2),C','    MORE PARAMETERS SPECIFIED ?
         BNE   GETCAT        IF NOT, BRANCH TO GET CATALOG INFORMATION
         EJECT
*
*      VOLUME SERIAL NUMBER PROCESSING.
*
         SPACE 1
         LA    R2,1(,R2)     LOAD ADDRESS OF NEXT SEPERATOR
         CLI   0(R2),C','    VOLUME SERIAL NUMBER SPECIFIED ?
         BE    GETSPARM      IF NOT, BRANCH TO GET NEXT PARAMETER
         MVC   VOLSERNO,0(R2) MOVE VOLUME SERIAL NUMBER
         LA    R2,6(,R2)     LOAD ADDRESS OF NEXT SEPERATOR
         CLI   0(R2),C','    MORE PARAMETERS SPECIFIED ?
         BNE   CALLDALC      IF NOT, BRANCH TO OBTAIN DSCB1
         SPACE 2
*
*      SELECT PARAMETER PROCESSING.
*
         SPACE 1
GETSPARM EQU   *
         LR    R4,R2         SAVE ADDRESS OF SEPERATOR
         SR    R3,R3         ZERO LENGTH COUNT
FROMLOOP EQU   *
         LA    R2,1(,R2)     LOAD ADDRESS OF NEXT CHARACTER
         CLI   0(R2),C' '    END OF PARAMETERS ?
         BE    ENDFRMLP      IF YES, BRANCH TO LOOP END
         CLI   0(R2),C','    END OF SELECT PARAMETERS ?
         BE    ENDFRMLP      IF YES, BRANCH TO LOOP END
         CLI   0(R2),C'-'    END OF FROM-PARAMETER ?
         BE    ENDFRMLP      IF YES, BRANCH TO LOOP END
         LA    R3,1(,R3)     INCREASE LENGTH COUNT
         CH    R3,=H'8'      VALID LENGTH ?
         BH    PRMERROR      IF NOT, BRANCH TO ERROR ROUTINE
         B     FROMLOOP      BRANCH TO LOOP
         SPACE 1
ENDFRMLP EQU   *
         LTR   R3,R3         FROM-PARAMETER SPECIFIED ?
         BZ    NOFNAME       IF NOT, BRANCH TO ALTERNATIV ROUTINE
         BCTR  R3,0          MODIFY FOR EX COMMAND
         EX    R3,MVCFNAME   BRANCH TO MOVE PARAMETER
         CLI   0(R2),C'-'    TO-PARAMETER SPECIFIED ?
         BE    GETTNAME      IF YES, BRANCH TO GET TO-PARAMETER
         EX    R3,MVCTNAME   BRANCH TO MOVE PARAMETER
         B     ASKNEXT       BRANCH
NOFNAME  EQU   *
         CLI   0(R2),C'-'    TO-PARAMETER SPECIFIED ?
         BE    GETTNAME      IF YES, BRANCH TO GET TO-PARAMETER
         B     ASKNEXT       BRANCH
         EJECT
GETTNAME EQU   *
         LR    R4,R2         SAVE ADDRESS OF SEPERATOR
         SR    R3,R3         ZERO LENGTH COUNT
TOLOOP   EQU   *
         LA    R2,1(,R2)     LOAD ADDRESS OF NEXT CHARACTER
         CLI   0(R2),C' '    END OF PARAMETERS ?
         BE    ENDTOLP       IF YES, BRANCH TO LOOP END
         CLI   0(R2),C','    END OF TO-PARAMETER ?
         BE    ENDTOLP       IF YES, BRANCH TO LOOP END
         LA    R3,1(,R3)     INCREASE LENGTH COUNT
         CH    R3,=H'8'      VALID LENGTH ?
         BH    PRMERROR      IF NOT, BRANCH TO ERROR ROUTINE
         B     TOLOOP        BRANCH TO LOOP
         SPACE 1
ENDTOLP  EQU   *
         LTR   R3,R3         TO-PARAMETER SPECIFIED ?
         BZ    ASKNEXT       BRANCH IF NOT
         BCTR  R3,0          MODIFY FOR EX COMMAND
         EX    R3,MVCTNAME   BRANCH TO MOVE TO-PARAMETER
ASKNEXT  EQU   *
         CLI   0(R2),C','    MORE PARAMETERS SPECIFIED ?
         BNE   GETCAT        IF NOT, BRANCH TO GET CATALOG INFORMATION
         SPACE 2
*
*      PROCESSING OF THE PARAMETER 'TEST'.
*
         SPACE 1
         CLC   1(5,R2),=C'TEST ' PARAMETER = 'TEST' ?
         BNE   PRMERROR      IF NOT, BRANCH TO ERROR ROUTINE
         OI    FLAGBYTE,FLAGTEST SET FLAG
         B     GETCAT        BRANCH TO GET CATALOG INFORMATION
         SPACE 1
MVCDSN   MVC   DSNAME(0),TEXT+5 MOVE DATA SET NAME
MVCFNAME MVC   FROMNAME(0),1(R4) MOVE FROM-PARAMETER
MVCTNAME MVC   TONAME(0),1(R4) MOVE TO-PARAMETER
         EJECT
***********************************************************************
*                                                                     *
*      CATALOG INFORMATION PROCESSING.                                *
*                                                                     *
***********************************************************************
         SPACE 3
GETCAT   EQU   *
         CLI   VOLSERNO,C' ' VOLUME SERIAL NUMBER SPECIFIED ?
         BNE   CALLDALC      IF YES, BRANCH TO OBTAIN DSCB1
         XC    CAMLIST(16),CAMLIST CLEAR CAMLIST AREA
         MVI   CAMLIST,X'44' SET FLAG
         LA    R2,DSNAME     LOAD
         SR    R3,R3             PARAMETER
         LA    R4,CAMWKFLD       ADRESSES AND
         STM   R2,R4,CAMLIST+4   STORE THEM
         LOCATE CAMLIST      MOVE CATALOG INFORMATION
         LTR   R15,R15       RETURN CODE = 0 ?
         BNZ   LOCERROR      IF NOT, BRANCH TO ERROR ROUTINE
         MVC   MESSAGE(MSG02LEN),MSG02 MOVE MESSAGE SKELETON
         MVC   MS02CVOL,CAMCVOL MOVE CATALOG VOLUME NUMBER
         MVC   MS02VOLI,CAMVOLI MOVE VOLUME SERIAL NUMBER
         BAL   R14,ERROROUT  BRANCH TO MESSAGE OUTPUT
         MVC   VOLSERNO,CAMVOLI MOVE VOLUME SERIAL NUMBER
         EJECT
***********************************************************************
*                                                                     *
*      CALL SUBROUTINE 'DYNALC'.                                      *
*                                                                     *
***********************************************************************
         SPACE 3
CALLDALC EQU   *
         MVC   DALPWKS(DALPLEN),DALPCON MOVE PARAMETER LIST
         LA    R2,DALPRC     LOAD ADDRESS OF RETURN CODE
         ST    R2,ADDRRC         AND STOTE IT
         LA    R2,DALPDDN    LOAD DDNAME ADDRESS
         LA    R3,DSNAME     LOAD DATA SET NAME ADDRESS
         STM   R2,R3,ADDRDDN STORE ADDRESSES
         LA    R2,VOLSERNO   LOAD ADDRESS OF VOLUME
         STCM  R2,7,ADDRVOLI+1   SERIAL NUMBER AND STORE IT
         XC    DALPRC,DALPRC ZERO RTURN CODE
         MVC   DALPDDN,BLANK CLEAR DDNAME AREA
         LOAD  EP=DYNALC               LOAD ENTRY POINT OF SUBROUTINE
         ST    R0,DYNADDR                  AND STORE IT
         LA    R1,DALPWKS    LOAD ADDRESS OF PARAMETER LIST
         LR    R15,R0                  LOAD ENTRY POINT OF SUBROUTINE
         BALR  R14,R15                 LINK TO SUBROUTINE
         CLI   DALPRC+3,X'00' RETURN CODE = 0 ?
         BNE   ALCERROR      IF NOT, BRANCH TO ERROR ROUTINE
         EJECT
***********************************************************************
*                                                                     *
*      OBTAIN DSCB1.                                                  *
*                                                                     *
***********************************************************************
         SPACE 3
GETDSCB1 EQU   *
         XC    CAMLIST(16),CAMLIST CLEAR CAMLIST AREA
         MVI   CAMLIST,X'C1' SET FLAG
         LA    R2,DSNAME     LOAD PARAMETER
         LA    R3,VOLSERNO       ADRRESSES
         LA    R4,CAMWKFLD       AND
         STM   R2,R4,CAMLIST+4   STORE THEM
         OBTAIN CAMLIST      OBTAIN DSCB1
         LTR   R15,R15       RETURN CODE = 0 ?
         BNZ   OBTERROR      IF NOT, BRANCH TO ERROR ROUTINE
         CLC   DS1CCHHR,=XL5'0' DUMMY DSCB1 ?
         BE    OBTERROR      IF YES, BRANCH TO ERROR ROUTINE
         TM    DS1DSORG,X'02' DSORG = PO ?
         BZ    ORGERROR      IF NOT, BRANCH TO ERROR ROUTINE
         EJECT
***********************************************************************
*                                                                     *
*      DIRECTORY PROCESSING.                                          *
*                                                                     *
***********************************************************************
         SPACE 3
*
*      OPEN DATA SET.
*
         SPACE 1
         MVC   INPUT(DCBLEN),DCBCONST MOVE DATA CONTROL BLOCK
         MVC   DCBDDN,DALPDDN MOVE DDNAME
         LA    R1,INPUT      LOAD ADDRESS OF DATA CONTROL BLOCK
         ST    R1,DCBADDR        BLOCK AND STORE IT
         MVI   DCBADDR,X'80' SET OPTION BYTE
         LA    R1,DCBADDR    LOAD ADDRESS OF DCB ADDRESS
         SVC   19            BRANCH TO OPEN DATA SET
         TM    DCBOFLGS,X'10' SUCCESSFUL OPEN ?
         BZ    OPNERROR      IF NOT, BRANCH TO ERROR ROUTINE
         SR    R2,R2         ZERO BLOCK COUNT
         LA    R1,10         INITIALIZE OUTPUT COUNT
         ST    R1,OUTCOUNT       AND STORE IT
         OI    FLAGBYTE,FLAGHOUT SET FLAG
         SPACE 2
*
*      DATA SET PROCESSING.
*
         SPACE 1
GETLOOP  EQU   *
         GET   INPUT         GET ONE BLOCK
         LA    R2,1(,R2)     INCREASE BLOCK COUNT
         TM    FLAGBYTE,FLAGEND END OF ENTRIES ?
         BO    GETLOOP       IF YES, BRANCH TO GET NEXT BLOCK
         LA    R10,2(,R1)    LOAD ADDRESS OF FIRST ENTRY
         ST    R10,ADDRNENT      AND STORE IT
         LH    R1,0(,R1)     LOAD BLOCK LENGTH AND
         BCTR  R1,0              DECREASE IT BY LENGTH
         BCTR  R1,0              OF BLOCK LENGTH FIELD
         ST    R1,BLKLEN         AND STORE IT
ENTRYLP  EQU   *
         ICM   R1,15,BLKLEN  LOAD REMAINDER BLOCK LENGTH
         BZ    GETLOOP       BRANCH IF LENGTH IS ZERO
         L     R10,ADDRNENT  LOAD ADDRESS OF NEXT ENTRY
         CLI   PDS2NAME,X'FF' END OF ENTRIES ?
         BE    ENTRYEND      BRANCH IF YES
         EJECT
*
*      COMPUTE ENTRY LENGTH.
*
         SPACE 1
         NI    FLAGBYTE,FLAGNALI CLEAR FLAG
         TM    PDS2INDC,X'80' MEMBER = ALIAS ?
         BZ    *+8           BRANCH IF NOT
         OI    FLAGBYTE,FLAGALI SET FLAG
         SR    R4,R4         ZERO FOR IC COMMAND
         NI    PDS2INDC,X'1F' LENGTH OF USER DATA HALFWORDS
         IC    R4,PDS2INDC   LOAD LENGTH
         SLA   R4,1          COMPUTE LENGTH IN BYTES
         LA    R4,12(,R4)    LOAD ENTRY LENGTH
         ST    R4,ENTLEN         AND STORE IT
         SR    R1,R4         COMPUTE REMAINDER LENGTH
         ST    R1,BLKLEN         AND STORE IT
         AR    R4,R10        LOAD ADDRESS OF NEXT ENTRY
         ST    R4,ADDRNENT       AND STORE IT
         SPACE 2
*
*      TEST MEMBER NAME.
*
         SPACE 1
         CLC   PDS2NAME,FROMNAME MEMBER NAME >= FROM-PARAMETER ?
         BL    ENTRYLP       IF NOT BRANCH TO LOOP
         CLC   PDS2NAME,TONAME MEMBER NAME <= TO-PARAMETER ?
         BH    ENTRYLP       IF NOT BRANCH TO LOOP
         SPACE 2
*
*      MOVE MEMBER NAME AND TTR.
*
         SPACE 1
         MVC   MESSAGE(MSG03LEN),MSG03 MOVE MESSAGE SKELETON
         MVC   MESSAGE+12(54),MESSAGE+11 CLEAR MESSAGE AREA
         MVC   MS03MBRN,PDS2NAME MOVE MEMBER NAME
         UNPK  MS03TTR(7),PDS2TTRP(4) UNPACK TTR
         MVI   MS03TTR+6,C' ' MOVE BLANK
         TR    MS03TTR,TRTABLE-240 PREPARE TTR
         EJECT
*
*      SSI INFORMATION PROCESSING.
*
         SPACE 1
         L     R5,ADDRNENT   LOAD ADDRESS OF NEXT ENTRY
         L     R4,ENTLEN     LOAD LENGTH OF ENTRY
         CH    R4,=H'12'     LENGTH = 12 ?
         BE    TSTALIAS      BRANCH IF YES
         CH    R4,=H'34'     LENGTH < 34 ?
         BL    GETSSI        BRANCH IF YES
         CH    R4,=H'38'     LENGTH = 38 ?
         BE    GETSSI        BRANCH IF YES
         TM    PDS2FTB0,X'10' SSI ?
         BZ    GETLKEDI      BRANCH IF NOT
         TM    PDS2FTB0,X'08' APF INFORMATION ?
         BZ    GETSSI        BRANCH IF NOT
         BCTR  R5,0          DECREASE BY APF INFORMATION
         BCTR  R5,0              LENGTH
GETSSI   EQU   *
         SH    R5,=H'4'      LOAD SSI ADDRESS
         UNPK  MS03SSI(9),0(5,R5) UNPACK SSI
         MVI   MS03SSI+8,C' ' MOVE BLANK
         TR    MS03SSI,TRTABLE-240 PREPARE SSI
         SPACE 2
*
*      LINKAGE INFORMATION PROCESSING.
*
         SPACE 1
GETLKEDI EQU   *
         TM    DS1RECFM,X'C0' RECFM = U (AS BUILT BY LINKAGE EDITOR) ?
         BNO   TSTALIAS      BRANCH IF NOT
         L     R4,ENTLEN     LOAD LENGTH OF ENTRY
         CH    R4,=H'34'     LENGTH DES ENTRY < 34 ?
         BL    TSTALIAS      BRANCH IF NOT
         SR    R15,R15       ZERO FOR IC COMMAND
         ICM   R15,7,PDS2STOR LOAD MEMBER LENGTH
         C     R15,=F'999999' LENGTH > 999999 ?
         BH    HIGHLEN       BRANCH IF YES
         BAL   R14,CONVDEC   BRANCH TO CONVERT TO DECIMAL
         MVC   MS03LEN,UNPKAREA+9 MOVE LENGTH
         B     TESTATTR      BRANCH
HIGHLEN  EQU   *
         MVC   MS03LEN,=C'******'
         EJECT
*
*      TEST ATTRIBUTES.
*
         SPACE 1
TESTATTR EQU   *
         LA    R4,ATTRTAB1-5 LOAD ADDRESS OF ATTRIBUTE TABLE
         LA    R5,ATTRVEC    LOAD ADDRESS OF ARTTIBUT VECTOR
         MVI   ATTRVEC,C' '
         MVC   ATTRVEC+1(79),ATTRVEC CLEAR VECTOR
         LA    R1,PDS2ATTR   LOAD ADDRESS OF ATTRIBUTE BYTE
         NI    FLAGBYTE,FLAGPAP CLEAR FLAG
         SR    R3,R3         ZERO FOR IC COMMAND
TSTALOOP EQU   *
         LA    R4,5(,R4)     LOAD ADDRESS OF NEXT TABLE ELEMENT
         CLI   0(R4),X'00'   END OF TABLE ?
         BE    TSTLPEND      IF YES, BRANCH TO LOOP END
         IC    R3,0(,R4)     INSERT ATTRIBUTE BYTE
         EX    R3,TMATTR     BRANCH TO TEST ATTRIBUTE
         BZ    NOATTR        BRANCH IF NO ATTRIBUTE
         CLC   0(5,R4),ATTREXEC MODULE EXECUTABLE ?
         BE    TSTALOOP      IF YES, BRANCH TO LOOP
         CLC   0(5,R4),ATTRNODC
         BE    TSTALOOP      IF YES, BRANCH TO LOOP
         MVC   0(4,R5),1(R4) MOVE ATTRIBUTE TEXT
INCRR5   EQU   *
         LA    R5,5(,R5)     LOAD ADDRESS OF NEXT VECTOR ELEMENT
         B     TSTALOOP      BRANCH TO LOOP
TSTLPEND EQU   *
         TM    FLAGBYTE,FLAGSAP SECOND ATTRIBUTE BYTE PROCESSED ?
         BO    TSTALPOK      IF YES, BRANCH TO END OF TEST
         OI    FLAGBYTE,FLAGSAP SET FLAG
         LA    R4,ATTRTAB2-5 LOAD ADDRESS OF ATTRIBUTE TABLE
         LA    R1,1(,R1)     LOAD ADDRESS OF ATTRIBUTE BYTE
         B     TSTALOOP      BRANCH TO LOOP
         SPACE 1
NOATTR   EQU   *
         CLC   0(5,R4),ATTREXEC MODULE EXECUTABLE ?
         BNE   *+14          BRANCH IF NOT
         MVC   0(4,R5),=C'NE  ' ATTRIBUTE = 'NOT EXECUTABLE'
         B     INCRR5        BRANCH
         CLC   0(5,R4),ATTRNODC
         BNE   TSTALOOP      BRANCH IF NOT
         MVC   0(4,R5),=C'DC  '
         B     INCRR5        BRANCH TO LOOP
         SPACE 1
TMATTR   TM    0(R1),X'00'   ATTRIBUTE ?
         SPACE 1
TSTALPOK EQU   *
         CLC   ATTRVEC+5(4),ATTRREUS+1 RENTERABLE AND REUASABLE ?
         BNE   MOVEAC        BRANCH IF NOT
         MVC   ATTRVEC+5(70),ATTRVEC+10 CLEAR 'REUS'
         MVC   0(4,R5),BLANK CLEAR DUPLICATE TEXT
         SH    R5,=H'5'      LOAD ADDRESS OF VECTOR END
         EJECT
*
*      MOVE AUTHORIZATION CODE.
*
         SPACE 1
MOVEAC   EQU   *
         TM    PDS2FTB0,X'08' APF-INFORMATIONEN SPECIFIED ?
         BZ    MVCATTR       BRANCH IF NOT
         MVC   0(3,R5),=C'AC=' MOVE TEXT
         L     R4,ADDRNENT   LOAD ADDRESS OF NEXT ENTRY
         TM    PDS2FTB0,X'10' SSI ?
         BO    GETAC         BRANCH IF YES
         TM    FLAGBYTE,FLAGALI MEMBER = ALIAS ?
         BO    GETAC         BRANCH IF YES
         BCTR  R4,0          END ADDRESS OF ENTRY
GETAC    EQU   *
         BCTR  R4,0          LOAD ADDRESS OF AC
         MVC   3(1,R5),0(R4) MOVE AC
         OI    3(R5),C'0'    MODIFY SIGN
         SPACE 2
*
*      MOVE ATTRIBUTE TEXTS.
*
         SPACE 1
MVCATTR  EQU   *
         LA    R5,ATTRVEC    LOAD ADDRESS OF ARTTIBUT VECTOR
MVCALOOP EQU   *
         MVC   MS03ATTR,0(R5) MOVE ATTRIBUTE TEXT
         LA    R5,20(,R5)    INCREASE ADDRESS IN VECTOR
         CLC   0(4,R5),BLANK END OF ATTRIBUTE VECTOR ?
         BE    TSTALIAS      BRANCH IF YES
         BAL   R14,MSGPUT    BRANCH MESSAGE OUTPUT
         MVC   MESSAGE(MSG03LEN),MSG03 MOVE MESSAGE SKELETON
         MVC   MESSAGE+12(54),MESSAGE+11 CLEAR MESSAGE AREA
         B     MVCALOOP      BRANCH TO LOOP
         EJECT
*
*      ROUTINE FOR ALIAS MEMBERS.
*
         SPACE 1
TSTALIAS EQU   *
         TM    FLAGBYTE,FLAGALI MEMBER = ALIAS ?
         BZ    GETRETAD      BRANCH IF NOT
         L     R4,ENTLEN     LOAD LENGTH OF ENTRY
         CH    R4,=H'44'     LENGTH < 44 ?
         BNL   MVCALINM      BRANCH IF NOT
         LA    R5,MS03ATTR+15
         CLC   MS03ATTR+15(5),BLANK ATTRIBUTES IN OUTPUT TEXT ?
         BE    MVCALIAS      BRANCH IF YES
         BAL   R14,MSGPUT    BRANCH MESSAGE OUTPUT
         MVC   MESSAGE+12(54),MESSAGE+11 CLEAR MESSAGE AREA
MVCALIAS EQU   *
         LA    R5,MS03ATTR   LOAD ADDRESS IN OUTPUT TEXT
         CLC   0(4,R5),BLANK ATTRIBUTES IN OUTPUT TEXT ?
         BE    *+12          BRANCH IF NOT
         LA    R5,5(,R5)     INCREASE ADDRESS
         B     MVCALIAS+4    BRANCH TO LOOP
         MVC   0(5,R5),ALIASTXT+1 SPECIFY ALIAS
         B     GETRETAD      BRANCH
MVCALINM EQU   *
         CLC   MS03ATTR(4),BLANK ATTRIBUTES IN OUTPUT TEXT ?
         BE    MVCATEXT      BRANCH IF NOT
         BAL   R14,MSGPUT    BRANCH MESSAGE OUTPUT
         MVC   MESSAGE+12(54),MESSAGE+11 CLEAR MESSAGE AREA
MVCATEXT EQU   *
         MVC   MS03ATTR(19),ALIASTXT MOVE TEXT
         L     R4,ADDRNENT   LOAD ADDRESS OF NEXT ENTRY
         TM    PDS2FTB0,X'08' APF INFORMATION ?
         BZ    *+8           BRANCH IF NOT
         BCTR  R4,0          DECREASE BY LENGTH OF
         BCTR  R4,0              APF INFORMATION
         TM    PDS2FTB0,X'10' SSI ?
         BZ    *+8           BRANCH IF NOT
         SH    R4,=H'4'      DECREASE BY LENGTH OF SSI
         SH    R4,=H'8'      ADDRESS OF MEMBER NAME
         MVC   MS03ATTR+10(8),0(R4) MOVE MEMBER NAME
GETRETAD EQU   *
         LA    R14,ENTRYLP   LOAD RETURN ADDRESS
         B     MSGPUT        BRANCH MESSAGE OUTPUT
         EJECT
***********************************************************************
*                                                                     *
*      ROUTINE FOR DIRECTORY STATISTICS.                              *
*                                                                     *
***********************************************************************
         SPACE 3
GETSTAT  EQU   *
         MVC   MESSAGE(MSG12LEN),MSG12 MOVE MESSAGE SKELETON
         LR    R15,R2        LOAD NUMBER OF BLOCKS
         CH    R15,=H'9999'  NUMBER OF BLOCKS > 9999 ?
         BH    *+14          IF YES, BRANCH TO MESSAGE OUTPUT
         BAL   R14,CONVDEC   BRANCH TO CONVERT TO DECIMAL
         MVC   MS12BLKS,UNPKAREA+11 MOVE NUMBER OF BLOCKS
         BAL   R14,ERROROUT  BRANCH TO MESSAGE OUTPUT
         MVC   MESSAGE(MSG13LEN),MSG13 MOVE MESSAGE SKELETON
         L     R15,USEDBLKS  LOAD NUMBER OF USED BLOCKS
         CH    R15,=H'9999'  NUMBER OF BLOCKS > 9999 ?
         BH    *+14          IF YES, BRANCH TO MESSAGE OUTPUT
         BAL   R14,CONVDEC   BRANCH TO CONVERT TO DECIMAL
         MVC   MS12BLKS,UNPKAREA+11 MOVE NUMBER OF BLOCKS
         L     R0,REG4       LOAD MCS-ID.
         WTO   MF=(E,MESSAGE) PUT MESSAGE LINE
         OI    FLAGBYTE,FLAGOUTP SIGNAL OUTPUT
         B     CLOSE         BRANCH TO CLOSE DATA SET
         EJECT
***********************************************************************
*                                                                     *
*      FINAL PROCESSING.                                              *
*                                                                     *
***********************************************************************
         SPACE 3
*
*      ROUTINE AT END OF ENTRIES.
*
         SPACE 1
ENTRYEND EQU   *
         TM    FLAGBYTE,FLAGTEST STATISTICS WANTED ?
         BZ    CLOSE         IF NOT, BRANCH TO CLOSE DATA SET
         OI    FLAGBYTE,FLAGEND SIGNAL END OF ENTRIES
         ST    R2,USEDBLKS   STORE NUMBER OF USED BLOCKS
         B     GETLOOP       BRANCH TO READ MORE BLOCKS
         SPACE 2
*
*      CLOSE DATA SET.
*
         SPACE 1
CLOSE    EQU   *
         LA    R1,DCBADDR    LOAD ADDRESS OF DCB ADDRESS
         SVC   20            BRANCH TO CLOSE DATA SET
         TM    FLAGBYTE,FLAGOUTP INFORMATION AVAILABLE ?
         BO    STOPWORK      BRANCH IF YES
         MVC   MESSAGE(MSG14LEN),MSG14 MOVE MESSAGE
         BAL   R14,ERROROUT  BRANCH TO MESSAGE OUTPUT
         SPACE 2
*
*     FREE MAIN STORAGE AREAS.
*     RELOAD REGISTERS,
*     RETURN.
*
         SPACE 1
STOPWORK EQU   *
         XRETURN ,R
         EJECT
***********************************************************************
*                                                                     *
*      MESSAGE OUTPUT.                                                *
*                                                                     *
***********************************************************************
         SPACE 3
MSGPUT   EQU   *
         ST    R14,SAVE1R14  SAVE RETURN ADDRESS
         L     R1,OUTCOUNT   LOAD OUTPUT COUNT
         BCTR  R1,0              AND DECREASE IT
         ST    R1,OUTCOUNT       AND STORE IT
         CLC   MS03MBRN,BLANK MESSAGE EXTENSION ?
         BE    GETREG4       BRANCH IF YES
         LTR   R1,R1         OUTPUT COUNT > 0 ?
         BP    GETREG4       BRANCH IF YES
         BAL   R14,WTORLOOP  BRANCH TO WTOR-MESSAGE OUTPUT
         OI    FLAGBYTE,FLAGHOUT SET FLAG
GETREG4  EQU   *
         TM    FLAGBYTE,FLAGHOUT HEAD LINE OUTPUT ?
         BZ    PUTLINE       BRANCH IF NOT
         L     R0,REG4       LOAD MCS-ID.
         WTO   MF=(E,HEADER) PUT HEAD LINE
         L     R0,REG4       LOAD MCS-ID.
         WTO   MF=(E,MSG03)  PUT HEAD LINE
         NI    FLAGBYTE,FLAGNOUT CLEAR FLAG
         LA    R1,10         INITIALIZE OUTPUT COUNT
         ST    R1,OUTCOUNT       AND STORE IT
PUTLINE  EQU   *
         L     R0,REG4       LOAD MCS-ID.
         WTO   MF=(E,MESSAGE) PUT MESSAGE LINE
         OI    FLAGBYTE,FLAGOUTP SIGNAL OUTPUT
         L     R14,SAVE1R14  LOAD RETURN ADDRESS
         BR    R14           RETURN
         EJECT
***********************************************************************
*                                                                     *
*      WTOR-MESSAGE OUTPUT.                                           *
*                                                                     *
***********************************************************************
         SPACE 3
WTORLOOP EQU   *
         XC    ECB,ECB       CLEAR EVENT CONTROL BLOCK
         L     R0,REG4       LOAD MCS-ID.
         LA    R4,ECB        LOAD ADDRESS OF ECB
         LA    R3,REPLY      LOAD ADDRESS OF REPLY
         MVC   WTORMSG(MSG09LEN),MSG09 MOVE MESSAGE SKELETON
         WTOR  ,(R3),1,(R4),MF=(E,WTORMSG) PUT MESSAGE LINE
         SPACE 1
         WAIT  ECB=ECB       WAIT FOR REPLY
         CLI   REPLY,C'Y'    REPLY = YES ?
         BER   R14           IF YES, BRANCH TO PROCESSING
         CLI   REPLY,C'N'    REPLY = NO ?
         BE    CLOSE         IF YES, BRANCH TO CLOSE DATA SET
         B     WTORLOOP      BRANCH TO WTOR-MESSAGE OUTPUT
         EJECT
***********************************************************************
*                                                                     *
*      ERROR ROUTINES.                                                *
*                                                                     *
***********************************************************************
         SPACE 3
*
*      PARAMETER ERROR ROUTINE.
*
         SPACE 1
PRMERROR EQU   *
         L     R0,REG4       LOAD MCS-ID.
         WTO   MF=(E,MSG05)  PUT ERROR MESSAGE
         B     STOPWORK      BRANCH TO FINAL PROCESSING
         SPACE 2
*
*      LOCATE ERROR ROUTINE.
*
         SPACE 1
LOCERROR EQU   *
         MVC   MESSAGE(MSG06LEN),MSG06 MOVE MESSAGE SKELETON
         BAL   R14,CONVDEC   BRANCH TO CONVERT TO DECIMAL
         MVC   MS06RC,UNPKAREA+13 MOVE RETURN CODE
         B     STOPWORK      BRANCH TO FINAL PROCESSING
         SPACE 2
*
*      OBTAIN ERROR ROUTINE.
*
         SPACE 1
OBTERROR EQU   *
         MVC   MESSAGE(MSG07LEN),MSG07 MOVE MESSAGE SKELETON
         BAL   R14,CONVDEC   BRANCH TO CONVERT TO DECIMAL
         MVC   MS07RC,UNPKAREA+13 MOVE RETURN CODE
         B     UNALLOC       BRANCH
         EJECT
*
*      INVALID DATA SET ERROR ROUTINE.
*
         SPACE 1
ORGERROR EQU   *
         MVC   MESSAGE(MSG08LEN),MSG08 MOVE MESSAGE SKELETON
         B     UNALLOC       BRANCH
         SPACE 2
*
*      ALLOCATION ERROR ROUTINE.
*
         SPACE 1
ALCERROR EQU   *
         MVC   MESSAGE(MSG10LEN),MSG10 MOVE MESSAGE SKELETON
         L     R15,DALPRC    LOAD RETURN CODE
         BAL   R14,CONVDEC   BRANCH TO CONVERT TO DECIMAL
         MVC   MS10RC,UNPKAREA+13 MOVE RETURN CODE
         UNPK  MS10EC(5),DALPEC+2(3) MOVE ERROR REASON CODE
         TR    MS10EC,TRTABLE-240 PREPARE ERROR REASON CODE
         MVI   MS10EC+4,C',' INSERT PAREN
         UNPK  MS10IC(5),DALPIC+2(3) MOVE INFORMATION REASON CODE
         TR    MS10IC,TRTABLE-240 PREPARE INFORMATION REASON CODE
         LA    R14,STOPWORK  LOAD RETURN ADDRESS
         B     ERROROUT      BRANCH TO MESSAGE OUTPUT
         SPACE 2
*
*      OPEN ERROR ROUTINE.
*
         SPACE 1
OPNERROR EQU   *
         MVC   MESSAGE(MSG11LEN),MSG11 MOVE MESSAGE SKELETON
UNALLOC  EQU   *
         BAL   R14,ERROROUT  BRANCH TO MESSAGE OUTPUT
         LA    R2,=CL12'UNALLOC ' LOAD ADDRESS OF DYNALLOC TYPE
         ST    R2,ADDRTYPE       AND STORE IT
         OI    ADDRDSN,X'80' SPECIFY END OF PARAMETER LIST
         LA    R1,DALPWKS    LOAD ADDRESS OF PARAMETER LIST
         L     R15,DYNADDR             LOAD ENTRY POINT OF SUBROUTINE
         BALR  R14,R15                 LINK TO SUBROUTINE
         CLI   DALPRC,X'00'  RETURN CODE = 0 ?
         BNZ   ALCERROR      IF NOT, BRANCH TO ERROR ROUTINE
         B     STOPWORK      BRANCH TO FINAL PROCESSING
         EJECT
***********************************************************************
*                                                                     *
*      OUTPUT OF ERROR MESSAGES.
*                                                                     *
***********************************************************************
         SPACE 2
ERROROUT EQU   *
         L     R0,REG4       LOAD MCS-ID.
         WTO   MF=(E,HEADER) PUT HEAD LINE
         L     R0,REG4       LOAD MCS-ID.
         WTO   MF=(E,MESSAGE) PUT ERROR MESSAGE
         BR    R14           RETURN
         SPACE 3
***********************************************************************
*                                                                     *
*      CONVERT BINARY TO UNPACKED DECIMAL VALUES.                     *
*                                                                     *
***********************************************************************
         SPACE 2
CONVDEC  EQU   *
         CVD   R15,DBWORD    CONVERT TO DECIMAL
         UNPK  UNPKAREA,DBWORD UNPACK
         OI    UNPKAREA+14,C'0' MODIFY SIGN
         BR    R14           RETURN
         EJECT
***********************************************************************
*                                                                     *
*      REGISTER EQUATES.                                              *
*                                                                     *
***********************************************************************
         SPACE 3
R0       EQU   0             MACRO AND PARAMETER REGISTER
R1       EQU   1             MACRO AND PARAMETER REGISTER
R2       EQU   2             WORK REGISTER
R3       EQU   3             WORK REGISTER
R4       EQU   4             WORK REGISTER
R5       EQU   5             WORK REGISTER
R6       EQU   6             WORK REGISTER
R7       EQU   7             WORK REGISTER
R8       EQU   8             WORK REGISTER
R9       EQU   9             WORK REGISTER
R10      EQU   10            BASE OF DSECT PDS
R11      EQU   11            BASE OF DSECT PARMAREA
R12      EQU   12            BASE OF CSECT LPDS
R13      EQU   13            BASE OF DSECT WKAREA
R14      EQU   14            RETURN ADDRESSES
R15      EQU   15            CSECT ADDRESSES AND RETURN CODES
         EJECT
***********************************************************************
*                                                                     *
*      CONSTANT AREAS.                                                *
*                                                                     *
***********************************************************************
         SPACE 3
*
*      PARAMETER LIST OF 'DYNALC' (CONSTANTS).
*
         SPACE 1
DALPCON  DS    0F
         DC    A(0)          ADDRESS OF RETURN CODES
         DC    A(DALPTYPE)   ADDRESS OF DYNALLOC TYPES
         DC    A(0)          ADDRESS OF DDNAME
         DC    A(0)          ADDRESS OF DATA SET NAME
         DC    A(0)
         DC    A(DALPSTAT)   ADDRESS OF DATA SET STATUS
         DC    A(DALPDISP)   ADDRESS OF NORM. DISPOSITION
         DC    A(DALPDISP)   ADDRESS OF COND. DISPOSITION
         DC    7A(0)
         DC    AL1(128)      ENDE OF PARAMETER LIST
         DC    AL3(0)        ADDRESS OF VOLUME SERIAL NUMBER
DALPLEN  EQU   *-DALPCON     LENGTH OF PARAMETER LIST
DALPSTAT DC    C'SHR'        DATA SET STATUS
DALPDISP DC    CL8'KEEP'     DATA SET DISPOSITION
DALPTYPE DC    C'DSALLOC '   DYNALLOC TYPE
DALPWAIT DC    C'WAIT'       WAIT REQUEST INDICATOR
         SPACE 2
*
*      TRANSLATION TABLE.
*
         SPACE 1
TRTABLE  DC    C'0123456789ABCDEF'
         SPACE 2
ALIASTXT DC    C'(ALIAS OF 12345678)'
         EJECT
*
*      ATTRIBUTE TABLES.
*
         SPACE 1
ATTRTAB1 EQU   *
         DC    X'80',C'RENT' REENTERABLE
ATTRREUS DC    X'40',C'REUS' REUSABLE
         DC    X'20',C'OVLY' IN OVERLAY STRUCTURE
         DC    X'10',C'TEST' UNDER TEST
         DC    X'08',C'OL  ' ONLY LOADABLE
         DC    X'04',C'SCTR' SCATTER FORMAT
ATTREXEC DC    X'02',C'EXEC' EXECUTABLE
         DC    X'00',C'    ' TABELLENSTOPWORK
         SPACE 1
ATTRTAB2 EQU   *
ATTRNODC DC    X'80',C'NODC'
         DC    X'10',C'NRLD' NO RLD ITEMS
         DC    X'08',C'NREP' NO REPROCESSABLE
         DC    X'04',C'SYMS'
         DC    X'01',C'REFR' REFRESHABLE
         DC    X'00'         TABLE END
ATRTBEND DC    C'    '
         EJECT
*
*      DATA CONTROL BLOCK (CONSTANTS).
*
         SPACE 1
DCBCONST DCB   DDNAME=INPUT000,                                        *
               DSORG=PS,                                               *
               MACRF=(GL),                                             *
               RECFM=F,                                                *
               LRECL=256,                                              *
               BLKSIZE=256,                                            *
               EODAD=GETSTAT
DCBLEN   EQU   *-DCBCONST    LENGTH OF DCB
         EJECT
***********************************************************************
*                                                                     *
*      MESSAGE AREA.                                                  *
*                                                                     *
***********************************************************************
         SPACE 3
MSG01    WTO   'XLPDS01 DSN=                                           *
                      ',                                               *
               MF=L,MCSFLAG=(REG0)
MSG01LEN EQU   *-MSG01
BLANK    EQU   MSG01+16
         SPACE 1
MSG02    WTO   'XLPDS02 CATALOG ON 123456 POINTS TO 123456',           *
               MF=L,MCSFLAG=(REG0)
MSG02LEN EQU   *-MSG02
         SPACE 1
MSG03    WTO   'XLPDS03 --NAME-- -TTR-- LENGTH --SSI--- -----ATTRIBUTES*
               -----',                                                 *
               MF=L,MCSFLAG=(REG0)
MSG03LEN EQU   *-MSG03
         SPACE 1
MSG04    WTO   'XLPDS04 FUNCTION SUPPORTED FO OS/VS2 (MVS) ONLY',      *
               MF=L,MCSFLAG=(REG0)
         EJECT
MSG05    WTO   'XLPDS05 ERROR IN PARAMETER LIST',                      *
               MF=L,MCSFLAG=(REG0)
         SPACE 1
MSG06    WTO   'XLPDS06 DATA SET NOT FOUND IN CATALOG, LOCATE RC=99',  *
               MF=L,MCSFLAG=(REG0)
MSG06LEN EQU   *-MSG06
         SPACE 1
MSG07    WTO   'XLPDS07 DATA SET NOT FOUND ON VOLUME, OBTAIN RC=99',   *
               MF=L,MCSFLAG=(REG0)
MSG07LEN EQU   *-MSG07
         SPACE 1
MSG08    WTO   'XLPDS08 DATA SET IS NOT PARTITIONED',                  *
               MF=L,MCSFLAG=(REG0)
MSG08LEN EQU   *-MSG08
         EJECT
MSG09    WTOR  'XLPDS09 REPLY ''Y'' (YES) OR ''N'' (NO) TO CONTINUE',  *
               MF=L,MCSFLAG=(REG0)
MSG09LEN EQU   *-MSG09
         SPACE 1
MSG10    WTO   'XLPDS10 ALLOCATION FAILURE, RC=99, EC=9999, IC=9999',  *
               MF=L,MCSFLAG=(REG0)
MSG10LEN EQU   *-MSG10
         SPACE 1
MSG11    WTO   'XLPDS11 OPEN FAILURE',                                 *
               MF=L,MCSFLAG=(REG0)
MSG11LEN EQU   *-MSG11
         SPACE 1
MSG12    WTO   'XLPDS12 **** DIRECTORY BLOCKS TOTAL',                  *
               MF=L,MCSFLAG=(REG0)
MSG12LEN EQU   *-MSG12
         SPACE 1
MSG13    WTO   'XLPDS13 **** DIRECTORY BLOCKS USED',                   *
               MF=L,MCSFLAG=(REG0)
MSG13LEN EQU   *-MSG13
         SPACE 1
MSG14    WTO   'XLPDS14 NO INFORMATION AVAILABLE',                     *
               MF=L,MCSFLAG=(REG0)
MSG14LEN EQU   *-MSG14
         EJECT
***********************************************************************
*                                                                     *
*      WORK AREAS.                                                    *
*                                                                     *
***********************************************************************
         SPACE 3
WKAREA   DSECT
SAVEAREA DS    18F           REGISTER SAVE AREA
DBWORD   DS    D             CVD WORK AREA
SAVE1R14 DS    F             RETURN ADDRESS SAVE AREA
USEDBLKS DS    F             NUMBER OF USED BLOCKS
ENTLEN   DS    F             LENGTH OF ENTRY
BLKLEN   DS    F             REMAINDER BLOCK LENGTH
ADDRNENT DS    F             ADDRESS OF NEXT ENTRY
OUTCOUNT DS    F             OUTPUT COUNT
DYNADDR  DS    F                       ENTRY POINT ADDR. OF SUBROUTINE
ECB      DS    F             EVENT CONTROL BLOCK
FROMNAME DS    CL8           FROM-PARAMETER
TONAME   DS    CL8           TO-PARAMETER
VOLSERNO DS    CL6           VOLUME SERIAL NUMBER
UNPKAREA DS    CL15          UNPK WORK AREA
ATTRVEC  DS    CL80          ATTRIBUTE VECTOR
REPLY    DS    C             REPLY CHARACTER
FLAGBYTE DS    C             MULTI CONTROL FLAG BYTE
FLAGTEST EQU   B'10000000'   X'80' - STATISTIC INFORMATION
FLAGEND  EQU   B'01000000'   X'40' - END OF ENTRIES
FLAGALI  EQU   B'00100000'   X'20' - ALIAS
FLAGNALI EQU   B'11011111'   X'DF' - NO ALIAS
FLAGSAP  EQU   B'00010000'   X'10' - SECOND ATTRIBUTE BYTE PROCESSING
FLAGPAP  EQU   B'11101111'   X'EF' - PRIMAX ATTRIBUTE BYTE PROCESSING
FLAGHOUT EQU   B'00001000'   X'08' - HEAD LINE OUTPUT
FLAGNOUT EQU   B'11110111'   X'F7' - NO HEAD LINE OUTPUT
FLAGOUTP EQU   B'00000100'   X'04' - INFORMATION AVAILABLE
         EJECT
*
*      DCB OF INPUT DATA SET.
*
         SPACE 1
INPUT    DS    0F
         DS    10F
DCBDDN   DS    CL8           DDNAME
DCBOFLGS DS    C             FLAG BYTE
         ORG   INPUT+DCBLEN
DCBADDR  DS    F             ADDRESS OF DCB
         SPACE 2
*
*      CAMLIST AREA.
*
         SPACE 1
CAMLIST  DS    4F            CAMLIST MACRO PARAMETER LIST
         DS    0D
CAMWKFLD DS    0CL265        WORK FIELD
         SPACE 2
*
*      CATALOG VOLUME SERIAL LIST.
*
         SPACE 1
         ORG   CAMWKFLD+6
CAMVOLI  DS    CL6           VOLUME SERIAL NUMBER
         ORG   CAMWKFLD+259
CAMCVOL  DS    CL6           VOLUME SERIAL NUMBER OF CVOL
         EJECT
*
*      DSCB1.
*
         SPACE 1
         ORG   CAMWKFLD
DS1FMTID DS    C             FORMAT IDENTIFIER (= C'1')
         DS    CL37
DS1DSORG DS    CL2           DATA SET ORGANISATION
DS1RECFM DS    C             DATA SET RECORD FORMAT
         DS    C
DS1BLKL  DS    CL2           DATA SET BLOCK LENGTH
DS1RECL  DS    CL2           DATA SET RECORD LENGTH
         DS    CL3
DS1DSIND DS    C             DATA SET INDICATORS
DS1CCHHR DS    CL5           CCHHR-ADDRESS OF DSCB1
         ORG   CAMWKFLD+265
         SPACE 2
*
*      PARAMETER LIST OF 'DYNALC' (WORK AREA).
*
         SPACE 1
DALPWKS  DS    0F
ADDRRC   DS    F             ADDRESS OF RETURN CODES
ADDRTYPE DS    F             ADDRESS OF DYNALLOC TYPES
ADDRDDN  DS    F             ADDRESS OF DDNAME
ADDRDSN  DS    F             ADDRESS OF DSNAME
         DS    11F
ADDRVOLI DS    F             ADDRESS OF VOLUME SERIAL NUMBER
         SPACE 1
DALPRC   DS    F             RETURN CODE
DALPEC   DS    F             ERROR REASON CODE
DALPIC   DS    F             INFORMATION REASON CODE
DALPDDN  DS    CL8           DDNAME
         EJECT
*
*      MESSAGE WORK AREAS.
*
         SPACE 1
HEADER   DS    0F            HEADER LINE
         ORG   HEADER+16
DSNAME   DS    CL44          DATA SET NAME
         ORG   HEADER+MSG01LEN
         SPACE 1
WTORMSG  DS    0F            WTOR-MESSAGE LINE
         ORG   WTORMSG+MSG09LEN
         SPACE 1
MESSAGE  DS    0F            MESSAGE LINE
         ORG   MESSAGE+12
         DS    CL11
MS02CVOL DS    CL6           CVOL NUMBER
         DS    CL11
MS02VOLI DS    CL6           VOLUME SERIAL NUMBER
         ORG   MESSAGE+12
MS03MBRN DS    CL8           MEMBER NAME
         DS    C
MS03TTR  DS    CL6           ADDRESS OF MEMBER (TTR)
         DS    C
MS03LEN  DS    CL6           LENGTH OF MEMBER
         DS    C
MS03SSI  DS    CL8           SSI INFORMATION
         DS    C
MS03ATTR DS    CL22          MODULE ATTRIBUTES
         ORG   MESSAGE+12
         DS    CL41
MS06RC   DS    CL2           RETURN CODE
         ORG   MESSAGE+12
         DS    CL40
MS07RC   DS    CL2           RETURN CODE
         ORG   MESSAGE+12
         DS    CL23
MS10RC   DS    CL2           RETURN CODE
         DS    CL5
MS10EC   DS    CL4           ERROR REASON CODE
         DS    CL5
MS10IC   DS    CL4           INFORMATION REASON CODE
         ORG   MESSAGE+12
MS12BLKS DS    CL4           NUMBER OF BLOCKS
         ORG   MESSAGE+66
         SPACE 1
WKAREAL  EQU   *-WKAREA      TOTAL LENGTH OF WORK AREAS
         EJECT
***********************************************************************
*                                                                     *
*      INPUT PARAMETER AREA.                                          *
*                                                                     *
***********************************************************************
         SPACE 3
         XPARM
         SPACE 3
***********************************************************************
*                                                                     *
*      PARTITIONED DATA SET ENTRY.                                    *
*                                                                     *
***********************************************************************
         SPACE 3
PDS      DSECT
PDS2NAME DS    CL8           MEMBER NAME
PDS2TTRP DS    CL3           TTR OF FIRST BLOCK
PDS2INDC DS    C             INDICATORS
PDS2TTRT DS    CL3
PDS2ZERO DS    C
PDS2TTRN DS    CL3
PDS2NL   DS    C
PDS2ATTR DS    CL2           ATTRIBUTE FIELD
PDS2STOR DS    CL3           TOTAL LENGTH OF MEMBER
PDS2FTBL DS    CL2
PDS2EPA  DS    CL3
PDS2FTB0 DS    CL3           FLAG BYTES
         EJECT
         END   LPDS
./ ADD  NAME=MEMTERM
         TITLE 'MEMTERM,  FORCE MEMORY TERMINATION BY JOBNAME OR ASID'
MEMTERM  CSECT
         SPACE 3
*              REGISTER USAGE AND EQUATES
         SPACE 3
R0       EQU   0
R1       EQU   1                        WORK REGISTER
R2       EQU   2                        JOBNAME LENGTH
R3       EQU   3                        ASVT, CURRENT ASCB
R4       EQU   4                        ASCB ADDRESS
R5       EQU   5                        JBNI FIELD ADDRESS
R6       EQU   6                        WORK REGISTER
R7       EQU   7                        CURRENT ASID
R8       EQU   8                        MAXU
R9       EQU   9
R10      EQU   10                       BRANCH REGISTER
R11      EQU   11                       ADDRESS OF PARMAREA
R12      EQU   12                       BASE REGISTER
R13      EQU   13                       SAVE AREA, WORK AREA
R14      EQU   14                       RETURN REGISTER
R15      EQU   15                       ENTRY POINT
         EJECT
         XSAVE R12,,MEMTERM,LENGTH
         USING PARMAREA,R11
         USING WORK,R13
         B     GO
VERSION  DC    CL8'V01-M03'
         CNOP  0,4
GO       EQU   *
         LR    R11,1
         LA    R4,WORK+72
         L     R5,ALENGTH
         LA    R6,WORK+72
         SR    R7,R7
         MVCL  R4,R6
         MVC   DUMPSAVE(4),=CL4'SAVE'
         MVI   ASIDSW,X'00'
         MVC   CNID,REG4                SAVE CONSOLE ID
         L     R6,16                    GET CVT ADDRESS
         TM    116(R6),X'01'            TEST FOR MVS SYSTEM
         BZ    NONMVS
       MODESET KEY=ZERO
         TS    LOCK
         BNZ   INUSE
ASVT     EQU   *
         L     R3,556(R6)               GET ASVT ADDRESS
         L     R8,516(R3)               LOAD MAXU
         LA    R3,528(R3)               POINT TO FIRST ASCB ENTRY
MISS     EQU   *
         CLI   11(R11),C','             TEST JOBNAME MISSING
         BNE   NOJOBN
         CLI   12(R11),C' '             TEST JOBNAME MISSING
         BE    NOJOBN
         CLC   12(5,R11),=C'ASID='      TEST FOR ASID KEYWORD
         BE    BYASID
         B     BYJBNM
BYASID   EQU   *                        MEMORY TERMINATION BY ASID
         MVI   ASIDSW,X'F0'             SET ASID SWITCH ON
         XC    JOBWK,JOBWK
         MVC   JOBWK(4),17(R11)         MOVE ZONED ASID TO WORK AREA
         BAL   R10,DGTST                TEST AND CONVERT INPUT
         ST    R7,ASID1                 SAVE ASID
         CR    R7,R8                    ASID GT MAX USER ?
         BH    NOASID                   YES, I CAN DO NOTHING FOR YOU
         B     FOUND                    DO NOT SEARCH ASID ACTIVE
BYJBNM   EQU   *                        MEMORY TERMINATION BY JOBNAME
         MVC   JOBN1,BLANK
         MVC   JOBWK,12(R11)            MOVE JOBNAME TO WORKAREA
         BAL   R10,JBNTST               GOTO TEST LENGTH OF JOBNAME
         ST    R2,JOBN1L                SAVE JOBNAME LENGTH
         BCTR  R2,0                     SUBTRACT ONE
         EX    R2,JBN1MVC               MOVE NOW JOBNAME
LDASCB   EQU   *
         L     R4,0(R3)                 LOAD ASCB ADDRESS
         TM    0(R3),X'80'              TEST FOR AVAILABLE ENTRY
         BO    NASGN                    ENTRY IS NOT ASSIGNED
         SR    R7,R7                    CLEAR REGISTER
         LH    R7,36(R4)                LOAD ASID
JBNI     L     R5,172(R4)               LOAD JOBNI ADDRESS
         LTR   R5,R5                    TEST FOR ZERO ADDRESS
         BZ    JBNS                     TRY JBNS FIELD
         CLC   0(8,R5),JOBN1            COMPARE JOBNAME
         BNE   JBNS                     NOT FOUND
         MVI   JBNID,C'I'               SET IDENTIEFIER
         B     FOUND
JBNS     L     R5,176(R4)               LOAD JOBNS ADDRESS
         LTR   R5,R5                    TEST FOR ZERO ADDRESS
         BZ    NASGN                    GO TO TRY NEXT ASCB
         CLC   0(8,R5),JOBN1            COMPARE JOBNAME
         BNE   NASGN                    NO SUCCESS
         MVI   JBNID,C'S'               SET IDENTIEFIER
         B     FOUND
NASGN    LA    R3,4(R3)                 INCREMENT ASID ENTRY
         BCT   R8,LDASCB                LOOP UP TO MAXU
         B     NOEXEC                   JOBNAME IS NOT EXECUTING
FOUND    EQU   *                        BE HAPPY, JOBNAME IS FOUND
JOBNWTOR XC    CNECB,CNECB
         XC    CNINP,CNINP
         MVC   CNTXT,MSG3               PREPARE WTOR FOR JOBNAME
         L     R0,CNID
         WTOR  ,CNINP,9,CNECB,MF=(E,CNTXT)
         WAIT  ECB=CNECB                WAIT FOR SLOWEST OPERATOR
         OC    CNINP,BLANK              CONVERT INPUT
         TM    ASIDSW,X'F0'             ASID SWITCH ON ?
         BO    ASIDON                   MEMORY TERMINATION BY ASID
         MVC   JOBN2(8),CNINP           SAVE JOBNAME
         CLC   JOBN1,JOBN2              COMPARE WITH JOBNAME FROM
         BNE   JBNNEQU                  . MODIFY COMMAND
EQUAL    EQU   *
         ST    R7,ASIDC                 SAVE CURRENT ASID
         C     R7,SYSTSK                CHECK FOR ASID USED FOR SYSTEM
         BH    KILLNOW                  IT WAS A USER ASID
MVSWTOR  EQU   *                        ASID IS USED FOR MVS ITSELF
         XC    CNECB,CNECB              SETUP FOR WTOR XMTERM7
         MVC   CNINP,BLANK
         MVC   CNTXT,MSG7
         L     R0,CNID
         WTOR  ,CNINP,8,CNECB,MF=(E,CNTXT)
         WAIT  ECB=CNECB                WAIT FOR OPERATOR'S CHOICE
         OC    CNINP,BLANK
         CLC   YES,CNINP                IS REPLY 'YES' ???
         BNE   RETURN                   VERY NICE, I CAN RETURN NOW
OVRKILL  L     R0,CNID                  SEND HORRIBLE MESSAGE
         WTO   MF=(E,MSG$)
         B     KILLNOW                  KILL MVS
KILLNOW  EQU   *
       MODESET KEY=ZERO,MODE=SUP
         LR    R6,R13                   SAVE R13 BECAUSE RTM NEEDS ITS
         LA    R13,SAVE2                OWN SAVE AREA
         BC    0,SKIPRTM                FOR SZAP TO DEACTIVATE RTM
*      CALLRTM TYPE=MEMTERM,COMPCOD=255,ASID=(R7)
         LA    R1,255 ***************** LOAD PARAMETER REG1
         SLL   1,12(0) **************** COMPCODE IN POSITION
         LA    0,136(,0) ************** DUMP/STEP/DUMPOPTS/ASID
         SLL   0,24(0) **************** SHIFT TO HIGTH ORDER BYTE
         OR    1,0 ******************** OR IN WITH COMPCODE
         LR    2,R7 ******************* GET REG2 WITH ASID
         L     15,X'10'(,0) *********** GET CVT ADDRESS
         L     15,52(,15) ************* ADDR OF CVTBTERM TABLE
         L     15,32(,15) ************* ADDRESS OF ENTRY POINT
         BALR  14,15 ******************
SKIPRTM  EQU   *
         LR    R13,R6                   RESTORE SAVE AREA
END0     EQU   *
         UNPK  CASID(9),ASIDC(5)        PREPARE FOR MSG 8
         TR    CASID(8),ZTAB
         XC    CNTXT,CNTXT
         MVC   CNTXT,MSG8               SET UP MSG 8
         MVC   CNTXT+32(4),CASID+4      STORE ASID IN MESSAGE
         MVC   CNTXT+41(1),JBNID        MOVE JOBNAME FOUND ID
         L     R0,CNID
         WTO   MF=(E,CNTXT)             SEND FINAL MESSAGE
RETURN   EQU   *
       MODESET KEY=NZERO,MODE=PROB
       XRETURN 0,R
         EJECT
JBNTST   EQU   *                        JOBNAME TEST ROUTINE
         MVI   JOBEND,C'*'              MOVE END INDICATOR
         OC    JOBWK,BLANK
         LA    R2,JOBWK                 LOAD POINTER
         LR    R1,R2
JBNTST1  CLI   0(R2),C'A'
         BL    JBNTST8                  PROBABLE LENGTH FOUND
JBNTST2  LA    R2,1(R2)                 INCREMENT BY ONE
         B     JBNTST1
JBNTST8  CLI   0(R2),C'#'               VALID
         BE    JBNTST2
         CLI   0(R2),C'$'                    ANS
         BE    JBNTST2
         CLI   0(R2),C'@'                         CHARACTER
         BE    JBNTST2
         SR    R2,R1                    CALCULATE LENGTH FOR MOVE
         BR    R10                      RETURN TO CALLER
DGTST    EQU   *                        DIGITAL TEST AND CONVERTION
         LA    R1,4                     LOOP 4 TIMES
         LA    R6,JOBWK                 LOAD POINTER
DGTST2   TM    0(R6),X'F0'              TEST FOR X'F0' TO X'F9'
         BNO   NOASID                   INVALID INPUT
         LA    R6,1(R6)                 INCREMENT
         BCT   R1,DGTST2                LOOP
         PACK  DWORD,JOBWK(4)           PREPARE FOR CVB
         CVB   R7,DWORD                 AND DO IT NOW
DGTST9   BR    R10                      RETURN TO CALLER
ASIDON   EQU   *
         CLC   CNINP(5),=C'ASID='       TEST FOR ASID KEYWORD
         BNE   NOJOBN
         OI    ASIDSW,X'FF'             SET 2ND ASIDSW ON
         XC    JOBWK,JOBWK
         MVC   JOBWK(4),CNINP+5         MOVE ZONED ASID TO WORK AREA
         BAL   R10,DGTST                TEST AND CONVERT INPUT
         ST    R7,ASID2                 SAVE ASID
         CLC   ASID1,ASID2              TEST FOR EQUAL ASID'S
         BNE   JBNNEQU
         B     EQUAL
NOASID   EQU   *
         MVC   CNTXT,MSG9               MOVE MESSAGE SKELETON
         L     R0,CNID
         MVC   CNTXT+18(4),JOBWK        MOVE INVALID ASID TO MESSAGE
         WTO   ,MF=(E,CNTXT)
DUMP     EQU   *                        FOR FUTURE EXPANSION
         STM   R0,R15,DUMPSAVE+4        SAVE REGISTERS
         DC    F'0'                     FORCE ABEND 0C1
NONMVS   EQU   *
         L     R0,CNID
         WTO   MF=(E,MSG6)
         B     RETURN
INUSE    EQU   *
         L     R0,CNID
         WTO   MF=(E,MSG1)
         B     RETURN
NOJOBN   EQU   *
         L     R0,CNID
         WTO   MF=(E,MSG2)
         B     RETURN
NOEXEC   EQU   *
         L     R0,CNID
         MVC   CNTXT,MSG5
         MVC   CNTXT+13(8),JOBN1        MOVE JOBNAME INTI MESSAGE
         WTO   ,MF=(E,CNTXT)
         B     RETURN
JBNNEQU  EQU   *
         L     R0,CNID
         WTO   MF=(E,MSG4)
         B     RETURN
         EJECT
MSG0     WTO   'XMTERM0',                                              *
               MCSFLAG=REG0,MF=L
MSG1     WTO   'XMTERM1  MEMORY TERMINATION ALLREADY IN USE',          *
               MCSFLAG=REG0,MF=L
MSG2     WTO   'XMTERM2  JOBNAME OR ASID MISSING BUT REQUIRED',        *
               MCSFLAG=REG0,MF=L
MSG3     WTOR  'XMTERM3  SPECIFY JOBNAME OR ASID FOR MEMORY TO BE TERMI*
               NATED',                                                 *
               MCSFLAG=REG0,MF=L
MSG4     WTO   'XMTERM4  JOBNAME OR ASID JUST GIVEN IS NOT EQUAL TO JOB*
               NAME IN MODIFY COMMAND',                                *
               MCSFLAG=REG0,MF=L
MSG5     WTO   'XMTERM5  JJJJJJJJ IS NOT EXECUTING',                   *
               MCSFLAG=REG0,MF=L
MSG6     WTO   'XMTERM6  NO MVS SYSTEM, MEMTERM MUST TERMINATE',       *
               MCSFLAG=REG0,MF=L
MSG7     WTOR  'XMTERM7  YOU WOULD LIKE TO KILL A MEMORY USED BY MVS IT*
               SELF ???',                                              *
               MCSFLAG=REG0,MF=L
MSG8     WTO   'XMTERM8  MEMORY WITH ASID=X''HHHH''(JBNX) HAS BEEN INIT*
               IALIZED FOR TERMINATION',                               *
               MCSFLAG=REG0,MF=L
MSG9     WTO   'XMTERM9  ASID=XXXX IS NOT VALID',                      *
               MCSFLAG=REG0,MF=L
MSG$     WTO   'XMTERM*  *** MEMTERM''S MVS OVERKILL NOW ACTIVE ***',  *
               MCSFLAG=REG0,MF=L
         EJECT
SYSTSK   DC    F'3'                     HIGHEST ASID FOR MVS ITSELF
ALENGTH  DC    A(LENGTH-72)             LENGTH OF WORK AREA MINUS SAVE
LOCK     DC    X'00'                    LOCK BYTE
YES      DC    CL8'YES'
NO       DC    CL8'NO'
BLANK    DC    CL8' '
         DC    A(16777215)
JBN1MVC  MVC   JOBN1(0),JOBWK
JBN2MVC  MVC   JOBN2(0),JOBWK
         ORG   *-240                    TRANSLATE TABLE
ZTAB     EQU   *
         ORG   *+240
         DC    CL16'0123456789ABCDEF'
         SPACE 6
         LTORG
         EJECT
         XPARM
         SPACE 6
WORK     DSECT
SAVE     DS    18F                      STANDARD SAVE AREA
SAVE2    DS    18F                      SAVE AREA FOR CALLRTM BECAUSE
RSVD0    DS    0F                       RTM WILL DO 'STM 0,15,8(13)'
DUMPSAVE DS    18F                      SAVE AREA IN CASE OF ABEND 0C1
CNID     DS    F                        CONSOLE ID
CNECB    DS    F                        WTOR ECB
CNINP    DS    2D                       WTOR REPLY AREA
JOBN1    DS    D                        JOBNAME FROM MODIFY COMMAND
JOBN2    DS    D                        JOBNAME FROM WTOR MSG XMTERM3
JOBN1L   DS    F                        LENGTH OF JOBNAME 1
JOBN2L   DS    F                        LENGTH OF JOBNAME 2
ASIDC    DS    F                        CURRENT ASID
ASID1    DS    F                        ASID 1 SAVE AREA
ASID2    DS    F                        ASID 2 SAVE AREA
RSVD1    DS    F
CASID    DS    CL8                      HEX ASID IN UNPACKED FORMAT
RSVD2    DS    CL8
         DS    0F
CNTXT    DS    CL80                     WORK AREA FOR WTOR'S
RSVD3    DS    F
DWORD    DS    D                        WORK AREA FOR CVB INSTR
JOBWK    DS    CL8                      WORK AREA FOR JOBNAME TESTING
JOBEND   DS    CL1                      END OF JOBWK
ASIDSW   DS    CL1                      ASID SWITCH
JBNID    DS    CL1                      JOBNAME FOUND IDENTIFIER
LENGTH   EQU   *-WORK
         EJECT
*CVTMAP   CVT   DSECT=YES
         EJECT
         PRINT NOGEN
*         IHAPSA  DSECT=YES
         PRINT GEN
         SPACE 6
         END   MEMTERM
./ ADD  NAME=MSG
MSG      CSECT
         XSAVE R12,,MSG,WORKL
         LR    R14,R1
         USING PARMAREA,R14
         USING WORK,R13
         XC    SWITCH,SWITCH
         LA    R4,TEXT+4
         L     R10,REG4
         L     R5,16                   CVT - ADRESSE
         L     R5,100(R5)              CONSOLE UCB-LISTE
         L     R6,72(R5)
         L     R7,76(R5)    LENGTH OF EACH UCM
         L     R5,80(R5)    ADDRESS OF LAST UCM
         CLI   0(R4),C''''
         BNE   NEXTNTRY
         OI    SWITCH,X'80'
         B     ACTALL
NEXTNTRY EQU   *
         L     R8,12(R6)     ADDRESS OF UCB
         CLC   13(3,R8),0(R4)    CUU'S MATCHING?
         BE    FOUND     YES, BRANCH
         CR    R6,R5    LAST UCM REACHED?
         BNE   NOER
         LA    2,NOTFOUND
         B     GETKSP
NOER     EQU   *
         LA    R6,0(R7,R6)   INCREASE POINTERLE TO NEXT UCM
         B     NEXTNTRY
FOUND    EQU   *
         SR    R0,R0
         IC    R0,26(R6)
         ST    R0,R0SAVE
         LR    R11,R4   R11 = CUU IN MSG-COMMAND
         TM    25(R6),X'10'            CONSOLE ACTIVE ?
         BO    ACTIVE
         LA    2,NOTACTIV
         B     GETKSP
ACTIVE   EQU   *
         LA    R4,4(R4)
ACTALL   EQU   *
         CLI   0(R4),C''''
         BE    PRMOK
ERROR    EQU   *
         LA    2,ERRPRM
         B     GETKSP
PRMOK    EQU   *
         LA    R5,1(R4)
         LR    R4,R5
         LA    R6,0
NEXTCHAR EQU   *
         LA    R4,0(R6,R5)
         CLI   0(R4),C''''             SEARCH ENDING APOSTROPH
         BE    ENDMSG
         LA    R6,1(R6)
         CH    R6,=H'101'
         BNL   ERROR
         B     NEXTCHAR
ENDMSG   EQU   *
         LA    R1,MESSAGE
         LR    R9,R1
         LA    R6,16(R6)
         STH   R6,0(R1)
         MVC   2(2,R1),=X'E000'
         MVC   11(3,R1),0(R11)   MOVE CUU FROM MSG-COMMAND
         TM    SWITCH,X'80'
         BNO   NOTALL
         MVI   2(R1),X'80'
         MVC   11(3,R1),=CL3'ALL'
NOTALL   EQU   *
         MVC   7(4,R1),=C' TO '
         MVC   16(100,R1),0(R5)
         LA    R7,0(R6,R1)
         MVC   0(4,R7),=X'0000FFFF'
         TM    SWITCH,X'80'
         BO    *+10
         MVC   2(2,R7),=X'0000'
         SR    R11,R11     CLEAR REGISTER FOR IC
         L     R5,16      CVT
         L     R5,100(R5)     POINTER TO CONLOLE UCB'S  (UCM-PREFIX)
         L     R6,72(R5)    ADDR. OF 1. UCM
         L     R7,76(R5)    LENGTH OF EACH UCM
         L     R5,80(R5)    ADDR. OF LAST UCM
NXTNTRY  EQU   *
         IC    R11,26(R6)    INSERT UCM-ID FROM CURRENT UCM
         CR    R11,R10   COMPARE WITH PASSED ID
         BE    CONSOK      THE ISSUING CONSOLE EXISTS - BRANCH
         CR    R6,R5  IF END OF LIST OF UCM'S,CHECK MEMORY OF COMPUTER
         BE    ERROR
         LA    R6,0(R7,R6)  THERE IS A HOPE TO FIND UCM, INCR. PTR.
         B     NXTNTRY    AND BRANCH
CONSOK   EQU   *
         L     R5,12(R6)   UCB-ADDR.
         MVC   4(3,R1),13(R5)
         MVC   14(2,R1),=C': '
         L     R0,R0SAVE
         WTO   MF=(E,MESSAGE)
RETURN   EQU   *
         XRETURN ,R
GETKSP   EQU   *
         MVC   MESSAGE,0(R2)
         L     R0,REG4
         WTO   MF=(E,MESSAGE)
         B     RETURN
NOTFOUND WTO   'XMSG001 SPECIFIED CONSOLE NOT FOUND',MF=L,             *
               MCSFLAG=(REG0)
NOTACTIV WTO   'XMSG002 CONSOLE NOT ACTIVE',MCSFLAG=REG0,              *
               MF=L
ERRPRM   WTO   'XMSG003 ERROR IN PARAMETER',MCSFLAG=REG0,              *
               MF=L
         REG
WORK     DSECT
SVA      DS    18F
R0SAVE   DS    F
MESSAGE  DS    CL120
SWITCH   DS    X
WORKL    EQU   *-WORK
         XPARM
         END
./ ADD  NAME=OCEWAREA
*/*  INCLUDE SYSLIB(OCEWAREA)                                  Y02134*/
*  % GOTO PLSGEN;                       /*EXPAND PLS PORTION   Y02134*/
*/*                                                              Y02134
         MACRO
         OCEWAREA &IOB=YES                                       S21940
.*
.**********************************************************************
.*
.*       VS2 RELEASE 03 DELETIONS/CHANGES
.*0000                                                         @ZA02504
.*
.* MODULE NAME = OCEWAREA (VS2-2)
.*
.* DESCRIPTIVE NAME = O/C/E WORK AREA ADDRESSING MACRO
.*
.* COPYRIGHT = NONE.
.*
.* STATUS = CHANGE LEVEL 000
.*
.* FUNCTION = O/C/E MACRO USED TO PROVIDE ADDRESSABILITY TO INTERNAL
.*            WORK AREAS.
.*
.* NOTES = NONE.
.*
.*      DEPENDENCIES = IEFJFCBN (JFCB = 176 BYTES IN LENGTH).
.*                     ONLY IN BAL VERSION.                      Y02134
.*
.*      RESTRICTIONS = CHANGES TO THIS MACRO MUST BE COORDINATED
.*                     WITH THE IECDSECS MACRO AND FUNCTIONS
.*                     WHICH INTERFACE INTERNALLY WITH O/C/E
.*                     ROUTINES. THIS MACRO WAS DESIGNED TO
.*                     BE USED IN A DSECT.
.*
.*      REGISTER CONVENTIONS = NOT APPLICABLE.
.*
.* PATCH LABEL = NOT APPLICABLE.
.*
.* MODULE TYPE = MACRO.
.*
.*      PROCESSOR = ASSEMBLER LANGUAGE.
.*
.*      MODULE SIZE = DESCRIBED BY THE LABEL DSECTSIZ. THE ACTUAL
.*                    WORK AREA SIZE IS DESCRIBED BY LABELS WITHIN
.*                    IECDSECS.
.*
.*      ATTRIBUTES = DSECT FIELDS.
.*
.* ENTRY POINT = DXLBL IN BAL VERSION                            Y02134
.*               FORCORE IN PLS VERSION                          Y02134
.*
.*      PURPOSE = THIS MACRO IS TO BE USED IN CONJUNCTION WITH
.*                THE IECDSECS MACRO TO DEFINE AND MAP INTERNAL
.*                WORK AREAS USED BY O/C/E AND FUNCTIONS WHICH
.*                INTERNALLY INTERFACE WITH O/C/E. THIS MACRO IS
.*                CALLED BY O/C/E CSECTS AT ASSEMBLY TIME.
.*
.*      LINKAGE = OCEWAREA IOB=(YES/NO) FOR BAL CALL             Y02134
.*                % INCLUDE SYSLIB(OCEWAREA) IN PLS CALL         Y02134
.*
.*      INPUT = IOB=, IOB=YES, OR IOB=NO.
.*
.*            IF IOB=YES OR IOB=, (DEFAULT) IS SPECIFIED, INTERNALLY
.*            DEFINED FIELDS IN THE IOB ARE GENERATED. THE LABELS
.*            FOR THESE FIELDS ARE MUTUALLY EXCLUSIVE OF THE LABELS
.*            GENERATED BY THE IOBLOCKS MACRO.
.*            FOR A PLS CALL THE IOB AREA IS EXPANDED            Y02134
.*            WITHOUT IOB LABELS.                                Y02134
.*
.*      OUTPUT = MAPPING OF COMMON O/C/E WORK AREA.
.*               SEE COMMENTS BELOW.
.*
.* EXIT NORMAL = MEND STATEMENT
.*
.* EXIT ERROR = IHBERMAC 183,IOB,YES
.*
.* EXTERNAL REFERENCES = SEE BELOW.
.*
.*      ROUTINES = NONE.
.*
.*    1 DATA AREAS = O/C/E COMMON WORK AREA.
.*      2 DATA AREAS = VOLUME LABEL AREA.
.*        3 DATA AREAS = ANSI VOLUME LABEL AREA.
.*        3 DATA AREAS = FILE LABEL 1 AREA.
.*        3 DATA AREAS = FILE LABEL 2 AREA.
.*        3 DATA AREAS = ANSI FILE LABEL 2 AREA.
.*        3 DATA AREAS = DATA SET CONTROL BLOCK LABEL AREA (DSCB).
.*        3 DATA AREAS = DATA SET CONTROL BLOCK FORMAT 3 KEY AREA.
.*        3 DATA AREAS = DATA SET CONTROL BLOCK FORMAT 3 RECORD AREA.
.*        3 DATA AREAS = MESSAGE AREA.
.*        3 DATA AREAS = MESSAGE LENGTHS.
.*        3 DATA AREAS = MESSAGE FORMAT.
.*      2 DATA AREAS = JOB FILE CONTROL BLOCK AREA (JFCB).
.*      2 DATA AREAS = O/C/E INTERNAL EVENT CONTROL BLOCK AREA (ECB).
.*      2 DATA AREAS = O/C/E INTERNAL INPUT/OUTPUT BLOCK AREA (IOB).
.*      2 DATA AREAS = O/C/E INTERNAL DATA EXTENT BLOCK AREA (DEB).
.*      2 DATA AREAS = O/C/E INTERNAL DATA CONTROL BLOCK AREA (DCB).
.*      2 DATA AREAS = O/C/E INTERNAL CONTROL WORDS AREA (CCW).
.*      2 DATA AREAS = O/C/E COMMON EXTENDED WORK AREAS.
.*      2 DATA AREAS = O/C/E PROTECTED CONTROL BLOCK POINTERS AREA.
.*      2 DATA AREAS = USER DCB COPY POINTERS AREA.
.*      2 DATA AREAS = O/C/E ACCESS METHOD AREA.
.*      2 DATA AREAS = O/C/E RECOVERY ROUTINE AUDIT TRAIL AREA.
.*
.*      CONTROL BLOCKS = DSCB,JFCB,ECB,IOB,DCB,DEB
.*
.* TABLES = NONE.
.*
.* MACROS = IHBERMAC.
.*
.* CHANGE ACTIVITY = Y02080
.*
.**********************************************************************
.*
.*         RELEASE 23 DELETIONS/CHANGES
.*         RELEASE 22 DELETIONS/CHANGES
.*         RELEASE 21 DELETIONS/CHANGES
.*                                                               S21940
.*         RELEASE 20 DELETIONS/CHANGES
.*                                                               S20038
.*
         SPACE 1
***********************************************************************
*
*        THIS MACRO IS USED TO DEFINE AND MAP THE O/C/E WORK AREA.
*
*        O/C/E = OPEN, OPEN TYPE=J, CLOSE, CLOSE TYPE=T,
*                EOV, FEOV, & RDJFCB.
*
***********************************************************************
         SPACE 1
***********************************************************************
*
*        O/C/EOV MAIN WORK AREA, FORMAT AND LENGTHS
*
***********************************************************************
*
*    1. O/C/E COMMON WORK AREA.                       TOTAL = 612 BYTES
*      2. VOLUME LABEL AREA.                                  100 BYTES
*      **** TAPE LABELS
*        3. ANSI VOLUME LABEL AREA.
*        3. FILE LABEL 1 AREA.
*        3. FILE LABEL 2 AREA.
*        3. ANSI FILE LABEL 2 AREA.
*      **** DIRECT ACCESS LABELS
*        3. DATA SET CONTROL BLOCK LABEL AREA (DSCB).
*        3. DATA SET CONTROL BLOCK FORMAT 3 KEY AREA.
*        3. DATA SET CONTROL BLOCK FORMAT 3 RECORD AREA.
*        3. MESSAGE AREA.
*        3. MESSAGE LENGTHS.
*        3. MESSAGE FORMAT.
*      2. JOB FILE CONTROL BLOCK AREA (JFCB).                 176 BYTES
*      2. O/C/E INTERNAL EVENT CONTROL BLOCK AREA (ECB).        4 BYTES
*      2. O/C/E INTERNAL INPUT/OUTPUT BLOCK AREA (IOB).        40 BYTES
*      2. O/C/E INTERNAL DATA EXTENT BLOCK AREA (DEB).         44 BYTES
*      2. O/C/E INTERNAL DATA CONTROL BLOCK AREA (DCB).         4 BYTES
*      2. O/C/E INTERNAL CONTROL WORDS AREA (CCW).             96 BYTES
*      2. O/C/E COMMON EXTENDED WORK AREAS.                    64 BYTES
*      2. O/C/E PROTECTED CONTROL BLOCK POINTERS AREA.         40 BYTES
*      2. USER DCB COPY POINTERS AREA.                         16 BYTES
*      2. O/C/E ACCESS METHOD AREA.                             4 BYTES
*      2. O/C/E RECOVERY ROUTINE AUDIT TRAIL AREA.             24 BYTES
*                                                             ---------
*                                           DSECTSIZ TOTAL =  612 BYTES
*
***********************************************************************
         EJECT
***********************************************************************
*
*        VOLUME LABEL AREA - SEE 'DATA SET LABELS- FL1 AND FL2'
*
***********************************************************************
         SPACE 1
DXLBL    DS    0CL80
VOLLABI  DS    CL3                 LABEL IDENTIFIER
VOLNO    DS    CL1                 VOLUME LABEL NUMBER
VOLSERNO DS    CL6
VOLSEC   DS    CL1
         DS    0CL10               RESERVED
VOLVTOC  DS    CL5
         DS    CL5
         DS    CL10                RESERVED
         DS    CL10                RESERVED
VOLOWNER DS    CL10                OWNER NAME AND ADDRESS CODE
         DS    CL29                RESERVED
         SPACE 1
***********************************************************************
*
*        ANSI VOLUME LABEL AREA
*        (ANSI AND IBM STANDARD LABEL DIFFERENCES)
*
***********************************************************************
         SPACE 1
         ORG   DXLBL+37
AVOLOWNR DS    CL14                     OWNER IDENTIFICATION
         DS    CL28                     RESERVED
LABSTAND DS    CL1                      LABEL STANDARD LEVEL
         SPACE 1
***********************************************************************
*
*        FILE LABEL 1 AREA - SEE 'DATA SET LABEL -- FL1'
*
***********************************************************************
         SPACE 1
         ORG   DXLBL
FL1LABI  DS    CL3                 LABEL IDENTIFIER
FL1NO    DS    CL1                 FILE LABEL NUMBER
FL1ID    DS    CL17                FILE IDENTIFIER
FL1FILSR DS    CL6                 FILE SERIAL NUMBER
FL1VOLSQ DS    CL4                 VOLUME SEQUENCE NUMBER
FL1FILSQ DS    CL4                 FILE SEQUENCE NUMBER
FL1GNO   DS    CL4                 GENERATION NUMBER
FL1VNG   DS    CL2                 VERSION NUMBER OF GENERATION
FL1CREDT DS    CL6                 CREATION DATE
FL1EXPDT DS    CL6                 EXPIRATION DATE
FL1FSEC  DC    C'0'                FILE SECURITY INDICATOR
FL1BLKCT DS    CL6                 BLOCK COUNT
FL1SYSCD DS    CL13                SYSTEM CODE
FL1RES   DS    0CL7                RESERVED FOR FUTURE USE
         DS    CL1
FL1RES1  DS    CL6
         SPACE 1
***********************************************************************
*
*        FILE LABEL 2 AREA - SEE 'DATA SET LABEL -- FL2'
*
***********************************************************************
         SPACE 1
         ORG   FL1ID
FL2RECFM DS    CL1                 RECORD FORMAT
FL2BLKL  DS    CL5                 BLOCK LENGTH
FL2LRECL DS    CL5                 BLOCKING FACTOR/RECORD LENGTH
FL2DEN   DS    CL1                 DENSITY
FL2FILP  DS    CL1                 FILE POSITION
FL2JSID  DS    0CL17               JOB/STEP IDENTIFICATION
FL2JOBD  DS    CL8                 JOB IDENTIFICATION
FL2JSSP  DC    C'/'                SLASH
FL2STEPD DS    CL8                 STEP IDENTIFICATION
FL2TRTCH DS    CL2                 TAPE RECORDING TECHNIQUE
FL2CNTRL DS    CL1                 CARRAIGE CONTROL CHARACTER
         DS    CL1                     RESERVED FOR FUTURE USE
FL2BLKA  DS    CL1                     BLOCK ATTRIBUTE
         DS    CL1                 RESERVED                      99223
FL2DRID  DS    0CL7                TAPE DRIVE ID                 99223
         DS    CL2                 RESERVED                      99223
FL2ID    DS    CL5                 ID OF CREATING DRIVE          99223
FL2DSIND DS    CL1                 DATA SET INDICATOR FIELD      Y02083
FL2RES   DS    CL32                RESERVED FOR FUTURE USE       Y02083
         SPACE 1
***********************************************************************
*
*        ANSI FILE LABEL 2 AREA
*        (ANSI AND IBM STANDARD FILE LABEL 2 DIFFERENCES)
*
***********************************************************************
         SPACE 1
         ORG   DXLBL+50
FL2BUFOF DS    CL2                      BUFFER OFFSET
         SPACE 1
***********************************************************************
*
*        DATA SET CONTROL BLOCK AREA - SEE 'FORMAT 1 DSCB'
*
***********************************************************************
         SPACE 1
         ORG   DXLBL
DXDSCB   DS    0CL96
DSCFMTID DC    C'1'
DSCFILSR DS    CL6                 FILE SERIAL NUMBER
DSCVOLSR DS    CL2
DSCCREDT DS    CL3                 CREATION DATE IN DISCONTINOUS BIN
DSCEXPDT DS    CL3                 EXPIRATION DATE IN DISCONTINOUS BIN
DSCNOEXT DS    CL1
DSCBLDBL DS    CL1
         DS    CL1
DSCSYSCD DS    CL13                SYSTEM CODE
         DS    CL7
DSCFILTY DS    CL2                 FILE TYPE
DSCRECFM DS    CL1                 RECORD FORMAT
DSCOPTCD DS    CL1                 OPTION CODE
DSCBLKL  DS    CL2                 BLOCK LENGTH
DSCLRECL DS    CL2                 RECORD LENGTH
DSCKEYL  DS    CL1                 KEY LENGTH
DSCRKP   DS    CL2                 KEY LOCATION
DSCDSIND DS    CL1
DSCSCALO DS    CL4
DSCLSTAR DS    CL3                 LAST USED TRACK AND BLOCK ON TRACK
DSCTRBAL DS    CL2                 BYTES REMAINING ON LAST TRACK USED
         DS    CL2                 RESERVED
DSCEXTYP DS    CL1                 EXTENT TYPE INDICATOR
DSCEXTSQ DS    CL1                 EXTENT SEQUENCE NUMBER
DSCLOWLM DS    CL4
DSCUPPLM DS    CL4
DSCEXT1  DS    CL10
DSCEXT2  DS    CL10
DSCNEXT  DS    CL5                 POINTER TO NEXT RECORD
DSCCORE  DS    CL4                 CORE ADDRESS OF NEXT DSCB RECORD
DSCBEND  EQU   *
         SPACE 1
***********************************************************************
*
*        DATA SET CONTROL BLOCK (FORMAT 3) KEY AREA
*
***********************************************************************
         SPACE 1
         ORG   DXDSCB
DXDSCB3K DS    0CL40
DSCBF3C  DC    X'03030303'
DSCBEXSK DS    0CL40
DSCBEXTY DS    CL1                 EXTENT TYPE INDICATOR
DSCBEXSQ DS    CL1                 EXTENT SEQUENCE NUMBER
DSCBLLMT DS    CL4                 CCHH LOWER LIMIT
DSCBULMT DS    CL4                 CCHH UPPER LIMIT
DSCBEX2  DS    CL10                ADDITIONAL EXTENT
DSCBEX3  DS    CL10                ADDITIONAL EXTENT
DSCBEX4  DS    CL10                ADDITIONAL EXTENT
         SPACE 1
***********************************************************************
*
*        DATA SET CONTROL BLOCK (FORMAT 3) RECORD AREA
*
***********************************************************************
         SPACE 1
         ORG   DXDSCB
DSCBFMID DC    C'3'                FORMAT ID
DSCBEXSD DS    0CL90               ADDITIONAL EXTENTS
DSCBEX5  DS    CL10                ADDITIONAL EXTENT
DSCBEX6  DS    CL10                ADDITIONAL EXTENT
DSCBEX7  DS    CL10                ADDITIONAL EXTENT
DSCBEX8  DS    CL10                ADDITIONAL EXTENT
DSCBEX9  DS    CL10                ADDITIONAL EXTENT
DSCBEXA  DS    CL10                ADDITIONAL EXTENT
DSCBEXB  DS    CL10                ADDITIONAL EXTENT
DSCBEXC  DS    CL10                ADDITIONAL EXTENT
DSCBEXD  DS    CL10                ADDITIONAL EXTENT
DSCBNEXT DS    CL5                 CCHHR OF NEXT FORMAT 3 DSCB
         SPACE 1
***********************************************************************
*
*        MESSAGE AREA
*
***********************************************************************
         SPACE 1
         ORG   DXDSCB
REPLYLTH DS    CL1
REPLYADR DS    CL3
REPLYECB DS    CL4
MSGLSTSZ DS    CL2  MSG LENGTH                                     DM0Q
MCSFLAGS DS    CL2  FLAG FIELD FOR MCS                             DM0Q
MESSAGEA DS    CL68 MESSAGE AREA                                   DM0Q
DESCODE  DS    CL2  DESCRIPTOR CODE FOR MCS                        DM0Q
ROUTCODE DS    CL2  ROUTING CODE FOR MCS                           DM0Q
REPLY    DS    CL12 REPLY AREA                                     DM0Q
*
         ORG   MESSAGEA
         SPACE 1
***********************************************************************
*
*        DEFINITION OF LENGTH OF MESSAGE COMPONENTS
*
***********************************************************************
         SPACE 1
MSERL    EQU   3                        MESSAGE SERIAL NUMBER LENGTH
MINSTL   EQU   6                        MSG INSTRUCTION LTH INC MSG SER
MUNL     EQU   3                        MESSAGE UNIT NAME LENGTH
MVOLL    EQU   6                        MESSAGE VOLUME SERIAL LENGTH
         SPACE 1
***********************************************************************
*
* MTXTL        LENGTH MAY BE DEFINED BY EACH MODULE TO FIT REQUIREMENT
* MSGLTH       LENGTH OF FULL MSG DEFINED BY EACH MODULE
*
***********************************************************************
         SPACE 1
***********************************************************************
*
*        MESSAGE FORMAT IS 'IEC000A M 000,00000  (TEXT)         '
*
***********************************************************************
         SPACE 1
MSGIOSUP DC    CL3'IEC'                 I/O SUPPORT MESSAGE IDENTITY
MSGSER   DS    0CL3                     MESSAGE SERIAL NUMBER
         ORG   MSGSER+MSERL-1
MSGSERLO DS    CL1                      VOLUME SERIAL LO ORDER BYTE
         ORG   MSGSER
MSGINSTR DC    CL6'000A M'              MESSAGE INSTRUCTION INCL MSGSER
         ORG   MSGINSTR+MINSTL-1
MSGACTN  DS    CL1                      MESSAGE ACTION REQD BY OPERATOR
         DC    C' '
MSGUN    DC    CL3'000'                 UNIT NAME THAT MSG REFERS TO
         DC    C','
MSGVOLSR DC    CL6'000000'              VOLUME SERIAL THAT MSG REFRS TO
         DC    C','
MSGTEXT  DS    0CL47                                               DM0Q
         SPACE 1
***********************************************************************
*
*        JOB FILE CONTROL BLOCK AREA - SEE 'JFCB'
*
***********************************************************************
         SPACE 1
         ORG   DSCBEND
DXJBF    DS    0CL176
         DS    CL176
*        IEFJFCBN                                                Y02080
         SPACE 1
***********************************************************************
*
*        O/C/E INTERNAL CONTROL BLOCKS AREA -
*        SEE 'ECB', 'IOB', 'DEB', 'DCB'
*        THE CONTROL BLOCK AREAS THAT FOLLOW (DXECB, DXIOB,
*        DXADDR, DXXXX, AND THE CHANNEL COMMAND WORDS) ARE
*        USED BY THE O/C/EOV ROUTINES TO PERFORM I/O: READ
*        AND WRITE LABELS, POSITION TAPE VOLUMES, ETC.
*
***********************************************************************
         SPACE 1
DXECB    DS    0CL4                     EVENT CONTROL BLOCK
         DC    X'00000000'
         SPACE 1
***********************************************************************
*
*        O/C/E INTERNAL INPUT/OUTPUT BLOCK
*
***********************************************************************
*
*  IF IOB=NO IS SPECIFIED 'DXIOB CL32' WILL BE THE ONLY
*  FIELD GENERATED IN THE IOB SECTION OF IECDSECT.
*  IF IOB=YES IS SPECIFIED OR IF IOB= IS OMITTED ALL IOB LABELS,
*  AS DESCRIBED IN THE IOB SECTION OF THIS MACRO, WILL BE EXPANDED.
*
***********************************************************************
         SPACE 1
         AIF   ('&IOB' EQ 'NO').IECA010                          S21940
         AIF   ('&IOB' EQ 'YES').IECA005                         S21940
         IHBERMAC 183,&IOB,YES
.IECA005 ANOP                                                    S21940
DXIOB    DS    0CL32
IOBWRITE EQU   X'40' -                  IOB USE FOR WRITE        Y02080
IOBREAD  EQU   X'20' -                  IOB USED FOR READ        Y02080
IOBFLAG1 DC    X'00'
IOBUNREL EQU   X'02' -                  UNRELATED FLAG           Y02080
IOBFLAG2 DC    X'00'
IOBSENSE DS    0H
IOBSENS0 DS    CL1
IOBSENS1 DS    CL1                 SENSE BYTE "1"
IOBECBPT DS    XL1
         DC    AL3(DXECB)
IOBCSW   DS    0D
IOBCOMAD DC    X'00000000'         KEY,0000,COMMAND ADDRESS
IOBSTAT0 DC    X'00'               STATUS BYTE 0
IOBSTAT1 DC    X'00'               STATUS BYTE 1
IOBCNT   DC    X'0000'             COUNT
IOBSIOCC DS    XL1
IOBSTART DC    AL3(DXCCW)
IOBWGHT  DS    XL1
IOBDCBPT DC    AL3(DXDCB)
         DS    XL1
         DS    XL3
IOBINCAM DC    X'0000'
IOBERRCT DS    XL2
         AGO   .IECA015                                          S21940
.IECA010 ANOP                                                    S21940
DXIOB    DS    CL32                                              S21940
.IECA015 ANOP                                                    S21040
         SPACE 1
DXDAADDR DS    D                   DIRECT ACCESS ADDRESS (MBBCCHHR)
         SPACE 1
***********************************************************************
*
*        O/C/E INTERNAL DATA EXTENT BLOCK
*
***********************************************************************
         SPACE 1
DYYYY    DS    0CL44
DXDEB    EQU   DYYYY-4
DXDEBDEB DC    X'00000000'
DXDEBOFL DS    0CL1
DXDEBIRB DC    X'00000000'
DXDEBSYS DC    X'00000000'
DXDEBUSR DC    X'00000000'
DXDEBECB DC    X'00000000'
DXDEBID  DS    0CL1
DXDEBDCB DC    AL4(DXDCB)
DXDCBAD  EQU   DXDEBDCB
DXDEBAPP DS    CL4
DXDEBMOD DS    0CL1
DXDEBUCB DS    F
DXDEBBIN DS    H
DXDEBSCC DS    H
DXDEBSHH DS    H
DXDEBECC DS    H
DXDEBEHH DS    H
DXDEBNTR DS    H
         SPACE 1
***********************************************************************
*
*        O/C/E INTERNAL DATA CONTROL BLOCK
*
***********************************************************************
         SPACE 1
DXXXX    DS    0F
DXDCB    EQU   DXXXX-44            POINTER TO RELATIVE BEGINNING OF DCB
DXDCBDEB DC    A(DXDEB)
         SPACE 1
***********************************************************************
*
*        O/C/E INTERNAL CHANNEL CONTROL WORDS
*
***********************************************************************
         SPACE 1
         CNOP  0,8
DXCCW    DS    0CL96
DXCCW1   DS    D
DXCCW2   DS    D
DXCCW3   DS    D
DXCCW4   DS    D
DXCCW5   DS    D
DXCCW6   DS    D
DXCCW7   DS    D
DXCCW8   DS    D
DXCCW9   DS    D
DXCCW10  DS    D
DXCCW11  DS    D
DXCCW12  DS    D
         SPACE 1                                                 Y02080
         DS    D                        RESERVED FOR FUTURE USE  Y02082
         SPACE 1
***********************************************************************
*
*        O/C/E COMMON EXTENDED MAIN WORK AREA
*
***********************************************************************
         SPACE 1
DXXCTL   DS    CL8                      TRANSFER CONTROL AREA    Y02134
         SPACE 1                                                 Y02134
DXWORK   DS    F                        WORK FIELD               Y02134
DXWORK1  DS    F                        WORK FIELD               Y02134
DXWORK2  DS    F                        WORK FIELD               Y02134
DXWORK3  DS    F                        WORK FIELD               Y02134
DXWORK4  DS    F                        WORK FIELD               Y02134
         SPACE 1                                                 Y02134
DXVOLSR  DS    0CL18                    VOLUME SERIAL NUMBERS    Y02080
DXVOLMT1 DS    0CL6                     VOLUME TO BE DISMOUNTED  Y02134
DXVOLSR1 DS    CL6                      VOLUME TO BE DISMOUNTED  Y02134
DXVOLMT2 DS    0CL6                     VOLUME TO BE MOUNTED     Y02134
DXVOLSR2 DS    CL6                      VOLUME TO BE MOUNTED     Y02134
DXVOLMT3 DS    0CL6                     LOOK AHEAD MOUNT VOLUME  Y02134
DXVOLSR3 DS    CL6                      LOOK AHEAD MOUNT VOLUME  Y02134
         SPACE 1
DXVOLSEQ DS    H                        VOLUME SEQUENCE NUMBER   Y02080
DXNOUNIT DS    H                        NUMBER UNITS ALLOCATED   Y02080
DXUNITOF DS    H                        OFFSET TO CURRENT UNIT   Y02080
         SPACE 1                                                 Y02080
DXRESSW  DS    CL1                      RESIDENT ROUTINE INDICTR Y02134
DXWKEYSV DS    AL1                      SAVED KEY OF IECRES CALL Y02082
DXUKEY   DS    AL1                      O/C/E CALLERS KEY        Y02080
DXEXTSW  DS    AL1                      EXTEND SWITCH            Y02080
         SPACE 1                                                 Y02080
***********************************************************************
*
*        POINTERS TO CONTROL BLOCKS IN PROTECTED STORAGE
*
***********************************************************************
         SPACE 1                                                 Y02080
DXASCBAD DS    AL4                      POINTER TO ASCB          Y02080
DXTCBADR DS    AL4                      POINTER TO TCB           Y02080
DXJSCBAD DS    AL4                      POINTER TO JSCB          Y02080
DXDSABQD DS    AL4                      POINTER TO DSAB QDB      Y02080
DXDSABAD DS    AL4                      POINTER TO FIRST DSAB    Y02080
DXDSAB   DS    AL4                      POINTER TO CURRENT DSAB  Y02080
DXDEBXAD DS    AL4                      POINTER TO DEB EXTENSION Y02080
DXTIOTAD DS    AL4                      POINTER TO TIOT          Y02080
DXUCBADR DS    AL4                      POINTER TO CURRENT UCB   Y02080
DXUCBSAV DS    AL4                      SAVED UCB POINTER        Y02134
         SPACE 1                                                 Y02080
***********************************************************************
*
*        USER DCB COPY POINTERS AREA:
*
***********************************************************************
         SPACE 1                                                 Y02082
*                                                                Y02082
* ORIGINAL DCB INFO NEEDED BY INIT AND INITIAL COPY              Y02082
*                                                                Y02082
         SPACE 1                                                 Y02082
* INFO FROM COMMON INTERFACE                                     Y02082
         ORG   DXWORK                   AFTER FOUNDATION         Y02134
DXWDSORG DS    0BL2                     COPIED DATA SET ORG USED Y02082
DXWDSRG1 DS    BL1                      FIRST BYTE OF DCBDSORG   Y02082
DXWDSRG2 DS    BL1                      SECOND BYTE OF DCBDSORG  Y02082
         SPACE 1                                                 Y02082
* FOUNDATION BEFORE OPEN                                         Y02082
         ORG   DXWORK+4                 OVERLAY 16 BYTES         Y02082
DXWFOUN  DS    0CL12                    DCB FOUNDATION           Y02082
DXWDDNAM DS    CL8                      DDNAME                   Y02082
DXWOFLGS DS    BL1                      OPEN FLAGS               Y02082
DXWIFLG  DS    BL1                      ERROR FLAGS FOR IOS      Y02082
DXWMACR  DS    0BL2                     TYPE I/O MACRO INSTR     Y02082
DXWMACR1 DS    BL1                      FIRST BYTE DCBMACR1      Y02082
DXWMACR2 DS    BL1                      SECOND BYTE DCBMACR2     Y02082
         SPACE 1                                                 Y02082
* FOUNDATION AFTER OPEN                                          Y02082
         ORG   DXWORK+4                 OVERLAY 4 WORDS          Y02082
DXWTIOT  DS    H                        OFFSET TO DD ENTRY TIOT  Y02082
DXWMACRF DS    0BL2                     TYPE I/O MACRO INSTR     Y02082
DXWMACF1 DS    BL1                      FIRST BYTE DCBMACF1      Y02082
DXWMACF2 DS    BL1                      SECOND BYTE DCBMACF2     Y02082
DXWDEBAD DS    0A                       ADDR OF DEB              Y02082
DXWIFLGS DS    BL1                      ERROR FLAGS FOR IOS      Y02082
         DS    AL3                      DEB ADDR                 Y02134
         ORG   DXWORK+16                ORG PAST FOUNDATION      Y02082
DXWCOPYE DS    BL1                      COPY ERROR CODE:         Y02082
*                                       0 = GOOD, 1 = BAD        Y02082
DXWMCR   DS    0BL2                     COMMON MACREF            Y02134
DXWMCR1  DS    BL1                      FIRST BYTE OF DCB MACREF Y02134
DXWMCR2  DS    BL1                      SECOND BYTE OF DCB MACRF Y02134
         DS    0F                                                Y02082
         ORG   ,                        RESET LOCATION COUNTER   Y02082
DXUDCBAD DS    AL4                      POINTER TO USER DCB      Y02082
DXPDCBAD DS    AL4                      POINTER TO COPIED DCB    Y02082
DXUDCBPL DS    H                        LNTH OF USER DCB PREFIX  Y02082
DXUDCBML DS    H                        LNTH OF MOVED DCB        Y02082
DXPRPARC DS    AL4                      SAVED PARM LIST POINTER  Y02082
         SPACE 1                                                 Y02080
***********************************************************************
*
*        ACCESS METHOD AREA                                      Y02080
*
***********************************************************************
         SPACE 1                                                 Y02080
DXMSGADR DS    AL4                      POINTER TO MSG CSECT     Y02080
         SPACE 1                                                 Y02080
***********************************************************************
*
*        RECOVERY ROUTINE DCB AUDIT TRAIL AREA                   Y02080
*
***********************************************************************
         SPACE 1                                                 Y02080
DXATCOM1 DS    0CL4                     COMMON O/C/E AUDIT INFO  Y02144
*                                                                Y02144
DXATGENS DS    B                        GENERAL STATUS           Y02144
*                                                                Y02144
DXATDMCT EQU   X'80'                    DATA MGMT CNT INCREMENT  Y02144
DXATREFR EQU   X'40'                    ON, DON'T COPY BACK DCB  YM1275
DXATDISP EQU   X'20'                    VOLUME DISP PERFORMED    Y02144
DXATJFCB EQU   X'10'                    JFCB READ OK             Y02144
DXATVGIV EQU   X'0E'                    A.M. STRING/CI GIVEN CTL Y02144
DXATVSMG EQU   X'08'                    VSAM STRING GIVEN CONTRL Y02144
DXATVTMG EQU   X'04'                    VTAM STRING GIVEN CONTRL Y02144
DXATVCIG EQU   X'02'                    ISAM-VSAM CI GIVEN CNTRL Y02144
DXATSRET EQU   X'01'                    A.M. STRING RETURNED CTL Y02144
*                                                                Y02144
DXATCLOS DS    C                        CLOSE FINAL PROCESSING   Y02144
*                                                                Y02144
DXATDBCK EQU   X'02'                    DEB DELETED FROM DEB TBL Y02144
DXATDELT EQU   X'04'                    A.M. ROUTINES AND I/O    Y02144
*                                       APPENDAGES DELETED       Y02144
DXATUTOT EQU   X'08'                    USER TOTALING SAVE AREA  Y02144
*                                       RELEASED                 Y02144
DXATRDCB EQU   X'0C'                    DCB RESTORATION FINISHED Y02144
DXATRDEB EQU   X'10'                    DEB REMOVED FR DEB CHAIN Y02144
DXATSABS EQU   X'14'                    STARTED DECREMENTING     Y02144
*                                       OPEN COUNT IN DSAB(S)    Y02144
DXATSABF EQU   X'18'                    FINISHED DECREMENTING    Y02144
*                                       OPEN COUNT IN DSAB(S)    Y02144
DXATDMS  EQU   X'1C'                    STARTED DECREMENTING     Y02144
*                                       DATA MGMT CNT IN UCB(S)  Y02144
DXATDMF  EQU   X'20'                    FINISHED DECREMENTING    Y02144
*                                       DATA MGMT CNT IN UCB(S)  Y02144
DXATIRB  EQU   X'28'                    IRB (IF ANY) HANDLED     Y02144
DXATRRQ  EQU   X'2C'                    RELATED REQUEST Q FREED  Y02144
DXATDEB  EQU   X'30'                    DEB CORE FREED           Y02144
DXATDEBX EQU   X'34'                    DEB EXTENSION CORE FREED Y02144
*                                                                Y02144
DXATOUTA DS    B                        OUTPUT TAPE DATA SET     Y02144
*                                       STATUS                   Y02144
DXATVLHD EQU   X'80'                    VOL1 OR HDR LBL WRITTEN  Y02144
DXATHDTM EQU   X'40'                    TM WRITTEN AFTER HDR LBL Y02144
DXATDATM EQU   X'20'                    TM WRITTEN AFTER DATA    Y02144
DXATTRL1 EQU   X'10'                    TRL1 LABEL WRITTEN       Y02144
DXATTRL2 EQU   X'08'                    TRL2 LABEL WRITTEN       Y02144
DXATTTM1 EQU   X'04'                    1ST TRAILING TM WRITTEN  Y02144
DXATTTM2 EQU   X'02'                    2ND TRAILING TM WRITTEN  Y02144
DXATNSL  EQU   X'01'                    NSL OUTPUT RTN GIVEN CTL Y02144
*                                                                Y02144
DXATDACC DS    B                        DIRECT ACCESS D/S STATUS Y02144
*                                                                Y02144
DXATF1CE EQU   X'80'                    FMT 1 DSCB REREAD IF     Y02144
*                                       CLOSE EXECS CALLED EOV   Y02144
DXATTRAK EQU   X'40'                    LAST TRACK USED & TRACK  Y02144
*                                       BALANCE FIELDS IN DSCB   Y02144
*                                       UPDATED FOR OUTPUT PS    Y02144
*                                       AND PO DATA SETS         Y02144
DXATDRCT EQU   X'20'                    DIRECTORY COUNT UPDATED  Y02144
DXATUPDB EQU   X'10'                    UPDATED DSCB WRITTEN     Y02144
DXATSMF  EQU   X'08'                    SMF RTN GIVEN CONTROL    YM4614
DXATEOF  EQU   X'02'                    EOF MARK WRITTEN: PS D/S Y02144
DXATRDDB EQU   X'01'                    DSCB READ                Y02144
*                                                                Y02144
DXATCOM2 DS    0CL4                     COMMON O/C/E AUDIT INFO  Y02144
*                                                                Y02144
DXATEOV  DS    B                        EOV PROCESSING           Y02144
*                                                                Y02144
DXATCCAT EQU   X'80'                    CONCATENATION            Y02144
DXATNVOL EQU   X'40'                    NEW VOLUME               Y02144
DXATDCHN EQU   X'20'                    DEB DECHAINED            Y02144
DXATDFRE EQU   X'10'                    DEB CORE FREED           Y02144
DXATDNEW EQU   X'08'                    NEW DEB CORE GOTTEN      Y02144
DXATREMT EQU   X'04'                    DEB REMOVED FROM DEB TBL Y02144
DXATDADM EQU   X'02'                    EOV WENT TO EXTEND       Y02144
DXATVCAT EQU   X'01'                    EOV WENT TO VSAM CATLG   Y02144
*                                                                Y02144
DXATOPEN DS    B                        OPEN PROCESSING          Y02144
*                                                                Y02144
DXATIGN  EQU   X'80'                    IGNORE OPTION ACTIVE     Y02144
DXATMODS EQU   X'40'                    DCB MERGE LOOP STARTED   Y02144
DXATMODE EQU   X'20'                    DCB MERGE DONE           Y02144
DXATMODM EQU   X'10'                    DCB MOD MASK IN DEB      Y02144
*                                       EXTENSION IS VALID       Y02144
DXATDSIN EQU   X'08'                    DSAB COUNT INCR STARTED  Y02144
DXATDFIN EQU   X'04'                    DSAB COUNT INCR FINISHED Y02144
*                                                                Y02144
DXATALL  DS    B                        COMMON AUDIT FLAGS       YM7099
*                                                                YM7099
DXATFC   EQU   X'80'                    PAST PT FOR NORMAL CLOSE YM7099
*                                       MUST ATTEMPT FORCE CLOSE YM7099
*                                       ON EOV OR TCLOSE ERROR   YM7099
DXATSWAP EQU   X'40'                    SYSEVENT OKSWAP INDICATR YM8511
         DS    CL1                      RESERVED                 YM7099
DXATCOM3 DS    AL4                      RRPLIST ADDRESS          Y02144
DXATCOM4 DS    AL4                      CRSA PTR FOR RECOVERY    Y02144
         SPACE 1                                                 Y02080
DXATEXC1 DS    AL4                      EXECUTOR AUDIT TRAIL     Y02080
DXEXHASP EQU   X'80'                    HASP CONTROL IND       @ZA02504
DXATEXC2 DS    AL4                      EXECUTOR AUDIT TRAIL     Y02080
*
**************************************************************** Y02080
*
DSECTSIZ EQU   *-DXLBL                  WORKAREA SIZE            Y02080
*
**************************************************************** Y02080
         MEND
.*                                                            Y02134 */
*%PLSGEN:;                                                   /*Y02134*/
*/*********************************************************************
*
*        THIS MACRO IS USED TO DEFINE AND MAP THE O/C/E WORK AREA.
*
*        O/C/E = OPEN, OPEN TYPE=J, CLOSE, CLOSE TYPE=T,
*                EOV, FEOV, & RDJFCB.
*
***********************************************************************

***********************************************************************
*
*        O/C/E WORK AREA FORMAT AND LENGTHS
*
***********************************************************************
*
*        VS2 RELEASE 03 DELETIONS/CHANGES
*0000                                                          @ZA02504
*
*    1. O/C/E COMMON WORK AREA.                       TOTAL = 612 BYTES
*      2. VOLUME LABEL AREA.                                  100 BYTES
*      2. JOB FILE CONTROL BLOCK AREA (JFCB).                 176 BYTES
*      2. O/C/E INTERNAL EVENT CONTROL BLOCK AREA (ECB).        4 BYTES
*      2. O/C/E INTERNAL INPUT/OUTPUT BLOCK AREA (IOB).        40 BYTES
*      2. O/C/E INTERNAL DATA EXTENT BLOCK AREA (DEB).         44 BYTES
*      2. O/C/E INTERNAL DATA CONTROL BLOCK AREA (DCB).         4 BYTES
*      2. O/C/E INTERNAL CONTROL WORDS AREA (CCW).             96 BYTES
*      2. O/C/E COMMON EXTENDED WORK AREAS.                    64 BYTES
*      2. O/C/E PROTECTED CONTROL BLOCK POINTERS AREA.         40 BYTES
*      2. USER DCB COPY POINTERS AREA.                         16 BYTES
*      2. O/C/E ACCESS METHOD AREA.                             4 BYTES
*      2. O/C/E RECOVERY ROUTINE AUDIT TRAIL AREA.             24 BYTES
*                                                             ---------
*                                           DSECTSIZ TOTAL =  612 BYTES
*
**********************************************************************/
*DCL 1 FORCORE BASED(RCORE) BDY(DWORD),
*      2 DXDSCB   CHAR(96),             /*DATA SET CONTROL BLOCK     */
*        3 DXLBL    CHAR(80),           /*DATA SET LABEL             */
*      2 DSCCORE  PTR(31),              /*CORE ADDRESS OF NEXT DSCB  */
*      2 DXJBF    CHAR(176),            /*JOB FILE CONTROL BLOCK     */
*      2 DXECB    CHAR(4),              /*INTERNAL ECB               */
*      2 DXIOB    CHAR(32),             /*INTERNAL IOB               */
*      2 DXDAADDR CHAR(8),              /*MBBCCHHR                   */
*        3 *        CHAR(4),            /*FILLER               YM8551*/
*        3 DXDEB    CHAR(4),            /*INTERNAL DEB         YM8551*/
*      2 DXDCB    CHAR(48) BDY(WORD),   /*INTERNAL DCB               */
*        3 *        CHAR(20),           /*FILLER               YM8551*/
*        3 DXDEBDCB PTR(31),            /*INTERNAL DCB PTR     YM8551*/
*        3 *        CHAR(20),           /*FILLER               YM8551*/
*        3 DXDCBDEB PTR(31),            /*INTERNAL DCB'S DEB POINTER */
*
*/*            O/C/E INTERNAL CCWS                                   */
*
*      2 DXCCW    CHAR(96) BDY(DWORD),  /*CCW AREA                   */
*        3 DXCCW1   CHAR(8) BDY(DWORD),
*        3 DXCCW2   CHAR(8) BDY(DWORD),
*        3 DXCCW3   CHAR(8) BDY(DWORD),
*        3 DXCCW4   CHAR(8) BDY(DWORD),
*        3 DXCCW5   CHAR(8) BDY(DWORD),
*        3 DXCCW6   CHAR(8) BDY(DWORD),
*        3 DXCCW7   CHAR(8) BDY(DWORD),
*        3 DXCCW8   CHAR(8) BDY(DWORD),
*        3 DXCCW9   CHAR(8) BDY(DWORD),
*        3 DXCCW10  CHAR(8) BDY(DWORD),
*        3 DXCCW11  CHAR(8) BDY(DWORD),
*        3 DXCCW12  CHAR(8) BDY(DWORD),
*
*/*            O/C/E COMMON EXTENDED WORKAREA                        */
*
*      2 *        CHAR(8),              /* RESERVED FOR FUTURE USE   */
*      2 DXXCTL   CHAR(8),              /*TRANSFER CONTROL AREA      */
*      2 DXWORK   CHAR(4),              /*WORK FIELD                 */
*      2 DXWORK1  CHAR(4),              /*WORK FIELD                 */
*      2 DXWORK2  CHAR(4),              /*WORK FIELD                 */
*      2 DXWORK3  CHAR(4),              /*WORK FIELD                 */
*      2 DXWORK4  CHAR(4),              /*WORK FIELD                 */
*      2 DXVOLSR CHAR(18),              /*VOLUME SERIAL NUMBERS      */
*        3 DXVOLSR1 CHAR(6),            /*VOLUME TO BE DISMOUNTED    */
*          4 DXVOLMT1 CHAR(6),          /*VOLUME TO BE DISMOUNTED    */
*        3 DXVOLSR2 CHAR(6),            /*VOLUME TO BE MOUNTED       */
*          4 DXVOLMT2 CHAR(6),          /*VOLUME TO BE MOUNTED       */
*        3 DXVOLSR3 CHAR(6),            /*LOOK AHEAD MOUNT VOLUME    */
*          4 DXVOLMT3 CHAR(6),          /*LOOK AHEAD MOUNT VOLUME    */
*      2 DXVOLSEQ FIXED(15),            /*VOLUME SEQUENCE NUMBER     */
*      2 DXNOUNIT FIXED(15),            /*NO. UNITS ALLOCATED        */
*      2 DXUNITOF FIXED(15),            /*OFFSET TO CURRENT UNIT     */
*      2 DXRESSW  CHAR(1),              /*RESIDENT ROUTINE INDICATOR */
*      2 DXWKEYSV CHAR(1),              /*SAVED KEY OF IECRES CALL   */
*      2 DXUKEY   CHAR(1),              /*CALLER'S KEY               */
*      2 DXEXTSW  CHAR(1),              /*DADSM EXTEND SWITCH        */
*
*/*            O/C/E PROTECTED CONTROL BLOCK POINTERS AREA           */
*
*      2 DXASCBAD PTR(31),              /*ASCB ADDRESS               */
*      2 DXTCBADR PTR(31),              /*TCB ADDRESS                */
*      2 DXJSCBAD PTR(31),              /*ACTIVE JSCB ADDRESS        */
*      2 DXDSABQD PTR(31),              /*DSAB QDB ADDRESS           */
*      2 DXDSABAD PTR(31),              /*FIRST DSAB ADDRESS         */
*      2 DXDSAB   PTR(31),              /*CURRENT DSAB ADDRESS       */
*      2 DXDEBXAD PTR(31),              /*DEB EXTENSION ADDRESS      */
*      2 DXTIOTAD PTR(31),              /*CURRENT TIOT ENTRY ADDRESS */
*      2 DXUCBADR PTR(31),              /*UCB ADDRESS                */
*      2 DXUCBSAV PTR(31),              /*SAVED UCB ADDRESS          */
*        3 * CHAR(1),                   /*FLAG BYTE            YM6525*/
*        3 DXUCBSVV PTR(24),            /*SAVED UCB ADDRESS    YM6525*/
*
*/*            USER DCB COPY POINTERS AREA                           */
*
*      2 DXUDCBAD PTR(31),              /*POINTER TO CALLER'S DCB    */
*        3 * CHAR(1),                   /*FLAG BYTE            YM6525*/
*        3 DXUACBAD PTR(24),            /*USER ADDR OF ACB/DCB YM6525*/
*      2 DXPDCBAD PTR(31),              /*POINTER TO COPIED DCB      */
*        3 * CHAR(1),                   /*FLAG BYTE            YM6525*/
*        3 DXPACBAD PTR(24),            /*COPY ADDR OF ACB/DCB YM6525*/
*      2 DXUDCBPL FIXED(15),            /*LENGTH OF USER DCB PREFIX  */
*      2 DXUDCBML FIXED(15),            /*LENGTH OF MOVED DCB        */
*      2 DXPRPARC PTR(31),              /*SAVED PARM LIST POINTER    */
*
*      2 DXMSGADR PTR(31),              /*POINTER TO MSG CSECT       */
*
*/*            RECOVERY ROUTINE DCB AUDIT TRAIL AREA                 */
*
*      2 DXATCOM1        CHAR(4),       /*COMMON O/C/E AUDIT TRAIL   */
*        3 DXATGENS      CHAR(1),       /*GENERAL STATUS             */
*          4 DXATDMCT    BIT(1),        /*DATA MGMT CNT INCREMENTED  */
*          4 DXATREFR    BIT(1),        /*ON,DON'T COPY DCB    YM1275*/
*          4 DXATDISP    BIT(1),        /*VOLUME DISP PERFORMED      */
*          4 DXATJFCB    BIT(1),        /*JFCB READ OK               */
*          4 DXATVGIV    BIT(3),        /*A.M. STRING/CI GIVEN CONTRL*/
*            5 DXATVSMG  BIT(1),        /*VSAM STRING GIVEN CONTROL  */
*            5 DXATVTMG  BIT(1),        /*VTAM STRING GIVEN CONTROL  */
*            5 DXATVCIG  BIT(1),        /*ISAM-VSAM CI GIVEN CONTROL */
*          4 DXATSRET    BIT(1),        /*A.M. STRING RETURNED CONTRL*/
*        3 DXATCLOS      FIXED(8),      /*CLOSE FINAL PROCESSING     */
*        3 DXATOUTA      CHAR(1),       /*OUTPUT TAPE D/S STATUS     */
*          4 DXATVLHD    BIT(1),        /*VOL1 OR HDR LABEL WRITTEN  */
*          4 DXATHDTM    BIT(1),        /*TM WRITTEN AFTER HDR LABELS*/
*          4 DXATDATM    BIT(1),        /*TM WRITTEN AFTER DATA      */
*          4 DXATTRL1    BIT(1),        /*TRL1 LABEL WRITTEN         */
*          4 DXATTRL2    BIT(1),        /*TRL2 LABEL WRITTEN         */
*          4 DXATTTM1    BIT(1),        /*FIRST TRAILING TM WRITTEN  */
*          4 DXATTTM2    BIT(1),        /*SECOND TRAILING TM WRITTEN */
*          4 DXATNSL     BIT(1),        /*NSL OUTPUT RTN GIVEN CONTRL*/
*        3 DXATDACC      CHAR(1),       /*DIRECT ACCESS D/S STATUS   */
*          4 DXATF1CE    BIT(1),        /*FMT 1 DSCB REREAD IF CLOSE
*                                         EXECUTORS CALLED EOV       */
*          4 DXATTRAK    BIT(1),        /*LAST TRACK USED AND TRACK
*                                         BALANCE FIELDS IN DSCB
*                                         UPDATED FOR OUTPUT PS AND
*                                         PO DATA SETS               */
*          4 DXATDRCT    BIT(1),        /*DIRECTORY COUNT UPDATED FOR
*                                         BPAM DATA SET              */
*          4 DXATUPDB    BIT(1),        /*UPDATED DSCB WRITTEN       */
*          4 DXATSMF     BIT(1),        /*SMF RTN GIVEN CONTRL YM4614*/
*          4 *           BIT(1),        /*RESERVED             YM4614*/
*          4 DXATEOF     BIT(1),        /*EOF MARK WRITTEN FOR PS DS */
*          4 DXATRDDB    BIT(1),        /*DSCB READ                  */
*      2 DXATCOM2        CHAR(4),       /*COMMON O/C/E AUDIT TRAIL   */
*        3 DXATEOV       CHAR(1),       /*EOV PROCESSING             */
*          4 DXATCCAT    BIT(1),        /*CONCATENATION              */
*          4 DXATNVOL    BIT(1),        /*NEW VOLUME                 */
*          4 DXATDCHN    BIT(1),        /*DEB DECHAINED              */
*          4 DXATDFRE    BIT(1),        /*DEB CORE FREED             */
*          4 DXATDNEW    BIT(1),        /*NEW DEB CORE GOTTEN        */
*          4 DXATREMT    BIT(1),        /*DEB REMOVED FROM DEB TBL   */
*          4 DXATDADM    BIT(1),        /*EOV WENT TO EXTEND         */
*          4 DXATVCAT    BIT(1),        /*EOV WENT TO VSAM CATLG 550Y*/
*        3 DXATOPEN      CHAR(1),       /*OPEN PROCESSING            */
*          4 DXATIGN     BIT(1),        /*IGNORE OPTION ACTIVE       */
*          4 DXATMODS    BIT(1),        /*DCB MERGE LOOP STARTED     */
*          4 DXATMODE    BIT(1),        /*DCB MERGE DONE             */
*          4 DXATMODM    BIT(1),        /*DEBX DCB MOD MASK IS VALID */
*          4 DXATDSIN    BIT(1),        /*DSAB COUNT INCR STARTED    */
*          4 DXATDFIN    BIT(1),        /*DSAB COUNT INCR FINISHED   */
*          4 *           BIT(2),        /*RESERVED                   */
*        3 DXATALL       CHAR(1),       /*COMMON AUDIT FLAGS   YM7099*/
*          4 DXATFC      BIT(1),        /*PAST POINT FOR NORMAL CLOSE--
*                                         MUST ATTEMPT FORCE CLOSE ON
*                                         EOV OR TCLOSE ERROR  YM7099*/
*          4 DXATSWAP    BIT(1),        /*SYSEVENT OKSWAP IND  YM8511*/
*          4 *           BIT(6),        /*RESERVED             YM8511*/
*        3 *             CHAR(1),       /*RESERVED                   */
*      2 DXATCOM3        PTR(31),       /*RRPLIST ADDRESS            */
*      2 DXATCOM4        PTR(31),       /*CRSA PTR USED BY RECOVERY  */
*
*      2 DXATEXC1        CHAR(4),       /*A.M. EXECUTOR AUDIT TRAIL  */
*        3 DXATEXB1      BIT(32),       /*A.M. EXECUTOR AUDIT TRAIL  */
*          4 DXEXHASP BIT(1),           /*HASP IN CONTROL    @ZA02504*/
*      2 DXATEXC2        CHAR(4),       /*A.M. EXECUTOR AUDIT TRAIL  */
*        3 DXATEXB2      BIT(32),       /*A.M. EXECUTOR AUDIT TRAIL  */
*      2 DSECTSIZ CHAR(0) BDY(WORD);    /*END OF IECDSECT            */
./ ADD  NAME=PAGE
PAGE     TITLE 'X-CMD MODULE PAGE FOR OS/VS2 RELEASE 3.7'
*
*          AUTHOR. H.P.ENGELHARDT.
*          INSTALLATION. BAYER AG LEVERKUSEN, RECHENZENTRUM.
*
PAGE     CSECT
* INITIALIZE X-CMD
         XSAVE R12,,PAGE,WORKL
         USING WORK,R13
         LR    R11,R1
         USING PARMAREA,R11
* TEST IF MVS
         L     R2,X'10'            CVT
         TM    116(R2),X'01'
         BO    PROCESS
         B     WRONGOS
*
PROCESS  EQU   *
* SET POINTERS
         L     R2,X'164'(R2)       PVT IN R2
         L     R3,X'0C'(R2)        PFT OFFSET IN R3
         MVC   MSG01(LENMSG01),MSG01C
         MVC   MSG02(LENMSG02),MSG02C
         MVC   MSG03(LENMSG03),MSG03C
* EDIT MSG01
         LH    R4,X'002'(R2)       AFC
         CVD   R4,DBBLWORD
         UNPK  COUNT,DBBLWORD
         OI    COUNT+3,X'F0'
         MVC   MSG01+16(4),COUNT
         LH    R4,X'004'(R2)       CLO
         CVD   R4,DBBLWORD
         UNPK  COUNT,DBBLWORD
         OI    COUNT+3,X'F0'
         MVC   MSG01+25(4),COUNT
         LH    R4,X'006'(R2)       COK
         CVD   R4,DBBLWORD
         UNPK  COUNT,DBBLWORD
         OI    COUNT+3,X'F0'
         MVC   MSG01+34(4),COUNT
         LH    R4,X'008'(R2)      POOL
         CVD   R4,DBBLWORD
         UNPK  COUNT,DBBLWORD
         OI    COUNT+3,X'F0'
         MVC   MSG01+43(4),COUNT
         L     R15,16              EORM
         L     R0,X'138'(R15)
         AH    R0,=H'1'
         SRL   R0,12
         CVD   R0,DBBLWORD
         UNPK  COUNT,DBBLWORD
         OI    COUNT+3,X'F0'
         MVC   MSG01+61(4),COUNT
* ACCUMULATE PAGE FRAME COUNTERS
         SR    R6,R6
         ICM   R6,3,X'10'(R2)      START OF PFT
         LA    R6,0(R3,R6)
         SR    R7,R7
         ICM   R7,3,X'12'(R2)      END OF PFT
         LA    R7,0(R3,R7)
         XC    ZEROES,ZEROES       RESET COUNTERS
PGLOOP   EQU   *
         TM    12(R6),X'80'        AVQ
         BZ    PGL001
         L     R8,CAQ
         LA    R8,1(R8)            ADD 1
         ST    R8,CAQ
PGL001   EQU   *
         TM    12(R6),X'20'        LSQA/SQA
         BZ    PGL002
         L     R8,CLSQA
         LA    R8,1(R8)            ADD 1
         ST    R8,CLSQA
PGL002   EQU   *
         TM    12(R6),X'10'        LFX
         BZ    PGL003
         L     R8,CLFX
         LA    R8,1(R8)            ADD 1
         ST    R8,CLFX
PGL003   EQU   *
         TM    12(R6),X'02'        V/R
         BZ    PGL004
         L     R8,CVR
         LA    R8,1(R8)            ADD 1
         ST    R8,CVR
PGL004   EQU   *
         TM    12(R6),X'04'        BAD
         BZ    PGL005
         L     R8,CBAD
         LA    R8,1(R8)            ADD 1
         ST    R8,CBAD
PGL005   EQU   *
         TM    13(R6),X'40'        OFF
         BZ    PGL006
         L     R8,COFF
         LA    R8,1(R8)            ADD 1
         ST    R8,COFF
PGL006   EQU   *
         TM    13(R6),X'10'        VIO
         BZ    PGL007
         L     R8,CVIO
         LA    R8,1(R8)            ADD 1
         ST    R8,CVIO
PGL007   EQU   *
         CLI   14(R6),X'00'        AFQ
         BNE   PGL008
         L     R8,CAFQ
         LA    R8,1(R8)            ADD 1
         ST    R8,CAFQ
PGL008   EQU   *
         CLI   14(R6),X'04'        SRQ
         BNE   PGL009
         L     R8,CSRQ
         LA    R8,1(R8)            ADD 1
         ST    R8,CSRQ
PGL009   EQU   *
         CLI   14(R6),X'08'        CFQ
         BNE   PGL010
         L     R8,CCFQ
         LA    R8,1(R8)            ADD 1
         ST    R8,CCFQ
PGL010   EQU   *
         CLI   14(R6),X'0C'        SQQ
         BNE   PGL011
         L     R8,CSQQ
         LA    R8,1(R8)            ADD 1
         ST    R8,CSQQ
PGL011   EQU   *
         CLI   14(R6),X'80'        LFQ
         BNE   PGL012
         L     R8,CLFQ
         LA    R8,1(R8)            ADD 1
         ST    R8,CLFQ
PGL012   EQU   *
         CLI   14(R6),X'84'        LAQ
         BNE   PGL013
         L     R8,CLAQ
         LA    R8,1(R8)            ADD 1
         ST    R8,CLAQ
PGL013   EQU   *
         LA    R6,X'10'(R6)        STEP TO NEXT ENTRY
         CR    R6,R7               TEST IF PFT END REACHED
         BNH   PGLOOP
* EDIT MSG02
         L     R4,CAQ
         CVD   R4,DBBLWORD
         UNPK  COUNT,DBBLWORD
         OI    COUNT+3,X'F0'
         MVC   MSG02+16(4),COUNT
         L     R4,CVIO
         CVD   R4,DBBLWORD
         UNPK  COUNT,DBBLWORD
         OI    COUNT+3,X'F0'
         MVC   MSG02+25(4),COUNT
         L     R4,CLFX
         CVD   R4,DBBLWORD
         UNPK  COUNT,DBBLWORD
         OI    COUNT+3,X'F0'
         MVC   MSG02+34(4),COUNT
         L     R4,CVR
         CVD   R4,DBBLWORD
         UNPK  COUNT,DBBLWORD
         OI    COUNT+3,X'F0'
         MVC   MSG02+43(4),COUNT
         L     R4,CLSQA
         CVD   R4,DBBLWORD
         UNPK  COUNT,DBBLWORD
         OI    COUNT+3,X'F0'
         MVC   MSG02+52(4),COUNT
         L     R4,CBAD
         CVD   R4,DBBLWORD
         UNPK  COUNT,DBBLWORD
         OI    COUNT+3,X'F0'
         MVC   MSG01+52(4),COUNT
         L     R4,COFF
         CVD   R4,DBBLWORD
         UNPK  COUNT,DBBLWORD
         OI    COUNT+3,X'F0'
         MVC   MSG02+61(4),COUNT
* EDIT MSG03
         L     R4,CAFQ
         CVD   R4,DBBLWORD
         UNPK  COUNT,DBBLWORD
         OI    COUNT+3,X'F0'
         MVC   MSG03+16(4),COUNT
         L     R4,CSRQ
         CVD   R4,DBBLWORD
         UNPK  COUNT,DBBLWORD
         OI    COUNT+3,X'F0'
         MVC   MSG03+25(4),COUNT
         L     R4,CCFQ
         CVD   R4,DBBLWORD
         UNPK  COUNT,DBBLWORD
         OI    COUNT+3,X'F0'
         MVC   MSG03+34(4),COUNT
         L     R4,CSQQ
         CVD   R4,DBBLWORD
         UNPK  COUNT,DBBLWORD
         OI    COUNT+3,X'F0'
         MVC   MSG03+52(4),COUNT
         L     R4,CLFQ
         CVD   R4,DBBLWORD
         UNPK  COUNT,DBBLWORD
         OI    COUNT+3,X'F0'
         MVC   MSG03+43(4),COUNT
         L     R4,CLAQ
         CVD   R4,DBBLWORD
         UNPK  COUNT,DBBLWORD
         OI    COUNT+3,X'F0'
         MVC   MSG03+61(4),COUNT
* OUTPUT MSG01
         L     R0,REG4
         WTO   MF=(E,MSG01)
* OUTPUT MSG02
         L     R0,REG4
         WTO   MF=(E,MSG02)
* OUTPUT MSG03
         L     R0,REG4
         WTO   MF=(E,MSG03)
         B     RETURN
* ERROR RETURNS
WRONGOS  L     R0,REG4
         WTO   MF=(E,MSG04)
         B     RETURN
* RETURN TO ROUTER
RETURN   EQU   *
         XRETURN ,R
         EJECT
* DEFINITIONS
         REG
* MESSAGES
MSG01C   WTO   'XPAGE01 AFC=**** CLO=**** COK=**** TTL=**** BAD=**** MR*
               Y=**** ',                                               *
               MF=L,MCSFLAG=REG0
LENMSG01 EQU   *-MSG01C
MSG02C   WTO   'XPAGE02 AVQ=**** VIO=**** LFX=**** V/R=**** L/S=**** OF*
               F=**** ',                                               *
               MF=L,MCSFLAG=REG0
LENMSG02 EQU   *-MSG02C
MSG03C   WTO   'XPAGE03 AFQ=**** SRQ=**** CFQ=**** LFQ=**** SQA=**** LS*
               Q=**** ',                                               *
               MF=L,MCSFLAG=REG0
LENMSG03 EQU   *-MSG03C
MSG04    WTO   'XPAGE04 OPERATING SYSTEM IN CONTROL IS NOT VS2 (MVS)', *
               MF=L,MCSFLAG=REG0
* X-TEXT
         XPARM
* WORKING STORAGE
WORK     DSECT
SAVE     DS    18F
DBBLWORD DS    D
MSG01    DS    CL80
MSG02    DS    CL80
MSG03    DS    CL80
COUNT    DS    CL04
PGECB    DS    F
         DS    0F
ZEROES   DS    0CL052 ****
CAQ      DS    F
CLSQA    DS    F
CLFX     DS    F
CVR      DS    F
CBAD     DS    F
COFF     DS    F
CVIO     DS    F
CAFQ     DS    F
CSRQ     DS    F
CCFQ     DS    F
CSQQ     DS    F
CLFQ     DS    F
CLAQ     DS    F
WORKL    EQU   *-WORK
         END
./ ADD  NAME=PROSE
* ZUM EINBAU DER X-CMDS UNTER OS/VS2 RELEASE 3.7 (MVS) SIND
* FOLGENDE MASSNAHMEN ERFORDERLICH:
*
* 1. LADEN DES VERTEILTEN BANDES AUF PLATTE MIT 'IEBCOPY'.
*    FOLGENGE LIBRARIES SIND AUF DEM BAND:
*        FILE 01   DSN=CMD.XSOURCE      (SOURCE LIBRARY)
*        FILE 02   DSN=CMD.XLINK        (LOAD   LIBRARY)
*        FILE 03   DSN=CMD.XHELP        (HELP   LIBRARY)
*    DIE GELADENEN LIBRARIES SIND ZU KATALOGISIEREN.
*
* 2. EINZAPPEN IN DIE PROGRAM PROPERTY TABLE:
*    PGM=XCNTRLVS, KEY=8, ATTRIBUTE=(SYSTASK,NONSWAPPABLE);
*    (MODULE 'IEFSD060' CSECT 'IEFSDPPT' IN 'SYS1.LPALIB',
*    TABLE-ENTRY CL8'XCNTRLVS', XL4'7080FFFF').
*
* 3. AUTORISIEREN DER LIBRARY 'CMD.XLINK' IN MEMBER 'IEAAPF00'
*    VON 'SYS1.PARMLIB'.
*
* 4. KOPIEREN DER PROZEDUR 'CMD.XSOURCE(XPROC)' NACH
*    'SYS1.PROCLIB(XCNTRLVS)'.
*    DABEI IST DER PARAMETER 'UNIT=VIODA' IN DEN DD-KARTEN
*    FUER 'SYSIN' UND 'SYSPRINT' DEN INSTALLATIONSGEGEBEN-
*    HEITEN ANZUPASSEN.
*
* 5. IPL DES SYSTEMS MIT 'CLPA'.
*
* 6. STARTEN VON XCNTRL MIT 'S XCNTRLVS.X'.
*
* 7. EINGABE VON 'F X,HELP'.
*    ALLE WEITERE ERKLAERUNG UEBER FUNKTION UND SYNTAX DER
*    EINZELNEN X-CMDS IST AUF DIESE WEISE ZU ERHALTEN.
*
* BEI RUECKFRAGEN BITTE AN H.P.ENGELHARDT, BAYER AG, 509 LEVERKUSEN,
* FR-RECHENZENTRUM WENDEN. (TEL.: 02172/30/81208).
*
./ ADD  NAME=QCB
         TITLE 'XQCB                             X-COMMAND QCB'
QCB      CSECT
         SPACE 3
***********************************************************************
*                                                                     *
*      IDENTIFICATION DIVISION.                                       *
*                                                                     *
*      PROGRAM-ID. QCB.                                               *
*      AUTHOR. EHNERT.                                                *
*      INSTALLATION. BAYER AG, LEVERKUSEN, RECHENZENTRUM.             *
*      DATE-WRITTEN. 3.7.1974.                                        *
*      REMARKS.                                                       *
*          DAS X-COMMAND QCB ZEIGT MOEGLICHE ZUKUENFTIGE ODER BE-     *
*          REITS BESTEHENDE KONFLIKTSITUATIONEN VON TASKS AN.         *
*                                                                     *
*          WIRD KEIN PARAMETER ANGEGEBEN, SO WERDEN ALLE TASKS ANGE-  *
*          ZEIGT, DIE EXCLUSIVEN ZUGRIFF AUF EINE DATEI HABEN, WENN   *
*          NOCH ANDERE TASKS GLEICHZEITIG AUF DIE DATEI WARTEN.       *
*                                                                     *
*          WIRD DER PARAMETER 'ALL' ANGEGEBEN, SO WERDEN ALLE EXCLU-  *
*          SIVEN REQUESTS ANGEZEIGT. IN DIESEM FALL KANN UEBER DAS    *
*          BESTEHEN EINER KONFLIKTSITUATION KEINE AUSSAGE GETROFFEN   *
*          WERDEN.                                                    *
*          WIRD DER PARAMETER '<JOBNAME>' ANGEGEBEN, SO WERDEN ALLE   *
*          REQUESTS DIESES JOBS ANGEZEIGT.                            *
*          WIRD DER PARAMETER '<Q-NAME>' ANGEGEBEN, SO WERDEN ALLE    *
*          BESTEHENDEN QCB MIT DEM NAMEN <Q-NAME> AUSGEGEBEN.         *
*                                                                     *
*          JOB- UND STEPNAMEN WERDEN UNTER VS2,REL2 MIT HILFE DES     *
*          UNTERPROGRAMMS FASID AUFGESUCHT.                           *
*                                                                     *
***********************************************************************
         EJECT
***********************************************************************
*                                                                     *
*      PROCEDURE DIVISION.                                            *
*                                                                     *
***********************************************************************
         SPACE 3
*
*      SICHERN DER REGISTER, ZUORDNUNG DER BASISREGISTER UND
*      SPEICHERPLATZANFORDERUNG FUER DIE ARBEITSBEREICHE.
*
         SPACE 2
         XSAVE R12,,QCB,ABERL
         LR    R11,R1        BASISREG. FUER DSECT PARMAREA INITIAL.
         USING PARMAREA,R11  BASISREG. FUER DSECT PARMAREA ZUORDNEN
         USING ABER,R13      BASISREG. FUER DSECT ABER ZUORDNEN
         SPIE  MF=(E,PICA)   FEHLERROUTINE AUFSETZEN
         EJECT
         SR    R7,R7         WTO-COUNT LOESCHEN
         MVI   JOBBYTE,X'00' SCHALTER LOESCHEN
         MVI   MQNBYTE,X'00' SCHALTER LOESCHEN
         MVI   ALLBYTE,X'00' SCHALTER LOESCHEN
         CLC   TEXT+4(4),=C'ALL ' PARAMETER = 'ALL' ?
         BNE   *+12          NEIN, VERZWEIGEN
         MVI   ALLBYTE,X'FF' SCHALTER SETZEN
         B     ASKSYS        VERZWEIGEN
         CLC   TEXT+3(2),=C',,' QCB NAME ANGEGEBEN ?
         BNE   *+12          NEIN, VERZWEIGEN
         MVI   MQNBYTE,X'FF' SCHALTER SETZEN
         B     ASKSYS        VERZWEIGEN
         CLC   TEXT+4(8),=CL8' ' KEIN PARAMETER ANGEGEBEN ?
         BE    ASKSYS        JA, VERZWEIGEN
         MVI   JOBBYTE,X'FF' SCHALTER SETZEN
         SPACE 2
*
*      ABFRAGE DES SYSTEMS.
*
         SPACE 1
ASKSYS   EQU   *
         MVI   SCH,X'00'     SCHALTER LOESCHEN
         L     R3,16         ADRESSE DER CVT LADEN
         TM    116(R3),X'01' SYSTEM = MVS ?
         BZ    MVT           NEIN, VERZW. ZUR VERARBEITUNG UNTER MVT
         SPACE 1
         OI    SCH,X'40'     BIT FUER MVS SETZEN
         EJECT
***********************************************************************
*                                                                     *
*      ROUTINE ZUM DURCHLAUFEN DER QCB-KETTEN IN VS2 (MVS).           *
*                                                                     *
***********************************************************************
         SPACE 3
MVS      EQU   *
         LOAD  EP=FASID                LOAD ENTRY POINT OF SUBROUTINE
         ST    R0,FASIDADR                 AND STORE IT
         LA    R0,ASID       ADRESSE DER ASID LADEN
         LA    R1,JOBNAME    ADRESSE DES JOBNAMEN LADEN
         LA    R2,STEPNAME   ADRESSE DES STEPNAMEN LADEN
         STM   R0,R2,PARMLIST ADRESSEN IN DIE PARAMETERLISTE UEBERTR.
         MVI   LASTPARM,X'80' BIT FUER LETZTEN PARAMETER SETZEN
         LA    R3,640(R3)    POINTER ZUM ERSTEN MAJOR-QCB LADEN
         SPACE 3
*
*      DURCHLAUFEN DER MAJOR-QCB-KETTE.
*
         SPACE 2
NXTMAJVS EQU   *
         L     R3,0(R3)      ADRESSE DES MAJOR-QCB LADEN
         LA    R3,0(R3)      ERSTES BYTE IN R3 LOESCHEN
         LTR   R3,R3         ENDE DER MAJOR-QCB'S ?
         BZ    RETURN        JA, VERZW. ZUM ABSCHLUSS
         SPACE 1
         LA    R4,8(R3)      POINTER ZUM ERSTEN MINOR-QCB LADEN
         SPACE 3
*
*      DURCHLAUFEN DER MINOR-QCB-KETTE.
*
         SPACE 2
NXTMINVS EQU   *
         L     R4,0(R4)      ADRESSE DES MINOR-QCB LADEN
         LA    R4,0(R4)      ERSTES BYTE IN R4 LOESCHEN
         LTR   R4,R4         ENDE DER MINOR-QCB'S ERREICHT ?
         BZ    NXTMAJVS      JA, VERZW. ZUR VERARB. DER MAJOR-QCB'S
         SPACE 1
         EJECT
*
*      VERARBEITUNG DER QEL'S.
*
         SPACE 2
NXTQELVS EQU   *
         L     R5,8(R4)      ADRESSE DES QEL LADEN
         LA    R5,0(R5)      ERSTES BYTE IN R5 LOESCHEN
         LTR   R5,R5         ENDE DER QEL'S ERREICHT ?
         BZ    NXTMINVS      JA, VERZW. ZUR VERARB. DER MINOR-QCB'S
         SPACE 1
         TM    ALLBYTE,X'FF' PARAMETER = 'ALL' ?
         BNZ   WTORVS        JA, VERZWEIGEN
         TM    JOBBYTE,X'FF' PARAMETER = '<JOBNAME>' ?
         BNZ   WTORVS        JA, VERZWEIGEN
         TM    MQNBYTE,X'FF' PARAMETER = '<Q-NAME>' ?
         BNZ   WTORVS        JA, VERZWEIGEN
         CLC   16(8,R3),=CL8'SYSIEFSD' MAJOR-QCB-NAME = 'SYSIEFSD' ?
         BE    WTORVS        JA, VERZWEIGEN
         SPACE 1
         CLC   1(3,R5),=XL3'000000' FOLGT NOCH EIN QEL ?
         BE    NXTMINVS      NEIN, VERZW. ZUR VERARB. DER MINOR-QCB'S
         SPACE 1
         TM    12(R5),X'80'  SHARED REQUEST ?
         BZ    WTORVS        NEIN, VERZWEIGEN
         SPACE 1
         LR    R6,R5         POINTER ZUM NAECHSTEN QEL LADEN
         SPACE 3
*
*      ABFRAGE AUF EXCLUSIVEN REQUEST.
*
         SPACE 2
TESTVS   EQU   *
         L     R6,0(R6)      ADRESSE DES NAECHSTEN QEL LADEN
         LA    R6,0(R6)      ERSTES BYTE IN R6 LOESCHEN
         LTR   R6,R6         ENDE DER QEL'S ERREICHT ?
         BZ    NXTMINVS      JA, VERZW. ZUR VERARB. DER MINOR-QCB'S
         SPACE 1
         TM    12(R6),X'80'  SHARED REQUEST ?
         BO    TESTVS        JA, VERZWEIGEN
         EJECT
*
*      AUFSUCHEN VON JOB- UND STEPNAMEN.
*
         SPACE 2
WTORVS   EQU   *
         MVC   WTO(LENMSG01),MSG01 NACHRICHT1 UEBERTRAGEN
         MVC   ASID,14(R5)   ASID UEBERTRAGEN
         LA    R1,PARMLIST   ADRESSE DER PARAMETERLISTE LADEN
         L     R15,FASIDADR            LOAD ENTRY POINT OF SUBROUTINE
         BALR  R14,R15       VERZWEIGEN ZUM UNTERPROGRAMM FASID
         SPACE 1
         LTR   R15,R15       UNTERPROGRAMM ERFOLGREICH BEENDET ?
         BNZ   FEHLR15       NEIN, VERZWEIGEN ZUR FEHLERROUTINE
         SPACE 3
*
*      UEBERTRAGEN DES MINOR-QCB-NAMEN.
*
         SPACE 2
         SR    R2,R2         R2 LOESCHEN
         IC    R2,16(R4)     LAENGE DES MINOR-QCB-NAMEN LADEN
         LA    R6,22         R6 INITIALISIEREN
         CR    R2,R6         LAENGE DES NAMEN > 22 ?
         BNH   *+6           NEIN, VERZWEIGEN
         SPACE 1
         LR    R2,R6         NEUE LAENGE LADEN
         BCTR  R2,0          R2 UM EINS VERMINDERN
         EX    R2,UEBERTR1   LAENGE MODIFIZIEREN
         TM    12(R5),X'80'  SHARED REQUEST ?
         BO    SCHRVS        JA, VERZWEIGEN
         SPACE 1
         MVC   WTO+39(2),=CL2'EX'
         B     SCHRVS        VERZWEIGEN
         SPACE 1
UEBERTR1 EQU   *
         MVC   MINQCBNM(0),20(R4) MINOR QCB NAME UEBERTRAGEN
         EJECT
*
*      AUSGABE DER NACHRICHT.
*
         SPACE 2
SCHRVS   EQU   *
         TM    JOBBYTE,X'FF' PARAMETER = '<JOBNAME>' ?
         BZ    MARKE1        NEIN, VERZWEIGEN
         CLC   JOBNAME,TEXT+4 JOBNAME = PARAMETER ?
         BNE   MARKE3        NEIN, VERZWEIGEN
         B     MARKE2        VERZWEIGEN
MARKE1   EQU   *
         TM    MQNBYTE,X'FF' PARAMETER = '<Q-NAME>' ?
         BZ    MARKE2        NEIN, VERZWEIGEN
         CLC   MINQCBNM,TEXT+5 Q-NAME = PARAMETER ?
         BNE   MARKE3        NEIN, VERZWEIGEN
MARKE2   EQU   *
         L     R0,REG4       ADRESSE DES AUFRUFERS LADEN
         WTO   MF=(E,WTO)    NACHRICHT AUSGEBEN
         OI    SCH,X'80'     BIT FUER AUSGABE SETZEN
         BAL   R14,WTOR      VERZW. ZUR WTOR-AUSGABE
MARKE3   EQU   *
         L     R5,0(R5)      ADRESSE DES NAECHSTEN QEL LADEN
         LA    R5,0(R5)      ERSTES BYTE IN R5 LOESCHEN
         LTR   R5,R5         ENDE DER QEL'S ERREICHT ?
         BZ    NXTMINVS      JA, VERZW. ZUR VERARB. DER MINOR-QCB'S
         B     WTORVS
         EJECT
***********************************************************************
*                                                                     *
*      ROUTINE ZUM DURCHLAUFEN DER QCB-KETTEN IN VS2,REL1 UND MVT.    *
*                                                                     *
***********************************************************************
         SPACE 2
MVT      EQU   *
         L     R3,200(R3)    ADRESSE DER SCVT LADEN
         L     R3,20(R3)     ADRESSE DES HEADQCB LADEN
         SPACE 3
*
*      DURCHLAUFEN DER MAJOR-QCB-KETTE.
*
         SPACE 2
NXTMAJVT EQU   *
         L     R3,0(R3)      ADRESSE DES MAJOR-QCB LADEN
         LA    R3,0(R3)      ERSTES BYTE IN R3 LOESCHEN
         LTR   R3,R3         ENDE DER MAJOR-QCB'S ERREICHT ?
         BZ    RETURN        JA, VERZW. ZUM ABSCHLUSS
         SPACE 1
         LR    R4,R3         POINTER ZUM ERSTEN MINOR-QCB LADEN
         SPACE 3
*
*      DURCHLAUFEN DER MINOR-QCB-KETTE.
*
         SPACE 2
NXTMINVT EQU   *
         L     R4,8(R4)      ADRESSE DES MINOR-QCB LADEN
         LA    R4,0(R4)      ERSTES BYTE IN R4 LOESCHEN
         LTR   R4,R4         ENDE DER MINOR-QCB'S ERREICHT ?
         BZ    NXTMAJVT      JA, VERZW, ZUR VERARB. DER MAJOR-QCB'S
         SPACE 1
         EJECT
*
*      VERARBEITUNG DER QEL'S.
*
         SPACE 2
NXTQELVT EQU   *
         L     R5,0(R4)      ADRESSE DES QEL LADEN
         LA    R5,0(R5)      ERSTES BYTE IN R5 LOESCHEN
         LTR   R5,R5         ENDE DER QEL'S ERREICHT ?
         BZ    NXTMINVT      JA, VERZW. ZUR VERARB. DER MINOR-QCB'S
         SPACE 1
         TM    ALLBYTE,X'FF' PARAMETER = 'ALL' ?
         BNZ   WTORVT        JA, VERZWEIGEN
         TM    JOBBYTE,X'FF' PARAMETER = '<JOBNAME>' ?
         BNZ   WTORVT        JA, VERZWEIGEN
         TM    MQNBYTE,X'FF' PARAMETER = '<Q-NAME>' ?
         BNZ   WTORVT        JA, VERZWEIGEN
         CLC   12(8,R3),=CL8'SYSIEFSD' MAJOR-QCB-NAME = 'SYSIEFSD' ?
         BE    WTORVT        JA, VERZWEIGEN
         SPACE 1
         CLC   1(3,R5),=XL3'000000' FOLGT NOCH EIN QEL ?
         BE    NXTMINVT      NEIN, VERZW. ZUR VERARB. DER MINOR-QCB'S
         SPACE 1
         TM    4(R5),X'80'   SHARED REQUEST ?
         BZ    WTORVT        NEIN, VERZWEIGEN
         SPACE 1
         LR    R6,R5         POINTER ZUM NAECHSTEN QEL LADEN
         SPACE 3
*
*      ABFRAGE AUF EXCLUSIVEN REQUEST.
*
         SPACE 2
TESTVT   EQU   *
         L     R6,0(R6)      ADRESSE DES NAECHSTEN QEL LADEN
         LA    R6,0(R6)      ERSTES BYTE IN R6 LOESCHEN
         LTR   R6,R6         ENDE DER QEL'S ERREICHT ?
         BZ    NXTMINVT      JA, VERZW. ZUR VERARB. DER MINOR-QCB'S
         SPACE 1
         TM    4(R6),X'80'   SHARED REQUEST ?
         BO    TESTVT        JA, VERZWEIGEN
         EJECT
*
*      AUFSUCHEN VON JOB- UND STEPNAMEN.
*
         SPACE 2
WTORVT   EQU   *
         MVC   WTO(LENMSG01),MSG01 NACHRICHT1 UEBERTRAGEN
         L     R2,8(R5)      ADRESSE DER TCB LADEN
         LA    R2,0(R2)      ERSTES BYTE IN R2 LOESCHEN
         LTR   R2,R2         ADRESSE DER TCB GUELTIG ?
         BZ    FEHLTCB       NEIN, VERZW. ZUR FEHLERROUTINE
         SPACE 1
         L     R2,12(R2)     ADRESSE DER TIOT LADEN
         LA    R2,0(R2)      ERSTES BYTE IN R2 LOESCHEN
         LTR   R2,R2         ADRESSE DER TIOT GUELTIG ?
         BZ    FEHLTCB       NEIN, VERZW. ZUR FEHLERROUTINE
         SPACE 1
         MVC   JOBNAME,=CL8' '
         NC    JOBNAME,0(R2) JOBNAME GUELTIG ?
         BZ    FEHLTCB       NEIN, VERZW. ZUR FEHLERROUTINE
         SPACE 1
         MVC   JOBNAME,0(R2) JOBNAME UEBERTRAGEN
         MVC   STEPNAME,=CL8' '
         NC    STEPNAME,0(R2) STEPNAME GUELTIG ?
         BZ    FEHLTCB       NEIN, VERZW. ZUR FEHLERROUTINE
         SPACE 1
         MVC   STEPNAME,8(R2) STEPNAME UEBERTRAGEN
         EJECT
*
*      UEBERTRAGEN DES MINOR-QCB-NAMEN.
*
         SPACE 2
         SR    R2,R2         R2 LOESCHEN
         IC    R2,12(R4)     LAENGE DES MINOR-QCB-NAME LADEN
         LA    R6,22         R6 INITIALISIEREN
         CR    R2,R6         LAENGE DES NAMEN > 22 ?
         BNH   *+6           NEIN, VERZWEIGEN
         SPACE 1
         LR    R2,R6         NEUE LAENGE LADEN
         BCTR  R2,0          R2 UM EINS VERMINDERN
         EX    R2,UEBERTR2   LAENGE MODIFIZIEREN
         TM    4(R5),X'80'   SHARED REQUEST ?
         BO    SCHRVT        JA, VERZWEIGEN
         SPACE 1
         MVC   WTO+39(2),=CL2'EX'
         B     SCHRVT        VERZWEIGEN
         SPACE 1
UEBERTR2 EQU   *
         MVC   MINQCBNM(0),14(R4) MINOR QCB NAME UEBERTRAGEN
         SPACE 3
*
*      AUSGABE DER NACHRICHT.
*
         SPACE 2
SCHRVT   EQU   *
         TM    JOBBYTE,X'FF' PARAMETER = '<JOBNAME>' ?
         BZ    MARKE11       NEIN, VERZWEIGEN
         CLC   JOBNAME,TEXT+4 JOBNAME = PARAMETER ?
         BNE   MARKE31       NEIN, VERZWEIGEN
         B     MARKE21       VERZWEIGEN
MARKE11  EQU   *
         TM    MQNBYTE,X'FF' PARAMETER = '<Q-NAME>' ?
         BZ    MARKE21       NEIN, VERZWEIGEN
         CLC   MINQCBNM,TEXT+5 Q-NAME = PARAMETER ?
         BNE   MARKE31       NEIN, VERZWEIGEN
MARKE21  EQU   *
         L     R0,REG4       ADRESSE DES AUFRUFERS LADEN
         WTO   MF=(E,WTO)    NACHRICHT AUSGEBEN
         OI    SCH,X'80'     BIT FUER AUSGABE SETZEN
         BAL   R14,WTOR      VERZW. ZUR WTOR-AUSGABE
MARKE31  EQU   *
         L     R5,0(R5)      ADRESSE DES NAECHSTEN QEL LADEN
         LA    R5,0(R5)      ERSTES BYTE IN R5 LOESCHEN
         LTR   R5,R5         ENDE DER QEL'S ERREICHT ?
         BZ    NXTMINVT      JA, VERZW. ZUR VERARB. DER MINOR-QCB'S
         B     WTORVT
         EJECT
***********************************************************************
*                                                                     *
*      ABSCHLUSSROUTINEN.                                             *
*                                                                     *
***********************************************************************
         SPACE 3
RETURN   EQU   *
         TM    SCH,X'80'     BIT FUER AUSGABE GESETZT ?
         BO    END           JA, VERZWEIGEN
         SPACE 1
         L     R0,REG4       ADRESSE DES AUFRUFERS LADEN
         TM    ALLBYTE,X'FF' PARAMETER = 'ALL' ?
         BZ    RETM1         NEIN, VERZWEIGEN
         WTO   MF=(E,MSG07)  NACHRICHT AUSGEBEN
         B     END           VERZWEIGEN
RETM1    EQU   *
         TM    JOBBYTE,X'FF' PARAMETER = '<JOBNAME>' ?
         BZ    RETM2         NEIN, VERZWEIGEN
         MVC   WTO(LENMSG08),MSG08 NACHRICHTENZEILE UEBERTRAGEN
         MVC   WTO+34(8),TEXT+4 JOBNAME UEBERTRAGEN
         WTO   MF=(E,WTO)  NACHRICHT AUSGEBEN
         B     END           VERZWEIGEN
RETM2    EQU   *
         TM    MQNBYTE,X'FF' PARAMETER = '<Q-NAME>' ?
         BZ    RETM3         NEIN, VERZWEIGEN
         WTO   MF=(E,MSG09) NACHRICHT AUSGEBEN
         B     END           VERZWEIGEN
RETM3    EQU   *
         WTO   MF=(E,MSG06)  NACHRICHT AUSGEBEN
         SPACE 3
*
*      SPEICHERPLATZFREIGABE, LADEN DER REGISTER UND RUECKSPRUNG.
*
         SPACE 2
END      EQU   *
         XRETURN ,R
         EJECT
***********************************************************************
*                                                                     *
*      FEHLERROUTINEN.                                                *
*                                                                     *
***********************************************************************
         SPACE 3
*
*      ROUTINE BEI FEHLER IM UNTERPROGRAMM FASID.
*
         SPACE 2
FEHLR15  EQU   *
         MVC   WTO(46),MSG03 NACHRICHT4 UEBERTRAGEN
         SRL   R15,4
         LTR   R15,R15       RC = 8 ?
         BNZ   *+14          NEIN, VERZWEIGEN
         SPACE 1
         MVC   WTO+44(2),=CL2'08' RC UEBERTRAGEN
         B     SCHRVS        VERZW. ZUR AUSGABE DER NACHRICHT
         SPACE 1
         MVC   WTO+44(2),=CL2'16' RC UEBERTRAGEN
         B     SCHRVS        VERZW. ZUR AUSGABE DER NACHRICHT
         SPACE 3
*
*      ROUTINE BEI UNGUELTIGER TCB-ADRESSE.
*
         SPACE 2
FEHLTCB  EQU   *
         MVC   WTO(28),MSG02 NACHRICHT3 UEBERTRAGEN
         B     SCHRVT        VERZW. ZUR AUSGABE DER NACHRICHT
         SPACE 3
*
*      ROUTINE BEI ADRESSIERUNGSFEHLER.
*
         SPACE 2
ERROR    EQU   *
         L     R0,REG4       ADRESSE DES AUFRUFERS LADEN
         WTO   MF=(E,MSG04)  NACHRICHT5 AUSGEBEN
         B     END           VERZWEIGEN ZUM ABSCHLUSS
         EJECT
***********************************************************************
*                                                                     *
*      WTOR-NACHRICHTENAUSGABE.                                       *
*                                                                     *
***********************************************************************
         SPACE 3
WTOR     EQU   *
         LA    R7,1(R7)      WTO-COUNT ERHOEHEN
         C     R7,=F'10'     SCHON 10 NACHRICHTEN AUSGEGEBEN ?
         BNER  R14           NEIN, VERZWEIGEN
         SR    R7,R7         WTO-COUNT LOESCHEN
NXTREPLY EQU   *
         XC    ECB,ECB       EVENT CONTROL BLOCK LOESCHEN
         L     R0,REG4       UCM-ID. DES AUFRUFERS LADEN
         LA    R8,ECB        ADRESSE DES ECB LADEN
         LA    R9,REPLY      ADRESSE DES REPLY LADEN
         MVC   WTO(LENMSG05),MSG05 NACHRICHTENZEILE UEBERTRAGEN
         WTOR  ,(R9),1,(R8),MF=(E,WTO) NACHRICHT AUSGEBEN
         SPACE 1
         WAIT  ECB=ECB       WARTEN AUF REPLY
         CLI   REPLY,C'N'    REPLY ='NO' ?
         BE    END           JA, VERZWEIGEN
         CLI   REPLY,C'Y'    REPLY = 'YES' ?
         BNE   NXTREPLY      NEIN, VERZWEIGEN
         BR    R14           VERZWEIGEN
         EJECT
***********************************************************************
*                                                                     *
*      DATA DIVISION.                                                 *
*                                                                     *
***********************************************************************
         SPACE 3
*
*      NACHRICHTEN.
*
         SPACE 2
MSG01    WTO   'XQCB001                   ENQUEUES ON                  *
                    ',                                                 *
               MF=L,MCSFLAG=(REG0)
LENMSG01 EQU   *-MSG01
MSG02    WTO   'XQCB002 INVALID TCB-ADDR',                             *
               MF=L,MCSFLAG=(REG0)
MSG03    WTO   'XQCB003 JOB- AND STEPNAME NOT FOUND, RC=99',           *
               MF=L,MCSFLAG=(REG0)
MSG04    WTO   'XQCB004 QCB ABNORMALLY TERMINATED. TRY IT AGAIN',      *
               MF=L,MCSFLAG=(REG0)
         EJECT
MSG05    WTOR  'XQCB005 REPLY ''Y'' (YES) OR ''N'' (NO) TO CONTINUE',  *
               MF=L,MCSFLAG=(REG0)
LENMSG05 EQU   *-MSG05
MSG06    WTO   'XQCB006 NO JOBS IN CONFLICT SITUATION',                *
               MF=L,MCSFLAG=(REG0)
MSG07    WTO   'XQCB007 NO EXISTING QCB''S',                           *
               MF=L,MCSFLAG=(REG0)
MSG08    WTO   'XQCB008 NO EXISTING QCB''S FOR *JOBNAME',              *
               MF=L,MCSFLAG=(REG0)
LENMSG08 EQU   *-MSG08
MSG09    WTO   'XQCB009 NO EXISTING QCB''S OF SPECIFIED NAME FOUND',   *
               MF=L,MCSFLAG=(REG0)
         EJECT
*
*      PROGRAM INTERRUPTION CONTROL AREA.
*
         SPACE 2
PICA     SPIE  ERROR,(4,5),MF=L
         SPACE 3
*
*      REGISTER EQUATES.
*
         SPACE 2
R0       EQU   0             ENTHAELT ADRESSE DES AUFRUFERS BEI WTO
R1       EQU   1             ZEIGT AUF PARAMETERBEREICH
R2       EQU   2             ZEIGT AUF TCB / TIOT
R3       EQU   3             ZEIGT AUF MAJOR-QCB'S
R4       EQU   4             ZEIGT AUF MINOR-QCB'S
R5       EQU   5             ZEIGT AUF QEL'S
R6       EQU   6             ARBEITSREGISTER
R7       EQU   7             WTO-COUNT
R8       EQU   8
R9       EQU   9
R10      EQU   10
R11      EQU   11            BASISREGISTER FUER DSECT PARMAREA
R12      EQU   12            BASISREGISTER FUER CSECT QCB
R13      EQU   13            BASISREGISTER FUER DSECT ABER
R14      EQU   14            ENTHAELT RUECKSPRUNGADRESSEN
R15      EQU   15            ENTHAELT EINGANGSADRESSEN
         EJECT
*
*      ARBEITSBEREICHE.
*
         SPACE 2
ABER     DSECT
SAVEAREA DS    18F           SAVEAREA FUER REGISTER
ECB      DS    F             EVENT CONTROL BLOCK
WTO      DS    0F            BEREICH FUER NACHRICHTEN
         ORG   WTO+12
JOBNAME  DS    CL8           JOB NAME
         DS    C
STEPNAME DS    CL8           STEP NAME
         DS    CL13
MINQCBNM DS    CL22          MINOR QCB NAME
         ORG   WTO+80
         SPACE 1
FASIDADR DS    F                       ENTRY POINT ADDR. OF SUBROUTINE
PARMLIST DS    0F
ADDRASID DS    A(ASID)       ADRESSE DER ASID
ADDRJOBN DS    A(JOBNAME)    ADRESSE DES JOBNAMEN
LASTPARM DS    C             = X'80'
ADDRSTPN DS    AL3(STEPNAME) ADRESSE DES STEPNAMEN
         SPACE 1
ASID     DS    H
SCH      DS    C             BEREICH FUER SCHALTER-BITS
JOBBYTE  DS    C             PARAMETER-SCHALTER
MQNBYTE  DS    C             PARAMETER-SCHALTER
ALLBYTE  DS    C             PARAMETER-SCHALTER
REPLY    DS    C             BEREICH FUER REPLY
ABERL    EQU   *-ABER        LAENGE DES ARBEITSBEREICHS
         SPACE 3
*
*      PARAMETERBEREICH.
*
         SPACE 2
         XPARM
         EJECT
         END   QCB
./ ADD  NAME=REG
         MACRO
         REG
*
*        REGISTER EQUATES
*
R0       EQU   0
R1       EQU   1
R2       EQU   2
R3       EQU   3
R4       EQU   4
R5       EQU   5
R6       EQU   6
R7       EQU   7
R8       EQU   8
R9       EQU   9
R10      EQU   10
RA       EQU   R10
R11      EQU   11
RB       EQU   R11
R12      EQU   12
RC       EQU   R12
R13      EQU   13
RD       EQU   R13
R14      EQU   14
RE       EQU   R14
R15      EQU   15
RF       EQU   R15
         SPACE 2
         MEND
./ ADD  NAME=RENAM
RENAM    CSECT
         REG
         XSAVE R12,,RENAM,WORKL
         LR    R11,R1
         USING WORK,R13
         USING PARMAREA,R11
         MVC   UNCLIST,UNCLISTS
         LA    R2,DSNAME
         ST    R2,UNCLIST+4
         LA    R2,NEWNAME
         ST    R2,UNCLIST+8
         LA    R2,VOLNO
         ST    R2,UNCLIST+12
         MVC   SEQNO,=C'0001'
         MVI   NEWNAME,X'40'
         MVC   NEWNAME+1(43),NEWNAME
         MVI   DSNAME,C' '
         MVC   DSNAME+1(43),DSNAME
         MVI   UNIT,C' '
         MVC   UNIT+1(5),UNIT
         XC    VOLNO,VOLNO
         LA    R8,TEXT+6
         LA    R3,100
         LR    R4,R8
         LA    R5,100(R8)
DSN1     EQU   *
         CLC   0(2,R4),=CL2'D='
         BNE   DSN3
         LA    R4,2(R4)
         B     DSN5
DSN3     EQU   *
         LA    R4,1(R4)
         BCT   R3,DSN1
         MVC   WTO(LENMSG01),MSG01
GIVEWTO  EQU   *
         L     R0,REG4
         WTO   MF=(E,WTO)
         B     RETURN
DSN5     EQU   *
         LR    R7,R5
         SR    R7,R4
         EX    R7,TCOMMA
         BNZ   DSN6
         LA    R1,1(R5)
DSN6     EQU   *
         SR    R1,R4
         BCTR  R1,0
         LTR   R1,R1
         BNM   DSN8
DELERROR EQU   *
         MVC   WTO(LENMSG02),MSG02
         B     GIVEWTO
DSN8     EQU   *
         EX    R1,MOVEDSN
         LR    R4,R8
         LA    R3,100
NEW1     EQU   *
         CLC   0(2,R4),=CL2'N='
         BNE   NEW3
         LA    R4,2(R4)
         B     NEW5
NEW3     EQU   *
         LA    R4,1(R4)
         BCT   R3,NEW1
         MVC   WTO(LENMSG01),MSG01
         MVC   WTO+40(2),=CL2'N='
         B     GIVEWTO
NEW5     EQU   *
         LR    R7,R5
         SR    R7,R4
         EX    R7,TCOMMA
         BNZ   NEW6
         LA    R1,1(R5)
NEW6     EQU   *
         SR    R1,R4
         BCTR  R1,0
         LTR   R1,R1
         BM    DELERROR
         EX    R1,MOVENEW
         LR    R4,R8
         LA    R3,100
UNIT1    EQU   *
         CLC   0(2,R4),=CL2'U='
         BE    UNIT2
         LA    R4,1(R4)
         BCT   R3,UNIT1
         MVC   WTO(LENMSG01),MSG01
         MVC   WTO+40(2),=CL2'U='
         B     GIVEWTO
UNIT2    EQU   *
         LA    R4,2(R4)
         LR    R7,R5
         SR    R7,R4
         EX    R7,TCOMMA
         BNZ   UNIT5
         LA    R1,1(R5)
UNIT5    EQU   *
         SR    R1,R4
         BCTR  R1,0
         LTR   R1,R1
         BM    DELERROR
         EX    R1,MOVEUNT
         CLC   UNIT(2),=CL2'24'
         BE    XXX
         CLC   UNIT(2),=CL2'34'
         BE    XXX
         CLC   UNIT(4),=C'TAPE'
         BNE   SEQ7
XXX      EQU   *
         LR    R4,R8
         LA    R3,100
SEQ1     EQU   *
         CLC   0(2,R4),=CL2'S='
         BE    SEQ2
         LA    R4,1(R4)
         BCT   R3,SEQ1
         B     VOL1
SEQ7     EQU   *
         MVI   SEQNO+3,C'0'
         B     VOL1
SEQ2     EQU   *
         LA    R4,2(R4)
         LR    R7,R5
         SR    R7,R4
         EX    R7,TCOMMA
         BNZ   SEQ5
         LA    R1,1(R5)
SEQ5     EQU   *
         SR    R1,R4
         BCTR  R1,0
         LTR   R1,R1
         BM    DELERROR
         EX    R1,TNUM
         BZ    SEQ6
         MVC   WTO(LENMSG01),MSG01
         MVC   WTO+40(2),=CL2'S='
         B     GIVEWTO
SEQ6     EQU   *
         LA    R9,SEQNO+3
         SR    R9,R1
         EX    R1,MOVESEQ
VOL1     EQU   *
         LR    R4,R8
         LA    R3,100
VOL2     EQU   *
         CLC   0(2,R4),=CL2'V='
         BE    VOL3
         LA    R4,1(R4)
         BCT   R3,VOL2
         MVC   WTO(LENMSG01),MSG01
         MVC   WTO+40(2),=CL2'V='
         B     GIVEWTO
VOL3     EQU   *
         LA    R4,2(R4)
         LA    R8,DEVTAB
         LA    R6,11
         LA    R7,DEVEND-11
VOL6     EQU   *
         CLC   4(6,R8),UNIT
         BE    VOL7
         BXLE  R8,R6,VOL6
         MVC   WTO(LENMSG03),MSG03
         B     GIVEWTO
VOL7     EQU   *
         LH    R2,VOLNO
         LA    R9,VOLIST
         LA    R3,VOLIST+240
         CLI   0(R4),C'('
         BE    VOL11
         LR    R7,R5
         SR    R7,R4
         ST    R2,ALIST
         EX    R7,TCOMMA
         L     R2,ALIST
         BNZ   VOL8
         LA    R1,1(R5)
VOL8     EQU   *
         SR    R1,R4
         CH    R1,=H'6'
         BNH   VOL9
         MVC   WTO(LENMSG04),MSG04
         B     GIVEWTO
VOL9     EQU   *
         MVC   0(4,R9),0(R8)
         BCTR  R1,0
         MVI   4(R9),X'40'
         MVC   5(5,R9),4(R9)
         EX    R1,MOVESER
         PACK  D,SEQNO
         CVB   R1,D
         STH   R1,10(R9)
         LA    R2,1(R2)
VOL10    EQU   *
         STH   R2,VOLNO
         B     ENDRT2
VOL11    EQU   *
         PACK  D,SEQNO
         CVB   R1,D
VOL12    EQU   *
         LA    R4,1(R4)
         STM   R1,R2,WTO
         LR    R7,R5
         SR    R7,R4
         EX    R7,TKLAM
         BZ    DELERROR
         SR    R1,R4
         LR    R6,R1
         LM    R1,R2,WTO
         BCTR  R6,0
         MVI   4(R9),X'40'
         MVC   5(5,R9),4(R9)
         EX    R6,MOVESER
         MVC   0(4,R9),0(R8)
         LA    R4,1(R6,R4)
         STH   R1,10(R9)
         LA    R2,1(R2)
         CLI   0(R4),C')'
         BE    VOL10
         LA    R9,12(R9)
         CR    R9,R3
         BL    VOL12
         MVC   WTO(LENMSG05),MSG05
         B     GIVEWTO
ENDRT2   EQU   *
         SR    R0,R0
         RENAME UNCLIST
         LH    R5,VOLNO
         LA    R6,VOLIST
         LA    R7,12
TEST2    EQU   *
         SR    R10,R10
         IC    R10,11(R6)
         SLA   R10,3
         LA    R9,ERRTAB
         AR    R10,R9
         L     R9,0(R10)
         L     R10,4(R10)
         BCTR  R10,0
         EX    R10,MVCWTO
         L     R0,REG4
         WTO   MF=(E,WTO)
         AR    R6,R7
         BCT   R5,TEST2
RETURN   EQU   *
         XRETURN ,R
ERRTAB   DS    0F
         DC    A(MSG06),A(LENMSG06)
         DC    A(MSG07),A(LENMSG07)
         DC    A(MSG11),A(LENMSG11)
         DC    A(MSG08),A(LENMSG08)
         DC    A(MSG09),A(LENMSG09)
         DC    A(MSG10),A(LENMSG10)
         DC    A(MSG10),A(LENMSG10)
         DC    A(MSG12),A(LENMSG12)
UNCLISTS CAMLST RENAME,ERRTAB,ERRTAB,ERRTAB
TKLAM    TRT   0(0,R4),TTAB
TTAB     DC    93X'00',X'FF',13X'00',X'FF',148X'00'
TCOMMA   TRT   0(0,R4),TRTTAB
TRTTAB   DC    64X'00',X'FF',42X'00',X'FF',148X'00'
MOVEDSN  MVC   DSNAME(0),0(R4)
MOVEUNT  MVC   UNIT(0),0(R4)
MVCWTO   MVC   WTO(0),0(R9)
TNUM     TRT   0(0,R4),NUMTAB
NUMTAB   DC    240X'FF',10X'00',6X'FF'
MOVESEQ  MVC   0(0,R9),0(R4)
MOVESER  MVC   4(0,R9),0(R4)
MOVENEW  MVC   NEWNAME(0),0(R4)
DEVTAB   DC    X'30008001'
         DC    C'2400  4'
         DC    X'30808001'
         DC    C'2400-16'
         DC    X'30C08001'
         DC    C'2400-26'
         DC    X'34008001'
         DC    C'2400-36'
         DC    X'34208001'
         DC    C'2400-46'
         DC    X'34008003'
         DC    C'3400-36'
         DC    X'34008003'
         DC    C'TAPE  4'
         DC    X'34008003'
         DC    C'BAND  4'
         DC    X'30002001'
         DC    C'2311  4'
         DC    X'30402002'
         DC    C'2301  4'
         DC    X'30002004'
         DC    C'2302  4'
         DC    X'30002003'
         DC    C'2303  4'
         DC    X'30C02008'
         DC    C'2314  4'
         DC    X'30002005'
         DC    C'2321  4'
         DC    X'30702007'
         DC    C'2305-26'
         DC    X'30702007'
         DC    C'DRUM  4'
         DC    X'30702006'
         DC    C'2305-16'
         DC    X'30702009'
         DC    C'3330  4'
         DC    X'30502009'
         DC    C'DISK  4'
         DC    X'3050200A'
         DC    C'3340  4'
         DC    X'3050200D'
         DC    C'3330  4'
DEVEND   EQU   *
MSG01    WTO   'XRENAM0 INVALID OR MISSING KEYWORD: D=.',              *
               MF=L,MCSFLAG=(REG0)
LENMSG01 EQU   *-MSG01
MSG02    WTO   'XRENAM1 DELIMITER ERROR',MCSFLAG=(REG0),MF=L
LENMSG02 EQU   *-MSG02
MSG03    WTO   'XRENAM2 INVALID UNIT NAME',MCSFLAG=(REG0),MF=L
LENMSG03 EQU   *-MSG03
MSG04    WTO   'XRENAM3 INVALID VOLSER',MCSFLAG=(REG0),MF=L
LENMSG04 EQU   *-MSG04
MSG05    WTO   'XRENAM4 MORE THAN 20 VOLSERS',MCSFLAG=(REG0),          *
               MF=L
LENMSG05 EQU   *-MSG05
MSG06    WTO   'XRENAM5 THE SPECIFIED DATA SET HAS BEEN RENAMED',MF=L, *
               MCSFLAG=(REG0)
LENMSG06 EQU   *-MSG06
MSG07    WTO   'XRENAM5 DSCB NOT FOUND',MF=L,MCSFLAG=(REG0)
LENMSG07 EQU   *-MSG07
MSG08    WTO   'XRENAM5 DUPLICATE DSNAME IN VTOC',MF=L,MCSFLAG=(REG0)
LENMSG08 EQU   *-MSG08
MSG09    WTO   'XRENAM5 PERM. I/O ERROR',MF=L,MCSFLAG=(REG0)
LENMSG09 EQU   *-MSG09
MSG10    WTO   'XRENAM5 UNABLE TO MOUNT VOLUME',MF=L,MCSFLAG=(REG0)
LENMSG10 EQU   *-MSG10
MSG11    WTO   'XRENAM5 DATA SET HAS NOT BEEN RENAMED',                *
               MF=L,MCSFLAG=(REG0)
LENMSG11 EQU   *-MSG11
MSG12    WTO   'XRENAM5 DATA SET IN USE',                              *
               MF=L,MCSFLAG=(REG0)
LENMSG12 EQU   *-MSG12
         LTORG
         XPARM
WORK     DSECT
SVA      DS    18F
WTO      DS    CL108
         DS    0F
UNCLIST  DS    CL16
DSNAME   DS    CL44
NEWNAME  DS    CL44
         CNOP  2,4
VOLNO    DS    H
VOLIST   DS    20CL12
SEQNO    DS    CL4
UNIT     DS    CL6
D        DS    D
ALIST    DS    F
WORKL    EQU   *-WORK
         END
./ ADD  NAME=RETU
         MACRO
&NAME    RETU  &RC=0,&PARAM=NOT
.*
.*       USER WRITTEN MACRO
.*       PROGRAM END ROUTINE
.*
         GBLB  &BEGIN,&PL1PROG
         GBLB  &SASTATC,&PRVEXIT,&FLPSAVE,&SUBROUT
         LCLC  &R
         LCLA  &WK,&WK1,&WK2
         LCLA  &LV
         LCLB  &SW,&SW1,&SW2,&SW3
&SW      SETB  ('&PARAM' EQ 'YES' OR '&RC'(1,1) EQ '(')
&SW1     SETB  (&PRVEXIT AND &SUBROUT)
&SW2     SETB  (&SW AND &SW1)
&LV      SETA  72
         AIF   (&BEGIN).START
&SASTATC SETB  1
.START   AIF   (NOT &FLPSAVE).C0X
&LV      SETA  &LV+32
.*
.*       SAVE PARAMS, STORE RC AND RESTORE OLD INTERRUPTION HANDLING
.*
.C0X      AIF  (&PL1PROG).PL1
.C0      AIF   (&SASTATC AND &SW1 AND NOT &SW).S01
         AIF   (&SASTATC AND NOT &SW1).S0
&SW3     SETB  1
&R       SETC  'R14'
         AGO   .C1
.S0      ANOP
&SW3     SETB  0
&R       SETC  'R13'
         AGO   .C1
.S01     ANOP
&NAME    L     R1,&LV.(,R13) LOAD OLD PICA ADDRESS
         SVC   14 ISSUE SPIE SVC
         L     R13,4(,R13) LOAD OLD SAVEAREA ADDRESS
         AGO   .C5
.C1      ANOP
&NAME    L     &R,4(,R13) LOAD OLD SAVEAREA ADDRESS
         AIF   ('&PARAM' NE 'YES').C2
         STM   R0,R1,20(&R) SAVE PARAMS
.C2      AIF   ('&RC'(1,1) NE '(').C3
         AIF   ('&RC(1)' LT '13').RCX0
&WK      SETA  &RC(1)-14
         AGO   .RCX1
.RCX0    AIF   ('&RC(1)' EQ '13' OR '&RC(1)' EQ '14').RCXMN
          AIF   (&PL1PROG AND '&RC(1)' EQ '12').PL1MN
&WK      SETA  &RC(1)+2
         AGO   .RCX1
.RCXMN   MNOTE 8,'REGISTER &RC(1) SHOULD NOT BE USED FOR RETURN CODE'
         AGO   .C3
.PL1MN   MNOTE 8,'REGISTER 12 SHOULD NOT BE USED IN A SUBROUTINE TO PL1/
               '
         MEXIT
.RCX1    ANOP
&WK      SETA  &WK*4
&WK      SETA  &WK+12
         ST    R&RC(1),&WK.(,&R) STORE RC
.C3      AIF   (NOT &SUBROUT OR NOT &PRVEXIT).C4X
         L     R1,&LV.(,R13) LOAD OLD PICA ADDRESS
         SVC   14 ISSUE SPIE SVC
&LV      SETA  &LV+4
.C4X     AIF   (NOT &PL1PROG).C4
         L     R1,&LV.(,R13) RESTORE
         ST    R14,0(,R1) OLD PRV CONTENTS
&LV      SETA  &LV+4
.C4      AIF   (&SASTATC).S1
.*
.*       RELEASE DYNAMIC SAVEAREA
.*
         LA    R0,&LV LOAD SAVEAREA LENGTH
         LR    R1,R13 LOAD SAVEAREA ADDRESS
         SVC   10 ISSUE FREEMAIN SVC
.S1      AIF   (NOT &SW3).C5
         LR    R13,R14 LOAD OLD SAVEAREA ADDRESS
.*
.*       RESTORE THE REGISTERS
.*
.C5      AIF   (NOT &FLPSAVE OR NOT &SUBROUT).C6
         LD    0,72(,R13) RESTORE
         LD    2,80(,R13) FLOATING
         LD    4,88(,R13) POINT
         LD    6,96(,R13) REGISTERS
.C6      AIF   (&SASTATC AND NOT &PL1PROG).C6X
         XC    8(4,R13),8(R13) DROP SAVEAREA CHAIN
         AIF   (NOT &PL1PROG).C6X
         LM    R14,R11,12(R13) RESTORE GENERAL REGISTERS
         AGO   .C6Y
.C6X     LM    R14,R12,12(R13) RESTORE GENERAL REGISTERS
.C6Y     AIF   ('&RC' EQ '(15)').C7
        AIF   ('&RC'(1,1) EQ '(').C60
         AIF   ('&RC' EQ '0').C60
         AIF   ('&RC' GT '4095').RCLARGE
         LA    R15,&RC LOAD RC INTO REG 15
         AGO   .C7
.C60     XR    R15,R15 SET RC ZERO
.C7      BR    R14 RETURN
        MEXIT
.RCLARGE MNOTE 4,'RC=&RC GREATER THAN 4095'
         AGO   .C7
         MEXIT
.PL1     ANOP
&SW3     SETB  1
&R       SETC  'R14'
         AGO   .C1
         MEND
./ ADD  NAME=RQE
         TITLE 'XRQE                                 X-COMMAND RQE'
RQE      CSECT
         SPACE 2
***********************************************************************
*                                                                     *
*      IDENTIFICATION DIVISION.                                       *
*                                                                     *
*      PROGRAM-ID. RQE.                                               *
*      AUTHOR. EHNERT.                                                *
*      INSTALLATION. BAYER AG, LEVERKUSEN, RECHENZENTRUM.             *
*      DATE-WRITTEN. 15.3.74.                                         *
*      REMARKS.                                                       *
*          DAS X-COMMAND RQE GIBT INFORMATIONEN AUS DER EIN-/AUS-    *
*          GABE-WARTESCHLANGE BEZUEGLICH DER DURCH PARAMETER SPEZI-   *
*          FIZIERTTEN DEVICES AUS.                                    *
*              ES GELTEN FOLGENDE PARAMETER:                          *
*          A) ALL = ALLE DEVICES                                      *
*          B) UR = UNIT-RECORD DEVICES                                *
*          C) TAPE = TAPE DEVICES                                     *
*          D) DASD = DIRECT-ACCESS DEVICES                            *
*          E) TP = TELEPROCESSING DEVICES                             *
*          F) GRAPHIC = GRAPHIC DEVICES                               *
*          G) 'TEST' : WIRD DIESER PARAMETER ANGEGEBEN, SO WERDEN     *
*          FEHLERMELDUNGEN BEZUEGLICH DER GANZEN RQE-KETTE AUSGEGE-   *
*          BEN, DIE STANDARDMAESSIG IMMER UNTERDRUECKT WERDEN.        *
*              WERDEN KEINE PARAMETER ANGEGEBEN, SO GELTEN STANDARD-  *
*          MAESSIG DIE PARAMETER 'UR', 'TAPE', 'DASD'.                *
*                                                                     *
***********************************************************************
         EJECT
***********************************************************************
*                                                                     *
*      PROCEDURE DIVISION.                                            *
*                                                                     *
***********************************************************************
         SPACE 3
*
*      REGISTER SICHERN UND SPEICHERPLATZANFORDERUNG FUER
*      ARBEITSBEREICHE.
*
         SPACE 2
         XSAVE R12,,TESTRQE,ABERL
         SPACE 3
*
*      REGISTERZUORDNUNGEN.
*
         SPACE 2
         USING ABER,R13      R13 ALS BASISREG. FUER ARBEITSBEREICHE
         LR    R11,R1        ADRESSE DES PARAMETERBEREICHS LADEN
         USING PARMAREA,R11  R11 ALS BASISREG. FUER PARAMETERBEREICHE
         SR    R3,R3         R3 LOESCHEN
         EJECT
***********************************************************************
*                                                                     *
*      VERARBEITUNG DER PARAMETERKETTE.                               *
*                                                                     *
***********************************************************************
         SPACE 3
         MVC   ABERTAB,DEVTAB DEVICE-TABELLE UEBERTRAGEN
         SR    R2,R2         R2 LOESCHEN
         LA    R5,5          R5 INITIALISIEREN
         LA    R8,TEXT+3     ADRESSE DER PARAMETERKETTE LADEN
         LA    R4,124        LAENGE DER PARAMETERKETTE LADEN
         CLI   0(R8),C','    FOLGEN PARAMETER ?
         BNE   DEFAULT       NEIN, VERZW ZUR DEFAULT-EINTRAGUNG
         SPACE 3
*
*      AUFSUCHEN DER EINZELPARAMETER.
*
         SPACE 2
PARMSCHL EQU   *
         LA    R8,1(R8)      R8 ZEIGT AUF DEN PARAMETER
         LR    R6,R8         ADRESSE DES PARAMETERS UMLADEN
         SR    R9,R9         R9 LOESCHEN
         LA    R5,1(R5)      R5 ERHOEHEN
         SPACE 1
ABFRAGE  EQU   *
         CLI   0(R6),C','    FOLGT NAECHSTER PARAMETER ?
         BE    AUSG          JA, VERZWEIGEN
         CLI   0(R6),X'00'   ENDE DER PARAMETERKETTE ERREICHT ?
         BE    AUSG          JA, VERZWEIGEN
         CLI   0(R6),C' '    ENDE DER PARAMETERKETTE ERREICHT ?
         BE    AUSG          JA, VERZWEIGEN
         LA    R9,1(R9)      R9 ERHOEHEN
         CH    R9,=H'08'     PARAMETERLAENGE GUELTIG ?
         BH    FEHLPARM      NEIN, VERZW. ZUR FEHLERROUTINE
         SPACE 1
         LA    R5,1(R5)      R5 ERHOEHEN
         CR    R5,R4         ENDE DER PARAMETERKETTE ERREICHT ?
         BH    AUSG          JA, VERZWEIGEN
         LA    R6,1(R6)      R6 ERHOEHEN
         B     ABFRAGE       VERZWEIGEN ZUR ABFRAGE
         EJECT
*
*      ABFRAGE DER EINZELPARAMETER.
*
         SPACE 1
AUSG     EQU   *
         MVC   ZWISPEI(8),=CL8' ' ZWISCHENSPEICHER LOESCHEN
         LTR   R9,R9         PARAMETERLAENGE = 0 ?
         BZ    FEHLPARM      JA, VERZW. ZUR FEHLERROUTINE
         BCTR  R9,0          R9 UM EINS VERMINDERN
         EX    R9,UEBERTR    VERZW. ZUM UEBERTRAGEN
         CLC   ZWISPEI(8),=CL8'TEST' PARAMETER = TEST ?
         BNE   SUCHALL       NEIN, VERZWEIGEN ZU WEITEREN ABFRAGEN
         LH    R2,=H'08'     R2 INITIALISIEREN
         B     ENDPARM       VERZW. ZUM ENDE DER ROUTINE
         SPACE 1
UEBERTR  EQU   *
         MVC   ZWISPEI(0),0(R8) PARAMETER UEBERTRAGEN
         SPACE 2
*
*      ROUTINE BEI PARAMETER = 'ALL'.
*
         SPACE 1
SUCHALL  EQU   *
         LA    R7,ABERTAB-10 ADRESSE DER TABELLE LADEN
         CLC   ZWISPEI(8),=CL8'ALL' ALLE DEVICE-KLASSEN ?
         BNE   TABSCHL       NEIN, VERZW. ZU WEITEREN ABFRAGEN
         SPACE 1
ALLSCHL  EQU   *
         LA    R7,10(R7)     R7 UM DIE LAENGE EINES ELEMENTS ERHOEHEN
         CLI   0(R7),X'FF'   TABELLENENDE ERREICHT ?
         BE    ENDPARM       JA, VERZW. ZUM ENDE DER PARM.-VERARB.
         SPACE 1
         OI    0(R7),X'80'   BIT SETZEN
         B     ALLSCHL
         SPACE 2
*
*      ROUTINE FUER EINZELPARAMETER.
*
         SPACE 1
TABSCHL  EQU   *
         LA    R7,10(R7)     R7 UM DIE LAENGE EINES ELEMENTS ERHOEHEN
         CLI   0(R7),X'FF'   PARAMETER GUELTIG ?
         BE    FEHLPARM      NEIN, VERZW. ZUR FEHLERROUTINE
         SPACE 1
         CLC   ZWISPEI(8),2(R7) PARAMETER = TABELLENELEMENT ?
         BNE   TABSCHL       NEIN, VERZWEIGEN
         OI    0(R7),X'80'   JA, BIT SETZEN
         EJECT
*
*      ABSCHLUSS DER ROUTINE.
*
         SPACE 2
ENDPARM  EQU   *
         LR    R8,R6         R8 NEU INITIALISIEREN
         CLI   0(R8),C','    FOLGT NOCH EIN PARAMETER ?
         BE    PARMSCHL      JA, VERZWEIGEN
         B     SUCHRQE       VERZW. ZUM AUFSUCHEN DER RQE-TABELLE
         SPACE 3
*
*      DEFAULT-EINTRAGUNGEN.
*
         SPACE 2
DEFAULT  EQU   *
         OI    ABERTAB,X'80'    BIT SETZEN BEI 'TAPE'
         OI    ABERTAB+10,X'80' BIT SETZEN BEI 'DASD'
         OI    ABERTAB+20,X'80' BIT SETZEN BEI 'UR'
         EJECT
***********************************************************************
*                                                                     *
*      RQE-VERARBEITUNG.                                              *
*                                                                     *
***********************************************************************
         SPACE 3
*
*      AUFSUCHEN DER RQE-TABELLE.
*
         SPACE 2
SUCHRQE  EQU   *
         L     R10,16        ADRESSE DER CVT LADEN
         TM    116(R10),X'01' SYSTEM = MVS ?
         BO    VSSYSTEM      JA, VERZW. ZUR ROUTINE FUER VS2,REL2
         SPACE 1
         L     R4,200(R10)   ADRESSE DER ZWEITEN CVT LADEN
         L     R4,112(R4)    ADRESSE DER I/O-DEV.-STAT.-TAB. LADEN
         LA    R4,0(R4)      ERSTES BYTE IN R4 LOESCHEN
         SPACE 1
         SR    R5,R5         R5 LOESCHEN
         TM    116(R10),X'02' SYSTEM = VS ?
         BZ    *+8           NEIN, VERZWEIGEN
         SPACE 1
         LA    R5,4          R5 INITIALISIEREN
         L     R10,120(R10)  ADRESSE DER RQE-TABELLE LADEN
         LA    R10,0(R10)    ERSTES BYTE IN R10 LOESCHEN
         SPACE 3
*
*      LESEN DER RQE-TABELLE.
*
         SPACE 2
LESRQE   EQU   *
         CLC   0(2,R10),=H'01' ENDE DER RQE-TABELLE ERREICHT ?
         BE    ABSCHLUS      JA, VERWEIGEN ZUM ABSCHLUSS
         CLI   4(R10),X'FF'  RQE FREI ?
         BE    ENDRQE        JA, VERZW. ZUM ENDE DER RQE-VERARBEITUNG
         MVC   NACHR,MSG1    NACHRICHT IN DEN ARBEITSBER. UEBERTR.
         EJECT
***********************************************************************
*                                                                     *
*      UCB-VERARBEITUNG.                                              *
*                                                                     *
***********************************************************************
         SPACE 3
LESUCB   EQU   *
         LH    R9,2(R10)     ADRESSE DES UCB LADEN
         LA    R8,FEHLUCB    ADRESSE DER FEHLERROUTINE LADEN
         CLI   2(R9),X'FF'   UCB ?
         BNE   FEHLROUT      NEIN, VERZWEIGEN ZUR FEHLERROUTINE
         SPACE 3
*
*      ABFRAGE DER DEVICE-KLASSEN.
*
         SPACE 2
         LA    R7,ABERTAB-10 ADRESSE DER TABELLE LADEN
         LA    R8,FEHLCLS    ADRESSE DER FEHLERROUTINE LADEN
         SPACE 1
UCBSCHL  EQU   *
         LA    R7,10(R7)     R7 UM DIE LAENGE EINES ELEMENTS ERHOEHEN
         CLI   0(R7),X'FF'   GUELTIGE DEVICE-KLASSE ?
         BE    FEHLROUT      NEIN, VERZW. ZUR FEHLERROUTINE
         CLC   18(1,R9),1(R7) DEV-KLASSE = TAB-ELEMENT ?
         BNE   UCBSCHL       NEIN, VERZW.
         MVI   SCH,X'00'     SCHREIBSCHALTER LOESCHEN
         CLI   0(R7),X'80'   GEWUENSCHTE DEVICE-KLASSE ?
         BNE   UEBUNIT       NEIN, VERZW.
         MVI   SCH,X'80'     SCHREIBSCHALTER SETZEN
         SPACE 3
*
*      UEBERTRAGEN DES UNIT-NAME.
*
         SPACE 2
UEBUNIT  EQU   *
         LA    R8,FEHLUCB    ADRESSE DER FEHLERROUTINE LADEN
         MVC   MSGUNITN,13(R9) UNIT-NAME UEBERTRAGEN
         MVC   ZWISPEI(8),=CL8' ' ZWISCHENSPEICHER LOESCHEN
         NC    ZWISPEI(3),MSGUNITN UNIT-NAME GUELTIG ?
         BZ    FEHLROUT      NEIN, VERZW. ZUR FEHLERROUTINE
         LTR   R2,R2         R2 = 0 ?
         BZ    UEBDEV3       JA, VERZWEIGEN
         EJECT
*
*      ABFRAGE DES DEVICE-STATUS.
*
         SPACE 2
         MVC   ZWISPEI(1),3(R9)
         TM    ZWISPEI,X'80' OFFLINE ?
         BC    1,*+10        NEIN, VERZWEIGEN
         MVC   MSGTEXT,DEVSTATA+1 'OFFLINE' UEBERTRAGEN
         MVC   ZWISPEI(1),3(R9)
         NI    ZWISPEI,X'02' SYSRES ODER CONSOLE ?
         BZ    UEBDEV1       NEIN, VERZWEIGEN
         CLI   18(R9),X'20'  DASD/SYSRES ?
         BNE   UEBDEV11
         MVC   MSGTEXT,DEVSTATA+21 'SYSRES' UEBERTRAGEN
         B     UEBDEV1
UEBDEV11 EQU   *
         CLI   18(R9),X'40'  TP ?
         BE    UEBDEV1
         CLI   18(R9),X'80'  TAPE ?
         BE    UEBDEV1
         MVC   MSGTEXT,DEVSTATA+41 'CONSOLE' UEBERTRAGEN
         SPACE 1
UEBDEV1  EQU   *
         MVC   ZWISPEI(1),3(R9)
         NI    ZWISPEI,X'10' UNLOAD PENDING ?
         BZ    UEBDEV2       NEIN, VERZWEIGEN
         MVC   MSGTEXT,DEVSTATA+61 'UNLOAD PENDING' UEBERTRAGEN
         SPACE 1
UEBDEV2  EQU   *
         MVC   ZWISPEI(1),3(R9)
         NI    ZWISPEI,X'40' OFFLINE PENDING ?
         BZ    UEBDEV3
         MVC   MSGTEXT,DEVSTATA+81 'OFFLINE PENDING' UEBERTRAGEN
         SPACE 1
UEBDEV3  EQU   *
         LA    R7,DEVFLAG    ADRESSE DER TABELLE LADEN
         LA    R6,3          R6 INITIALISIEREN
         SPACE 1
DEVSCHL  EQU   *
         MVC   ZWISPEI(1),6(R9)
         NC    ZWISPEI(1),0(R7) ENTSPR. FLAGBIT GESETZT ?
         BZ    *+10          NEIN, VERZWEIGEN
         MVC   MSGTEXT,1(R7) JA, TEXT UEBERTRAGEN
         LA    R7,20(R7)     R7 UM DIE LAENGE EINES ELEMENTS ERHOEHEN
         BCT   R6,DEVSCHL    VERZWEIGEN
         EJECT
*
*      PATH-ABFRAGE.
*
         SPACE 2
         TM    12(R9),X'0F'  PATHS BENUTZT ?
         BC    8,LESTCB      NEIN, VERZWEIGEN
         MVC   MSGTEXT(14),PATHZ NACHRICHT UEBERTRAGEN
         LA    R1,15         R1 SETZEN
         IC    R0,12(R9)     FLAG-BYTE LADEN
         NR    R1,R0         PATH-MASKE SETZEN
         SLA   R1,2          R1 ENTHAELT INDEX DER PATH-TABELLE
         LA    R0,PATHTAB-4  ADRESSE DER PATH-TABELLE LADEN
         AR    R1,R0         ADRESSE DES TABELLENELEMENTS LADEN
         MVC   MSGTEXT+5(4),0(R1) TABELLENELEMENT UEBERTRAGEN
         EJECT
*
*      TIOT-VERARBEITUNG.
*
         SPACE 2
LESTCB   EQU   *
         LA    R8,FEHLTCB    ADRESSE DER FEHLERROUTINE LADEN
         L     R6,8(R10)     ADRESSE DES DEB LADEN
         L     R6,0(R6)      ADRESSE DES TCB LADEN
         L     R9,12(R10)    TCB-ADRESSE LADEN
         LA    R6,0(R6)      ERSTES BYTE IN R6 LOESCHEN
         LA    R9,0(R9)      ERSTES BYTE IN R9 LOESCHEN
         CR    R9,R6         ADRESSE = TCB-ADRESSE ?
         BNE   FEHLROUT      NEIN, VERZWEIGEN ZUR FEHLERROUTINE
         SPACE 1
         CR    R4,R9         TCB DES MASTER SCHEDULER ?
         BE    UEBMSCH       JA, VERZW. ZUM UEBERTRAGEN DER NACHRICHT
         SPACE 1
LESTIOT  EQU   *
         L     R9,12(R9)     TIOT-ADRESSE LADEN
         LA    R9,0(R9)      ERSTES BYTE IN R9 LOESCHEN
         LTR   R9,R9         TIOT DES MASTER SCHEDULER ?
         BZ    UEBMSCH       JA, VERZW. ZUM UEBERTRAGEN DER NACHRICHT
         SPACE 1
         MVC   ZWISPEI(8),=CL8' ' ZWISCHENSPEICHER LOESCHEN
         NC    ZWISPEI(8),0(R9) JOBNAME GUELTIG ?
         BZ    FEHLROUT      NEIN, VERZW. ZUR FEHLERROUTINE
         SPACE 1
         MVC   MSGJOBN,0(R9) JOBNAME UEBERTRAGEN
         MVC   ZWISPEI(8),=CL8' ' ZWISCHENSPEICHER LOESCHEN
         NC    ZWISPEI(8),8(R9) STEPNAME GUELTIG ?
         BZ    FEHLROUT      NEIN, VERZW. ZUR FEHLERROUTINE
         SPACE 1
         MVC   MSGSTEPN,8(R9) STEPNAME UEBERTRAGEN
         TM    SCH,X'80'     SCHREIBSCHALTER GESETZT ?
         BC    8,ENDRQE      NEIN, VERZW. ZUM ENDE DER RQE-VERARBEITUNG
         EJECT
*
*      AUSGABE DER NACHRICHT.
*
         SPACE 2
SCHRRQE  EQU   *
         LR    R3,R10        R3 INITIALISIEREN
         L     R0,REG4       ADRESSE DES BILDSCHIRMS LADEN
         WTO   MF=(E,NACHR)  NACHRICHT AUSGEBEN
         SPACE 3
*
*      ENDE DER RQE-VERARBEITUNG.
*
         SPACE 2
ENDRQE   EQU   *
         LA    R10,16(R5,R10) R10 AUF NAECHSTES RQE EINSTELLEN
         B     LESRQE        VERZW. ZUM LESEN DES NAECHSTEN RQE
         SPACE 3
*
*      MASTER-SCHEDULER-NACHRICHT UEBERTRAGEN.
*
         SPACE 2
UEBMSCH  EQU   *
         MVC   MSGJOBN,=C'MASTER  '
         MVC   MSGSTEPN,=C'SCHEDULR'
         LTR   R2,R2         R2 = 0 ?
         BZ    ENDRQE        JA, VERZW. ZUM ENDE DER RQE-VERARBEITUNG
         B     SCHRRQE       VERZW. ZUM AUSGEBEN DER NACHRICHT
         EJECT
***********************************************************************
*                                                                     *
*      ROUTINE FUER VS2, REL2.                                        *
*                                                                     *
***********************************************************************
         SPACE 3
VSSYSTEM EQU   *
         LOAD  EP=FASID            LOAD SUBROUTINE'S ENTRY POINT
         ST    R0,FASIDADR         STORE ADDRESS OF SUBROUTINE
         LA    R2,UCBTAB           ADRESSE UCB-TABELLE
         LA    R0,UCBTABE          ADRESSE UCB TABELLE ENDE
         L     R4,X'7C'(,R10)      ADRESSE I/O COMM. TABLE
         L     R5,X'48'(,R4)       ADRESSE LCH TABLE
         L     R3,X'40'(,R4)       ADRESSE I/O COMM. TABLE EXTENSION
         SR    R6,R6               LOESCHEN R6 FUER IC
         IC    R6,X'05'(,R3)       ANZAHL LCH'S
*
LCHLP    CLC   0(4,R5),=X'FFFFFFFF'  PTR -> IOQE VORHANDEN?
         BE    LCHLPBCT            NEIN - NAECHSTER LCH
*
         LM    R7,R8,0(R5)         ADRESSEN LCHFST, LCHLST LADEN
IOQLP    L     R3,8(,R7)           ADRESSE IOSB
         L     R9,X'10'(,R3)       ADRESSE UCB
         LH    R10,X'06'(,R3)      ASID
*
TABLPA   LA    R1,ABERTAB          ADRESSE DER TABELLE
TABLP    CLI   0(R1),X'FF'         ENDE DER TABELLE?
         BE    TABLPE              JA - NAECHSTES IOQE
         CLI   0(R1),X'80'         GEWUENSCHTE DEVICE-CLASS?
         BNE   TABLPBCT            NEIN - NAECHSTES TAB-ELEMENT
         CLC   18(1,R9),1(R1)      DEV-CLASS (UCB) = DEV-CLASS (TAB)?
         BNE   TABLPBCT            NEIN - NAECHSTES TAB-ELEMENT
         USING UCBTAB,R2
         STM   R9,R10,UCBADDR      UCB-ADRESSE UND ASID SPEICHERN
         LA    R2,UCBNXTEL         ADRESSE SPEICHER ERHOEHEN
         DROP  R2
         CR    R2,R0               ENDE SPEICHER ERREICHT?
         BNL   LCHLPE              JA - AUSGABE EINLEITEN
         B     TABLPE              NAECHSTES IOQE VERARBEITEN
*
TABLPBCT LA    R1,10(,R1)          ADRESSE NAECHSTES TAB-ELEMENT
         B     TABLP               VERZWEIGEN ZUM VERGLEICH
*
IOQLPBCT EQU   *
TABLPE   CR    R7,R8               LETZTES IOQE IN LCH QUEUE?
         BE    LCHLPBCT            JA - NAECHSTEN LCH VERARBEITEN
         L     R7,0(,R7)           ADRESSE NAECHSTES IOQE
         C     R7,=X'FFFFFFFF'     PRUEFEN
         BE    LCHLPBCT                AUF
         LTR   R7,R7                       PLAUSI-
         BZ    LCHLPBCT                        BILITAET
         B     IOQLP               ABARBEITEN DER TAB-ELEMENTE
*
LCHLPBCT LA    R5,32(,R5)          ADRESSE NAECHSTER LCH
         BCT   R6,LCHLP            VERARBEITEN NAECHSTEN LCH
LCHLPE   EQU   *
         LR    R5,R2               ADRESSE LFD. UCB-EL
         LA    R2,UCBTAB           ADRESSE 1. UCB-EL
         USING UCBTAB,R2
         SR    R5,R2               -> ANZAHL UCB-EL * LAENGE
         SR    R4,R4               R4 LOESCHEN FUER DIV
         LA    R0,L'UCBEL          LAENGE EINES UCB-EL
         DR    R4,R0               -> ANZAHL UCB-EL
         LTR   R3,R5               ANZAHL = 0?
         BNP   ABSCHLUS            NEIN - ABSCHLUSS
*
MSGLP    EQU   *
         MVC   NACHR,MSG1         MSG-GERUEST UEBERTRAGEN
         MVC   MSGJOBN,=CL8' '    JOBNAME = BLANKS (FASID)
         LA    R6,ASID            ADRESSE ASID
         LA    R7,MSGJOBN         ADRESSE JOBNAME
         LA    R8,MSGSTEPN        ADRESSE STEPNAME
         STM   R6,R8,PARMLIST     ADRESSEN SPEICHERN
         OI    PARMLIST+8,X'80'   KENNZEICHNEN LETZTEN PARAMETER
         LA    R1,PARMLIST        LADEN ADRESSE PARAMETER-LISTE
         L     R15,FASIDADR       LOAD ENTRY POINT OF SUBR.
         BALR  R14,R15            LINK TO SUBROUTINE
         L     R9,UCBADDR         UCB-ADDR LADEN
         MVC   MSGUNITN,13(R9)    UNIT-NAMEN UEBERTRAGEN
         LA    R7,DEVFLAG         ADRESSE DER TABELLE
         LA    R6,4               ZAEHLER
FLGLP    MVC   ZWISPEI(1),6(R9)
         NC    ZWISPEI(1),0(R7)   ENTSPRECHENDES BIT GESETZT?
         BZ    *+10               NEIN -
         MVC   MSGTEXT,1(R7)      JA - TEXT UEBERTRAGEN
         LA    R7,20(,R7)         ADRESSE ERHOEHEN
         BCT   R6,FLGLP           BCT
*
         CLI   18(R9),X'80'       TAPE DEVICE?
         BNE   NOMOUNT            NEIN -
         CLC   28(6,R9),=XL6'00'  VOLSER-NR EINGETRAGEN?
         BNE   NOMOUNT            JA -
* MOUNT-MSG SUCHEN
         MODESET KEY=ZERO         FETCH PROTECTION 0C4 AUSSCHLIESSEN
         L     R6,X'10'           R6 = CVTPTR
         L     R6,X'64'(,R6)      R6 = PTR -> UCM-BASE
         L     R1,X'18'(,R6)      R1 = PTR -> FIRST WQE
         LTR   R1,R1              LAST WQE?
         BNP   UCMLPA             JA -
WQELP    CLC   X'A9'(3,R1),36(R9) MSG-ID'S GLEICH?
         BE    MOUNTMSG           JA -
         CLC   X'01'(3,R1),=XL3'00'  LAST WQE?
         BE    UCMLPA             JA -
         L     R1,X'00'(,R1)      ADRESSE NAECHSTES WQE
         B     WQELP
MOUNTMSG MVC   MSGTEXT2-9(13),X'27'(R1)  UEBERTRAGEN MSG-TEXT
         B     NOALTPTH
UCMLPA   L     R8,X'50'(,R6)      ADRESSE LETZTE UCM ENTRY
         L     R4,X'4C'(,R6)      LAENGE EINER UCM ENTRY
         L     R6,X'48'(,R6)      ADRESSE ERSTE UCM ENTRY
UCMLP    CR    R6,R8              VERGLEICHEN MIT ADRESSE LETZTE ENTRY
         BH    NOMOUNT            BEI >: NICHT GEFUNDEN
         L     R7,X'1C'(,R6)      ADRESSE DCM
         LTR   R7,R7              GRAPHICS?
         BZ    UCMLPE             NEIN - NAECHSTER UCM-ENTRY
         L     R7,X'00'(,R7)      ADRESSE PAGEABLE DCM
         LTR   R7,R7              VORHANDEN?
         BZ    UCMLPE             NEIN - NAECHSTER UCM-ENTRY
         LH    R0,X'FE'(,R7)      NUMBER OF LINES IN MSG AREA
         L     R14,X'20'(,R7)     ADDRESS OF FIRST DOM NUMBER
DOMLP    CLC   5(3,R14),36(R9)    MSG-ID'S GLEICH?
         BE    LINEGEF            JA - TEXT AUSGEBEN
         LA    R14,8(,R14)        NAECHSTE DOM-NUMBER
         BCT   R0,DOMLP           BCT
         B     UCMLPE             NAECHSTE UCM-ENTRY
LINEGEF  LH    R15,X'FE'(,R7)     NUMBER OF LINES IN MSG AREA
         SR    R15,R0             -> INDEX DER ZEILE
         MH    R15,X'104'(,R7)    * LAENGE EINER ZEILE
         L     R1,X'30'(,R7)      ADRESSE DER 1. ZEILE
         AR    R1,R15             -> ADRESSE DER MSG
         LA    R0,25              BCT-COUNT
LINELP   CLC   0(2,R1),=C'*I'     TEXT = '*I(EF233A M XXX,)'?
         BE    MSGGEF             JA - RICHTIGE SPALTE ERWISCHT
         LA    R1,1(,R1)          ADRESSE NAECHSTE SPALTE
         BCT   R0,LINELP          BCT
         B     NOMOUNT            TEXT NICHT GEFUNDEN
MSGGEF   MVC   MSGTEXT2-9(13),8(R1)  TEXT UEBERTRAGEN
         B     NOALTPTH           UND AUSGEBEN
UCMLPE   AR    R6,R4              ADRESSE NAECHSTE UCM ENTRY
         B     UCMLP
NOMOUNT  EQU   *
         TM    1(R9),X'01'        ALT PATH VORHANDEN?
         BZ    NOALTPTH           NEIN - TEXT AUSLASSEN
         BAL   R14,TESTPATH       PATH'S + CPU VORHANDEN?
         MVC   MSGTEXT(14),PATHZ TEXT UEBERTRAGEN
         MVC   MSGTEXT+14(5),=CL8' '
         SR    R8,R8              R8 LOESCHEN FUER IC
         IC    R8,8(,R9)          PATH-BITS HOLEN
         SRL   R8,4               4 NACH RECHTS,
         SLL   R8,2               UND 2 NACH LINKS SHIFTEN
         LA    R8,PATHTAB-4(R8)   ADRESSE DES PATH-TEXTS LADEN
         MVC   MSGTEXT+5(4),0(R8)   UND UEBERTRAGEN
NOALTPTH L     R0,REG4            KONSOL-ID
         WTO   MF=(E,NACHR)       WTO
         LA    R2,UCBNXTEL        NAECHSTES UCB-EL
         BCT   R5,MSGLP               VERARBEITEN
         DROP  R2
         MODESET KEY=NZERO        ALTEN PSW-KEY EINSETZEN
         B     ABSCHLUS           ENDE
         EJECT
***********************************************************************
*                                                                     *
*      FEHLERROUTINEN.                                                *
*                                                                     *
***********************************************************************
         SPACE 3
FEHLROUT EQU   *
         CH    R2,=H'08'     TEST UND AUSGABE DER NACHRICHTEN ?
         BNE   ENDRQE        NEIN, VERZW. ZUM ENDE DER RQE-VERARBEITUNG
         BR    R8            JA, VERZW. ZUR ENTSPR. FEHLERROUTINE
         SPACE 3
*
*      ROUTINE BEI ADRESSIERUNGSFEHLER DES UCB.
*
*
         SPACE 2
FEHLUCB  EQU   *
         MVC   NACHR,MSG4    NACHRICHT UEBERTRAGEN
         B     MOVERQE
         SPACE 3
*
*      ROUTINE BEI ADRESSIERUNGSFEHLER DES TCB.
*
         SPACE 2
FEHLTCB  EQU   *
         MVC   NACHR,MSG5    NACHRICHT UEBERTRAGEN
         SPACE 1
MOVERQE  EQU   *
         ST    R10,ZWISPEI
         UNPK  ZWISPEI+1(7),ZWISPEI+1(4)
         ST    R2,SAVE1R2
         TR    ZWISPEI+1(6),CCTAB-240
         L     R2,SAVE1R2
         MVC   MSGRQE,ZWISPEI+1
         B     SCHRRQE       VERZW. ZUR AUSGABE DER NACHRICHT
         EJECT
*
*      ROUTINE BEI UNGUELTIGER DEVICE-KLASSE.
*
         SPACE 2
FEHLCLS  EQU   *
         MVC   NACHR,MSG6    NACHRICHT UEBERTRAGEN
         UNPK  ZWISPEI(3),18(2,R9)
         ST    R2,SAVE1R2
         TR    ZWISPEI(2),CCTAB-240
         L     R2,SAVE1R2
         MVC   MSGCLS,ZWISPEI DEVICE-KLASSE UEBERTRAGEN
         B     SCHRRQE       VERZW. ZUR AUSGABE DER NACHRICHT
         SPACE 3
*
*      ROUTINE BEI FALSCHEM PARAMETER.
*
         SPACE 2
FEHLPARM EQU   *
         MVC   NACHR,MSG3    NACHRICHT UEBERTRAGEN
         L     R0,REG4       ADRESSE DES BILDSCHIRMS LADEN
         WTO   MF=(E,NACHR)  NACHRICHT AUSGEBEN
         B     ENDE          VERZW. ZUM VERARBEITUNGSENDE
         EJECT
***********************************************************************
*                                                                     *
*      ABSCHLUSS-ROUTINE.                                             *
*                                                                     *
***********************************************************************
         SPACE 3
ABSCHLUS EQU   *
         LTR   R3,R3         R3 = 0 ?
         BNZ   END           NEIN, VERZW. ZUM VERARBEITUNGSENDE
         SPACE 1
         L     R0,REG4       ADRESSE DES BILDSCHIRMS LADEN
         MVC   NACHR,MSG2    NACHRICHT UEBERTRAGEN
         WTO   MF=(E,NACHR)  NACHRICHT AUSGEBEN
         B     ENDE          VERZW. ZUM VERARBEITUNGSENDE
         SPACE 1
END      EQU   *
         MVC   NACHR,MSG7    NACHRICHT UEBERTRAGEN
         L     R0,REG4       ADRESSE DES BILDSCHIRMS LADEN
         WTO   MF=(E,NACHR)  NACHRICHT AUSGEBEN
         EJECT
*
*      REGISTER LADEN UND SPEICHERPLATZFREIGABE.
*
         SPACE 2
ENDE     EQU   *
         XRETURN ,R
         EJECT
TESTPATH EQU   *
         ST    R3,SAVE1R3
         L     R3,16         CVT
         L     R3,764(R3)    PCCAVT
         LTR   R3,R3         AVAILABLE ?
         BZ    ENDTPATH      BRANCH IF NOT
         MVI   CPUBYTE,X'00'
         CLC   0(4,R3),=XL6'0' CPU 0 ?
         BE    *+8
         OI    CPUBYTE,X'F0'
         CLC   4(4,R3),=XL6'0' CPU 1 ?
         BE    *+8
         OI    CPUBYTE,X'0F'
         TM    8(R9),X'C0'   PATHS FOR CPU 0 ?
         BNZ   *+8           BRANCH IF NO
         NI    CPUBYTE,X'0F'
         TM    8(R9),X'30'   PATHS FOR CPU 1 ?
         BNZ   ENDTPATH      BRANCH IF NO
         NI    CPUBYTE,X'F0'
ENDTPATH EQU   *
         L     R3,SAVE1R3
         TM    CPUBYTE,X'FF' MISSING PATHS FOR EXISTING CPU(S) ?
         BZ    NOALTPTH      BRANCH IF NOT
         BR    R14
         EJECT
***********************************************************************
*                                                                     *
*      DATA DIVISION.                                                 *
*                                                                     *
***********************************************************************
         SPACE 3
*
*      EQUATES.
*
         SPACE 2
R0       EQU   0             ENTHAELT BEI WTO ADRESSE DES BILDSCHIRMS
R1       EQU   1
R2       EQU   2             SCHALTER F. AUSGABE VON FEHLERNACHRICHTEN
R3       EQU   3             ANZEIGE AUF RQE
R4       EQU   4             ZEIGT AUF I/O-DEVICE-STATISTIC-TABLE
R5       EQU   5             INDEXREG.: 0 BEI MVT, 4 BEI VS
R6       EQU   6             INDEX FUER PARAMETERKETTE
R7       EQU   7             TABELLENINDEX
R8       EQU   8             ENTHAELT ADR. DER FEHLERROUTINEN
R9       EQU   9             ZEIGT AUF UCB, BZW. TCB-TIOT
R10      EQU   10            INDEX FUER RQE-TABELLE
R11      EQU   11            BASIS FUER PARAMETERBEREICH
R12      EQU   12            BASISREG. FUER CSECT TESTRQE
R13      EQU   13            BASIS FUER ARBEITSBEREICHE
R14      EQU   14
R15      EQU   15
         EJECT
*
*      TABELLEN.
*
         SPACE 2
CCTAB    DC    C'0123456789ABCDEF'
         SPACE 3
DEVSTATA DS    0CL20
         DC    X'80',CL19'OFFLINE'
         DC    X'02',CL19'SYSRES'
         DC    X'02',CL19'CONSOLE'
         DC    X'10',CL19'UNLOAD PENDING'
         DC    X'40',CL19'OFFLINE PENDING'
DEVFLAG  DS    0CL20
         DC    X'40',CL19'NOT READY'
         DC    X'08',CL19'CONTROL UNIT BUSY '
         DC    X'01',CL19'I/O RECOVERY ACTIVE'
*
         DC    X'04',CL19'DEVICE RESERVED'
         SPACE 3
DEVTAB   DS    0CL10
         DC    X'0080',CL8'TAPE'
         DC    X'0020',CL8'DASD'
         DC    X'0008',CL8'UR'
         DC    X'0040',CL8'TP'
         DC    X'0010',CL8'GRAPHIC'
         DC    X'FFFF',CL8' '
         DC    X'0000',CL8' '
         DC    X'0000',CL8' '
         DC    X'0000',CL8' '
         SPACE 3
PATHZ    DC    CL14'PATH .... INOP'
PATHTAB  DS    0CL4
         DC    C'...1'
         DC    C'..1.'
         DC    C'..11'
         DC    C'.1..'
         DC    C'.1.1'
         DC    C'.11.'
         DC    C'.111'
         DC    C'1...'
         DC    C'1..1'
         DC    C'1.1.'
         DC    C'1.11'
         DC    C'11..'
         DC    C'11.1'
         DC    C'111.'
         DC    C'1111'
         EJECT
*
*      NACHRICHTEN.
*
         SPACE 2
MSG1     WTO   'XRQE001 JJJJJJJJ SSSSSSSS  UNIT=999                    *
                               ',                                      *
               MCSFLAG=(REG0),MF=L
MSG2     WTO   'XRQE002 NO OPEN REQUEST ELEMENTS',                     *
               MCSFLAG=(REG0),MF=L
MSG3     WTO   'XRQE003 ERROR IN PARAMETER LIST',                      *
               MCSFLAG=(REG0),MF=L
MSG4     WTO   'XRQE004 UCB-ADDRESS INVALID..........RQE-ADDR=999999', *
               MCSFLAG=(REG0),MF=L
         EJECT
MSG5     WTO   'XRQE005 TCB-ADDRESS INVALID..........RQE-ADDR=999999', *
               MCSFLAG=(REG0),MF=L
MSG6     WTO   'XRQE006 UCBTYPE INVALID..............UCBTYPE=99',      *
               MCSFLAG=(REG0),MF=L
MSG7     WTO   'XRQE007 END OF OPEN REQUEST ELEMENTS',                 *
               MCSFLAG=(REG0),MF=L
MSG8     WTO   'XRQE008 FUNCTION NOT SUPPORTED FOR OS/VS2 (MVS)',      *
               MCSFLAG=(REG0),MF=L
         EJECT
*
*      PARAMETERBEREICH.
*
         SPACE 2
         XPARM
         SPACE 3
*
*      ARBEITSBEREICHE.
*
         SPACE 2
ABER     DSECT
SAVEAREA DS    18F
ZWISPEI  DS    2F            ZWISCHENSPEICHER
SAVE1R2  DS    F             SAVEAREA1 FUER R2
SAVE1R3  DS    F             SAVEAREA1 FUER R3
FASIDADR DS    F             ENTRY POINT ADRESS OF SUBROUTINE
NACHR    DS    0CL75         BEREICH FUER NACHRICHTEN
         DS    CL12
MSGJOBN  DS    CL8           JOBNAME
         DS    C
MSGSTEPN DS    CL8           STEPNAME
         DS    CL7
MSGUNITN DS    CL3           UNIT-NAME
         DS    CL2
MSGTEXT  DS    CL19          TEXT UEBER DEVICE-STATUS
         DS    C
MSGTEXT2 DS    CL14
         ORG   NACHR+50
MSGRQE   DS    CL6           RQE-ADRESSE
         ORG   NACHR+49
MSGCLS   DS    CL2
         ORG   NACHR+75
SCH      DS    C             PRUEF- UND SCHREIBSCHALTER
CPUBYTE  DS    C             PRUEF-SCHALTER
ABERTAB  DS    CL90
*
PARMLIST DS    3F            PARAMETER-LISTE FUER FASID
*
UCBTAB   DS    0D            DWB-ALIGN
ANZUCBEL EQU   99
*
UCBEL    DS    0CL8
UCBADDR  DS    F
RESERVE  DS    H
ASID     DS    H
*
UCBNXTEL DS    0C
         DS    (ANZUCBEL-1)CL(L'UCBEL)
UCBTABE  EQU   *
*
ABERL    EQU   *-ABER        LAENGE DES ARBEITSBEREICHS
         SPACE 3
         END   RQE
./ ADD  NAME=SCANTCB
         MACRO
         SCANTCB &NOSYM
*
*   SCAN TCB SUBTASK CHAIN SUBROUTINE
*
* INPUT  R0    MAIN TCB ADDR
*        R1    ADDR OF TCB HAVING BEEN PROCESSED (ZERO AT INIT ENTRY)
* OUTPUT R1    ADDR OF TCB TO BE PROCESSED NEXT
*        R2    CONTENTS DESTROYED
* EXIT   B     4(0,14) TO PROCESS TCB
*        B     0(0,14) NO MORE TCB'S
*
         AIF   ('&NOSYM' EQ 'NOSYM').NOSYM
* TCB FIELD OFFSETS
TCB      EQU   0                       FOR COMPATIBILITY WITH 'TCB' MAC
TCBNTC   EQU   X'80'                   NEXT TCB ON SAME LEVEL
TCBOTC   EQU   X'84'                   ORIGINATING TCB
TCBLTC   EQU   X'88'                   LAST SUBTASK TCB
*
.NOSYM   ANOP
         AIF   ('&SYSECT' EQ 'SCANTCB').NONAME
SCANTCB  DS    0H
.NONAME  ANOP
         LTR   R1,R1                   CHECK INPUT REG FOR TCB ADDR
         BNZ   SCANTCBT
* INITIAL ENTRY
         LR    R1,R0                   DUPLICATE INPUT REG
         LA    R1,0(0,R1)              ZERO HIGH ORDER BYTE
         LR    R0,R1                   RESTORE INPUT TCB ADDR
SCANTCBL EQU   *
         L     R2,TCBLTC-TCB(0,R1)     LOAD AND
         LA    R2,0(0,R2)              ZERO HIGH ORDER BYTE
         LTR   R2,R2                   CHECK LTC POINTER
         BZ    SCANTCBP                NO SUBTASK, PROCESS
SCANTCBC EQU   *
         LR    R1,R2                   RELOAD REG
         B     SCANTCBL                GO TEST LTC
* SECONDARY ENTRY
SCANTCBT EQU   *
         CLR   R1,R0                   MAIN TCB PROCESSED
         BE    0(0,R14)                YES, TAKE ALL-DONE-EXIT
         L     R2,TCBNTC-TCB(0,R1)     GET NTC PTR
         LA    R2,0(0,R2)              ZERO HIGH ORDER BYTE
         LTR   R2,R2                   MORE TASKS ON THIS LEVEL
         BNZ   SCANTCBC                GO TEST SUBTASKS
         L     R1,TCBOTC-TCB(0,R1)     GET ORIGINATING TASK
SCANTCBP EQU   *
         LA    R1,0(0,R1)              ZERO HIGH ORDER BYTE
         B     4(0,R14)                BRANCH TO PROCESS
         MEND
./ ADD  NAME=SCR
SCR      CSECT
         REG
         XSAVE R12,,SCR,WORKL
         LR    R11,R1
         USING WORK,R13
         USING PARMAREA,R11
         MVC   OVRLIST,OVRLISTS
         MVC   EXPLIST,EXPLISTS
         LA    R2,DSNAME
         ST    R2,OVRLIST+4
         ST    R2,EXPLIST+4
         LA    R2,VOLNO
         ST    R2,OVRLIST+12
         ST    R2,EXPLIST+12
         MVC   SEQNO,=C'0001'
         MVI   DSNAME,C' '
         MVC   DSNAME+1(43),DSNAME
         MVI   UNIT,C' '
         MVC   UNIT+1(5),UNIT
         XC    VOLNO,VOLNO
         MVI   FLAG,X'00'
         LA    R8,TEXT+4
         LA    R3,100
         LR    R4,R8
         LA    R5,100(R8)
DSN1     EQU   *
         CLC   0(2,R4),=CL2'D='
         BNE   DSN3
         LA    R4,2(R4)
         B     DSN5
DSN3     EQU   *
         LA    R4,1(R4)
         BCT   R3,DSN1
         MVC   WTO(LENMSG01),MSG01
GIVEWTO  EQU   *
         L     R0,REG4
         WTO   MF=(E,WTO)
         B     RETURN
DSN5     EQU   *
         LR    R7,R5
         SR    R7,R4
         EX    R7,TCOMMA
         BNZ   DSN6
         LA    R1,1(R5)
DSN6     EQU   *
         SR    R1,R4
         BCTR  R1,0
         LTR   R1,R1
         BNM   DSN8
DELERROR EQU   *
         MVC   WTO(LENMSG02),MSG02
         B     GIVEWTO
DSN8     EQU   *
         EX    R1,MOVEDSN
         LR    R4,R8
         LA    R3,100
UNIT1    EQU   *
         CLC   0(2,R4),=CL2'U='
         BE    UNIT2
         LA    R4,1(R4)
         BCT   R3,UNIT1
         MVC   WTO(LENMSG01),MSG01
         MVC   WTO+40(2),=CL2'U='
         B     GIVEWTO
UNIT2    EQU   *
         LA    R4,2(R4)
         LR    R7,R5
         SR    R7,R4
         EX    R7,TCOMMA
         BNZ   UNIT5
         LA    R1,1(R5)
UNIT5    EQU   *
         SR    R1,R4
         BCTR  R1,0
         LTR   R1,R1
         BM    DELERROR
         EX    R1,MOVEUNT
         CLC   UNIT(2),=CL2'24'
         BE    XXX
         CLC   UNIT(2),=CL2'34'
         BE    XXX
         CLC   UNIT(4),=C'TAPE'
         BNE   SEQ7
XXX      EQU   *
         LR    R4,R8
         LA    R3,100
SEQ1     EQU   *
         CLC   0(2,R4),=CL2'S='
         BE    SEQ2
         LA    R4,1(R4)
         BCT   R3,SEQ1
         B     VOL1
SEQ7     EQU   *
         MVI   SEQNO+3,C'0'
         B     VOL1
SEQ2     EQU   *
         LA    R4,2(R4)
         LR    R7,R5
         SR    R7,R4
         EX    R7,TCOMMA
         BNZ   SEQ5
         LA    R1,1(R5)
SEQ5     EQU   *
         SR    R1,R4
         BCTR  R1,0
         LTR   R1,R1
         BM    DELERROR
         EX    R1,TNUM
         BZ    SEQ6
         MVC   WTO(LENMSG01),MSG01
         MVC   WTO+40(2),=CL2'S='
         B     GIVEWTO
SEQ6     EQU   *
         LA    R9,SEQNO+3
         SR    R9,R1
         EX    R1,MOVESEQ
VOL1     EQU   *
         LR    R4,R8
         LA    R3,100
SEEKPRG  EQU   *
         CLC   0(6,R4),=C',PURGE'
         BE    FOUNDPRG
         LA    R4,1(R4)
         BCT   R3,SEEKPRG
         B     SEEKS
FOUNDPRG EQU   *
         OI    FLAG,X'80'
SEEKS    EQU   *
         LR    R4,R8
         LA    R3,100
VOL2     EQU   *
         CLC   0(2,R4),=CL2'V='
         BE    VOL3
         LA    R4,1(R4)
         BCT   R3,VOL2
         MVC   WTO(LENMSG01),MSG01
         MVC   WTO+40(2),=CL2'V='
         B     GIVEWTO
VOL3     EQU   *
         LA    R4,2(R4)
         LA    R8,DEVTAB
         LA    R6,11
         LA    R7,DEVEND-11
VOL6     EQU   *
         CLC   4(6,R8),UNIT
         BE    VOL7
         BXLE  R8,R6,VOL6
         MVC   WTO(LENMSG03),MSG03
         B     GIVEWTO
VOL7     EQU   *
         LH    R2,VOLNO
         LA    R9,VOLIST
         LA    R3,VOLIST+240
         CLI   0(R4),C'('
         BE    VOL11
         LR    R7,R5
         SR    R7,R4
         ST    R2,ALIST
         EX    R7,TCOMMA
         L     R2,ALIST
         BNZ   VOL8
         LA    R1,1(R5)
VOL8     EQU   *
         SR    R1,R4
         CH    R1,=H'6'
         BNH   VOL9
         MVC   WTO(LENMSG04),MSG04
         B     GIVEWTO
VOL9     EQU   *
         MVC   0(4,R9),0(R8)
         BCTR  R1,0
         MVI   4(R9),X'40'
         MVC   5(5,R9),4(R9)
         EX    R1,MOVESER
         PACK  D,SEQNO
         CVB   R1,D
         STH   R1,10(R9)
         LA    R2,1(R2)
VOL10    EQU   *
         STH   R2,VOLNO
         B     ENDRT2
VOL11    EQU   *
         PACK  D,SEQNO
         CVB   R1,D
VOL12    EQU   *
         LA    R4,1(R4)
         STM   R1,R2,WTO
         LR    R7,R5
         SR    R7,R4
         EX    R7,TKLAM
         BZ    DELERROR
         SR    R1,R4
         LR    R6,R1
         LM    R1,R2,WTO
         BCTR  R6,0
         MVI   4(R9),X'40'
         MVC   5(5,R9),4(R9)
         EX    R6,MOVESER
         MVC   0(4,R9),0(R8)
         LA    R4,1(R6,R4)
         STH   R1,10(R9)
         LA    R2,1(R2)
         CLI   0(R4),C')'
         BE    VOL10
         LA    R9,12(R9)
         CR    R9,R3
         BL    VOL12
         MVC   WTO(LENMSG05),MSG05
         B     GIVEWTO
ENDRT2   EQU   *
         SR    R0,R0
         TM    FLAG,X'80'
         BO    SCROVR
         SCRATCH EXPLIST
         B     ERRTEST
SCROVR   EQU   *
         SCRATCH OVRLIST
ERRTEST  EQU   *
         LH    R5,VOLNO
         LA    R6,VOLIST
         LA    R7,12
TEST2    EQU   *
         SR    R10,R10
         IC    R10,11(R6)
         SLA   R10,3
         LA    R9,ERRTAB
         AR    R10,R9
         L     R9,0(R10)
         L     R10,4(R10)
         BCTR  R10,0
         EX    R10,MVCWTO
         L     R0,REG4
         WTO   MF=(E,WTO)
         AR    R6,R7
         BCT   R5,TEST2
RETURN   EQU   *
         XRETURN ,R
ERRTAB   DS    0F
         DC    A(MSG06),A(LENMSG06)
         DC    A(MSG07),A(LENMSG07)
         DC    A(MSG11),A(LENMSG11)
         DC    A(MSG08),A(LENMSG08)
         DC    A(MSG09),A(LENMSG09)
         DC    A(MSG10),A(LENMSG10)
         DC    A(MSG10),A(LENMSG10)
         DC    A(MSG12),A(LENMSG12)
OVRLISTS CAMLST SCRATCH,DEVTAB,,DEVTAB,,OVRD
EXPLISTS CAMLST SCRATCH,DEVTAB,,DEVTAB
TKLAM    TRT   0(0,R4),TTAB
TTAB     DC    93X'00',X'FF',13X'00',X'FF',148X'00'
TCOMMA   TRT   0(0,R4),TRTTAB
TRTTAB   DC    64X'00',X'FF',42X'00',X'FF',148X'00'
MOVEDSN  MVC   DSNAME(0),0(R4)
MOVEUNT  MVC   UNIT(0),0(R4)
TNUM     TRT   0(0,R4),NUMTAB
NUMTAB   DC    240X'FF',10X'00',6X'FF'
MOVESEQ  MVC   0(0,R9),0(R4)
MOVESER  MVC   4(0,R9),0(R4)
MVCWTO   MVC   WTO(0),0(R9)
DEVTAB   DC    X'30008001'
         DC    C'2400  4'
         DC    X'30808001'
         DC    C'2400-16'
         DC    X'30C08001'
         DC    C'2400-26'
         DC    X'34008001'
         DC    C'2400-36'
         DC    X'34208001'
         DC    C'2400-46'
         DC    X'34008003'
         DC    C'3400-36'
         DC    X'34008003'
         DC    C'TAPE  4'
         DC    X'34008003'
         DC    C'BAND  4'
         DC    X'30002001'
         DC    C'2311  4'
         DC    X'30402002'
         DC    C'2301  4'
         DC    X'30002004'
         DC    C'2302  4'
         DC    X'30002003'
         DC    C'2303  4'
         DC    X'30C02008'
         DC    C'2314  4'
         DC    X'30002005'
         DC    C'2321  4'
         DC    X'30702007'
         DC    C'2305-26'
         DC    X'30702007'
         DC    C'DRUM  4'
         DC    X'30702006'
         DC    C'2305-16'
         DC    X'30502009'
         DC    C'3330  4'
         DC    X'30502009'
         DC    C'DISK  4'
         DC    X'3050200A'
         DC    C'3340  4'
         DC    X'3050200D'
         DC    C'3330  4'
DEVEND   EQU   *
MSG01    WTO   'XSCR000 INVALID OR MISSING KEYWORD: D=.',MCSFLAG=REG0, *
               MF=L
LENMSG01 EQU   *-MSG01
MSG02    WTO   'XSCR001 DELIMITER ERROR',MCSFLAG=REG0,MF=L
LENMSG02 EQU   *-MSG02
MSG03    WTO   'XSCR002 INVALID UNIT NAME',MCSFLAG=REG0,MF=L
LENMSG03 EQU   *-MSG03
MSG04    WTO   'XSCR003 INVALID VOLSER',MCSFLAG=REG0,MF=L
LENMSG04 EQU   *-MSG04
MSG05    WTO   'XSCR004 MORE THAN 20 VOLSERS',MCSFLAG=REG0,            *
               MF=L
LENMSG05 EQU   *-MSG05
MSG06    WTO   'XSCR005 SPECIFIED DATA SET HAS BEEN SCRATCHED',MF=L,   *
               MCSFLAG=REG0
LENMSG06 EQU   *-MSG06
MSG07    WTO   'XSCR005 DSCB NOT FOUND',MF=L,MCSFLAG=REG0
LENMSG07 EQU   *-MSG07
MSG08    WTO   'XSCR005 RETENTION PERIOD HAS NOT EXPIRED',MF=L,        *
               MCSFLAG=REG0
LENMSG08 EQU   *-MSG08
MSG09    WTO   'XSCR005 PERM. I/O ERROR',MF=L,MCSFLAG=REG0
LENMSG09 EQU   *-MSG09
MSG10    WTO   'XSCR005 UNABLE TO MOUNT VOLUME',MF=L,MCSFLAG=REG0
LENMSG10 EQU   *-MSG10
MSG11    WTO   'XSCR005 DATA SET HAS NOT BEEN DELETED',                *
               MF=L,MCSFLAG=REG0
LENMSG11 EQU   *-MSG11
MSG12    WTO   'XSCR005 DATA SET IN USE',                              *
               MF=L,MCSFLAG=REG0
LENMSG12 EQU   *-MSG12
         LTORG
         XPARM
WORK     DSECT
SVA      DS    18F
WTO      DS    CL108
         DS    0F
OVRLIST  DS    CL16
EXPLIST  DS    CL16
DSNAME   DS    CL44
         CNOP  2,4
VOLNO    DS    H
VOLIST   DS    20CL12
SEQNO    DS    CL4
UNIT     DS    CL6
D        DS    D
ALIST    DS    F
FLAG     DS    X
WORKL    EQU   *-WORK
         END
./ ADD  NAME=SHOW
         TITLE 'XSHOW                             X-COMMAND SHOW'
SHOW     CSECT
         SPACE 3
***********************************************************************
*                                                                     *
*      PROGRAM-ID. SHOW.                                              *
*      AUTHOR. EHNERT.                                                *
*      INSTALLATION. BAYER AG, LEVERKUSEN, RECHENZENTRUM.             *
*      DATE-WRITTEN. 24. 2. 1975.                                     *
*      REMARKS.                                                       *
*                                                                     *
*          DAS X-COMMAND 'SHOW' GIBT INFORMATIONEN UEBER DIE          *
*          DATEIEN AUS, DEREN NAMEN AUF INDEXEBENE ODER VOLL-         *
*          STAENDIG SPEZIFIEZIERT WURDEN ODER DIE RACF-,              *
*          PASSWORD- ODER NOPWREAD-GESCHUETZT SIND.                   *
*                                                                     *
*          ZUSAETZLICH KOENNEN FOLGENDE PARAMETER ANGEGEBEN WERDEN:   *
*          A) MSG: AUSGABE VON INFORMATIONEN UEBER SPEICHERPLATZ-     *
*             ANFORDERUNG UND -BELEGUNG SOWIE UEBER DIE DCB'S DER     *
*             DATEIEN,                                                *
*          B) EXT: AUSGABE VON INFORMATIONEN UEBER DIE EINZELNEN      *
*             SPEICHERPLATZ-AUSDEHNUNGEN (EXTENTS),                   *
*          C) DATE: AUSGABE VON INFORMATIONEN UEBER ERSTELL- UND      *
*             FALLDATUM DER DATEIEN,                                  *
*          D) CAT: AUSGABE VON KATALOG-INFORMATIONEN,                 *
*          E) BIS ZU ZEHN MASKEN FUER DIE VOLUME SERIAL NUMBERS,      *
*             MIT DEREN HILFE EINE AUSWAHL DER VOLUMES GETROFFEN      *
*             WERDEN KANN, DABEI STEHT '*' FUER JEDES ZEICHEN AN      *
*             DIESER STELLE.                                          *
*                                                                     *
*          WIRD KEINER DER PARAMETER A) BIS D) ANGEGEBEN, SO          *
*          GELTEN STANDARDMAESSIG 'MSG' UND 'CAT'. WERDEN KEINE       *
*          VOLSER-MASKEN SPEZIFIZIERT, SO WERDEN ALLE ONLINE          *
*          LIBRARIES NACH DEN DATEIEN DURCHSUCHT.                     *
*                                                                     *
***********************************************************************
         EJECT
***********************************************************************
*                                                                     *
*      INITIAL PROCESSING.                                            *
*                                                                     *
***********************************************************************
         SPACE 3
*
*      SAVE REGISTER CONTENTS,
*      GET MAIN STORAGE FOR WORK AREAS,
*      ALLOCATE BASE REGISTERS.
*
         SPACE 1
         XSAVE R11,,SHOW,WORKLEN
         SPACE 1
         USING UCB,R03                 ALLOC. BASE REG. OF UCB
         USING PARMAREA,R09            ALLOC. BASE REG. OF PARMAREA
         LR    R09,R01                 INIT. BASE REG. OF PARMAREA
         USING MESSAGE,R10             ALLOC. BASE REG. OF MESSAGE
         USING SHOW,R11,R12            ALLOC. BASE REG. OF CSECT
         LA    R12,2048(,R11)          INITIALIZE
         LA    R12,2048(,R12)              UPPER BASE REGISTER
         USING WORKAREA,R13            ALLOC. BASE REG. OF WORKAREA
         EJECT
*
*      INITIALIZE WORK AREAS.
*
         SPACE 1
         XC    CAMSEEK(48),CAMSEEK     CLEAR MACRO WORK AREAS
         MVI   CAMSEEK,X'C0'           SET FLAG BYTE
         MVI   CAMSEEK+1,X'80'         SET FLAG BYTE
         MVI   CAMSRCH,X'C1'           SET FLAG BYTE
         MVI   CAMNAME,X'44'           SET FLAG BYTE
         MVI   FLG1BYTE,FLG1INIT       INITIALIZE FLAG BYTE
         MVI   FLG2BYTE,FLG2INIT       INITIALIZE FLAG BYTE
         XC    LINECNT,LINECNT         ZERO OUTPUT LINE COUNT
         MVC   WTOR(MSG13LEN),MSG13    MOVE WTOR LINE
         LA    R02,CCHHR               LOAD ADDRESS OF CCHHR AREA
         LA    R03,VOLSERNO            LOAD ADDRESS OF VOLSER AREA
         LA    R04,OBTWKFLD            LOAD ADDRESS OF OBTWKFLD
         STM   R02,R04,CADRCCHH        STORE ADDRESSES IN CAMSEEK
         LA    R02,DSNAME              LOAD ADDRESS OF DSNAME
         LA    R04,OBTWKFLD+44         LOAD ADDRESS OF OBTWKFLD+44
         STM   R02,R04,CADRDSN         STORE ADDRESSES IN CAMSRCH
         SR    R03,R03                 ZERO REGISTER
         LA    R04,LOCWKFLD            LOAD ADDRESS OF LOCWKFLD
         STM   R02,R04,CAMDSN          STORE ADDRESSES IN CAMNAME
         LA    R02,ENDTAB1             LOAD
         LA    R03,ENDTAB2                 END ADDRESSES
         LA    R04,ENDTAB3                 OF TABLES
         LA    R05,ENDTPVOL                AND
         STM   R02,R05,ADDRETB1            STORE THEM
         MVC   UCMID,REG4              MOVE UCM-ID.
         SPACE 2
*
*      SET FLAG BYTES IN MESSAGE AREAS.
*
         SPACE 1
         LA    R02,MSGTAB              LOAD ADDRESSES OF
         LA    R03,EXTNTAB                 MESSAGE AREAS
         LA    R04,DATETAB                 AND
         STM   R02,R04,SAVE1R10            STORE THEM
         LA    R04,MSGTAB              LOAD ADDRESS OF
         LA    R06,MSGTAB+1                MESSAGE AREAS
         LA    R07,ERRORTAB-MSGTAB-1   LOAD LENGTH OF MESSAGE AREAS
         MVI   MSGTAB,X'FF'            INITIALIZE MESSAGE AREA
         LA    R05,1                   INITIALIZE
         ICM   R05,8,MSGTAB                REGISTER
         MVCL  R06,R04                 SET MESSAGE AREAS TO X'FF'
         EJECT
***********************************************************************
*                                                                     *
*      INPUT PARAMETER PROCESSING.                                    *
*                                                                     *
***********************************************************************
         SPACE 3
*
*      PROCESSING OF DATA SET NAME(S).
*
         SPACE 1
         LA    R04,TEXT                LOAD PARAMETER START ADDRESS
         LA    R08,PARMLEN-1           LOAD LENGTH OF PARMAREA
         EX    R08,TRT                 BRANCH TO FIND SEPERATOR
         BZ    PRMERROR                BRANCH IF NO FOUND
         CLM   R02,1,TRTCOMMA          COMMA FOUND ?
         BNE   PRMERROR                IF NOT, BRANCH TO ERROR ROUTINE
         LR    R05,R01                 COMPUTE
         SR    R05,R04                      LENGTH OF TEXT
         SR    R08,R05                 COMPUTE REMAINDER LENGTH
         LA    R04,1(,R01)             LOAD ADDRESS OF NEXT BYTE
         EX    R08,TRT                 BRANCH TO FIND NEXT SEPERATOR
         BZ    PRMERROR                BRANCH IF NO FOUND
         LR    R05,R01                 COMPUTE LENGTH
         SR    R05,R04                     OF DATA SET NAME
         BNP   PRMERROR                BRANCH IF INVALID LENGTH
         CH    R05,=H'44'              LENGTH VALID ?
         BH    PRMERROR                BRANCH IF INVALID LENGTH
         MVC   HEADER(MSG00LEN),MSG00  MOVE MESSAGE SKELETON
         BCTR  R05,0                   MODIFY FOR EX COMMAND
         STH   R05,DSNMLEN             STORE LENGTH
         EX    R05,MOVEPNAM            BRANCH TO MOVE DSNAME
         CLC   0(4,R04),=C'RACF'       RACF PROTECTED DATA SETS ?
         BE    SETRACF                 BRANCH IF YES
         CLC   0(8,R04),=C'PASSWORD'   PASSWORD PROTECTED DATA SETS ?
         BE    SETPWRD                 BRANCH IF YES
         CLC   0(8,R04),=C'NOPWREAD'   NOPWREAD PROTECTED DATA SETS ?
         BE    SETNOPW                 BRANCH IF YES
         BCTR  R01,0                   DECREASE ADDRESS
         CLI   0(R01),C'.'             INDEX LEVEL SPECIFIED ?
         LA    R01,1(,R01)             CORRECT LENGTH
         BE    SETINDEX                BRANCH IF YES
ENDPNAM1 EQU   *
         TM    FLG2BYTE,FLG2PROT       PROTECTED DATA SETS ?
         BZ    *+10                    BRANCH IF NOT
         MVC   HEADER+12(4),=CL4' '    CLEAR CONSTANT
         EJECT
*
*      PROCESSING OF FOLLOWING PARAMETERS (VOLSER MASKS,
*      'MSG', 'EXT', 'DATE', AND 'CAT').
*
         SPACE 1
         LA    R06,TABPVOL1            LOAD ADDRESS OF VOLSER TABLE
NEXTPARM EQU   *
         CLM   R02,1,TRTCOMMA          MORE PARAMETERS SPECIFIED ?
         BNE   ENDPARM                 BRANCH IF NOT
         SR    R08,R05                 COMPUTE REMAINDER LENGTH
         LA    R04,1(,R01)             LOAD ADDRESS OF NEXT BYTE
         EX    R08,TRT                 BRANCH TO FIND SEPERATOR
         BZ    PRMERROR                BRANCH IF NO FOUND
         LR    R05,R01                 COMPUTE LENGTH
         SR    R05,R04                     OF PARAMETER
         BZ    PRMERROR                TEST LENGTH
         CH    R05,=H'6'                   AND BRANCH
         BH    PRMERROR                    IF INVALID
         CLC   0(3,R04),=C'MSG'        GENERAL INFORMATION REQUESTED ?
         BNE   *+12                    BRANCH IF NOT
         OI    FLG1BYTE,FLG1GIN        ELSE SET FLAG
         B     NEXTPARM                    AND BRANCH
         CLC   0(3,R04),=C'EXT'        EXTENT INFORMATION REQUESTED ?
         BNE   *+12                    BRANCH IF NOT
         OI    FLG1BYTE,FLG1EXT        ELSE SET FLAG
         B     NEXTPARM                    AND BRANCH
         CLC   0(4,R04),=C'DATE'       DATE INFORMATION REQUESTED ?
         BNE   *+12                    BRANCH IF NOT
         OI    FLG1BYTE,FLG1DATE       ELSE SET FLAG
         B     NEXTPARM                    AND BRANCH
         CLC   0(3,R04),=C'CAT'        CATALOG INFORMATION REQUESTED ?
         BNE   *+12                    BRANCH IF NOT
         OI    FLG1BYTE,FLG1CAT        ELSE SET FLAG
         B     NEXTPARM                    AND BRANCH
         C     R06,ADDRETPV            END OF VOLSER TABLE ?
         BNL   PRMERROR                BRANCH IF YES
         BCTR  R05,0                   MODIFY FOR EX COMMAND
         EX    R05,MOVEPVOL            BRANCH TO MOVE VOLSER
         OI    FLG1BYTE,FLG1VOL        SET FLAG
         STC   R05,0(R06)              STORE LENGTH
         LA    R06,7(,R06)             LOAD ADDRESS OF NEXT TABLE ELEM.
         B     NEXTPARM                BRANCH
         EJECT
*
*      END OF PARAMETER PROCESSING.
*
         SPACE 1
ENDPARM  EQU   *
         TM    FLG1BYTE,FLG1INFO       INFO. PARAMETER SPECIFIED ?
         BNE   *+8                     BRANCH IF YES
         OI    FLG1BYTE,FLG1GINC       ELSE SET DEFAULT FLAGS
         MVI   0(R06),X'80'            SPECIFY END OF TABLE
         TR    TABPVOL1(77),TRTABLE    TRANSLATE DON'T CARE CHARACTER
         MVC   TABPVOL2,TABPVOL1       COPY VOLSER TABLE
         TR    TABPVOL2(77),TRTABLE    TRANSLATE DON'T CARE CHARACTER
         TM    FLG2BYTE,FLG2ON         FULL DSNAME SPECIFIED ?
         BNZ   GETUCB                  BRANCH IF NOT
         LA    R14,GETUCB              ELSE LOAD RETURN ADDRESS
         B     LOCATE                      AND BRANCH
         SPACE 2
SETRACF  EQU   *
         OI    FLG2BYTE,FLG2RACF       SET FLAG
         B     ENDPNAM1                BRANCH
SETPWRD  EQU   *
         OI    FLG2BYTE,FLG2PWRD       SET FLAG
         B     ENDPNAM1                BRANCH
SETNOPW  EQU   *
         OI    FLG2BYTE,FLG2NOPW       SET FLAG
         B     ENDPNAM1                BRANCH
SETINDEX EQU   *
         OI    FLG2BYTE,FLG2INLV       SET FLAG
         B     ENDPNAM1                BRANCH
         EJECT
***********************************************************************
*                                                                     *
*      PROCESSING OF UCB VECTOR TABLE.                                *
*                                                                     *
***********************************************************************
         SPACE 3
GETUCB   EQU   *
         DROP  R09                     FREE BASE REGISTER
         GETMAIN R,LV=VECLEN,SP=125
         LR    R09,R01                 INITIALIZE BASE REGISTER
         USING VECTOR,R09              ALLOC. BASE REG. OF VECTOR
         ST    R09,UCBADDR             STORE ADDR. OF UCB ADDR. VECTOR
         MVI   UCBADDR,X'80'           MOVE OPTION BYTE
         MVC   VECEND,=X'FFFF'         SET END OF VECTOR
         LA    R01,UCBADDR             LOAD ADDR. OF UCB ADDR. VECTOR
         LINK  EP=GETUCBS              LINK TO SUBROUTINE 'GETUCBS'
         L     R02,UCBADDR             LOAD ADDR. OF UCB ADDR. VECTOR
         BCTR  R02,0                   DECREASE
         BCTR  R02,0                       BY TWO
         DROP  R09                     FREE BASE REGISTER
         EJECT
***********************************************************************
*                                                                     *
*      PROCESSING OF UCB INFORMATION.                                 *
*                                                                     *
***********************************************************************
         SPACE 3
NEXTUCB  EQU   *
         LA    R02,2(,R02)             LOAD ADDRESS OF NEXT UCB ADDR.
         CLC   0(2,R02),=X'FFFF'       END OF VECTOR ?
         BE    ENDPROC                 BRANCH IF YES
         SR    R03,R03                 ZERO FOR ICM COMMAND
         ICM   R03,3,0(R02)            LOAD UCB ADRESS
         CLI   UCBDVCLS,X'20'          DEVICE = DASD ?
         BNE   NEXTUCB                 BRANCH IF NOT
         TM    DEVSTAT,X'80'           DEVICE ONLINE ?
         BZ    NEXTUCB                 BRANCH IF NOT
         TM    DEVSTAT,X'10'           UNLOAD PENDING ?
         BO    NEXTUCB                 BRANCH IF YES
         CLC   UCBVOLI,=XL6'0'         VOLID ?
         BE    NEXTUCB                 BRANCH IF NOT
         TM    UCB+17,X'08'            VIRTUAL DEVICE ?
         BO    TSTVVOL                 BRANCH IF YES
         TM    FLG1BYTE,FLG1VOL        VOLSER MASKS SPECIFIED ?
         BZ    MVCVOLID                BRANCH IF NOT
         SPACE 2
*
*      COMPARE WITH SPECIFIED VOLSER NUMBERS.
*
         SPACE 1
         SR    R05,R05                 ZERO FOR ICM COMMAND
         LA    R06,TABPVOL1-7          LOAD ADDRESS OF VOLSER TABLE 1
         LA    R07,TABPVOL2-7          LOAD ADDRESS OF VOLSER TABLE 2
NXTVOLID EQU   *
         LA    R06,7(,R06)             LOAD ADDRESS OF NEXT ELEMENT
         LA    R07,7(,R07)             LOAD ADDRESS OF NEXT ELEMENT
         TM    0(R06),X'80'            END OF TABLE ?
         BO    NEXTUCB                 BRANCH IF YES
         IC    R05,0(R06)              INSERT LENGTH
         MVC   WKVOLID1,UCBVOLI        MOVE VOLSER NUMBER
         MVC   WKVOLID2,UCBVOLI        MOVE VOLSER NUMBER
         EX    R05,NCVOLID1            BRANCH TO NC VOLSER NUMBERS
         EX    R05,OCVOLID2            BRANCH TO OC VOLSER NUMBERS
         CLC   WKVOLID1,WKVOLID2       VOLID = SPEC. VOLID ?
         BNE   NXTVOLID                BRANCH IF NOT
         B     MVCVOLID                BRANCH
         SPACE 1
TSTVVOL  EQU   *
         LA    R06,TABPVOL1-7          LOAD ADDRESS OF VOLSER TABLE 1
NXTVVOL  EQU   *
         LA    R06,7(,R06)             LOAD ADDRESS OF NEXT ELEMENT
         TM    0(R06),X'80'            END OF TABLE ?
         BO    NEXTUCB                 BRANCH IF YES
         CLC   UCBVOLI,1(R06)          VOLID = SPEC. VOLID ?
         BNE   NXTVVOL                 BRANCH IF NOT
MVCVOLID EQU   *
         MVC   VOLSERNO,UCBVOLI        MOVE VOLSER NUMBER
         TM    FLG2BYTE,FLG2ON         FULL DSNAME SPECIFIED ?
         BZ    GETDSCB1                BRANCH IF YES
         SPACE 2
*
*      COMPUTE CCHHR OF VTOC.
*
         SPACE 1
         SR    R04,R04                 ZERO FOR IC COMMAND
         IC    R04,DEVCODE             INSERT DEVICE CODE
         SLA   R04,2                   DEVICE CODE * 4
         LA    R05,TABTCAP(R04)        LOAD ADDRESS OF TABLE ELEMENT
         CLI   0(R05),X'80'            DEVICE RESERVED ?
         BE    DEVERROR                IF YES BRANCH TO ERROR ROUTINE
         LH    R06,UCBVTOC             LOAD RELATIVE ADDRESS OF VTOC
         SRDA  R06,32                  R06 -> R07
         D     R06,0(R05)              DIV. TT / SPECIFIC TRK PER CYL
         STH   R07,CCHHR               STORE CYLINDER NUMBER
         STH   R06,CCHHR+2             STORE HEADER NUMBER
         SR    R05,R05                 ZERO FOR IC COMMAND
         IC    R05,UCBVTOC+2           LOAD RECORD NUMBER OF VTOC
         STC   R05,CCHHR+4                 AND STORE IT
         STH   R05,CURRECNO            STORE CURR. RECORD NUMBER
         STH   R06,CURTRKNO            STORE CURR. TRACK NUMBER
         STH   R07,CURCYLNO            STORE CURRENT CYLINDER NUMBER
         SPACE 2
*
*      GET DSCB4.
*
         SPACE 1
         OBTAIN CAMSEEK                OBTAIN DSCB4
         LTR   R15,R15                 OBTAIN SUCCESSFUL ?
         BNZ   DEVERROR                IF NOT, BRANCH TO ERROR ROUTINE
         CLI   DS4FMTID,X'F4'          FIRST DSCB = DSCB4 ?
         BNE   DEVERROR                IF NOT, BRANCH TO ERROR ROUTINE
         MVC   MTRKNO,DS4DEVSZ+2       SAVE MAXIMUM TRACK ADDRESS
         MVI   MRECNO,X'00'            SAVE MAXIMUM
         MVC   MRECNO+1(1),DS4DEVT         RECORD ADDRESS
         MVC   MDS1ADDR(4),DS4HPCR     SAVE HIGHEST
         MVI   MDS1R,X'00'                 DISK ADDRESS
         MVC   MDS1R+1(1),DS4HPCR+4        OF DSCB1
         EJECT
***********************************************************************
*                                                                     *
*      DSCB1 PROCESSING.                                              *
*                                                                     *
***********************************************************************
         SPACE 3
NXTDSCB  EQU   *
         MVC   CCHHR,CURADDR           RESTORE CCHHR AREA
         LH    R04,CURRECNO            LOAD CURRENT RECORD NUMBER
         LA    R04,1(R04)                  AND INCREASE IT
         CH    R04,MRECNO              RECORD NUMBER TOO HIGH ?
         BNH   NXTREC                  BRANCH IF NOT
         LH    R04,CURTRKNO            ELSE LOAD CURRENT TRACK NUMBER
         LA    R04,1(R04)                  AND INCRESE IT
         CH    R04,MTRKNO              TRACK NUMBER TOO HIGH ?
         BL    NXTTRK                  BRANCH IF NOT
         LH    R04,CURCYLNO            ELSE LOAD CURR. CYLINDER NUMBER
         LA    R04,1(R04)                  AND INCRESE IT
         STH   R04,CURCYLNO            STORE NEW
         STH   R04,CCHHR                   CYLINDER NUMBER
         SR    R04,R04                 ZERO TRCK NUMBER
NXTTRK   EQU   *
         STH   R04,CURTRKNO            STORE NEW
         STH   R04,CCHHR+2                 TRACK NUMBER
         LA    R04,1                   INITIALIZE RECORD NUMBER
NXTREC   EQU   *
         STH   R04,CURRECNO            STORE NEW
         STC   R04,CCHHR+4                 RECORD NUMBER
         CLC   CURADDR(6),MDS1ADDR     END OF VTOC ?
         BH    NEXTUCB                 BRANCH IF YES
         OBTAIN CAMSEEK                ELSE OBTAIN NEXT DSCB
         LTR   R15,R15                 SUCCESSFUL OBTAIN ?
         BNZ   OBTERROR                IF NOT, BRANCH TO ERROR ROUTINE
         CLI   DS1FMTID,C'1'           DSCB = DSCB1 ?
         BNE   NXTDSCB                 BRANCH IF NOT
         EJECT
         TM    FLG2BYTE,FLG2INLV       INDEX LEVEL SPECIFIED ?
         BO    TSTINDLV                BRANCH IF YES
         TM    FLG2BYTE,FLG2RACF       RACF PROTECTED DATA SETS ?
         BO    TSTRACFP                BRANCH IF YES
         TM    FLG2BYTE,FLG2PWRD       PASSWORD PROTECTED DATA SETS ?
         BO    TSTPWRDP                BRANCH IF YES
         TM    FLG2BYTE,FLG2NOPW       NOPWREAD PROTECTED DATA SETS ?
         BO    TSTNOPWP                BRANCH IF YES
         SPACE 1
TSTINDLV EQU   *
         LH    R05,DSNMLEN             LOAD LENGTH OF SPEC. NAME
         EX    R05,TESTNAME            BRANCH TO TEST DSNAME
         BNE   NXTDSCB                 BRANCH IF INVALID DSNAME
         B     TESTOK                  BRANCH IF VALID DSNAME
TSTRACFP EQU   *
         TM    DS1DSIND,DS1RACF        RACF PROTECTED DATA SET ?
         BNO   NXTDSCB                 BRANCH IF NOT
         B     TESTOK                  BRANCH IF YES
TSTPWRDP EQU   *
         TM    DS1DSIND,DS1PSWD        PASSWORD PROTECTED DATA SET ?
         BNO   NXTDSCB                 BRANCH IF NOT
         TM    DS1DSIND,DS1NOPWR       NOPWREAD PROTECTED DATA SET ?
         BO    NXTDSCB                 BRANCH IF YES
         B     TESTOK                  BRANCH IF NOT
TSTNOPWP EQU   *
         TM    DS1DSIND,DS1NOPWR       NOPWREAD PROTECTED DATA SET ?
         BNO   NXTDSCB                 BRANCH IF NOT
TESTOK   EQU   *
         MVC   HEADER(MSG00LEN),MSG00  MOVE MESSAGE SKELETON
         MVC   DSNAME,DS1DSNAM         MOVE DATA SET NAME
         LA    R14,SETFNDFL            LOAD RETURN ADDRESS
         B     LOCATE                      AND BRANCH
         EJECT
GETDSCB1 EQU   *
         OBTAIN CAMSRCH                OBTAIN DSCB1
         LTR   R15,R15                 SUCCESSFUL OBTAIN ?
         BNZ   OBTERROR                BRANCH IF NOT
         CLC   DS1CCHHR,=XL6'0'        DUMMY DSCB1 ?
         BE    NEXTUCB                 BRANCH IF YES
SETFNDFL EQU   *
         OI    FLG1BYTE,FLG1FND        SET FLAG
         LA    R14,DSCB1MSG            LOAD ADDRESS OF NEXT ROUTINE
         TM    FLG1BYTE,FLG1DATE       DATE INFORMATION REQUESTED ?
         BO    DATEINFO                BRANCH IF YES
DSCB1MSG EQU   *
         LA    R14,DSCB1EXT            LOAD ADDRESS OF NEXT ROUTINE
         TM    FLG1BYTE,FLG1GIN        GENERAL INFORMATION REQUESTED ?
         BO    MSGINFO                 BRANCH IF YES
DSCB1EXT EQU   *
         TM    FLG2BYTE,FLG2ON         FULL DSNAME SPECIFIED ?
         BZ    *+12                    BRANCH IF YES
         LA    R14,NXTDSCB             ELSE LOAD ADDR. OF NEXT ROUTINE
         B     *+8                         AND BRANCH
         LA    R14,NEXTUCB             LOAD ADDRESS OF NEXT ROUTINE
         TM    FLG1BYTE,FLG1EXT        EXTENT INFORMATION REQUESTED ?
         BO    EXTINFO                 BRANCH IF YES
         BR    R14                     BRANCH IF NOT
         EJECT
***********************************************************************
*                                                                     *
*      FINAL PROCESSING.                                              *
*                                                                     *
***********************************************************************
         SPACE 3
ENDPROC  EQU   *
         NI    FLG1BYTE,FLG1NWTO       CLEAR FLAG BYTE
         FREEMAIN R,SP=125             ISSUE FREEMAIN
         CLI   REPLY,C'N'              LAST REPLY = NO ?
         BE    RETURN                  BRANCH IF YES
         TM    FLG1BYTE,FLG1FND        ANY DATA SET FOUND ?
         BO    OUTRMSGN                BRANCH IF YES
         L     R00,UCMID               LOAD UCM-ID.
         WTO   MF=(E,HEADER)           DISPLAY MESSAGE LINE
         L     R00,UCMID               LOAD UCM-ID.
         WTO   MF=(E,MSG06)            DISPLAY MESSAGE LINE
         B     RETURN                  BRANCH
         EJECT
*
*      OUTPUT OF GENERAL INFORMATION.
*
         SPACE 1
OUTRMSGN EQU   *
         LA    R10,MSGTAB              LOAD ADDRESS OF MESSAGE TABLE
         CLI   MSGFLAG,X'00'           MESSAGES TO BE DISPLAYED ?
         BNE   OUTREXTN                BRANCH IF NOT
         BAL   R14,OUTMSGM             BRANCH IF YES
         SPACE 2
*
*      OUTPUT OF EXTENT MESSAGES.
*
         SPACE 1
OUTREXTN EQU   *
         LA    R10,EXTNTAB             LOAD ADDRESS OF MESSAGE TABLE
         CLI   MSGFLAG,X'00'           MESSAGES TO BE DISPLAYED ?
         BNE   OUTRDTEN                BRANCH IF NOT
         BAL   R14,OUTEXTM             BRANCH IF YES
         SPACE 2
*
*      OUTPUT OF DATE MESSAGES.
*
         SPACE 1
OUTRDTEN EQU   *
         LA    R10,DATETAB             LOAD ADDRESS OF MESSAGE TABLE
         CLI   MSGFLAG,X'00'           MESSAGES TO BE DISPLAYED ?
         BNE   RETURN                  BRANCH IF NOT
         BAL   R14,OUTDATM             BRANCH IF YES
         EJECT
*
*      FREEMAIN WORK AREAS,
*      RELOAD REGISTER CONTENTS,
*      RETURN.
*
         SPACE 1
RETURN   EQU   *
         L     R00,UCMID               LOAD UCM-ID.
         WTO   MF=(E,MSG07)            DISPLAY END MESSAGE
         XRETURN ,R
         EJECT
***********************************************************************
*                                                                     *
*      CATALOG INFORMATION PROCESSING.                                *
*                                                                     *
***********************************************************************
         SPACE 3
LOCATE   EQU   *
         L     R00,UCMID               LOAD UCM-ID.
         WTO   MF=(E,HEADER)           DISPLAY HEAD LINE
         TM    FLG1BYTE,FLG1CAT        CATALOG INFORMATION REQUESTED ?
         BZR   R14                     BRANCH IF NOT
         ST    R14,SAVE3R14            STORE RETURN ADDRESS
         LOCATE CAMNAME                GET CATALOG INFORMATION
         LTR   R15,R15                 RETURN CODE = 0 ?
         BNZ   LOCERROR                IF NOT, BRANCH TO ERROR ROUTINE
         LH    R05,LOCWKFLD            LOAD NUMBER OF VOLUMES
         LTR   R05,R05                 DATA SET CATALOGED ?
         BZ    LOCERROR                IF NOT, BRANCH TO ERROR ROUTINE
         LA    R10,ERRORTAB            INITIALIZE BASE REGISTER
         MVC   MESSAGE(MSG01LEN),MSG01 MOVE MESSAGE SKELETON
         MVC   MS0CVOL,LOCWKFLD+259    MOVE CVOL NUMBER
         LA    R06,LOCWKFLD+6          LOAD ADDRESS OF FIRST VOLSER
         LA    R07,20                  LOAD MAXIMUM NUMBER
         CR    R05,R07                 ACT. NUMBER > MAX. NUMBER ?
         BNH   *+6                     BRANCH IF NOT
         LR    R05,R07                 ELSE LOAD MAXIMUM NUMBER
         LA    R07,3                   INITIALIZE LOOP COUNT
         CR    R07,R05                 LOOP COUNT > NO. OF VOLSERS ?
         BNH   *+6                     BRANCH IF NOT
         LR    R07,R05                 ELSE SET NEW LOOP COUNT
         LR    R08,R07                 LOAD LOOP COUNT
         LA    R04,MS0VOL2             LOAD ADDRESS IN MESSAGE
         LH    R01,LINECNT             INCREASE
         LA    R01,1(,R01)                 OUTPUT
         STH   R01,LINECNT                 LINE COUNT
         EJECT
MOVELOOP EQU   *
         MVC   0(6,R04),0(R06)         MOVE VOLSER NUMBER
         MVI   6(R04),C','             MOVE SEPERATOR
         LA    R04,7(,R04)             LOAD NEXT AVAILABLE ADDRESS
         LA    R06,12(,R06)            LOAD ADDRESS OF NEXT VOLSER
         BCT   R07,MOVELOOP            BRANCH TO LOOP
         SPACE 1
         CR    R08,R05                 ALL VOLSERS ALREADY MOVED ?
         BL    *+10                    BRANCH IF NOT
         BCTR  R04,0                   DECREASE ADDRESS
         MVI   0(R04),C' '             CLEAR SEPERATOR
         L     R00,UCMID               LOAD UCM-ID.
         WTO   MF=(E,MESSAGE)          DISPLAY MESSAGE LINE
         LH    R01,LINECNT             INCREASE
         LA    R01,1(,R01)                 OUTPUT
         STH   R01,LINECNT                 LINE COUNT
         CR    R08,R05                 ALL VOLSERS ALREADY MOVED ?
         BNL   ENDLOC                  BRANCH IF YES
         SR    R05,R08                 DECREASE NUMBER OF VOLSERS
         LA    R07,7                   INITIALIZE LOOP COUNT
         CR    R07,R05                 LOOP COUNT > NO. OF VOLUMES ?
         BNH   *+6                     BRANCH IF NOT
         LR    R07,R05                 ELSE SET NEW LOOP COUNT
         LR    R08,R07                 LOAD LOOP COUNT
         LA    R04,MS0VOL1             LOAD ADDRESS IN MESSAGE
         MVC   MS0VOL1(54),MS0VOL1-1   CLEAR MESSAGE AREA
         B     MOVELOOP                BRANCH
ENDLOC   EQU   *
         L     R14,SAVE3R14            LOAD RETURN ADDRESS
         BR    R14                         AND BRANCH
         EJECT
***********************************************************************
*                                                                     *
*      PROCESSING OF DCB AND ALLOCATION INFORMATIONS.                 *
*                                                                     *
***********************************************************************
         SPACE 3
MSGINFO  EQU   *
         ST    R14,SAVE1R14            SAVE RETURN ADDRESS
         L     R10,SAVE1R10            INIT. BASE REGISTER
         MVI   MSGFLAG,X'00'           CLEAR FLAG
         MVC   MESSAGE(MSG03LEN),MSG03 MOVE MESSAGE SKELETON
         MVC   MS3VOLID,UCBVOLI        MOVE VOLSER NUMBER
         MVC   MS3ADR,UCBNAME          MOVE UNIT NAME
         TM    DS1DSIND,DS1RACF        RACF PROTECTION ?
         BNO   *+14                    BRANCH IF NOT
         MVC   MS3MARK,=C'RF'          ELSE SPECIFY RACF PROTECTION
         B     GETDCBIN                    AND BRANCH
         TM    DS1DSIND,DS1NOPWR       NOPWREAD PROTECTION ?
         BNO   *+14                    BRANCH IF NOT
         MVC   MS3MARK,=C'NR'          ELSE SPECIFY NOPWREAD PROTECTION
         B     GETDCBIN                    AND BRANCH
         TM    DS1DSIND,DS1PSWD        PASSWORD PROTECTION ?
         BNO   GETDCBIN                BRANCH IF NOT
         MVC   MS3MARK,=C'PW'          ELSE SPECIFY PASSWORD PROTECTION
         SPACE 2
*
*      PREPARE DCB INFORMATION.
*
         SPACE 1
GETDCBIN EQU   *
         MVC   WRKDCBIN,CONDCBIN       MOVE MASK
         LA    R06,TB1DSORG-3          LOAD ADDRESS OF 1. TABLE
         LA    R09,DS1DSORG            LOAD ADDRESS OF DSORG FIELD
DSORGLP  EQU   *
         LA    R06,3(,R06)             LOAD ADDRESS OF NEXT ELEMENT
         TM    0(R06),X'FF'            END OF TABLE ?
         BO    DSORGLPE                BRANCH IF END OF 1. TABLE
         BZ    RECFM                   BRANCH IF END OF 2. TABLE
         IC    R01,0(R06)              INSERT TABLE ELEMENT
         EX    R01,TMDSORG             BRANCH TO TEST UNDER MASK
         BZ    DSORGLP                 BRANCH IF OTHER DSORG
         MVC   WRKDSORG,1(R06)         MOVE TEXT
         CLC   WRKDSORG,TB2VSAM+1      VSAM DATA SET ?
         BNE   RECFM                   BRANCH IF NOT
         MVC   WRKDSORG+2,=C'AM'
         B     RECFM                   BRANCH
DSORGLPE EQU   *
         LA    R06,TB2DSORG            LOAD ADDRESS OF 2. TABLE
         LA    R09,DS1DSORG+1          LOAD ADDRESS OF DSORG FIELD
         B     DSORGLP                 BRANCH TO LOOP
         EJECT
RECFM    EQU   *
         TM    DS1RECFM,X'C0'          RECFM = U ?
         BO    EDBLKSI                 BRANCH IF YES
         TM    DS1RECFM,X'80'          RECFM = F ?
         BNO   *+8                     BRANCH IF NOT
         MVI   WRKRECFM,C'F'           ELSE SPECIFY RECFM = F
         TM    DS1RECFM,X'40'          RECFM = V ?
         BNO   *+8                     BRANCH IF NOT
         MVI   WRKRECFM,C'V'           ELSE SPECIFY RECFM = V
         SPACE 1
         TM    DS1RECFM,X'10'          DATA SET BLOCKED ?
         BZ    *+8                     BRANCH IF NOT
         MVI   WRKRECFM+1,C'B'         ELSE SPECIFY BLOCKED
         TM    DS1RECFM,X'08'          SPANNED, STANDARD ?
         BZ    *+8                     BRANCH IF NOT
         MVI   WRKRECFM+2,C'S'         ELSE SPECIFY SPANNED, STANDARD
         TM    DS1RECFM,X'04'          ASA CONTROL CHARACTER ?
         BZ    *+8                     BRANCH IF NOT
         MVI   WRKRECFM+3,C'A'         ELSE SPECIFY ASA CONTROL CHAR.
         TM    DS1RECFM,X'02'          MC CONTROL CHARACTER ?
         BZ    *+8                     BRANCH IF NOT
         MVI   WRKRECFM+3,C'M'         ELSE SPECIFY MC CONTROL CHAR.
         SPACE 1
         LH    R04,DS1LRECL            LOAD RECORD LENGTH
         CVD   R04,DBWORD                  AND CONVERT IT TO DECIMAL
         MVC   WRKLRECL,=X'402020202120'   MOVE EDIT MASK
         ED    WRKLRECL,DBWORD+5       EDIT RECORD LENGTH
         MVI   WRKLRECL,C','           INSERT SEPERATOR
         SPACE 1
EDBLKSI  EQU   *
         LH    R04,DS1BLKL             LOAD BLOCK SIZE
         CVD   R04,DBWORD                  AND CONVERT IT TO DECIMAL
         MVC   WRKBLKSI,=X'402020202120'   MOVE EDIT MASK
         ED    WRKBLKSI,DBWORD+5       EDIT BLOCK SIZE
         MVI   WRKBLKSI,C','           INSERT SEPERATOR
         SPACE 1
         LA    R04,WRKSHFTL            LOAD SHIFT LENGTH
         LA    R06,WRKDCBIN            LOAD SHIFT START ADDRESS
         BAL   R14,SHFTLOOP            BRANCH TO SHIFT
         MVC   MS3DCBIN,WRKDCBIN       MOVE DCB INFORMATION
         EJECT
*
*      PREPARE ALLOCATION INFORMATION.
*
         SPACE 1
         SR    R04,R04                 ZERO FOR IC COMMAND
         IC    R04,DEVCODE             LOAD DEVICE CODE
         SLA   R04,1                   DEVICE CODE * 2
         LA    R08,TABTCAP(R04)        LOAD ADDRESS OF TABLE ELEMENT
         CLI   0(R08),X'80'            DEVICE RESERVED ?
         BE    DEVERROR                IF YES BRANCH TO ERROR ROUTINE
         MVC   TABELEM,0(R08)          MOVE TABLE ELEMENT
         LH    R04,DS1LSTAR            LOAD TT ADDR. OF LAST BLOCK PTR
         CLC   DS1LSTAR(5),=XL6'0'     LAST BLOCK POINTER = 0 ?
         BE    *+16                    BRANCH IF YES
         CLI   DS1LSTAR+2,X'00'        R ADDR. = 0 ?
         BE    *+8                     BRANCH IF YES
         LA    R04,1(,R04)             ELSE INCRESE TRACK ADDRESS
         CH    R04,=H'9999'            USED TRACKS > 9999 ?
         BH    *+14                    BRANCH IF YES
         BAL   R14,CONVDEC             BRANCH TO CONVERT TO DECIMAL
         MVC   MS3USED,WKAREA+11       MOVE NUMBER OF USED TRACKS
         MVC   WRKALLOC,CONALLOC       MOVE MASK
         TM    DS1SCALO,X'C0'          REQUEST IN CYLINDERS ?
         BNO   REQINTRK                BRANCH IF NOT
         MVC   WRKALTYP(3),=C'CYL'     ELSE SPEC. REQUEST IN CYL.
         TM    DS1EXT1,X'FF'           EXTENT DESCRIPTION ?
         BZ    SECALLOC                BRANCH IF NOT
         BAL   R14,EXT1LEN             BRANCH TO COMPUTE EXTENT SIZE
         LTR   R07,R07                 EXTENT IN CYLINDERS ?
         BZ    ALLOCOK                 BRANCH IF YES
         LA    R06,1(,R06)             ELSE INCREASE NUMBER OF CYL.
         B     ALLOCOK                 BRANCH
         SPACE 1
REQINTRK EQU   *
         TM    DS1SCALO,X'80'          REQUEST IN TRACKS ?
         BZ    REQINBLK                BRANCH IF NOT
         MVC   WRKALTYP(3),=C'TRK'     ELSE SPEC. REQUEST IN TRK.
         TM    DS1EXT1,X'FF'           EXTENT DESCRIPTION ?
         BZ    SECALLOC                BRANCH IF NOT
         BAL   R14,EXT1LEN             BRANCH TO COMPUTE EXTENT SIZE
         MH    R06,TABELEM             COMPUTE NUMBER
         AR    R06,R07                      OF ALLOCATED TRACKS
         B     ALLOCOK                 BRANCH
         EJECT
REQINBLK EQU   *
         TM    DS1SCALO,X'40'          REQUEST IN BLOCKS ?
         BZ    ENDSEALC                BRANCH IF NOT
         LH    R04,DS1BLKL             LOAD BLOCK SIZE
         CVD   R04,DBWORD                  AND CONVERT IT TO DECIMAL
         MVC   WRKALTYP,=X'402020202120'   MOVE EDIT MASK
         ED    WRKALTYP,DBWORD+5       EDIT BLOCK SIZE
         B     SECALLOC                BRANCH
ALLOCOK  EQU   *
         CVD   R06,DBWORD              CONV. PRIM. ALLOC. QUAN. TO DEC.
         MVC   WRKPRMAL,=X'402020202120'   MOVE EDIT MASK
         ED    WRKPRMAL,DBWORD+5       EDIT PRIMARY ALLOCATION QUAN.
         MVI   WRKPRMAL,C'('           INSERT SEPERATOR
SECALLOC EQU   *
         ICM   R04,7,DS1SCALO+1        INSERT SEC. ALLOCATION QUAN.
         CVD   R04,DBWORD                  AND CONVERT IT TO DECIMAL
         MVC   WRKSECAL,=X'402020202120'   MOVE EDIT MASK
         ED    WRKSECAL,DBWORD+5       EDIT SECONDARY ALLOCATION QUAN.
         MVI   WRKSECAL,C','           INSERT SEPERATOR
ENDSEALC EQU   *
         LA    R04,WRKASLEN            LOAD SHIFT LENGTH
         LA    R06,WRKALLOC            LOAD SHIFT START ADDRESS
         BAL   R14,SHFTLOOP            BRANCH TO SHIFT
         MVC   MS3ALLOC,WRKALLOC       MOVE ALLOCATION INFORMATION
         EJECT
*
*      COMPUTE ALLOCATED TRACKS.
*
         SPACE 1
         BAL   R14,GETEXT              BRANCH TO GET EXTENT INFORMATION
         LA    R08,EXTTAB-10           LOAD ADDR. OF EXTENT INFO. TABLE
         SR    R09,R09                 ZERO
         ST    R09,CCNO                    CYLINDER COUNT AND
         ST    R09,HHNO                    TRACK COUNT
ALOTRKLP EQU   *
         LA    R08,10(,R08)            LOAD ADDRESS OF NEXT ELEMENT
         TM    0(R08),X'FF'            END OF TABLE ?
         BO    ALOTRKEN                BRANCH IF YES
         BZ    ALOTRKLP                BRANCH IF NO EXTENT DESCRIPTIONS
         MVC   DS1EXT1,0(R08)          MOVE EXTENT DESCRIPTION
         BAL   R14,EXT1LEN             BRANCH TO COMPUTE EXTENT SIZE
         L     R09,CCNO                INCREASE
         AR    R09,R06                     CYLINDER
         ST    R09,CCNO                    COUNT
         L     R09,HHNO                INCREASE
         AR    R09,R07                     TRACK
         ST    R09,HHNO                    COUNT
         B     ALOTRKLP                BRANCH
ALOTRKEN EQU   *
         L     R04,CCNO                COMPUTE
         MH    R04,TABELEM                 NUMBER OF
         A     R04,HHNO                    ALLOCATED TRACKS
         CH    R04,=H'9999'            ALLOCATED TRACKS > 9999 ?
         BH    *+14                    BRANCH IF YES
         BAL   R14,CONVDEC             BRANCH TO CONVERT TO DECIMAL
         MVC   MS3TRKS,WKAREA+11       MOVE NUMBER OF ALLOC. TRACKS
         L     R14,SAVE1R14            LOAD RETURN ADDRESS
         LA    R10,68(,R10)            LOAD ADDR. OF NEXT TABLE ELEM.
         C     R10,ADDRETB1            END OF TABLE ?
         BNL   OUTMSGM                 BRANCH IF YES
         TM    FLG2BYTE,FLG2ON         FULL DSNAME SPECIFIED ?
         BNZ   OUTMSGM1                BRANCH IF NOT
         ST    R10,SAVE1R10            STORE CURRENT ADDRESS
         BR    R14                     BRANCH
         EJECT
***********************************************************************
*                                                                     *
*      PROCESSING OF EXTENT INFORMATION.                              *
*                                                                     *
***********************************************************************
         SPACE 3
EXTINFO  EQU   *
         ST    R14,SAVE1R14            SAVE RETURN ADDRESS
         TM    FLG1BYTE,FLG1GIN        EXTENT INFO. TABLE FILLED ?
         BO    *+8                     BRANCH IF YES
         BAL   R14,GETEXT              BR. TO FILL EXTENT INFO. TABLE
         L     R10,SAVE2R10            INIT. BASE REGISTER
         SR    R05,R05                 ZERO OUTPUT LINE COUNT
         LA    R01,1                   INITIALIZE FOR CR COMMAND
         ZAP   EXTCOUNT,=P'+0'         ZERO EXTENT COUNT
         LA    R06,EXTTAB              LOAD ADDR. OF EXTENT INFO. TABLE
LOOP1    EQU   *
         TM    0(R06),X'FF'            END OF TABLE ?
         BO    ENDLOOP                 BRANCH IF YES
         LA    R05,1(,R05)             INCREASE OUTPUT LINE COUNT
         MVI   MSGFLAG,X'00'           CLEAR FLAG
         MVC   MESSAGE(MSG04LEN),MSG04 MOVE MESSAGE SKELETON
         C     R10,ADDRETB1            FIRST LINE IN MESSAGE ?
         BNE   LOOP2-8                 BRANCH IF NOT
         MVC   MS5VOLID,=C'VOLSER'     PREPARE
         MVC   MS5NOEXT,=C'NO'             HEAD LINE
         LA    R07,MS4EXT1-14          LOAD ADDRESS IN MESSAGE
         LA    R08,3                   INITIALIZE LOOP COUNT
LOOP2    EQU   *
         LA    R07,14(,R07)            LOAD NEXT ADDRESS IN MESSAGE
         AP    EXTCOUNT,=P'+1'         INCREASE EXTENT COUNT
         UNPK  0(2,R07),EXTCOUNT       STORE EXTENT COUNT
         OI    1(R07),C'0'             MODIFY SIGN
         BCT   R08,LOOP2               BRANCH
         LA    R10,68(,R10)            LOAD ADDR. OF NEXT TABLE ELEM.
         MVC   MESSAGE(MSG04LEN),MSG04 MOVE MESSAGE SKELETON
         MVC   MESSAGE+12(54),MESSAGE+11 CLEAR MESSAGE AREA
         MVI   MSGFLAG,X'00'           CLEAR FLAG
         CR    R05,R01                 SECOND OUTPUT LINE
         BNE   LOOP3-8                 BRANCH IF NOT
         MVC   MS5VOLID,UCBVOLI        MOVE VOLSER NUMBER
         LH    R04,NOEXT               LOAD NUMBER OF EXTENTS
         BAL   R14,CONVDEC             BRANCH TO CONVERT TO DECIMAL
         MVC   MS5NOEXT,WKAREA+13      MOVE NUMBER OF EXTENTS
         LA    R07,MS5EXT-14           LOAD ADDRESS IN MESSAGE
         LA    R08,3                   INITIALIZE LOOP COUNT
         EJECT
LOOP3    EQU   *
         LA    R07,14(,R07)            LOAD NEXT ADDRESS IN MESSAGE
         TM    0(R06),X'FF'            EXTENT DESCRIPTION AVAILABLE ?
         BZ    EOFLOOP3                BRANCH IF NOT
         ICM   R04,3,2(R06)            LOAD CC START ADDR. OF EXTENT
         BAL   R14,CONVDEC             BRANCH TO CONVERT TO DECIMAL
         MVC   0(3,R07),WKAREA+12      MOVE CC START ADDR. OF EXTENT
         MVI   3(R07),C'/'             INSERT SEPERATOR
         ICM   R04,3,4(R06)            LOAD HH START ADDR. OF EXTENT
         BAL   R14,CONVDEC             BRANCH TO CONVERT TO DECIMAL
         MVC   4(2,R07),WKAREA+13      MOVE HH START ADDR. OF EXTENT
         ICM   R04,3,6(R06)            LOAD CC END ADDRESS OF EXTENT
         BAL   R14,CONVDEC             BRANCH TO CONVERT TO DECIMAL
         MVC   7(3,R07),WKAREA+12      MOVE CC END ADDR. OF EXTENT
         MVI   10(R07),C'/'            INSERT SEPERATOR
         ICM   R04,3,8(R06)            LOAD HH END ADDR. OF EXTENT
         BAL   R14,CONVDEC             BRANCH TO CONVERT TO DECIMAL
         MVC   11(2,R07),WKAREA+13     MOVE HH END ADDR. OF EXTENT
         MVI   6(R07),C'-'
EOFLOOP3 EQU   *
         LA    R05,1(,R05)             INCREASE LINE COUNT
         LA    R06,10(,R06)            LOAD ADDRESS OF NEXT ELEMENT
         TM    0(R06),X'FF'            END OF TABLE ?
         BO    ENDLOOP                 BRANCH IF YES
         BCT   R08,LOOP3               BRANCH
         LA    R10,68(,R10)            LOAD ADDR. OF NEXT TABLE ELEM.
         B     LOOP1                   BRANCH
ENDLOOP  EQU   *
         L     R14,SAVE1R14            LOAD RETURN ADDRESS
         LA    R10,68(,R10)            LOAD ADDR. OF NEXT TABLE ELEM.
         C     R10,ADDRETB2            END OF TABLE ?
         BNL   OUTEXTM                 BRANCH IF YES
         TM    FLG2BYTE,FLG2ON         FULL DSNAME SPECIFIED ?
         BNZ   OUTEXTM1                BRANCH IF NOT
         ST    R10,SAVE2R10            STORE CURRENT ADDRESS
         BR    R14                     BRANCH
         EJECT
***********************************************************************
*                                                                     *
*      PROCESSING OF CREATION AND EXPIRATION DATE.                    *
*                                                                     *
***********************************************************************
         SPACE 3
DATEINFO EQU   *
         ST    R14,SAVE1R14            SAVE RETURN ADDRESS
         L     R10,SAVE3R10            INIT. BASE REGISTER
         MVI   MSGFLAG,X'00'           CLEAR FLAG
         MVC   MESSAGE(MSG05LEN),MSG05 MOVE MESSAGE SKELETON
         MVC   MS6VOLID,UCBVOLI        MOVE VOLSER NUMBER
         SR    R04,R04                 ZERO FOR IC COMMAND
         IC    R04,DS1CREDT            LOAD CREATION DATE (YEAR)
         BAL   R14,CONVDEC             BRANCH TO CONVERT TO DECIMAL
         MVC   MS6CREDT(2),WKAREA+13   MOVE YEAR
         IC    R04,DS1EXPDT            LOAD EXPIRATION DATE (YEAR)
         BAL   R14,CONVDEC             BRANCH TO CONVERT TO DECIMAL
         MVC   MS6EXPDT(2),WKAREA+13   MOVE YEAR
         ICM   R04,3,DS1CREDT+1        LOAD CREATION DATE (DAYS)
         BAL   R14,CONVDEC             BRANCH TO CONVERT TO DECIMAL
         MVC   MS6CREDT+3(3),WKAREA+12 MOVE DAYS
         ICM   R04,3,DS1EXPDT+1        LOAD EXPIRATION DATE (DAYS)
         BAL   R14,CONVDEC             BRANCH TO CONVERT TO DECIMAL
         MVC   MS6EXPDT+3(3),WKAREA+12 MOVE DAYS
         MVI   MS6EXPDT+2,C'.'         INSERT DECIMAL POINT
         MVI   MS6CREDT+2,C'.'         INSERT DECIMAL POINT
         L     R14,SAVE1R14            LOAD RETURN ADDRESS
         LA    R10,68(,R10)            LOAD ADDR. OF NEXT TABLE ELEM.
         C     R10,ADDRETB3            END OF TABLE ?
         BNL   OUTDATM                 BRANCH IF YES
         TM    FLG2BYTE,FLG2ON         FULL DSNAME SPECIFIED ?
         BNZ   OUTDATM1                BRANCH IF NOT
         ST    R10,SAVE3R10            STORE CURRENT ADDRESS
         BR    R14                     BRANCH
         EJECT
***********************************************************************
*                                                                     *
*      ERROR ROUTINES.                                                *
*                                                                     *
***********************************************************************
         SPACE 3
*
*      INPUT PARAMETER ERROR ROUTINE.
*
         SPACE 1
PRMERROR EQU   *
         L     R00,UCMID               LOAD UCM-ID.
         WTO   MF=(E,MSG08)            DISPLAY ERROR MESSAGE
         B     RETURN                  BRANCH
         SPACE 2
*
*      OBTAIN ERROR ROUTINE.
*
         SPACE 1
OBTERROR EQU   *
         TM    FLG2BYTE,FLG2ON         FULL DSNAME SPECIFIED ?
         BNZ   *+12                    BRANCH IF NOT
         CH    R15,=H'8'               DSCB1 NOT FOUND ?
         BE    NEXTUCB                 BRANCH IF YES
         LA    R10,ERRORTAB            INIT. BASE REGISTER
         MVC   MESSAGE(MSG10LEN),MSG10 MOVE MESSAGE SKELETON
         MVC   MS11VOLI,UCBVOLI        MOVE VOLSER NUMBER
         LR    R04,R15                 LOAD RETURN CODE
         BAL   R14,CONVDEC             BRANCH TO CONVERT TO DECIMAL
         MVC   MS11RC,WKAREA+13        MOVE RETURN CODE
         L     R00,UCMID               LOAD UCM-ID.
         WTO   MF=(E,MESSAGE)          DISPLAY MESSAGE
         TM    FLG2BYTE,FLG2ON         FULL DSNAME SPECIFIED ?
         BNZ   NXTDSCB                 BRANCH IF NOT
         B     NEXTUCB                 BRANCH IF YES
         EJECT
*
*      ROUTINE FOR RESERVED DEVICES.
*
         SPACE 1
DEVERROR EQU   *
         LA    R10,ERRORTAB            INIT. BASE REGISTER
         MVC   MESSAGE(MSG09LEN),MSG09 MOVE MESSAGE SKELETON
         UNPK  MS10DEVC(3),DEVCODE(2)  MOVE DEVICE CODE
         TR    MS10DEVC,TABHEXA-240    EDIT DEVICE CODE
         MVC   MS10VOLI,UCBVOLI        MOVE VOLSER NUMBER
         L     R00,UCMID               LOAD UCM-ID.
         WTO   MF=(E,MESSAGE)          DISPLAY MESSAGE
         B     NEXTUCB                 BRANCH
         SPACE 2
*
*      LOCATE ERROR ROUTINE.
*
         SPACE 1
LOCERROR EQU   *
         LA    R10,ERRORTAB            INIT. BASE REGISTER
         CH    R15,=H'8'               RETURN CODE = 8 ?
         BE    NONCATLG                BRANCH IF YES
         LTR   R05,R05                 CATALOG INFORMATION ?
         BZ    NONCATLG                BRANCH IF NOT
         MVC   MESSAGE(MSG11LEN),MSG11 MOVE MESSAGE SKELETON
         LR    R04,R15                 LOAD RETURN CODE
         BAL   R14,CONVDEC             BRANCH TO CONVERT TO DECIMAL
         MVC   MS12RC,WKAREA+13        MOVE RETURN CODE
WTOFMSG  EQU   *
         L     R00,UCMID               LOAD UCM-ID.
         WTO   MF=(E,MESSAGE)          DISPLAY MESSAGE
         L     R14,SAVE3R14            LOAD RETURN ADDRESS
         BR    R14                         AND BRANCH
NONCATLG EQU   *
         MVC   MESSAGE(MSG12LEN),MSG12 MOVE MESSAGE SKELETON
         B     WTOFMSG                 BRANCH
         EJECT
***********************************************************************
*                                                                     *
*      MESSAGE OUTPUT.                                                *
*                                                                     *
***********************************************************************
         SPACE 3
*
*      DISPLAY GENERAL INFORMATION MESSAGES.
*
         SPACE 1
OUTMSGM  EQU   *
         L     R00,UCMID               LOAD UCM-ID.
         WTO   MF=(E,HEADER)           DISPLAY HEAD LINE
         LH    R01,LINECNT             INCREASE
         LA    R01,1(,R01)                 OUTPUT
         STH   R01,LINECNT                 LINE COUNT
OUTMSGM1 EQU   *
         ST    R14,SAVE1R14            SAVE RETURN ADDRESS
         L     R00,UCMID               LOAD UCM-ID.
         WTO   MF=(E,MSG02)            DISPLAY 2. MESSAGE
         LH    R01,LINECNT             INCREASE
         LA    R01,1(,R01)                 OUTPUT
         STH   R01,LINECNT                 LINE COUNT
         LA    R10,MSGTAB-68           LOAD ADDRESS OF TABLE
         L     R09,ADDRETB1            LOAD END ADDRESS OF TABLE
         BAL   R14,OUTPUT              BRANCH TO DISPLAY SINGLE LINES
         LA    R10,MSGTAB              LOAD ADDRESS OF TABLE
         ST    R10,SAVE1R10                AND STORE IT
         L     R14,SAVE1R14            LOAD RETURN ADDRESS
         BR    R14                     BRANCH
         EJECT
*
*      DISPLAY EXTENT INFORMATION MESSAGES.
*
         SPACE 1
OUTEXTM  EQU   *
         L     R00,UCMID               LOAD UCM-ID.
         WTO   MF=(E,HEADER)           DISPLAY HEAD LINE
         LH    R01,LINECNT             INCREASE
         LA    R01,1(,R01)                 OUTPUT
         STH   R01,LINECNT                 LINE COUNT
OUTEXTM1 EQU   *
         ST    R14,SAVE1R14            SAVE RETURN ADDRESS
         LA    R10,EXTNTAB-68          LOAD ADDRESS OF TABLE
         LA    R09,DATETAB             LOAD END ADDRESS OF TABLE
         BAL   R14,OUTPUT              BRANCH TO DISPLAY SINGLE LINES
         LA    R10,EXTNTAB             LOAD ADDRESS OF TABLE
         ST    R10,SAVE2R10                AND STORE IT
         L     R14,SAVE1R14            LOAD RETURN ADDRESS
         BR    R14                     BRANCH
         EJECT
*
*      DISPLAY DATE INFORMATION MESSAGES.
*
         SPACE 1
OUTDATM  EQU   *
         L     R00,UCMID               LOAD UCM-ID.
         WTO   MF=(E,HEADER)           DISPLAY HEAD LINE
         LH    R01,LINECNT             INCREASE
         LA    R01,1(,R01)                 OUTPUT
         STH   R01,LINECNT                 LINE COUNT
OUTDATM1 EQU   *
         ST    R14,SAVE1R14            SAVE RETURN ADDRESS
         L     R00,UCMID               LOAD UCM-ID.
         WTO   MF=(E,MSG05)            DISPLAY 2. MESSAGE
         LH    R01,LINECNT             INCREASE
         LA    R01,1(,R01)                 OUTPUT
         STH   R01,LINECNT                 LINE COUNT
         LA    R10,DATETAB-68          LOAD ADDRESS OF TABLE
         L     R09,ADDRETB3            LOAD END ADDRESS OF TABLE
         BAL   R14,OUTPUT              BRANCH TO DISPLAY SINGLE LINES
         LA    R10,DATETAB             LOAD ADDRESS OF TABLE
         ST    R10,SAVE3R10                AND STORE IT
         L     R14,SAVE1R14            LOAD RETURN ADDRESS
         BR    R14                     BRANCH
         EJECT
*
*      DISPLAY SINGLE LINES.
*
         SPACE 1
OUTPUT   EQU   *
         ST    R14,SAVE2R14            SAVE RETURN ADDRESS
         LH    R04,LINECNT             LOAD OUTPUT LINE COUNT
NEXTMSG  EQU   *
         LA    R10,68(,R10)            LOAD ADDR. OF NEXT TABLE ELEM.
         CR    R10,R09                 END OF TABLE ?
         BNL   ENDMSG                  BRANCH IF YES
         CLI   MSGFLAG,X'FF'           END OF TABLE ?
         BE    ENDMSG                  BRANCH IF YES
         MVI   MSGFLAG,X'FF'           SET FLAG
         L     R00,UCMID               LOAD UCM-ID.
         WTO   MF=(E,MESSAGE)          DISPLAY ONE MESSAGE
         LA    R04,1(,R04)             INCREASE OUTPUT LINE COUNT
         B     NEXTMSG                 BRANCH
ENDMSG   EQU   *
         STH   R04,LINECNT             STORE OUTPUT LINE COUNT
         CH    R04,=H'10'              MORE THAN 10 LINES DISPLAYED ?
         BL    ENDMSG1                 BRANCH IF NOT
         TM    FLG1BYTE,FLG1WTOR       WTOR LINE OUTPUT ?
         BZ    ENDMSG1                 BRANCH IF NOT
         XC    LINECNT,LINECNT         ZERO OUTPUT LINE COUNT
NXTREPLY EQU   *
         XC    ECB,ECB                 CLEAR EVENT CONTROL BLOCK
         MVI   REPLY,C' '              CLEAR REPLY AREA
         L     R00,UCMID               LOAD UCM ID. OF CALLER
         LA    R04,ECB                 LOAD ADDRESS OF ECB
         LA    R05,REPLY               LOAD ADDRESS OF REPLY
         WTOR  ,(R05),1,(R04),MF=(E,WTOR)
         WAIT  ECB=ECB                 WAIT FOR COMPLETION
         CLI   REPLY,C'N'              REPLY = NO ?
         BE    ENDPROC                 BRANCH IF YES
         CLI   REPLY,C'Y'              REPLY = YES ?
         BNE   NXTREPLY                BRANCH IF NOT
ENDMSG1  EQU   *
         L     R14,SAVE2R14            LOAD RETURN ADDRESS
         BR    R14                     BRANCH
         EJECT
***********************************************************************
*                                                                     *
*      FILL EXTENT INFORMATION TABLE.                                 *
*                                                                     *
***********************************************************************
         SPACE 3
GETEXT   EQU   *
         ST    R14,SAVE2R14            SAVE RETURN ADDRESS
         SR    R04,R04                 ZERO FOR IC COMMAND
         IC    R04,DS1NOEPV            INSERT NUMBER OF EXTENTS
         STH   R04,NOEXT                   AND STORE IT
         LA    R06,EXTTAB-10           LOAD ADDR. OF EXTENT INFO. TABLE
         SR    R05,R05                 ZERO REGISTER
         SPACE 2
*
*      GET THE FIRST THREE EXTENTS DESCRIPTIONS.
*
         SPACE 1
         LA    R07,DS1EXT1-10          LOAD ADDR. OF EXTENT DESCR.
         LA    R01,3                   MAX. NUMBER OF EXTENT DESCR.
         BAL   R14,NXTEXT              BRANCH TO MOVE EXTENT DESCR.
         CR    R05,R04                 NO EXTENT DESCR. LEFT ?
         BNL   ENDEXT                  BRANCH IF YES
         SPACE 2
*
*      GET THE FOLLOWING FOUR EXTENT DESCRIPTIONS.
*
         SPACE 1
         MVC   CCHHR,DS1PTRDS          MOVE ADDRESS OF NEXT DSCB
         OBTAIN CAMSEEK                OBTAIN NEXT DSCB
         LTR   R15,R15                 RETURN CODE = 0 ?
         BNZ   OBTERROR                IF NOT, BRANCH TO ERROR ROUTINE
         CLI   DS2FMTID,C'2'           DSCB = DSCB2 ?
         BNE   DSCB3OK                 BRANCH IF NOT
         MVC   CCHHR,DS2PTRDS          MOVE ADDRESS OF NEXT DSCB
         OBTAIN CAMSEEK                OBTAIN NEXT DSCB
         LTR   R15,R15                 RETURN CODE = 0 ?
         BNZ   OBTERROR                IF NOT, BRANCH TO ERROR ROUTINE
         EJECT
DSCB3OK  EQU   *
         LA    R15,99                  SET RETURN CODE
         CLI   DS3FMTID,C'3'           DSCB = DSCB3 ?
         BNE   OBTERROR                BRANCH IF NOT
         LA    R07,DS3EXTNT-10         LOAD ADDRESS OF EXTENT DESCR.
         LA    R01,7                   MAX. NUMBER OF EXTENT DESCR.
         BAL   R14,NXTEXT              BRANCH TO MOVE EXTENT DESCR.
         CR    R05,R04                 NO EXTENT DESCR. LEFT ?
         BNL   ENDEXT                  BRANCH IF YES
         SPACE 2
*
*      GET THE LAST NINE EXTENT DESCRIPTIONS.
*
         SPACE 1
         LA    R07,DS3ADEXT-10         LOAD ADDRESS OF EXTENT DESCR.
         LA    R01,16                  MAX. NUMBER OF EXTENT DESCR.
         BAL   R14,NXTEXT              BRANCH TO MOVE EXTENT DESCR.
         SPACE 2
ENDEXT   EQU   *
         CR    R05,R04                 ALL EXTENT DESCR. MOVED ?
         BH    *+8                     BRANCH IF YES
         LA    R06,10(,R06)            ELSE INCREASE ADDRESS IN TABLE
         MVI   0(R06),X'FF'            SPECIFY TABLE END
         L     R14,SAVE2R14            LOAD RETURN ADDRESS
         BR    R14                     BRANCH
         SPACE 2
*
*      MOVE EXTENT DESCRIPTIONS INTO TABLE.
*
         SPACE 1
NXTEXT   EQU   *
         LA    R05,1(,R05)             INCREASE NO. OF EXTENT DESCR.
         LA    R06,10(,R06)            LOAD ADDRESS OF NEXT ELEMENT
         LA    R07,10(,R07)            LOAD ADDR. OF NEXT EXT. DESCR.
         CR    R05,R04                 NO EXTENT DESCR. LEFT ?
         BHR   R14                     BRANCH IF YES
         MVC   0(10,R06),0(R07)        MOVE EXTENT DESCRIPTION
         CR    R05,R01                 EXTENT DESCR. LEFT ?
         BL    NXTEXT                  BRANCH IF YES
         BR    R14                     BRANCH IF NOT
         EJECT
***********************************************************************
*                                                                     *
*      COMPUTE SIZE OF A SINGLE EXTENT.                               *
*                                                                     *
***********************************************************************
         SPACE 3
EXT1LEN  EQU   *
         MVC   DBWORD,DS1EXT1+2        MOVE EXTENT DESCRIPTION
         LH    R04,DBWORD              LOAD CC START ADDRESS OF EXTENT
         LH    R05,DBWORD+2            LOAD HH START ADDRESS OF EXTENT
         LH    R06,DBWORD+4            LOAD CC END ADDRESS OF EXTENT
         LH    R07,DBWORD+6            LOAD HH END ADDRESS OF EXTENT
         CR    R07,R05                 HH END ADDR. > HH START ADDR. ?
         BNL   ADDROK                  BRANCH IF YES
         BCTR  R06,0                   ELSE DECREASE CC END ADDRESS
         AH    R07,TABELEM                 AND INCREASE HH END ADDRESS
ADDROK   EQU   *
         SR    R06,R04                 COMPUTE NUMBER OF CYLINDERS
         LA    R07,1(,R07)             COMPUTE NUMBER
         SR    R07,R05                     OF TRACKS
         BR    R14                     BRANCH
         EJECT
***********************************************************************
*                                                                     *
*      CONVERT BINARY TO UNPACKED DECIMAL NUMBERS.                    *
*                                                                     *
***********************************************************************
         SPACE 3
CONVDEC  EQU   *
         CVD   R04,DBWORD              CONVERT TO DECIMAL
         UNPK  WKAREA,DBWORD           UNPACK
         OI    WKAREA+14,C'0'          MODIFY SIGN
         BR    R14                     BRANCH
         SPACE 3
***********************************************************************
*                                                                     *
*      SHIFT LEFT TO SUPPRESS BLANKS.                                 *
*                                                                     *
***********************************************************************
         SPACE 3
SHFTLOOP EQU   *
         CLI   0(R06),C' '             BLANK IN THIS PLACE ?
         BNE   NEXTCHAR                BRANCH IF NOT
         EX    R04,SHIFT               ELSE BRANCH TO SHIFT
         B     SHFTCNT                 BRANCH
NEXTCHAR EQU   *
         LA    R06,1(,R06)             LOAD ADDRESS OF NEXT CHARACTER
SHFTCNT  EQU   *
         BCT   R04,SHFTLOOP            BRANCH TO LOOP
         BR    R14                     RETURN
         EJECT
***********************************************************************
*                                                                     *
*      COMMANDS ISSUED BY EX COMMAND.                                 *
*                                                                     *
***********************************************************************
         SPACE 3
MOVEPNAM MVC   DSNAME(0),0(R04)        MOVE DATA SET NAME
MOVEPVOL MVC   1(0,R06),0(R04)         MOVE VOLSER NUMBER
NCVOLID1 NC    WKVOLID1(0),1(R06)      NC VOLID'S
OCVOLID2 OC    WKVOLID2(0),1(R07)      OC VOLID'S
TMDSORG  TM    0(R09),X'00'            DSORG FIELD = TABLE ELEMENT ?
SHIFT    MVC   0(0,R06),1(R06)         SHIFT LEFT
TRT      TRT   0(0,R04),TRTTABLE       FIND SEPERATORS
TESTNAME CLC   DS1DSNAM(0),DSNAME      TEST DATA SET NAME
         SPACE 3
***********************************************************************
*                                                                     *
*      REGISTER EQUATES.                                              *
*                                                                     *
***********************************************************************
         SPACE 3
R00      EQU   0                       MACRO AND PARAMETER REGISTER
R01      EQU   1                       MACRO AND PARAMETER REGISTER
R02      EQU   2                       PTR. IN CVT / UCB LOOKUP TABLE
R03      EQU   3                       BASE REGISTER OF UCB
R04      EQU   4                       WORK REGISTER
R05      EQU   5                       WORK REGISTER
R06      EQU   6                       WORK REGISTER
R07      EQU   7                       WORK REGISTER
R08      EQU   8                       WORK REGISTER
R09      EQU   9                       BASE REG. OF PARMAREA / VECTOR
R10      EQU   10                      POINTER IN MESSAGE TABLES
R11      EQU   11                      1. BASE REGISTER OF CSECT
R12      EQU   12                      2. BASE REGISTER OF CSECT
R13      EQU   13                      BASE REGISTER OF WORKAREA
R14      EQU   14                      RETURN ADDRESSES
R15      EQU   15                      CSECT ADDRESSES AND RETURN CODES
         EJECT
***********************************************************************
*                                                                     *
*      CONSTANTS.                                                     *
*                                                                     *
***********************************************************************
         SPACE 3
*
*      TRANSLATE TABLES.
*
         SPACE 1
TABHEXA  DC    C'0123456789ABCDEF'
         SPACE 1
TRTTABLE DC    64X'00',C' ',42X'00',C',',148X'00'
TRTCOMMA EQU   TRTTABLE+107
         SPACE 1
TRTABLE  DC    X'000102030405060708090A0B0C0D0E0F'
         DC    X'101112131415161718191A1B1C1D1E1F'
         DC    X'202122232425262728292A2B2C2D2E2F'
         DC    X'303132333435363738393A3B3C3D3E3F'
         DC    X'404142434445464748494A4B4C4D4E4F'
         DC    X'505152535455565758595A5BFF5D5E5F' X'5C' -> X'FF'
         DC    X'606162636465666768696A6B6C6D6E6F'
         DC    X'707172737475767778797A7B7C7D7E7F'
         DC    X'808182838485868788898A8B8C8D8E8F'
         DC    X'909192939495969798999A9B9C9D9E9F'
         DC    X'A0A1A2A3A4A5A6A7A8A9AAABACADAEAF'
         DC    X'B0B1B2B3B4B5B6B7B8B9BABBBCBDBEBF'
         DC    X'C0C1C2C3C4C5C6C7C8C9CACBCCCDCECF'
         DC    X'D0D1D2D3D4D5D6D7D8D9DADBDCDDDEDF'
         DC    X'E0E1E2E3E4E5E6E7E8E9EAEBECEDEEEF'
         DC    X'F0F1F2F3F4F5F6F7F8F9FAFBFCFDFE00' X'FF' -> X'00'
         SPACE 2
*
*      MASKS FOR UPDATE OF DCB AND ALLOCATION INFORMATIONS.
*
         SPACE 1
CONDCBIN DC    C'*   ,U   ,*    ,*     '
CONALLOC DC    C'*     ,(*    ,*    ) '
         EJECT
*
*      TRACKS / CYLINDER ON DASD DEVICES.
*
         SPACE 1
TABTCAP  DS    0H
         DC    X'8000'       00 - RESERVED
         DC    H'10'         01 - 2311    DISK STORAGE DEVICE
         DC    H'08'         02 - 2301    PARALLEL DRUM
         DC    H'10'         03 - 2303    SERIAL DRUM
         DC    H'46'         04 - 2302    DISK STORAGE
         DC    H'20'         05 - 2321    DATA CELL DRIVE
         DC    H'08'         06 - 2305/1  FIXED HEAD STORAGE / MODEL 1
         DC    H'08'         07 - 2305/2  FIXED HEAD STORAGE / MODEL 2
         DC    H'20'         08 - 2314    DISK STORAGE FACILITY
         DC    H'19'         09 - 3330/1  DISK STORAGE / MODEL 1
         DC    H'12'         0A - 3340    DISK STORAGE
         DC    H'30'         0B - 3350    DISK STORAGE
         DC    X'8000'       0C - RESERVED
         DC    H'19'         0D - 3330/11 DISK STORAGE / MODEL 11
         DC    X'8000'       0E - RESERVED
         DC    X'8000'       0F - RESERVED
         SPACE 2
*
*      DSORG BIT AND TEXT TABLE.
*
         SPACE 1
TB1DSORG EQU   *
         DC    X'80',C'IS'   INDEXED SEQUENTIAL ORGANISATION
         DC    X'40',C'PS'   PHYSICAL SEQUENTIAL ORGANISATION
         DC    X'20',C'DA'   DIRECT ORGANISATION
         DC    X'10',C'CX'   BTAM OR QTAM LINE GROUP
         DC    X'08',C'CQ'   QTAM DIRECT ACCESS MESSAGE QUEUE
         DC    X'04',C'MQ'   QTAM PROBLEM PROGRAM MESSAGE QUEUE
         DC    X'02',C'PO'   PARTITIONED ORGANISATION
         DC    X'01',C'U '   UNMOVABLE
         DC    X'FF'         TABLE END
TB2DSORG EQU   *
         DC    X'80',C'GS'   GRAPHICS ORGANISATION
         DC    X'40',C'TX'   TCAM LINE GROUP
         DC    X'20',C'TQ'   TCAM MESSAGE QUEUE
TB2VSAM  DC    X'08',C'VS'   ACB (VSAM)
         DC    X'04',C'TR'   TCAM 3705
         DC    X'00'         TABLE END
         EJECT
***********************************************************************
*                                                                     *
*      MESSAGE SKELETONS.
*                                                                     *
***********************************************************************
         SPACE 3
MSG00    WTO   'XSHOW00 DSN=                                           *
                ',                                                     *
               MF=L,MCSFLAG=(REG0)
MSG00LEN EQU   *-MSG00
         SPACE 1
MSG01    WTO   'XSHOW01 CATALOG ON 123456 POINTS TO:                   *
                      ',                                               *
               MF=L,MCSFLAG=(REG0)
MSG01LEN EQU   *-MSG01
         SPACE 1
MSG02    WTO   'XSHOW02 VOLSER ADR --ALLOCATED-- TRKS USED DCB-INFORMAT*
               ION  M',                                                *
               MF=L,MCSFLAG=(REG0)
MSG02LEN EQU   *-MSG02
         SPACE 1
MSG03    WTO   'XSHOW02 123456 123 --ALLOCATED-- **** ****             *
                      ',                                               *
               MF=L,MCSFLAG=(REG0)
MSG03LEN EQU   *-MSG03
         EJECT
MSG04    WTO   'XSHOW04           --EXTENT01--- --EXTENT02--- --EXTENT0*
               3---',                                                  *
               MF=L,MCSFLAG=(REG0)
MSG04LEN EQU   *-MSG04
         SPACE 1
MSG05    WTO   'XSHOW05 VOLSER CREDTE EXPDTE',                         *
               MF=L,MCSFLAG=(REG0)
MSG05LEN EQU   *-MSG05
         SPACE 1
MSG06    WTO   'XSHOW06 SPECIFIED DATA SET NOT FOUND',                 *
               MF=L,MCSFLAG=(REG0)
MSG06LEN EQU   *-MSG06
         SPACE 1
MSG07    WTO   'XSHOW07 END OF PROCESSING',                            *
               MF=L,MCSFLAG=(REG0)
MSG07LEN EQU   *-MSG07
         SPACE 1
MSG08    WTO   'XSHOW08 ERROR IN  PARAMETER LIST',                     *
               MF=L,MCSFLAG=(REG0)
MSG08LEN EQU   *-MSG08
         EJECT
MSG09    WTO   'XSHOW09 VOLSER=123456, DEVICE FAILURE, DEVCODE=99',    *
               MF=L,MCSFLAG=(REG0)
MSG09LEN EQU   *-MSG09
         SPACE 1
MSG10    WTO   'XSHOW10 VOLSER=123456, OBTAIN FAILURE, RC=99',         *
               MF=L,MCSFLAG=(REG0)
MSG10LEN EQU   *-MSG10
         SPACE 1
MSG11    WTO   'XSHOW11 LOCATE FAILURE, RC=99',                        *
               MF=L,MCSFLAG=(REG0)
MSG11LEN EQU   *-MSG11
         SPACE 1
MSG12    WTO   'XSHOW12 SPECIFIED DATA SET IS NOT CATALOGED',          *
               MF=L,MCSFLAG=(REG0)
MSG12LEN EQU   *-MSG12
         SPACE 1
MSG13    WTOR  'XSHOW13 REPLY ''Y'' (YES) OR ''N'' (NO) TO CONTINUE',  *
               MF=L,MCSFLAG=(REG0)
MSG13LEN EQU   *-MSG13
         EJECT
         LTORG
         EJECT
***********************************************************************
*                                                                     *
*      WORK AREAS.                                                    *
*                                                                     *
***********************************************************************
         SPACE 3
WORKAREA DSECT
SAVEAREA DS    18F                     SAVEAREA OF GENERAL REGISTERS
         SPACE 2
*
*      ADDRESS AREAS.
*
         SPACE 1
ADDRETB1 DS    F                       END ADDRESS OF MESSAGE TABLE 1
ADDRETB2 DS    F                       END ADDRESS OF MESSAGE TABLE 2
ADDRETB3 DS    F                       END ADDRESS OF MESSAGE TABLE 3
ADDRETPV DS    F                       END ADDRESS OF VOLSER TABLE
SAVE1R10 DS    F                       SAVEAREA 1 OF R10
SAVE2R10 DS    F                       SAVEAREA 2 OF R10
SAVE3R10 DS    F                       SAVEAREA 3 OF R10
SAVE1R14 DS    F                       SAVEAREA 1 OF R14
SAVE2R14 DS    F                       SAVEAREA 2 OF R14
SAVE3R14 DS    F                       SAVEAREA 3 OF R14
UCBADDR  DS    F                       ADDRESS OF UCB ADDR. VECTOR
         SPACE 2
*
*      MULTI CONTROL FLAG BYTES.
*
         SPACE 1
FLG1BYTE DS    C                       FLAG BYTE 1
FLG1INIT EQU   B'00000000'             INITIAL VALUE
FLG1INFO EQU   B'11110000'             INFORMATION PARAMETERS
FLG1GIN  EQU   B'10000000'             GENERAL INFORMATION
FLG1GINC EQU   B'10010000'             GENERAL AND CATALOG INFORMATION
FLG1EXT  EQU   B'01000000'             EXTENT INFORMATION
FLG1DATE EQU   B'00100000'             DATE INFORMATION
FLG1CAT  EQU   B'00010000'             CATALOG INFORMATION
FLG1VOL  EQU   B'00001000'             SPECIFIC VOLSER
FLG1WTOR EQU   B'00000100'             WTOR MESSAGE OUTPUT
FLG1NWTO EQU   B'11111011'             NO WTOR MESSAGE OUTPUT
FLG1FND  EQU   B'00000010'             DATA SET(S) FOUND
         SPACE 1
FLG2BYTE DS    C                       FLAG BYTE 2
FLG2RACF EQU   B'10000000'             RACF PROTECTION
FLG2PWRD EQU   B'01000000'             PASSWORD PROTECTION
FLG2NOPW EQU   B'00100000'             NO PASSWORD READ PROTECTION
FLG2INLV EQU   B'00010000'             SHOW - INDEX LEVEL
FLG2PROT EQU   B'11100000'             PROTECTION
FLG2ON   EQU   B'11110000'             FLAG ON
FLG2INIT EQU   B'00000000'             INITIAL VALUE
         EJECT
*
*      WORK SPACES.
*
         SPACE 1
DBWORD   DS    D                       CVD WORK AREA
ECB      DS    F                       EVENT CONTROL BLOCK
UCMID    DS    F                       UCM ID OF CALLER
CCNO     DS    F                       COUNT OF ALLOCATED CYLINDERS
HHNO     DS    F                       COUNT OF ALLOCATED TRACKS
DSNMLEN  DS    H                       LENGTH OF SPECIFIED NAME
NOEXT    DS    H                       NUMBER OF EXTENTS
TABELEM  DS    H                       ELEMENT OF TABTCAP
LINECNT  DS    H                       OUTPUT LINE COUNT
EXTCOUNT DS    CL2                     DECIMAL COUNT
         DS    0H
CCHHR    DS    CL5                     CCHHR ADDRESS OF NEXT DSCB
WKAREA   DS    CL15                    DECIMAL WORK AREA
VOLSERNO DS    CL6                     VOLSER WORK AREA
WKVOLID1 DS    CL6                     VOLSER WORK AREA
WKVOLID2 DS    CL6                     VOLSER WORK AREA
REPLY    DS    C                       REPLY AREA
WRKDCBIN DS    0CL22                   DCB INFORMATION
WRKDSORG DS    CL2                     DATA SET ORGANISATION (PART 1)
         DS    CL2                     DATA SET ORGANISATION (PART 2)
         DS    C                       SEPERATOR
WRKRECFM DS    CL4                     RECORD FORMAT
WRKBLKSI DS    CL6                     BLOCK SIZE
WRKLRECL DS    CL6                     RECORD LENGTH
         DS    C
WRKSHFTL EQU   *-WRKDCBIN-2            SHIFT LENGTH
WRKALLOC DS    0CL21                   ALLOCATION-INFORMATIONEN
WRKALTYP DS    CL6                     ALLOCATION TYPE
         DS    C                       SEPERATOR
WRKPRMAL DS    CL6                     PRIMARY ALLOCATION QUANTITY
WRKSECAL DS    CL6                     SECONDARY ALLOCATION QUANTITY
         DS    CL2
WRKASLEN EQU   *-WRKALLOC-2            SHIFT LENGTH
MDS1ADDR DS    3H                      HIGHEST DISK ADDR. OF DSCB1
         ORG   MDS1ADDR
MDS1CC   DS    H                       MAX. CYLINDER NUMBER (DS4HPCR)
MDS1HH   DS    H                       MAX. HEADER NUMBER (DS4HPCR+2)
MDS1R    DS    H                       MAX. RECORD NUMBER (DS4HPCR+4)
MCURADDR DS    2H                      MAX. CURRENT ADDRESS
         ORG   MCURADDR
MTRKNO   DS    H                       MAX. HEADER NUMBER (DS4DEVSZ+2)
MRECNO   DS    H                       MAX. RECORD NUMBER (DS4DEVT)
CURADDR  DS    3H                      CURRENT ADDRESS
         ORG   CURADDR
CURCYLNO DS    H                       CURRENT CYLINDER NUMBER
CURTRKNO DS    H                       CURRENT HEADER NUMBER
CURRECNO DS    H                       CURRENT RECORD NUMBER
         EJECT
*
*      CAMLIST MACROS (WORK AREA).
*
         SPACE 1
CAMSEEK  DS    0F
         DS    C                       AL1(192)
         DS    C                       AL1(128)
         DS    C                       AL1(0)
         DS    C                       AL1(0)
CADRCCHH DS    F                       A(CCHHR)
CADRUCBV DS    F                       A(VOLSERNO)
CADRCAMW DS    F                       A(OBTWKFLD)
         SPACE 1
CAMSRCH  DS    0F
         DS    C                       AL1(193)
         DS    C                       AL1(0)
         DS    C                       AL1(0)
         DS    C                       AL1(0)
CADRDSN  DS    F                       A(DSNAME)
CADUCBVO DS    F                       A(VOLSERNO)
CADCAMWK DS    F                       A(OBTWKFLD+44)
         SPACE 1
CAMNAME  DS    0F
         DS    C                       AL1(68)
         DS    C                       AL1(0)
         DS    C                       AL1(0)
         DS    C                       AL1(0)
CAMDSN   DS    F                       A(DSNAME)
         DS    F                       A(0)
CAMCWK   DS    F                       A(LOCWKFLD)
         SPACE 1
OBTWKFLD DS    CL140                   OBTAIN WORK AREA
         DS    0D
LOCWKFLD DS    CL265                   LOCATE WORK AREA
ENDCAMWK EQU   *
         EJECT
*
*      DATA SET CONTROL BLOCK FORMAT 1.
*
         SPACE 1
         ORG   OBTWKFLD
DSCB1    DS    0CL140
DS1DSNAM DS    CL44                    DATA SET NAME
DS1FMTID DS    C                       FORMAT IDENTIFIER (= C'1')
         DS    CL8
DS1CREDT DS    CL3                     CREATION DATE (YDD)
DS1EXPDT DS    CL3                     EXPIRATION DATE (YDD)
DS1NOEPV DS    C                       NO. OF SEPERATE EXTENTS
         DS    CL22
DS1DSORG DS    CL2                     DATA SET ORGANISATION
DS1RECFM DS    C                       DATA SET RECORD FORMAT
         DS    C
DS1BLKL  DS    CL2                     DATA SET BLOCK LENGTH
DS1LRECL DS    CL2                     DATA SET RECORD LENGTH
         DS    CL3
DS1DSIND DS    C                       DATA SET INDICATORS
DS1LVOL  EQU   X'80'                   LAST VOLUME
DS1RACF  EQU   X'C0'                   RACF PROTECTION
DS1PSWD  EQU   X'90'                   PASSWORD PROTECTION
DS1NOPWR EQU   X'94'                   NO PASSWORD READ PROTECTION
DS1OSPW  EQU   X'10'                   OS PASSWORD PROTECTION
DS1OSNPW EQU   X'10'                   OS NO PASSWORD READ PROTECTION
DS1SCALO DS    CL4                     ALLOCATION PARAMETERS
DS1LSTAR DS    CL3                     LAST BLOCK POINTER (TTR
DS1TRBAL DS    CL2                                         LL)
         DS    CL2
DS1EXT1  DS    3CL10                   DESCRIPTION OF EXTENT1 - EXTENT3
DS1PTRDS DS    CL5                     POINTER TO NEXT DSCB (CCHHR)
DS1CCHHR DS    CL5                     POINTER TO DSCB1 (CCHHR)
         EJECT
*
*      DATA SET CONTROL BLOCK FORMAT 2.
*
         SPACE 1
         ORG   OBTWKFLD
DSCB2    DS    0CL140
         DS    CL44
DS2FMTID DS    C                       FORMAT IDENTIFIER (=C'2')
         DS    CL90
DS2PTRDS DS    CL5                     POINTER TO DSCB3 (CCHHR)
         SPACE 2
*
*      DATA SET CONTROL BLOCK FORMAT 3.
*
         SPACE 1
         ORG   OBTWKFLD
DSCB3    DS    0CL140
         DS    CL4
DS3EXTNT DS    4CL10                   DESCRIPTION OF EXTENT4 - EXTENT7
DS3FMTID DS    C                       FORMAT IDENTIFIER (=C'3')
DS3ADEXT DS    9CL10                   DESCRIPTION OF EXTENT8 -EXTENT16
         SPACE 2
*
*      DATA SET CONTROL BLOCK FORMAT 4.
*
         SPACE 1
         ORG   OBTWKFLD
DSCB4    DS    0CL140
         DS    CL44
DS4FMTID DS    C                       FORMAT IDENTIFIER (=C'4')
DS4HPCR  DS    CL5                     HIGH DISK ADDR OF DSCB1
         DS    CL12
DS4DEVSZ DS    CL4                     DEVICE SIZE
         DS    CL8
DS4DEVT  DS    C                       NO. OF DSCB'S ON A TRACK
         ORG   ENDCAMWK
         EJECT
*
*      PARAMETER VOLSER TABLE.
*
*      BYTE1 - LENGTH OF PARAMETER VOLSER OR
*          X'80' IF END OF TABLE
*      BYTES2-7 - PARAMETER VOLSER NUMBER
*
         SPACE 1
TABPVOL1 DS    10CL7                   TABLE WITH MASK X'FF'
ENDTPVOL EQU   *
         DS    CL7
TABPVOL2 DS    CL77                    TABLE WITH MASK X'00'
         SPACE 2
*
*      EXTENT INFORMATION TABLE.
*
*      BYTE1: DATA SET EXTENT TYPE INDICATOR, X'FF' IF END OF TABLE
*      BYTE2: EXTENT SEQUENCE NUMBER
*      BYTE3-6: LOWER LIMIT OF THIS EXTENT (CCHH)
*      BYTE7-10: UPPER LIMIT OF THIS EXTENT (CCHH)
*
         SPACE 1
EXTTAB   DS    17CL10
         SPACE 2
*
*      MESSAGE TABLES.
*
*      BYTE1-66: WTO MESSAGE LINE
*      BYTE67:   X'00', IF MESSAGE AVAILABLE
*      BYTE68:   RESERVED
*
         SPACE 1
         DS    0F
MSGTAB   DS    10CL68                  TABLE OF GENERAL INFO. MESSAGES
ENDTAB1  EQU   *
EXTNTAB  DS    10CL68                  TABLE OF EXTENT INFO. MESSAGES
ENDTAB2  EQU   *
         DS    7CL68                   EXTENT OF EXTNTAB
DATETAB  DS    10CL68                  TABLE OF DATE INFO. MESSAGES
ENDTAB3  EQU   *
ERRORTAB DS    CL68                    ERROR MESSAGE TABLE
HEADER   DS    0CL66                   HEAD LINE
         DS    CL16
DSNAME   DS    CL44                    DATA SET NAME
         ORG   HEADER+66
WTOR     DS    15F                     WTOR LINE
         SPACE 1
WORKLEN  EQU   *-WORKAREA              LENGTH OF WORK AREA
         EJECT
***********************************************************************
*                                                                     *
*      MESSAGE DESCRIPTIONS.                                          *
*                                                                     *
***********************************************************************
         SPACE 3
MESSAGE  DSECT
         SPACE 2
*
*      DESCRIPTIONS OF MSG01.
*
         SPACE 1
         ORG   MESSAGE+4
         DS    CL8
MS0VOL1  EQU   *
         DS    CL11
MS0CVOL  DS    CL6                     CATALOG VOLUME SERIAL NUMBER
         DS    CL12
MS0VOL2  EQU   *
         SPACE 2
*
*      DESCRIPTIONS OF MSG03.
*
         SPACE 1
         ORG   MESSAGE+4
         DS    CL8
MS3VOLID DS    CL6                     VOLUME SERIAL NUMBER
         DS    C
MS3ADR   DS    CL3                     UNIT ADDRESS
         DS    C
MS3ALLOC DS    CL13                    ALLOCATION INFORMATION
         DS    C
MS3TRKS  DS    CL4                     ALLOCATED TRACKS
         DS    C
MS3USED  DS    CL4                     USED TRACKS
         DS    C
MS3DCBIN DS    CL17                    DCB INFORMATION
MS3MARK  DS    CL2                     MARK OF PROTECTION
         EJECT
*
*      DESCRIPTIONS OF MSG04.
*
         SPACE 1
         ORG   MESSAGE+4
         DS    CL8
MS4VOLID DS    CL6                     VOLUME SERIAL NUMBER
         DS    C
MS4NOEXT DS    CL2                     NUMBER OF SEPERATE EXTENTS
         DS    CL9
MS4EXT1  DS    CL2                     EXTENT NUMBER
         DS    CL12
MS4EXT2  DS    CL2                     EXTENT NUMBER
         DS    CL12
MS4EXT3  DS    CL2                     EXTENT NUMBER
         SPACE 2
*
*      DESCRIPTIONS OF MSG04.
*
         SPACE 1
         ORG   MESSAGE+4
         DS    CL8
MS5VOLID DS    CL6                     VOLUME SERIAL NUMBER
         DS    C
MS5NOEXT DS    CL2                     NUMBER OF SEPERATE EXTENTS
         DS    C
MS5EXT   DS    3CL14                   EXTENT DESCRIPTION
         SPACE 2
*
*      DESCRIPTIONS OF MSG05.
*
         SPACE 1
         ORG   MESSAGE+4
         DS    CL8
MS6VOLID DS    CL6                     VOLUME SERIAL NUMBER
         DS    C
MS6CREDT DS    CL6                     CREATION DATE
         DS    C
MS6EXPDT DS    CL6                     EXPIRATION DATE
         EJECT
*
*      DESCRIPTIONS OF MSG09.
*
         SPACE 1
         ORG   MESSAGE+4
         DS    CL15
MS10VOLI DS    CL6                     VOLUME SERIAL NUMBER
         DS    CL26
MS10DEVC DS    CL2                     DEVICE CODE
         SPACE 2
*
*      DESCRIPTIONS OF MSG10.
*
         SPACE 1
         ORG   MESSAGE+4
         DS    CL15
MS11VOLI DS    CL6                     VOLUME SERIAL NUMBER
         DS    CL21
MS11RC   DS    CL2                     RETURN CODE
         SPACE 2
*
*      DESCRIPTIONS OF MSG11.
*
         SPACE 1
         ORG   MESSAGE+4
         DS    CL27
MS12RC   DS    CL2                     RETURN CODE
         SPACE 2
         ORG   MESSAGE+66
MSGFLAG  DS    C                       FLAG BYTE
         EJECT
***********************************************************************
*                                                                     *
*      UCB DESCRIPTIONS.                                              *
*                                                                     *
***********************************************************************
         SPACE 3
UCB      DSECT
         DS    CL3
DEVSTAT  DS    C                       DEVICE STATUS
         DS    CL9
UCBNAME  DS    CL3                     UNIT NAME
UCBTYPE  DS    CL2                     DEVICE TYPE
UCBDVCLS DS    C                       DEVICE CLASS
DEVCODE  DS    C                       DEVICE CODE
         DS    CL4
UCBVTOC  DS    CL4                     REL. ADDR. OF VTOC FOR THIS VOL.
UCBVOLI  DS    CL6                     VOLUME SERIAL NUMBER
UCBSTAB  DS    C                       VOLUME STATUS
         SPACE 3
***********************************************************************
*                                                                     *
*      PARAMETER AREA.                                                *
*                                                                     *
***********************************************************************
         SPACE 3
         XPARM
PARMLEN  EQU   *-TEXT                  LENGTH OF PARAMETER AREA
         SPACE 3
***********************************************************************
*                                                                     *
*      UCB ADDRESS VECTOR.                                            *
*                                                                     *
***********************************************************************
         SPACE 3
VECTOR   DSECT
         DS    1024H
VECEND   DS    H                       =X'FFFF'
VECLEN   EQU   *-VECTOR
         EJECT
         END   SHOW
./ ADD  NAME=SPACE
         TITLE 'XSPACE                             X-COMMAND SPACE'
SPACE    CSECT
         SPACE 3
***********************************************************************
*                                                                     *
*      PROGRAM-ID. SPACE.                                             *
*      AUTHOR. EHNERT.                                                *
*      INSTALLATION. BAYER AG, LEVERKUSEN, RECHENZENTRUM.             *
*      DATE-WRITTEN. 16. 7. 1975.                                     *
*      REMARKS.                                                       *
*                                                                     *
*          DAS X-COMMAND 'SPACE' GIBT INFORMATIONEN UEBER DEN         *
*          FREIEN SPEICHERPLATZ, DIE ANZAHL DER EXTENTS UND DEN       *
*          EXTENT DER ALS PARAMETER SPEZIFIZIERTEN VOLUMES AUS.       *
*                                                                     *
*          ALS PARAMETER KOENNEN BIS ZU ZEHN VOLSER-MASKEN ANGE-      *
*          GEBEN WERDEN, MIT DEREN HILFE EINE AUSWAHL DER VOLUMES     *
*          GETROFFEN WIRD. DABEI STEHT '*' FUER JEDES ZEICHEN AN      *
*          DIESER STELLE.                                             *
*                                                                     *
***********************************************************************
         EJECT
***********************************************************************
*                                                                     *
*      BEGINN DER VERARBEITUNG.                                       *
*                                                                     *
***********************************************************************
         SPACE 3
*
*      SICHERN DER REGISTER,
*      SPEICHERPLATZANFORDERUNG FUER ARBEITSBEREICHE,
*      ZUORDNUNG DER BASISREGISTER.
*
         SPACE 1
         XSAVE R12,,SPACE,ABERL
         SPACE 1
         LR    R11,R1        BASISREG. FUER DSECT PARMAREA INITIALIS.
         USING UCB,R3        BASISREG. FUER DSECT UCB ZUORDNEN
         USING MESSAGE,R10   BASISREG. FUER DSECT MESSAGE ZUORDNEN
         USING PARMAREA,R11  BASISREG. FUER DSECT PARMAREA ZUORDNEN
         USING ABER,R13      BASISREG. FUER DSECT ABER ZUORDNEN
         EJECT
*
*      INITIALISIERUNG DER SPEICHER.
*
         SPACE 1
         MVI   FNDBYTE,X'00' SCHALTER LOESCHEN
         MVI   WTORBYTE,X'FF' SCHALTER SETZEN
         LA    R2,ENDTAB1    ENDADRESSEN DER
         LA    R3,ENDTPVOL       TABELLEN LADEN
         STM   R2,R3,ADDRETB1    UND SPEICHERN
         MVC   UCMID,REG4    UCM-ID. DES AUFRUFERS UEBERTRAGEN
         SPACE 2
*
*      FLAG BYTS IN NACHRICHTENBEREICHEN SETZEN.
*
         SPACE 1
         LA    R10,MSGTAB    ADRESSE DER TABELLE LADEN
         ST    R10,SAVE1R10      UND SPEICHERN
         L     R3,ADDRETB1   ENDADRESSE DER TABELLEN LADEN
CLEARMSS EQU   *
         MVC   MESSFLAG,=X'FFFF' FLAG BYTES SETZEN
         LA    R10,68(R10)   R10 ERHOEHEN
         CR    R10,R3        ENDE DER TABELLEN ERREICHT ?
         BL    CLEARMSS      NEIN, VERZWEIGEN
         EJECT
***********************************************************************
*                                                                     *
*      VERARBEITUNG DER EINGABEPARAMETER.                             *
*                                                                     *
***********************************************************************
         SPACE 3
         LA    R4,TEXT+5     R4 INITIALISIEREN
         LA    R8,PARMENDE   ENDADRESSE DES PARAMETERBEREICHS LADEN
         CLI   0(R4),C','    PARAMETER ANGEGEBEN ?
         BNE   FEHLPARM      NEIN, VERZW. ZUR FEHLERROUTINE
         LA    R6,TABPVOL1   ADRESSE DER VOLSER-TABELLE LADEN
NEXTPARM EQU   *
         SR    R5,R5         R5 LOESCHEN
         LR    R7,R4         ADRESSE DES TRENNUNGSZEICHENS LADEN
NXTBYTE  EQU   *
         LA    R4,1(R4)      R4 ERHOEHEN
         CR    R4,R8         PARAMETERBEREICH UEBERSCHRITTEN ?
         BNL   FEHLPARM      JA, VERZW. ZUR FEHLERROUTINE
         CLI   0(R4),C','    ENDE DES PARAMETERS ERREICHT ?
         BE    NEXTPVOL      JA, VERZWEIGEN
         CLI   0(R4),X'00'   ENDE DER PARAMETERKETTE ERREICHT ?
         BE    NEXTPVOL      JA, VERZWEIGEN
         CLI   0(R4),C' '    ENDE DER PARAMETERKETTE ERREICHT ?
         BE    NEXTPVOL      JA, VERZWEIGEN
         LA    R5,1(R5)      R5 ERHOEHEN
         CLI   0(R4),C'*'    BELIEBIGES ZEICHEN AN DIESER STELLE ?
         BNE   NXTBYTE       NEIN, VERZWEIGEN
         MVI   0(R4),X'FF'   ZEICHEN UMSETZEN
         B     NXTBYTE       VERZWEIGEN
         EJECT
NEXTPVOL EQU   *
         C     R6,ADDRETPV   TABELLENENDE UEBERSCHRITTEN ?
         BNL   FEHLPARM      JA, VERZWEIGEN
         C     R5,=F'6'      LAENGE DER VOLID GUELTIG ?
         BH    FEHLPARM      NEIN, VERZW. ZUR FEHLERROUTINE
         LTR   R5,R5         VOLID ANGEGEBEN ?
         BZ    FEHLPARM      NEIN, VERZW. ZUR FEHLERROUTINE
         BCTR  R5,0          R5 UM EINS VERMINDERN
         EX    R5,MOVEPVOL   VERZW. ZUR UEBERTR. DER VOLSER NUMBER
         STC   R5,0(R6)      LAENGENANGABE IN TABELLE EINTRAGEN
         LA    R6,7(R6)      R6 ERHOEHEN
         CLI   0(R4),C','    FOLGEN WEITERE PARAMETER ?
         BE    NEXTPARM      JA, VERZWEIGEN
         SPACE 2
*
*      ABSCHLUSS DER PARAMETERVERARBEITUNG.
*
         SPACE 1
         MVI   0(R6),X'80'   TABELLENENDE SPEZIFIZIEREN
         MVC   TABPVOL2,TABPVOL1 VOLSER-TABELLE KOPIEREN
         LA    R6,TABPVOL2-1 ADRESSE DER TABELLE LADEN
NEXTFF   EQU   *
         LA    R6,1(R6)      R6 ERHOEHEN
         CLI   0(R6),X'80'   TABELLENENDE ERREICHT ?
         BE    GETUCB        JA, VERZWEIGEN
         CLI   0(R6),X'FF'   TABELLENZEICHEN = X'FF' ?
         BNE   NEXTFF        NEIN, VERZWEIGEN
         MVI   0(R6),X'00'   TABELLENZEICHEN UMSETZEN
         B     NEXTFF        VERZWEIGEN
         EJECT
***********************************************************************
*                                                                     *
*      VERARBEITUNG DER UCB-INFORMATIONEN.                            *
*                                                                     *
***********************************************************************
         SPACE 3
GETUCB   EQU   *
         DROP  R11           R11 FREIGEBEN
         GETMAIN R,LV=VEKLEN,SP=125
         LR    R11,R1        BASISREG. FUER DSECT VEKTOR INIT.
         USING VEKTOR,R11    BASISREG. FUER DSECT VEKTOR ZUORDNEN
         ST    R11,UCBADDR   VEKTOR-ADRESSE SPEICHERN
         MVI   UCBADDR,X'80' OPTION BYTE SETZEN
         LA    R1,UCBADDR    ADRESSE DER VEKTOR-ADRESSE LADEN
         LINK  EP=GETUCBS              LINK TO SUBROUTINE
         LA    R2,VEKTOR     ADRESSE DES UCB-VEKTORS LADEN
         SR    R3,R3         R3 LOESCHEN
         MVC   VEKEND,=X'FFFF' ENDE DES UCB-VEKTORS SPEZIFIZIEREN
         S     R2,=F'2'      R2 UM ZWEI VERMINDERN
NEXTUCB  EQU   *
         LA    R2,2(R2)      R2 ERHOEHEN
         CLC   0(2,R2),=X'FFFF' ENDE DES UCB-VEKTORS ERREICHT ?
         BE    ABSCHLUS      JA, VERZW. ZUM ABSCHLUSS DER VERARBEITUNG
         ICM   R3,3,0(R2)    ADRESSE DES UCB LADEN
         CLI   UCBDVCLS,X'20' DEVICE = DASD ?
         BNE   NEXTUCB       NEIN, VERZWEIGEN
         TM    DEVSTAT,X'80' EINHEIT ONLINE ?
         BZ    NEXTUCB       NEIN, VERZWEIGEN
         TM    DEVSTAT,X'10' EINHEIT IM UNLOAD ?
         BO    NEXTUCB       JA, VERZWEIGEN
         CLC   UCBVOLI,=XL6'0' VOLID VORHANDEN ?
         BE    NEXTUCB       NEIN, VERZWEIGEN
         TM    UCB+17,X'08'                VIRTUAL DEVICE ?
         BO    TSTVVOL                     BRANCH IF YES
         EJECT
*
*      VERGLEICH MIT SPEZIFIZIERTEN VOLSER NUMBERS.
*
         SPACE 1
         SR    R5,R5         R5 LOESCHEN
         LA    R6,TABPVOL1-7 ADRESSE DER VOLSER-TABELLE LADEN
         LA    R7,TABPVOL2-7 ADRESSE DER VOLSER-TABELLE LADEN
NXTVOLID EQU   *
         LA    R6,7(R6)      R6 ERHOEHEN
         LA    R7,7(R7)      R7 ERHOEHEN
         TM    0(R6),X'80'   TABELLENENDE ERREICHT ?
         BO    NEXTUCB       JA, VERZWEIGEN
         IC    R5,0(R6)      LAENGENANGABE LADEN
         MVC   ZWVOLID1,UCBVOLI VOLSER NUMBER UEBERTRAGEN
         MVC   ZWVOLID2,UCBVOLI VOLSER NUMBER UEBERTRAGEN
         EX    R5,NCVOLID1   VERZW. ZUR UEBERLAGERUNG DER VOLID
         EX    R5,OCVOLID2   VERZW. ZUR UEBERLAGERUNG DER VOLID
         CLC   ZWVOLID1,ZWVOLID2 VOLID = AUSGEW. VOLID ?
         BNE   NXTVOLID      VERZW., WENN VOLID ^= AUSGEW. VOLID
         B     MVCVOLID
         SPACE 1
TSTVVOL  EQU   *
         LA    R6,TABPVOL1-7 ADRESSE DER VOLSER-TABELLE LADEN
NXTVVOL  EQU   *
         LA    R6,7(R6)      R6 ERHOEHEN
         TM    0(R6),X'80'   TABELLENENDE ERREICHT ?
         BO    NEXTUCB       JA, VERZWEIGEN
         CLC   UCBVOLI,1(R6) VOLID = AUSGEW. VOLID ?
         BNE   NXTVVOL       VERZW., WENN VOLID ^= AUSGEW. VOLID
MVCVOLID EQU   *
         MVC   VOLSERNO,UCBVOLI VOLSER NUMBER UEBERTRAGEN
         MVI   FNDBYTE,X'FF' FLAG BYTE SETZEN
         EJECT
***********************************************************************
*                                                                     *
*      DSCB5 LESEN UND AUSWERTEN (SVC 78).                            *
*                                                                     *
***********************************************************************
         SPACE 3
         L     R10,SAVE1R10  R10 INITIALISIEREN
         MVC   MESSAGE(LENMSG02),MSG02 NACHRICHTENZEILE UEBERTRAGEN
         MVC   MS2VOLID,UCBVOLI VOLSER NUMBER UEBERTRAGEN
         MVC   MS2ADR,UCBNAME UNIT NAME UEBERTRAGEN
         LA    R1,SVCWKFLD   ADRESSE DES SVC WORK FIELD LADEN
         LR    R0,R3         UCB-ADRESSE LADEN
         SVC   78            VERZW. ZUR VERARBEITUNG DES DSCB5
         MVC   MS2FRCYL,SVCFRCYL ANZ. FREIER CYLINDER UEBERTRAGEN
         MVC   MS2FRTRK,SVCFRTRK ANZ. FREIER TRACKS UEBERTRAGEN
         MVC   MS2NOEXT,SVCNOEXT ANZ. DER EXTENTS UEBERTRAGEN
         MVC   MS2MXCYL,SVCMXCYL ANZ. CYL. DES GROESSTEN EXT. UEBERTR.
         MVC   MS2MXTRK,SVCMXTRK ANZ. TRK. DES GROESSTEN EXT. UEBERTR.
         LA    R14,NEXTUCB   RUECKSPRUNGADRESSE LADEN
         MVC   MESSFLAG,=XL6'0' FLAG BYTES LOESCHEN
         LA    R10,68(R10)   R10 ERHOEHEN
         C     R10,ADDRETB1  ENDE DER TABELLE UEBERSCHRITTEN ?
         BNL   AUSMSGM       JA, VERZWEIGEN
         ST    R10,SAVE1R10  LAUFENDE ADRESSE SPEICHERN
         BR    R14           VERZWEIGEN
         EJECT
***********************************************************************
*                                                                     *
*      ABSCHLUSSROUTINEN.                                             *
*                                                                     *
***********************************************************************
         SPACE 3
ABSCHLUS EQU   *
         FREEMAIN R,SP=125    SPEICHERPLATZ FREIGEBEN
         MVI   WTORBYTE,X'00' FLAG BYTE LOESCHEN
         CLI   FNDBYTE,X'FF' VOLUME(S) GEFUNDEN ?
         BE    AUSRMSGN      JA, VERZWEIGEN
         L     R0,UCMID      UCM-ID. DES AUFRUFERS LADEN
         WTO   MF=(E,MSG03)  NACHRICHT AUSGEBEN
         B     ENDE          VERZWEIGEN
         SPACE 2
*
*      AUSGABE NOCH OFFENER INFO-NACHRICHTEN.
*
         SPACE 1
AUSRMSGN EQU   *
         LA    R10,MSGTAB    ADRESSE DER TABELLE LADEN
         CLC   MESSFLAG,=XL6'0' SIND NOCH NACHRICHTEN OFFEN ?
         BNE   ENDE          NEIN, VERZWEIGEN
         BAL   R14,AUSMSGM   JA, VERZW. ZUR NACHRICHTENAUSGABE
         EJECT
*
*      SPEICHERPLATZFREIGABE,
*      REINITIALISIERUNG DER REGISTER UND
*      RUECKSPRUNG ZUM AUFRUFENDEN PROGRAMM.
*
         SPACE 1
ENDE     EQU   *
         XRETURN ,R
         EJECT
***********************************************************************
*                                                                     *
*      FEHLERROUTINEN.                                                *
*                                                                     *
***********************************************************************
         SPACE 3
*
*      ROUTINE BEI FEHLER IN DER PARAMETERKETTE.
*
         SPACE 1
FEHLPARM EQU   *
         L     R0,UCMID      UCM-ID. DES AUFRUFERS LADEN
         WTO   MF=(E,MSG04)  NACHRICHT AUSGEBEN
         B     ENDE          VERZWEIGEN
         EJECT
***********************************************************************
*                                                                     *
*      AUSGABE DER NACHRICHTEN.                                       *
*                                                                     *
***********************************************************************
         SPACE 3
AUSMSGM  EQU   *
         ST    R14,SAVE1R14  RUECKSPRUNGADRESSE SICHERN
         L     R0,UCMID      UCM-ID. DES AUFRUFERS LADEN
         WTO   MF=(E,MSG01)  UEBERSCHRIFTENZEILE AUSGEBEN
         LA    R10,MSGTAB-68 ADRESSE DER TABELLE LADEN
         L     R9,ADDRETB1   ENDADRESSE DER TABELLE LADEN
         BAL   R14,AUSGABE   VERZW. ZUR AUSGABE WEITERER ZEILEN
         LA    R10,MSGTAB    ADRESSE DER TABELLE LADEN
         ST    R10,SAVE1R10      UND SPEICHERN
         L     R14,SAVE1R14  RUECKSPRUNGADRESSE LADEN
         CLI   WTORBYTE,X'FF' FLAG BYTE GESETZT ?
         BNER  R14           NEIN, VERZWEIGEN
NXTREPLY EQU   *
         XC    ECB,ECB       EVENT CONTROL BLOCK LOESCHEN
         L     R0,UCMID      UCM-ID. DES AUFRUFERS LADEN
         LA    R4,ECB        ADRESSE DES ECB LADEN
         LA    R5,REPLY      ADRESSE DES REPLY LADEN
         MVC   WTOR(LENMSG05),MSG05 NACHRICHTENZEILE UEBERTRAGEN
         WTOR  ,(R5),1,(R4),MF=(E,WTOR)
         SPACE 1
         WAIT  ECB=ECB       AUF REPLY WARTEN
         CLI   REPLY,C'N'    REPLY = NO ?
         BE    ENDE          JA, VERZWEIGEN
         CLI   REPLY,C'Y'    REPLY = YES ?
         BNE   NXTREPLY      NEIN, VERZWEIGEN
         L     R14,SAVE1R14  RUECKSPRUNGADRESSE LADEN
         BR    R14           VERZWEIGEN
         EJECT
*
*      AUSGABE EINZELNER NACHRICHTENZEILEN.
*
         SPACE 1
AUSGABE  EQU   *
         ST    R14,SAVE2R14  RUECKSPRUNGADRESSE SICHERN
NEXTMESS EQU   *
         LA    R10,68(R10)   R10 ERHOEHEN
         CR    R10,R9        ENDE DER TABELLE ERREICHT ?
         BNL   ENDMESS       JA, VERZWEIGEN
         CLC   MESSFLAG,=X'FFFF' FLAG BYTES GESETZT ?
         BE    ENDMESS       JA, VERZWEIGEN
         MVC   MESSFLAG,=X'FFFF' FLAG BYTES SETZEN
         L     R0,UCMID      UCM-ID. DES AUFRUFERS LADEN
         WTO   MF=(E,MESSAGE) EINE NACHRICHTENZEILE AUSGEBEN
         B     NEXTMESS      VERZWEIGEN
ENDMESS  EQU   *
         L     R14,SAVE2R14  RUECKSPRUNGADRESSE LADEN
         BR    R14           VERZWEIGEN
         EJECT
***********************************************************************
*                                                                     *
*      BEFEHLE, DIE MIT HILFE DES EXECUTE-BEFEHLS AUSGEFUEHRT WERDEN. *
*                                                                     *
***********************************************************************
         SPACE 3
MOVEPVOL EQU   *
         MVC   1(0,R6),1(R7) VOLID IN TABELLE UEBERTRAGEN
NCVOLID1 EQU   *
         NC    ZWVOLID1(0),1(R6) VOLID UEBERLAGERN
OCVOLID2 EQU   *
         OC    ZWVOLID2(0),1(R7) VOLID UEBERLAGERN
         EJECT
***********************************************************************
*                                                                     *
*      REGISTER EQUATES.                                              *
*                                                                     *
***********************************************************************
         SPACE 3
R0       EQU   0             MACRO- UND-PARAMETER REGISTER
R1       EQU   1             MACRO- UND-PARAMETER REGISTER
R2       EQU   2             POINTER IN UCB-ADR. VEKTOR
R3       EQU   3             POINTER FUER UCB
R4       EQU   4             ARBEITSREGISTER
R5       EQU   5             ARBEITSREGISTER
R6       EQU   6             ARBEITSREGISTER
R7       EQU   7             ARBEITSREGISTER
R8       EQU   8             ARBEITSREGISTER
R9       EQU   9             ARBEITSREGISTER
R10      EQU   10            POINTER IN NACHRICHTEN-TABELLEN
R11      EQU   11            BASISREG. FUER DSECT PARMAREA / VEKTOR
R12      EQU   12            BASISREG. FUER CSECT SPACE
R13      EQU   13            BASISREG. FUER DSECT ABER
R14      EQU   14            RUECKSPRUNGADRESSEN
R15      EQU   15            CSECT-ADRESSEN UND RETURN CODES
         EJECT
***********************************************************************
*                                                                     *
*      DEFINITION DER AUSGABENACHRICHTEN.                             *
*                                                                     *
***********************************************************************
         SPACE 3
MSG01    WTO   'XSPACE1 VOLSER ADR FREE-SPACE EXT  LARGEST-EXTENT',    *
               MF=L,MCSFLAG=(REG0)
         SPACE 1
MSG02    WTO   'XSPACE2 VOLSER ADR 9999/9999  9999   9999/9999',       *
               MF=L,MCSFLAG=(REG0)
LENMSG02 EQU   *-MSG02
         SPACE 1
MSG03    WTO   'XSPACE3 SPECIFIED VOLUME(S) NOT FOUND',                *
               MF=L,MCSFLAG=(REG0)
         SPACE 1
MSG04    WTO   'XSPACE4 INVALID PARAMETER LIST',                       *
               MF=L,MCSFLAG=(REG0)
         SPACE 1
MSG05    WTOR  'XSPACE5 REPLY ''Y'' (YES) OR ''N'' (NO) TO CONTINUE',  *
               MF=L,MCSFLAG=(REG0)
LENMSG05 EQU   *-MSG05
         EJECT
***********************************************************************
*                                                                     *
*      DEFINITION DER ARBEITSBEREICHE.                                *
*                                                                     *
***********************************************************************
         SPACE 3
ABER     DSECT
SAVEAREA DS    18F           SAVEAREA FUER ALLGEMEINE REGISTER
         SPACE 2
*
*      ADRESSEN-SPEICHER.
*
         SPACE 1
ADDRETB1 DS    F             ENDADRESSE DER MSG-NACHRICHTEN-TABELLE
ADDRETPV DS    F             ENDADRESSE DER VOLSER-TABELLE
SAVE1R10 DS    F             SAVEAREA1 FUER R10
SAVE1R14 DS    F             SAVEAREA1 FUER R14
SAVE2R14 DS    F             SAVEAREA2 FUER R14
UCBADDR  DS    F             ADRESSE DES UCB-VEKTORS
UCMID    DS    F             UCM-ID. DES AUFRUFERS
         SPACE 2
*
*      ARBEITSSPEICHER.
*
         SPACE 1
FNDBYTE  DS    C             SCHALTER FUER GEFUNDENE VOLUMES
WTORBYTE DS    C             SCHALTER FUER WTOR
REPLY    DS    C             SPEICHER FUER REPLY
VOLSERNO DS    CL6           ZWISCHENSPEICHER FUER VOLSER NUMBER
ZWVOLID1 DS    CL6           ZWISCHENSPEICHER FUER VOLSER NUMBER
ZWVOLID2 DS    CL6           ZWISCHENSPEICHER FUER VOLSER NUMBER
ECB      DS    F             EVENT CONTROL BLOCK
WTOR     DS    15F           BEREICH FUER WTOR-NACHRICHT
SVCWKFLD DS    0F            SVC WORK FIELD
         DS    CL6
SVCFRCYL DS    CL4           ANZ. FREIER CYLINDER
         DS    CL1
SVCFRTRK DS    CL4           ANZ. FREIER TRACKS
         DS    CL1
SVCNOEXT DS    CL4           ANZ. DER EXTENTS
         DS    CL1
SVCMXCYL DS    CL4           ANZ. CYLINDER DES GROESSTEN EXTENTS
         DS    CL1
SVCMXTRK DS    CL4           ANZ. TRACKS DES GROESSTEN EXTENTS
         ORG   SVCWKFLD+80
         EJECT
*
*      MASKEN-TABELLEN FUER VOLSER NUMBERS AUS DEM PARAMETERBEREICH.
*
*      AUFBAU DER TABELLE:
*      BYTE1 - LAENGE DES ANGEGEBENEN VOLSER-PARAMETERS ODER
*          X'80' BEI TABELLENENDE
*      BYTES2-7 - ANFANGSZEICHEN DER VOLSER NUMBER UND MASKENZEICHEN
*
         SPACE 1
TABPVOL1 DS    10CL7         TABELLE MIT MASKENZEICHEN X'FF'
ENDTPVOL EQU   *
         DS    CL7
TABPVOL2 DS    CL77          TABELLE MIT MASKENZEICHEN X'00'
         SPACE 2
*
*      NACHRICHTEN-BEREICHE.
*
*      AUFBAU:
*      BYTE1-66: WTO-NACHRICHTENZEILE
*      BYTE67-68: X'0000', WENN NACHRICHTENZEILE VERFUEGBAR
*
         SPACE 1
         DS    0F
MSGTAB   DS    10CL68        TABELLE FUER NACHRICHTEN
ENDTAB1  EQU   *
         SPACE 1
ABERL    EQU   *-ABER        LAENGE DER ARBEITSBEREICHE
         EJECT
***********************************************************************
*                                                                     *
*      DEFINITIONEN FUER EINE NACHRICHTENZEILE.                       *
*                                                                     *
***********************************************************************
         SPACE 3
MESSAGE  DSECT
         SPACE 2
*
*      DEFINITIONEN FUER MSG02.
*
         SPACE 1
         ORG   MESSAGE+4
         DS    CL8
MS2VOLID DS    CL6           VOLUME SERIAL NUMBER
         DS    C
MS2ADR   DS    CL3           UNIT ADDRESS
         DS    CL1
MS2FRCYL DS    CL4           FREE CYLINDERS
         DS    CL1
MS2FRTRK DS    CL4           FREE TRACKS
         DS    CL2
MS2NOEXT DS    CL4           NO. OF EXTENTS
         DS    CL3
MS2MXCYL DS    CL4           CYLINDERS OF LARGES EXTENTS
         DS    CL1
MS2MXTRK DS    CL4           TRACKS OF LARGES EXTENT
         ORG   MESSAGE+66
MESSFLAG DS    CL2           FLAG BYTES
         EJECT
***********************************************************************
*                                                                     *
*      UCB-DEFINITIONEN.                                              *
*                                                                     *
***********************************************************************
         SPACE 3
UCB      DSECT
         DS    CL3
DEVSTAT  DS    C             DEVICE STATUS
         DS    CL9
UCBNAME  DS    CL3           UNIT NAME
         DS    CL2
UCBDVCLS DS    C             DEVICE CLASS
DEVCODE  DS    C             DEVICE CODE
         DS    CL4
UCBVTOC  DS    CL4           REL. ADDR. OF SPACE FOR THIS VOL. (TTR0)
UCBVOLI  DS    CL6           VOLUME SERIAL NUMBER
         SPACE 3
***********************************************************************
*                                                                     *
*      PARAMETERBEREICH.                                              *
*                                                                     *
***********************************************************************
         SPACE 3
         XPARM
PARMENDE EQU   *
         SPACE 3
***********************************************************************
*                                                                     *
*      VEKTOR MIT UCB-ADRESSEN.                                       *
*                                                                     *
***********************************************************************
         SPACE 3
VEKTOR   DSECT
         DS    1024H
VEKEND   DS    H             =X'FFFF'
VEKLEN   EQU   *-VEKTOR
         EJECT
         END   SPACE
./ ADD  NAME=TIME
TIME     TITLE 'MODULE XTIME TO COMPUTE CPU-IDLE TIMES'
*
*      PROGRAM-ID. 'XTIME'.
*      AUTHOR. HANS-PETER ENGELHARDT.
*      INSTALLATION. BAYER AG, 509 LEVERKUSEN, RECHENZENTRUM.
*      REMARKS. THIS MODULE MUST BE LINKED WITH THE 'RENT' OPTION.
*
         SPACE 3
TIME     CSECT
         XSAVE R12,,TIME,WORKL
         USING WORK,R13
         LR    R11,R1
         USING PARMAREA,R11
         L     R2,16
         TM    116(R2),X'01'
         BZ    LOCK
         MODESET KEY=ZERO
LOCK     TS    LOCKSW              TEST IF ALREADY IN USE ---
         BNZ   BUSY                YES
         MVC   REG4B,REG4          SAVE FIRST USERS CONSOLE ID
DEFAULT  MVC   XTEXT(50),=CL50'TIME,INTERVAL=00.01.00,MODEL=*** '
         L     R15,16              LOAD CVT ADDRESS
         SH    R15,=H'8'           POINT TO MODEL
         UNPK  XTEXT+29(4),2(3,R15)
         MVI   XTEXT+32,X'40'
         CLI   XTEXT+29,C'0'
         BNE   OK
         MVC   WORKWORD(2),XTEXT+30
         MVC   XTEXT+29(2),WORKWORD
         MVI   XTEXT+31,X'40'
OK       EQU   *
         BAL   R9,CHECKPRM         ESTABLISH DEFAULT OPTIONS
         MVC   XAREA,PARMAREA      SAVE THE SPECIFIED PARAMETERS
         OC    XTEXT(50),=50X'40'  CONVERT TO CAPITAL LETTERS
         BAL   R9,CHECKPRM         TEST REAL OPTIONS
         B     START
* TEST PARAMETER
CHECKPRM LA    R6,XTEXT+4          SET POINTER (MINUS 'TIME')
         CLC   XTEXT(4),=C'TIME'   CORRECT PROGRAM NAME ---
         BNE   ERROR               NO. THERE MUST BE A LINK NAME ERROR
NEXTPARM EQU   *
         CLI   0(R6),C','
         BE    COMMA
         CLI   0(R6),C' '          END OF PARAMETERS ---
         BCR   8,R9                YES
         B     ERROR               SYNTAX INVALID
TESTPARM EQU   *
         CLC   0(6,R6),=C'MODEL='
         BE    TESTMDL
         CLC   0(9,R6),=C'INTERVAL='
         BE    TESTINTV
         B     ERROR               INVALID PARAMETER
COMMA    LA    R6,1(R6)            STEP ONE BYTE
         B     TESTPARM
* LOOK UP MODEL INSTRUCTION TIMINGS
TESTMDL  EQU   *
         MVC   MODEL,6(R6)         SAVE MODEL
         CLI   MODEL+2,C','        MODEL ONLY TWO CHARACTERS ---
         BNE   *+8                 NO. SKIP NEXT INSTRUCTION
         MVI   MODEL+2,C' '        ERASE COMMA
         LA    R3,MDLTABLE
LOOKUP   C     R3,=A(MDLTBEND)
         BNL   ERROR               SPECIFIED MODEL NOT IN TABLE
         CLC   MODEL,0(R3)
         BE    MDLOK               MODEL FOUND
         LA    R3,12(R3)           STEP TO NEXT ENTRY
         B     LOOKUP
MDLOK    EQU   *
         MVC   MSG01+62(3),MODEL   ACKNOLEDGE MODEL
         MVC   MSG05+22(3),MODEL
         MVC   MSG01+53(1),3(R3)   AND SYSTEM
         MVC   MSG05+19(1),3(R3)
         L     R4,4(R3)
         A     R4,8(R3)
         ST    R4,TIMING           MODEL TIMING FOR LATER USE.
         LA    R6,8(R6)            SET POINTER
         CLI   2(R3),C' '          TO NEXT PARM
         BE    NEXTPARM
         LA    R6,1(R6)
         B     NEXTPARM
* CHECK THE SPECIFIED INTERVAL
TESTINTV EQU   *
         MVC   INTERVAL,9(R6)      SAVE INTERVAL
         TM    INTERVAL+0,X'F0'
         BNO   ERROR               NO DIGITS
         TM    INTERVAL+1,X'F0'
         BNO   ERROR               NO DIGITS
         CLI   INTERVAL+2,C'.'
         BNE   ERROR               FORMAT INVALID
         TM    INTERVAL+3,X'F0'
         BNO   ERROR               NO DIGITS
         TM    INTERVAL+4,X'F0'
         BNO   ERROR               NO DIGITS
         CLI   INTERVAL+5,C'.'
         BNE   ERROR               FORMAT INVALID
         TM    INTERVAL+6,X'F0'
         BNO   ERROR               NO DIGITS
         TM    INTERVAL+7,X'F0'
         BNO   ERROR               NO DIGITS
         CLC   INTERVAL+0(2),=C'23'
         BH    ERROR               LOGIC ERROR
         CLC   INTERVAL+3(2),=C'59'
         BH    ERROR               LOGIC ERROR
         CLC   INTERVAL+6(2),=C'59'
         BH    ERROR               LOGIC ERROR
         CLC   INTERVAL,=C'00.00.01'
         BL    ERROR               LOGIC ERROR
         MVC   MSG01+35(8),INTERVAL
         LA    R6,17(R6)
         B     NEXTPARM            THE TIME INTERVAL IS VALID.
* START PROCESS
START    EQU   *
         TIME  DEC
         ST    R0,DAYTIME
         TIME  BIN
         ST    R0,TOD01
         UNPK  DBBLWORD(7),DAYTIME
         MVC   MSG01+17(2),DBBLWORD+0
         MVC   MSG01+20(2),DBBLWORD+2
         MVC   MSG01+23(2),DBBLWORD+4
         L     R0,REG4A            LOAD CONSOLE ID
         WTO   MF=(E,MSG01)
         MVC   ZEIT,=ZL8'0'
         MVC   ZEIT+0(2),INTERVAL+0
         MVC   ZEIT+2(2),INTERVAL+3
         MVC   ZEIT+4(2),INTERVAL+6
TIMESET  SR    R3,R3
         LA    R8,1                SET COUNT VALUE
         TM    116(R2),X'01'
         BZ    GOON1
         MODESET KEY=NZERO
GOON1    EQU   *
         SPIE  PCEXIT,(8)          SET PICA FOR FIXED OVERFLOW
         STIMER REAL,EXIT,DINTVL=ZEIT
         CHAP  -255                SET DPRTY=00
*
* TIME MEASUREMENT LOOP
*
TIMELOOP AR    R3,R8               ADD 1 INTO REG 3
TIMESW   B     TIMELOOP
*
RESUME   EQU   *
         CHAP  +251                GAIN NORMAL DPRTY
         TTIMER CANCEL             RESET TIMER SERVICE REQUEST
         TIME  DEC
         ST    R0,DAYTIME
         TIME  BIN
         ST    R0,TOD02
         SPIE
         TM    116(R2),X'01'
         BZ    GOON2
         MODESET KEY=ZERO
GOON2    EQU   *
         UNPK  DBBLWORD(7),DAYTIME
         MVC   MSG02+17(2),DBBLWORD+0
         MVC   MSG02+20(2),DBBLWORD+2
         MVC   MSG02+23(2),DBBLWORD+4
* RESULT PROCESSING
* ACTIVE TIME
         LR    R4,R3
         SRDA  R4,32               PREPARE EVEN/ODD REG PAIR
         M     R4,TIMING           ACTIVE TIME IN NANOSECONDS
         D     R4,=F'1000000000'   NOW IN SECONDS
         ST    R5,ESECONDS         SAVE FOR LATER
         SR    R4,R4
         D     R4,=F'60'
         CVD   R4,DBBLWORD         SECONDS
         MVO   DAYTIME+0(2),DBBLWORD+6(2)
         SR    R4,R4
         D     R4,=F'60'
         CVD   R4,DBBLWORD         MINUTES
         MVO   DAYTIME+1(2),DBBLWORD+6(2)
         CVD   R5,DBBLWORD         HOURS
         MVO   DAYTIME+2(2),DBBLWORD+6(2)
         UNPK  DBBLWORD(7),DAYTIME
         MVC   MSG05+35(2),DBBLWORD+4
         MVC   MSG05+38(2),DBBLWORD+2
         MVC   MSG05+41(2),DBBLWORD+0
* ELAPSED TIME
         SR    R4,R4
         L     R5,TOD02            ENDTIME
         S     R5,TOD01            MINUS STARTTIME
         BP    NOADD               IS RESULT MINUS ---
         A     R5,=F'8640000'      ADD 24 HOURS
NOADD    EQU   *
         D     R4,=F'100'          ELAPSED SECONDS
         ST    R5,ISECONDS         SAVE FOR LATER
         SR    R4,R4
         D     R4,=F'60'
         CVD   R4,DBBLWORD         SECONDS
         MVO   DAYTIME+0(2),DBBLWORD+6(2)
         SR    R4,R4
         D     R4,=F'60'
         CVD   R4,DBBLWORD         MINUTES
         MVO   DAYTIME+1(2),DBBLWORD+6(2)
         CVD   R5,DBBLWORD         HOURS
         MVO   DAYTIME+2(2),DBBLWORD+6(2)
         UNPK  DBBLWORD(7),DAYTIME
         MVC   MSG02+35(2),DBBLWORD+4
         MVC   MSG02+38(2),DBBLWORD+2
         MVC   MSG02+41(2),DBBLWORD+0
* COMPUTE PERCENTAGE
         L     R5,ESECONDS         ACTIVE TIME
         M     R4,=F'1000'         MULTIPLY BY 1000 (FOR .1%)
         D     R4,ISECONDS         ELAPSED TIME
         CVD   R5,DBBLWORD
         UNPK  WORKWORD,DBBLWORD
         OI    WORKWORD+3,X'F0'    ERASE SIGN
         MVC   MSG05+53(3),WORKWORD
         MVC   MSG05+57(1),WORKWORD+3
         L     R3,=F'1000'
         SR    R3,R5
         CVD   R3,DBBLWORD
         UNPK  WORKWORD,DBBLWORD
         OI    WORKWORD+3,X'F0'    ERASE SIGN
         LTR   R3,R3               TEST IF NEGATIVE ---
         BP    *+10                NO. SKIP NEXT INSTRUCTION
         MVC   WORKWORD,=C'****'   % BUSY IS NEGATIVE
         MVC   MSG02+53(3),WORKWORD
         MVC   MSG02+57(1),WORKWORD+3
         L     R0,REG4A            LOAD CONSOLE ID
         WTO   MF=(E,MSG02)
         L     R0,REG4A            LOAD CONSOLE ID
         WTO   MF=(E,MSG05)
UNLOCK   NI    LOCKSW,X'00'        RESET LOCKBYTE
         OI    TIMESW+1,X'F0'      RESET PROGRAM SWITCH
XRETURN  EQU   *
         TM    116(R2),X'01'
         BZ    END
         MODESET KEY=NZERO
END      EQU   *
         XRETURN ,R
*
BUSY     EQU   *
         OC    TEXT+0(9),=9X'40'   CONVERT TO CAPITAL
         CLC   TEXT(9),=C'TIME,STOP'  STOP COMMAND ---
         BNE   BUSYMSG             SECOND REQUEST - REJECTED
         NI    TIMESW+1,X'0F'      TERMINATE LOOP
         L     R0,REG4             NEW REQUESTORS ID
         WTO   MF=(E,MSG06)        COMMAND ACCEPTED
         CLC   REG4,REG4B          SAME CONSOLE ---
         BE    XRETURN             YES
         MVC   MSG08+52(3),=C'***'
         L     R5,16               LOAD ADDRESS OF CVT
         L     R5,100(R5)          ADDRESS OF CONSOLE UCB LIST
         L     R6,72(R5)           ADDRESS OF FIRST UCM
         L     R7,76(R5)           LENGTH OF EACH UCM
         L     R5,80(R5)           ADDRESS OF LAST UCM
NEXTNTRY EQU   *
         CLC   26(1,R6),REG4+3     UCM OF NEW REQUESTOR ---
         BE    IDFOUND             YES
         CR    R6,R5               LAST UCM REACHED ---
         BE    NOTFOUND            CONSOLE ID COULD'NT BE LOCATED
         LA    R6,0(R7,R6)         STEP TO NEXT UCM
         B     NEXTNTRY
IDFOUND  EQU   *
         L     R8,12(R6)           LOAD UCB ADDRESS
         MVC   MSG08+52(3),13(R8)  MOVE CONSOLE ADDRESS INTO MESSAGE
NOTFOUND EQU   *
         L     R0,REG4B            LOAD OLD CONSOLE ID
         WTO   MF=(E,MSG08)        INFORM FIRST USER
         B     XRETURN
BUSYMSG  EQU   *
         L     R0,REG4             LOAD CONSOLE ID (NEW)
         WTO   MF=(E,MSG04)        BUSY MESSAGE
         B     XRETURN
ERROR    EQU   *
         L     R0,REG4A            LOAD CONSOLE ID
         WTO   MF=(E,MSG03)
         B     UNLOCK              EXIT
* TIMER EXIT ROUTINE
EXIT     EQU   *
         BAL   R7,NITIMESW
         BR    R14                 PURGE EXIT IRB
* FIXED POINT OVERFLOW EXIT (CC. = 0C8)
PCEXIT   EQU   *
         BAL   R7,NITIMESW
         L     R3,=F'2147483646'   RESET REGISTER 3
         L     R0,REG4A            LOAD CONSOLE ID
         WTO   MF=(E,MSG07)        WARNING MESSAGE
         BR    R14                 RELEASE CONTROL
         EJECT
NITIMESW EQU   *
         TM    116(R2),X'01'
         BZ    GOON3
         MODESET KEY=ZERO
GOON3    EQU   *
         NI    TIMESW+1,X'0F'      TERMINATE LOOP
         TM    116(R2),X'01'
         BZR   R7
         MODESET KEY=NZERO
         BR    R7
LOCKSW   DC    X'00'               LOCK BYTE
* TABLE OF INSTRUCTION TIMINGS IN NANO-SECONDS
MDLTABLE DS    0D               'AR'      'BC'
M145     DC    CL3'145',C'7',F'001373',F'001792'
M155     DC    CL3'155',C'7',F'000499',F'000993'
M158     DC    CL3'158',C'7',F'000463',F'000671'
M165     DC    CL3'165',C'7',F'000080',F'000350'
M168     DC    CL3'168',C'7',F'000080',F'000320'
M195     DC    CL3'195',C'7',F'000054',F'000270'
M30      DC    CL3'30 ',C'6',F'020470',F'017000'
M40      DC    CL3'40 ',C'6',F'007500',F'009380'
M50      DC    CL3'50 ',C'6',F'002510',F'004000'
M65      DC    CL3'65 ',C'6',F'000900',F'001100'
M67      DC    CL3'67 ',C'6',F'000900',F'001100'
M75      DC    CL3'75 ',C'6',F'000390',F'001010'
MDLTBEND EQU   *
M85      DC    CL3'85 ',C'6'
M91      DC    CL3'91 ',C'6'
M95      DC    CL3'95 ',C'6'
* CONSTANTS
REG4B    DC    A(0)                MUST BE IN THE BODY OF THE MODULE
         LTORG
MSG01    WTO   'XTIME01 TIME=00.00.00 INTERVAL=00.00.00 SYSTEM=/3*0 MOD*
               EL=XXX',MF=L,MCSFLAG=REG0,DESC=5
MSG02    WTO   'XTIME02 TIME=**.**.**  ELAPSED=**.**.** CPU-BUSY=***.*%*
                ',                                                     *
               MF=L,MCSFLAG=REG0,DESC=5
MSG03    WTO   'XTIME03 ERROR IN PARAMETER',                           *
               MF=L,MCSFLAG=REG0,DESC=5
MSG04    WTO   'XTIME04 REQUEST REJECTED - TASK BUSY',                 *
               MF=L,MCSFLAG=REG0,DESC=5
MSG05    WTO   'XTIME05 BASE=/3*0-XXX   ACTIVE=**.**.** CPU-IDLE=***.*%*
               ',                                                      *
               MF=L,MCSFLAG=REG0,DESC=5
MSG06    WTO   'XTIME06 STOP COMMAND ACCEPTED',                        *
               MF=L,MCSFLAG=REG0,DESC=5
MSG07    WTO   'XTIME07 TERMINATION DUE TO COUNTER OVERFLOW',          *
               MF=L,MCSFLAG=REG0,DESC=5
MSG08    WTO   'XTIME08 STOP COMMAND HAS BEEN ISSUED BY CONSOLE ***',  *
               MF=L,MCSFLAG=REG0,DESC=5
         REG
         XPARM
         EJECT
* WORKING STORAGE
WORK     DSECT
SAVE     DS    18F                 MUST BE THE FIRST STATM. AFTER DSECT
XAREA    DS    0CL128
REG4A    DS    F
XTEXT    DS    CL124
* END OF XAREA
DAYTIME  DS    F
TOD01    DS    F
TOD02    DS    F
WORKWORD DS    F
DBBLWORD DS    D
ESECONDS DS    F
ISECONDS DS    F
INTERVAL DS    CL8
MODEL    DS    CL3
TIMING   DS    F
ZEIT     DS    CL8
WORKL    EQU   *-WORK
         END
./ ADD  NAME=UCM
         TITLE 'IGCUCM3D  DISPLAY WQE COUNT WAITING FOR EACH CONSOLE'
UCM      CSECT
*
*        REGISTER EQUATES
*
         SPACE
R0       EQU   0                  PARM REG WTO
R1       EQU   1                  PARM REG WTO
R2       EQU   2                  UCM-ID CALLER
R3       EQU   3                  MLWTO WORK REG
R4       EQU   4                  UCM BASE
R5       EQU   5                  WORK
R6       EQU   6                  UCM ENTRY
R7       EQU   7                  UCB
R8       EQU   8                  OUTPUT QUEUE
R9       EQU   9                  WTO COUNT
R10      EQU   10                 ZERO REG
R11      EQU   11                 BUFFER POS
R12      EQU   12                 BASE
R13      EQU   13                 SAVE AREA AND WORKING STORAGE (GETM)
R14      EQU   14                 RETURN
         EJECT
*
*        THIS ROUTINE GATHERES STATISTICAL INFORMATION
*        AND WRITES THEM OUT TO THE OPERATOR BY WTO
*        IT ALSO TEST IF MCS IS IMPLEMENTED IF NOT IT
*        NOTIFIES THE OPERATOR AND RETURNS
*        THIS ROUTINE IS NOT REUSABLE.
*
         SPACE
         XSAVE R12,,UCM,WORKL
         USING WORK,R13
         MVI   LINE,C' '
         MVC   LINE+1(WFIELD-LINE-1),LINE
         MVC   WFIELD,=C'00000000'
         LA    R2,7(,R1)          LOAD ADDRESS OF SEPERATOR
         LA    R5,3               LOAD MAXIMUM LENGTH OF NAME
         LA    R6,UCMTAB1         LOAD ADDRESS OF UCM TABLE
         LA    R7,TABEND1         LOAD END ADDRESS OF UCM TABLE
LOOP1    EQU   *
         LR    R3,R2              LOAD ADDRESS OF SEPERATOR
         SR    R4,R4              ZERO LENGTH COUNT
LOOP2    EQU   *
         LA    R2,1(,R2)          LOAD ADDRESS OF NEXT CHARACTER
         CLI   0(R2),C' '         END OF PARAMETER CHAIN ?
         BE    UCMEND             BRANCH IF YES
         CLI   0(R2),C','         END OF PARAMETER ?
         BE    UCMEND             BRANCH IF YES
         LA    R4,1(,R4)          INCREASE LENGTH
         B     LOOP2              BRANCH
UCMEND   EQU   *
         CR    R4,R5              LENGTH VALID ?
         BNH   *+6                BRANCH IF YES
         LR    R4,R5              LOAD MAXIMUM LENGTH
         LTR   R4,R4              PARAMETER SPECIFIED ?
         BZ    TSTBLNK            BRANCH IF NOT
         BCTR  R4,0               SUBTRACT BY ONE
         STC   R4,0(,R6)          STORE LENGTH
         EX    R4,MOVEUCM         BRANCH TO MOVE
         LA    R6,4(,R6)          LOAD NEXT ADDRESS IN TABLE
         CR    R6,R7              AVAILABLE ?
         BE    LOOPEND            BRANCH IF NOT
TSTBLNK  EQU   *
         CLI   0(R2),C' '         END OF PARAMETER CHAIN ?
         BE    LOOPEND            BRANCH IF YES
         B     LOOP1              BRANCH IF NOT
LOOPEND  EQU   *
         MVI   0(R6),X'80'        MARK END OF TABLE
         LA    R6,UCMTAB1-1       LOAD ADDRESS OF UCM TABLE
         LA    R7,UCMTAB2-1       LOAD ADDRESS OF UCM TABLE
TABLOOP  EQU   *
         LA    R6,1(,R6)          ADDRESS OF NEXT CHARACTER
         LA    R7,1(,R7)          ADDRESS OF NEXT CHARACTER
         MVC   0(1,R7),0(R6)      MOVE CHARACTER
         CLI   0(R6),X'80'        END OF TABLE ?
         BE    ENDTAB             BRANCH IF YES
         CLI   0(R6),C'*'         ALL CHARACTERS IN THIS PLACE ?
         BNE   TABLOOP            BRANCH IF NOT
         MVI   0(R6),X'FF'        CHANGE CHARACTER
         MVI   0(R7),X'00'        CHANGE CHARACTER
         B     TABLOOP            BRANCH
ENDTAB   EQU   *
         L     R2,0(R1)           LOAD UCM-ID
         SR    R10,R10            CLEAR ZERO REG
         LA    R11,WTO            LOAD FIRST BUFFER POS
         L     R4,76              CVT
         L     R4,100(R4)         UCM BASE
         TM    68(R4),X'02'       MCS GENED ?
         BZ    NONMCS             NO BRANCH
         LH    R5,46(R4)          GET AND EDIT BUFFER LIMIT
         CVD   R5,WFIELD
         MVC   WTO(LENVAL),VALUES
         UNPK  WTO+25(3),WFIELD+6(2)
         OI    WTO+27,X'F0'
         LH    R5,56(R4)          LOAD GET AND EDIT RQE COUNT (WTOR)
         CVD   R5,WFIELD
         UNPK  WTO+54(3),WFIELD+6(2)
         OI    WTO+56,X'F0'
         LH    R5,58(R4)          GET AND EDIT WQE COUNT (WTO)
         CVD   R5,WFIELD
         UNPK  WTO+39(3),WFIELD+6(2)
         OI    WTO+41,X'F0'
         LR    R0,R2              LOAD UCM-ID
         WTO   MF=(E,WTO)
         LR    R0,R2              LOAD UCM-ID
         WTO   MF=(E,HEADER)
         EJECT
*
*        THIS ROUTINE LISTS ALL CONSOLES WITH
*        THEIR ACTUAL STATUS AND THE NUMBER OF WTO'S
*        NOT YET WRITTEN OUT.
*        IT COUNTS MINOR AND MAJOR WTO'S
*
         SPACE
         L     R6,72(R4)          GET FIRST UCM ENTRY
         MVC   WTO(LENMSG),MSG
NUCME    L     R7,12(R6)          UCB
         MVC   CON(3),13(R7)      MOVE UCBNAME TO BUFFER
         CLI   UCMTAB1,X'80'      TABLE FILLED ?
         BE    COMPOK             BRANCH IF NOT
         STM   R6,R8,SAVE6TO8     SAVE REGISTERS
         LA    R6,UCMTAB1-4       LOAD ADDRESS OF UCM TABLE
         LA    R7,UCMTAB2-4       LOAD ADDRESS OF UCM TABLE
         SR    R8,R8              ZERO FOR IC COMMAND
COMPLOOP EQU   *
         LA    R6,4(,R6)          LOAD ADDRESS OF NEXT ENTRY
         CLI   0(R6),X'80'        END OF UCM TABLE ?
         BE    LM                 BRANCH IF YES
         LA    R7,4(,R7)          LOAD ADDRESS OF NEXT ENTRY
         MVC   NCCON,CON          MOVE UNIT NAME
         MVC   OCCON,CON          MOVE UNIT NAME
         IC    R8,0(R6)           LOAD LENGTH
         EX    R8,NC              BRANCH
         EX    R8,OC              BRANCH
         CLC   NCCON,OCCON        CONSOLE WANTED ?
         BNE   COMPLOOP           BRANCH IF NOT
         LM    R6,R8,SAVE6TO8     RELOAD REGISTERS
COMPOK   EQU   *
         LR    R5,R6              SAVE REG
         L     R6,44(R6)          GET ALT UCM ENTRY
         L     R7,12(R6)          ALT UCB
         MVC   ALT(3),=C'   '
         LTR   R7,R7
         BZ    *+10
         MVC   ALT(3),13(R7)      MOVE UCBNAME TO BUFFER
         LR    R6,R5              RELOAD REG
         MVI   STATUS,C'A'        STATUS ACTIVE TO BUFFER
         TM    25(R6),X'10'       TEST FOR ACTIVE
         BO    ACTIVE             YES BRANCH
         MVI   STATUS,C'N'        NOT ACTIVE TO BUFFER
         MVC   WQEC,BLANK         BLANK OUT WTO COUNT IN BUFFER
         B     NACTIVE
ACTIVE   TM    42(R6),X'80'       MASTER CONSOLE ?
         BZ    NMASTER            NO BRANCH
         MVI   STATUS,C'M'        INDICATE SO IN BUFFER
NMASTER  EQU   *
         LA    R5,5               SET # OF ENTRIES IN BLOCK -1
         SR    R9,R9              CLEAR WTO COUNT REG
         L     R8,36(R6)          GET SYSOUT QUEUE
NENTRY   TM    0(R8),X'0F'        NULL ENTRY ?
         BZ    PURGED             YES BRANCH
         TM    0(R8),X'02'        PURGED ENTRY ?
         BO    PURGED             YES BRANCH
         LA    R9,1(R9)           INCREMENT WTO COUNT
*  /* CIRCUMVENTION MVS 0C4 PROBLEM */
         L     R1,16              LOAD CVT ADDRESS
         TM    116(R1),X'01'      MVS BIT ON?
         BO    NMLWTO             BYPASS MVT MULTI-LINE WTO
         TM    0(R8),X'04'        MLWTO ?
         BZ    NMLWTO             NO BRANCH
         L     R3,0(R8)           LOAD FIRST WTO
         L     R3,124(R3)         LOAD ADDRESS OF NEXT MINOR
TMLWTO   LA    R3,0(R3)           TEST FOR
         CR    R3,R10                  VALID ENTRY
         BE    NMLWTO             NOT VALID BRANCH
         LA    R9,1(R9)           INCR WTO COUNT
         L     R3,84(R3)          LOAD ADDRESS OF NEXT MINOR
         B     TMLWTO             GO AND TEST AGAIN
NMLWTO   EQU   *
PURGED   TM    0(R8),X'80'        END OF BLOCK ?
         BO    ENDBLOCK           YES BRANCH
         TM    0(R8),X'90'        END OF BLOCK ?
         BO    ENDBLOCK           YES BRANCH
NULL     LA    R8,4(R8)           L ADDRESS OF NEXT ENTRY
         BCT   R5,NENTRY          IF NOT SIXTH ENTRY GO AND TEST
         CLI   0(R8),X'C0'        POINTER TO NEXT BLOCK ?
         BNE   ENDBLOCK           NO BRANCH
         L     R8,0(R8)           LOAD NEXT BLOCK
         LA    R5,5               SET # OF ENTRIES IN BLOCK -1
         B     NENTRY             GO AND TEST AGAIN
ENDBLOCK CVD   R9,WFIELD          EDIT AND MOVE WTO COUNT IN BUFFER
         UNPK  WQEC(3),WFIELD+6(2)
         OI    WQEC+2,X'F0'
NACTIVE  MVC   16(15,R11),LINE    MOVE BUFFER IN WTO LINE
         LA    R5,WTO             TEST BUFFER POS
         CR    R11,R5
         BE    INCR               IF FIRST POS IN BUFFER BRANCH
         LA    R11,WTO            SET BUFFER POS TO FIRST
         B     OK                 BRANCH TO WRITE TO OPER.
INCR     LA    R11,WTO+21         SET BUFFER POS TO LAST
         B     NEXTUCM            SEARCH FOR NEXT UCM ENTRY
OK       EQU   *
         LR    R0,R2              LOAD UCM-ID
         WTO   MF=(E,WTO)
NEXTUCM  CL    R6,80(R4)          LAST UCM ?
         BE    END                YES GO AND PREPARE FOR END
         AL    R6,76(R4)          ADD UCM LENGHTH TO GET NEXT
         B     NUCME              GO AND TEST AGAIN
NONMCS   EQU   *
         LR    R0,R2              LOAD UCM-ID
         WTO   MF=(E,ERRMSG)
         XRETURN ,R               RETURN TO XCNTRL
END      EQU   *
         LA    5,WTO              TEST BUFFER POS
         CR    R11,R5
         BE    END1               IF FIRST BRANCH
         MVC   WTO+37(15),BLANK   BLANK LAST BUFFER POS
         LR    R0,R2              LOAD UCM-ID
         WTO   MF=(E,WTO)
END1     EQU   *
         XRETURN ,R               RETURN TO XCNTRL
LM       EQU   *
         LM    R6,R8,SAVE6TO8     RELOAD REGISTERS
         B     NEXTUCM            BRANCH
NC       NC    NCCON(0),1(R6)     MOVE UNIT NAME
OC       OC    OCCON(0),1(R7)     MOVE UNIT NAME
MOVEUCM  MVC   1(0,R6),1(R3)      MOVE UNIT NAME
         EJECT
*
*        MESSAGES
*
         SPACE
ERRMSG   WTO   'XUCM004 NO MCS IMPLEMENTED',MF=L
         SPACE
VALUES   WTO   'XUCM001 BUFFER LIMIT     WTO COUNT     WTOR COUNT    ',X
               MCSFLAG=(REG0,RESP),MF=L,DESC=(5)
LENVAL   EQU   *-VALUES
         SPACE
HEADER   WTO   'XUCM002 CONSOLE/ALT STA WTO  CONSOLE/ALT STA WTO',     *
               MCSFLAG=(REG0,RESP),MF=L,DESC=(5)
         SPACE
MSG      WTO   'XUCM003                                         ',     *
               MCSFLAG=(REG0,RESP),MF=L,DESC=(5)
LENMSG   EQU   *-MSG
         EJECT
WORK     DSECT
SAVEAREA DS    18F
SAVE6TO8 DS    3F
WTO      DS    15F
NCCON    DS    CL3
OCCON    DS    CL3
UCMTAB1  DS    CL40
TABEND1  DS    C
UCMTAB2  DS    CL40
         SPACE 1
*
*        BUFFER
*
        SPACE
LINE     EQU   *
CON      DC    C'    '
ALT      DC    C'     '
STATUS   DC    C'   '
WQEC     DC    C'   '
BLANK    DC    CL15' '
         SPACE
         DS    0D
WFIELD   DC    C'00000000'        UNPK WORK AREA
         SPACE 3
WORKL    EQU   *-WORK
         END
./ ADD  NAME=UNCAT
UNCAT    START
         REG
         XSAVE R12,,UNCAT,WORKL
         USING WORK,R13
         USING PARMAREA,R11
         LR    R11,R1
         CLI   TEXT+5,C' '  NO PARAMETERS ?
         BE    ERROR        BRANCH TO ERROR ROUTINE
         MVC   CLIST,CLISTX
         LA    R3,DSNAME
         ST    R3,CLIST+4
         MVI   DSNAME,X'40'
         MVC   DSNAME+1(43),DSNAME
         TRT   TEXT+6(45),TRTDEL
         BZ    ERROR
         LA    R2,TEXT+7
         LR    R3,R1
         SR    R3,R2
         LTR   R3,R3        NO PARAMETERS ?
         BM    ERROR        BRANCH TO ERROR ROUTINE
         EX    R3,MVCEX1
         CLC   0(3,R1),=C',C='
         BNE   UNCATL
         MVC   CVOL,3(R1)
         LA    R1,CVOL
         ST    R1,CLIST+8
         OI    CLIST,X'80'
UNCATL   EQU   *
         CATALOG CLIST
         LA    R3,ERRTAB
         AR    R3,R15
         L     R3,0(R3)
         MVC   WTO,0(R3)
         L     R0,REG4
         WTO   MF=(E,WTO)
RETURN   EQU   *
         XRETURN ,R
TRTDEL   DC    256XL1'00'
         ORG   TRTDEL+64
         DC    X'40'
         ORG   TRTDEL+107
         DC    C','
         ORG
ERROR    EQU   *
         MVC   WTO(LENMSG08),MSG08
         L     R0,REG4
         WTO   MF=(E,WTO)
         B     RETURN
MVCEX1   MVC   DSNAME(0),TEXT+6
CLISTX   CAMLST UCATDX,ERRTAB
ERRTAB   DS    0F
         DC    A(MSG01)
         DC    A(MSG02)
         DC    A(MSG03)
         DC    A(0)
         DC    A(MSG04)
         DC    A(MSG05)
         DC    A(MSG06)
         DC    A(MSG07)
MSG01    WTO   'XUNCAT1 SPECIFIED DSNAME HAS BEEN UNCATALOGED',MF=L,   *
               MCSFLAG=REG0
LENMSG01 EQU   *-MSG01
MSG02    WTO   'XUNCAT2 CATALOG VOLUME NOT MOUNTED',MCSFLAG=REG0,MF=L
LENMSG02 EQU   *-MSG02
MSG03    WTO   'XUNCAT3 INCONSISTENT INDEX STRUCTURE',MF=L,            *
               MCSFLAG=REG0
LENMSG03 EQU   *-MSG03
MSG04    WTO   'XUNCAT4 INDEX STRUCTURE DOES NOT EXIST',MF=L,          *
               MCSFLAG=REG0
LENMSG04 EQU   *-MSG04
MSG05    WTO   'XUNCAT5 NO SPACE AVAILABLE IN THE CATALOG DATA SET',   *
               MF=L,MCSFLAG=REG0
LENMSG05 EQU   *-MSG05
MSG06    WTO   'XUNCAT6 INPROPERLY NAMED GENERATION DATA GROUP',       *
               MF=L,MCSFLAG=REG0
LENMSG06 EQU   *-MSG06
MSG07    WTO   'XUNCAT7 PERM. I/O ERROR',MF=L,MCSFLAG=REG0
LENMSG07 EQU   *-MSG07
MSG08    WTO   'XUNCAT8 SYNTAX ERROR',MCSFLAG=REG0,MF=L
LENMSG08 EQU   *-MSG08
         XPARM
WORK     DSECT
SVA      DS    18F
WTO      DS    CL80
CLIST    DS    CL12
DSNAME   DS    CL44
CVOL     DS    CL6
WORKL    EQU   *-WORK
         END   UNCAT
./ ADD  NAME=UNIT
         TITLE 'XDVOL                             X-COMMAND DVOL'
DVOL     CSECT
         SPACE 3
***********************************************************************
*                                                                     *
*      PROGRAM-ID. DVOL.                                              *
*      AUTHOR. EHNERT.                                                *
*      INSTALLATION. BAYER AG, LEVERKUSEN, RECHENZENTRUM.             *
*      DATE-WRITTEN. 7. 10. 1975.                                     *
*      REMARKS.                                                       *
*                                                                     *
*          DAS X-COMMAND 'DVOL' GIBT INFORMATIONEN UEBER DEN          *
*          STATUS DER ALS PARAMETER SPEZIFIZIERTEN VOLUMES AUS.       *
*                                                                     *
*          ALS PARAMETER KOENNEN BIS ZU ZEHN VOLSER- ODER ADRESS-     *
*          MASKEN ANGEGEBEN WERDEN, MIT DEREN HILFE EINE AUSWAHL      *
*          GETROFFEN WIRD. DABEI STEHT '*' FUER JEDES ZEICHEN AN      *
*          DIESER STELLE.                                             *
*          ALS WEITERE AUSWAHL-PARAMETER KOENNEN DEVICE-TYPEN (DASD,  *
*          MSS, TAPE, UR, TP, GRAPHIC) UND DEVICE-STATUS (ONLINE,     *
*          OFFLINE, READY) ANGEGEBEN WERDEN.                          *
*                                                                     *
*          WIRD DAS PROGRAMM UNTER DEM NAMEN 'DVOL' AUFGERUFEN,       *
*          SO GELTEN DIE SPEZIFIZIERTEN PARAMETER ALS VOLSER-         *
*          MASKEN, WIRD ES UNTER DEM NAMEN 'UNIT' AUFGERUFEN,         *
*          SO GELTEN DIE SPEZIFIZIERTEN PARAMETER ALS ADRESS-         *
*          MASKEN.                                                    *
*                                                                     *
***********************************************************************
         EJECT
***********************************************************************
*                                                                     *
*      INITIAL PROCESSING.                                            *
*                                                                     *
***********************************************************************
         SPACE 3
*
*      SAVE REGISTER CONTENTS,
*      GETMAIN FOR WORK AREAS,
*      ALLOCATION OF BASE REGISTERS.
*
         SPACE 1
         XSAVE R12,,DVOL,WKAREALN
         SPACE 1
         LR    R11,R01                 INITIALIZE BASE REG. OF PARMAREA
         USING UCB,R03                 ALLOC. BASE REG. OF UCB
         USING UCBCMEXT,R09            ALLOC. BASE REG. OF UCB EXTENT
         USING MESSAGE,R10             ALLOC. BASE REG. OF MESSAGE
         USING PARMAREA,R11            ALLOC. BASE REG. OF PARMAREA
         USING WKAREA,R13              ALLOC. BASE REG. OF WKAREA
         EJECT
*
*      INITIALIZE WORK AREAS.
*
         SPACE 1
         MVI   VOLBYTE,X'00'           CLEAR FLAG BYTE
         MVI   VOLBYTE,X'00'           CLEAR FLAG BYTE
         MVI   WTORBYTE,X'FF'          SET FLAG
         LA    R02,ENDTAB1             LOAD ADDRESSES OF
         LA    R03,ENDTPVOL                TABLE ENDS AND
         STM   R02,R03,ADDRETB1            STORE THEM
         MVC   UCMID,REG4              MOVE UCM ID. OF CALLER
         MVC   PNAME,TEXT              MOVE NAME OF PROGRAM
         MVC   HEADER(LENMSG01),MSG01  MOVE HEAD LINE
         LA    R10,HEADER              INITIALIZE BASE REG. OF MESSAGE
         MVC   MSGNAME,PNAME           MOVE NAME OF PROGRAM
         MVC   WTOR(LENMSG05),MSG05    MOVE WTOR MESSAGE
         LA    R10,WTOR                INITIALIZE BASE REG. OF MESSAGE
         MVC   WTORNAME,PNAME          MOVE PROGRAM NAME
         MVI   CPUBYTE,X'00'           CLEAR FLAG BYTE
         MVI   PRMFLAGS,X'00'
         MVC   PRMFLAGS+1(PFLAGLEN-1),PRMFLAGS
         MVI   WTOBYTE,X'00'           CLEAR FLAG BYTE
         LA    R02,PJOBNAME            LOAD ADDRESS OF JOB NAME
         LA    R03,PSTEPNME            LOAD ADDRESS OF STEP NAME
         STM   R02,R03,PJNMEADR        STORE ADDRESSES
         OI    PSNMEADR,X'80'          INDICATE LAST ENTRY
         SPACE 2
*
*      SET FLAG BYTES IN MESSAGE AREA.
*
         SPACE 1
         LA    R10,MSGTAB              LOAD ADDRESS OF TABLE
         ST    R10,SAVE1R10                AND STORE IT
         L     R03,ADDRETB1            LOAD ADDRESS OF TABLE END
CLEARMSS EQU   *
         MVC   MSGFLAG,=X'FFFF'        SET FLAGS
         LA    R10,68(R10)             LOAD ADDRESS OF NEXT ENTRY
         CR    R10,R03                 TABLE END ?
         BL    CLEARMSS                BRANCH IF NOT
         SPACE 1
         L     R02,16                  LOAD ADRESSE OF CVT
         TM    116(R02),X'10'          SYSTEM = MVS ?
         BZ    GETPARM                 BRANCH IF NOT
         L     R02,764(R02)            LOAD ADRESSE OF PCCAVT
         LTR   R02,R02                 PCCAVT AVAILABLE ?
         BZ    GETPARM                 BRANCH IF NOT
         CLC   0(4,R02),=XL6'0'        CPU 0 AVAILABLE ?
         BE    *+8                     BRANCH IF NOT
         OI    CPUBYTE,X'F0'           SET FLAGS
         CLC   4(4,R02),=XL6'0'        CPU 1 AVAILABLE ?
         BE    GETPARM                 BRANCH IF NOT
         OI    CPUBYTE,X'0F'           SET FLAGS
         EJECT
***********************************************************************
*                                                                     *
*      INPUT PARAMETER PROCESSING.                                    *
*                                                                     *
***********************************************************************
         SPACE 3
GETPARM  EQU   *
         CLC   TEXT(4),=C'DVOL'        VOLUMES SPECIFIED ?
         BNE   *+8                     BRANCH IF NOT
         MVI   VOLBYTE,X'FF'           SET FLAG
         LA    R04,TEXT+4              LOAD ADDRESS OF PARAMETER CHAIN
         LA    R08,PARMEND             LOAD ADDRESS OF PARAMETER END
         LA    R06,TABPVOL1            LOAD ADDRESS OF VOLUME TABLE
         CLI   0(R04),C','             PARAMETERS SPECIFIED ?
         BNE   NOPARM                  BRANCH IF NOT
NEXTPARM EQU   *
         SR    R05,R05                 ZERO LENGTH COUNT
         LR    R07,R04                 LOAD ADDRESS OF SEPERATOR
NXTBYTE  EQU   *
         LA    R04,1(R04)              LOAD ADDRESS OF NEXT CHARACTER
         CR    R04,R08                 END OF PARAMETER CHAIN ?
         BNL   PRMERROR                IF YES, BRANCH TO ERROR ROUTINE
         CLI   0(R04),C','             END OF PARAMETER ?
         BE    NEXTPVOL                BRANCH IF YES
         CLI   0(R04),X'00'            END OF PARAMETER CHAIN ?
         BE    NEXTPVOL                BRANCH IF YES
         CLI   0(R04),C' '             END OF PARAMETER CHAIN ?
         BE    NEXTPVOL                BRANCH IF YES
         LA    R05,1(R05)              INCREASE LENGTH COUNT
         CLI   0(R04),C'*'             DON'T CARE CHARACTER ?
         BNE   NXTBYTE                 BRANCH IF NOT
         MVI   0(R04),X'FF'            TRANSLATE CHARACTER
         B     NXTBYTE                 BRANCH
         EJECT
NEXTPVOL EQU   *
         BAL   R14,SETFLAGS            BRANCH TO SET FLAGS
         C     R06,ADDRETPV            END OF TABLE ?
         BNL   PRMERROR                IF YES, BRANCH TO ERROR ROUTINE
         C     R05,=F'6'               VALID LENGTH ?
         BH    PRMERROR                IF NOT, BRANCH TO ERROR ROUTINE
         LTR   R05,R05                 VALID LENGTH ?
         BZ    PRMERROR                IF NOT, BRANCH TO ERROR ROUTINE
         BCTR  R05,0                   MODIFY FOR EX COMMAND
         EX    R05,MOVEPVOL            BRANCH TO MOVE VOLSER NUMBER
         STC   R05,0(R06)              STORE LENGTH
         LA    R06,7(R06)              LOAD ADDRESS OF NEXT ENTRY
         CLI   0(R04),C','             MORE PARAMETERS IN CHAIN ?
         BE    NEXTPARM                BRANCH IF YES
         SPACE 2
*
*      END OF PARAMETER PROCESSING.
*
         SPACE 1
ENDPARM  EQU   *
         MVI   0(R06),X'80'            INDICATE END OF TABLE
         MVC   TABPVOL2,TABPVOL1       COPY TABLE
         LA    R06,TABPVOL2-1          LOAD ADDRESS OF TABLE
NEXTFF   EQU   *
         LA    R06,1(R06)              LOAD ADDRESS OF NEXT CHARACTER
         CLI   0(R06),X'80'            END OF TABLE ?
         BE    GETFASID                BRANCH IF YES
         CLI   0(R06),X'FF'            CHARACTER = X'FF' ?
         BNE   NEXTFF                  BRANCH IF NOT
         MVI   0(R06),X'00'            TRANSLATE CHARACTER
         B     NEXTFF                  BRANCH
         SPACE 1
NOPARM   EQU   *
         MVI   NOPMFLAG,X'FF'          SET FLAG
         B     ENDPARM                 BRANCH
         EJECT
***********************************************************************
*                                                                     *
*      SET PARAMETER FLAGS.                                           *
*                                                                     *
***********************************************************************
         SPACE 3
SETFLAGS EQU   *
         LA    R01,PRMTABLE-10         LOAD ADDRESS OF TABLE
         LA    R02,PRMFLAGS            LOAD ADDRESS OF FLAG BYTES
         SR    R03,R03                 ZERO FOR IC COMMAND
SETFLGLP EQU   *
         LA    R01,10(R01)             LOAD ADDRESS OF NEXT ENTRY
         LA    R02,1(R02)              LOAD ADRESS OF NEXT FLAG BYTE
         CLI   0(R01),X'FF'            END OF TABLE ?
         BER   R14                     RETURN IF YES
         IC    R03,0(R01)              INSERT LENGTH
         EX    R03,CLCPARM             BRANCH TO COMPARE PARAMETERS
         BNE   SETFLGLP                BRANCH IF NOT EQUAL
         MVI   PARMFLAG,X'FF'          SET FLAGS
         MVI   0(R02),X'FF'            SET FLAGS
         CLI   0(R04),C','             MORE PARAMETERS IN CHAIN ?
         BE    NEXTPARM                BRANCH IF YES
         B     ENDPARM                 BRANCH
         SPACE 2
GETFASID EQU   *
         LOAD  EP=FASID                LOAD ENTRY POINT ADDRESS
         ST    R00,FASIDADR                AND STORE IT
         EJECT
***********************************************************************
*                                                                     *
*      PROCESSING OF UCB INFORMATION.                                 *
*                                                                     *
***********************************************************************
         SPACE 3
GETUCB   EQU   *
         DROP  R11                     FREE BASE REG. OF PARMAREA
         GETMAIN R,LV=UCBTBLEN,SP=125
         LR    R11,R01                 INITIALIZE BASE REG. OF UCBADTAB
         USING UCBADTAB,R11            ALLOC. BASE REG. OF UCBADTAB
         ST    R11,UCBADDR             STORE ADDRESS OF TABLE
         MVI   UCBADDR,X'80'           SET OPTION BYTE
         LA    R01,UCBADDR             LOAD ADDRESS OF PARAMETER
         LINK  EP=GETUCBS              LINK TO SUBROUTINE
         LA    R02,UCBADTAB            LOAD ADDRESS OF TABLE
         SR    R03,R03                 ZERO FOR ICM COMMAND
         MVC   UCBTBEND,=X'FFFF'       SPECIFY END OF TABLE
         S     R02,=F'2'               DECREASE ADDRESS
NEXTUCB  EQU   *
         LA    R02,2(R02)              LOAD ADDRESS OF NEXT ENTRY
         CLC   0(2,R02),=X'FFFF'       END OF TABLE ?
         BE    ENDPROC                 BRANCH IF YES
         ICM   R03,3,0(R02)            LOAD ADDRESS OF UCB
         SPACE 1
         MVI   FNDBYTE,X'FF'           SET FLAGS
         TM    PARMFLAG,X'FF'          SELECT PARAMETERS ?
         BZ    *+8                     BRANCH IF NOT
         BAL   R14,TSTFLAGS            BRANCH TO TEST FLAGS
         TM    FNDBYTE,X'FF'           TEST OK ?
         BZ    NEXTUCB                 BRANCH IF NOT
         EJECT
*
*      COMPARISON OF UCB ADDRESSES OR VOLSER NUMBERS.
*
         SPACE 1
         SR    R05,R05                 ZERO FOR IC COMMAND
         LA    R06,TABPVOL1-7          LOAD ADDRESS OF TABLE
         LA    R07,TABPVOL2-7          LOAD ADDRESS OF TABLE
NXTVOLID EQU   *
         LA    R06,7(R06)              LOAD ADDRESS OF NEXT ENTRY
         LA    R07,7(R07)              LOAD ADDRESS OF NEXT ENTRY
         TM    0(R06),X'80'            END OF TABLE ?
         BO    TESTADDR                BRANCH IF YES
         IC    R05,0(R06)              INSERT LENGTH
         CLI   VOLBYTE,X'FF'           VOLSER NUMBERS SPECIFIED ?
         BNE   NEXTADR                 BRANCH IF NOT
         TM    UCBDVCLS,X'A0'          TAPE OR DIRECT ACCESS ?
         BZ    NEXTUCB                 BRANCH IF NOT
         CLC   UCBVOLI,=XL6'0'         VOLSER NUMBER ?
         BE    NEXTUCB                 BRANCH IF NOT
         MVC   ZWVOLID1,UCBVOLI        MOVE VOLSER NUMBER
         MVC   ZWVOLID2,UCBVOLI        MOVE VOLSER NUMBER
EXMVC    EQU   *
         EX    R05,NCVOLID1            BRANCH TO TRANSLATE VOLID
         EX    R05,OCVOLID2            BRANCH TO TRANSLATE VOLID
         CLC   ZWVOLID1,ZWVOLID2       VOLID VALID ?
         BNE   NXTVOLID                BRANCH IF NOT
         MVC   VOLSERNO,UCBVOLI        MOVE VOLSER NUMBER
         B     MVCMSG                  BRANCH
         SPACE 1
NEXTADR  EQU   *
         MVC   ZWVOLID1,UCBNAME        MOVE UNIT NAME
         MVC   ZWVOLID2,UCBNAME        MOVE UNIT NAME
         B     EXMVC                   BRANCH
         SPACE 1
TESTADDR EQU   *
         TM    TABPVOL1,X'80'          ADDRESSES OR VOLUMES SPEC. ?
         BZ    NEXTUCB                 BRANCH IF YES
         TM    VOLBYTE,X'FF'           VOLSER NUMBERS SPECIFIED ?
         BZ    MVCMSG                  BRANCH IF NOT
         TM    UCBDVCLS,X'A0'          TAPE OR DIRECT ACCESS ?
         BZ    NEXTUCB                 BRANCH IF NOT
         EJECT
***********************************************************************
*                                                                     *
*      EDIT MESSAGE LINES.                                            *
*                                                                     *
***********************************************************************
         SPACE 3
MVCMSG   EQU   *
         L     R10,SAVE1R10            INITIALIZE BASE REG. OF MESSAGE
         MVC   MESSAGE(LENMSG02),MSG02 MOVE MESSAGE SKELETON
         MVC   MSGNAME,PNAME           MOVE NAME OF PROGRAM
         MVC   MSGADR,UCBNAME          MOVE NAME OF UNIT
         STCM  R03,3,MSGUCBAD          STORE ADDRESS OF UNIT
         UNPK  MSGUCBAD(5),MSGUCBAD(3) UNPACK ADDRESS
         MVI   MSGUCBAD+4,C' '
         TR    MSGUCBAD,TABHEXA-240    TRANSLATE ADDRESS
         SPACE 1
         TM    UCBSTAT,UCBONLI         DEVICE ONLINE ?
         BO    TESTSYS                 BRANCH IF YES
         MVC   MSGLINE,=C'OFF'         SPECIFY OFFLINE
         B     TESTALOC                BRANCH
TESTSYS  EQU   *
         TM    CPUBYTE,X'FF'           SYSTEM = MVS ?
         BZ    TESTALOC                BRANCH IF NOT
         TM    UCBFL5,UCBALTPH         ALTERNATE PATH ?
         BNZ   TESTCPU0                BRANCH IF YES
         MVC   MSGPATH0(5),=C' N/A '   NOT APPLICATABLE
         B     TESTALOC                BRANCH
TESTCPU0 EQU   *
         TM    CPUBYTE,X'F0'           CPU 0 AVAILABLE ?
         BZ    TESTCPU1                BRANCH IF NOT
         MVC   MSGPATH0,=C'**'
         TM    UCBCHM,UCBPPA           PRIMARY PATH FROM CPU 0 ?
         BNZ   *+8                     BRANCH IF NOT
         MVI   MSGPATH0,C'1'
         TM    UCBCHM,UCBSPA           SECONDARY PATH FROM CPU 0 ?
         BNZ   TESTCPU1                BRANCH IF NOT
         MVI   MSGPATH0+1,C'1'
TESTCPU1 EQU   *
         TM    CPUBYTE,X'0F'           CPU 1 AVAILABLE ?
         BZ    TESTALOC                BRANCH IF NOT
         MVC   MSGPATH1,=C'**'
         TM    UCBCHM,UCBPPB           PRIMARY PATH FROM CPU 1 ?
         BNZ   *+8                     BRANCH IF NOT
         MVI   MSGPATH1,C'1'
         TM    UCBCHM,UCBSPB           SECONDARY PATH FROM CPU 1 ?
         BNZ   TESTALOC                BRANCH IF NOT
         MVI   MSGPATH1+1,C'1'
         EJECT
TESTALOC EQU   *
         TM    UCBSTAT,UCBALOC         DEVICE ALLOCATED ?
         BZ    TESTNRDY                BRANCH IF NOT
         MVC   MSGALLOC,=8C'.'         INITIALIZE MESSAGE AREA
         MVC   PJOBNAME,=CL8' '        CLEAR JOB NAME
         L     R09,UCBEXTPT            LOAD ADDRESS OF COMMON UCB EXT.
         LA    R09,UCBASID             LOAD ADDRESS OF ASID
         ST    R09,PASIDADR                AND STORE IT
         LA    R01,PARMLIST            LOAD ADDRESS OF PARAMETER LIST
         L     R15,FASIDADR            LOAD ADDRESS OF SUBROUTINE
         BALR  R14,R15                 BRANCH TO SUBROUTINE
         LTR   R15,R15                 VALID JOB NAME ?
         BNZ   TESTNRDY                BRANCH IF NOT
         MVC   MSGALLOC,PJOBNAME       MOVE JOB NAME
TESTNRDY EQU   *
         TM    UCBFLA,UCBNRY           DEVICE READY ?
         BZ    TSTCUBSY                BRANCH IF YES
         MVC   MSGREADY,=C'NR'         INDICATE NOT READY
TSTCUBSY EQU   *
         TM    UCBFLA,UCBCUB           CONTROL UNIT BUSY ?
         BZ    TSTDVBSY                BRANCH IF NOT
         MVC   MSGSTAT(4),=C'CUBS'     MOVE TEXT
         B     TSTDVRES                BRANCH
TSTDVBSY EQU   *
         TM    UCBFLA,UCBBSY           DEVICE BUSY ?
         BZ    TSTMOUNT                BRANCH IF NOT
         MVC   MSGSTAT(4),=C'BUSY'     MOVE TEXT
         B     TSTDVRES                BRANCH
TSTMOUNT EQU   *
         TM    UCBDMCT,UCBMOUNT        MOUNT PENDING ?
         BZ    TSTIOREC                BRANCH IF NOT
         MVC   MSGSTAT(5),=C'MOUNT'    MOVE TEXT
         EJECT
TSTIOREC EQU   *
         TM    UCBFLA,UCBQISCE         IO RECOVERY ACTIVE ?
         BZ    TSTDVRES                BRANCH IF NOT
         MVC   MSGSTAT(5),=C'IOREC'    MOVE TEXT
         B     TESTVOLI                BRANCH
TSTDVRES EQU   *
         TM    UCBFLB,UCBRESVH         DEVICE RESERVED ?
         BZ    TESTVOLI                BRANCH IF NOT
         MVC   MSGSTAT+4(2),=C'-R'     MOVE TEXT
TESTVOLI EQU   *
         TM    UCBDVCLS,X'A0'          TAPE OR DIRECT ACCESS ?
         BZ    TESTDFLT                BRANCH IF NOT
         CLC   UCBVOLI,=XL6'0'         VOLID ?
         BE    TESTSTOR                BRANCH IF NOT
         MVC   MSGVOLID,UCBVOLI        MOVE VOLSER NUMBER
TESTSTOR EQU   *
         TM    UCBSTAB,UCBBSTR         STORAGE VOLUME ?
         BZ    TESTPUB                 BRANCH IF NOT
         MVC   MSGATTR1,=C'STG/RMV'    SPECIFY STORAGE VOLUME
TESTPUB  EQU   *
         TM    UCBSTAB,UCBBPUB         PUBLIC VOLUME ?
         BZ    TESTPRV                 BRANCH IF NOT
         MVC   MSGATTR1,=C'PUB/RMV'    SPECIFY PUBLIC VOLUME
TESTPRV  EQU   *
         TM    UCBSTAB,UCBBPRV         PRIVATE VOLUME ?
         BZ    TESTRES                 BRANCH IF NOT
         MVC   MSGATTR1,=C'PRV/RMV'    SPECIFY PRIVATE VOLUME
TESTRES  EQU   *
         TM    UCBSTAT,UCBPRES         VOLUME RESIDENT ?
         BZ    TESTRSV                 BRANCH IF NOT
         MVC   MSGATTR2,=C'RES'        SPECIFY RESIDENT VOLUME
TESTRSV  EQU   *
         TM    UCBSTAT,UCBRESV         VOLUME RESERVED ?
         BZ    TESTDFLT                BRANCH IF NOT
         MVC   MSGATTR2,=C'RSV'        SPECIFY RESERVED VOLUME
TESTDFLT EQU   *
         CLI   NOPMFLAG,X'FF'          DEFAULT OUTPUT ?
         BNE   MSGOK                   BRANCH IF NOT
         CLC   MSGSTAT,=CL8' '         STATUS INFORMATION ?
         BE    NEXTUCB                 BRANCH IF NOT
         CLC   MSGSTAT(5),=C'MOUNT'    MOUNT PENDING ?
         BE    NEXTUCB                 BRANCH IF NOT
MSGOK    EQU   *
         MVI   WTOBYTE,X'FF'           SET FLAGS
         LA    R14,NEXTUCB             LOAD RETURN ADDRESS
         MVC   MSGFLAG,=XL6'0'         CLEAR FLAG BYTES
         LA    R10,68(R10)             LOAD ADDRESS OF NEXT ENTRY
         C     R10,ADDRETB1            END OF TABLE
         BNL   PUTMSG                  BRANCH IF YES
         ST    R10,SAVE1R10            SAVE CURRENT ADDRESS
         BR    R14                     RETURN
         EJECT
***********************************************************************
*                                                                     *
*      FINAL PROCESSING.                                              *
*                                                                     *
***********************************************************************
         SPACE 3
ENDPROC  EQU   *
         FREEMAIN R,SP=125             FREE TABLE AREA
         MVI   WTORBYTE,X'00'          CLEAR FLAG BYTE
         TM    WTOBYTE,X'FF'           MESSAGE OUTPUT ?
         BNZ   PUTOPMSG                BRANCH IF YES
         LA    R10,MSGTAB              LOAD ADDRESS OF TABLE
         MVC   MESSAGE(LENMSG03),MSG03 MOVE MESSAGE
         CLI   VOLBYTE,X'FF'           PROGRAM = X-DVOL ?
         BE    *+10                    BRANCH IF YES
         MVC   MSGNAME,PNAME           MOVE NAME OF PROGRAM
         L     R00,UCMID               LOAD UCM ID. OF CALLER
         WTO   MF=(E,MESSAGE)          DISPLAY MESSAGE
         B     RETURN                  BRANCH
         SPACE 2
*
*      DISPLAY OF OPEN MESSAGES.
*
         SPACE 1
PUTOPMSG EQU   *
         LA    R10,MSGTAB              LOAD ADDRESS OF TABLE
         CLC   MSGFLAG,=XL6'0'         ALL MESSAGES DISPLAYED ?
         BNE   RETURN                  BRANCH IF NOT
         BAL   R14,PUTMSG              IF YES, BR. TO MESSAGE OUTPUT
         EJECT
*
*      FREE WORK AREAS,
*      RELOAD REGISTER CONTENTS,
*      RETURN.
*
         SPACE 1
RETURN   EQU   *
         XRETURN ,R
         SPACE 3
***********************************************************************
*                                                                     *
*      PARAMETER ERROR ROUTINE.                                       *
*                                                                     *
***********************************************************************
         SPACE 3
PRMERROR EQU   *
         LA    R10,MSGTAB              LOAD ADDRESS OF MESSAGE TABLE
         MVC   MESSAGE(LENMSG04),MSG04 MOVE MESSAGE
         MVC   MSGNAME,PNAME           MOVE NAME OF PROGRAM
         L     R00,UCMID               LOAD UCM ID. OF CALLER
         WTO   MF=(E,MESSAGE)          DISPLAY MESSAGE
         B     RETURN                  BRANCH
         EJECT
***********************************************************************
*                                                                     *
*      TEST DEVICES FOR SPECIFIED STATUS.                             *
*                                                                     *
***********************************************************************
         SPACE 3
TSTFLAGS EQU   *
         CLC   TAPEFLAG(5),=XL6'0'     DEVICES TYPE(S) SPECIFIED ?
         BE    TSTMSS                  BRANCH IF NOT
         LA    R04,PRMTABLE-10         LOAD ADDRESS OF TABLE
         LA    R05,PRMFLAGS            LOAD ADDRESS OF FLAG BYTES
TSTDEVLP EQU   *
         LA    R04,10(R04)             LOAD ADDRESS OF NEXT ENTRY
         CLI   1(R04),X'FF'            END OF TABLE ?
         BE    CLEARFLG                BRANCH IF YES
         LA    R05,1(R05)              LOAD ADDRESS OF NEXT FLAG BYTE
         TM    0(R05),X'FF'            FLAG ON ?
         BZ    TSTDEVLP                BRANCH IF NOT
         CLC   UCBDVCLS,1(R04)         SPECIFIED DEVICE TYPE ?
         BNE   TSTDEVLP                BRANCH IF NOT
         SPACE 1
TSTMSS   EQU *
         TM    MSSFLAG,X'FF'           VIRTUAL DEVICES SPECIFIED ?
         BZ    TSTNOMSS                BRANCH IF NOT
         TM    UCBDVCLS,UCB3DACC       DIRECT ACCESS ?
         BZ    TSTMSC                  BRANCH IF NOT
         TM    UCBTBYT2,UCBRVDEV       VIRTUAL DEVICE ?
         BZ    CLEARFLG                BRANCH IF NOT
         B     TSTPLINE                BRANCH
TSTNOMSS EQU   *
         TM    UCBDVCLS,UCB3DACC       DIRECT ACCESS ?
         BZ    TSTNOMSC                BRANCH IF NOT
         TM    UCBTBYT2,UCBRVDEV       VIRTUAL DEVICE ?
         BO    CLEARFLG                BRANCH IF YES
         B     TSTPLINE                BRANCH
TSTNOMSC EQU   *
         TM    UCBUNTYP,UCBDSM         MSC ?
         BO    CLEARFLG                BRANCH IF YES
         EJECT
TSTPLINE EQU   *
         CLC   ONLFLAG(2),=XL6'0'      ON/OFFLINE DEVICES SPECIFIED ?
         BE    TSTREADY                BRANCH IF NOT
         TM    UCBSTAT,UCBONLI         DEVICE ONLINE ?
         BZ    TSTPOFFL                BRANCH IF NOT
         TM    ONLFLAG,X'FF'           ONLINE DEVICES SPECIFIED ?
         BZ    CLEARFLG                BRANCH IF NOT
         B     TSTREADY                BRANCH
TSTPOFFL EQU   *
         TM    OFFLFLAG,X'FF'          OFFLINE DEVICES SPECIFIED ?
         BZ    CLEARFLG                BRANCH IF NOT
         SPACE 1
TSTREADY EQU   *
         TM    RDYFLAG,X'FF'           READY DEVICES SPECIFIED ?
         BZ    TSTFLGOK                BRANCH IF NOT
         TM    UCBSFLS,UCBNRY          DEVICE READY ?
         BO    CLEARFLG                BRANCH IF NOT
         SPACE 1
TSTFLGOK EQU   *
         BR    R14                     RETURN
         SPACE 2
CLEARFLG EQU   *
         MVI   FNDBYTE,X'00'           CLEAR FLAG BYTE
         BR    R14                     RETURN
TSTMSC   EQU   *
         TM    UCBUNTYP,UCBDSM         MSC ?
         BNO   CLEARFLG                BRANCH IF NOT
         B     TSTPLINE                BRANCH IF YES
         EJECT
***********************************************************************
*                                                                     *
*      MESSAGE DISPLAY.                                               *
*                                                                     *
***********************************************************************
         SPACE 3
PUTMSG   EQU   *
         ST    R14,SAVE1R14            SAVE RETURN ADDRESS
         L     R00,UCMID               LOAD UCM ID. OF CALLER
         WTO   MF=(E,HEADER)           DISPLAY HEAD LINE
         LA    R10,MSGTAB-68           LOAD ADDRESS OF TABLE
         L     R09,ADDRETB1            LOAD ADDRESS OF TABLE END
         BAL   R14,DISPLAY             BRANCH TO DISPLAY
         LA    R10,MSGTAB              LOAD ADDRESS OF TABLE
         ST    R10,SAVE1R10                AND STORE IT
         L     R14,SAVE1R14            LOAD RETURN ADDRESS
         CLI   WTORBYTE,X'FF'          FLAG ON ?
         BNER  R14                     RETURN IF NOT
NXTREPLY EQU   *
         XC    ECB,ECB                 CLEAR EVENT CONTROL BLOCK
         MVI   REPLY,C' '              CLEAR REPLY AREA
         L     R00,UCMID               LOAD UCM ID. OF CALLER
         LA    R04,ECB                 LOAD ADDRESS OF ECB
         LA    R05,REPLY               LOAD ADDRESS OF REPLY
         WTOR  ,(R05),1,(R04),MF=(E,WTOR)
         SPACE 1
         WAIT  ECB=ECB                 WAIT FOR COMPLETION
         CLI   REPLY,C'N'              REPLY = NO ?
         BE    RETURN                  BRANCH IF YES
         CLI   REPLY,C'Y'              REPLY = YES ?
         BNE   NXTREPLY                BRANCH IF NOT
         L     R14,SAVE1R14            LOAD RETURN ADDRESS
         BR    R14                     RETURN
         EJECT
*
*      DISPLAY SINGLE MESSAGE LINES.
*
         SPACE 1
DISPLAY  EQU   *
         ST    R14,SAVE2R14            SAVE RETURN ADDRESS
NEXTMSG  EQU   *
         LA    R10,68(R10)             LOAD ADDRESS OF NEXT ENTRY
         CR    R10,R09                 END OF TABLE ?
         BNL   ENDMSG                  BRANCH IF YES
         CLC   MSGFLAG,=X'FFFF'        FLAGS ON ?
         BE    ENDMSG                  BRANCH IF YES
         MVC   MSGFLAG,=X'FFFF'        SET FLAGS
         L     R00,UCMID               LOAD UCM ID. OF CALLER
         WTO   MF=(E,MESSAGE)          DISPLAY ONE MESSAGE
         B     NEXTMSG                 BRANCH
ENDMSG   EQU   *
         L     R14,SAVE2R14            LOAD RETURN ADDRESS
         BR    R14                     RETURN
         SPACE 3
***********************************************************************
*                                                                     *
*      COMMANDS VIA EXECUTE COMMAND.                                  *
*                                                                     *
***********************************************************************
         SPACE 3
MOVEPVOL EQU   *
         MVC   1(0,R06),1(R07)         MOVE VOLID TO TABLE
NCVOLID1 EQU   *
         NC    ZWVOLID1(0),1(R06)      TRANSLATE VOLID
OCVOLID2 EQU   *
         OC    ZWVOLID2(0),1(R07)      TRANSLATE VOLID
CLCPARM  EQU   *
         CLC   2(0,R01),1(R07)         PARAMETER = TABLE ENTRY ?
         EJECT
***********************************************************************
*                                                                     *
*      REGISTER EQUATES.                                              *
*                                                                     *
***********************************************************************
         SPACE 3
R00      EQU   0                       MACRO AND PARAMETER REGISTER
R01      EQU   1                       MACRO AND PARAMETER REGISTER
R02      EQU   2                       PTR. IN CVT / UCB LOOKUP TABLE
R03      EQU   3                       POINTER TO UCB
R04      EQU   4                       WORK REGISTER
R05      EQU   5                       WORK REGISTER
R06      EQU   6                       WORK REGISTER
R07      EQU   7                       WORK REGISTER
R08      EQU   8                       WORK REGISTER
R09      EQU   9                       BASE OF COMMON UCB EXTENSION
R10      EQU   10                      POINTER IN MESSAGE TABLE
R11      EQU   11                      BASE OF PARMAREA / UCBADTAB
R12      EQU   12                      BASE OF CSECT DVOL
R13      EQU   13                      BASE OF WKAREA
R14      EQU   14                      RETURN ADDRESSES
R15      EQU   15                      CSECT ADRESSES AND RETURN CODES
         EJECT
***********************************************************************
*                                                                     *
*      TRANSLATE TABLE.                                               *
*                                                                     *
***********************************************************************
         SPACE 2
TABHEXA  DC    C'0123456789ABCDEF'
         SPACE 3
***********************************************************************
*                                                                     *
*      PARAMETER TABLE.                                               *
*                                                                     *
***********************************************************************
         SPACE 2
PRMTABLE EQU   *
         DC    X'03',X'80',CL8'TAPE'
         DC    X'03',X'20',CL8'DASD'
         DC    X'01',X'08',CL8'UR'
         DC    X'01',X'40',CL8'TP'
         DC    X'06',X'10',CL8'GRAPHIC'
         DC    X'02',X'FF',CL8'MSS'
         DC    X'05',X'FF',CL8'ONLINE'
         DC    X'06',X'FF',CL8'OFFLINE'
         DC    X'04',X'FF',CL8'READY'
         DC    X'FF',X'FF',CL8' '      TABLE END
         EJECT
***********************************************************************
*                                                                     *
*      MESSAGE CONSTANTS.                                             *
*                                                                     *
***********************************************************************
         SPACE 3
MSG01    WTO   'XDVOL01 VOLSER ADR LNE -ALLOC-- -STATUS-- PATHS -ATTR--*
                UCB ',                                                 *
               MF=L,MCSFLAG=(REG0)
LENMSG01 EQU   *-MSG01
         SPACE 1
MSG02    WTO   'XDVOL02        ADR ON      NO   RD        ../..   N/A  *
                9999',                                                 *
               MF=L,MCSFLAG=(REG0)
LENMSG02 EQU   *-MSG02
         SPACE 1
MSG03    WTO   'XDVOL03 NO OUTPUT PRODUCED',                           *
               MF=L,MCSFLAG=(REG0)
LENMSG03 EQU   *-MSG03
         SPACE 1
MSG04    WTO   'XDVOL04 INVALID PARAMETER LIST',                       *
               MF=L,MCSFLAG=(REG0)
LENMSG04 EQU   *-MSG04
         EJECT
MSG05    WTOR  'XDVOL05 REPLY ''Y'' (YES) OR ''N'' (NO) TO CONTINUE',  *
               MF=L,MCSFLAG=(REG0)
LENMSG05 EQU   *-MSG05
         SPACE 3
         LTORG
         EJECT
***********************************************************************
*                                                                     *
*      WORK AREAS.                                                    *
*                                                                     *
***********************************************************************
         SPACE 3
WKAREA   DSECT
SAVEAREA DS    18F                     SAVEAREA OF GENERAL REGISTERS
         SPACE 2
*
*      ADRESSEN-SPEICHER.
*
         SPACE 1
ADDRETB1 DS    F                       END ADDRESS OF MESSAGE TABLE
ADDRETPV DS    F                       END ADDRESS OF VOLUME TABLE
SAVE1R10 DS    F                       SAVEAREA1 OF R10
SAVE1R14 DS    F                       SAVEAREA1 OF R14
SAVE2R14 DS    F                       SAVEAREA2 OF R14
UCBADDR  DS    F                       ADDRESS OF UCB TABLE
FASIDADR DS    F                       ADDRESS OF SUBROUTINE 'FASID'
UCMID    DS    F                       UCM ID. OF CALLER
         SPACE 2
*
*      WORK AREAS.
*
         SPACE 1
ECB      DS    F                       EVENT CONTROL BLOCK
FNDBYTE  DS    C                       FLAG
VOLBYTE  DS    C                       FLAG OF SPECIFIED VOLUMES
CPUBYTE  DS    C                       FLAG BYTE OF CPU'S
WTOBYTE  DS    C                       FLAG OF WTO
WTORBYTE DS    C                       FLAG OF WTOR
REPLY    DS    C                       REPLY AREA
VOLSERNO DS    CL6                     VOLSER NUMBER
ZWVOLID1 DS    CL6                     VOLSER NUMBER
ZWVOLID2 DS    CL6                     VOLSER NUMBER
PNAME    DS    CL4                     NAME OF PROGRAM
         SPACE 2
*
*      PARAMETER LIST OF 'FASID'.
*
         SPACE 1
PARMLIST DS    0F
PASIDADR DS    F                       ADDRESS OF ASID
PJNMEADR DS    F                       ADDRESS OF JOB NAME
PSNMEADR DS    F                       ADDRESS OF STEP NAME
PJOBNAME DS    CL8                     JOB NAME
PSTEPNME DS    CL8                     STEP NAME
         EJECT
*
*      PARAMETER FLAGS.
*
         SPACE 1
PRMFLAGS DS    0CL8
PARMFLAG DS    C                       FLAG BYTE OF PARAMETER
TAPEFLAG DS    C                       FLAG BYTE OF TAPE SELECT.
DASDFLAG DS    C                       FLAG BYTE OF DASD SELECT.
URFLAG   DS    C                       FLAG BYTE OF UR SELECT.
TPFLAG   DS    C                       FLAG BYTE OF TP SELECT.
GRAPFLAG DS    C                       FLAG BYTE OF GRAPHIC SELECT.
MSSFLAG  DS    C                       FLAG BYTE OF MSS SELECT.
ONLFLAG  DS    C                       FLAG BYTE OF ONLINE SELECT.
OFFLFLAG DS    C                       FLAG BYTE OF OFFLINE SELECT.
RDYFLAG  DS    C                       FLAG BYTE OF READY SELECT.
NOPMFLAG DS    C                       FLAG BYTE OF DEFAULT DISPLAY
PFLAGLEN EQU   *-PRMFLAGS              LENGTH OF FLAG BYTES
         SPACE 2
*
*      TABLE WITH PARAMETER ADDRESSES OR VOLSER NUMBERS.
*
*      BYTE1 - LENGTH OF PARAMETER OR X'80'
*      BYTES2-7 - PARAMETER VALUE(S)
*
         SPACE 1
TABPVOL1 DS    10CL7                   TABLE 1
ENDTPVOL EQU   *
         DS    CL7
TABPVOL2 DS    CL77                    TABLE 2
         SPACE 2
*
*      MESSAGE AREA.
*
*      BYTE1-66: WTO MESSAGE LINE
*      BYTE67-68: X'0000', IF MESSAGE LINE AVAILABLE
*
         SPACE 1
         DS    0F
MSGTAB   DS    10CL68
ENDTAB1  EQU   *
HEADER   DS    17F                     HEAD LINE
WTOR     DS    15F                     WTOR LINE
         SPACE 1
WKAREALN EQU   *-WKAREA                LENGTH OF WORK AREAS
         EJECT
***********************************************************************
*                                                                     *
*      MESSAGE AREA.                                                  *
*                                                                     *
***********************************************************************
         SPACE 3
MESSAGE  DSECT
         ORG   MESSAGE+5
MSGNAME  DS    CL4                     PROGRAM NAME
         DS    CL3
MSGVOLID DS    CL6                     VOLUME SERIAL NUMBER
         DS    CL1
MSGADR   DS    CL3                     UNIT ADDRESS
         DS    CL1
MSGLINE  DS    CL3                     ON/OFF LINE
         DS    CL1
MSGALLOC DS    CL8                     UNIT ALLOC
         DS    CL1
MSGREADY DS    CL2                     UNIT READY
         DS    CL1
MSGSTAT  DS    CL6                     UNIT STATUS
         DS    CL1
MSGPATH0 DS    CL2                     PATHS FROM CPU 0
         DS    CL1
MSGPATH1 DS    CL2                     PATHS FROM CPU 1
         DS    CL1
MSGATTR1 DS    CL7                     ATTRIBUTES
         ORG   *-3
MSGATTR2 DS    CL3                     ATTRIBUTES
         DS    CL1
MSGUCBAD DS    CL4                     UCB ADDRESS
         ORG   MESSAGE+13
WTORNAME DS    CL4                     PROGRAM NAME
         ORG   MESSAGE+66
MSGFLAG  DS    CL2                     FLAG BYTES
         EJECT
***********************************************************************
*                                                                     *
*      INPUT PARAMETER AREA.                                          *
*                                                                     *
***********************************************************************
         SPACE 3
         XPARM
PARMEND  EQU   *
         SPACE 3
***********************************************************************
*                                                                     *
*      UCB ADDRESS TABLE.                                             *
*                                                                     *
***********************************************************************
         SPACE 3
UCBADTAB DSECT
         DS    1024H
UCBTBEND DS    H             =X'FFFF'
UCBTBLEN EQU   *-UCBADTAB
         EJECT
***********************************************************************
*                                                                     *
*      UCB-DEFINITIONEN.                                              *
*                                                                     *
***********************************************************************
         SPACE 2
UCB      DSECT
         IEFUCBOB LIST=YES
         END   DVOL
./ ADD  NAME=VARY
         TITLE '                                        X-COMMAND VARY'
XVARY    CSECT
         SPACE 3
***********************************************************************
*                                                                     *
*      PROGRAM-ID. XVARY.                                             *
*      AUTHOR. EHNERT.                                                *
*      INSTALLATION. BAYER AG, LEVERKUSEN, RECHENZENTRUM.             *
*      DATE-WRITTEN. 03. 02. 1977.                                    *
*      REMARKS.                                                       *
*                                                                     *
*          MIT HILFE DES X-COMMANDS 'VARY' KOENNEN VARY-COMMANDS      *
*          IN FORMATEN EINGEGEBEN WERDEN, DIE VOM BETIEBSSYSTEM       *
*          HER NICHT ZULAESSIG SIND.                                  *
*                                                                     *
***********************************************************************
         EJECT
***********************************************************************
*                                                                     *
*      INITIAL PROCESSING.                                            *
*                                                                     *
***********************************************************************
         SPACE 3
         XSAVE R12,,XVARY,WORKLEN
         USING WORK,R13                BASE REGISTER OF WORK AREA
         USING PARMAREA,R11            BASE REGISTER OF PARAMETER AREA
         LR    R11,R01                 INITIALIZE BASE REGISTER
         MVI   TEXT+4,C' '             CLEAR SEPERATOR
         MVI   FLAGBYTE,X'00'          CLEAR CPU FLAG BYTE
         MVC   SVCLEN,CLEN             MOVE LENGTH FIELD
         MVC   SVCTEXT,SVCTEXT-1       CLEAR TEXT FIELD
         XC    TRTTAB(256),TRTTAB      CLEAR TRANSLATE TABLE
         MVC   WTO(LENMSG02),MSG02     MOVE MESSAGE SKELETTON
         EJECT
***********************************************************************
*                                                                     *
*      TEST COMMAND TYPE.                                             *
*                                                                     *
***********************************************************************
         SPACE 3
*
*      TEST DEVICE TYPE.
*
         SPACE 1
         CLC   TEXT+5(2),=C'CH'        VARY CHANNEL ?
         BE    SETCHFLG                BRANCH IF YES
         CLC   TEXT+5(3),=C'CPU'       VARY CPU ?
         BE    SVC34                   BRANCH IF YES
         CLC   TEXT+5(4),=C'PATH'      VARY PATH ?
         BE    SETPTFLG                BRANCH IF YES
         SPACE 2
*
*      SCAN COMMAND FOR PARENS.
*
         SPACE 1
SCANCMD  EQU   *
         MVI   LPAN,C'('               MOVE LEFT PAREN TO TABLE
         TRT   TEXT,TRTTAB             SCAN FOR LEFT PAREN
         BZ    SVC34                   BRANCH IF NOT AVAILABLE
         ST    R01,ADDRLPAN            SAVE ADDRESS OF LEFT PAREN
         MVI   LPAN,X'00'
         MVI   RPAN,C')'               MOVE RIGTH PAREN TO TABLE
         TRT   TEXT,TRTTAB             SCAN FOR LEFT PAREN
         BZ    ERROR                   BRANCH IF NOT AVAILABLE
         C     R01,ADDRLPAN            RIGTH PAREN AFTER LEFT PAREN ?
         BNH   ERROR                   BRANCH IF NOT
         ST    R01,ADDRRPAN            SAVE ADDRESS OF RIGTH PAREN
         MVI   KOMMA,C','              MOVE SEPERATOR TO TABLE
         SPACE 2
*
*      TEST IF CPU-ID AVAILABLE.
*
         SPACE 1
         TM    FLAGBYTE,CHAPATH        CPU-ID POSSIBLE ?
         BZ    NOCPUID                 BRANCH IF NOT
         BCTR  R01,0                   GET ADDRESS
         BCTR  R01,0                       OF SEPERATOR
         CLI   0(R01),C','             CPU-ID POSSIBLE ?
         BNE   NOCPUID                 BRANCH IF NOT
         CLI   1(R01),C'0'             CPU 0 ?
         BE    CPUID0                  BRANCH IF YES
         CLI   1(R01),C'1'             CPU 1 ?
         BE    CPUID1                  BRANCH IF YES
         CLI   1(R01),C'S'             BOTH CPU'S ?
         BE    CPUIDS                  BRANCH IF YES
         EJECT
*
*      PREPARE PARAMETER LIST FOR SVC 34.
*
         SPACE 1
MODTEXT  EQU   *
         TM    FLAGBYTE,CPUS           CPU-ID'S SPECIFIED ?
         BZ    NOCPUID                 BRANCH IF NOT
         LA    R02,TEXT+123            LOAD END ADDRESS OF PARAMETER
         S     R02,ADDRRPAN            COMPUTE LENGTH OF TEXT-3
         EX    R02,MOVETEXT            BRANCH TO MODIFY PARAMETER
         MVC   TEXT+122(2),=C'  '      CLEAR THE LAST TWO BYTES
         ST    R01,ADDRRPAN            STORE NEW ADDR. OF RIGTH PAREN
NOCPUID  EQU   *
         L     R02,ADDRLPAN            LOAD ADDRESS OF LEFT PAREN
         LA    R03,TEXT                LOAD ADDRESS OF PARAMETER
         SR    R02,R03                 COMPUTE LENGTH OF TEXT-1
         EX    R02,MVCTEXT1            BRANCH TO MOVE TEXT-1
         LA    R02,SVCTEXT+1(R02)      LOAD ADDRESS OF UNIT NAME
         ST    R02,ADDRUNIT                AND STORE IF
         L     R01,ADDRRPAN            LOAD ADDRESS OF RIGTH PAREN
         LA    R03,TEXT+123            LOAD ADDRESS OF LAST CHARACTER
         SR    R03,R01                 COMPUTE LENGTH OF TEXT-3
         LA    R02,1(,R02)             LOAD ADDRESS OF TEXT-3
         TM    FLAGBYTE,CHANNEL        VARY CHANNEL ?
         BO    *+8                     BRANCH IF YES
         LA    R02,2(,R02)             LOAD ADDRESS OF TEXT-3
         TM    FLAGBYTE,CPUS           CPU-ID'S SPECIFIED ?
         BZ    *+20                    BRANCH IF NOT
         MVI   0(R02),C','             MOVE SEPERATOR
         LA    R02,1(,R02)             COMPUTE ADDRESS OF CPU-ID
         ST    R02,ADRCPUID                AND STORE IT
         LA    R02,1(,R02)             LOAD ADDRESS OF TEXT-3
         EX    R03,MVCTEXT3            BRANCH TO MOVE TEXT-3
         EJECT
***********************************************************************
*                                                                     *
*      MODIFY ADDRESSES IN PARAMETER LIST.                            *
*                                                                     *
***********************************************************************
         SPACE 3
*
*      SCAN INPUT LIST FOR NEXT ADDRESSES.
*
         SPACE 1
         L     R06,ADDRLPAN            LOAD ADDRESS OF LEFT PAREN
TRTLOOP  EQU   *
         C     R06,ADDRRPAN            END OF TEXT-2 ?
         BNL   RETURN                  BRANCH IF YES
         LR    R05,R06                 LOAD ADDRESS OF SEPERATOR
         L     R04,ADDRRPAN            LOAD ADDRESS OF RIGTH PAREN
         SR    R04,R05                 COMPUTE TRT-LENGTH
         BNP   ERROR                   BRANCH IF INVALID LENGTH
         BCTR  R04,0                   MODIFY FOR EX COMMAND
         EX    R04,TRT                 BRANCH TO SCAN FOR SEPERATOR
         BZ    ERROR                   BRANCH IF ERROR IN CHAIN
         LR    R06,R01                 LOAD ADDRESS OF NEW SEPERATOR
         BCTR  R01,0                   COMPUTE
         SR    R01,R05                     LENGTH OF PARAMETER
         BZ    TRTLOOP                 BRANCH IF DUMMY PARAMETER
         TM    FLAGBYTE,CHANNEL        VARY CHANNEL ?
         BO    MOVECHAN                BRANCH IF YES
         SPACE 1
         TR    1(3,R05),TRTAB          TRANSLATE UNIT NAME
         PACK  FROM(5),1(4,R05)        PACK UNIT NAME
         MVC   TO,FROM                 MOVE UNIT NAME
         C     R01,=F'3'               SINGLE UNIT NAME ?
         BE    NOTOUNIT                BRANCH IF YES
         TR    5(3,R05),TRTAB          TRANSLATE UNIT NAME
         PACK  TO(5),5(4,R05)          PACK UNIT NAME
NOTOUNIT EQU   *
         L     R02,FROM                LOAD UNIT NAME
         BCTR  R02,0                   INITIALIZE FOR LOOP
         LA    R10,UNITLOOP            LOAD START ADDRESS OF LOOP
         B     UNITLOOP                BRANCH TO LOOP
         SPACE 1
MOVECHAN EQU   *
         TR    1(1,R05),TRTAB          TRANSLATE CHANNEL ADDRESS
         PACK  FROM(5),1(2,R05)        PACK CHANNEL ADDRESS
         MVC   TO,FROM                 MOVE CHANNEL ADDRESS
         C     R01,=F'1'               SINGLE CHANNEL ADDRESS ?
         BE    NOTOCHAN                BRANCH IF YES
         TR    3(1,R05),TRTAB          TRANSLATE CHANNEL ADDRESS
         PACK  TO(5),3(2,R05)          PACK CHANNEL ADDRESS
NOTOCHAN EQU   *
         L     R02,FROM                LOAD CHANNEL ADDRESS
         BCTR  R02,0                   INITIALIZE FOR LOOP
         LA    R10,CHANLOOP            LOAD START ADDRESS OF LOOP
         B     CHANLOOP                BRANCH TO LOOP
         EJECT
*
*      COMPUTE SINGLE UNIT ADDRESSES.
*
         SPACE 1
UNITLOOP EQU   *
         LA    R02,1(,R02)             NEXT UNIT NAME
         C     R02,TO                  UNIT WANTED ?
         BH    TRTLOOP                 BRANCH IF NOT
         ST    R02,FROM                STORE UNIT NAME
         UNPK  UNPKAREA,FROM(5)        UNPACK UNIT NAME
         TR    UNPKAREA(3),TRTAB       TRANSLATE UNIT NAME
         L     R03,ADDRUNIT            LOAD STORE ADDRESS
         MVC   0(3,R03),UNPKAREA       MOVE UNIT NAME
         B     TESTCPU                 BRANCH TO TEST CPU-ID'S
         SPACE 2
*
*      COMPUTE SINGLE CHANNEL ADDRESSES.
*
         SPACE 1
CHANLOOP EQU   *
         LA    R02,1(,R02)             NEXT CHANNEL ADDRESS
         C     R02,TO                  UNIT WANTED ?
         BH    TRTLOOP                 BRANCH IF NOT
         ST    R02,FROM                STORE CHANNEL ADDRESS
         UNPK  UNPKAREA,FROM(5)        UNPACK CHANNEL ADDRESS
         TR    UNPKAREA(3),TRTAB       TRANSLATE CHANNEL ADDRESS
         L     R03,ADDRUNIT            LOAD STORE ADDRESS
         MVC   0(1,R03),UNPKAREA+2     MOVE CHANNEL ADDRESS
         EJECT
*
*      TEST CPU-ID'S.
*
         SPACE 1
TESTCPU  EQU   *
         TM    FLAGBYTE,CPUS           CPU-ID'S SPECIFIED ?
         BNZ   CPUAV                   BRANCH IF YES
         BAL   R14,SVCCALL             BRANCH TO SVC 34
         BR    R10                     RETURN
         SPACE 2
*
*      INSERT CPU-ID'S.
*
         SPACE 1
CPUAV    EQU   *
         L     R03,ADRCPUID            LOAD STORE ADDRESS
         TM    FLAGBYTE,CPU0           CPU 0 ?
         BZ    CPU1AV                  BRANCH IF NOT AVAILABLE
         MVI   0(R03),C'0'             MOVE CPU-ID
         BAL   R14,SVCCALL             BRANCH TO SVC 34
CPU1AV   EQU   *
         TM    FLAGBYTE,CPU1           CPU 1 ?
         BZR   R10                     RETURN IF NOT AVAILABLE
         MVI   0(R03),C'1'             MOVE CPU-ID
         BAL   R14,SVCCALL             BRANCH TO SVC 34
         BR    R10                     RETURN
         EJECT
***********************************************************************
*                                                                     *
*      ERROR ROUTINE AND                                              *
*      FINAL PROCESSING.                                              *
*                                                                     *
***********************************************************************
         SPACE 3
ERROR    EQU   *
         L     R00,REG4                LOAD UCM-ID
         WTO   'XVARY01 ERROR IN PARAMETER LIST',MCSFLAG=(REG0)
         SPACE 2
RETURN   EQU   *
         XRETURN ,R                    FINAL PROCESSING
         EJECT
***********************************************************************
*                                                                     *
*      SUBROUTINE TO ISSUE SVC 34.                                    *
*                                                                     *
***********************************************************************
         SPACE 3
SVC34    EQU   *
         MVC   SVCTEXT,TEXT            MOVE WHOLE PARAMETER TEXT
         LA    R14,RETURN              LOAD RETURN ADDRESS
SVCCALL  EQU   *
         L     R01,16                  LOAD ADDRESS OF CVT
         TM    116(R01),X'01'          SYSTEM = MVS ?
         BZ    NOTMVS                  BRANCH IF NOT
         MODESET KEY=ZERO              MODIFY PSW KEY
NOTMVS   EQU   *
         L     R00,REG4                LOAD UCM-ID
         MVC   WTO+12(124),SVCTEXT     MOVE TEXT TO OUTPUT LINE
         WTO   MF=(E,WTO)
         L     R00,REG4                LOAD UCM-ID
         LA    R01,SVCLIST             LOAD ADRESS OF PARAMETER LIST
         SVC   34
         L     R01,16                  LOAD ADDRESS OF CVT
         TM    116(R01),X'01'          SYSTEM = MVS ?
         BZR   R14                     RETURN IF NOT
         MODESET KEY=NZERO             MODIFY PSW KEY
         BR    R14                     RETURN
         EJECT
***********************************************************************
*                                                                     *
*      MISCELANEUS COMMANDS.                                          *
*                                                                     *
***********************************************************************
         SPACE 2
MOVETEXT MVC   0(0,R01),2(R01)         MODIFY PARAMETER TEXT
MVCTEXT1 MVC   SVCTEXT(0),TEXT         MOVE TEXT-1
MVCTEXT3 MVC   0(0,R02),0(R01)         MOVE TEXT-3
TRT      TRT   1(0,R06),TRTTAB         SCAN FOR SEPERATOR
         SPACE 1
SETCHFLG OI    FLAGBYTE,CHANNEL        SET FLAG
         B     SCANCMD                 BRANCH
SETPTFLG OI    FLAGBYTE,PATH           SET FLAG
         B     SCANCMD                 BRANCH
         SPACE 1
CPUIDS   OI    FLAGBYTE,CPU1           SET FLAG
CPUID0   OI    FLAGBYTE,CPU0           SET FLAG
         B     MODTEXT                 BRANCH
CPUID1   OI    FLAGBYTE,CPU1           SET FLAG
         B     MODTEXT                 BRANCH
         EJECT
***********************************************************************
*                                                                     *
*      REGISTER EQUATES.                                              *
*                                                                     *
***********************************************************************
         SPACE 2
R00      EQU   0                       MACRO AND PARAMETER REGISTER
R01      EQU   1                       MACRO AND PARAMETER REGISTER
R02      EQU   2                       WORK REGISTER
R03      EQU   3                       WORK REGISTER
R04      EQU   4                       WORK REGISTER
R05      EQU   5                       WORK REGISTER
R06      EQU   6                       WORK REGISTER
R07      EQU   7
R08      EQU   8
R09      EQU   9
R10      EQU   10
R11      EQU   11                      BASE OF INPUT PARAMETER LIST
R12      EQU   12                      BASE OF CSECT
R13      EQU   13                      BASE OF WORK AREA, PTR. TO S A
R14      EQU   14                      LINK AND RETURN REGISTER
R15      EQU   15                      LINK AND RETURN REGISTER
         EJECT
***********************************************************************
*                                                                     *
*      CONSTANT WORK AREA.                                            *
*                                                                     *
***********************************************************************
         SPACE 2
MSG02    WTO   'XVARY02                                                *
                                                                       *
                                    ',MF=L,MCSFLAG=(REG0)
LENMSG02 EQU   *-MSG02
         SPACE 1
CLEN     DC    H'129',H'0',C' '        HEADER OF SVC PARAMETER LIST
         SPACE 1
TRTAB    DC    193C'?'                 TRANSLATE TABLE
         DC    X'FAFBFCFDFEFF'
         DC    41C'?'
         DC    C'0123456789ABCDEF'
         SPACE 3
***********************************************************************
*                                                                     *
*      INPUT PARAMETER LIST.                                          *
*                                                                     *
***********************************************************************
         SPACE 2
         XPARM
         EJECT
***********************************************************************
*                                                                     *
*      WORK AREA.                                                     *
*                                                                     *
***********************************************************************
         SPACE 2
WORK     DSECT
SAVEAREA DC    18F'0'                  SAVE AREA FOR GENERAL REGISTERS
ADDRLPAN DC    A(0)                    ADDRESS OF LEFT PAREN
ADDRRPAN DC    A(0)                    ADDRESS OF RIGHT PAREN
ADDRUNIT DC    A(0)                    ADDRESS OF UNIT NAME
ADRCPUID DC    A(0)                    ADDRESS OF CPU-ID
         SPACE 1
FROM     DC    F'0'
TO       DC    F'0'
UNPKAREA DC    F'0'
         SPACE 1
WTO      DC    34F'0'                  OUTPUT MESSAGE AREA
         SPACE 1
SVCLIST  DS    0F                      PARAMETER LIST FOR SVC 34
SVCLEN   DC    CL5' '
SVCTEXT  DC    CL124' '
         SPACE 1
FLAGBYTE DC    X'00'                  FLAG BYTE
CPU0     EQU   B'10000000'            CPU 0
CPU1     EQU   B'01000000'            CPU 1
CPUS     EQU   B'11000000'            CPU 0 AND CPU 1
CHANNEL  EQU   B'00100000'            CHANNEL
PATH     EQU   B'00010000'            PATH
CHAPATH  EQU   B'00110000'            CHANNEL AND PATH
         SPACE 1
TRTTAB   DC    77X'00'                 TRANSLATE TABLE
LPAN     DC    C'('
         DC    15X'00'
RPAN     DC    C')'
         DC    13X'00'
KOMMA    DC    C','
         DC    148X'00'
WORKLEN  EQU   *-WORK
         SPACE 3
         END   XVARY
./ ADD  NAME=VTOC
         TITLE 'XVTOC                             X-COMMAND VTOC'
VTOC     CSECT
         SPACE 3
***********************************************************************
*                                                                     *
*      PROGRAM-ID. VTOC.                                              *
*      AUTHOR. EHNERT.                                                *
*      INSTALLATION. BAYER AG, LEVERKUSEN, RECHENZENTRUM.             *
*      DATE-WRITTEN. 24. 3. 1975.                                     *
*      REMARKS.                                                       *
*                                                                     *
*          DAS X-COMMAND 'VTOC' GIBT INFORMATIONEN UEBER DIE          *
*          VTOC'S DER ALS PARAMETER SPEZIFIZIERTEN VOLUMES AUS.       *
*                                                                     *
*          ALS PARAMETER KOENNEN BIS ZU ZEHN VOLSER-MASKEN ANGE-      *
*          GEBEN WERDEN, MIT DEREN HILFE EINE AUSWAHL DER VOLUMES     *
*          GETROFFEN WIRD. DABEI STEHT '*' FUER JEDES ZEICHEN AN      *
*          DIESER STELLE.                                             *
*                                                                     *
***********************************************************************
         EJECT
***********************************************************************
*                                                                     *
*      BEGINN DER VERARBEITUNG.                                       *
*                                                                     *
***********************************************************************
         SPACE 3
*
*      SICHERN DER REGISTER,
*      SPEICHERPLATZANFORDERUNG FUER ARBEITSBEREICHE,
*      ZUORDNUNG DER BASISREGISTER.
*
         SPACE 1
         XSAVE R12,,VTOC,ABERL
         SPACE 1
         LR    R11,R1        BASISREG. FUER DSECT PARMAREA INITIALIS.
         USING UCB,R3        BASISREG. FUER DSECT UCB ZUORDNEN
         USING MESSAGE,R10   BASISREG. FUER DSECT MESSAGE ZUORDNEN
         USING PARMAREA,R11  BASISREG. FUER DSECT PARMAREA ZUORDNEN
         USING ABER,R13      BASISREG. FUER DSECT ABER ZUORDNEN
         EJECT
*
*      INITIALISIERUNG DER SPEICHER.
*
         SPACE 1
         MVC   CAMOBT(CAMLEN),CAMCOBT CAMLIST-MACRO UEBERTRAGEN
         MVI   FNDBYTE,X'00' SCHALTER LOESCHEN
         MVI   MVSBYTE,X'00' SCHALTER LOESCHEN
         MVI   WTORBYTE,X'FF' SCHALTER SETZEN
         LA    R2,CCHHR      ADRESSE DES CCHHR-FELDES LADEN
         LA    R3,VOLSERNO   ADRESSE DER VOLSER NUMBER LADEN
         LA    R4,CAMWKFLD   ADRESSE VON CAMWKFLD LADEN
         STM   R2,R4,CADRCCHH ADRESSEN IN CAMOBT SPEICHERN
         LA    R2,ENDTAB1    ENDADRESSEN DER
         LA    R3,ENDTPVOL       TABELLEN LADEN
         STM   R2,R3,ADDRETB1    UND SPEICHERN
         MVC   UCMID,REG4    UCM-ID. DES AUFRUFERS UEBERTRAGEN
         SPACE 2
*
*      FLAG BYTS IN NACHRICHTENBEREICHEN SETZEN.
*
         SPACE 1
         LA    R10,MSGTAB    ADRESSE DER TABELLE LADEN
         ST    R10,SAVE1R10      UND SPEICHERN
         L     R3,ADDRETB1   ENDADRESSE DER TABELLEN LADEN
CLEARMSS EQU   *
         MVC   MESSFLAG,=X'FFFF' FLAG BYTES SETZEN
         LA    R10,68(R10)   R10 ERHOEHEN
         CR    R10,R3        ENDE DER TABELLEN ERREICHT ?
         BL    CLEARMSS      NEIN, VERZWEIGEN
         EJECT
***********************************************************************
*                                                                     *
*      VERARBEITUNG DER EINGABEPARAMETER.                             *
*                                                                     *
***********************************************************************
         SPACE 3
         LA    R4,TEXT+4     R4 INITIALISIEREN
         LA    R8,PARMENDE   ENDADRESSE DES PARAMETERBEREICHS LADEN
         CLI   0(R4),C','    PARAMETER ANGEGEBEN ?
         BNE   FEHLPARM      NEIN, VERZW. ZUR FEHLERROUTINE
         LA    R6,TABPVOL1   ADRESSE DER VOLSER-TABELLE LADEN
NEXTPARM EQU   *
         SR    R5,R5         R5 LOESCHEN
         LR    R7,R4         ADRESSE DES TRENNUNGSZEICHENS LADEN
NXTBYTE  EQU   *
         LA    R4,1(R4)      R4 ERHOEHEN
         CR    R4,R8         PARAMETERBEREICH UEBERSCHRITTEN ?
         BNL   FEHLPARM      JA, VERZW. ZUR FEHLERROUTINE
         CLI   0(R4),C','    ENDE DES PARAMETERS ERREICHT ?
         BE    NEXTPVOL      JA, VERZWEIGEN
         CLI   0(R4),X'00'   ENDE DER PARAMETERKETTE ERREICHT ?
         BE    NEXTPVOL      JA, VERZWEIGEN
         CLI   0(R4),C' '    ENDE DER PARAMETERKETTE ERREICHT ?
         BE    NEXTPVOL      JA, VERZWEIGEN
         LA    R5,1(R5)      R5 ERHOEHEN
         CLI   0(R4),C'*'    BELIEBIGES ZEICHEN AN DIESER STELLE ?
         BNE   NXTBYTE       NEIN, VERZWEIGEN
         MVI   0(R4),X'FF'   ZEICHEN UMSETZEN
         B     NXTBYTE       VERZWEIGEN
         EJECT
NEXTPVOL EQU   *
         C     R6,ADDRETPV   TABELLENENDE UEBERSCHRITTEN ?
         BNL   FEHLPARM      JA, VERZWEIGEN
         C     R5,=F'6'      LAENGE DER VOLID GUELTIG ?
         BH    FEHLPARM      NEIN, VERZW. ZUR FEHLERROUTINE
         LTR   R5,R5         VOLID ANGEGEBEN ?
         BZ    FEHLPARM      NEIN, VERZW. ZUR FEHLERROUTINE
         BCTR  R5,0          R5 UM EINS VERMINDERN
         EX    R5,MOVEPVOL   VERZW. ZUR UEBERTR. DER VOLSER NUMBER
         STC   R5,0(R6)      LAENGENANGABE IN TABELLE EINTRAGEN
         LA    R6,7(R6)      R6 ERHOEHEN
         CLI   0(R4),C','    FOLGEN WEITERE PARAMETER ?
         BE    NEXTPARM      JA, VERZWEIGEN
         SPACE 2
*
*      ABSCHLUSS DER PARAMETERVERARBEITUNG.
*
         SPACE 1
         MVI   0(R6),X'80'   TABELLENENDE SPEZIFIZIEREN
         MVC   TABPVOL2,TABPVOL1 VOLSER-TABELLE KOPIEREN
         LA    R6,TABPVOL2-1 ADRESSE DER TABELLE LADEN
NEXTFF   EQU   *
         LA    R6,1(R6)      R6 ERHOEHEN
         CLI   0(R6),X'80'   TABELLENENDE ERREICHT ?
         BE    GETUCB        JA, VERZWEIGEN
         CLI   0(R6),X'FF'   TABELLENZEICHEN = X'FF' ?
         BNE   NEXTFF        NEIN, VERZWEIGEN
         MVI   0(R6),X'00'   TABELLENZEICHEN UMSETZEN
         B     NEXTFF        VERZWEIGEN
         EJECT
***********************************************************************
*                                                                     *
*      VERARBEITUNG DER UCB-INFORMATIONEN.                            *
*                                                                     *
***********************************************************************
         SPACE 3
GETUCB   EQU   *
         L     R2,16         ADRESSE DER CVT LADEN
         TM    116(R2),X'01' SYSTEM = OS/VS2 (MVS) ?
         BZ    *+8           NEIN, VERZWEIGEN
         MVI   MVSBYTE,X'FF' FLAG BYTE SETZEN
         DROP  R11           R11 FREIGEBEN
         GETMAIN R,LV=VEKLEN,SP=125
         LR    R11,R1        BASISREG. FUER DSECT VEKTOR INIT.
         USING VEKTOR,R11    BASISREG. FUER DSECT VEKTOR ZUORDNEN
         ST    R11,UCBADDR   VEKTOR-ADRESSE SPEICHERN
         MVI   UCBADDR,X'80' OPTION BYTE SETZEN
         LA    R1,UCBADDR    ADRESSE DER VEKTOR-ADRESSE LADEN
         LINK  EP=GETUCBS              LINK TO SUBROUTINE
         LA    R2,VEKTOR     ADRESSE DES UCB-VEKTORS LADEN
         SR    R3,R3         R3 LOESCHEN
         MVC   VEKEND,=X'FFFF' ENDE DES UCB-VEKTORS SPEZIFIZIEREN
         S     R2,=F'2'      R2 UM ZWEI VERMINDERN
NEXTUCB  EQU   *
         LA    R2,2(R2)      R2 ERHOEHEN
         CLC   0(2,R2),=X'FFFF' ENDE DES UCB-VEKTORS ERREICHT ?
         BE    ABSCHLUS      JA, VERZW. ZUM ABSCHLUSS DER VERARBEITUNG
         ICM   R3,3,0(R2)    ADRESSE DES UCB LADEN
         CLI   UCBDVCLS,X'20' DEVICE = DASD ?
         BNE   NEXTUCB       NEIN, VERZWEIGEN
         TM    DEVSTAT,X'80' EINHEIT ONLINE ?
         BZ    NEXTUCB       NEIN, VERZWEIGEN
         TM    DEVSTAT,X'10' EINHEIT IM UNLOAD ?
         BO    NEXTUCB       JA, VERZWEIGEN
         CLC   UCBVOLI,=XL6'0' VOLID VORHANDEN ?
         BE    NEXTUCB       NEIN, VERZWEIGEN
         TM    UCB+17,X'08'                VIRTUAL DEVICE ?
         BO    TSTVVOL                     BRANCH IF YES
         EJECT
*
*      VERGLEICH MIT SPEZIFIZIERTEN VOLSER NUMBERS.
*
         SPACE 1
         SR    R5,R5         R5 LOESCHEN
         LA    R6,TABPVOL1-7 ADRESSE DER VOLSER-TABELLE LADEN
         LA    R7,TABPVOL2-7 ADRESSE DER VOLSER-TABELLE LADEN
NXTVOLID EQU   *
         LA    R6,7(R6)      R6 ERHOEHEN
         LA    R7,7(R7)      R7 ERHOEHEN
         TM    0(R6),X'80'   TABELLENENDE ERREICHT ?
         BO    NEXTUCB       JA, VERZWEIGEN
         IC    R5,0(R6)      LAENGENANGABE LADEN
         MVC   ZWVOLID1,UCBVOLI VOLSER NUMBER UEBERTRAGEN
         MVC   ZWVOLID2,UCBVOLI VOLSER NUMBER UEBERTRAGEN
         EX    R5,NCVOLID1   VERZW. ZUR UEBERLAGERUNG DER VOLID
         EX    R5,OCVOLID2   VERZW. ZUR UEBERLAGERUNG DER VOLID
         CLC   ZWVOLID1,ZWVOLID2 VOLID = AUSGEW. VOLID ?
         BNE   NXTVOLID      VERZW., WENN VOLID ^= AUSGEW. VOLID
         B     MVCVOLID
         SPACE 1
TSTVVOL  EQU   *
         LA    R6,TABPVOL1-7 ADRESSE DER VOLSER-TABELLE LADEN
NXTVVOL  EQU   *
         LA    R6,7(R6)      R6 ERHOEHEN
         TM    0(R6),X'80'   TABELLENENDE ERREICHT ?
         BO    NEXTUCB       JA, VERZWEIGEN
         CLC   UCBVOLI,1(R6) VOLID = AUSGEW. VOLID ?
         BNE   NXTVVOL       BRANCH IF NOT
MVCVOLID EQU   *
         MVC   VOLSERNO,UCBVOLI VOLSER NUMBER UEBERTRAGEN
         MVI   FNDBYTE,X'FF' FLAG BYTE SETZEN
         EJECT
***********************************************************************
*                                                                     *
*      CCHHR DER VTOC BERECHNEN.                                      *
*                                                                     *
***********************************************************************
         SPACE 3
         SR    R4,R4         R4 LOESCHEN
         IC    R4,DEVCODE    DEVICE CODE LADEN
         SLA   R4,2          DEVICE CODE * 4
         LA    R5,TABTCAP    ADRESSE DER TABTCAP-TABELLE LADEN
         AR    R5,R4         R5 ERHOEHEN
         CLI   0(R5),X'80'   DEVICE RESERVED ?
         BE    FEHLDEVC      JA, VERZW. ZUR FEHLERROUTINE
         LH    R6,0(R5)      TABELLENELEMENTEHN
         LH    R7,2(R5)          LADEN UND
         STM   R6,R7,TRKPCYL     SPEICHERN
         LH    R6,UCBVTOC    REL. ADRESSE DER VTOC LADEN
         CLI   MVSBYTE,X'FF' FLAG BYTE GESETZT ?
         BE    *+8           JA, VERZWEIGEN
         LH    R6,SRTEFSCT   REL. ADRESSE DER VTOC LADEN
         SRDA  R6,32         R6 --> R7
         D     R6,TRKPCYL    DIV. TT / SPECIFIC TRACKS/CYLINDER
         STH   R7,CCHHR      CC-ADRESSE DER VTOC SPEICHERN
         STH   R6,CCHHR+2    HH-ADRESSE DER VTOC SPEICHERN
         MVI   CCHHR+4,X'01' R-ADRESSE DER VTOC SPEICHERN
         EJECT
***********************************************************************
*                                                                     *
*      DSCB4 LESEN UND AUSWERTEN.                                     *
*                                                                     *
***********************************************************************
         SPACE 3
         OBTAIN CAMOBT       DSCB4 LESEN
         LTR   R15,R15       RETURN CODE = 0 ?
         BNZ   FEHLOBT       NEIN, VERZWEIGEN
         CLI   DS4FMTID,C'4' DSCB = DSCB4 ?
         BNE   FEHLDSCB      NEIN, VERZWEIGEN
         SPACE 1
         L     R10,SAVE1R10  R10 INITIALISIEREN
         MVC   MESSAGE(LENMSG02),MSG02 NACHRICHTENZEILE UEBERTRAGEN
         MVC   MS2VOLID,UCBVOLI VOLSER NUMBER UEBERTRAGEN
         MVC   MS2ADR,UCBNAME UNIT NAME UEBERTRAGEN
         UNPK  MS2CCHH(3),CCHHR+1(2) CC-ADRESSE UEBERTRAGEN
         UNPK  MS2CCHH+2(3),CCHHR+3(2) HH-ADRESSE UEBERTRAGEN
         MVI   MS2CCHH+4,C' '
         TR    MS2CCHH,TABHEXA-240 ADRESSE AUFBEREITEN
         LH    R5,DS4NOATK   ANZ. DER ALT. TRACKS REM. LADEN
         L     R4,NOALTRK    ANZ. DER ALTERNATE TRACKS LADEN
         SR    R4,R5         ANZ. BENUTZTER ALTERN. TRACKS BERECHNEN
         BAL   R14,CONVDEC   VERZW. ZUM UMWANDELN IN DEZIMALZAHL
         MVC   MS2ATRK,ZWFELD+11 ANZ. ALT. TRACKS UEBERTRAGEN
         BAL   R14,ALOTRK    VERZW. ZUM BERECHNEN DER ALLOCATED TRACKS
         SR    R4,R4         R4 LOESCHEN
         IC    R4,DS4DEVDT   ANZ. DER DSCBS PRO TRACK LADEN
         MR    R6,R4         ANZ. DER ALLOCATED DSCBS BERECHNEN
         LR    R4,R7         ANZ. DER ALLOCATED DSCBS LADEN
         ST    R4,NODSCBS         UND SPEICHERN
         C     R4,=F'9999'   ANZ. DER ALLOC. DSCBS > 9999 ?
         BH    *+14          JA, VERZWEIGEN
         BAL   R14,CONVDEC   VERZW. ZUM UMWANDELN IN DEZIMALZAHL
         MVC   MS2DSCB,ZWFELD+11 ANZ. DER ALLOC. DSCBS UEBERTR.
         SH    R4,DS4DSREC   ANZ. DER FREIEN DSCBS SUBTRAHIEREN
         ST    R4,HIGHWATM   HIGH WATER MARK SPEICHERN
         MVI   VSAMBYTE,X'00' FLAG BYTE LOESCHEN
         EJECT
         TM    DS4VSCID,X'C0' VSAM INDICATORS ?
         BZ    NOVSAM        NEIN, VERZWEIGEN
         MVI   VSAMBYTE,X'01' FLAG BYTE SETZEN
         UNPK  MS2VSTMS(9),DS4VSTMS(5) TIMESTAMP UEBERTRAGEN
         UNPK  MS2VSTMS+8(9),DS4VSTMS+4(5) TIMESTAMP UEBERTRAGEN
         MVI   MS2VSTMS+16,C' '
         TR    MS2VSTMS,TABHEXA-240 TIMESTAMP AUFBEREITEN
NOVSAM   EQU   *
         BAL   R14,GETDSCBS  VERZW. ZUM BERECHNEN DER BEN. DSCBS
         TM    VSAMBYTE,X'FF' VSAM ?
         BZ    MSG02OK       NEIN, VERZWEIGEN
         TM    VSAMBYTE,X'10' MASTER CATALOG ?
         BZ    *+14          NEIN, VERZWEIGEN
         MVC   MS2FLAGS,=C'MCAT' MASTER CATALOG SPEZIFIZIEREN
         B     MSG02OK       VERZWEIGEN
         TM    VSAMBYTE,X'08' USER CATALOG ?
         BZ    *+14          NEIN, VERZWEIGEN
         MVC   MS2FLAGS,=C'UCAT' USER CATALOG SPEZIFIZIEREN
         B     MSG02OK       VERZWEIGEN
         TM    VSAMBYTE,X'04' VSAM DATASET ?
         BZ    *+14          NEIN, VERZWEIGEN
         MVC   MS2FLAGS,=C'DSET' VSAM DATASET SPEZIFIZIEREN
         B     MSG02OK       VERZWEIGEN
         TM    VSAMBYTE,X'02' VSAM SPACE ?
         BZ    *+14          NEIN, VERZWEIGEN
         MVC   MS2FLAGS,=C'DSPC' VSAM SPACE SPEZIFIZIEREN
         B     MSG02OK       VERZWEIGEN
         MVC   MS2FLAGS,=C'CAND'
MSG02OK  EQU   *
         C     R4,=F'9999'   ANZ. DER BENUTZTEN DSCBS > 9999 ?
         BH    *+14          JA, VERZWEIGEN
         BAL   R14,CONVDEC   VERZW. ZUM UMWANDELN IN DEZIMALZAHL
         MVC   MS2USED,ZWFELD+11 ANZ. DER BENUTZTEN DSCBS UEBERTR.
         LA    R14,NEXTUCB   RUECKSPRUNGADRESSE LADEN
         MVC   MESSFLAG,=XL6'0' FLAG BYTES LOESCHEN
         LA    R10,68(R10)   R10 ERHOEHEN
         C     R10,ADDRETB1  ENDE DER TABELLE UEBERSCHRITTEN ?
         BNL   AUSMSGM       JA, VERZWEIGEN
         ST    R10,SAVE1R10  LAUFENDE ADRESSE SPEICHERN
         BR    R14           VERZWEIGEN
         EJECT
***********************************************************************
*                                                                     *
*      BERECHNUNG DER ALLOCATED TRACKS.                               *
*                                                                     *
***********************************************************************
         SPACE 3
ALOTRK   EQU   *
         MVC   DBWORD,DS4VTOCE+2 EXTENT-BESCHREIBUNG UEBERTRAGEN
         LH    R4,DBWORD+6   HH-ADRESE DES EXTENT-ENDES LADEN
         LH    R5,DBWORD     CC-ADRESE DES EXTENT-BEGINNS LADEN
         LH    R6,DBWORD+2   HH-ADRESE DES EXTENT-BEGINNS LADEN
         LH    R7,DBWORD+4   CC-ADRESE DES EXTENT-ENDES LADEN
         CR    R4,R6         R4 ^< R6 ?
         BNL   *+10          JA, VERZWEIGEN
         A     R4,TRKPCYL    R4 UM ANZ. TRACKS/CYLINDER ERHOEHEN
         BCTR  R7,0          R7 UM EINS VERMINDERN
         LA    R4,1(R4)      R4 UM EINS ERHOEHEN
         SR    R7,R5         ANZ. DER ALLOCATED CYLINDERS BERECHNEN
         SR    R4,R6         ANZ. DER ALLOCATED TRACKS BERECHNEN
         SR    R6,R6         R6 LOESCHEN
         M     R6,TRKPCYL    MULT. MIT ANZ. TRACKS/CYLINDER
         AR    R7,R4         ANZ. ALLOCATED TRACKS ADDIEREN
         BR    R14           VERZWEIGEN
         EJECT
***********************************************************************
*                                                                     *
*      BERECHNUNG DER BENUTZTEN DSCBS.                                *
*                                                                     *
***********************************************************************
         SPACE 3
GETDSCBS EQU   *
         ST    R14,SAVE1R14  RUECKSPRUNGADRESSE SICHERN
         L     R8,NODSCBS    ANZ. DER ALLOCATED DSCBS LADEN
         L     R7,HIGHWATM   HIGH WATER MARK LADEN
         BCTR  R7,0          R7 UM EINS VERMINDERN
         LA    R6,1          DSCB-ZAEHLER INITIALISIEREN
         LA    R4,1          R4 INITIALISIEREN
         MVC   MTRKNO,DS4DEVSZ+2 MAX. SPURADRESSE SPEICHERN
         XC    MRECNO,MRECNO MRECNO LOESCHEN
         MVC   MRECNO+1(1),DS4DEVDT MAX. SATZADRESSE LADEN
NEXTDSCB EQU   *
         LA    R6,1(R6)      DSCB-ZAEHLER ERHOEHEN
         CR    R6,R8         HIGH WATER MARK UEBERSCHRITTEN ?
         BH    LOOPENDE      JA, VERZWEIGEN
         SR    R5,R5         R5 LOESCHEN
         IC    R5,CCHHR+4    LFD. SATZADRESSE LADEN
         LA    R5,1(R5)      SATZADRESSE ERHOEHEN
         CH    R5,MRECNO     SPUR UEBERSCHRITTEN ?
         BNH   NEXTREC       NEIN, VERZWEIGEN
         LH    R5,CCHHR+2    LFD. SPURADRESSE LADEN
         LA    R5,1(R5)      SPURADRESSE ERHOEHEN
         CH    R5,MTRKNO     ZYLINDER UEBERSCHRITTEN ?
         BL    NEXTTRK       NEIN, VERZWEIGEN
         LH    R5,CCHHR      LFD. ZYLINDERADRESSE LADEN
         LA    R5,1(R5)      ZYLINDERADRESSE ERHOEHEN
         STH   R5,CCHHR      NEUE ZYLINDERADRESSE SPEICHERN
         SR    R5,R5         NEUE SPURADRESSE = 0
NEXTTRK  EQU   *
         STH   R5,CCHHR+2    NEUE SPURADRESSE SPEICHERN
         LA    R5,1          NEUE SATZADRESSE = 1
NEXTREC  EQU   *
         STC   R5,CCHHR+4    NEUE SATZADRESSE SPEICHERN
         OBTAIN CAMOBT       NAECHSTEN DSCB LESEN
         LTR   R15,R15       RETURN CODE = 0 ?
         BNZ   FEHLOBT       NEIN, VERZW. ZUR FEHLERROUTINE
         CLI   DS4FMTID,X'00' DUMMY DSCB ?
         BE    NEXTDSCB      JA, VERZWEIGEN
         LA    R4,1(R4)      ANZ. BENUTZTER DSCBS ERHOEHEN
         CLI   DS4FMTID,C'1' DSCB = DSCB1 ?
         BNE   RETFLOOP      NEIN, VERZWEIGEN
         TM    VSAMBYTE,X'FF' VSAM ?
         BZ    RETFLOOP      NEIN, VERZWEIGEN
         EJECT
         CLC   CAMWKFLD(8),=C'VSAMDSET'
         BNE   *+12          NEIN, VERZWEIGEN
         OI    VSAMBYTE,X'04' VSAM DATASET
         BCT   R7,NEXTDSCB   VERZWEIGEN
         CLC   CAMWKFLD+9(8),=C'VSAMDSET'
         BNE   *+12          NEIN, VERZWEIGEN
         OI    VSAMBYTE,X'04' VSAM DATASET
         BCT   R7,NEXTDSCB   VERZWEIGEN
         CLC   CAMWKFLD(17),=C'Z9999992.VSAMDSPC'
         BNE   *+12          NEIN, VERZWEIGEN
         OI    VSAMBYTE,X'02' VSAM SPACE
         BCT   R7,NEXTDSCB   VERZWEIGEN
         CLC   CAMWKFLD+9(17),=C'Z9999992.VSAMDSPC'
         BNE   *+12          NEIN, VERZWEIGEN
         OI    VSAMBYTE,X'02' VSAM SPACE
         BCT   R7,NEXTDSCB   VERZWEIGEN
         CLC   CAMWKFLD(17),=C'Z9999994.VSAMDSPC'
         BNE   *+12          NEIN, VERZWEIGEN
         OI    VSAMBYTE,X'08' USER CATALOG
         BCT   R7,NEXTDSCB   VERZWEIGEN
         CLC   CAMWKFLD+9(17),=C'Z9999994.VSAMDSPC'
         BNE   *+12          NEIN, VERZWEIGEN
         OI    VSAMBYTE,X'08' USER CATALOG
         BCT   R7,NEXTDSCB   VERZWEIGEN
         CLC   CAMWKFLD(17),=C'Z9999996.VSAMDSPC'
         BNE   *+12          NEIN, VERZWEIGEN
         OI    VSAMBYTE,X'10' MASTER CATALOG
         BCT   R7,NEXTDSCB   VERZWEIGEN
         CLC   CAMWKFLD+9(8),=C'VSAMDSPC'
         BNE   RETFLOOP      NEIN, VERZWEIGEN
         OI    VSAMBYTE,X'02' VSAM SPACE
RETFLOOP EQU   *
         BCT   R7,NEXTDSCB   VERZWEIGEN
LOOPENDE EQU   *
         L     R14,SAVE1R14  RUECKSPRUNGADRESSE LADEN
         BR    R14           VERZWEIGEN
         EJECT
***********************************************************************
*                                                                     *
*      ABSCHLUSSROUTINEN.                                             *
*                                                                     *
***********************************************************************
         SPACE 3
ABSCHLUS EQU   *
         FREEMAIN R,SP=125    SPEICHERPLATZ FREIGEBEN
         MVI   WTORBYTE,X'00' FLAG BYTE LOESCHEN
         CLI   FNDBYTE,X'FF' VOLUME(S) GEFUNDEN ?
         BE    AUSRMSGN      JA, VERZWEIGEN
         L     R0,UCMID      UCM-ID. DES AUFRUFERS LADEN
         WTO   MF=(E,MSG03)  NACHRICHT AUSGEBEN
         B     ENDE          VERZWEIGEN
         SPACE 2
*
*      AUSGABE NOCH OFFENER INFO-NACHRICHTEN.
*
         SPACE 1
AUSRMSGN EQU   *
         LA    R10,MSGTAB    ADRESSE DER TABELLE LADEN
         CLC   MESSFLAG,=XL6'0' SIND NOCH NACHRICHTEN OFFEN ?
         BNE   ENDE          NEIN, VERZWEIGEN
         BAL   R14,AUSMSGM   JA, VERZW. ZUR NACHRICHTENAUSGABE
         EJECT
*
*      SPEICHERPLATZFREIGABE,
*      REINITIALISIERUNG DER REGISTER UND
*      RUECKSPRUNG ZUM AUFRUFENDEN PROGRAMM.
*
         SPACE 1
ENDE     EQU   *
         XRETURN ,R
         EJECT
***********************************************************************
*                                                                     *
*      FEHLERROUTINEN.                                                *
*                                                                     *
***********************************************************************
         SPACE 3
*
*      ROUTINE BEI FEHLER IN DER PARAMETERKETTE.
*
         SPACE 1
FEHLPARM EQU   *
         L     R0,UCMID      UCM-ID. DES AUFRUFERS LADEN
         WTO   MF=(E,MSG04)  NACHRICHT AUSGEBEN
         B     ENDE          VERZWEIGEN
         SPACE 2
*
*      ROUTINE BEI OBTAIN-FEHLER (RC ^= 0).
*
         SPACE 1
FEHLOBT  EQU   *
         LA    R10,FEHLTAB   R10 INITIALISIEREN
         MVC   MESSAGE(LENMSG06),MSG06 NACHRICHTENZEILE UEBERTRAGEN
         MVC   MS6VOLI,UCBVOLI VOLSER NUMBER UEBERTRAGEN
         LR    R4,R15        RETURN CODE IN R4 LADEN
         BAL   R14,CONVDEC   VERZW. ZUM UMWANDELN IN DEZIMALZAHL
         MVC   MS6RC,ZWFELD+13 RETURN CODE UEBERTRAGEN
         L     R0,UCMID      UCM-ID. DES AUFRUFERS LADEN
         WTO   MF=(E,MESSAGE) NACHRICHTENZEILE AUSGEBEN
         B     NEXTUCB       VERZWEIGEN
         EJECT
*
*      ROUTINE BEI RESERVED DEVICES.
*
         SPACE 1
FEHLDEVC EQU   *
         LA    R10,FEHLTAB   R10 INITIALISIEREN
         MVC   MESSAGE(LENMSG05),MSG05 NACHRICHTENZEILE UEBERTRAGEN
         UNPK  MS5DEVC(3),DEVCODE(2) DEVICE CODE UEBERTRAGEN
         TR    MS5DEVC,TABHEXA-240 DEVICE CODE AUFBEREITEN
         MVC   MS5VOLI,UCBVOLI VOLSER NUMBER UEBERTRAGEN
         L     R0,UCMID      UCM-ID. DES AUFRUFERS LADEN
         WTO   MF=(E,MESSAGE) NACHRICHTENZEILE AUSGEBEN
         B     NEXTUCB       VERZWEIGEN
         SPACE 2
*
*      ROUTINE BEI DSCB-FEHLER (1.DSCB ^= DSCB4).
*
         SPACE 1
FEHLDSCB EQU   *
         LA    R10,FEHLTAB   R10 INITIALISIEREN
         MVC   MESSAGE(LENMSG07),MSG07 NACHRICHTENZEILE UEBERTRAGEN
         MVC   MS7VOLI,UCBVOLI VOLSER NUMBER UEBERTRAGEN
         L     R0,UCMID      UCM-ID. DES AUFRUFERS LADEN
         WTO   MF=(E,MESSAGE) NACHRICHTENZEILE AUSGEBEN
         B     NEXTUCB       VERZWEIGEN
         EJECT
***********************************************************************
*                                                                     *
*      AUSGABE DER NACHRICHTEN.                                       *
*                                                                     *
***********************************************************************
         SPACE 3
AUSMSGM  EQU   *
         ST    R14,SAVE1R14  RUECKSPRUNGADRESSE SICHERN
         L     R0,UCMID      UCM-ID. DES AUFRUFERS LADEN
         WTO   MF=(E,MSG01)  UEBERSCHRIFTENZEILE AUSGEBEN
         LA    R10,MSGTAB-68 ADRESSE DER TABELLE LADEN
         L     R9,ADDRETB1   ENDADRESSE DER TABELLE LADEN
         BAL   R14,AUSGABE   VERZW. ZUR AUSGABE WEITERER ZEILEN
         LA    R10,MSGTAB    ADRESSE DER TABELLE LADEN
         ST    R10,SAVE1R10      UND SPEICHERN
         L     R14,SAVE1R14  RUECKSPRUNGADRESSE LADEN
         CLI   WTORBYTE,X'FF' FLAG BYTE GESETZT ?
         BNER  R14           NEIN, VERZWEIGEN
NXTREPLY EQU   *
         XC    ECB,ECB       EVENT CONTROL BLOCK LOESCHEN
         L     R0,UCMID      UCM-ID. DES AUFRUFERS LADEN
         LA    R4,ECB        ADRESSE DES ECB LADEN
         LA    R5,REPLY      ADRESSE DES REPLY LADEN
         MVC   WTOR(LENMSG08),MSG08 NACHRICHTENZEILE UEBERTRAGEN
         WTOR  ,(R5),1,(R4),MF=(E,WTOR)
         SPACE 1
         WAIT  ECB=ECB       AUF REPLY WARTEN
         CLI   REPLY,C'N'    REPLY = NO ?
         BE    ENDE          JA, VERZWEIGEN
         CLI   REPLY,C'Y'    REPLY = YES ?
         BNE   NXTREPLY      NEIN, VERZWEIGEN
         L     R14,SAVE1R14  RUECKSPRUNGADRESSE LADEN
         BR    R14           VERZWEIGEN
         EJECT
*
*      AUSGABE EINZELNER NACHRICHTENZEILEN.
*
         SPACE 1
AUSGABE  EQU   *
         ST    R14,SAVE2R14  RUECKSPRUNGADRESSE SICHERN
NEXTMESS EQU   *
         LA    R10,68(R10)   R10 ERHOEHEN
         CR    R10,R9        ENDE DER TABELLE ERREICHT ?
         BNL   ENDMESS       JA, VERZWEIGEN
         CLC   MESSFLAG,=X'FFFF' FLAG BYTES GESETZT ?
         BE    ENDMESS       JA, VERZWEIGEN
         MVC   MESSFLAG,=X'FFFF' FLAG BYTES SETZEN
         L     R0,UCMID      UCM-ID. DES AUFRUFERS LADEN
         WTO   MF=(E,MESSAGE) EINE NACHRICHTENZEILE AUSGEBEN
         B     NEXTMESS      VERZWEIGEN
ENDMESS  EQU   *
         L     R14,SAVE2R14  RUECKSPRUNGADRESSE LADEN
         BR    R14           VERZWEIGEN
         EJECT
***********************************************************************
*                                                                     *
*      UMWANDLUNG VON DUALZAHLEN IN ENTPACKTE DEZIMALZAHLEN.          *
*                                                                     *
***********************************************************************
         SPACE 3
CONVDEC  EQU   *
         CVD   R4,DBWORD     INHALT VON R4 UMWANDELN
         UNPK  ZWFELD,DBWORD DEZIMALZAHL ENTPACKEN
         OI    ZWFELD+14,C'0' VORZEICHEN MODIFIZIEREN
         BR    R14           VERZWEIGEN
         SPACE 3
***********************************************************************
*                                                                     *
*      BEFEHLE, DIE MIT HILFE DES EXECUTE-BEFEHLS AUSGEFUEHRT WERDEN. *
*                                                                     *
***********************************************************************
         SPACE 3
MOVEPVOL EQU   *
         MVC   1(0,R6),1(R7) VOLID IN TABELLE UEBERTRAGEN
NCVOLID1 EQU   *
         NC    ZWVOLID1(0),1(R6) VOLID UEBERLAGERN
OCVOLID2 EQU   *
         OC    ZWVOLID2(0),1(R7) VOLID UEBERLAGERN
         EJECT
***********************************************************************
*                                                                     *
*      REGISTER EQUATES.                                              *
*                                                                     *
***********************************************************************
         SPACE 3
R0       EQU   0             MACRO- UND-PARAMETER REGISTER
R1       EQU   1             MACRO- UND-PARAMETER REGISTER
R2       EQU   2             POINTER IN CVT / UCB LOOKUP TABLE
R3       EQU   3             POINTER FUER UCB
R4       EQU   4             ARBEITSREGISTER
R5       EQU   5             ARBEITSREGISTER
R6       EQU   6             ARBEITSREGISTER
R7       EQU   7             ARBEITSREGISTER
R8       EQU   8             ARBEITSREGISTER
R9       EQU   9             ARBEITSREGISTER
R10      EQU   10            POINTER IN NACHRICHTEN-TABELLEN
R11      EQU   11            BASISREG. FUER DSECT PARMAREA / VEKTOR
R12      EQU   12            BASISREG. FUER CSECT VTOC
R13      EQU   13            BASISREG. FUER DSECT ABER
R14      EQU   14            RUECKSPRUNGADRESSEN
R15      EQU   15            CSECT-ADRESSEN UND RETURN CODES
         EJECT
***********************************************************************
*                                                                     *
*      DEFINITION DER KONSTANTEN-SPEICHER.                            *
*                                                                     *
***********************************************************************
         SPACE 3
*
*      CAMLIST-MACRO (KONSTANTEN).
*
         SPACE 1
CAMCOBT  CAMLST SEEK,0,0,0
CAMLEN   EQU   *-CAMCOBT     LAENGE DES CAMLIST-MACROS
         SPACE 2
*
*      TABELLE FUER AUFBEREITUNG VON HEXADEZIMALZAHLEN.
*
         SPACE 1
TABHEXA  DC    C'0123456789ABCDEF'
         EJECT
*
*      TRACKS / CYLINDER UND ALTERNATE TRACKS.
*
         SPACE 1
TABTCAP  DS     0H
         DC     X'80',XL3'0'  00 - RESERVED
         DC     X'80',XL3'0'  01 - 2311    DISK STORAGE DEVICE
         DC     X'80',XL3'0'  02 - 2301    PARALLEL DRUM
         DC     X'80',XL3'0'  03 - 2303    SERIAL DRUM
         DC     X'80',XL3'0'  04 - 2302    DISK STORAGE
         DC     X'80',XL3'0'  05 - 2321    DATA CELL DRIVE
         DC     H'08',H'001'  06 - 2305/1  FIXED HEAD STORAGE / MODEL 1
         DC     H'08',H'001'  07 - 2305/2  FIXED HEAD STORAGE / MODEL 2
         DC     X'80',XL3'0'  08 - 2314    DISK STORAGE FACILITY
         DC     H'19',H'133'  09 - 3330/1  DISK STORAGE / MODEL 1
         DC     H'12',H'012'  0A - 3340    DISK STORAGE
         DC     H'30',H'150'  0B - 3350    DISK STORAGE
         DC     X'80',XL3'0'  0C - RESERVED
         DC     H'19',H'133'  0D - 3330/11 DISK STORAGE / MODEL 11
         DC     X'80',XL3'0'  0E - RESERVED
         DC     X'80',XL3'0'  0F - RESERVED
         EJECT
***********************************************************************
*                                                                     *
*      DEFINITION DER AUSGABENACHRICHTEN.                             *
*                                                                     *
***********************************************************************
         SPACE 3
MSG01    WTO   'XVTOC01 VOLSER ADR CCHH DSCB USED ATRK VSAM ---TIMESTAM*
               P----',                                                 *
               MF=L,MCSFLAG=(REG0)
         SPACE 1
MSG02    WTO   'XVTOC02 VOLSER ADR 0000 **** **** 0000                 *
                      ',                                               *
               MF=L,MCSFLAG=(REG0)
LENMSG02 EQU   *-MSG02
         SPACE 1
MSG03    WTO   'XVTOC03 SPECIFIED VOLUME(S) NOT FOUND',                *
               MF=L,MCSFLAG=(REG0)
         SPACE 1
MSG04    WTO   'XVTOC04 INVALID PARAMETER LIST',                       *
               MF=L,MCSFLAG=(REG0)
         EJECT
MSG05    WTO   'XVTOC05 VOLSER=123456, DEVICE FAILURE, DEVCODE=99',    *
               MF=L,MCSFLAG=(REG0)
LENMSG05 EQU   *-MSG05
         SPACE 1
MSG06    WTO   'XVTOC06 VOLSER=123456, OBTAIN FAILURE, RC=99',         *
               MF=L,MCSFLAG=(REG0)
LENMSG06 EQU   *-MSG06
         SPACE 1
MSG07    WTO   'XVTOC07 VOLSER=123456, 1. DSCB NOT FORMAT 4',          *
               MF=L,MCSFLAG=(REG0)
LENMSG07 EQU   *-MSG07
         SPACE 1
MSG08    WTOR  'XVTOC08 REPLY ''Y'' (YES) OR ''N'' (NO) TO CONTINUE',  *
               MF=L,MCSFLAG=(REG0)
LENMSG08 EQU   *-MSG08
         EJECT
***********************************************************************
*                                                                     *
*      DEFINITION DER ARBEITSBEREICHE.                                *
*                                                                     *
***********************************************************************
         SPACE 3
ABER     DSECT
SAVEAREA DS    18F           SAVEAREA FUER ALLGEMEINE REGISTER
         SPACE 2
*
*      ADRESSEN-SPEICHER.
*
         SPACE 1
ADDRETB1 DS    F             ENDADRESSE DER MSG-NACHRICHTEN-TABELLE
ADDRETPV DS    F             ENDADRESSE DER VOLSER-TABELLE
SAVE1R10 DS    F             SAVEAREA1 FUER R10
SAVE1R14 DS    F             SAVEAREA1 FUER R14
SAVE2R14 DS    F             SAVEAREA2 FUER R14
UCBADDR  DS    F             ADRESSE DES UCB-VEKTORS
UCMID    DS    F             UCM-ID. DES AUFRUFERS
         SPACE 2
*
*      ARBEITSSPEICHER.
*
         SPACE 1
DBWORD   DS    D             ZWISCHENSPEICHER
ZWFELD   DS    CL15          ZWISCHENSPEICHER FUER DEZIMALZAHLEN
FNDBYTE  DS    C             SCHALTER FUER GEFUNDENE VOLUMES
MVSBYTE  DS    C             SCHALTER FUER SYSTEM = MVS
VSAMBYTE DS    C             SCHALTER FUER VSAM
WTORBYTE DS    C             SCHALTER FUER WTOR
REPLY    DS    C             SPEICHER FUER REPLY
VOLSERNO DS    CL6           ZWISCHENSPEICHER FUER VOLSER NUMBER
ZWVOLID1 DS    CL6           ZWISCHENSPEICHER FUER VOLSER NUMBER
ZWVOLID2 DS    CL6           ZWISCHENSPEICHER FUER VOLSER NUMBER
TRKPCYL  DS    F             TRACKS PRO CYLINDER
NOALTRK  DS    F             ANZAHL DER ALLOCATED DSCBS
HIGHWATM DS    F             HIGH WATER MARK DER USED DSCBS
NODSCBS  DS    F             HIGH WATER MARK FUER ANZ. DER DSCBS
ECB      DS    F             EVENT CONTROL BLOCK
WTOR     DS    15F           BEREICH FUER WTOR-NACHRICHT
MRECNO   DS    H             MAX. SATZADRESSE
MTRKNO   DS    H             MAX. SPURADRESSE
         EJECT
*
*      CAMLIST-MACRO (ARBEITSBEREICH).
*
         SPACE 1
CAMOBT   DS    0F
         DS    C             AL1(192)
         DS    C             AL1(128)
         DS    C             AL1(0)
         DS    C             AL1(0)
CADRCCHH DS    F             A(CCHHR)
CADRUCBV DS    F             A(UCBVOLI)
CADRCAMW DS    F             A(CAMWKFLD)
         DS    0H
CCHHR    DS    CL5           CCHHR-ADRESSE DES NAECHSTEN DSCB
         DS    0D
CAMWKFLD DS    CL148         WORK FIELD
         SPACE 2
*
*      DSCB4-DEFINITIONEN.
*
         SPACE 1
         ORG   CAMWKFLD
WKDSCB4  DS    0CL148        DATA SET CONTROL BLOCK FORMAT 4
         DS    CL44
DS4FMTID DS    C             FORMAT IDENTIFIER (=C'1')
         DS    CL5
DS4DSREC DS    CL2           NUMBER OF AVAILABLE FORMAT 0 DSCBS
         DS    CL4
DS4NOATK DS    CL2           NUMBER OF ALTERNATE TRACKS REMAINING
         DS    CL4
DS4DEVSZ DS    CL4           DEVICE SIZE
         DS    CL8
DS4DEVDT DS    C             NUMBER OF DSCBS PER TRACK
         DS    C
DS4VSTMS DS    CL8           VSAM TIMESTAMP
DS4VSCID DS    C             VSAM CATALOG INDICATOR
         DS    CL20
DS4VTOCE DS    CL10          VTOC EXTENT
         DS    CL25
         EJECT
*
*      MASKEN-TABELLEN FUER VOLSER NUMBERS AUS DEM PARAMETERBEREICH.
*
*      AUFBAU DER TABELLE:
*      BYTE1 - LAENGE DES ANGEGEBENEN VOLSER-PARAMETERS ODER
*          X'80' BEI TABELLENENDE
*      BYTES2-7 - ANFANGSZEICHEN DER VOLSER NUMBER UND MASKENZEICHEN
*
         SPACE 1
TABPVOL1 DS    10CL7         TABELLE MIT MASKENZEICHEN X'FF'
ENDTPVOL EQU   *
         DS    CL7
TABPVOL2 DS    CL77          TABELLE MIT MASKENZEICHEN X'00'
         SPACE 2
*
*      NACHRICHTEN-BEREICHE.
*
*      AUFBAU:
*      BYTE1-66: WTO-NACHRICHTENZEILE
*      BYTE67-68: X'0000', WENN NACHRICHTENZEILE VERFUEGBAR
*
         SPACE 1
         DS    0F
MSGTAB   DS    10CL68        TABELLE FUER NACHRICHTEN
ENDTAB1  EQU   *
FEHLTAB  DS    CL68          TABELLE FUER FEHLERNACHRICHTEN
         SPACE 1
ABERL    EQU   *-ABER        LAENGE DER ARBEITSBEREICHE
         EJECT
***********************************************************************
*                                                                     *
*      DEFINITIONEN FUER EINE NACHRICHTENZEILE.                       *
*                                                                     *
***********************************************************************
         SPACE 3
MESSAGE  DSECT
         SPACE 2
*
*      DEFINITIONEN FUER MSG02.
*
         SPACE 1
         ORG   MESSAGE+4
         DS    CL8
MS2VOLID DS    CL6           VOLUME SERIAL NUMBER
         DS    C
MS2ADR   DS    CL3           UNIT ADDRESS
         DS    C
MS2CCHH  DS    CL4           CCHH-ADRESSE DER VTOC
         DS    C
MS2DSCB  DS    CL4           AVAILABLE DSCBS
         DS    C
MS2USED  DS    CL4           USED DSCBS
         DS    C
MS2ATRK  DS    CL4           USED ALTERNATE TRACKS
         DS    C
MS2FLAGS DS    CL4           VSAM FLAGS
         DS    C
MS2VSTMS DS    CL16          VSAM TIMESTAMP
         EJECT
*
*      DEFINITIONEN FUER MSG05.
*
         SPACE 1
         ORG   MESSAGE+4
         DS    CL15
MS5VOLI  DS    CL6           VOLUME SERIAL NUMBER
         DS    CL26
MS5DEVC  DS    CL2           DEVICE CODE
         SPACE 2
*
*      DEFINITIONEN FUER MSG06.
*
         SPACE 1
         ORG   MESSAGE+4
         DS    CL15
MS6VOLI  DS    CL6           VOLUME SERIAL NUMBER
         DS    CL21
MS6RC    DS    CL2           RETURN CODE
         SPACE 2
*
*      DEFINITIONEN FUER MSG07.
*
         SPACE 1
         ORG   MESSAGE+4
         DS    CL15
MS7VOLI  DS    CL6
         SPACE 2
         ORG   MESSAGE+66
MESSFLAG DS    CL2           FLAG BYTES
         EJECT
***********************************************************************
*                                                                     *
*      UCB-DEFINITIONEN.                                              *
*                                                                     *
***********************************************************************
         SPACE 3
UCB      DSECT
         DS    CL3
DEVSTAT  DS    C             DEVICE STATUS
         DS    CL9
UCBNAME  DS    CL3           UNIT NAME
         DS    CL2
UCBDVCLS DS    C             DEVICE CLASS
DEVCODE  DS    C             DEVICE CODE
         DS    CL4
UCBVTOC  DS    CL4           REL. ADDR. OF VTOC FOR THIS VOL. (TTR0)
UCBVOLI  DS    CL6           VOLUME SERIAL NUMBER
         ORG   UCB+36
SRTEFSCT DS    CL4           REL. ADDR. OF VTOC (MVT + VS2, REL.1)
         SPACE 3
***********************************************************************
*                                                                     *
*      PARAMETERBEREICH.                                              *
*                                                                     *
***********************************************************************
         SPACE 3
         XPARM
PARMENDE EQU   *
         SPACE 3
***********************************************************************
*                                                                     *
*      VEKTOR MIT UCB-ADRESSEN.                                       *
*                                                                     *
***********************************************************************
         SPACE 3
VEKTOR   DSECT
         DS    1024H
VEKEND   DS    H             =X'FFFF'
VEKLEN   EQU   *-VEKTOR
         EJECT
         END   VTOC
./ ADD  NAME=WTOR
WTOR     CSECT
         REG
         XSAVE R12,,WTOR,WORKL
         LR    R11,R1
         USING PARMAREA,R11
         USING WORK,R13
         L     R3,16
         MVI   MVS,X'00'
         TM    116(R3),X'01'
         BZ    *+8
         MVI   MVS,X'FF'
         L     R3,100(R3)
         L     R3,28(R3)
         LA    R3,0(R3)
         LTR   R3,R3
         BZ    NOWTOR
         MVC   WTO(MESS2-MESS1),MESS1
         CLI   MVS,X'FF'
         BNE   NEXTRQE
         MODESET KEY=ZERO
NEXTRQE  EQU   *
         L     R4,12(R3)
         LH    R5,6(R4)
         BCTR  R5,0
         CLI   MVS,X'FF'  MVS?
         BNE   *+8            NO
         LA    R5,23(R5)      ADD PREFIX LENGTH
         CH    R5,=H'52'      LIMIT WTOR LENGTH
         BNH   LENGTHOK
         LH    R5,=H'52'
LENGTHOK EQU   *
         EX    R5,MVCEX1
         LA    R5,13(R5)
         STH   R5,WTO
         L     R0,REG4
         WTO   MF=(E,WTO)
         L     R3,0(R3)
         LA    R3,0(R3)
         LTR   R3,R3
         BNZ   NEXTRQE
RETURN   EQU   *
         CLI   MVS,X'FF'
         BNE   END
         MODESET KEY=NZERO
END      EQU   *
         XRETURN ,R
NOWTOR   EQU   *
         MVC   WTO(MESS3-MESS2),MESS2
         L     R0,REG4
         WTO   MF=(E,WTO)
         B     RETURN
MESS1    WTO   'XWTOR01                                                *
                         ',MF=L,MCSFLAG=REG0
MESS2    WTO   'XWTOR02 NO OUTSTANDING REPLIES',MF=L,                  *
               MCSFLAG=(REG0)
MESS3    DS    0H
MVCEX1   MVC   WTO+12(0),8(R4)
         XPARM
WORK     DSECT
SVA      DS    18F
WTO      DS    CL140
MVS      DS    C
WORKL    EQU   *-WORK
         END   WTOR
./ ADD  NAME=XCNTRLVS
XCNTRLVS CSECT
         PRINT NOGEN
         XSAVE R12,,XCNTRLVS,WORKLX
         USING WORKX,R13
         EXTRACT ANSWER,FIELDS=COMM
         L     R3,ANSWER
         LA    R3,4(R3)
         QEDIT ORIGIN=(R3)
         EXTRACT ANSWER,FIELDS=COMM
         L     R3,ANSWER
         LA    R3,4(R3)
         QEDIT ORIGIN=(R3),CIBCTR=5
         L     R3,ANSWER
WAITX    EQU   *
         L     R1,0(R3)
         WAIT  ECB=(1)
         EXTRACT ANSWER,FIELDS=COMM
         L     R6,ANSWER
         L     R6,4(R6)
CONT     EQU   *
         XR    R7,R7        LOAD CALLERS CON ID
         IC    R7,12(R6)    INTO REG 7.
         L     R3,=V(CONID) STORE CON ID
         ST    R7,0(R3)     INTO STAI-EXIT FOR ABEND MSG
         CLI   4(R6),X'40'
         BE    RETURN
         LH    R3,14(R6)
         LTR   R3,R3
         BNP   WAIT
         MVC   MODULENM,=CL8' '
         BCTR  R3,0
         MVI   ZWI,X'40'
         MVC   ZWI+1(127),ZWI
         EX    R3,MVCEX2
         XC    ZWI(4),ZWI
         LA    R15,128
         STH   R15,ZWI
         LA    R1,ZWI
         CALL  BSPCORR
         LTR   R15,R15
         BNZ   WAIT
         MVI   ZWI+3,C'<'
         CALL  BSPCORR
         LTR   R15,R15
         BNZ   WAIT
         LR    R8,R6
* SEARCH L-OPERAND FOR DEDICATED CONID
         LA    R6,ZWI+4
         MVI   LCONID,X'00'
NEXTPOS  EQU   *
         LA    R4,ZWI+127
         SR    R4,R6     COMPUTE TRT-LENGTH
         SR    R1,R1     ERASE R1 FOR TRT
         LH    R2,=H'64' INSERT BLANK FOR END CONDITION
         EX    R4,TRTEX2
         CH    R2,=H'64' END OF REQUEST-MSG?
         BE    ENDSRCH
         CLC   1(2,R1),=C'L='
         BNE   WEITER
         CLI   5(R1),C'Z'
         BNE   WEITER
         CLI   6(R1),C','
         BE    *+12
         CLI   6(R1),C' '
         BNE   WEITER
         TM    3(R1),X'F0'
         BNO   WEITER
         TM    4(R1),X'F0'
         BNO   WEITER
         PACK  DBLWORD,3(2,R1)
         CVB   R4,DBLWORD
         STC   R4,LCONID     DESTINATION CONSOLE
         MVC   3(3,R1),=C'<<<'
         LA    R1,ZWI
         CALL  BSPCORR
         LTR   R15,R15
         BNZ   WAIT
         B     ENDSRCH
WEITER   EQU   *
         LA    R6,1(R1)
         B     NEXTPOS
ENDSRCH  EQU   *
         LA    R6,ZWI-12
         LA    R1,17(R3,R6)
         EX    R3,TRTEX1
         LA    R5,16(R6)
         SR    R1,R5
         LTR   R1,R1
         BNP   WAIT
         CH    R1,=H'8'       MODULENAME MAX 8 CHAR
         BNH   *+8
         LH    R1,=H'8'
         BCTR  R1,0
         EX    R1,MVCEX1
ATTACH   EQU   *
* ISSUE BLDL FOR THE REQUESTED MODULE NAME
         BLDL  0,BLDLIST      ISSUE BLDL FOR DATA SET IN STEPLIB
         LTR   R15,R15        BLDL RETURN CODE = 0?
         BNZ   ERRORMSG       BR IF NO
* TEST IF MODULE WAS FOUND IN STEPLIB
         CLI   BLDLZ,1        EXAMINE SOURCE OF DIRECTORY ENTRY
         BNH   ERRORMSG       IF NOT STEPLIB - ISSUE ERROR MSG
         B     ATTMOD         BR
* ISSUE ERROR MSG
ERRORMSG EQU   *
         MVC   MSGAREA,ERRMSGL  MOVE MSG SKELETON
         MVC   MSGMODNM,MODULENM  MOVE MODULE NAME
         SR    R0,R0          CLEAR R0 FOR IC
         IC    R0,12(,R8)     INSERT CONSOLE ID
         WTO   MF=(E,MSGAREA) ISSUE ERROR MSG
         B     WAIT           BR
ATTMOD   GETMAIN R,LV=128,SP=127
         MVC   4(124,R1),ZWI+4
         XC    0(4,R1),0(R1)
         MVC   3(1,R1),12(R8)
         CLI   LCONID,X'00'    L=..Z SPECIFIED?
         BE    *+10            NO.
         MVC   3(1,R1),LCONID  YES.
         ATTACH DE=MODULENM,STAI=(EXIT),GSPV=127
WAIT     EQU   *
         L     R3,ANSWER
         LA    R3,4(R3)
         L     R5,0(R3)
         QEDIT ORIGIN=(R3),BLOCK=(R5)
         EXTRACT ANSWER,FIELDS=COMM
         L     R3,ANSWER
         L     R6,4(R3)
         LA    R6,0(R6)
         LTR   R6,R6
         BZ    WAITX
         B     CONT
RETURN   EQU   *
         L     R15,16
         L     R15,0(R15)
         L     R15,4(R15)
         L     R15,136(R15)
         LA    R11,0(R15)
         LTR   R11,R11
         BZ    EXITRET
SWITCH   NOP   STORE
         XC    ECB,ECB
         MVC   REPLY,=CL3' '
         L     R7,=V(CONID)  INSERT CON ID
         L     R0,0(R7)
         WTOR  'XCNTRL1 REPLY ''YES'' OR ''NO'' TO STOP XCNTRL WITH ACT*
               IVE SUBTASKS',REPLY,3,ECB,MCSFLAG=(REG0)
         WAIT  ECB=ECB
         OC    REPLY,=CL3' '
         CLC   REPLY,=CL3'NO'
         BNE   TSTYES
         L     R3,ANSWER
         LA    R3,4(R3)
         QEDIT ORIGIN=(R3),CIBCTR=5
         B     WAIT
TSTYES   EQU   *
         CLC   REPLY,=CL3'YES'
         BNE   SWITCH
         MVI   SWITCH+1,X'F0'
STORE    EQU   *
         ST    R11,ANSWER
         DETACH ANSWER
         B     RETURN
EXITRET  EQU   *
         XRETURN 0,R
*
ERRMSGL  WTO   'XCNTRL3 MODULE AAAAAAAA NOT FOUND IN XCMD-LIBRARY',    *
               MCSFLAG=REG0,MF=L
MVCEX1   MVC   MODULENM(0),16(R6)
MVCEX2   MVC   ZWI+4(0),16(R6)
TRTEX1   TRT   16(0,R6),TRTAB
TRTEX2   TRT   00(0,R6),TRTAB
TRTAB    DC    256XL1'00'
         ORG   TRTAB+64
         DC    X'40'
         ORG   TRTAB+107
         DC    X'6B'
         ORG
         REG
ANSWER   DS    F
BLDLIST  DS    0CL62          BUILD LIST
BLDLFF   DC    H'0001'        NUMBER OF ENTRIES
BLDLLL   DC    H'0058'        LENGTH OF EACH ENTRY
MODULENM DS    CL8            MEMBER NAME
BLDLTTR  DS    CL3            MEMBER STARTING LOCATION
BLDLK    DS    CL1            CONCATENATION NUMBER
BLDLZ    DS    CL1            SOURCE OF DIRECTORY ENTRY
BLDLC    DS    CL1            NUMBER OF USER DATA HALFWORDS
BLDLUH   DS    22H            22 USER DATA HALFWORDS
ECB      DS    F
REPLY    DS    CL3
         LTORG
WORKX    DSECT
         DS    18F
LCONID   DS    C
DBLWORD  DS    D
MSGAREA  DS    0CL53             MSG AREA FOR ERROR MSG
         DS    CL4               RDW
         DS    CL15              'XCNTRL3 MODULE '
MSGMODNM DS    CL8               MODULE NAME
         DS    CL26              ' NOT FOUND IN XCMD LIBRARY'
*
         DS    0D
ZWI      DS    CL128
WORKLX   EQU   *-WORKX
         EJECT
EXIT     CSECT
         XSAVE R12,,EXIT,WORKL
         USING WORK1,R13
         LA    R15,12
         CR    R0,R15
         BNE   CROK
         LR    R3,R1
         B     CRNOK
CROK     EQU   *
         L     R3,4(R1)
CRNOK    EQU   *
         SLL   R3,8
         SRL   R3,8
         LR    R4,R3
         SLL   R4,20
         SRL   R4,20
         CR    R4,R3
         BNE   SYS
         CVD   R3,DBLWD
         UNPK  CC,DBLWD
         OI    CC+2,X'F0'
         B     DETACH
SYS      EQU   *
         SRL   R3,12
         ST    R3,DBLWD
         UNPK  CC(4),DBLWD(5)
         TR    CC,CCTAB-240
DETACH   EQU   *
         MVC   WTO1(CCTAB-MESS8),MESS8
         MVC   WTO1+39(3),CC
         CR    R0,R15
         BE    MOVNONAM
         TM    88(R1),X'40'  MODULE NAME OR RB ADDRESS?
         BO    MOVNAM        NO ADDRESS
MOVNONAM EQU   *
         MVC   WTO1+17(8),=CL8'NO NAME'
         B     WTO1XIT
MOVNAM   EQU   *
         MVC   WTO1+17(8),88(R1)
WTO1XIT  EQU   *
         L     R0,CONID        TAKE LATEST USER
         WTO   MF=(E,WTO1)
         XRETURN 0,R
MESS8    WTO   'XCNTRL2 TASK 12345678 ABENDED. CC= XXX',MF=L,          *
               MCSFLAG=(REG0)
CCTAB    DC    C'0123456789ABCDEF'
CONID    DC    A(0)         LATEST CON ID
         ENTRY CONID
         LTORG
WORK1    DSECT
SVA1     DS    18F
WTO1     DS    CL50
DBLWD    DS    D
CC       DS    CL3
         DS    X
WORKL    EQU   *-WORK1
         END
./ ADD  NAME=XPARM
         MACRO
         XPARM
PARMAREA DSECT
REG4     DS    F
TEXT     DS    CL124
PRMLEN   EQU   *-PARMAREA
         MEND
./ ADD  NAME=XPROC
//*
//*    OS/VS2 VERSION OF X-CMDS.
//*
//XCNTRLVS  PROC PRTY='(15,0)',CORE=256
//IEFPROC EXEC PGM=XCNTRLVS,DPRTY=&PRTY.,REGION=&CORE.K
//STEPLIB   DD DISP=SHR,DSN=CMD.XLINK
//IEFRDER   DD DUMMY
//HELPLIB   DD DISP=SHR,DSN=CMD.XHELP       HELP
//SYSIN     DD UNIT=VIODA,SPACE=(TRK,2)     AMS, BAY
//SYSPRINT  DD UNIT=VIODA,SPACE=(CYL,(5,5)) AMS, BAY
//SYSDIAG   DD DUMMY                        BAY
//PARMLIB   DD DUMMY                        BAY
//SYSUDUMP  DD SYSOUT=Z
./ ADD  NAME=XRETURN
         MACRO
&SYM     XRETURN &RC,&MODE
.*
.*                 EXTENDED RETURN MACRO
.*                 RESTORES REGISTERS
.*                 MAY PROVIDE RETURNCODE
.*
         LCLA  &C
         LCLB  &NC,&CF
         LCLC  &R,&NM
         AIF   (T'&MODE EQ 'O' OR '&MODE' EQ 'R').CONT
         MNOTE 8,'UNKNOWN OPERAND'
         MEXIT
.CONT    ANOP
&NM      SETC  '&SYM'
         AIF   (T'&RC NE 'O').CODE
&NC      SETB  (1)
         AGO   .NOCODE
.CODE    ANOP
&R       SETC  '15'
         AIF   ('&RC'(1,1) EQ '(').REG
         AIF   (T'&RC EQ 'N').FIX
&NM      L     15,&RC                  LOAD CODE
&NM      SETC  ''
         AGO   .NOCODE
.FIX     ANOP
&CF      SETB  (1)
         AGO   .NOCODE
.REG     ANOP
&R       SETC  '&RC'(2,K'&RC-2)
.NOCODE  ANOP
&NM      L     13,4(0,13)              GET HIGH SA ADDR
         AIF   (&NC OR &CF).NOSTORE
         ST    &R,16(0,13)             STORE CODE
.NOSTORE AIF   (T'&MODE EQ 'O').NORENT
         L     1,8(0,13)               GET LOW SA ADDR
         LH    0,2(1)                  GET LENGTH
         LA    15,1                    PREPARE FOR SP 1
         SLL   15,24                   SP IN HIGH ORDER BYTE
         OR    0,15                    INSERT SP 1
         FREEMAIN  R,LV=(0),A=(1)      FREE CORE
.NORENT  LM    14,12,12(13)            RESTORE REGS
         AIF   (NOT &CF).EXIT
         LA    15,&RC                  LOAD CODE
&C       SETA  &RC
         AIF   (&C/4*4 EQ &C).EXIT
         MNOTE 0,'UNUSUAL CODE'
.EXIT    MVI   12(13),X'FF'            FORTRAN REQUIREMENT
         SPM   14                      RESTORE PGM MASK AND CC
         BR    14
         MEND
./ ADD  NAME=XSAVE
         MACRO
&SYM     XSAVE &BASE,&AREA,&ID,&LEN
.*
.*                 EXTENDED SAVE MACRO
.*                 ASSUMES ENTRYPOINT ADDRESS IN REGISTER 15
.*                 SAVES REGISTERS 14 THROUGH 12
.*                 LOADS BASE REGISTER AND CHAINES SAVEAREAS
.*                 MAY PRODUCE REENTRANT CODE
.*
         LCLA  &OFFSET,&BASEOFF,&LLID,&DISPL
         LCLA  &NREG,&REGIX
         LCLC  &NM,&REG,&BL
         LCLC  &PREV
&OFFSET  SETA  4
&NM      SETC  '&SYM'
&REG     SETC  '15'
&BL      SETC  ''
         AIF   (T'&ID EQ 'O').NOID
&LLID    SETA  K'&ID
         AIF   (&LLID NE &LLID/2*2).OVBL
&BL      SETC  ' '
&LLID    SETA  &LLID+1   BLANK
.OVBL    ANOP
&LLID    SETA  &LLID+8   DATE
&DISPL   SETA  4+1+&LLID   B,X,(DATE,ID)
&NM      B     &DISPL.(0,15)
         DC    AL1(&LLID)
         DC    C'&ID&BL'
         DC    CL8'&SYSDATE'
&OFFSET  SETA  4+4+1+&LLID   B,STM,X,(DATE,ID)
&NM      SETC  ''
.NOID    ANOP
&NM      STM   14,12,12(13)            SAVE REGS
         AIF   (T'&BASE EQ 'O').NOBASE
         AIF   ('&BASE'(1,1) NE '(').LOAD
&REGIX   SETA  1
&NREG    SETA  N'&BASE
&REG     SETC  '&BASE(&REGIX)'
         LR    &REG,15
&OFFSET  SETA  &OFFSET+2
.LOOP    ANOP
         USING *-&OFFSET+&BASEOFF,&REG
&REGIX   SETA  &REGIX+1
         AIF   ('&REGIX' GT '&NREG').SETUSE
&PREV    SETC  '&REG'
&REG     SETC  '&BASE(&REGIX)'
         LA    &REG,X'FFF'
         LA    &REG,1(&REG,&PREV)
&OFFSET  SETA  &OFFSET+8
&BASEOFF SETA  &BASEOFF+4096
         AGO   .LOOP
.LOAD    LR    &BASE,15                LOAD BASE REG
&OFFSET  SETA  &OFFSET+2
&REG     SETC  '&BASE'
.NOBASE  ANOP
         USING *-&OFFSET,&REG
.SETUSE  ANOP
         AIF   (T'&AREA NE 'O').NORENT
         AIF   (T'&LEN NE 'O').NOTZERO
         LA    0,72                    GET LENGTH
         AGO   .COMP
.NOTZERO ANOP
         LA    0,&LEN                  GET LENGTH
.COMP    ANOP
         LA    1,1                     PREPARE FOR SP 1
         SLL   1,24                    SP 1 IN HIGH ORDER BYTE
         OR    0,1                     INSERT SP 1
         GETMAIN   R,LV=(0)            GET CORE
         XC    0(3*4,1),0(1)           ZERO CHAIN ADDRESSES
         AIF   (T'&LEN NE 'O').GET
         LA    0,72                    GET LENGTH
         AGO   .NOSTH
.GET     ANOP
         LA    0,&LEN                  GET LENGTH
.NOSTH   ANOP
         STH   0,2(1)                  STORE LENGTH
         AGO   .COM
.NORENT  LA    1,&AREA                 GET SA ADDR
.COM     ST    1,8(0,13)               SA DOWN CHAIN
         ST    13,4(0,1)               SA UP CHAIN
         LR    13,1                    LOAD SA REG
         L     1,4(0,13)               GET HIGH SA
         LM    0,1,20(1)               RESTORE REGS 0 AND 1
         AIF   (T'&AREA NE 'O').TEST
         MEXIT
.TEST    AIF   (T'&AREA EQ 'U').DEFINE
         MEXIT
.DEFINE  B     &AREA+72                BRANCH AROUND SAVEAREA
&AREA    DC    18F'0'                  SAVEAREA
         MEND

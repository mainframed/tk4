PROC 0
GLOBAL &HEXVALUE
GLOBAL &VALUE
/**********************************************************************/
/*     H     H   EEEEEEE    AAAAA    DDDDDD    EEEEEEE   RRRRRR       */
/*     H     H   E         A     A   D     D   E         R     R      */
/*     HHHHHHH   EEEEEEE   AAAAAAA   D     D   EEEEEEE   RRRRRR       */
/*     H     H   E         A     A   D     D   E         R   R        */
/*     H     H   EEEEEEE   A     A   DDDDDD    EEEEEEE   R     R      */
/**********************************************************************/
/*  CLIST NAME: VTAM22            REL/DATE: 2.1/08.15.79              */
/*                                                                    */
/*  DOC: THIS CLIST WILL FIND RPH'S AND CRA'S AND LIST 32 BYTES OF    */
/*       THE RPH.  IT WILL ALSO DETERMINE WHETHER LOCKS ARE HELD      */
/*       BY ANY RPH'S.                                                */
/*  SYMBOLS EQUATED: ATCVT, RPH, PCB, LPB.                            */
/*  SYMBOLS FOUND: ATCVT, RPH, PCB, LPB.                            */
/*  RETURN: CONTROL IS PASSED TO THE CALLING CLIST OR IPCS.           */
/*  DEPENDENCIES: 1) THIS CLIST REQUIRES THAT COMMAND                 */
/*                   CLEAR BE INSTALLED IN YOUR ENVIRONMENT.        */
/*                2) THIS CLIST REQUIRES THAT CLIST 'HEX' BE          */
/*                   INSTALLED IN YOUR ENVIRONMENT.                   */
/*  USE: WHEN CONTROL IS RECEIVED, THIS CLIST FINDS THE RPH'S AND THE */
/*       CRA'S, LIST 32 BYTES OF THE RPH AND DETERMINES WHETHER LOCKS */
/*       ARE HELD BY ANY RPH'S.                                       */
/*SJM******************************************************************/
EQ ATCVT 408.%                           /* FIND ATCVT                */
EQ VTAMASCB ATCVT+5C4% STR(ASCB)         /* EQUATE THE SCB            */
EVAL VTAMASCB+24 LE(2)
SET &VTAMASID=&LASTCC                    /* FIND VTAM'S ASID          */
EQ BPDTY ATCVT+80%
FUNC2: SET &SW=0                         /* ASK USER IF HE WANTS TO   */
NOTE 'START OF RPH ANALYSIS' NOTERMINAL PRINT PAGE
WRITE DO YOU WANT TO LIST RPH'S (IF NO, VTAMDIAG RUNS 3 TO 5 MINS TO
WRITENR CHECK VTAM LOCK STATUS.) ENTER Y/(N) ===>
READ &AF2                                /* THE RPH'S.                */
IF &AF2=&STR(Y) × &AF2=&STR(YES) THEN DO
WRITE DO YOU WANT THE FIRST WORD OF MAJOR CONTROL BLOCK AND
WRITENR WORK ELEMENT LISTED? Y/(N) ===>
      READ &AF3
      END
IF &AF2^=&STR(Y) × &AF2^=&STR(YES) THEN DO
NOTE 'THE FOLLOWING ARE THE RPHS' PAGE PRINT NOTERMINAL
SET &T=NOTERMINAL
END
EQ LPEE BPDTY+C8%                 /* PTR TO LP BPCB       */
EVAL LPEE+8                      /* GET START OF LPBUF AREA */
SET &LPBEGIN=&LASTCC            /* START OF LPBUF */
EVAL LPEE+C                      /* GET END OF LPBUF AREA */
SET &LPEND=&LASTCC              /* END OF LPBUF       */
EQ LPBUF LPEE+8%
EQ LPB LPEE+8%
EQ LPBUFL LPEE+C%
SET &N=0                        /* TEMPORARY COUNTER */
SET &LPLEN=&LPEND-&LPBEGIN       /* USE FOR LENGTH OF SEARCH FOR CRA*/
LOOP: IF &LPLEN>=844 THEN  DO          /* IS LENGTH BELOW MIN  */
  IF &SW=0 THEN DO
     SET &SW=1
     L LPB NOTERMINAL PRINT
     GOTO BYPASS
     END
BYPASS: F X'016C' ADDR(X:X+EC0) NOVERIFY BDY(4) FLAG(TERMINATING)
IF &LASTCC=4 THEN GOTO FUNC2END
COMPARE VALUE(X'FF') WITH(ADDRESS(X-3C) LE(1))    MASK(X'80')
IF &LASTCC^=0 THEN DO   /* NEWWW */
   EVAL X+2      /* SET BEGIN SEARCH ADDRESS */
   GOTO LOOP
   END
/************ START  CODE TO CHECK LOCKS  ***********************/
EVAL X LE(2)
SET &RPHID=&LASTCC
EVAL X-2C                     /* POINT TO LOCK STAT WORD */
SET &LOCKSTAT=&LASTCC         /* GET STAT */
IF &LOCKSTAT>0 && &LOCKSTAT<=256 && &RPHID=364 THEN DO
   WRITE LOCK(S) HELD.   ADDR LOCK WORD FOLLOWS. USE TO CALC RPH ADDR.
   L X-2C LE(4)
   /* BREAKDOWN LOCK WORD */
   COMPARE VALUE(X'FF') WITH(ADDRESS(X-29)) MASK(X'01') LENGTH(1)
   IF &LASTCC=0 THEN WRITE LEVEL 1 VDLOCK HELD.  '
   COMPARE VALUE(X'FF') WITH(ADDRESS(X-29)) MASK(X'02') LENGTH(1)
   IF &LASTCC=0 THEN WRITE LEVEL 2 VOCLOCK HELD.  '
   COMPARE VALUE(X'FF') WITH(ADDRESS(X-29)) MASK(X'04') LENGTH(1)
   IF &LASTCC=0 THEN WRITE LEVEL 3 RDTLOCK HELD.   '
   COMPARE VALUE(X'FF') WITH(ADDRESS(X-29)) MASK(X'08') LENGTH(1)
   IF &LASTCC=0 THEN WRITE LEVEL 4 OCLOCK OR FMCBLOCK HELD.'
   COMPARE VALUE(X'FF') WITH(ADDRESS(X-29)) MASK(X'10') LENGTH(1)
   IF &LASTCC=0 THEN WRITE LEVEL 5 DEBLOCK OR DNCBLOCK HELD.'
   COMPARE VALUE(X'FF') WITH(ADDRESS(X-29)) MASK(X'20') LENGTH(1)
   IF &LASTCC=0 THEN WRITE LEVEL 6 SNTLOCK HELD.    '
   COMPARE VALUE(X'FF') WITH(ADDRESS(X-29)) MASK(X'40') LENGTH(1)
   IF &LASTCC=0 THEN WRITE LEVEL 7 DAFLOCK HELD.     '
   COMPARE VALUE(X'FF') WITH(ADDRESS(X-29)) MASK(X'80') LENGTH(1)
   IF &LASTCC=0 THEN WRITE LEVEL 8 DVTLOCK OR CTLLOCK OR CKPLOCK HELD.'
   EVAL X+0                   /* RESET PTR BEGINNING OF RPH */
   END
 ELSE  EVAL X+0             /* RESET PTR BEGINNING OF RPH */
/************ END   NEW CODE TO CHECK LOCKS  ***********************/
WRITE
L X LE(32)  /* SET BEGIN SEARCH ADDRESS */
EQU ELEM X
IF &AF2^=&STR(Y) OR &AF3^=&STR(YES) THEN GOTO NORPHELM
EVAL ELEM+15 LE(3)
SET &MCB=&LASTCC
IF &MCB=0 THEN +
NOTE 'THERE IS NO MAJOR CONTROL BLOCK FOR THIS RPH'
IF &MCB^=0 THEN DO
NOTE 'THE FOLLOWING IS THE FIRST WORD OF THE MAJOR CONTROL BLOCK:'
L ELEM+14% LEN(4) ASID(&VTAMASID)
END
EVAL ELEM+19 LE(3)
SET &WE=&LASTCC
IF &WE=0 THEN +
NOTE 'THERE IS NO WORK ELEMENT FOR THIS RPH'
IF &WE^=0 THEN DO
NOTE 'THE FOLLOWING IS THE FIRST WORD OF THE WORK ELEMENT:'
L ELEM+18% LE(4) ASID(&VTAMASID)
END
EVAL ELEM+0
NORPHELM: +
SET &LPLEN=&LPLEN-844     /* DECREMENT SEARCH LENGTH */
EVAL X+18
GOTO LOOP              /* LOOP TO FIND ALL RPH'S */
END
FUNC2END: WRITE VTAM22 COMPLETED.

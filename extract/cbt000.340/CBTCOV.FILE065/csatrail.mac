++PTF (PK00001).
++VER (Z038) FMID (JBB1326) PRE (UZ55983).
++VER (Z038) FMID (JBB1326) PRE (UZ56392)  /*
* *****************************************************************
*                      SQA TRAILER ZAP
*
* DESCRIPTION- THIS ZAP WILL MODIFY IEAVGM00 TO ADD A FOUR WORD
*              TRAILER BLOCK AT THE END OF GETMAINED AREAS IN
*              SUBPOOLS 245, 227, 228, AND 239.
*
* OPERATION- FROM THE HOOKS IN IEAVGM00 A X'10' BYTE TRAILER
*            IS ADDED TO GETMAINS FOR SQA AND IS DELETED FOR
*            FREEMAINS OF SQA PROVIDING THE X'10' BYTES FOLLOWING A
*            FREEMAIN REQUEST CAN BE IDENTIFIED AS CONTAINING A
*            TRAILER.
*
* EXCEPTIONS/RESTRICTIONS-
*
*          - IF AN AREA GETMAINED IN ONE BLOCK IS LATER FREEMAINED
*            IN PARTS THE TRAILER WILL DISAPPEAR WHEN THE PART OF
*            THE BLOCK WITH THE LARGEST VIRTUAL ADDRESS IS
*            FREEMAINED. THEREFORE, THE TRAILER CAN DISAPPEAR
*            PREMATURELY.
*
*          - IF THE REQUEST IS FOR A MULTIPLE OF A PAGE,
*            (I.E. 1000, 2000, 3000 BYTES, ETC), THE TRACE WILL
*            NOT ADD ON X'10' BYTES BUT BUILDS THE TRAILER IN THE
*            LAST X'10' BYTES OF THE REQUESTED GETMAINED AREA.
*            SO IF THE REQUESTOR DOES NOT USE THE LAST X'10' BYTES
*            OF THE GETMAINED AREA YOU WILL FIND THE TRAILER. BUT
*            IF HE ZEROS OR USES THE LAST X'10' BYTES OF THE
*            GETMAINED AREA, THE TRAILER WILL BE MISSING.
*
* OUTPUT-
*
*    THE TRAILER CONSISTS OF THE FOLLOWING INFORMATION:
*
*        +0 X'FE' AS AN EYECATCHER (TESTED BY FREEMAIN HOOK)
*        +1 RETURN ADDRESS IF BRANCH REQUEST AND SVC ADDR.
*           IF SVC REQUEST
*        +4 FIRST FOUR BYTES OF JOBNAME/INITNAME OF REQUESTOR.
*        +8 LENGTH OF REQUEST (INCLUDING THE TRAILER)
*        +C EYE CATCHER 'EYE'
*
* NOTES-
*
*    1. ALTHOUGH THIS ZAP IS WRITTEN WITH SMP CONTROL STATEMENTS,
*       IT IS RECOMMENDED THAT THE CONTROL STATEMENTS BE REMOVED
*       AND THE ZAP BE APPLIED TO AN ALTERNATE NUCLEUS VIA
*       SUPERZAP. NOTE ALSO THAT THE NAME STATEMENTS SPECIFY
*       IEANUC01 WHICH YOU WILL HAVE TO CHANGE TO THE NAME OF THE
*       ALTERNATE NUCLEUS YOU HAVE BUILT.
*
*    2. THE LINES WITH THE ASTERISKS BEFORE THE COMMENTS MUST BE
*       MODIFIED IF THE TRAP IS RELOCATED IN THE PSA.
*
*
* CHANGE ACTIVITY-
*     80/03/20 TESTED
*     80/04/10 MODIFIED TO SUPPORT REQUESTS OF EXACTLY X'1000'
*              BYTES AS SUCH REQUESTS MUST BE RETURNED STARTING
*              ON EXACTLY A PAGE BOUNDARY.
*     80/07/17 MODIFIED TO SUPPORT IMS GETMAINS OF PAGE MULTIPLES.
*              IMS EXPECTS TO GET STORAGE ON A PAGE BOUNDARY IF
*              THE REQUEST IS A EVEN PAGE MULTIPLE.
*     80/09/01 TOTALLY REWRITTEN ZAP TO CLEANUP THE LOGIC FLOW.
*              ALSO ADDED ABOVE NOTE AND FIXED SOME OF THE SMP
*              STATEMENTS.
*     81/05/13 ADDED SUPPORT FOR UZ31872, UZ34680, AND UZ36943
*              LEVELS.
*     81/05/27 ADDED SUPPORT FOR SP 2 PTF'S UZ34679 AND UZ35390.
*              DUE TO THE CHANGES IN THE LDA MAPPING THE SP 2
*              SUPPORT RESULTS IN TWO DIFFERENT VERSIONS OF THIS
*              ZAP. ALSO ADDED SUPPORT FOR UZ35461.
*     81/11/06 ADD SUPPORT FOR SP 3. THE SAME COMMENTS ABOVE ARE
*              VALID FOR SP3.
*     82/01/14 ADD SUPPORT FOR SP 2 PTF'S UZ35460 AND UZ36944.
*     82/04/23 ADD SUPPORT FOR BASE 3.8 PTF'S UZ54253 AND UZ59767.
*              ADD SUPPORT FOR SP 2 PTF UZ54254.
*              ADD SUPPORT FOR SP 3 PTF'S UZ55983 AND UZ56392.
*              FIXED PROBLEM IN ENTRY 1 WHEN REQUESTS ARE FOR SQA
*              AND EVEN PAGE. ALSO FIXED PROBLEM IN ENTRY 1 WHEN
*              REQUEST IS PAGE MULTIPLE AND NOT SQA REQUEST NOT TO
*              ADD X'10' TO THE LENGTH.
*    82/10/18  ADDED SUPPORT FOR PTF UZ55982
*    82/05/10  DELETE "END" EYE CATCHER AT LOC.'800'
*
* *****************************************************************
* */.
++ZAP(IEAVGM00)          /* PRE JBB1326                      */ .
* ************************
* HOOKS IN IEAVGM00      *
* ************************
NAME IEANUC01 IEAVGM00           (PRE JBB1326)
VER 09FE 9140,4011            AQE REQUEST?  (AFTER LABEL CRNDLNTH)
VER 0A02 0789                 NO RETURN
VER 0A08 4770,8450            BRANCH IF NOT 4K REQUEST
VER 0D1C 91C0,423A            LIST REQUESTED?  (AT LABEL GCOMM3)
VER 0F9C 4590,8434            GO TO ROUND ROUTINE  (AFTER INLSQA)
REP 09FE 9141,4011            AQE AND SQA REQUEST?
REP 0A08 47F0,06CC          * BRANCH TO ENTRY POINT ONE
REP 0D1C 47F0,070A          * BRANCH TO ENTRY POINT TWO
REP 0F9C 4590,0784          * LINK TO ENTRY POINT THREE
++ZAP(IEAVGM00)          /* PRE UZ55983                      */ .
* ************************
* HOOKS IN IEAVGM00      *
* ************************
NAME IEANUC01 IEAVGM00           (PRE UZ55983)
VER 0A2E 9140,4011            AQE REQUEST?
VER 0A32 0789                 NO RETURN
VER 0A38 4770,8450            BRANCH IF NOT 4K REQUEST
VER 0D4C 91C0,423A            LIST REQUESTED?
VER 0FCC 4590,8434            GO TO ROUND ROUTINE
REP 0A2E 9141,4011            AQE AND SQA REQUEST?
REP 0A38 47F0,06CC          * BRANCH TO ENTRY POINT ONE
REP 0D4C 47F0,070A          * BRANCH TO ENTRY POINT TWO
REP 0FCC 4590,0784          * LINK TO ENTRY POINT THREE
++ZAP(IEAVGM00)          /* PRE UZ56392                      */ .
* ************************
* HOOKS IN IEAVGM00      *
* ************************
NAME IEANUC01 IEAVGM00           (PRE UZ56392)
VER 0A36 9140,4011            AQE REQUEST?
VER 0A3A 0789                 NO RETURN
VER 0A40 4770,8450            BRANCH IF NOT 4K REQUEST
VER 0D54 91C0,423A            LIST REQUESTED?
VER 0FD4 4590,8434            GO TO ROUND ROUTINE
REP 0A36 9141,4011            AQE AND SQA REQUEST?
REP 0A40 47F0,06CC          * BRANCH TO ENTRY POINT ONE
REP 0D54 47F0,070A          * BRANCH TO ENTRY POINT TWO
REP 0FD4 4590,0784          * LINK TO ENTRY POINT THREE
++ZAP(IEAASU00).
* **************************
* ZAP TO IEAVFX00          *
* **************************
NAME IEANUC01 IEAVFX00
REP 06C8 C2C7D540             START OF ZAP (BGN)
*
* ENTRY 1    (IN CRNDLNTH ROUTINE)
*
*     THIS ENTRY IS IN THE GETMAIN PATH AND INCREASES THE SIZE OF
*     A REQUEST FOR SQA BY X'10' BYTES.
*
*     NOTE: ON ENTRY THE CONDITION CODE IS SET BY A TEST TO SEE IF
*           THE LENGTH OF A REQUEST IS EXACTLY 4096 BYTES.
*
REP 06CC 4770,06DA          * NOT A PAGE - GO TO NOTAPAGE
REP 06D0 9140,4011            AQE REQUEST?
REP 06D4 4710,844C            YES, RETURN AND PROCESS...
*                             4K AQE NEEDED REQ.
REP 06D8 07F9                 NO, RETURN TO CALLER OF CRNDLNTH
REP 06DA 5860,07E8          * GET MASK TO AND OFF LOW TWELVE BITS
REP 06DE 146A                 TURN OFF LOWER BYTE AND HALF OF NEXT
REP 06E0 156A                 WAS THE REQUEST A PAGE MULTIPLE?
REP 06E2 4770,06F0          * NO, GO GET TRAILER
REP 06E6 9140,4011            IS AN AQE NEEDED?
REP 06EA 4710,8450            YES, PROCESS AQE NEEDED REQUEST
REP 06EE 07F9                 NO, RETURN TO CALLER OF CRNDLNTH
REP 06F0 9140,4011            IS AN AQE NEEDED?
REP 06F4 47E0,0704          * NO, JUST ADD LENGTH FOR TRAILER
REP 06F8 9101,4011            SQA REQUEST?
REP 06FC 47E0,8450          * NO, PROCESS AQE NEEDED REQUEST
REP 0700 41A0,A008            ADD LENGTH FOR AQE
REP 0704 41A0,A010            ADD LENGTH FOR TRAILER
REP 0708 07F9                 RETURN TO CALLER OF CRNDLNTH
*
* ENTRY 2
*
*     THIS ENTRY BUILDS THE TRAILER IF THE REQUEST WAS A GETMAIN
*     FOR SQA AND AN AREA WAS ALLOCATED. THE SPACE FOR THE TRAILER
*     WAS SETUP BY ENTRY 1.
*
*     NOTE: IF THE AREA REQUESTED WAS AN EVEN PAGE MULTIPLE, THE
*           TRAILER IS BUILT INSIDE THE ALLOCATED STORAGE RETURNED
*           TO THE USER.
*
REP 070A 9101,4011            SQA REQUEST?
REP 070E 4770,071A          * YES, GO TEST FOR TRAILER
REP 0712 91C0,423A            RESTORE OVERLAID INSTRUCTION
REP 0716 47F0,8760            RETURN TO IEAVGM00
REP 071A 12E2                 WAS ANY STORAGE ALLOCATED?
REP 071C 4780,0712          * NO, RETURN
REP 0720 1EEA                 ADD LENGTH TO START ADDRESS
REP 0722 41F0,0010            GET TRAILER SIZE
REP 0726 1FEF                 SUBTRACT FROM END ADDRESS
REP 0728 92FE,E000            MOVE IN EYE CATCHER
REP 072C D203,E00C,07EC     * MOVE IN 'EYE' CATCHER
REP 0732 58F0,0224            GET PSAAOLD
REP 0736 41F0,F0AC            INITIALIZE NAME POINTER
REP 073A 9500,F001            IS THERE A POINTER TO THE JOBNAME?
REP 073E 4770,0752          * YES THERE IS A JOBNAME, GO TO NAMEOK
REP 0742 41F0,F004            NO JOBNAME, POINT AT STC NAME
REP 0746 9500,F001            IS THERE A POINTER TO THE STC NAME?
REP 074A 4770,0752          * YES THERE IS A STC NAME, GO TO NAMEOK
REP 074E 41F0,07F4          * POINT AT UNKNOWN NAME PTR
REP 0752 58F0,F000            GET POINTER TO NAME
REP 0756 D203,E004,F000       MOVE 1ST FOUR CHARACTERS OF NAME
REP 075C 50A0,E008            SAVE LENGTH OF REQUEST
REP 0760 9101,4010            IS IT BRANCH ENTRY?
REP 0764 4710,077A          * YES, HANDLE BRANCHES
REP 0768 58F0,021C            GET TCBOLD POINTER
REP 076C 58F0,F000            GET RB ADDRESS
REP 0770 D202,E001,F015       COPY PSW ADDRESS FOR SVC
REP 0776 47F0,0712          * RETURN TO IEAVGM00
REP 077A D202,E001,4051       COPY RETURN ADDRESS
REP 0780 47F0,0712          * RETURN TO IEAVGM00
*
* ENTRY 3
*
*      THIS IS THE FREEMAIN PATH. THE TRAILER IS ZEROED IF IT
*      CAN BE IDENTIFIED. IF THE LENGTH IS INCORRECT ONLY THE
*      EYE CATCHER IS ZEROED.
*
REP 0784 4160,0007            GET 7 FOR ROUNDING
REP 0788 1AA6                 ADD 7 TO THE LENGTH
REP 078A 16A6                 OR TO TURN ON LOW THREE BITS
REP 078C 17A6                 X/OR TO ROUND LENGTH TO DOUBLEWORD
REP 078E 9101,4011            SQA REQUEST?
REP 0792 4780,07CC          * NO, BYPASS TRAILER CHECKS
REP 0796 186B                 GET START OF AREA
REP 0798 1E6A                 ADD LENGTH TO GET END OF AREA
REP 079A B106,0000            IS THE SEGMENT/PAGE VALID?
REP 079E 4770,07CC          * NO, DO NOT PROCESS TRAILER
REP 07A2 95FE,6000            IS THIS MY TRAILER ID?
REP 07A6 4770,07CC          * NO, DO NOT PROCESS TRAILER
REP 07AA D503,600C,07EC     * IS THIS MY TRAILER?
REP 07B0 4770,07CC          * NO, DO NOT PROCESS TRAILER
REP 07B4 41A0,A010            ADD TRAILER SIZE TO LENGTH
REP 07B8 59A0,6008            DOES LENGTH AGREE WITH TRAILER?
REP 07BC 4770,07C6          * NO, GO CLEAR ONLY 'EYE' CATCHER
REP 07C0 D70F,6000,6000       CLEAR OUT TRAILER
REP 07C6 D703,600C,600C       CLEAR ONLY 'EYE' CATCHER
REP 07CC 4160,0007            RESTORE REG 6 FOR RETURN
REP 07D0 9140,4011            AQE REQUEST?
REP 07D4 0789                 NO, RETURN TO IEAVGM00
REP 07D6 59A0,07F0          * LENGTH FOR 4K?
REP 07DA 4770,07E2          * NO, BYPASS SETTING FLAG
REP 07DE 9680,4011            SET FLAG FOR 4K REQUEST
REP 07E2 41A0,A008            ADD SIZE OF AQE
REP 07E6 07F9                 RETURN TO IEAVGM00
*
* DATA AREAS
*
REP 07E8 FFFFF000
REP 07EC C5E8C540
REP 07F0 00001000
REP 07F4 000007F8             POINTER TO UNKNOWN NAME
REP 07F8 E4D5D2D5D6E6D540     'UNKNOWN' JOB NAME
*     E  N  D        O   F         Z  A  P

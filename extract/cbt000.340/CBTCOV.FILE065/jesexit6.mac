***********************************************************************
* THIS MEMBER CONTAINS THE SOURCE CODE FOR A JES2 EXIT #6 THAT        *
* CONTROLS THE TYPE (3420 OR 3480) OF TAPE DRIVE WHICH WILL BE        *
* ALLOCATED TO "UNIT=TAPE" REQUESTS BASED UPON THE RETENTION CRITERIA *
* OF OUTPUT FILES OR THE VOLUME SERIAL NUMBERS OF INPUT FILES.        *
*                                                                     *
* ASSUMPTIONS INCLUDE: 1. UNIT ESOTERIC NAMES OF "TAPE", "3420", AND  *
*                         "3480" EXIST IN THE SYSTEM (THE 'DYNAMASK'  *
*                         PROGRAM, AVAILABLE ELSEWHERE ON THIS TAPE,  *
*                         MAKES THIS EASY)                            *
*                      2. 3420 TAPE REELS ARE NUMBERED 000000-009999, *
*                         AND 3480 CARTRIDGES ARE NUMBERED 010000 -   *
*                         999999                                      *
*                      3. THE INSTALLATION WISHES TO FORCE LONG TAPE  *
*                         RETENTIONS (> 1 YEAR) ONTO 3420 REELS, AND  *
*                         SHORT RETENTIONS (< 1 YEAR) ONTO 3480 TAPE  *
*                         CARTRIDGES.                                 *
*                                                                     *
* ANY OR ALL OF THESE ASSUMPTIONS MAY BE RELAXED BY MODIFYING THIS    *
* EXIT.                                                               *
***********************************************************************
***********************************************************************
* THE FOLLOWING $JCT MACRO WAS COPIED FROM 'SYS1.HASPSRC' & MODIFIED  *
* AS INDICATED TO CORRECT SYNTAX ERRORS WITHIN THE DISTRIBUTED SOURCE *
* CODE. FUTURE ASSEMBLIES OF THIS EXIT SHOULD USE THE PRODUCTION MACRO*
* INSTEAD, WHICH WILL PRESUMABLY BE FIXED BY THEN.                    *
*                                                                     *
* SCOTT WILSON, JULY 15, 1987                                         *
***********************************************************************
         MACRO -- $JCT -- HASP JOB CONTROL TABLE DSECT
         $JCT  ,                                                   @133
.*
.*             5740-XC6 CONTAINS RESTRICTED MATERIALS OF IBM.
.*             (C) COPYRIGHT IBM CORPORATION 1980,1985
.*             LICENSED MATERIALS - PROPERTY OF IBM.
.*             REFER TO COPYRIGHT INSTRUCTIONS FORM G120-2083
.*
JCT      DSECT                     JOB CONTROL TABLE DSECT
.*       DS    (BUFSTART-BFPDSECT)X     BUFFER CONTROL INFORMATION @136
         DS    XL(BUFSTART-BFPDSECT)    STW 3/87 THIS & PREVIOUS LINE
JCTSTART EQU   *                   START OF DATA WRITTEN TO SPOOL
JCTID    DS    CL4'JCT'            JCT IDENTIFIER
JCTLENG  DS    AL2(*-*)            LENGTH OF JCT INCLUDING PREFIX
JCTFLAG1 DS    B                   FLAGS 1 ---
JCT1CKPT EQU   X'80'               REWRITE THIS JCT
JCTBURST EQU   X'40'               JOB OUTPUT BURST OPTION
JCT1INTJ EQU   X'20'               INTERNALLY CREATED JOB  (NO SJB) N30
JCT1LDR  EQU   X'10'               JOB CREATED BY LOADER DEV.  @OZ75074
JCTJTFLG DS    BL1                 JOB TERM FLAGS (SSJTFLG1)   @OZ81051
JCTJBKEY DS    XL4                 JOB IDENTIFIER KEY
JCTJDVT  DS    CL8                 JDVT NAME                       @133
JCTTRAK  DS    XL4                 TRACK ADDRESS OF THIS JCT       @136
JCTSPIOT DS    XL4                 TRACK ADDRESS OF 1ST SPIN IOT   @136
JCTIOT   DS    XL4                 TRACK ADDRESS OF 1ST REGULAR IOT
JCTOCTTR DS    XL4                 TRACK ADDRESS OF OCR TABLE
JCTXTRK  DS    XL4                 TRACK ADDRESS OF 1ST XMIT TRACK SPR2
JCTXBUFO DS    XL4                 BUFFER OFFSET IN 1ST XMIT TRACK SPR2
JCTSAMSK DS    XL(($MAXDA+31)/32*4)  SPOOLS ALLOWED MASK           @136
JCTPDDBK DS    H                   PERIPHERAL DATA SET KEY
JCTPDDBO DS    H                   DATA SET KEY FOR 1ST OUTPUT PDDB
JCTCNVRC DS    F                   RETURN CODE FROM JCL CONVERTER
         SPACE 1                                                   SPR2
JCTUSER0 DS    F                   RESERVED FOR USER               SPR2
JCTUSER1 DS    F                   RESERVED FOR USER               SPR2
JCTUSER2 DS    F                   RESERVED FOR USER               SPR2
JCTUSER3 DS    F                   RESERVED FOR USER               SPR2
JCTUSER4 DS    F                   RESERVED FOR USER               SPR2
JCTUSER5 DS    F                   RESERVED FOR USER               SPR2
JCTUSER6 DS    F                   RESERVED FOR USER               SPR2
JCTUSER7 DS    F                   RESERVED FOR USER               SPR2
JCTUSER8 DS    F                   RESERVED FOR USER               SPR2
JCTUSER9 DS    F                   RESERVED FOR USER               SPR2
JCTUSERA DS    F                   RESERVED FOR USER               SPR2
JCTUSERB DS    F                   RESERVED FOR USER               SPR2
JCTUSERC DS    F                   RESERVED FOR USER               SPR2
JCTUSERD DS    F                   RESERVED FOR USER               SPR2
JCTUSERE DS    F                   RESERVED FOR USER               SPR2
JCTUSERF DS    F                   RESERVED FOR USER               SPR2
         EJECT                                                 @OZ81051
JCTPRTY  DS    CL2                 /*PRIORITY OR JOB CARD 'PRTY='
JCTJSSTP DS    H                   JOB SELECT RESTART STEP (SSRQSTEP)
JCTFLAG2 DS    BL1                 FLAG BYTE                   @OZ81051
JCT2NCNV EQU   B'10000000'          JOB IS NOT TO BE CONVERTED @OZ81051
JCT2AVDP EQU   B'01000000'          DO NOT DO AUTH VERIFICATION IN JOB C
                                     INITIATION, ALREADY DONE, JOB     C
                                     PASSED VERIFICATION CHECK @OZ81051
JCT2AVF  EQU   B'00100000'          JOB FAILED AUTH VERIFICATION IN    C
                                     CALL FROM JES2            @OZ81051
JCT2AVD  EQU   B'00010000'          AUTH VERIFICATION DONE     @OZ81051
JCT2NMSG EQU   B'00001000'          JCT CONTAINS NOTIFY MSG TEXTS FROM C
                                     CNVT PHASE AFTER NJE HDR/TRLR,    C
                                     AL2(LEN),C'TEXT',...,H'0' @OZ81051
JCT2NMJL EQU   B'00000100'          MSG TEXTS ARE IN JOB LOG   @OZ81051
JCT2RPAI EQU   B'00000010'          AUTH INFORMATION IN NJH2USR/GRP    C
                                     SHOULD BE PROPAGATED      @OZ81051
JCT2JCLH EQU   B'00000001'         JCLHOLD, USED ONLY BETWEEN CNVT     C
                                    PROCESSOR/SUBTASK, THE JQE FLAG IS C
                                    ALWAYS CORRECT (QUE4JCLH)  @OZ81051
JCTNEXTQ DS    XL1                 NEXT QUEUE TO PLACE JOB ON AFTER    C
                                    IEFCMAUT CALL IN CNVT PROC @OZ81051
JCTJSFLG DS    B                   JOB SELECT FLAGS (SSRQFLG1)
JCTSMFLG DS    BL1                 SMF FLAGS
         SPACE 4                                                   @136
JCTPURGE DS    0X                  START OF SMF PURGE RECORD
         SPACE 1
* KEEP THE FIELDS JCTJOBFL AND JCTJBOPT TOGETHER FOR SMF
         SPACE 1
JCTJOBFL DS    BL1                 HASP JOB FLAGS
JCTJBOPT DS    BL1                 HASP JOB OPTIONS
         EJECT                                                     @136
* KEEP NEXT 38 BYTES INTACT FOR SMF - JCTJOBID THROUGH JCTOPRIO    SPR2
         SPACE 1
         DS    0F                                                  SPR2
JCTJOBID DS    CL8                 HASP ASSIGNED JOB IDENTIFICATION
JCTJNAME DS    CL8                 JOB NAME FROM JOB CARD
JCTPNAME DS    CL20                PROGRAMMER'S NAME FROM JOB CARD
JCTMCLAS DS    C                   MSGCLASS FROM JOB CARD
JCTJCLAS DS    C                   HASP EXECUTION JOB CLASS    @OZ74892
JCTIPRIO DS    X                   HASP INITIAL JOB SELECTION PRIORITY
JCTPRIO  DS    X                   HASP EXECUTION SELECTION PRIORITY
JCTIOPRI DS    X                   HASP INITIAL OUTPUT SELECTION PRIO
JCTOPRIO DS    X                   HASP OUTPUT SELECTION PRIORITY
         DS    XL2                 RESERVED FOR FUTURE USE         SPR2
         SPACE 1                                                   SPR2
JCTROUTE DS    0F                  INPUT ROUTE CODE                SPR2
JCTRNODE DS    H                    NODE NUMBER                    SPR2
JCTRRMT  DS    H                    REMOTE NUMBER                  SPR2
         SPACE 1                                                   SPR2
* KEEP NEXT 36 BYTES INTACT FOR SMF - JCTINDEV THROUGH JCTLINCT
         SPACE 1
JCTINDEV DS    CL8                 HASP INPUT DEVICE NAME
JCTACCTN DS    CL4                 JOB ACCOUNTING NUMBER FROM JOB CARD
JCTROOMN DS    CL4                 PROGRAMMER'S ROOM NUMBER
JCTETIME DS    F                   ESTIMATED EXECUTION TIME
JCTESTLN DS    F                   ESTIMATED OUTPUT LINES
JCTESTPU DS    F                   ESTIMATED PUNCHED OUTPUT
JCTFORMS DS    CL8                 JOB OUTPUT FORMS                @133
         DS    X                   RESERVED
JCTCPYCT DS    X                   JOB PRINT COPY COUNT
         DS    X                   RESERVED
JCTLINCT DS    X                   LINES PER PAGE
         SPACE 1
JCTESTPG DS    F                   ESTIMATED PAGE OUTPUT           @133
JCTESTBY DS    F                   ESTIMATED BYTE OUTPUT           @133
         SPACE 1                                                   SPR2
JCTPROUT DS    0F                  JOB PRINT ROUTE CODE            SPR2
JCTPRNOD DS    H                    NODE NUMBER                    SPR2
JCTPRRMT DS    H                    REMOTE NUMBER                  SPR2
         SPACE 1                                                   SPR2
JCTPUOUT DS    0F                  JOB PUNCH ROUTE CODE            SPR2
JCTPUNOD DS    H                    NODE NUMBER                    SPR2
JCTPURMT DS    H                    REMOTE NUMBER                  SPR2
         SPACE 1                                                   SPR2
JCTPROCN DS    CL8                 PROCEDURE DDNAME
JCTPASS  DS    CL8                 CURRENT PASSWORD
JCTNUPAS DS    CL8                 NEW PASSWORD
         EJECT                                                     @133
* KEEP NEXT 48 BYTES INTACT FOR SMF - JCTCNVON THROUGH JCTODTOF
         SPACE 1
JCTCNVON DS    F                   TIME ON  JCL CONVERSION PROCESSOR
JCTCDTON DS    F                   DATE ON  JCL CONVERSION PROCESSOR
JCTCNVOF DS    F                   TIME OFF JCL CONVERSION PROCESSOR
JCTCDTOF DS    F                   DATE OFF JCL CONVERSION PROCESSOR
JCTXEQON DS    F                   TIME ON  EXECUTION      PROCESSOR
JCTXDTON DS    F                   DATE ON  EXECUTION      PROCESSOR
JCTXEQOF DS    F                   TIME OFF EXECUTION      PROCESSOR
JCTXDTOF DS    F                   DATE OFF EXECUTION      PROCESSOR
JCTOUTON DS    F                   TIME ON  OUTPUT         PROCESSOR
JCTODTON DS    F                   DATE ON  OUTPUT         PROCESSOR
JCTOUTOF DS    F                   TIME OFF OUTPUT         PROCESSOR
JCTODTOF DS    F                   DATE OFF OUTPUT         PROCESSOR
         SPACE 1
* KEEP NEXT 28 BYTES INTACT FOR SMF - JCTCARDS THROUGH JCTOTSID
         SPACE 1
JCTCARDS DS    F                   TOTAL NUMBER OF INPUT CARDS
JCTLINES DS    F                   GENERATED OUTPUT LINES
JCTPUNCH DS    F                   GENERATED PUNCHED OUTPUT
JCTRDSID DS    CL4                 INPUT PROCESSOR SYSTEM ID
JCTCVSID DS    CL4                 CONVERSION PROCESSOR SYSTEM ID
JCTEXSID DS    CL4                 EXECUTION PROCESSOR SYSTEM ID
JCTOTSID DS    CL4                 OUTPUT PROCESSOR SYSTEM ID
         SPACE 1                                                   @133
JCTPAGES DS    F                   GENERATED OUTPUT PAGES          @133
JCTBYTES DS    F                   GENERATED OUTPUT BYTES          @133
         SPACE 2                                                   SPR2
JCTXEQND DS    H                   INITIAL EXECUTION NODE          SPR2
JCTXNODE DS    H                   ACTUAL EXECUTION NODE           SPR2
         SPACE 1                                                   SPR2
* KEEP NEXT 76 BYTES INTACT FOR SMF - JCTNJSID THROUGH JCTNLNDE    SPR2
         SPACE 1                                                   SPR2
JCTNJSID DS    CL4                 JOB XMITTER PROCESSOR SYSTEM ID SPR2
JCTNJTON DS    F                   TIME ON JOB TRANSMITTER PROCESSOR
JCTNDTON DS    F                   DATE ON JOB TRANSMITTER PROCESSOR
JCTNJTOF DS    F                   TIME OFF JOB TRANSMITTER PROCESSOR
JCTNDTOF DS    F                   DATE OFF JOB TRANSMITTER PROCESSOR
JCTNACCT DS    CL8                 NETWORK ACCOUNTING NUMBER       SPR2
JCTNOJID DS    CL8                 ORIGINAL JOB IDENTIFICATION     SPR2
JCTNNDEV DS    CL8                 JOB TRANSMITTER DEVICE NAME     SPR2
JCTNONDE DS    CL8                 NETWORK ORIGINAL NODE NAME      SPR2
JCTNXNDE DS    CL8                 NETWORK EXECUTION NODE NAME     SPR2
JCTNNNDE DS    CL8                 NETWORK NEXT NODE NAME          SPR2
         EJECT                                                     SPR2
JCTNLNDE DS    CL8                 NETWORK LAST NODE NAME          SPR2
JCTESOUT DS    F                   ESTIMATED OUTPUT (LINES+CARDS)
JCTXOUT  DS    F                   GENERATED OUTPUT RECORDS
JCTTSUID DS    CL7                 TIME SHARING USERID FOR NOTIFY
JCTTSUAF DS    BL1                 INPUT SYSAF FOR NOTIFY
JCTPSN1  DS    CL8                 STEP NAME FROM EXEC STEP
JCTPSN2  DS    CL8                 STEP NAME OF CALLING STEP
JCTWORK  DS    XL144               144-BYTE WORK AREA
JCTXWRK  DS    XL80                80-BYTE WORK AREA FOR RDR EXITS SPR2
JCTJMRST EQU   *                   START OF JMR AREA
         SPACE 1
* KEEP THE FIELDS JCTJMRJN, JCTRDRON, AND JCTRDTON TOGETHER FOR SMF
         SPACE 1
JCTJMRJN DS    CL8                 JMR JOB NAME
JCTRDRON DS    F                   TIME ON INPUT PROCESSOR
JCTRDTON DS    F                   DATE ON INPUT PROCESSOR
JCTCPUID DS    XL4                 JMR CPU IDENTIFICATION
JCTUSEID DS    CL8                 JMR USER IDENTIFICATION
JCTSTEP  DS    X                   CURRENT STEP NUMBER
JCTINDC  DS    BL1                 JMR SMF OPTIONS
JCTJTCC  DS    0XL2,X              CONDITION CODE
JCTCLASS DS    X                   HASP EXECUTION JOB CLASS    @OZ74892
JCTUCOM  DS    F                   JMR USER COMMUNICATION AREA
JCTUJVP  DS    F                   JMR ADDRESS OF USER EXIT ROUTINE
         SPACE 1
* KEEP THE FIELDS JCTRDROF AND JCTRDTOF TOGETHER FOR SMF
         SPACE 1
JCTRDROF DS    F                   TIME OFF INPUT PROCESSOR
JCTRDTOF DS    F                   DATE OFF INPUT PROCESSOR
JCTJOBIN DS    F                   JMR JOB SYSIN COUNT
JCTRDR   DS    XL2                 READER DEVICE TYPE AND CLASS
JCTJMOPT DS    BL1                 JMR SMF OPTIONS
         DS    X                   RESERVED
JCTJMRND DS    0F                  END OF JMR
JCTJMR   EQU   JCTJMRST,*-JCTJMRST REFERENCE FOR ENTIRE JMR AREA
         SPACE 2                                                   @136
JCTXMASK DS    XL32                EXIT JOB MASK                   SPR2
JCTJQE   DS    F                   OFFSET OF HASP JOB QUEUE ENTRY  @136
         DS    4F                  RESERVED FOR FUTURE USE         @136
JCTEND   EQU   *                   END OF JOB CONTROL TABLE
         SPACE 1                                                   SPR2
*        NJE JOB HEADER AND TRAILER FOLLOW JCT --                  SPR2
         SPACE 1                                                   SPR2
JCTNJHDR DS    0F                  START OF NJE JOB HEADER         SPR2
JCTNJHLN DS    0H                  LENGTH OF HEADER = DISPL TO TRAILER
         EJECT                                                     @133
         SPACE 3
*        JCTSMFLG  (CATSMFLG)                                      @136
         SPACE 1
JCTSMFL0 EQU   B'10000000'         RESERVED
JCTSMFL1 EQU   B'01000000'         RESERVED
JCTNOUSO EQU   B'00100000'         DO NOT TAKE IEFUSO SMF EXIT
JCTSMFL3 EQU   B'00010000'         RESERVED
JCTSMFL4 EQU   B'00001000'         RESERVED
JCTNOTY6 EQU   B'00000100'         DO NOT PRODUCE TYPE 6 SMF RECORD
JCTNOUJP EQU   B'00000010'         DO NOT TAKE IEFUJP SMF EXIT
JCTNOT26 EQU   B'00000001'         DO NOT PRODUCE TYPE 26 SMF RECORD
         SPACE 3
*        JCTJOBFL  (CATJOBFL)                                      @136
         SPACE 1
JCTBATCH EQU   B'10000000'         BACKGROUND BATCH JOB
JCTTSUJB EQU   B'01000000'         FOREGROUND TIME SHARING USER
JCTSTCJB EQU   B'00100000'         SYSTEM TASK
JCTVALJB EQU   JCTBATCH+JCTTSUJB+JCTSTCJB  VALID CLASSES           @136
JCTNOJNL EQU   B'00010000'         NO JOURNAL OPTION
JCTNOUPT EQU   B'00001000'         NO OUTPUT OPTION
JCTTSCAN EQU   B'00000100'         TYPRUN=SCAN WAS SPECIFIED
JCTTCOPY EQU   B'00000010'         TYPRUN=COPY WAS SPECIFIED
JCTRSTRT EQU   B'00000001'         ALLOW WARM START RE-QUEUE TO XEQ
         SPACE 3
*        JCTJBOPT  (CATJBOPT)                                      @136
         SPACE 1
JCTPRICD EQU   B'10000000'         /*PRIORITY CARD OR JOB CARD         C
                                     'PRTY=' PRESENT (NOT USED IN      C
                                     CATJBOPT FIELD)               @136
JCTSETUP EQU   B'01000000'         /*SETUP CARD(S) PRESENT (NOT USED   C
                                    IN CATJBOPT FIELD)             @136
JCTTHOLD EQU   B'00100000'         TYPRUN=HOLD                     @136
JCTNOLOG EQU   B'00010000'         NO JOB LOG OPTION
JCTXBACH EQU   B'00001000'         EXECUTION BATCHING JOB
JCTINRDR EQU   B'00000100'         JOB WAS ENTERED ON INTRDR (NOT      C
                                    USED IN CATJBOPT FIELD)        @136
JCTRERUN EQU   B'00000010'         JOB WAS RE-RUN (NOT USED IN         C
                                    CATJBOPT FIELD)                @136
JCTQHELD EQU   B'00000001'         NOT USED IN JCTJBOPT, INDICATES     C
                                    CLASS QUEUE IS HLD IN CATJBOPT @136
         EJECT
         SPACE 3
*        JCTCNVRC                                                  SPR2
         SPACE 3
JCTCOK   EQU   0                   JCL CONVERTED WITHOUT ERROR
JCTCJCL  EQU   4                   JCL ERROR DETECTED BY CONVERTER
JCTCIO   EQU   8                   I/O ERROR DETECTED BY CONVERTER
JCTCDUPL EQU   JCTCJCL             DUPLICATE LOGON EXECUTING
JCTCABND EQU   36                  UNRECOVERABLE ERROR IN CONVERSION
JCTGMFAL EQU   56                  CONVERTER GETMAIN FAILED      @134AY
         SPACE 5
*        JCTJMOPT                                                  SPR2
         SPACE 3
JCTJMRUX EQU   B'00100000'         IF ON, TAKE USER EXITS FOR SMF
         MEND
EXIT006  TITLE 'JES2 EXIT #6: TAPE UNIT SELECTION BASED UPON RETENTION'
***********************************************************************
* THE PURPOSE OF THIS EXIT IS TO FORCE LONG RETENTION TAPE DATASETS   *
* ONTO 9-TRACK REELS AS OPPOSED TO 3480 TAPE CARTRIDGES. THIS IS DONE *
* TO (1) PRESERVE THE HIGH-PERFORMANCE TAPE CARTRIDGES FOR FREQUENTLY *
* USED DATA, AND (2) TO USE THE LEAST-COST STORAGE MEDIUM FOR LONG    *
* TERM ARCHIVALS.                                                     *
*                                                                     *
* AT THIS POINT, LONG RETENTION DATASETS ARE DEFINED AS THOSE HAVING  *
* EITHER (A) RETENTION PERIODS GREATER THAN 365 DAYS (1 YEAR), OR (B) *
* EXPIRATION DATES FARTHER THAN ONE YEAR IN THE FUTURE.               *
*                                                                     *
* THIS JES2 EXIT NUMBER 6 WAS ORIGINALLY WRITTEN BY SCOTT WILSON AT   *
* THE CITY OF LONG BEACH ON MARCH  9, 1987 FOR JES2 SP2.1.5 (HJE2215) *
* USING THE SAMPLE JES2 EXIT #6 IN IBM PUBLICATION H3832-SN-00, PAGES *
* X6-1 THROUGH X6-18 AS A MODEL.                                      *
***********************************************************************
         EJECT
***********************************************************************
* PROGRAM SPECIFICATIONS:                                             *
*                                                                     *
* ASIDE FROM THE INTERESTING THINGS THAT THE JES2 MACROS DO WITH THE  *
* REGISTERS, THE FOLLOWING ARE THE USES OF THE REGISTERS IN THIS EXIT *
* (DEPENDING ON WHEN YOU LOOK):                                       *
*                                                                     *
* R0  - STASHED INTO R4 SO MVS AND JES2 MACROS CAN USE R0             *
* R1  - STASHED INTO R3 SO MVS AND JES2 MACROS CAN USE R1             *
* R2  - FLAG REGISTER, MADE UP OF SIX FLAGS (TWO FULL BYTE FLAGS AND  *
*       FOUR HALF-BYTE FLAGS) EACH SIGNIFYING A CHARACTERISTIC OF THE *
*       DD CARD BEING PROCESSED. BYTES 1 AND 2 ARE COUNTERS OF 3420   *
*       AND 3480 VOLSERS RESPECTIVELY. THE HIGH HALF OF BYTE 3 IS AN  *
*       INDICATOR OF "EXPDT=99000' (1=YES, 0=NO), AND THE LOW HALF IS *
*       A "RETPD" INDICATOR (2= <365 DAYS, 1= >364 DAYS, 0=NOT FOUND).*
*       THE HIGH HALF OF BYTE 4 IS AN "EXPDT" INDICATOR (WITH THE     *
*       SAME VALUES AS THE "RETPD" INDICATOR), AND THE LOW HALF OF    *
*       BYTE 4 SIGNIFIES WHETHER "UNIT=TAPE" WAS SPECIFIED (1=YES,    *
*       0=NO).
*                                                                     *
*       A SUMMARY ILLUSTRATION OF THIS FOLLOWS:                       *
*                                                                     *
*                                 +---- EXPDT = 99000                 *
*                                 ×                                   *
*       3480 VOLSER* ------------+×+--- RETPD >= 365 DAYS             *
*                                ×××                                  *
*       3420 VOLSER* ----------+ ×××+-- EXPDT >= 1 YEAR FROM NOW      *
*                              × ××××                                 *
*                              × ××××+- UNIT=TAPE                     *
*                              × ×××××                                *
*                              V VVVVV                                *
*     REGISTER # 2 CONTAINS:  01011221                                *
*                                                                     *
* R3  - ADDRESS OF 4-WORD PARAMETER LIST (1ST WORD = 16-BYTE WORKAREA *
*                                                    ADDRESS          *
*                                         2ND WORD = ADDRESS OF LAST  *
*                                                    TEXT IMAGE       *
*                                                    PROCESSED (IF    *
*                                                    R0=0) OR         *
*                                                    CONVERTER RETURN *
*                                                    CODE (IF R0=4)   *
*                                         3RD WORD = ADDRESS OF DTE   *
*                                         4TH WORD = ADDRESS OF JCT   *
* R4  - STATUS  OF CONVERSION PROCESSING (0 = SINGLE STATEMENT;       *
*                                         4 = ENTIRE JOB)             *
* R5  - ADDRESS OF JCL TEXT IMAGE; BASE REGISTER FOR WORKAREA         *
* R6  - LENGTH OF JCL TEXT IMAGE                                      *
* R7  - JCL TEXT IMAGE POSITIONAL POINTER                             *
* R8  - NUMBER OF SUBPARAMETERS WITHIN AN INTERNAL TEXT PARAMETER     *
* R9  - LENGTH OF INTERNAL TEXT SUBPARAMETERS                         *
* R10 - ADDRESS OF UNIT PARAMETER WITHIN INTERNAL TEXT STRING         *
* R11 - ADDRESS OF HCT                                                *
* R12 - JES2 EXIT #6 BASE REGISTER                                    *
* R13 - ADDRESS OF 18-WORD OS SAVEAREA                                *
* R14 - RETURN ADDRESS                                                *
* R15 - ENTRY ADDRESS AND EXIT RETURN CODE; CVT BASE REGISTER         *
*                                                                     *
***********************************************************************
         EJECT
***********************************************************************
* THE LOGIC OF THIS EXIT IS AS FOLLOWS:                               *
*                                                                     *
* INTERNAL TEXT IMAGES ARE SCANNED ONCE DURING AN "EXTRACT" PHASE.    *
* DURING THIS PHASE, NON-"DD" CARDS ARE REJECTED, WHOLE-JOB           *
* CONVERSIONS ARE PROCESSED, AND THE PARAMETERS SPECIFIED FOR "UNIT=",*
* "EXPDT=", "VOL=SER=", AND/OR "RETPD=" ARE EXTRACTED AND STORED.     *
* WHEN THE SCAN HAS COMPLETED, THE STORED PARAMETERS ARE QUERIED FOR  *
* ELIGIBILITY FOR SUBSTITUTION (I.E. UNIT = TAPE AND EITHER RETPD >=  *
* 365 OR EXPDT >= 1 YEAR FROM CURRENT DATE), OR "UNIT=TAPE" AND       *
* "VOL=SER=" A VOLUME MASK OF 00XXXX (3420) OR 01XXXX (3480).  IF ONE *
* OF THESE CONDITIONS EXISTS, THEN THE "UNIT" PARAMETER IS            *
* REEVALUATED, AND A WTO IS ISSUED TO THE JOB LOG TO ACKNOWLEDGE      *
* THE CHANGE. THIS EXIT ENFORCES A DEFAULT TAPE TYPE OF 3480.         *
*                                                                     *
* WHEN PROCESSING INDIVIDUAL JCL STATEMENTS, THE EXIT CANNOT FORCE A  *
* JCL ERROR DIRECTLY. WHEN ONE IS DESIRED, AN INDICATOR FLAG IS SET IN*
* THE PROVIDED WORKAREA, AND IT IS READ AND INTERPRETED DURING WHOLE  *
* JOB PROCESSING, WHERE DIRECT JCL ERROR HANDLING IS AVAILABLE.       *
***********************************************************************
         EJECT
***********************************************************************
* JES2 REQUIRED HOUSEKEEPING MACROS                                   *
***********************************************************************
         COPY $HASPGBL            COPY HASP GLOBALS
JESEXIT6       $MODULE ENVIRON=SUBTASK,SYSP=(GEN,GEN,DATA,GEN,GEN),    +
               $PCE,                                                   +
               $JQE,                                                   +
               $HCT,                                                   +
               $MIT,                                                   +
               $HASPEQU,                                               +
               $CAT,                                                   +
               $JCT,                                                   +
               $SVT,                                                   +
               $TRP,                                                   +
               TEXT,                                                   +
               KEYS,                                                   +
               WPL
         EJECT
***********************************************************************
* MOST OF THE FIRST BLOCK OF CODE IS DONE IN OBSERVANCE OF THE        *
* STANDARD LINKAGE CONVENTIONS FOR JES2 SP2.1.5 EXITS. STARTING WITH  *
* THIS RELEASE, JES2 EXIT #6 MAY BE CALLED BY MULTIPLE CONVERSION     *
* SUBTASKS SIMULTANEOUSLY.                                            *
***********************************************************************
         USING TEXT,R5            SET ADDRESSABILITY TO INTERNAL TEXT
EXIT6   $ENTRY BASE=R12           EXIT ROUTINE ENTRY POINT
         STM   R14,R12,12(R13)    SAVE REGISTERS
         LR    R12,R15            SET LOCAL BASE REGISTER
         LR    R4,R0              SAVE EXIT REASON CODE
         LR    R3,R1              SAVE ADDRESS OF PARAMETER LIST
         GETMAIN R,LV=180,SP=229  ACQUIRE MAIN STORAGE
         ST    R13,4(R1)          SAVE CALLER'S SAVE AREA ADDRESS
         ST    R1,8(R13)          COMPLETE SAVE AREA CHAIN
         LR    R13,R1             POINT TO ACQUIRED SPACE SAVE AREA
         USING GETAREA,R13        SET ADDRESSABILITY TO GETMAINED STG.
***********************************************************************
* THE LIST FORMAT WTO MACRO IS MAPPED INTO A DSECT, SO IT IS          *
* NECESSARY TO INTIALIZE THE GETMAINED STORAGE TO MATCH THE DSECT MAP *
* PRIOR TO ISSUING THE EXECUTE FORMAT WTO. THIS SKELETON WTO INCLUDES *
* ALL ROUTING AND DESCRIPTOR CODES AS WELL AS THE MESSAGE TEXT ITSELF.*
***********************************************************************
         MVC   WTOMSG1(4),=XL4'00438080'
         MVC   WTOMSG1+4(63),=CL63'DDNAME:          - UNIT PARAMETER CH+
               ANGED FROM "TAPE" TO "    "'
         MVC   WTOMSG1+68(8),=XL8'02004000001A8080'
         MVC   WTOMSG2+4(22),=CL22'BECAUSE               '
         MVC   WTOMSG2+26(4),=XL4'02004000'
*
         L     R2,=XL4'00000000'  INITIALIZE R2 TO ALL ZEROES
         L     R10,=XL4'00000000' INITIALIZE R10 TO ALL ZEROES
         C     R4,=XL4'00000000'  SEE IF EXIT INVOKED FOR JCL STATEMENT
         BE    GETTEXT            IF SO, PROCESS THE CARD IMAGE
         L     R5,0(R3)           IF NOT, LOAD ADDRESS OF WORKAREA
         USING WORKAREA,R5        SET ADDRESSABILITY TO WORKAREA
         CLI   WORKAREA,X'08'     SEE IF A JCL ERROR WAS FLAGGED
         BNE   NOERROR            IF NOT, EXIT RETURN CODE = 0
         L     R5,4(R3)           IF NOT, LOAD ADDRESS OF WORKAREA
         USING EXITCODE,R5        SET ADDRESSABILITY TO WORKAREA
         MVC   RETCODE,=XL4'00000008' FLAG JCL ERROR FOR THIS JOB
         B     BACK2JES               END OF JOB PROCESSING
NOERROR  EQU   *
         L     R5,4(R3)           IF NOT, LOAD ADDRESS OF WORKAREA
         USING EXITCODE,R5        SET ADDRESSABILITY TO WORKAREA
         MVC   RETCODE,=XL4'00000000' FLAG JCL ERROR FOR THIS JOB
         B     BACK2JES               END OF JOB PROCESSING
         EJECT
***********************************************************************
* TEST FOR DD CARDS. PROCESS NO OTHERS.                               *
***********************************************************************
GETTEXT  L     R5,4(R3)           GET ADDRESS OF JCL TEXT IMAGE
         L     R6,=XL4'00000000'  RESET LENGTH REGISTER
         LH    R6,0(R5)           LOAD LENGTH OF JCL TEXT IMAGE
         AR    R6,R5              DETERMINE ADDRESS OF END OF TEXT
         LA    R7,2(R5)           SET POINTER REG. TO CARD-TYPE FLAG
DDTEST   CLI   0(R7),X'04'        TEST FOR DD CARD
         BNE   CHECKRC            LEAVE THIS EXIT IF NOT A "DD" CARD
         LA    R7,4(R7)           SET POINTER TO DDNAME LENGTH KEY
         L     R9,=XL4'00000000'  CLEAR REGISTER 9 PRIOR TO USE
         LH    R9,0(R7)           LOAD THE DDNAME LENGTH INTO R8
         SRL   R9,8               SHIFT RIGHT TO JUSTIFY NUMBER
         S     R9,=XL4'00000001'  SUBTRACT 1 FROM LENGTH OF DDNAME
         C     R9,=XL4'FFFFFFFF'  IS LENGTH OF DDNAME NEGATIVE 1?
         BZ    LOADZERO           IF SO, ZERO OUT DDNAME LENGTH
         LA    R7,1(R7)           SET POINTER TO START OF DDNAME
         EX    R9,MOVEDD          ALTER LENGTH OF DDNAME FOR MVC
         B     ADVANCE            DON'T EXECUTE MVC TWICE
MOVEDD   MVC   WTOMSG1+12(0),0(R7) MOVE DDNAME INTO WTO MESSAGE
LOADZERO L     R9,=XL4'00000000'  ZERO OUT DDNAME LENGTH
ADVANCE  AR    R7,R9              ADVANCE POINTER PAST DDNAME...
         A     R7,=XL4'00000001'  ...AND POINT TO NEXT KEY
         EJECT
*
***********************************************************************
* TEST FOR THE END OF THE INTERNAL TEXT IMAGE IN TWO WAYS; (1) BY THE *
* X'FE' END-OF-TEXT KEY, OR (2) BY COUNTING BEYOND THE INDICATED      *
* LENGTH OF THE TEXT IMAGE RECORD.                                    *
***********************************************************************
ENDTEST  EQU   *
         CLI   0(R7),X'FE'        IS THIS THE END OF TEXT INDICATOR?
         BE    PROCESS            IF SO, PROCESS EXTRACTED DATA
         CR    R7,R6              HAVE WE PASSED THE END OF TEXT?
         BP    PROCESS            IF SO, PROCESS EXTRACTED DATA
*
***********************************************************************
* TEST FOR THE PRESENCE OF A "SPACE" OPERAND, AND LEAVE EXIT IF YOU   *
* FIND ONE (IT'S NON-STANDARD A ND TOO HARD TOO PARSE. TAPES CAN'T    *
* HAVE SPACE PARAMETERS ANYWAY, SO JES2 WILL JCL ERROR THE JOB ANYWAY)*
***********************************************************************
SPCETEST CLI   0(R7),X'47'        IS THIS A "SPACE" PARAMETER?
         BE    CHECKRC            IF SO, LEAVE THIS EXIT
*
***********************************************************************
* TEST FOR THE PRESENCE OF A "VOL=REF" OPERAND, AND LEAVE EXIT IF YOU *
* FIND ONE (IT'S NOT NECESSARY TO SPECIFY A "UNIT", SINCE THE UNIT    *
* DEFAULTS TO WHEREEVER IT WAS ORIGINALLY MOUNTED).                   *
***********************************************************************
REFTEST  CLI   0(R7),X'50'        IS THIS A "VOL=REF" PARAMETER?
         BE    CHECKRC            IF SO, LEAVE THIS EXIT
*
***********************************************************************
* TEST FOR THE PRESENCE OF A "UNIT" OPERAND, AND PROCESS ACCORDINGLY  *
***********************************************************************
UNITTEST CLI   0(R7),X'41'        IS THIS A "UNIT" OPERAND?
         BE    GOTUNIT            IF SO, PROCESS "UNIT" OPERAND
*
***********************************************************************
* TEST FOR THE PRESENCE OF AN "EXPDT" OPERAND, & PROCESS ACCORDINGLY  *
***********************************************************************
EXPDTEST CLI   0(R7),X'51'        IS THIS A "EXPDT" OPERAND?
         BE    GOTEXPDT           IF SO, PROCESS "EXPDT" OPERAND
*
***********************************************************************
* TEST FOR THE PRESENCE OF A "RETPD" OPERAND, & PROCESS ACCORDINGLY   *
***********************************************************************
RETPDTST CLI   0(R7),X'52'        IS THIS A "RETPD" OPERAND?
         BE    GOTRETPD           IF SO, PROCESS "RETPD" OPERAND
*
***********************************************************************
* TEST FOR THE PRESENCE OF A "VOL=SER" OPERAND, & PROCESS ACCORDINGLY *
***********************************************************************
VOLTEST  CLI   0(R7),X'4F'        IS THIS A "VOL=SER=" OPERAND?
         BE    GOTVLSER           IF SO, PROCESS "VOL=SER" OPERAND
         EJECT
*
***********************************************************************
* CALCULATE THE POSITION OF THE NEXT KEY BY (1) ADVANCING POINTER TO  *
* THE NEXT BYTE OF THE TEXT IMAGE, WHICH SHOULD BE THE NUMBER OF      *
* OPERANDS THAT FOLLOW, AND STORE THIS IN R8; (2) ADVANCING POINTER   *
* TO THE NEXT BYTE OF THE TEXT IMAGE, WHICH SHOULD BE THE LENGTH OF   *
* THE FOLLOWING OPERANDS THAT FOLLOW, AND STORE THIS IN R9; (3)       *
* DETERMINE HOW FAR TO ADVANCE TO FIND THE NEXT KEY; (4) ADD THE      *
* ADVANCEMENT FACTOR TO THE POINTER REGISTER (R7); AND (5) RESUME     *
* TESTING KEYS.                                                       *
***********************************************************************
NEXTKEY  EQU   *
         L     R8,=XL4'00000000'  RESET NUMBER OF SUBPARAMETERS
         L     R9,=XL4'00000000'  RESET LENGTH OF SUBPARAMETERS
         LA    R7,1(R7)           POINT TO NUMBER OF SUBPARAMETERS
         LH    R8,0(R7)           LOAD NUMBER OF SUBPARAMETERS
         SLL   R8,16              SHIFT LEFT TO TRUNCATE JUNK
         SRL   R8,24              SHIFT RIGHT TO JUSTIFY NUMBER
         C     R8,=XL4'00000000'  CHECK FOR ZERO SUBPARAMETERS
         BZ    NOPARMS            CONTINUE TO NEXT KEY IF ZERO PARMS
BYPASS   LA    R7,1(R7)           ELSE POINT TO LENGTH OF SUBPARMS
CHKLNGTH CLI   0(R7),X'80'        IS LENGTH FIELD PREFIXED BY AN 8?
         BL    PRMLNGTH           BRANCH OUT IF NOT AT LEAST X'80'
         CLI   0(R7),X'8F'        BRANCH OUT IF AT LEAST X'80' BUT...
         BH    PRMLNGTH           ...NOT MORE THAN X'8F'
         LH    R8,0(R7)           LOAD SPECIAL # OF PARAMETERS
         SLL   R8,20              SHIFT LEFT TO ISOLATE # OF PARMS
         SRL   R8,28              SHIFT RIGHT TO JUSTIFY # OF PARMS
         B     BYPASS             REPROCESS IN THE USUAL WAY
PRMLNGTH LH    R9,0(R7)           LOAD LENGTH OF SUBPARAMETERS
         SLL   R9,16              SHIFT LEFT TO TRUNCATE JUNK
         SRL   R9,24              SHIFT RIGHT TO JUSTIFY NUMBER
         AR    R7,R9              POINT TO END OF SUBPARAMETER
         S     R8,=XL4'00000001'  DECREMENT SUBPARAMETER COUNTER
         C     R8,=XL4'00000000'  CHECK FOR END OF SUBPARAMETERS
         BP    BYPASS             PROCESS ANY REMAINING SUBPARAMETERS
NOPARMS  LA    R7,1(R7)           AND POINT TO NEXT KEY
         B     ENDTEST            RESUME SCAN
         EJECT
***********************************************************************
* SUBROUTINE TO PROCESS "UNIT" PARAMETERS. IF UNIT IS "TAPE"          *
* THEN THE EXPDT/RETPD TESTS WILL BE CONDUCTED. OTHERWISE, PROCESSING *
* WILL STOP FOR THIS "DD" CARD.                                       *
***********************************************************************
GOTUNIT  EQU   *
         CLC   3(4,R7),=CL4'TAPE' IS THIS A "UNIT=TAPE"?
         BNE   CHECKRC            IF NOT, FORGET THIS "DD" CARD
         A     R2,=XL4'00000001'  SET UNIT FLAG IN R2
         LR    R10,R7             "REMEMBER" UNIT PARAMETER ADDRESS...
         LA    R10,3(R10)         ...IN R10 FOR LATER MODIFICATION
         B     NEXTKEY            RETURN TO INTERNAL TEXT IMAGE SCAN
*
***********************************************************************
* THE SPECIFIED EXPDT PARAMETER IS TESTED FOR A "99000" VALUE, WHICH  *
* IS A SPECIAL UCC-1/TMS INDICATOR FOR TAPE RETENTIONS BASED UPON OS  *
* CATALOG STATUS. THESE ARE WEEDED OUT, AND ANY OTHERS ARE RANGE      *
* TESTED BY PACKING THE NUMERIC OPERAND INTO GETMAINED STORAGE, AND   *
* COMPARING WITH THE PACKED CURRENT DATE VALUE FROM THE CVT. BY THE   *
* VERY DEFINITION OF JULIAN FORMAT DATES, THE CURRENT DATE CAN SIMPLY *
* BE SUBTRACTED FROM THE EXPDT PARAMETER TO TEST FOR A DIFFERENCE OF  *
* AT LEAST P'1000', WHICH WOULD INDICATE A 1 YEAR OR MORE RETENTION.  *
* ANY REQUESTS MEETING THIS CRITERION ARE FLAGGED FOR FURTHER         *
* PROCESSING.                                                         *
***********************************************************************
GOTEXPDT EQU   *                  SET MESSAGE ID TO $HASP998
         CLC   3(5,R7),=CL5'99000'  IS THIS THE '99000' SPECIAL VALUE?
         BE    CATFLAG            IF SO, FORCE UNIT=3480
         LA    R15,X'10'          LOAD ADDRESS OF POINTER TO CVT
         L     R15,0(R15)         LOAD ADDRESS OF CVT
         USING CVTMAP,R15         SET ADDRESSABILITY TO CVT
         ZAP   PACKAREA,=PL4'0'   ZERO PACKED AREA OF GETMAINED STG.
         PACK  PACKAREA,3(5,R7)   PACK SUPPLIED EXPDT VALUE
         SP    PACKAREA,CVTDATE   SUBTRACT CURRENT DATE FROM EXPDT
         CP    PACKAREA,=PL4'1000'       IS THE DIFFERENCE 1 YEAR?
         BL    LILEXPDT           IF DIFFERENCE < 1 YEAR, DEFAULT=3480
BIGEXPDT A     R2,=XL4'00000010'  SET EXPDT FLAG IN R2
         B     NEXTKEY            RETURN TO INTERNAL TEXT IMAGE SCAN
LILEXPDT A     R2,=XL4'00000020'  SET EXPDT FLAG IN R2
         B     NEXTKEY            RETURN TO INTERNAL TEXT IMAGE SCAN
CATFLAG  EQU   *
         A     R2,=XL4'00001000'  SET EXPDT=99000 FLAG IN R2
         B     NEXTKEY            RETURN TO INTERNAL TEXT IMAGE SCAN
*
***********************************************************************
* TEST THE LENGTH OF ANY SPECIFIED "RETPD=" PARAMETER VALUES. IF THE  *
* LENGTH OF THE OPERATOR SPECIFIED IS > 3, THEN IT'S VALUE IS         *
* OBVIOUSLY > 365, AND THE FLAG IN R2 IS SET. IF THE LENGTH IS < 3,   *
* THEN THE VALUE IS OBVIOUSLY < 365, AND NO FURTHER PROCESSING IS     *
* NEEDED FOR THIS "DD" CARD. IF THE LENGTH IS EXACTLY 3, THEN THE     *
* VALUE IS INTERROGATED (AN ASSIGNMENT MADE EASIER BY THE WONDERFUL   *
* EBCDIC COLLATING SEQUENCE, WHICH ALLOWS THESE CHARACTER FORMATS     *
* TO BE CORRECTLY COMPARED NUMERICALLY).                              *
***********************************************************************
GOTRETPD EQU   *
         CLI   2(R7),X'04'        IS THE LENGTH OF THE RETPD PARM > 4?
         BNH   SCANRTPD           IF LENGTH <= 4, PROCEED WITH SCAN
         MVC   WTOMSG1+21(46),=CL46'RETPD TOO LONG - MUST BE 4 BYTES OR+
                LESS      '       ISSUE JCL ERROR WTO
         B     JCLMSG             PROCESS JCL ERROR
SCANRTPD L     R9,=XL4'00000000'  ZERO OUT REGISTER 9
         LH    R9,2(R7)           LOAD LENGTH OF RETPD OPERAND
         SRL   R9,24              SHIFT RIGHT TO JUSTIFY NUMBER
LOWTEST  EX    R9,LOWRTPD                EXECUTE FIRST RETPD RANGE TEST
         B     HIGHTEST                  DON'T EXECUTE CLC TWICE
LOWRTPD  CLC   3(0,R7),=XL4'F0F0F0F0'    IS THE RETPD NUMERIC ZEROES?
HIGHTEST BL    NOTNUM             IF RETPD < 0000, ISSUE JCLERROR
         EX    R9,HIGHRTPD               EXECUTE SECOND RANGE TEST
         B     TESTDONE                  DON'T EXECUTE CLC TWICE
HIGHRTPD CLC   3(0,R7),=XL4'F9F9F9F9'    IS THE RETPD NUMERIC NINES?
TESTDONE BH    NOTNUM             IF RETPD > 9999, ISSUE JCL ERROR
         ZAP   PACKAREA,=PL4'0'   ZERO OUT PACKAREA
TRY4     C     R9,=XL4'00000004'  IS SPECIFIED RETPD 4 BYTES LONG?
         BL    TRY3               IF LESS, TRY 3 BYTES LONG
         PACK  PACKAREA(4),3(4,R7)  OTHERWISE PACK SUPPLIED RETPD VALUE
         B     TSTRETPD           GO TO RETPD VALUE TEST
TRY3     C     R9,=XL4'00000003'  IS SPECIFIED RETPD 3 BYTES LONG?
         BL    LILRETPD           IF LESS, MUST BE LESS THAN 366 DAYS
         PACK  PACKAREA+1(3),3(3,R7)     PACK SUPPLIED EXPDT VALUE
TSTRETPD CP    PACKAREA(4),=PL4'366'     COMPARE SUPPLIED RETPD TO 366
         BL    LILRETPD                  IF LESS, SET INDICATOR FLAG
BIGRETPD EQU   *
         A     R2,=XL4'00000100'  SET RETPD FLAG IN R2 (RETPD >= 366)
         B     NEXTKEY            RETURN TO INTERNAL TEXT IMAGE SCAN
LILRETPD A     R2,=XL4'00000200'  SET RETPD FLAG IN R2 (RETPD < 366)
         B     NEXTKEY            RETURN TO INTERNAL TEXT IMAGE SCAN
NOTNUM   MVC   WTOMSG1+21(46),=CL46'RETPD IS NUT NUMERIC - MUST BE IN R+
               ANGE 1-9999'       ISSUE JCL ERROR WTO
         B     JCLMSG             PROCESS JCL ERROR
         EJECT
*
***********************************************************************
* TEST THE VOLSER OPERAND(S) FOR NUMERIC VALUES OF 00XXXX (3420) OR   *
* 01XXXX (3480). SET INDICATOR FLAGS IN R2 WHEN EITHER OR BOTH ARE    *
* FOUND.                                                              *
***********************************************************************
GOTVLSER EQU   *
         LA    R7,1(R7)           POINT TO NUMBER OF VOLSERS
         LH    R8,0(R7)           LOAD NUMBER OF VOLSERS
         SRL   R8,8               SHIFT RIGHT TO JUSTIFY NUMBER
         C     R8,=XL4'00000000'  CHECK FOR ZERO VOLSERS
         BZ    NOPARMS            CONTINUE TO NEXT KEY IF ZERO VOLSERS
         LA    R7,1(R7)           OTHERWISE, POINT TO LENGTH OF VOLSERS
NEXTVOL  LH    R9,0(R7)           LOAD LENGTH OF VOLSERS
         SRL   R9,8               SHIFT RIGHT TO JUSTIFY NUMBER
         LA    R7,1(R7)           POINT TO VOLSER OPERAND
         CLC   0(2,R7),=CL2'00'   IS THIS A 3420 VOLSER?
         BE    MARK3420           IF SO, MARK IT AS SUCH
         CLC   0(2,R7),=CL2'01'   IS THIS A 3480 VOLSER?
         BE    MARK3480           IF SO, MARK IT AS SUCH
SKIPOVER AR    R7,R9              POINT TO NEXT KEY (VOLSER LENGTH)
         S     R8,=XL4'00000001'  DECREMENT VOLSER COUNT BY 1
         C     R8,=XL4'00000000'  ARE THERE ANY MORE VOLS. TO PROCESS?
         BP    NEXTVOL            IF SO, GO DO IT
         B     ENDTEST            IF NOT, CONTINUE PROCESSING DD CARD
MARK3420 A     R2,=XL4'01000000'  INDICATE 3420 VOLSER IN FLAG REGISTER
         B     SKIPOVER           RETURN TO VOLSER PROCESSING
MARK3480 A     R2,=XL4'00010000'  INDICATE 3480 VOLSER IN FLAG REGISTER
         B     SKIPOVER           RETURN TO VOLSER PROCESSING
         EJECT
***********************************************************************
* THE INDICATOR FLAGS ARE CHECKED TO SEE IF THE "DD" CARD BEING       *
* PROCESSED IS ELIGIBLE FOR "UNIT" PARAMETER REPLACEMENT. IF SO, THE  *
* UNIT WILL BE CHANGED, AND AN INDICATIVE WTO MESSAGE WILL            *
* BE ISSUED TO THE JOB LOG. OTHERWISE, THE EXIT WILL FORCE THE DEFAULT*
* UNIT TYPE OF 3480.                                                  *
***********************************************************************
PROCESS  EQU   *
         ST    R2,FLAGS           STORE PARAMETER FLAGS INTO TEST AREA
TESTBOTH CLI   FLAG1,X'01'        TEST FOR 3420 VOLSERS
         BL    TEST3480           IF NOT INDICATED, GO TO 3480 TEST
         CLI   FLAG2,X'01'        TEST FOR 3480 TAPE CARTRIDGE VOLSERS
         BNL   JCLERROR           JCL ERROR IF 3420 & 3480 SPECIFIED
         B     VOL3420            PROCESS 3420 REQUESTS ACCORDINGLY
TEST3480 CLI   FLAG2,X'01'        TEST FOR 3480 TAPE CARTRIDGE VOLSERS
         BNL   VOL3480            PROCESS 3480 REQUESTS ACCORDINGLY
         CLI   FLAG3,X'10'        IS EXPDT=99000?
         BE    CHGCATLG           IF TEST IS TRUE, SUBSTITUTE UNIT=3480
         CLC   FLAG3(2),=XL2'0101'   TEST FOR RETPD > 365 & UNIT = TAPE
         BE    CHGRETPD           IF TEST IS TRUE, SUBSTITUTE UNIT=3420
         CLC   FLAG3(2),=XL2'0201'   TEST FOR RETPD < 365 & UNIT = TAPE
         BE    LOWRETPD           IF TEST IS TRUE, SUBSTITUTE UNIT=3480
         CLI   FLAG4,X'11'        TEST FOR EXPDT > 1 YEAR & UNIT = TAPE
         BE    CHGEXPDT           IF TEST IS TRUE, SUBSTITUTE UNIT=3420
         CLI   FLAG4,X'21'        TEST FOR EXPDT < 1 YEAR & UNIT = TAPE
         BE    LOWEXPDT           IF TEST IS TRUE, SUBSTITUTE UNIT=3480
         B     DEFAULT            IF NO TESTS ARE TRUE, DEFAULT=3480
         SPACE
JCLERROR EQU   *
         L     R0,=XL4'00000000'  ENSURE REGISTER 0 IS EMPTY FOR WTO
         MVC   WTOMSG1+21(46),=CL46'- ATTEMPT TO CONCATENATE 3420 && 34+
               80 TAPES    '
JCLMSG   LA    R1,WTOMSG1         LOAD ADDRESS OF WTO MESSAGE
         WTO   MF=(E,(R1))        EXECUTE WTO INSTRUCTION
         L     R0,=XL4'00000000'  ENSURE REGISTER 0 IS EMPTY FOR WTO
         MVC   WTOMSG2+4(22),=CL22'JOB ENDED - JCL ERROR '
         LA    R1,WTOMSG2         LOAD ADDRESS OF WTO MESSAGE
         WTO   MF=(E,(R1))        EXECUTE WTO INSTRUCTION
         L     R5,0(R3)           LOAD ADDRESS OF WORKAREA
         USING WORKAREA,R5        SET ADDRESSABILITY TO WORKAREA
         MVI   WORKAREA,X'08'     INDICATE JCL ERROR IN WORKAREA
         B     EXITRC8            LEAVE THIS EXIT WITH A JCL ERROR
         SPACE
VOL3420  EQU   *
         MVC   WTOMSG2+12(14),=CL14'3420 VOLSER   '
         B     UNIT3420                       FORCE UNIT=3420
         SPACE
VOL3480  EQU   *
         MVC   WTOMSG2+12(14),=CL14'3480 VOLSER   '
         B     UNIT3480           FORCE UNIT=3480
         EJECT
***********************************************************************
* MESSAGE FOR CATALOG CONTROLLED TAPE CARTRIDGES                      *
***********************************************************************
CHGCATLG EQU   *
         MVC   WTOMSG2+12(14),=CL14'EXPDT = 99000 '
         B     UNIT3480           FORCE UNIT=3480
         SPACE
***********************************************************************
* MESSAGE FOR LONG RETENTION TAPE REELS (RETPD > 365)                 *
***********************************************************************
CHGRETPD EQU   *
         MVC   WTOMSG2+12(14),=CL14'RETPD > 1 YEAR'
         B     UNIT3420           FORCE UNIT=3420
         SPACE
***********************************************************************
* MESSAGE FOR LONG RETENTION TAPE REELS (EXPDT > TODAY + 1 YEAR)      *
***********************************************************************
CHGEXPDT EQU   *
         MVC   WTOMSG2+12(14),=CL14'EXPDT > 1 YEAR'
         B     UNIT3420           FORCE UNIT=3420
         SPACE
***********************************************************************
* MESSAGE FOR SHORT RETENTION TAPES (RETPD < TODAY + 1 YEAR)          *
***********************************************************************
LOWRETPD EQU   *
         MVC   WTOMSG2+12(14),=CL14'RETPD < 1 YEAR'
         B     UNIT3480           FORCE UNIT=3480
         SPACE
***********************************************************************
* MESSAGE FOR SHORT RETENTION TAPES (EXPDT < TODAY + 1 YEAR)          *
***********************************************************************
LOWEXPDT EQU   *
         MVC   WTOMSG2+12(14),=CL14'EXPDT < 1 YEAR'
         B     UNIT3480           FORCE UNIT=3480
         SPACE
DEFAULT  EQU   *
         C     R10,=XL4'00000000' CHECK TO SEE IF A WTO IS NECESSARY
         BZ    CHECKRC            IF NO UNIT PARAMETER, SKIP WTO
         MVC   WTOMSG2+12(14),=CL14'DEFAULT = 3480'
UNIT3480 EQU   *
         MVC   0(4,R10),=CL4'3480'    REPLACE "3480" FOR SPECIFIED UNIT
         MVC   WTOMSG1+62,=CL4'3480'   INDICATE 3480 IN WTO MESSAGE
         B     MESSAGE1               ISSUE WTO MESSAGE
         SPACE
UNIT3420 MVC   0(4,R10),=CL4'3420'    REPLACE "3480" FOR SPECIFIED UNIT
         MVC   WTOMSG1+62,=CL4'3420'   INDICATE 3420 IN WTO MESSAGE
         SPACE
MESSAGE1 EQU   *
         LA    R1,WTOMSG1         LOAD ADDRESS OF WTO MESSAGE TEXT
         L     R0,=XL4'00000000'  ENSURE REGISTER 0 IS EMPTY FOR WTO
         WTO   MF=(E,(R1))        EXECUTE WTO
MESSAGE2 EQU   *
         LA    R1,WTOMSG2         LOAD ADDRESS OF WTO MESSAGE TEXT
         L     R0,=XL4'00000000'  ENSURE REGISTER 0 IS EMPTY FOR WTO
         WTO   MF=(E,(R1))        EXECUTE WTO
***********************************************************************
* IF A JCL ERROR WAS FLAGGED ANYWHERE IN THE PROCESSING, TERMINATE    *
* THE EXIT WITH AN RC=8 FOR EACH SUBSEQUENT CARD IMAGE (TO GUARANTEE  *
* THAT THE LAST CARD IMAGE SCAN WILL FORCE THE JCL ERROR)             *
***********************************************************************
         B     CHECKRC
JOBDONE  EQU   *
CHECKRC  EQU   *
EXITRC8  L     R5,0(R3)           IF NOT, LOAD ADDRESS OF WORKAREA
         USING WORKAREA,R5        SET ADDRESSABILITY TO WORKAREA
         CLI   WORKAREA,X'08'     SEE IF A JCL ERROR WAS FLAGGED
         BNE   EXITRC0            IF NOT, EXIT RETURN CODE = 0
         L     R15,=XL4'00000008' IF SO, EXIT RETURN CODE = 8
         B     BACK2JES           LEAVE THIS EXIT
EXITRC0  EQU   *
         L     R15,=XL4'00000000' SET RC=0 FOR NORMAL EXIT TERMINATION
***********************************************************************
* AGAIN, LINKAGE CONVENTIONS ARE OBSERVED IN CLEANING UP PRIOR TO THE *
* RETURN TO CALLER                                                    *
***********************************************************************
BACK2JES LR    R1,R13             REMEMBER ADDRESS OF GETMAINED STORAGE
         DROP  R5,R13,R15         DROP REGISTER ADDRESSABILITIES
         L     R13,4(R13)         GET ADDRESS OF CALLER'S REGISTERS
         FREEMAIN R,LV=180,A=(R1),SP=229          FREE MAIN STORAGE
         L     R14,12(R13)        RESTORE CALLER'S REGISTER 14
         LM    R0,R12,20(R13)     RESTORE CALLER'S REGISTERS 0-12
         BR    R14                RETURN TO CALLER
         LTORG
        $MODEND
         EJECT
***********************************************************************
* A CUSTOMIZED CVT MAPPING DSECT IS NECESSARY DUE TO CONFLICTS WITHIN *
* THE $MODEND MACRO                                                   *
***********************************************************************
*        CVT   LIST=YES,DSECT=YES CVT MAPPING MACRO
CVTMAP   DSECT                    CUSTOMIZED CVT MAPPING DSECT
CVTSTART DS    XL56
CVTDATE  DS    PL4
CVTMIDLE DS    XL143
CVTUSER  DS    XL4
CVTEND   DS    XL1213
         SPACE
***********************************************************************
* MAPPING DSECT FOR WORKAREA                                          *
***********************************************************************
WORKSPCE DSECT
WORKAREA DS    XL16
         SPACE
***********************************************************************
* MAPPING DSECT FOR EXIT RETURN CODE                                  *
***********************************************************************
EXITCODE DSECT
RETCODE  DS    XL4
         SPACE
***********************************************************************
* A CUSTOMIZED DSECT IS ALSO NECESSARY TO MAP THE GETMAINED STORAGE.  *
* SAVEAREA (18 FULLWORDS = 72 BYTES) + PACKAREA (4 BYTES) + FLAGS     *
* (4 BYTES) + WTO (100 BYTES) = 180 BYTES TOTAL REQUIRED GETMAIN AREA.*
***********************************************************************
GETAREA  DSECT
*
SAVEAREA DS    18F
*
PACKAREA DS    PL4'0'
*
FLAGS    DS    0XL4               PARAMETER FLAGS FROM R2
FLAG1    DS    XL1'00'            3420 VOLSER FLAG
FLAG2    DS    XL1'00'            3480 VOLSER FLAG
FLAG3    DS    XL1'00'            RETPD FLAG (01=RETPD PRESENT,
*                                             10=EXPDT=99000)
FLAG4    DS    XL1'00'            EXPDT/UNIT=TAPE FLAGS (10=EXPDT
*                                 PRESENT, 01="UNIT=TAPE" PRESENT)
***********************************************************************
* THE WTO SKELETON IS UPDATED WITH THE SITUATION-SPECIFIC INFO PRIOR  *
* TO ISSUANCE OF THE E-FORMAT WTO MACROS                              *
***********************************************************************
*                         1         2         3         4         5
*                123456789012345678901234567890123456789012345678901234
*                   6         7
*              5678901234567890
WTOMSG1  WTO   'DDNAME:          - UNIT PARAMETER CHANGED FROM "TAPE" T+
               O "    "',MF=L,ROUTCDE=(2),DESC=(7)
WTOMSG2  WTO   'BECAUSE               ',MF=L,ROUTCDE=(2),DESC=(7)
* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
         END
         EJECT

++PTF (PK00002).
++VER (Z038) FMID (JBB1326).
* **********************************************************************
*                   SQA FQE OVERLAY TRAP (JBB1326)
*
* DESCRIPTION - THIS ZAP WILL ATTEMPT TO TRAP A SQA FQE OVERLAY.
*
* OPERATION - HOOK OUT OF IEAVPFTE (BECAUSE IT IS ENTERED OFTEN AND
*             HOLDS THE SALLOC LOCK) AND SCAN THE SQA FQE'S VALIDITY
*             CHECKING EACH ONE. THIS TRAP ONLY CHECKS FQE'S FOR
*             SUBPOOL 245. WHEN AN ERROR IS DETECTED THIS TRAP WILL
*             PUT THE SYSTEM INTO A 'DEAD' WAIT STATE SO A STANDALONE
*             DUMP CAN BE TAKEN.
*
* REGISTER USAGE - REGISTERS SAVED AT 0940 AT TIME OF ERROR.
*
*      R0 - WORK REGISTER              REG 8 = START OF FREE AREA
*      R1 - CVT ADDRESS                REG 9 = PREVIOUS FQE ADDRESS
*      R2 - SQA SPQE ADDRESS           REG A = PREVIOUS DQE ADDRESS
*      R3 - CURRENT DQE ADDRESS        REG B = WORK REGISTER
*      R4 - START OF PREVIOUS FREE     REG C = WORK REGISTER
*           AREA (OR END OF DQE)
*      R5 - CURRENT FQE ADDRESS        REG D = UNUSED
*      R6 - START OF DQE AREA          REG E = UNUSED
*      R7 - END OF FREE AREA           REG F = ERROR CODE INDICATOR
*                                              (SEE TRAP CODE FOR
*                                               FURTHER DEFINITION)
*
*   RESTRICTIONS:  IF THIS TRAP IS USED ON A 3081 THE FOLLOWING
*      INSTRUCTIONS MUST BE MODIFIED
*      CHANGE REP 08B4 FROM 91C0,F008  TO  91A0,F008
*      CHANGE REP 08EC FROM 0000,0001  TO  0000,0002
*
* NOTES -
*      1. ALTHOUGH THIS ZAP IS WRITTEN WITH SMP CONTROL STATEMENTS,
*         IT IS RECOMMENDED THAT THE CONTROL STATEMENTS BE REMOVED
*         AND THE ZAP BE APPLIED TO AN ALTERNATE NUCLEUS VIA SUPERZAP.
*         NOTE ALSO THAT THE NAME STATEMENTS SPECIFY IEANUC01 WHICH
*         YOU WILL HAVE TO CHANGE TO THE NAME OF THE ALTERNATE NUCLEUS
*         THAT YOU HAVE BUILT.
*
*      2. THE LINES MARKED WITH ASTERISKS BEFORE THE COMMENTS MUST BE
*         MODIFIED IF THE TRAP IS RELOCATED IN THE PSA.
*
* CHANGE ACTIVITY -
*
*      82/09/29 WRITTEN
*      82/09/30 TESTED
*
* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
++ZAP(IEAVPFTE).
NAME IEANUC01 IEAVPFTE       (JBB1326)
VER 0022 58A0,3034            FOURTH INST. IN IEAVPFTE
REP 0022 4560,0820          * BRANCH TO TRAP
*
++ZAP(IEAASU00).
*
NAME IEANUC01 IEAVFX00
*
VER 0820 0000,0000            START OF TRAP CODE
VER 0A00 0000,0000            END OF TRAP CODE
REP 0820 900F,0900          * SAVE REGISTERS (SAVE AREA 1)
REP 0824 1FFF,0700            CLEAR ERROR CODE REGISTER
REP 0828 5810,0010            GET CVT ADDRESS
REP 082C 9110,10B6            IS NIP ACTIVE?
REP 0830 4770,08E2          * YES, GO TO EXIT
REP 0834 5820,1230            GET GDA ADDRESS
REP 0838 5820,2018            GET SQA SPQE ADDRESS
REP 083C 5830,2004            GET DQE ADDRESS
REP 0840 1233                 IS IT ZERO?
REP 0842 4780,08D0          * YES, GO MAKE TRACE RECORD
REP 0846 5840,3008            GET DQE BLK ADDRESS
REP 084A 5E40,300C            ADD DQE LENGTH
REP 084E 5850,3000            GET FIRST FQE
REP 0852 1255                 IS IT ZERO?
REP 0854 4780,088C          * YES, GET NEXT DQE
REP 0858 5860,3008            GET DQE BLK START ADDRESS
REP 085C 1956                 IS FQE BELOW DQE START ADDRESS?
REP 085E 4740,08A4          * YES, ERROR (REG 15 = 1)
REP 0862 1875                 PUT FQE ADDRESS IN REG 7
REP 0864 5E70,08FC          * GET END OF FREE AREA
REP 0868 1974                 IS END OF FREE AREA HIGHER THAT REG 4?
REP 086A 4720,08A0          * YES, ERROR (REG 15 = 2)
REP 086E 1887                 PUT END OF FQE IN REG 8
REP 0870 5F80,5004            SUBTRACT LENGTH OF FQE
REP 0874 1986                 IS START OF FQE BELOW START OF DQE?
REP 0876 4740,089C          * YES, ERROR (REG 15 = 3)
REP 087A 1987                 IS FQE START BELOW END OF FQE?
REP 087C 47B0,0898          * NO, ERROR (REG 15 = 4)
REP 0880 1848                 SET REG 4 EQUAL TO START OF FREE AREA
REP 0882 1895                 SET REG 9 EQUAL TO PREVIOUS FQE
REP 0884 5850,5000            GET NEXT FQE TO CHECK
REP 0888 47F0,0852          * CHECK NEXT FQE
*
* GET NEXT DQE
*
REP 088C 18A3                 SET REG A TO PREVIOUS DQE
REP 088E 1B99                 SET PREVIOUS FQE TO ZERO
REP 0890 5830,3004            GET NEXT DQE
REP 0894 47F0,0840          * CHECK NEXT DQE
*
* SYSTEM STOP CODE
*
REP 0898 41F0,F001            ERROR 4
REP 089C 41F0,F001            ERROR 3
REP 08A0 41F0,F001            ERROR 2
REP 08A4 41F0,F001            ERROR 1
REP 08A8 900F,0940          * SAVE TRAP REGS (SAVE AREA 2)
REP 08AC 58F0,0010            GET CVT ADDRESS
REP 08B0 58F0,F294            GET CSD ADDRESS
REP 08B4 91C0,F008            IS IT AP/MP?
REP 08B8 47E0,08CC          * NO, BRANCH TO UP STOP CODE
REP 08BC 48F0,0204            GET PHYSICAL CPU ID FOR THIS CPU
REP 08C0 57F0,08EC          * FLIP ID TO OTHER CPU
REP 08C4 AE0F,0009            SIGP OTHER CPU TO STOP
REP 08C8 4760,08C4          * BRANCH BACK IF OTHER CPU IS BUSY
REP 08CC 8200,08F0          * LOAD DEAD WAIT PSW
*
* EXIT CODE
*
REP 08D0 95FA,1191            IS TRACE ACTIVE?
REP 08D4 4770,08E2          * NO, DON'T TRACE
REP 08D8 58C0,0224            GET CURRENT ASCB ADDRESS
REP 08DC E50D,C024,08F8     * MAKE TRACE ENTRY
REP 08E2 980F,0900          * RESTORE REGS (SAVE AREA 1)
REP 08E6 58A0,3034            REPLACE OVERLAID INSTRUCTION
REP 08EA 07F6                 RETURN TO IEAVPFTE
*
* DATA AREAS
*
REP 08EC 0000,0001            X/OR MASK TO FLIP CPU IDS
REP 08F0 0002,0000            DEAD WAIT PSW
REP 08F4 0000,DEAD            DEAD WAIT PSW
REP 08F8 D6D2,0000            'OK' TRACE ENTRY
REP 08FC 0000,0008            LENGTH OF FQE
REP 0900 0000,0000            START OF SAVE AREA 1
REP 093C 0000,0000            END OF SAVE AREA 1
REP 0940 0000,0000            START OF SAVE AREA 2
REP 097C 0000,0000            END OF SAVE AREA 2
*
* END OF SQAFQEV3 TRAP
*
* *****************************************************
//SYSLIB DD DSN=SYS1.NUCLEUS
.TYPE
* ----------------------------------------------------------------------
*
*  DESCRIPTION:  THIS TRAP WILL VALIDITY CHECK THE FBQE CHAINS EVERY-
*                TIME THE SALLOC LOCK IS OBTAINED IN IEAVGM00 OR
*                IEAVGM00.  IF IT DETECTS A BAD FBQE A DEAD WAIT
*                PSW WILL BE LOADED.  WHEN THE DEAD WAIT PSW IS
*                LOADED TAKE A STANDALONE DUMP AND PRINT THE PSA(S)
*                AND SQA.
*  REGISTERS SAVEAREAS:
*                X'91C' THRU X'958' - REGISTERS 0 THRU F AT TIME OF
*                ERROR.  AT TIME OF ERROR REG 4 WILL POINT TO THE
*                BAD FBQE AND REG 5 WILL POINT TO THE PREVIOUS FBQE.
*  RESTRICTIONS: NONE
*  HISTORY:      07/27/82  WRITTEN AND TESTED (BJB)
* ----------------------------------------------------------------------
NAME IEANUC01 IEAVGM00      (PRE UZ56392)
VER 21A4 989A,4128
REP 21A4 47F0,0854          * BRANCH TO PATCH1
NAME IEANUC01 IEAVGM03      (PRE UZ56392)
VER 0CF0 989A,4128
REP 0CF0 47F0,0854          * BRANCH TO PATCH1
NAME IEANUC01 IEAVFX00
REP 0810 C2C7,D540            BGN - BEGINNING OF S/ZAP
REP 0814 0000,0000            SAVE AREA FOR REGS 0 THRU F (PATCH1)
* PATCH1
REP 0854 900F,0814          * STORE REGISTERS
REP 0858 4510,0868          * BALR TO VALIDITY CHECK THE FBQES
REP 085C 980F,0814          * RESTORE REGISTERS
REP 0860 989A,4128            REPLACE OVERLAID INSTRUCTION
REP 0864 07F9                 RETURN TO CALLER
* CODE TO VALIDITY CHECK THE FBQES FOR CSA
REP 0868 5820,004C            LOAD ADDR OF THE CVT
REP 086C 9110,20B6            IS NIP ACTIVE?
REP 0870 4710,08C0          * YES, DO NOT CHECK ANY FURTHER
REP 0874 5820,2230            LOAD ADDR OF THE GDA
REP 0878 5830,2008            LOAD ADDR OF THE CSA PQE
REP 087C 1233                 IS THERE A PQE?
REP 087E 4780,08B6          * NO, FURTHER CHECKS TO BE MADE
REP 0882 5840,3000            LOAD THE ADDR OF THE FIRST FBQE
REP 0886 1853                 SET REG 5 TO PREVIOUS FBQE
REP 0888 1934                 IS THE CURRENT FBQE THE PQE?
REP 088A 4780,08B6          * NO, FURTHER CHECKS TO BE MADE
REP 088E B100,4000            IS THE ADDR OF THE FBQE VALID?
REP 0892 4770,08D0          * NO, ERROR --------------------------------
REP 0896 5950,4004            DOES BACKWARD PTR POINT TO PREVIOUS FBQE?
REP 089A 4770,08D0          * NO, ERROR --------------------------------
REP 089E 1854                 SET REG 5 EQUAL TO PREVIOUS FBQE
REP 08A0 5840,4000            GET POINTER TO NEXT FBQE
REP 08A4 1934                 ARE WE POINTING BACK TO THE PQE?
REP 08A6 4770,088E          * NO, VALIDITY CHECK THIS FBQE
REP 08AA 4700,0000            UNUSED INSTRUCTION
REP 08AE 5950,4004            DOES BACKWARD PTR POINT TO PREVIOUS FBQE
REP 08B2 4770,08D0          * NO, ERROR --------------------------------
* MAKE TRACE ENTRY AND EXIT
REP 08B6 5860,0224            LOAD ADDR OF THE CURRENT ASCB
REP 08BA E50D,6024,08C8     * MAKE 'OK' TRACE INSTRUCTION
REP 08C0 07F1                 RETURN TO CALLER
* OK TRACE PSW
REP 08C8 D6D2,8000            'OK' PSW WHICH
REP 08CC 0000,0000                         MUST BE ON DOUBLE WORD BNDRY
* SYSTEM(S) STOP CODE
REP 08D0 900F,091C          * SAVE REGISTERS
REP 08D4 58F0,0010            LOAD ADDRESS OF CVT
REP 08D8 58F0,F294            LOAD ADDRESS OF CSD
REP 08DC 91C0,F008            IS IT AN AP/MP?
REP 08E0 47E0,0904          * NO, BRANCH TO SEE IF 3081 AP/MP
REP 08E4 48F0,0204            GET PHYSICAL CPU ID FOR THIS CPU
REP 08E8 57F0,0900          * FLIP ID TO OTHER CPU
REP 08EC AE0F,0009            SIGP OTHER CPU TO STOP
REP 08F0 4760,08EC          * LOOP IF OTHER CPU IS BUSY
REP 08F4 8200,08F8          * LOAD WAIT IN THIS CPU
REP 0900 0000,0001            X/OR MASK TO FLIP CPU IDS
REP 08F8 0002,0000            DEAD WAIT PSW
REP 08FC 0000,DEAD            DEAD WAIT PSW
* D/T3081 SUPPORT
REP 0904 91A0,F008            IS IT A 3081 AP/MP?
REP 0908 47E0,08F4          * NO, BRANCH TO UP STOP CODE
REP 090C 48F0,0204            GET PHYSICAL CPU ID FOR THIS CPU
REP 0910 57F0,0918          * FLIP ID TO OTHER CPU
REP 0914 47F0,08EC          * BRANCH TO SIGP OTHER CPU TO STOP
REP 0918 0000,0002            X/OR MASK TO FLIP CPU IDS
* **** SAVE AREA FOR REGS 0 THRU F AT TIME OF ERROR ********************
REP 091C 0000,0000            REG 0 THRU F SAVEAREA AT TIME OF ERROR
REP 095C C5D5,C440            END - END OF S/ZAP
*
* **** THE ASTERISK PRECEEDING A COMMENT INDCIATES AN INSTRUCTION
*      TO BE MODIFIED IF TRAP IS RELOCATED IN PSA

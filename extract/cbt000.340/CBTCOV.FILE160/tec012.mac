      IMPLICIT INTEGER*2 (A-Z)
      DIMENSION NTEMPB(16),MPOSTN(13),MVMADX (90,7),MVMADO(7)
     *,MVMADS(7),NWINNR (90,3),NCHKR(10,4),MBOARD(18,16),NROTR(8,16),
     *MAINBD(64),MOVGMO(32),MOVGMX(32),CNTBRD(18,2) ,NSQUAR(64,7),
     *BBORDX(18),BBORDO(18),INTVCO(64),INTVCX(64),MAXVEC(64),
     *TMPVEC(16),NTEMPA(16),ORDERS(64)
      NS=0
      NX=1
      NO=2
      NCONFG=88
      DO 5 I=1,10
  5   READ (32,7) (NCHKR(I,J),J=1,4)
    7 FORMAT (4I2)
      DO 50 I=1,NCONFG
   50 READ (32,77) (NWINNR(I,J),J=1,3),(MVMADX(I,K),K=1,5)
   77 FORMAT (8I2)
      DO 300 I=1,18
  300 READ (32,307) (MBOARD(I,J),J=1,16)
  307 FORMAT (16I2)
      DO 400 I=1,8
  400 READ (32,407) (NROTR(I,J),J=1,16)
  407 FORMAT (16I2)
      READ (32,507) (ORDERS(I),I=1,32)
      READ (32,507) (ORDERS(I),I=33,64)
  507 FORMAT (32I2)
      CALL CMPNSQ(NSQUAR,MBOARD)
      GAMNUM=0
  550 WORLS=0
      FRSMOV=0
      DO 560 I=1,18
      CNTBRD(I,NO)=0
  560 CNTBRD(I,NX)=0
      DO 600 I=1,64
  600 MAINBD(I)=NS
      GAMNUM=GAMNUM+1
      IF (GAMNUM.GT.8) GAMNUM=2
      MOVENO=0
      MVGMNO=0
      NROTS=GAMNUM
      FRCMOV=0
      GO TO 1600
  101 WRITE (6,107)
  107 FORMAT(21H **NOT A LEGAL MOVE**)
  111 WRITE (6,117)
  117 FORMAT(11H ENTER MOVE)
  121 READ (5,127) MOVGMO(MVGMNO)
  127 FORMAT(I2)
      IF (MOVGMO(MVGMNO).EQ.66) GO TO 9300
      IF (MOVGMO(MVGMNO).EQ.77) GO TO 8200
      IF ((MOVGMO(MVGMNO).GT.64).OR.(MOVGMO(MVGMNO).LT.1)) GO TO 101
      IF (MAINBD(MOVGMO(MVGMNO)).NE.NS) GO TO 101
      MAINBD(MOVGMO(MVGMNO))=NO
      CALL UPDATE(MOVGMO(MVGMNO),NO,CNTBRD,NSQUAR)
      IF (NIX.EQ.88) GO TO 1690
      WORLS=0
      WMAX=0
       DO 202 I=1,14
      NSUBX=0
      NSUBO=0
      IF (CNTBRD(I,NX).LT.3) NSUBX=1
      IF (CNTBRD(I,NO).LT.3) NSUBO=1
      IF ((NSUBX.EQ.1).AND.(NSUBO.EQ.1)) GO TO 202
      DO 204 J=1,16
  204 NTEMPB(J)=MAINBD(MBOARD(I,J))
      IF (NSUBX.EQ.1) GO TO 206
      CALL NCHECK(NTEMPB,NX,NTOWIN,NUMPOS,NCHKR)
       IF (NUMPOS.EQ.0) GO TO 206
      MOVEX=MBOARD(I,NTOWIN)
      WORLS=2
      GO TO 8000
 206  IF (WMAX.EQ.2) GO TO 202
      IF (NSUBO.EQ.1) GO TO 202
      CALL NCHECK(NTEMPB,NO,NTOBLK,NUMPOS,NCHKR)
      IF (NUMPOS.EQ.0) GO TO 202
      IF (NUMPOS.GT.1) GO TO 222
      MOVEX=MBOARD(I,NTOBLK)
      IF (WORLS.EQ.0) GO TO 220
      IF (MOVEX.NE.LSTMVX) GO TO 222
      GO TO 202
 222  WORLS=1
      WMAX=2
      GO TO 202
 220  LSTMVX=MOVEX
      WORLS=1
 202  CONTINUE
      IF (WMAX.EQ.2) GO TO 9000
      IF (WORLS.EQ.1) GO TO 8000
       NUM=2
       IF (BILDNO.EQ.5) GO TO 4050
       IF (MOVENO.GT.1) GO TO 3333
  205    IF (BRDINS.EQ.0) GO TO 208
      IF (CNTBRD(BRDINS,NO).EQ.LSTCTO) GO TO 4000
  208 BRDXCT=0
      NUM=3
      SWTCH=0
      R=0
  210 BRDOCT=0
      DO 3000 I=1,18
      IF ((CNTBRD(I,NO).EQ.0).OR.(CNTBRD(I,NX).GT.R)) GO TO 250
      BRDOCT=BRDOCT+1
      BBORDO(BRDOCT)=I
      GO TO 3000
  250 IF (SWTCH.EQ.1) GO TO 3000
      IF ((CNTBRD(I,NX).EQ.0).OR.(CNTBRD(I,NO).GT.0)) GO TO 3000
      BRDXCT=BRDXCT+1
      BBORDX(BRDXCT)=I
 3000 CONTINUE
      IF (BRDXCT.EQ.0) GO TO 8000
      IF (NUM.NE.3) GO TO 3004
      CALL BIASED(MAINBD,ORDERS,MAXVEC,NUMMAX)
      GO TO 1028
 3004 IF (BRDOCT.NE.0) GO TO 3010
 3005 R=R+1
      IF (R.GT.3) GO TO 8000
      SWTCH=1
      GO TO 210
 3010 MAXMUM=0
      SWTCH=0
      DO 650 N=1,64
      INTVCO(N)=0
  650 INTVCX(N)=0
      DO 800 N=1,64
      IF (MAINBD(N).NE.NS) GO TO 800
       BRDINT=NSQUAR(N,1)+1
      NMINTO=0
      NMINTX=0
      DO 900 I=2,BRDINT
      DO 950 K=1,BRDOCT
      IF (BBORDO(K).EQ.NSQUAR(N,I)) NMINTO=NMINTO+1
  950 CONTINUE
      DO 975 K=1,BRDXCT
      IF (BBORDX(K).EQ.NSQUAR(N,I)) NMINTX=NMINTX+1
  975 CONTINUE
  900 CONTINUE
      INTVCO(N)=NMINTO
      INTVCX(N)=NMINTX
      NSUMOX=NMINTO+NMINTX
      IF (NSUMOX.LE.MAXMUM) GO TO 800
      MAXMUM=NSUMOX
  800 CONTINUE
      NUMMAX=0
      IF (MAXMUM.EQ.0) GO TO 3005
      DO 1025 I=1,64
      NSUMOX=INTVCO(I)+INTVCX(I)
      IF (NSUMOX.NE.MAXMUM) GO TO 1025
      NUMMAX=NUMMAX+1
      MAXVEC(NUMMAX)=I
 1025 CONTINUE
 1028 TMPCNT=0
 1050 DO 1100 I=1,BRDXCT
      IF  (CNTBRD(BBORDX(I),NX).NE.NUM) GO TO 1100
      TMPCNT=TMPCNT+1
      TMPVEC(TMPCNT)=BBORDX(I)
 1100 CONTINUE
      IF (TMPCNT.EQ.0) GO TO 1205
      IF (NUMMAX.EQ.0) GO TO 3005
      DO 1200 I=1,TMPCNT
      DO 1225 K=1,NUMMAX
      DO 1250 L=1,16
      IF  (MAXVEC(K).NE.MBOARD(TMPVEC(I),L)) GO TO 1250
      IF (NUM.NE.3) MAINBD(MAXVEC(K))=NX
      DO 1275 J=1,16
      NTEMPB(J)=MAINBD(MBOARD(TMPVEC(I),J))
 1275 CONTINUE
      IF (NUM.NE.3) MAINBD(MAXVEC(K))=NS
      DO 1280 N=1,8
      IF ((NTEMPB(NROTR(N,1)).EQ.0).AND.(NTEMPB(NROTR(N,2)).EQ.0))
     *GO TO 1280
      NROTRA=N
      GO TO 1290
 1280 CONTINUE
      IF (NUM.GT.1) GO TO 1225
 1290 DO 1295 N=1,16
 1295 NTEMPA(N)=NTEMPB(NROTR(NROTRA,N))
      DO 1300 M=1,NCONFG
      KOUNTS=0
      IF (NTEMPA(NWINNR(M,1)).EQ.NX) KOUNTS=KOUNTS+1
      IF (NTEMPA(NWINNR(M,2)).EQ.NX) KOUNTS=KOUNTS+1
      IF (NTEMPA(NWINNR(M,3)).EQ.NX) KOUNTS=KOUNTS+1
      IF ((KOUNTS.NE.3).AND.((KOUNTS.NE.2).OR.(NUM.NE.1))) GO TO 1300
      IF (NUM.EQ.1) GO TO 1400
      BRDINS=TMPVEC(I)
      WINCON=M
      NROTS=NROTRA
      FRCMOV=0
      IF (NUM.EQ.3) GO TO 4050
       BILDNO=3
       LSTCTX=3
      LSTCTO= CNTBRD(BRDINS,NO)
      HRSTIC=0
      GO TO 1400
 1300 CONTINUE
 1250 CONTINUE
 1225 CONTINUE
 1200 CONTINUE
 1205 IF (NUM.EQ.1) GO TO 3005
      NUM=NUM-1
      IF (NUM.EQ.1) GO TO 3004
      GO TO 1028
 1600 IF (GAMNUM.EQ.1) GO TO 1610
      GO TO 1675
 1610 WRITE (6,7777)
 7777 FORMAT (' ')
      WRITE (6,1617)
 1617 FORMAT(' ',T22,'3-D 4X4X4 TIC-TAC-TOE')
 1620 WRITE (6,1627)
 1627 FORMAT(' ',T21,'OTHERWISE KNOWN AS QUBIC')
 1630 WRITE (6,1637)
 1637 FORMAT(' ',T13,'AUTHORED BY BILL HENRY  INFE 375',
     *' WINTER-1975')
      WRITE (6,7777)
      WRITE (6,7777)
 1640 WRITE (6,1647)
 1647 FORMAT(' ',T16,'SQUARES ARE IDENTIFIED AS FOLLOWS')
      DO 1650 K=1,4
      B=K*4-3
      E=B+3
      WRITE (6,1657) ((MBOARD(1,I),I=B,E),
     * (MBOARD(2,I),I=B,E),
     * (MBOARD(3,I),I=B,E),
     * (MBOARD(4,I),I=B,E))
 1650 CONTINUE
 1657 FORMAT (' ',T6,4I3,'  ',4I3,' ',4I3,' ',4I3)
      WRITE (6,7777)
      WRITE (6,7777)
      WRITE (6,1667)
 1667 FORMAT('    OPTIONS')
      WRITE (6,1677)
 1677 FORMAT('    1. ENTER...66...TO GET A BOARD LISTING')
       WRITE (6,1687)
 1687 FORMAT('    2. ENTER...77...TO RESIGN FROM THE GAME')
      WRITE (6,1697)
 1697 FORMAT('    3. ENTER...88...TO GET THE FIRST MOVE')
      WRITE (6,1707)
 1707 FORMAT('    4. ENTER...99...TO PLAY ANOTHER GAME')
      WRITE (6,7777)
      WRITE (6,7777)
      WRITE (6,1717)
 1717 FORMAT('    **NOTES**')
      WRITE (6,1727)
 1727 FORMAT('    --OPTIONS 3 AND 4 ARE TO BE USED ONLY WHEN')
      WRITE (6,1737)
 1737 FORMAT('      THEY ARE REQUESTED')
      WRITE (6,1747)
 1747 FORMAT('    --ALL NUMBERS ENTERED MUST, REPEAT, *MUST*')
      WRITE (6,1757)
 1757 FORMAT('      HAVE TWO DIGITS. IE. A 03 INSTEAD OF 3')
      WRITE (6,7777)
 1675 WRITE (6,7777)
      WRITE (6,1767)
 1767 FORMAT(' ENTER 88 TO MOVE FIRST, OTHERWISE HIT RETURN')
      READ (5,8027) NIX
      IF (NIX.NE.88) GO TO 1700
      FRSMOV=1
      MVGMNO=1
      GO TO 111
 1690 NIX=0
      IF (CNTBRD(1,NO).EQ.0) GO TO 1700
      BRDINS=4
      GO TO 1750
 1700 BRDINS=1
 1750 WINCON=1
      LSTCTO=0
      BILDNO=0
       LSTCTX=0
      GO TO 4000
 1400 MOVEX=MAXVEC(K)
      GO TO 8000
 3333 MAX=0
      SWTCH=0
      SUB=0
      CALL BIASED(MAINBD,ORDERS,MAXVEC,SUB)
      IF (SUB.LT.2) GO TO 9100
      SWTCH=0
      MAXBLK=0
      MAXPOS=0
      DO 3550 I=1,SUB
       N=MAXVEC(I)
       NUMINT=NSQUAR(N,1)+1
      NUM=0
       DO 3575 J=2,NUMINT
       INTCHX=CNTBRD(NSQUAR(N,J),NX)
      IF ((INTCHX.LT.2).OR.(INTCHX.GT.15)) GO TO 3700
       MAINBD(MAXVEC(I))=NX
 3585 DO 3600 K=1,16
 3600  NTEMPB(K)=MAINBD(MBOARD(NSQUAR(N,J),K))
      IF (SWTCH.EQ.1) GO TO 3750
      CALL NCHECK (NTEMPB,NX,NTOWIN,NUMPOS,NCHKR)
      IF (NUMPOS.EQ.0) GO TO 3700
      IF (NUMPOS.GT.1) GO TO 3610
      NTEMPB(NTOWIN)=NO
      CALL NCHECK(NTEMPB,NO,NTOBLK,NUMBLK,NCHKR)
      NTEMPB(NTOWIN)=NS
      IF (NUMBLK.GT.0) GO TO 3700
      IF (NUMPOS.LE.MAXPOS) GO TO 3610
      MAXPOS=NUMPOS
      MAXSUB=I
 3610   IF (NUMPOS.LT.2) GO TO 3700
      MOVEX=MAXVEC(I)
      GO TO 8000
 3700 IF (MAXBLK.GT.1) GO TO 3760
      INTCHO=CNTBRD(NSQUAR(N,J),NO)
      IF ((INTCHO.LT.2).OR.(INTCHO.GT.15))  GO TO 3760
       MAINBD(MAXVEC(I))=NO
      SWTCH=1
      GO TO 3585
 3750 SWTCH=0
      CALL NCHECK (NTEMPB,NO,NTOBLK,NUMPOS,NCHKR)
       IF (NUMPOS.EQ.0) GO TO 3760
      IF (NUMPOS.GT.1) GO TO 3740
      MOVEO=MBOARD(NSQUAR(N,J),NTOBLK)
      IF (NUM.EQ.0) GO TO 3730
      IF (MOVEO.NE.LSTMVO) GO TO 3740
      GO TO 3760
 3730 NUM=1
      MAXBLK=NUM
      BLKSUB=I
      LSTMVO=MOVEO
      GO TO 3760
 3740 MAXBLK=2
      BLKSUB=I
 3760 MAINBD(MAXVEC(I))=NS
 3575 CONTINUE
 3550 CONTINUE
       IF (MAXBLK.GT.1) GO TO 3800
 3080 X=4
      HRSTIC=0
3078    POSSUM=0
       DO 3825 I=1,18
       DIFF=CNTBRD(I,NO)-CNTBRD(I,NX)
      IF (DIFF.NE.X) GO TO 3825
      POSSUM=POSSUM+1
      TMPVEC(POSSUM)=I
3825    CONTINUE
       IF (POSSUM.EQ.0) GO TO 3850
      DO 6666 M=1,POSSUM
       DO 3830 J=1,16
 3830 NTEMPB(J)=MAINBD(MBOARD(TMPVEC(M),J))
       DO 3835 J=1,16
       IF (NTEMPB(J).NE.NS) GO TO 3835
       NTEMPB(J)=NO
       NMEM=0
       DO 3840 K=1,10
       DO 3842 L=1,4
       IF (NCHKR(K,L).EQ.J) GO TO 3844
3842    CONTINUE
       GO TO 3840
3844    KOUNT=0
       DO 3845 I=1,4
       INDX=NCHKR(K,I)
       IF (NTEMPB(INDX).EQ.NO) KOUNT=KOUNT+1
       IF (NTEMPB(INDX).NE.NX) GO TO 3845
       KOUNT=0
       GO TO 3840
3845    CONTINUE
       NMEM=NMEM+KOUNT
3840    CONTINUE
      IF (CNTBRD(TMPVEC(M),NO).LT.3) GO TO 3834
      CALL NCHECK(NTEMPB,NO,NTOBLK,NUMPOS,NCHKR)
      NMEM=NMEM+NUMPOS
 3834 IF (NMEM.LE.HRSTIC) GO TO 3833
       HRSTIC=NMEM
       MXPS=J
      MAXBD=TMPVEC(M)
3833    NTEMPB(J)=NS
3835    CONTINUE
 6666 CONTINUE
 3850 X=X-1
      IF (X.NE.0) GO TO 3078
      IF (HRSTIC.EQ.0) GO TO 3860
       IF ((HRSTIC.GT.5).OR.(MAXPOS.EQ.0)) GO TO 3900
 3837  MOVEX=MAXVEC(MAXSUB)
       GO TO 205
 3860 MOVEX=MAXVEC(SUB)
      GO TO 205
3900    MOVEX=MBOARD(MAXBD,MXPS)
      IF (HRSTIC.GT.6) GO TO 8000
      IF ((HRSTIC.GT.5).AND.(MOVENO.GT.7)) GO TO 8000
      IF ((HRSTIC.GT.5).AND.(FRSMOV.EQ.1)) GO TO 8000
       GO TO 205
3800   MOVEX=MAXVEC(BLKSUB)
       GO TO 8000
 4000 BILDNO=BILDNO+1
       IF (LSTCTX.NE.CNTBRD(BRDINS,NX)) GO TO 208
      IF (BILDNO.GT.3) GO TO 4050
      LSTCTO=CNTBRD(BRDINS,NO)
      MOVEX=MBOARD(BRDINS,NROTR(NROTS,NWINNR(WINCON,BILDNO)))
       LSTCTX=BILDNO
      GO TO 8000
 4050 FRCMOV=FRCMOV+1
       BILDNO=5
      MOVEX=MBOARD(BRDINS,NROTR(NROTS,MVMADX(WINCON,FRCMOV)))
      IF (MAINBD(MOVEX).EQ.NS) GO TO 8000
      BRDINS=0
      BILDNO=0
      FRCMOV=0
      GO TO 3333
 8000 MOVENO=MOVENO+1
      MVGMNO=MOVENO
      MAINBD(MOVEX)=NX
      MOVGMX(MOVENO)=MOVEX
      CALL UPDATE (MOVGMX(MOVENO),NX,CNTBRD,NSQUAR)
      WRITE (6,8007) MOVEX
 8007 FORMAT (11H I MOVE TO ,I2)
      IF (WORLS.NE.2) GO TO 111
       GO TO 9300
 8010 WRITE (6,8017)
 8017 FORMAT(30H I WON. ENTER 99 TO PLAY AGAIN)
 8020 READ (5,8027) DECIDR
 8027 FORMAT (I2)
      IF (DECIDR.EQ.99) GO TO 550
      GO TO 9200
 8200 WRITE (6,8207)
 8207 FORMAT (20H YOU QUIT. THEREFORE)
      GO TO 8010
 9000 WRITE (6,9007)
 9007 FORMAT (31H I LOSE. ENTER 99 TO PLAY AGAIN)
      GO TO 8020
 9100 WRITE (6,9107)
 9107 FORMAT (35H NO ONE WINS ENTER 99 TO PLAY AGAIN)
      GO TO 8020
 9300 DO 9400 K=1,4
      B=K*4-3
      E=B+3
      WRITE (6,1657) ((MAINBD(MBOARD(1,I)),I=B,E),
     * (MAINBD(MBOARD(2,I)),I=B,E),
     * (MAINBD(MBOARD(3,I)),I=B,E),
     * (MAINBD(MBOARD(4,I)),I=B,E))
 9400 CONTINUE
       IF (WORLS.NE.2) GO TO 9405
       WRITE (6,9417)
 9417  FORMAT (24H IT SHOULD BE CLEAR THAT)
       GO TO 8010
 9405  WRITE (6,9407)
 9407 FORMAT(34H I AM 1, YOU ARE 2, AND SPACE IS 0)
      GO TO 111
 9200 STOP
      END
      SUBROUTINE NCHECK(NBORD,NPLYR,NSUBB,NUMF,NCHK)
      IMPLICIT INTEGER*2 (A-Z)
      DIMENSION NBORD(16),NCHK(10,4)
      NUMF=0
      NS=0
      DO 301 I=1,10
      NMEM=0
      KOUNT=0
      DO 302 J=1,4
      INDX=NCHK(I,J)
      IF (NBORD(INDX).EQ.NPLYR) KOUNT=KOUNT+1
      IF (NBORD(INDX).EQ.NS) NMEM=INDX
  302 CONTINUE
      IF ((KOUNT.NE.3).OR.(NMEM.EQ.0)) GO TO 301
      NUMF=NUMF+1
      NSUBB=NMEM
  301 CONTINUE
      RETURN
      END
      SUBROUTINE CMPNSQ (NSQUAR,MBOARD)
      IMPLICIT INTEGER*2 (A-Z)
      DIMENSION NSQUAR(64,7),MBOARD(18,16)
      DO 100 N=1,64
      NSQUAR(N,1)=0
      NUMINT=1
      DO 200 J=1,18
      DO 300 K=1,16
      IF (N.NE.MBOARD(J,K)) GO TO 300
      NUMINT=NUMINT+1
      NSQUAR(N,1)=NSQUAR(N,1)+1
      NSQUAR(N,NUMINT)=J
      GO TO 200
  300 CONTINUE
  200 CONTINUE
  100 CONTINUE
      RETURN
      END
      SUBROUTINE UPDATE (MOVEX,NX,CNTBRD,NSQUAR)
      IMPLICIT INTEGER*2 (A-Z)
      DIMENSION CNTBRD(18,2), NSQUAR(64,7)
      NUMBRD=NSQUAR(MOVEX,1)+1
      DO 100 N=2,NUMBRD
      CNTBRD(NSQUAR(MOVEX,N),NX)=CNTBRD(NSQUAR(MOVEX,N),NX)+1
  100 CONTINUE
      RETURN
      END
      SUBROUTINE BIASED(MAINBD,ORDERS,MAXVEC,NUMVAR)
      IMPLICIT INTEGER*2 (A-Z)
      DIMENSION MAINBD(64),ORDERS(64),MAXVEC(64)
      NUMVAR=0
      NS=0
      DO 10 I=1,64
      IF (MAINBD(ORDERS(I)).NE.NS) GO TO 10
      NUMVAR=NUMVAR+1
      MAXVEC(NUMVAR)=ORDERS(I)
  10  CONTINUE
      RETURN
      END

         MACRO
         STAES
         SPACE 1
STAEPARM DSECT
         SPACE 1
*        THIS IS A DSECT OF THE PARAMETERS PASSED TO STAE DURING
*        EXECUTION OF THE STAE MACRO.   THESE ARE PASSED IN THE
*        PARAM= PARAMETER OF THE STAE MACRO WHICH IS PASSED AS THE
*        FIRST WORD OF THE STAEWORK MACRO TO IKJEHSIR.
         SPACE 1
TBLADDR  DS    0A             ADDRESS OF RETRY TABLE
         SPACE 1
STAEFLAG DC    X'00'          FLAG BYTE FOR STAE EXIT
         SPACE 1
*        THE MEANING OF THE FLAG BYTE BITS FOLLOWS:
         SPACE 1
STAEUSER EQU   X'01'          USER WILL HANDLE ABENDS
STAETMP  EQU   X'02'          USER WANTS THE TMP TO HANDLE ABENDS
         SPACE 1
*        IF NEITHER OF THE BITS IS SET, STAEUSER IS ASSUMED
         SPACE 1
*        THE FOLLOWING IS THE POINTER TO THE TABLE OF ABENDS.
*        THIS IS DESCRIBED IN PARAM DSECT
         SPACE 1
STAETBL  DC    AL3(0)         POINTER TO TABLE
         SPACE 1
*        THE FOLLOWING IS THE POINTER TO THE PSEUDO RETRY ADDRESS
*        THIS IS DESCRIBED IN THE RETRY DSECT.
         SPACE 1
RETRYER  DC    A(0)           ADDRESS OF LM & SAVEAREA
         EJECT
RETRY    DSECT
         SPACE 1
*        THIS IS A DSECT OF THE RETRY ADDRESS PASSED TO IKJEHSIR
*        DURING THE EXECUTION OF THE STAE MACRO VIA PARAM=.
         SPACE 1
*        THE FIRST TWO DC'S ARE USED TO OBTAIN ADDRESSABILITY FOR THE
*        USER'S RETRY ROUTINE; THIS ELIMINATES THE PROBLEM OF A
*        PROGRAM THE USER CALLED ABENDING.  WHEN THIS HAPPENS, STAE
*        RETURNS THE REGISTERS BELONGING TO THE CALLED PROGRAM TO
*        THE STAE RETRY ROUTINE.
*              NOTE:  DUE TO MEMMAP RESTRICTION, THESE SHOULD BE DC'S
         SPACE 1
RETRIER  DC    X'980FF008'    LM    R0,R15,8(R15)   LOAD ALL REGISTERS
         DC    X'47F0F000'    B     0(R15)    GO TO RETRY ROUTINE
         SPACE 1
*        THE FOLLOWING 16 DC'S ARE A STORAGE AREA FOR THE USER'S
*        REGISTERS.  THE SLOTS FOR R0, R1, R2 & R15 WILL BE SET UP
*        BY THE IKJEHSIR ROUTINE AS FOLLOWS:
*              R0     THE CODE GIVEN TO THE EXIT ROUTINE BY STAE
*              R1     THE ABEND CODE, RIGHT JUSTIFIED
*              R2     THE ENTRY NUMBER IN LIST OF CODES
*              R15    THE ADDRESS OF THE USERS RETRY ROUTINE
         SPACE 1
RETRYR0  DC    F'0'           STORAGE FOR R0
RETRYR1  DC    F'0'           STORAGE FOR R1
RETRYR2  DC    F'0'           STORAGE FOR R2
RETRYRS  DC    10F'0'         THE REST OF THE REGS
RETRYR13 DC    F'0'           STORAGE FOR R13
RETRYR14 DC    F'0'           STORAGE FOR R14
RETRYR15 DC    F'0'           STORAGE FOR R15
         SPACE 1
*        THE FOLLOWING WORD IS REQUIRED SO THAT THE PUTLINE
*        SERVICE ROUTINE CAN BE INVOKED BY THE STAE EXIT
*        ROUTINE.  IT IS REGISTER 1 AS GIVEN TO THE CP BY
*        THE TMP.  IT IS A POINTER TO FOUR ADDRESSES, SEE
*        THE TMPPARM DSECT.
         SPACE 1
TMPREG1  DC    F'0'           REG 1 FROM TMP
         EJECT
PARAM    DSECT
         SPACE 1
*        THIS IS A DSECT OF THE PARAMETER TABLE OF ADDRESSES OF THOSE
*        ROUTINES WHICH WILL HANDLE SPECIFIC ABENDS.  THIS IS BUILD
*        BY THE USER OF THE STAE EXIT ROUTINE AND PASSED TO THE
*        IKJEHSIR ROUTINE THRU THE PARAM= PARAMETER OF THE STAE MACRO.
         SPACE 1
*        EACH ENTRY IN THE TABLE IS OF THE FOLLOWING FORM, AND MUST
*        BE TWO WORDS LONG.  THE TABLE MUST BE FULLWORD ALIGNED.
         SPACE 1
*  *****************************************************************
*  *         *                                                     *
*  *   FLAG  *    ABEND CODE OR ADDRESS OF LIST OF CODES           *
*  *         *                                                     *
*  *****************************************************************
*  *                                                               *
*  *           ADDRESS OF THE ROUTINE TO HANDLE THE CODE(S)        *
*  *                                                               *
*  *****************************************************************
         SPACE 1
PARMADDR DS    0A             ADDRESS OF LIST OF CODES
         SPACE 1
PARMFLAG DC    X'00'          FLAG BYTE
         SPACE 1
*        THE FOLLOWING IS THE MEANING OF THE FLAG BYTE BITS
         SPACE 1
FLAGONE  EQU   X'01'          RETRY FOR ONE CODE ONLY--CODE FOLLOWS
FLAGMUL  EQU   X'02'          RETRY FOR LIST OF CODES--ADDRESS FOLLOWS
FLAGALL  EQU   X'04'          RETRY ALL OTHER CODES--A ZERO FOLLOWS
FLAGUSER EQU   X'08'          RETRY FOR USER ABENDS
FLAGNMSG EQU   X'10'          DO NOT ISSUE MESSAGE
FLAGEND  EQU   X'80'          END OF TABLE
         SPACE 1
*        THE FOLLOWING CAN BE ONE OF THREE THINGS:  THE ACTUAL ABEND
*        CODE, THE ADDRESS OF A LIST OF CODES, OR A ZERO.
         SPACE 1
PARMCODA DC    X'00'          1ST BYTE OF ADDRESS
PARMCODE DC    H'0'           ABEND CODE
         SPACE 1
*        THE FOLLOWING IS ALWAYS REQUIRED.  IT IS THE ADDRESS OF THE
*        ROUTINE WHICH WILL HANDLE ABENDS; IE, THE USER'S RETRY
*        ROUTINE.
         SPACE 1
PARMRTRY DC    A(0)           ADDRESS OF ROUTINE
         SPACE 1
PARMLNTH EQU   *-PARMADDR     LENTH OF EACH ENTRY
         EJECT
PARMLIST DSECT
         SPACE 1
*        THE FOLLOWING IS A DSECT OF THE LIST OF CODES PASSED TO THE
*        IKJEHSIR ROUTINE BY THE USER THRU THE USE OF THE FLAGMUL
*        BIT OF THE PARMFLAG OF THE PARAM DSECT.  EACH ENTRY IS A
*        HALFWORD LONG, AND MAY BE EITHER A USER OR A SYSTEM ABEND
*        CODE.  THE USER ABEND CODES MUST BE FLAGGED BY THE USE
*        OF THE FLAGUSER IN THE PARMFLAG OF THE PARAM DSECT.  IF THE
*        FLAGUSER IS ON, ALL CODES IN THAT LIST MUST BE USER ABEND
*        CODES.
         SPACE 1
CODES    DC    H'0'           AN ABEND CODE
         SPACE 1
*        THE HIGH ORDER BIT OF CODES IS USED TO SIGNIFY THE END OF THE
*        LIST OF CODES.  IF THE BIT IS ON, THAT IS THE END OF THE LIST
         SPACE 1
CODESEND EQU   X'80'          END OF LIST
         SPACE 1
CODELNTH EQU   *-CODES        LENGTH OF EACH CODE
         EJECT
TMPPARM  DSECT
         SPACE 1
*        THIS IS A DSECT OF THE FOUR WORD AREA PASSED TO THE
*        CP BY THE TMP.  THE UPT, PSCB, AND ECT ARE DESCRIBED
*        IN THEIR RESPECTIVE DSECTS (QV).  THE COMMAND BUFFER
*        IS THE COMMAND AS ENTERED BY THE USER AT THE TERMINAL.
         SPACE 1
TMPCMBUF DC    F'0'           POINTER TO COMMAND BUFFER
TMPUPT   DC    F'0'           POINTER TO THE UPT
TMPPSCB  DC    F'0'           POINTER TO PSCB
TMPECT   DC    F'0'           POINTER TO ECT
         EJECT
STAEWORK DSECT
         SPACE 1
*        THIS IS A DSECT OF THE WORK AREA PASSED TO THE IKJEHSIR
*        ROUTINE BY ASIR.  IT IS USED ONLY TO OBTAIN THE PARAMETER
*        ADDRESS PASSED BY THE USER TO THE STAE SVC.
         SPACE 1
STAEEXIT DC    F'0'           EXIT ROUTINE PARAMETER, PARAM=
STAECODE DC    F'0'           ABEND COMPLETION CODE
STAEPSW  DC    D'0'           PSW AT ABEND TIME
STAEPSWP DC    D'0'           LAST P/P PSW
STAEREGS DC    16F'0'         REGS AT TIME OF ABEND
STAEPGM  DC    CL8' '         NAME OF ABENDING PROGRAM
STAEENT  DC    F'0'           ENTRY POINT OF ABENDING PGM
STAEPAD  DC    F'0'           PADDING
         SPACE 1
STAELNTH EQU   *-STAEWORK     LENGTH OF THE WORK AREA
         MEND

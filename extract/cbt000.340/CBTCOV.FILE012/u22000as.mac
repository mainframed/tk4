DGN1     TITLE 'MVTDEBE PROGRAM - D NORRIS - AMENDED BY G NEVILL'
***********************************************************************
*                                                                     *
*                              MVTDEBE                                *
*     A GENERAL PURPOSE UTILITY PROGRAM FOR CARD AND TAPE HANDLING    *
*                                                                     *
* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
*                                                                     *
*        CC    CARD TO CARD                                           *
*        CP    CARD TO PRINTER                                        *
*        CT    CARD TO TAPE        UNBLOCKED                          *
*        CTB   CARD TO TAPE        BLOCKED                            *
*        TC    TAPE TO CARD        PUNCH 1ST 80 BYTES OF EACH BLOCK   *
*        TCB   TAPE TO CARD        PUNCH ALL CHARACTERS OF BLOCK      *
*        TP    TAPE TO PRINTER     CHAR 1 TO 99999 RECORDS            *
*        TPB   TAPE TO PRINTER     CHAR 1 TO 99999 RECORDS  BACKWARDS *
*        TD    TAPE TO PRINTER     HEX  1 TO 99999 RECORDS            *
*        TDB   TAPE TO PRINTER     HEX  1 TO 99999 RECORDS  BACKWARDS *
*        AP    TAPE TO PRINTER     CHAR 1 TO 99999 RECORDS  ASCII     *
*        AD    TAPE TO PRINTER     HEX  1 TO 99999 RECORDS  ASCII     *
*        TT    TAPE TO TAPE        1 TO 99999 FILES                   *
*        SR    SPACE RECORDS       FORWARD SKIP 1 TO 99999 RECORDS    *
*        BS    BACKSPACE RECORDS  BACKWARD SKIP 1 TO 99999 RECORDS    *
*        SF    SPACE FILE          FORWARD SKIP 1 TO 99999 FILES      *
*        BF    BACKSPACE FILES    BACKWARD SKIP 1 TO 99999 FILES      *
*        RW    REWIND TAPE                                            *
*        WT    WRITE TAPE MARK                                        *
*        WTL   INITIALISE TAPE     WRITE VOLUME LABEL                 *
*                                                                     *
* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
*                                                                     *
*                      DD CARDS REQUIRED                              *
*                                                                     *
* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
*                                                                     *
*        IEFRDER             FIRST TAPE UNIT                          *
*        SYSTAPE1            SECND TAPE UNIT                          *
*        SYSPRINT            SPECIFY BLOCKSIZE MULT OF 133            *
*        SYSPUNCH            MUST BE REAL OR PSEUDO CARD PUNCH        *
*        SYSIN               MUST BE REAL OR PSEUDO CARD READER       *
*                                                                     *
***********************************************************************
         EJECT
MVTDEBE  START 0
R0       EQU   0
R1       EQU   1
R2       EQU   2
R3       EQU   3
R4       EQU   4
R5       EQU   5
R6       EQU   6
R7       EQU   7
R8       EQU   8                   LINECOUNT
R9       EQU   9                   LINK 3 PRINT ROUTINE
R10      EQU   10                  LINK 1
R11      EQU   11                  LINK 2
R12      EQU   12                  BASE 1
R13      EQU   13                  BASE 2
R14      EQU   14
R15      EQU   15
         USING MVTDEBE,15
         B     AROUND
         DC    X'07'
         DC    C'MVTDEBE'
AROUND   DS    0H
         SAVE  (14,12)
BEGIN    BALR  12,0
         USING *,12
BEGIN1   EQU   *
         USING SAVEAREA,13        ESTABLISH 13 AS BASE REG AND SAVE    X
               AREA POINTER
         LA    14,SAVEAREA-1
         LA    14,1(,14)          REG 14 NOW POINTS TO SAVE AREA
         ST    13,4(,14)          STORE BACK CHAIN POINTER
         ST    14,8(,13)          STORE FORWARD CHAIN POINTER
         LR    13,14              REG 13 NOW BASE AND SAVE POINTER
         SPACE 1
*  GET OS POINTERS
         L     3,16               GET CVT POINTER
         L     2,0(0,3)           GET POINTER TO TCB POINTERS
         L     3,4(0,2)           GET TCB POINTER
*  GET PROTECT KEY FROM TCB FOR THE DEB'S
         OC    INDEB+24(1),28(3)
         OC    OUTDEB+24(1),28(3)
*  STORE TCB ADDRESS INTO DEBS
         ST    3,INDEB
         ST    3,OUTDEB
*  GET TIOT ADDRESS
         L     2,12(,3)           GET ADDRESS OF TIOT
         ST    2,TIOTADR          STORE IT
*  WRITE 'REPLY EOJ' MESSAGE
         WTO   'OEH801I REPLY EOJ TO END MVTDEBE'
         SPACE 1
*  WRITE 'REPLY STOP' MESSAGE
*     NOTE THAT NO WAIT IS ISSUED
         SPACE 1
TERMMSG  NI    JECB,X'00'               CLEAR ECB
         WTOR  'OEH802I REPLY STOP TO END FUNCTION',JOB,4,JECB
         SPACE 1
*  ALL ROUTINES RETURN HERE WHEN THEY ARE FINISHED.
         SPACE 1
ASKAGN   EQU   *
NEWNAME  NI    INIOB,X'3F'
         NI    OUTIOB,X'3F'
*  RESET TAPE DUMP SWITCHES
         NI    TD3+1,X'0F'        SET BC 0 TO BC 15
         NI    TD6+1,X'0F'
         EJECT
*  WRITE 'REPLY PROG ID' MESSAGE
         MVI   ID+2,C' '           CLEAR REPLY ID
         WTOR  'OEH803D REPLY PROG ID - XX',ID,3,REPLYECB
         BAL   11,WAITANS         BRANCH TO WAIT ROUTINE
         SPACE 1
*  INTERPRET PROGRAM ID
         SPACE 1
         OC    ID(3),=CL10' '           MAKE ALL CAPS
         CLC   ID(3),=C'EOJ'
         BE    EOJ
         CLC   ID(3),=C'WTL'
         BE    WTL
         CLC   ID(3),=CL3'TCB'
         BE    TCB
         CLC   ID(3),=C'CTB'
         BE    CTB
         CLC   ID(2),=C'BF'
         BE    BF
         CLC   ID(2),=C'BS'
         BE    BS
         CLC   ID(2),=C'CC'
         BE    CC
         CLC   ID(2),=C'CP'
         BE    CP
         CLC   ID(2),=C'CT'
         BE    CT
         CLC   ID(2),=C'RW'
         BE    RW
         CLC   ID(2),=C'SF'
         BE    SF
         CLC   ID(2),=C'SR'
         BE    SR
         CLC   ID(2),=C'TC'
         BE    TC
         CLC   ID(2),=C'TD'
         BE    TD
         CLC   ID(2),=C'TP'
         BE    TP
         CLC   ID(2),=C'TT'
         BE    TT
         CLC   ID(2),=C'WT'
         BE    WT
         CLC   ID(2),=C'AP'
         BE    AP
         CLC   ID(2),=C'AD'
         BE    AD
         WTO   'OEH804I BAD ID - TRY AGAIN'
         B     ASKAGN
         EJECT
*  END OF JOB ROUTINE
         SPACE 1
*  RELOAD SAVE AREA POINTER
EOJ      L     13,4(0,13)
         RETURN (14,12),RC=0
         EJECT
*  BACKSPACE A FILE ON TAPE
         SPACE 1
BF        EQU   *
         BAL   10,TPOUTSET        GO GET OUTPUT TAPE
         MVC   OUTCCW+8(8),BFCCW      MOVE BACKSPACE CCW TO OUTPUT IOB
         B    SFEXCP
         SPACE 1
*  FORWARD SPACE A FILE ON TAPE
         SPACE 1
SF       EQU   *
         BAL   10,TPOUTSET      GO GET OUTPUT TAPE
         MVC   OUTCCW+8(8),SFCCW  MOVE FORWARD SPACE CCW TO IOB
SFEXCP   EQU   *
         LA    R1,FILEM            POINT TO FILES MSG
         BAL   R10,ASKNUM          ASK FOR NUMBER
         MVC   OUTCCW+16(8),=X'0300000020000001'  MODE SET NO-OP
         BAL   11,IOOUT           GO SPACE THE FILE
         CLI   OUTECB,X'7F'       WAS I/O SUCCESSFUL
         BNE   *+8                 GO CHECK ERRORS
         BCT   R6,IOOUT            LOOP R6 TIMES
         TM    OUTSTAT+4,X'02'   BACKED INTO LOAD POINT
         BC    1,TAPERR    YES, BRANCH
         B     ASKAGN
         EJECT
*  BACKSPACE NNNN RECORDS ON TAPE
         SPACE 1
BS       EQU   *
         SPACE 1
*  SKIP NNNN RECORDS ON TAPE
         SPACE 1
SR       EQU   *
         BAL   10,TPOUTSET        GO GET OUTPUT TAPE
         LA   R1,SKIPRECM          POINT TO RECORDS QUESTION
         BAL  R10,ASKNUM           GET ANSWER IN R6
         CLC   ID(2),=C'SR'       WAS REQUEST SKIP RECORDS
         BE    SREX               FALL THROUGH FOR BACKSPACE
BSEX     MVC   OUTCCW+8(8),BSCCW  MOVE BACKSPACE CCW TO OUTPUT IOB
BSEX2    MVC   OUTCCW+16(8),=X'0300000020000001' MODE SET NO-OP
BSAGN    EQU   *
         BAL   11,IOOUT           GO SPACE THE FILE
         CLI   OUTECB,X'7F'       WAS IT A SUCCESS
         BE    BCT6
         TM    OUTSTAT+4,X'02'      AT LOAD POINT
         BC    1,TAPERR      YES, BRANCH
BCT6     EQU   *
         BCT   6,BSAGN            DECREMENT, TEST REC NO
         B     ASKAGN
SREX     MVC   OUTCCW+8(8),SRCCW  MOVE FORWARD SPACE CCW TO OUTPUT IOB
         B     BSEX2
         EJECT
*  CARD TO CARD REPRODUCE
         SPACE 1
CC       EQU   *
         MVI   INMODSTK,X'41'     SELECT STACKER 1
         MVI   INDEVT,X'41'       INPUT = 2540
         MVC   DDNAME(8),=CL8'SYSIN'  MOVE DDNAME
         BAL   6,TIOTSCAN         GET UCB ADDRESS
         ST    2,INDEBMOD         STORE UCB ADDRESS IN DEB
         MVI   OUTMDSTK,X'41'     SELECT STACKER 1
         MVI   OUTDEVT,X'42'      OUTPUT = 2540 PUNCH
         MVC   DDNAME(8),=C'SYSPUNCH'  MOVE DDNAME
         BAL   6,TIOTSCAN         GO GET UCB ADDRESS
         ST    2,OUTDEBMD         STORE UCB ADDRESS INTO DEB
         MVC   INCCW(8),CP1CCW    MOVE READ CCW TO INPUT IOB
         MVC   OUTCCW(8),CTCCW    MOVE PUNCH CCW TO OUTPUT IOB
CCLOOP   EQU   *
         BAL   11,IOIN            READ A CARD
         CLI   INECB,X'7F'        WAS INPUT A SUCCESS
         BE    CC1
         TM    INSTAT+4,X'01'    EOF
         BC    1,ASKAGN    YES
         B     RDRERROR
CC1      EQU   *
         BAL   11,IOOUT           PUNCH A CARD
         CLI   OUTECB,X'7F'       WAS OUTPUT A SUCCESS
         BE    CCLOOP
*
PCHERROR EQU   *
         WTO   'OEH806I PUNCH ERROR - STOP'
         B     ASKAGN
         EJECT
*  CARD TO PRINTER - 80/80 LIST
         SPACE 1
CP       EQU   *
*  SET UP READER'S DCB AND DEB
         MVI   INMODSTK,X'41'     SELECT STACKER 1
         MVI   INDEVT,X'41'       INPUT = 2540 READER
         MVC   DDNAME(8),=CL8'SYSIN'  MOVE DDNAME
         BAL   6,TIOTSCAN         GO GET UCB ADDRESS
         ST    2,INDEBMOD         STORE UCB ADDRESS INTO DEB
         BAL   9,OPENPRNT         GO OPEN PRINTER
CP2      EQU   *
         XC    PAGECT(2),PAGECT    CLEAR PAGE COUNT
         MVC   HEAD+1(2),ID        MOVE IN COMMAND
         BAL   R9,SKIPTO1          PRINT HEADING
*  SET UP READER CCW
CPGO     MVC   INCCW(8),CP1CCW    MOVE READ CCW TO INPUT IOB
CPLOOP   EQU   *
         BAL   11,IOIN            READ A CARD
         CLI   INECB,X'7F'        INPUT A SUCCESS
         BE    CP1
         TM    INSTAT+4,X'01'      EOF?
         BC    1,ASKAGN
RDRERROR EQU   *
         WTO   'OEH807I READER ERROR - STOP'
         B     ASKAGN
CP1      EQU   *
         MVC   TDOUTAR(80),TDAREA  MOVE CARD TO PRINT AREA
         MVC   TDOUTAR+80(52),=CL52' '  CLEAR REST OF PRINT AREA
         BAL   9,TDPRINT          PRINT A LINE
         B     CPLOOP
         EJECT
*  CARD TO TAPE
         SPACE 1
CT       EQU   *
*  SET UP READER'S DCB AND DEB
         MVI   INMODSTK,X'41'     SELECT STACKER 1
         MVI   INDEVT,X'41'       INPUT IS A 2540
         MVC   DDNAME(8),=CL8'SYSIN'  MOVE DDNAME
         BAL   6,TIOTSCAN         GET UCB ADDRESS
         ST    2,INDEBMOD         STORE UCB ADDRESS INTO DEB
         MVC   INCCW(8),CP1CCW    MOVE READ CCW TO INPUT IOB
*  SET UP TAPE'S DCB AND DEB
         BAL   10,TPOUTSET        GO TO 'OUTPUT TAPE' MESSAGE
         MVC   OUTCCW+8(8),CTCCW  MOVE WRITE CCW TO OUTPUT IOB
         SR    2,2                SET CARD COUNT TO ZERO
CTLOOP   EQU   *
         BAL   11,IOIN            READ A CARD
         CLI   INECB,X'7F'        READ A SUCCESS
         BE    CT1
         TM    INSTAT+4,X'01'     CHECK UNIT EXCAPTION - EOF
         BC    1,CTEOJ1
         B     RDRERROR
CT1      EQU   *
         LA    2,1(2)             INCREMENT CARD COUNT
         BAL   11,IOOUT           WRITE A TAPE
         CLI   OUTECB,X'7F'       WRITE A SUCCESS
         BE    CTLOOP
         B     TAPERR
         SPACE 1
*  DISPLAY CARD COUNT
         SPACE 1
CTEOJ1   EQU   *
         BAL   R10,DSPLYCNT        DISPLAY R2 RECORD COUNT
*  PREPARE TO WRITE TAPE MARK
CTEOJ    EQU   *
         BAL   R10,WTM             GO WRITE TAPE MARK
         B     ASKAGN
WTM      DS    0H                  TAPE MARK WRITER
         MVC   OUTCCW+8(8),WTCCW  MOVE TAPE MARK CCW TO OUTPUT IOB
         OI    OUTCCW+12,X'60'    TURN ON CHAIN FLAG
         MVC   OUTCCW+16(8),=X'0300000020000001' MODE SET NO-OP
         BAL   11,IOOUT           WRITE A TAPE MARK
         CLI   OUTECB,X'7F'       WAS IT A SUCCESS
         BNE   TAPERR
         BR    R10                 RETURN TO CALLER
         EJECT
         SPACE 1
*  CARD TO TAPE, BLOCKED
         SPACE 1
CTB      EQU   *
*  SET UP READER DCB, DEB AND IOB
         MVI   INMODSTK,X'41'     SELECT STACKER 1
         MVI   INDEVT,X'41'       DEVICE = 2540
         MVC   DDNAME(8),=CL8'SYSIN'  MOVE DDNAME
         BAL   6,TIOTSCAN         GO GET UCB ADDRESS
         ST    2,INDEBMOD         STORE UCB ADDRESS INTO DEB
*  SET UP OUTPUT DCB, DEB AND IOB
         BAL   10,TPOUTSET        GO TO 'OUTPUT TAPE' MESSAGE
*  GO GET OUTPUT BLOCKSIZE
         LA    R1,BLKSIZEM         POINT TO BLOCKSIZE QUESTION
         BAL   R10,ASKNUM          GO GET ANSWER IN R6
*  INITIALIZE FOR LOOP
         SR    2,2                SET CARD COUNT TO ZERO
         MVC   OUTCCW+8(8),CTCCW  MOVE WRITE CCW TO IOB
         STH   R6,OUTCCW+14        STORE BLOCKSIZE AS BYTE COUNT
CTB2     SR    4,4                SET BLK COUNT TO ZERO
         MVC   INCCW(8),CTBCCW1   MOVE READ CCW TO IOB
CTBLOOP  EQU   *
         L     10,INCCW           LOAD FIRST WORD OF READ CCW
         A     10,=F'80'          ADD 80 TO DATA ADDRESS
         ST    10,INCCW           RESTORE UPDATED CCW
         BAL   11,IOIN            READ A CARD
         CLI   INECB,X'7F'        READ SUCCESSFUL
         BE    CTB1
         TM    INSTAT+4,X'01'     END OF FILE
         BC    1,CTBEOJ0
         B     RDRERROR
CTB1     EQU   *
         LA    2,1(,2)            INCREMENT CARD COUNT
         A     4,=F'80'           ADD 80 TO BLK COUNY
         CR    R4,R6               COMPARE BLK COUNT TO BLKSIZE
         BC    4,CTBLOOP          LOOP IF BLK COUNT LESS
CTBWRITE EQU   *
         BAL   11,IOOUT           WRITE TAPE
         CLI   OUTECB,X'7F'       WAS WRITE A SUCCESS
         BNE   TAPERR
         B     CTB2
CTBEOJ0  EQU   *
         STH   4,OUTCCW+14        STORE TRUNCATED BYTE COUNT
         BAL   11,IOOUT           WRITE TRUNCATED BLOCK
         CLI   OUTECB,X'7F'       WAS IT SUCCESSFUL
         BNE   TAPERR
         B     CTEOJ1             BRANCH TO CLOSING ROUTINE
         EJECT
*  TAPE TO CARD,  JUST PUNCH THE FIRST 80 BYTES OF THE INPUT RECORD
         SPACE 1
TC       EQU   *
         BAL   10,TAPINSET        GO GET THE INPUT TAPE
         MVC   INCCW+8(8),TDINCCW TAPE READ CCW TO IOB
         MVI   OUTDEVT,X'42'      OUTPUT = 2540 PUNCH
         MVI   OUTMDSTK,X'41'     SELECT STACKER 1
         MVC   DDNAME(8),=C'SYSPUNCH'  MOVE DDNAME
         BAL   6,TIOTSCAN         GO GET UCB ADDRESS
         ST    2,OUTDEBMD         STORE UCB ADDRESS INTO DEB
         MVC   OUTCCW(8),CTCCW    MOVE PUNCH CCW TO OUTPUT IOB
TCLOOP   EQU   *
         BAL   11,IOIN            READ A TAPE
         CLI   INECB,X'7F'        WAS IT A SUCCESS
         BE    TC1
         TM    INSTAT+4,X'01'      EOF
         BC    1,ASKAGN
         B     TAPERROR
TC1      EQU   *
         BAL   11,IOOUT           PUNCH A CARD
         CLI   OUTECB,X'7F'       WAS IT A SUCCESS
         BE    TCLOOP
         B     PCHERROR
         EJECT
*  TAPE TO CARD, BLOCKED - IN WHICH THE ENTIRE TAPE RECORD IS PUNCHED
         SPACE 1
TCB      EQU   *
*  SET UP TAPE DCB AND IOB
         BAL   10,TAPINSET        GO TO 'INPUT TAPE' MESSAGE
         MVC   INCCW+8(8),TDINCCW  MOVE TAPE READ CCW TO IOB
*  SET UP PUNCH DCB, DEB AND IOB
         MVI   OUTDEVT,X'42'      DEVICE = 2540 PUNCH
         MVI   OUTMDSTK,X'41'     SELECT STACKER 1
         MVC   DDNAME(8),=CL8'SYSPUNCH'  MOVE DDNAME
         BAL   6,TIOTSCAN         GO GET UCB ARRESS
         ST    2,OUTDEBMD         STORE UCB ADDRESS INTI DEB
*  INITIALIZE FOR LOOP
         SR    2,2                SET CARD COUNT TO ZERO
TCB2     SR    4,4                SET BLK COUNT TO ZERO
         MVC   OUTCCW(8),CTCCW    MOVE PUNCH CCW TO OUT IOB
         SPACE 1
TCBLOOP  EQU   *
         BAL   11,IOIN            READ TAPE
         CLI   INECB,X'7F'        WAS READ A SUCCESS
         BE    TCB3
         TM    INSTAT+4,X'01'     CHECK FOR EOF
         BC    1,TCBEOJ
         B     TAPERROR
TCB3     LH    9,=H'32767'        LOAD READ CCW BYTE COUNT
         SH    9,INSTAT+6         SUBTRACT RESIDUAL BYTE COUNT, NOW
*                                 WE HAVE BLK SIZE IN REG 9
TCB1     BAL   11,IOOUT           PUNCH A CARD
         CLI   OUTECB,X'7F'       WAS IT A SUCCESS
         BNE   PCHERROR
         LA    2,1(,2)            INCREMENT CARD COUNT
         A     4,=F'80'           ADD 80 TO BLK COUNT
         CR    4,9                COMPARE BLK COUNT WITH BLK SIZE
         BE    TCB2
         BC    2,TCB4             BRANCH IF BLK COUNT HIGH
         L     10,OUTCCW          LOAD FIRST WORD OF PUNCH CCW
         A     10,=F'80'          ADD 80 TO DATA ADDRESS
         ST    10,OUTCCW          RESTORE UPDATED CCW
         B     TCB1
         SPACE 1
*   ROUTINE FOR BLK SIZE A NON MULTIPLR OF 80
TCB4     EQU   *
         WTO   'OEH814I LAST CARD PUNCHED NOT 80 BYTES'
         WTOR  'EOH815D REPLY STOP OR GO',JOB,4,REPLYECB
         BAL   11,WAITANS         GO WAIT FOR REPLY
         CLC   JOB(4),=CL4'STOP'  ANSWER = 'STOP'
         BNE   TCB2
         OI    JECB,X'40'         SET TERMINATE FLAG
         BAL   11,IOOUT           GO TERMINATE
         SPACE 1
*  PRINT CARD COUNT AND EXIT
TCBEOJ   EQU   *
         BAL   R10,DSPLYCNT        DISPLAY R2 RECORD COUNT
         B ASKAGN
*
*  EDIT R2 COUNT INTO MESSAGE AND WRITE TO OPERATOR
*
DSPLYCNT DS    0H
         MVC   COUNT(6),=X'402020202020'  FORM EDIT MASK
         CVD   2,TDWK             CONVERT CARD COUNT TO HEX
         ED    COUNT(6),TDWK+5    EDIT CARD COUNT
         LA    1,MESSAGE          LOAD MESSAGE ADDRESS
         SVC   35                 PRINT CARD COUNT
         BR    R10                 RETURN
         EJECT
*  PRINT A TAPE
         SPACE 1
TP       EQU   *
*  TP USES THE TD ROUTINE WITHOUT THE HEX-TO-CHARACTER CONVERSION
         OI    TD3+1,X'F0'        SET BRANCHES TO BC 15
         OI    TD6+1,X'F0'
         SPACE 1
*  PRINT A TAPE IN HEX
         SPACE 1
TD       EQU   *
         BAL   9,OPENPRNT         OPEN THE PRINTER
*  SET UP TAPE'S DCB AND DEB
         BAL   10,TAPINSET        GO GET THE INPUT TAPE
         MVC   INCCW+8(8),TDINCCW MOVE READ CCW TO INPUT IOB
         CLI   ID,C'A'             ASCII MODE
         BNE   *+12                GO SET OFF TRANSLATE
         NI    AD6+1,X'0F'         SET TO NOP
         B     *+8
         OI    AD6+1,X'F0'         SET TO BRANCH
         OI    TDB1+1,X'F0'        SWITCH OFF READ BACKWARDSW
         CLI   ID+2,C'B'           WAS BACKWARDS REQUESTED
         BNE   TDHEAD
         MVC   INCCW+8(8),TDCCWBAK MOVE IN READ BACKWARDS CCW
         NI    TDB1+1,X'0F'        NOP BRANCH               W
TDHEAD   DS    0H
         XC    PAGECT(2),PAGECT    CLEAR PAGE COUNT
         MVC   HEAD+1(3),ID        MOVE IN COMMAND
         BAL   R9,SKIPTO1          PRINT HEADING
         SP    RECCNT(3),RECCNT(3) SET RECORD COUNT TO ZERO
         LA    R1,PRECM            HOW MANY
         BAL   R10,ASKNUM          BLOCKS TO PRINT
TDLOOP   EQU   *
         BAL   11,IOIN            GO READ THE TAPE
         CLI   INECB,X'7F'        WAS IT SUCCESSFUL
         BE    TD1
         TM    INSTAT+4,X'01'     TEST FOR EOF
         BC    1,TDEOJ
         B     TAPERROR
TD1      LH    2,INSTAT+6          GET RESIDUAL COUNT
         LH    3,TDINCCW+6         GET BEGINING COUNT
         SR    3,2                 GET BYTES READ IN
         CVD   3,TDWK             STORE RECORD LENGTH
         MVI   TDOUTAR,C' '       CLEAR THE PRINT AREA
         MVC   TDOUTAR+1(131),TDOUTAR
         EDIT  TDOUTAR+126,TDWK+5,'XXXX0'
         AP    RECCNT(3),COND1(1) ADD 1 TO RECORD COUNT
         EDIT  TDOUTAR+121,RECCNT,'XXXX0'
         LA    2,TDAREA           LOAD ADDRESS OF TAPE AREA
         LA    5,TDAREA
         LA    R7,80               LOAD NO OF CHARS PER LINE
*                                  LOAD 80 FOR TP 40 FOR TD
TDB1     B     AD6                 NOP IF READ BACKWARDS
         AH    R2,TDCCWBAK+6       POINT TO END OF BUFFER
         SR    R2,R3               POINT BACK TO START OF RECORD
         LR    R5,R2               POINT R5   TO START OF RECORD
AD6      B     TD6                 CHANGED TO NOP IF ASCII
         CLI   ID+1,C'P'           CHARACTER FORMAT
         BE    APTR                GOTRANSLATE 80
         TR    0(40,R2),ASCIITAB   TRANSLATE TO EBCDIC
         B     TD6
APTR     TR    0(80,R2),ASCIITAB   TRANSLATE TO EBCDIC
TD6      BC    0,TD7              BC 15 FOR TP, BC 0 FOR TD
*  FOLLOWING UNPACKS FOR TD
*  R2 POINTS TO THE INPUT AREA
*  R5 POINTS TO THE OUTPUT AREA
         L     5,=A(TDAREA2)      LOAD ADDRESS OF WORK AREA
         LA    R7,40               LOAD NO OF CHARS PER LINE
         MVC   TDOUTAR+82(40),0(2) MOVE IN EBCDIC
         BAL   R9,TDTR             REMOVE SPECIAL CHARACTERS
         BAL   14,UNPK            GO FORMAT TAPE TO HEX REPRESENTATION
TD7      EQU   *
         CR    3,7                COMPARE REMAINING TAPE LENGTH WITH
*                                 PRINT WIDTH
         BL    TD3                BRANCH IF WILL FIT INTO PRINT LINE
         MVC   TDOUTAR(80),0(R5)   MOVE RECORD TO PRINT AREA
*                                 REG 5 POINTS TO TDAREA FOR TP
*                                 REG 5 POINTS TO TDAREA2 FOR TD
TDPR     EQU   *
         BAL   9,TDPRINT          GO PRINT A LINE
         MVI   TDOUTAR,C' '       CLEAR THE PRINT AREA
         MVC   TDOUTAR+1(131),TDOUTAR
         SR    3,7                SUBTRACT PRINT WIDTH FROM REMAINING
*                                 TAPE LENGTH
         BC    12,TD9             BRANCH IF ENTIRE TAPE REC HAS BEEN
*                                 PRINTED
         AR    2,7                ADD PRINT WIDTH TO INPUT AREA POINTER
         AR    5,7                SAME FOR OUTPUT AREA POINTER
         B     AD6
TD3      BC    0,TD4              BC 15 FOR TP, BC 0 FOR TD
         LR    11,3               LOAD REMAINING TAPE LENGTH
         AR    11,3          DOUBLE IT BECAUSE IT'S UNPACKED
         BCTR  11,0          DECREMENT ONE FOR THE MOVE
         EX    11,MVCOML          MOVE LAST OF TAPE TO PRINT AREA
         SR    R11,R3              SUBTRACT PRINT WIDTH
         MVC   TDOUTAR+82(40),=CL52' '
         EX    R11,MOVELAST        MOVE LAST EBCDIC TO PRINT LINE
         BAL   R9,TDTR             REMOVE SPECIAL CHARACTERS
         B     TDPR
TD4      EQU   *
         BCTR  3,0                DECREMENT LENGTH BY 1
         EX    3,MVCOML           MOVE TAPE TO PRINT AREA
         B     TDPR
MVCOML   MVC   TDOUTAR(0),0(5)
MOVELAST MVC   TDOUTAR+82(0),0(R2) MOVE TO BE EXECUTED
*  CONVERT TAPE FROM CHARACTER TO HEX
UNPK     EQU   *
         UNPK  0(15,5),0(8,2)
         UNPK  14(15,5),7(8,2)
         UNPK  28(15,5),14(8,2)
         UNPK  42(15,5),21(8,2)
         UNPK  56(15,5),28(8,2)
         UNPK  70(15,5),35(8,2)
         UNPK  84(15,5),42(8,2)
         UNPK  98(3,5),49(2,2)
         TR    0(100,5),TDPTABLE-240
         BR    14
TD9      EQU   *
         BAL   R9,SPACE1           SPACE THE PRINTER
         BCT   R6,TDLOOP           DO IT R6 TINIMES
         B     ASKAGN
TDEOJ    EQU   *
         MVC   TDOUTAR(11),=C'*TAPE MARK*'
         MVC   TDOUTAR+11(121),TDOUTAR
         BAL   R9,TDPRINT          GO PRINT TAPE MARK FOUND
         B     ASKAGN
         SPACE 3
TDTR     DS    0H
         MVI   TDOUTAR+81,C'*'     ENCLOSE EBCDIC
         MVI   TDOUTAR+122,C'*'    IN ATSERISKS
         TR    TDOUTAR+82(40),TDPRTAB
         BR    R9
         EJECT
*  TAPE TO TAPE COPY
         SPACE 1
TT       EQU   *
         BAL   10,TAPINSET        GO GET INPUT TAPE
         BAL   10,TPOUTSET        GO GET OUTPUT TAPE
         LA    R1,FILEM            POINT TO FILES MSG
         BAL   R10,ASKNUM          ASK FOR NUMBER IN R6
TTAGAIN  DS    0H
         MVC   INCCW+8(8),TTCCWIN  MOVE READ CCW TO INPUT IOB
         MVC   OUTCCW+8(8),TTCCWOUT MOVE WRITE CCW TO OUTPUT IOB
         SLR   R2,R2               CLEAR RECORD COUNTER
         LA    R11,TT2             SET RETURN ADDRESS
         B     IOIN                GO DO FIRST READ
TTLOOP   DS    0H
         LA    R2,1(,R2)           COUNT RECORDS WRITTEN
TT2      DS    0H
         CLI   INECB,X'7F'         WAS READ A SUCCESS
         BE    TT1                 DO NEXT IF SO
         TM    INSTAT+4,X'01'      EOF ?
         BC    1,TTEOJ             GO WRITE TM AND CHECK ALL DONE
TAPERROR DS    0H
         LA    R1,ITAPERRM         POINT TO INPUT ERR MSG
         B     WTO                 GO WRITE IT
TT1      DS    0H
         LH    R4,TTCCWIN+6        LOAD READ CCW BYTE COUNT
         SH    R4,INSTAT+6         TAKE OFF RESIDUAL COUNT
         STH   R4,OUTCCW+14        STORE RECD LENGTH IN OUTPUT CCW
         BAL   R11,IOINOUT         GO WRITE OUTPUT & READ INPUT
         CLI   OUTECB,X'7F'        WAS WRITE A SUCCESS
         BE    TTLOOP              YES DO IT AGAIN
TAPERR   DS    0H
         LA    R1,OTAPERRM         POINT TO OUTPUT ERROR MSG
WTO      DS    0H
         WTO   MF=(E,(1))          ISSUE MSG
         B ASKAGN
ITAPERRM WTO   'OEH808I INPUT TAPE ERROR - STOP',MF=L
OTAPERRM WTO   'OEH809I OUTPUT TAPE ERROR - STOP',MF=L
         SPACE 3
TTEOJ    DS    0H
         BAL   R10,WTM             GO WRITE TAPE MARK
         BAL   R10,DSPLYCNT        GO PRINT NUMBER OF RECORDS
         BCT   R6,TTAGAIN          GO DO NEXT FILE
         B     ASKAGN
         EJECT
*  REWIND A TAPE
         SPACE 1
RW       EQU   *
         BAL   10,TPOUTSET        GO GET OUTPUT TAPE
         MVC   OUTCCW+8(8),RWCCW  MOVE REWIND CCW TO OUTPUT IOB
         OI    OUTCCW+12,X'60'    TURN ON CHAIN FLAG
         MVC   OUTCCW+16(8),=X'0300000020000001' MODE SET NO-OP
         BAL   11,IOOUT           REWIND THE TAPE
         B     ASKAGN
         SPACE 3
*  WRITE A TAPE MARK
         SPACE 1
WT       EQU   *
         BAL   10,TPOUTSET        GO GET OUTPUT TAPE
         B     CTEOJ              GO WRITE THE TAPE MARK
         EJECT
*  WRITE A TAPE VOLUME LABEL
         SPACE 1
WTL      EQU   *
*  REWIND THE TAPE
         BAL   10,TPOUTSET        GO GET TAPE UNIT
         MVC   OUTCCW+8(8),RWCCW  MOVE REWIND CCW TO OUT IOB
         OI    OUTCCW+12,X'60'    SET ON COMMAND CHAIN AND SLI FLAG
         MVC   OUTCCW+16(8),=X'0300000020000001' MODE SET NO-OP
         BAL   11,IOOUT           REWIND THE TAPE
*  WRITE THE VOLUME LABEL
         MVI   TDAREA,X'40'       CLEAR THE IO AREA TO BLANKS
         MVC   TDAREA+1(79),TDAREA
         WTOR  'OEH816D REPLY VOLID - XXXXXX',TDAREA+4,6,REPLYECB
         BAL   11,WAITANS         WAIT FOR REPLY
         OC    TDAREA+4(6),=CL10' '     MAKE ALL CAPS
         WTOR  'OEH817D REPLY OWNER ID - CCCCCCCCC',                   X
               TDAREA+41,10,REPLYECB
         BAL   11,WAITANS         WAIT FOR REPLY
         OC    TDAREA+41(10),=CL10' '   MAKE ALL CAPS
         MVC   TDAREA(4),=C'VOL1'   MOVE IN VOL1
         MVI   TDAREA+10,X'F0'    MOVE IN 'NO SECURITY' FLAG
         MVC   OUTCCW+8(8),CTCCW  MOVE WRITE CCW TO OUT IOB
         BAL   11,IOOUT           WRITE THE VOLUME LABEL
*  WRITE A DUMMY HEADER LABEL
         MVC   TDAREA(3),=C'HDR'   MOVE IN HDR
         MVI   TDAREA+4,X'F0'     CLEAR REST OF LABEL TO ZERO
         MVC   TDAREA+5(75),TDAREA+4
         BAL   11,IOOUT           WRITE THE DUMMY HEADER LABEL
*  WRITE A TAPE MARK AND EXIT
         B     CTEOJ
         EJECT
*  TEST TO SEE IF PRINTER HAS BEEN OPENED
         SPACE 1
OPENPRNT EQU   *
         TM    OPENSW,X'FF'       IS THE PRINTER OPEN
         BC    1,OPENOK
         OPEN (PRINT,(OUTPUT))
         OI    OPENSW,X'FF'       TURN ON PRINTER OPEN SWITCH
OPENOK   BR    9
         SPACE 3
*  COMMON PRINT ROUTINE
         SPACE 1
TDPRINT  EQU   *
         TR    TDOUTAR(80),PRTABLE
         MVI   CTLCHAR,X'40'      INSERT SINGLE SPACE CONTROL CHAR
         PUT   PRINT,CTLCHAR      PRINT A LINE
         BCTR  R8,R9               RETURN IF NOT PAGE END
         SPACE 1
*  SKIP PRINTER TO CHANNEL 1
         SPACE 1
SKIPTO1  EQU   *
         LH    R1,PAGECT           PICK UP PAGECT
         LA    R1,1(R1)            ADD 1
         STH   R1,PAGECT
         CVD   R1,TDWK             EDIT INTO
         EDIT  PAGE,TDWK+5,'XX,XX0'          HEADING
         PUT   PRINT,HEAD
         LA    R8,60               RESET LINECT
         BR    R9                  RETURN
         EJECT
         SPACE 1
*  SPACE PRINTER ONE LINE
         SPACE 1
SPACE1   EQU   *
         MVI   CTLCHAR,X'40'      INSERT SPACE 1 CONTROL CHAR
         MVC   TDOUTAR(132),CTLCHAR  CLEAR PRINT LINE
         B     TDPRINT
         EJECT
*  ROUTINE TO CONVERT MM INTO A SET MODE COMMAND
         SPACE 1
CONVRTMM EQU   *
         STM   2,3,SAVEUM         STORE REGS 2 & 3
         IC    2,MM+1             INSERT SECOND MODE BYTE INTO REG 2
         TM    MM+1,X'F0'         IS THIS BYTE NUMERIC
         BC    1,MMMM1            BRANCH IF NUMERIC
         AH    2,=H'9'            ADD 9 TO CONVERT ALPHA TO HEX DIGIT
MMMM1    SRDL  2,4                SHIFT DIGIT OF BYTE TO REG 3
         IC    2,MM               INSERT FIRST MODE BYTE NEXT TO
*                                 DIGIT OF SECOND
         TM    MM,X'F0'           IS FIRST BYTE NUMERIC
         BC    1,MMMM2            BRANCH IF NUMERIC
         AH    2,=H'9'            ADD 9 TO CONVERT ALPHA TO HEX DIGIT
MMMM2    SLDL  2,4                SHIFT DIGITS NEXT TO EACH OTHER
         STC   2,MM               STORE MODE BYTE INTI MM
         LM    2,3,SAVEUM         RESTORE REGS 2 + 3
         BR    6
SAVEUM   DS    2F
         SPACE 3
         SPACE 3
*  ROUTINE TO ASK FOR THE INPUT TAPE
         SPACE 1
TAPINSET EQU   *
         WTOR  'OEH812D REPLY INPUT TAPE - MMXXX',MM,5,REPLYECB
         BAL   9,WAITAPE          GO WAIT FOR THE REPLY
         MVC   INTRTCH(1),MM      MOVE MODE BYTE INTO DCB
         MVI   INDEVT,X'81'       TAPE INDICATOR TO DCB
         ST    2,INDEBMOD         STORE UCB ADDRESS INTO DEB
         MVC   INDEBMOD(1),MM     MOVE MODE BYTE INTO DEB
         OI    INIOB,X'40'         SET ON CHAINING
         MVC   INCCW(1),MM        MOVE MODE BYTE INTO MODE SET CCW
         MVC   INCCW+1(7),=X'00000060000001' COMPLETE MODE SET CCW
         BR    10
         EJECT
*  ROUTINE TO ASK FOR THE OUTPUT TAPE
         SPACE 1
TPOUTSET EQU   *
         WTOR  'OEH813D REPLY OUTPUT TAPE - MMXXX',MM,5,REPLYECB
         BAL   9,WAITAPE
         MVC   OUTTRTCH(1),MM     MOVE MODE TO DCB RECORDING TECHNIQUE
         MVI   OUTDEVT,X'81'      SET TAPE INDICATOR IN DCB
         ST    2,OUTDEBMD         STORE UCB ARRESS INTO DEB
         MVC   OUTDEBMD(1),MM     MOVE MODE TO DEB + 32
         OI    OUTIOB,X'40'       SET COMMAND CHAIN FLAG IN IOB
         MVC   OUTCCW(1),MM       MOVE MODE INTO OUTPUT CCW 1
         MVC   OUTCCW+1(7),=X'00000060000001'  COMPLETE CCW 1
         BR    10
         EJECT
*  ASK OPERATOR FOR A NUMBER AND PLACE IN REGISTER 6
         SPACE 1
ASKNUM   DS    0H
         MVC   FINAL(10),REPLYMSK  CLEAR REPLY AREA
         WTOR  ,TEMP,5,REPLYECB,MF=(E,(1)) ISSUE REQUEST
         BAL   R11,WAITANS         WAIT FOR REPLY
         CLC   TEMP(4),=CL4'STOP'  ANSWER STOP
         BE    ASKAGN
REPROUND DS    0H
         MVC   FINAL(10),FINAL+1   SHIFT REPLY UP ONE
         CLI   TEMP,X'FF'          REACHED END OF REPLY
         BNE   REPROUND            SHIFT UP AGAIN
         PACK  TDWK,FINAL(5)       CONVERT NUMBER
         CVB   R6,TDWK             TO BINARY IN R6
         BR    R10
         EJECT
*  COMMON I/O ROUTINE FOR OUTPUT
         SPACE 1
IOOUT    EQU   *
         TM    JECB,X'40'         HAS STOP BEEN RECEIVED
         BO    TERMMSG
         XC    OUTECB(4),OUTECB   SET OUT ECB TO ZEROES
         EXCP  OUTIOB             PERFORM OUTPUT
         WAIT  ECB=OUTECB         WAIT FOR COMPLETION
         NI    OUTDCB+44,X'3F'    RESTORE DCB
         BR    11
         SPACE 3
*  COMMON I/O ROUTINE FOR INPUT
         SPACE 1
IOIN     EQU   *
         TM    JECB,X'40'         HAS STOP BEEN RECEIVED
         BO    TERMMSG
         XC    INECB(4),INECB     SET IN ECB TO ZEROES
         EXCP  INIOB              PERFORM THE INPUT
         WAIT  ECB=INECB          WAIT FOR COMPLETION
         NI    INDCB+44,X'3F'     RESTORE THE DCB
         BR    11
         SPACE 3
*  ROUTINE TO WRITE AND READ SIMULTANEOUSLY ON BOTH TAPES
*
IOINOUT  DS    0H
         TM    JECB,X'40'          HAS STOP BEEN RECEIVED
         BO    TERMMSG
         MVC   TEMPHOLD,INCCW+9    SWAP
         MVC   INCCW+9(3),OUTCCW+9      THE
         MVC   OUTCCW+9(3),TEMPHOLD         BUFFERS
         XC    OUTECB(4),OUTECB    ZEROIZE
         XC    INECB(4),INECB       ECBS
         EXCP  OUTIOB              FIRE UP
         EXCP  INIOB               CHANNEL PROGS
         WAIT  2,ECBLIST=ECBS      WAIT FOR BOTH
         NI    OUTDCB+44,X'3F'     RESTORE
         NI    INDCB+44,X'3F'       THE DCBS
         BR    R11                 RETURN
         EJECT
*  COMMON WAIT FOR ALL REPLIES
WAITANS  EQU   *
         WAIT  ECB=REPLYECB
         XC    REPLYECB(4),REPLYECB SET ECB TO ZEROES
         BR    11
         SPACE 3
*  ROUTINE TO WAIT ON THE REPLY AND CONVERT THE MM INTO A SET MODE
WAITAPE  EQU   *
         WAIT  ECB=REPLYECB
         XC    REPLYECB(4),REPLYECB SET ECB TO ZERO
         OC    MM(5),=CL10' '      MAKE ALL CAPS
         CLC   MM(4),=C'STOP'     WAS REPLY STOP
         BE    ASKAGN
         BAL   6,CONVRTMM         GO CONVERT MM TO MODE SET
         OI    MM,X'03'            SET MODE COMMAND NOW IN MM
         MVC   DDNAME(8),=CL8'IEFRDER'  MOVE DDNAME
         BAL   6,TIOTSCAN         GO GET UCB ADDRESS
         CLC   13(3,2),XXX        COMPARE UCB UNIT WITH REPLY UNIT
         BCR   8,9                BRANCH IF EQUAL
         MVC   DDNAME(8),=CL8'SYSTAPE1'  MOVE DDNAME
         BAL   6,TIOTSCAN         GO GET UCB ADDRESS
         CLC   13(3,2),XXX        COMPARE UCB UNIT WITH REPLY UNIT
         BCR   8,9                BRANCH IF EQUAL
         SPACE  3
BADEVICE EQU   *
         WTO   'OEH811I INVALID DEVICE'
         B     ASKAGN
         SPACE 1
APPEND   BR    14
         EJECT
*  SCAN TIOT FOR UCB ADDRESS
TIOTSCAN EQU   *
         SR    2,2                CLEAR REG 2
         L     3,TIOTADR          LOAD TIOT ADDRESS
         LA    3,24(,3)           SKIP TO FIRST DD ENTRY
*  SCAN FOR DDNAME
TIOTLOOP CLC   4(8,3),DDNAME      COMPARE TO DDNAME
         BE    TIOTUCB
         IC    2,0(,3)            INSERT ENTRY LENGTH
         AR    3,2                GET ADDRESS OF NEXT ENTRY
         CLI   0(3),X'00'         END OF TIOT
         BNE   TIOTLOOP
         WTO   'OEH818I INVALID DDNAME - EOJ'
         B     EOJ
*  GET UCB ADDRESS
TIOTUCB  LH    2,18(,3)           LOAD UCB ADDRESS
         BR    6
         EJECT
*  DCB FOR INPUT DATA SET
         SPACE 1                       Î
INDCB    DS    0F
         DC    4F'0'
INTRTCH  EQU   *
INMODSTK EQU   *
         DC    X'00'
INDEVT   DC    X'00'
INDENS   DC    X'00'
         DC    X'00'
         DC    5F'0'
         DC    H'0'
         DC    BL2'1101000000001000'
         DC    A(INDEB)
         DC    X'10000000'
         DC    5F'0'
         SPACE 1                       Î
*  DEB FOR INPUT DATA SET
         SPACE 1                       Î
INIOVEC  EQU   *
         DC    A(APPEND)
         DC    A(APPEND)
         DC    A(APPEND)
         DC    A(APPEND)
         DC    A(APPEND)
         DC    3F'0'
         DC    X'06000000'
INDEB    DS    0F
         DC    F'0'
         DC    X'04'
         DC    AL3(OUTDEB)
         DC    X'C0000000'
         DC    X'30000000'
         DC    2F'0'
         DC    X'0F'
         DC    AL3(INDCB)
         DC    X'02'
         DC    AL3(INIOVEC)
INDEBMOD DC    X'00'
INDEBUCB DC    X'000000'
         DC    F'0'
         SPACE 1                       9
*  ECB FOR INPUT DATA SET
         SPACE 1                       9
INECB    DC    F'0'
         SPACE 1
*  IOB FOR INPUT DATA SET
         SPACE 1
INIOB    DS    0F
         DC    X'0200'
INSENS   DC    H'0'
         DC    X'7F'
         DC    AL3(INECB)
INSTAT   DC    2F'0'
         DC    A(INCCW)
         DC    A(INDCB)
         DC    F'0'
         DC    H'1'
         DC    H'0'
INDASD   DC    X'00'
INSEEK   DC    XL7'00'
         SPACE 1
*  CCW'S FOR INPUT DATA SET
         SPACE 1
INCCW    DS    5D
         SPACE 3
*  DCB FOR OUTPUT DATA SET
         SPACE 1
OUTDCB   DS    0F
         DC    4F'0'
OUTTRTCH EQU   *
OUTMDSTK EQU   *
         DC    X'00'
OUTDEVT  DC    X'00'
OUTDENS  DC    X'00'
         DC    X'00'
         DC    5F'0'
         DC    H'0'
         DC    BL2'1101000000001000'
         DC    A(OUTDEB)
         DC    X'10000000'
         DC    5F'0'
         SPACE 1
*  DEB FOR OUTPUT DATA SET
         SPACE 1
OUTIOVEC EQU   *
         DC    A(APPEND)
         DC    A(APPEND)
         DC    A(APPEND)
         DC    A(APPEND)
         DC    A(APPEND)
         DC    3F'0'
         DC    X'06000000'
OUTDEB   DS    0F
         DC    F'0'
         DC    X'17000000'
         DC    X'C0000000'
         DC    X'30000000'
         DC    2F'0'
         DC    X'0F'
         DC    AL3(OUTDCB)
         DC    X'02'
         DC    AL3(OUTIOVEC)
OUTDEBMD DC    X'00'
OUTDBUCB DC    X'000000'
         DC    F'0'
         SPACE 1
*  ECB FOR OUTPUT DATA SET
         SPACE 1
OUTECB   DC    F'0'
         SPACE 1
*  IOB FOR OUTPUT DATA SET
         SPACE 1
OUTIOB   DS    0F
         DC    XL2'0200'
OUTSENS  DC    H'0'
         DC    X'7F'
         DC    AL3(OUTECB)
OUTSTAT  DC    2F'0'
         DC    A(OUTCCW)
         DC    A(OUTDCB)
         DC    F'0'
         DC    H'1'
         DC    H'0'
OUTDASD  DC    X'00'
OUTSEEK  DC    XL7'00'
         SPACE 1
*  CCW'S FOR OUTPUT DATA SET
         SPACE 1
OUTCCW   DS    5D
         SPACE 3
*  CONSTANTS AND CCW'S      * * * * * * * * * * * * * * * * * * * * *
         SPACE 3
JECB     DC    F'0'
JOB      DC    F'0'
TEMPHOLD DS    CL3
         SPACE 3
BFCCW    CCW   X'2F',SFCCW,X'60',1
BSCCW    CCW   X'27',BSCCW,X'60',1
CP1CCW   CCW   2,TDAREA,X'20',80
CP2CCW   CCW   9,TDAREA,X'20',80
CTCCW    CCW   1,TDAREA,X'20',80
RWCCW    CCW   7,RWCCW,X'20',1
SFCCW    CCW   X'3F',SFCCW,X'60',1
SRCCW    CCW   X'37',BSCCW,X'60',1
TDINCCW  CCW   2,TDAREA,X'20',32767
TTCCWIN  CCW   2,TTAREA,X'20',32767
TTCCWOUT CCW   1,TDAREA,X'20',32767
WTCCW    CCW   31,TDAREA,X'20',1
CTBCCW1  CCW   2,TDAREA-80,X'20',80
TDCCWBAK CCW   12,TDAREA+32766,X'20',32767   READ BACKWARDS
         SPACE 3
OPENSW   DC    X'00'
         SPACE 1
PRINT    DCB   DDNAME=SYSPRINT,MACRF=PM,DSORG=PS,RECFM=FBA,LRECL=133
         EJECT
TDWK     DS    D
SAVEAREA DC    18F'0'
BLKSIZE  DC    D'0'
LINECT   DC    H'0'
FINAL    DC    CL5'0'
TEMP     DC    CL5'0'
         DC    X'FF'
TDPTABLE DC    C'0123456789ABCDEF'
         DS    0F
MESSAGE  DC    AL2(THERE-*)     MESSAGE LENGTH
         DC    AL2(0)
         DC    C'OEH819I '
COUNT    DC    C'NUMBER '
         DC    C'RECORDS PROCESSED'
THERE    EQU   *
ID       DC    CL4' '              FUNCTION REQUESTED
MM       DC    C'00'
XXX      DC    C'000'
REPLYECB DC    F'0'
DDNAME   DC    D'0'
TIOTADR  DC    F'0'
ECBS     DC    A(OUTECB)
         DC    X'80',AL3(INECB)
CTLCHAR  DC    C' '
TDOUTAR  DS    CL132
RECCNT   DC    X'00000F'
COND1    DC    X'1F'
RECHDG   DC    C'REC '
         DC    X'2020202020'
         DC    C', LENGTH '
         DC    X'2020202020'
REPLYMSK DC    5C'0',5X'FF'        MASK FOR REPLY AREA
PAGECT   EQU   LINECT
HEAD     DC    CL112'1',C'PAGE'
PAGE     DC    CL17'PAGE NO RECD LGTH'
         EJECT
PRTABLE  DC    256X'40'            QN TRANSLATE TABLE
         ORG   PRTABLE+C'.'
         DC    C'.<(+×&&'
         ORG   PRTABLE+C'$'
         DC    C'$*);^-/'
         ORG   PRTABLE+C','
         DC    C',%_>?'
         ORG   PRTABLE+C':'
         DC    C':#@''="'
         ORG   PRTABLE+C'A'
         DC    C'ABCDEFGHI'
         ORG   PRTABLE+C'J'
         DC    C'JKLMNOPQR'
         ORG   PRTABLE+C'S'
         DC    C'STUVWXYZ'
         ORG   PRTABLE+C'0'
         DC    C'0123456789'
         ORG
         SPACE 3
TDPRTAB        DC 256C' '
         ORG   TDPRTAB+X'40'  0123456789ABCDEF
         DC                 C'           . (+ '
         DC                 C'            *)  '
         DC                 C'-/         ,    '
         DC                 C'              = '
         ORG   TDPRTAB+X'C0'  0123456789ABCDEF
         DC                 C' ABCDEFGHI      '
         DC                 C' JKLMNOPQR      '
         DC                 C'  STUVWXYZ      '
         DC                 C'0123456789      '
         ORG
         SPACE 3
ASCIITAB DC    256C' '             TRANSLATE TABLE FOR ASCII
         ORG   ASCIITAB  0 1 2 3 4 5 6 7 8 9 A B C D E F
         DC           X'00010203372D2E2F1605250B0C0D0E0F' 0
         DC           X'101112133C3D322618193F271C1D1E1F' 1
         DC           X'405A7F7B5B6C507D4D5D5C4E6B604B61' 2
         DC           X'F0F1F2F3F4F5F6F7F8F97A5E4C7E6E6F' 3
         DC           X'7CC1C2C3C4C5C6C7C8C9D1D2D3D4D5D6' 4
         DC           X'D7D8D9E2E3E4E5E6E7E8E94DE05D5F6D' 5
         DC           X'79818283848586878889919293949596' 6
         DC           X'979899A2A3A4A5A6A7A8A9C06AD0A107' 7
         ORG
         SPACE 3
         LTORG
SKIPRECM WTOR  'OEH805D REPLY NUMBER RECS TO SKIP - XXXXX',MF=L
BLKSIZEM WTOR  'OEH810D REPLY OUTPUT BLOCK SIZE - XXXXX',MF=L
FILEM    WTOR  'OEH820D REPLY NUMBER OF FILES - XXXXX',MF=L
PRECM    WTOR  'OEH821D REPLY NUMBER OF RECS TO PRINT - XXXXX',MF=L
         SPACE 3
TDAREA   DS    80CL250
         DS    40CL250
         DS    28CL100    32800 BYTES
TDAREA2  DS    CL101
TTAREA   DS    CL32800             TT SECOND BUFFER
AP       EQU   TP
AD       EQU   TD
         END   MVTDEBE

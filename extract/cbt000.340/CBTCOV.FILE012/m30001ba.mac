USING A SAVEAREA POOL IN A MODULAR ASSEMBLER PROGRAM
MOST MODULAR PROGRAMS HAVE A REGISTER SAVE AREA DEFINED WITHIN EACH MODU
THE NUMBER OF MODULES IN THE LONGEST 'PATH' IN MOST MODULAR PROGRAMS IS
CONSIDERABLY SMALLER THAN THE TOTAL NUMBER OF MODULES IN THE PROGRAM.  I
TOSSIBLE, THEREFORE, TO MAKE A SIGNIFICANT CORE SAVING IF CHAIN OF SAVE
IS ESTABLISHED AND EACH MODULE OBTAINS A SAVE AREA ONLY WHEN IT RECEIVES
WHEN THE MODULE RETURNS CONTROL TO THE CALLING MODULE, THE SAVEAREA IS R
TO THE POOL.
THREE MACROS HAVE BEEN WRITTEN WHICH:
(A) SET UP SAVEAREA POOL OF THE REQUIRED SIZE, GENERATE TWO ROUTINES, SA
AND SAVEUP, WHICH WILL HANDLE SAVEAREA CHAINING.
(B) PROVIDES STANDARD LINKAGE TO THE SAVEDOWN ROUTINE.
(C) PROVIDES STANDARD LINKAGE TO SAVEUP ROUTINE.
THESE MACROS ARE (A) SAVEAREA, (B) SAVEDOWN, (C) SAVEUP.  DO NOT USE
RBINIT, RBRETURN, SAVE OR RETURN MACROS IN CSECTS WHICH CONTAIN SAVEDOWN
SAVEUP;  DO NOT USE REGEQU, DO NOT DEFINE IN-LINE SAVE AREAS.  THE USE O
IS UNCHANGED.  A PROGRAM WHICH INCLUDES MODULES WHICH MAKE USE OF THE SA
POOL MAY INCLUDE MODULES WHICH DO NOT USE THE POOL.  THESE MAY BE COBOL,
INSTALLATION STANDARD ROUTINES OR ASSEMBLER MODULES WHICH DO NOT ISSUE S
AND SAVEUP.  (ALSO FORTRAM, PL/1).  THE MACROS ARE NOT IN A RE-ENTRANT
SITUATION.
SAVEAREA MACRO
SAVEAREA POOL=N
THE PARAMETER POOL=N SPECIFIES HOW MANY EIGHTEEN-FULLWORD SAVEAREAS ARE
BE ASSEMBLED IN THE SAVEAREA POOL.  IF THIS PARAMETER IS OMITTED, A DEFA
VALUE OF POOL=5 IS ASSUMED. THE NUMBER OF SAVE AREAS REQUIRED ON THE POO
SAME AS THE NUMBER OF MODULES WHICH USE THE POOL IN THE LONGEST POSSIBLE
OF THE PROGRAM.  IT MAY BE CONSIDERED DESIRABLE TO DEFINE A POOL WITH ON
MORE SAVEAREAS THEN ARE CALCULATED TO BE NECESSARY, THIS MIGHT SAVE ALTE
POOL SIZE IF ANOTHER MODULE WAS ADDES TO THE PROGRAM.
THIS MACRO GENERATES A CSECT NAMES SAVEAREA, WHICH HAS TWO ENTRY POINTS,
SAVEDOWN AND SAVEUP.  THESE ARE ROUTINES WHICH HANDLE REQUESTS FOR NEW
SAVEAREAS AND RETURN USED SAVEAREAS TO THE POOL. THE CSECT ALSO CONTAINS
SAVEAREA POOL AND NECESSARY CONTROL FIELDS.  A NUMBER OF LABELS, ALL PRE
SAV, ARE GENERATED;  PROGRAMMERS SHOULD AVOIS DUPLICATE LABELS BY NOT CO
LABELS PREFIXED IN THIS WAY.
THIS MACRO SHOULD BE CODED ONCE ONLY IN ANY PROGRAM.  IT MAY BE CODED
IN ANY ONE MODULE, BUT MAY NOT BE OVERLAID.  IT MAY BE SEPARATE MODULE I
DESIRED; THE PROGRAM WOULD NEED TO SUPPLY HIS OWN CSECT AND END CARDS,
AND INCLUDE THE MODULE AT LINKAGE EDIT TIME.  THE MACRO RESUMES THE CURR
CSECT.
SAVEDOWN MACRO
LABEL SAVEDOWN BASERE^=N
THE LABEL USED WITH THIS MACRO MUST BE PRESENT AND IS USED TO GENERATE
THE CSECT ASTATEMENT FOR THE MODULE. THE BASEREG = PARAMETER ALLOWS THE
PROGRAMMER TO SPECIFY THE BASE REGISTER TO BE USED IN THE MODULE.  BE DE
REGISTER TWELVE IS ESTABLISHED AS THE BASE REGISTER. THE BASE REGISTER M
SPECIFIED IN REGISTER EQUATE FORM, E.G. BASEREG=RB, OR AS A DECIMAL NUMB
BASEREG=11.
THE MACRO SHOULD BE ISSUED AT THE ENTRY POINT(S) OR ANY MODULE WHICH IS
TO MAKE USE OF THE POOL OF SAVEAREAS. THE MACRO DOES THE FOLLOWING:
1) ESTABLISHES THE CSECT USING THE LABEL SUPPLIED WITH THE MACRO AS CSEC
2) STORES THE CALLING MODULES REGISTERS IN THE CALLING SAVEAREA.
3) BRANCHES AND LINKS TO THE ROUTINE SAVEDOWN WHICH OBTAINS A NEW SAVEAR
THE POOL, CHAIN OLD AND NEW SAVEAREAS AND RETURNS WITH RESITER THIRTEEN
POINTING TO THE NEW SAVE AREA.
4) ESTABLISHES THE CSECT BASE REGISTER, AS DESCRIBING ABOVE.
5) THE FIRST INVOCATION OF THIS MACRO IN AN ASSEMBLY CAUSES REGISTER EQU
TO BE MADE (R0 TO RF); SUBSEQUENT INVOCATIONS OF THE MACRO BYPASS REGIST
EQUATION. THUS, IN A MODULE WHICH NEEDS TO HAVE A NUMBER OF CSECT'S, THE
MACRO MAY BE USED AT THE START OF EACH CSECT WITHOUT CAUSING REPETITION
REGISTER EQUATES.
SAVEUP MACRO
LABEL SAVEUP
THE USE OF A LABEL WITH THIS MACRO IS OPTIONAL. THE MACRO SHOULD BE
ISSUED AT THE LOGICAL EXIT POINT OF A CSECT IT MUST ONLY BE USED IF THE
CSECT WAS STARTED WITH A SAVEDOWN MACRO. THE MACRO MUST ONLY BE ISSUED W
REGISTER 13 CONTAINS THE VALUE GIVEN IT BY THE SAVEDOWN MACRO AT THE STA
THE CSECT.  SAVEUP BRANCHES TO THE SAVEUP ROUTINE WHICH RESTORES THE CAL
MODLUES REGISTERS, RETURNS THE CURRENT SAVE AREA TO THE POOL, ESTABLISHE
CALLING MODULE SAVEAREA AS THE CURRENT SAVE AREA , AND RETURNS TO THE CA
MODULE.
ERROR CONDITIONS
IF SAVEDOWN IS ISSUED WHEN THERE ARE NO FREE SAVEAREAS ON THE POOL, THE
JOB IS TERMINATED WITH THE MESSAGE 'SAVEDOWN CAUSED JOB TERMINATION - RE
MADE FOR A SAVEAREA WHEN NO AREA AVAILABLE'DISPLAYED ON THE PRINTER(SYST
THIS NORMALLY INDICATES THAT A LARGER SAVEAREA POOL IS REQUIRED; IT MIGH
INDICATE A PROGRAM LOGIC ERROR, FOR EXAMPLE SAVEDOWN NOT BEING FOLLOWED
A SAVEUP.  OTHER ERROR CONDITIONS INCLUDE ISSUING SAVEDOWN AND SAVEUP WH
NO SAVEAREA MACRO HAS BEEN CODED IN ANY MODULE IN THE PROGRAM, PROBABLY
GIVING AN OPERATION EXCEPTION IN LOW CORE; THE ABSENCE OF THE SAVEDOWN A
SAVEUP ROUTINES WILL BE SHOWN ON THE LINKAGE-EDITOR MAP. IF A SAVEUP MAC
IS ISSUED WHEN NO SAVEDOWN HAD BEEN ISSUED, THE RESULTS GENERALLY ARE
'UNPREDICTABLE',SIMILARLY, IF A SAVEUP IS ISSUED AND REGISTER THIRTEEN D
CONTAIN THE VALUE SET UP BY CORRESPONDING SAVEDOWN, RESULTS ARE
UNPREDICTABLE.
SAVEAREA, SAVEDOWN, SAVEUP - SUMMARY OF USE
THE SAVEAREA MACRO IS CODED ONCE ONLY IF ANY PROGRAM; A SAVEAREA POOL
IS GENERATED TOGETHER WITH THE CODE NEEDED TO SUPPORT THE SAVEDOWN AND
SAVEUP MACROS.
SAVEDOWN IS ISSUED AT THE ENTRY POINT(S) TO ANY EXECUTABLE MODULE; IT
GENERATES A CSECT, STORES REGISTERS, LINKS TO THE ROUTINE WHICH PROVIDES
NEW SAVEAREA, ESTABLISHES THE BASE REGISTER AND GENERATES REGISTER EQUAT
SAVEUP IS ISSUED AT THE LOGICAL EXIT POINT(S) IN A CSECT. IT GENERATES
A BRANCH TO THE ROUTINE WHICH RETURNS THE CURRENT SAVE AREA TO THE POOL,
RELOADS THE CALLING MODULES REGISTERS AND RETURNS TO THE CALLING MODULE.
SAVEDOWN AND SAVEUP MUST BOTH BE ISSUED IF EITHER IS ISSUED. DO NOT USE
SAVE, RETURN, RBINIT, RBRETURN, TPSAVE, TPRETRN OR REGEQU; DO NOT DEFINE
IN-LINE SAVE AREAS.
THESE MACROS ARE ONLY AVAILABLE TO OS ASSEMBLER PROGRAMS. IF THERE IS
SUFFICIENT DEMAND, DOS VERSION MAY EASILY BE PRODUCED.
MODULE TESTING
WHEN TESTING AN INDIVIDUAL MODULE (OR GROUP OF MODULES) WHICH ISSUES
SAVEDOWN AND SAVEUP, AND MODULE WITH A SAVEAREA CSECT MUST BE INCLUDED I
TEST. THE SIMPLEST WAY TO ACHIEVE THIS IS TO CODE THE SAVEAREA MACRO FOR
THE PROGRAM IN A SEPARATE MODULE, CATALOGUE THIS MODULE UNDER A SUITABLE
NAME, (N.B. NOT SAVEAREA), AND INCLUDE THIS MODULE WHEN TESTING ANY
INDIVIDUAL MODULE OF THE PROGRAM.

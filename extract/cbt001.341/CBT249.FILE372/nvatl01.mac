//NVATL01 JOB ,'VATLST DEFAULTS ZAP',CLASS=9,COND=(4,LT),TYPRUN=HOLD
/*PROCLIB NER.SP1IPO.CNTL
/*JOBPARM Q=F,I
//*
//ASM     EXEC PGM=IFOX00,REGION=256K,PARM='NODECK,NOLOAD,NOALIGN'
//SYSLIB   DD  DSN=SYS1.SMPMTS,DISP=SHR,DCB=BLKSIZE=6400,
//             VOL=SER=IPORES,UNIT=3330-1
//         DD  DSN=SYS1.AMODGEN,DISP=SHR,
//             VOL=SER=IPODLB,UNIT=3330-1
//         DD  DSN=SYS1.MACLIB,DISP=SHR,
//             VOL=SER=IPORES,UNIT=3330-1
//SYSUT1   DD  UNIT=SYSDA,SPACE=(CYL,(1,1)),DCB=BLKSIZE=1700
//SYSUT2   DD  UNIT=SYSDA,SPACE=(CYL,(1,1)),DCB=BLKSIZE=1700
//SYSUT3   DD  UNIT=SYSDA,SPACE=(CYL,(1,1)),DCB=BLKSIZE=1700
//SYSPRINT DD  DSN=&&LIST,DISP=(,PASS),UNIT=SYSDA,SPACE=(TRK,(20,20))
//SYSIN    DD  *
*ZAP CARD ++USERMOD(NVATL01)     /*
*ZAP CARD   PROBLEM:  DASD VOLUMES NOT IN VATLSTXX AT IPL ARE
*ZAP CARD             ASSIGNED A VOLUME STATUS OF PUBLIC.  VOLUMES
*ZAP CARD             NOT PERMANENTLY RESIDENT ARE MARKED REMOVABLE.
*ZAP CARD   SOLUTION: CHANGE NIP SO ALL VOLUMES NOT IN VATLSTXX ARE
*ZAP CARD             ASSIGNED THE PRIVATE ATTRIBUTE.  VOLUMES NOT
*ZAP CARD             PERMANENTLY RESIDENT ARE MARKED AS RESERVED.
*ZAP CARD             OFFLINE DEVICES ARE HANDLED AS BEFORE.
*ZAP CARD                                     */     .
*ZAP CARD ++VER(Z038) FMID(FBB1221) PRE(UZ33077) .
*ZAP CARD ++ZAP(IEAVAP00) .
*ZAP CARD  EXPAND IEAVAP00(50)
*ZAP CARD  NAME IEAVAP00
IEAVAP00 CSECT ,
         PRINT NOGEN
         IEFUCBOB
         PRINT GEN
IEAVAP00 CSECT ,
         SPACE 2
         PRINT DATA
         SPACE 2
TRAP     EQU   IEAVAP00+X'0236'   TRAP INTERCEPT ADDRESS
PATCH    EQU   IEAVAP00+X'4508'   PATCH AREA ADDRESS
@PSTART  EQU   IEAVAP00+X'0024'   BASE ADDRESS
         SPACE 3
         USING @PSTART,12
         USING @PSTART+4095,11
         USING @PSTART+8190,9
         USING @PSTART+12285,8
         USING @PSTART+16380,4
         SPACE 2
         USING UCBCMSEG,10        ADDRESSABILITY FOR UCB
         EJECT ,
*ZAP START VER
         SPACE
         ORG   TRAP               VERIFY INTERCEPT
         SPACE
         TM    UCBSTAT,UCBPRES    PERMANENTLY RESIDENT ?
BACKIN   EQU   *
         BNO   @RF00343
         OI    UCBSTAB,UCBBPUB    YES, TURN ON PUBLIC BIT
@RF00343 EQU   *
         SPACE 4
*ZAP START REP
         SPACE
         ORG   TRAP
         B     VATLTEST           BRANCH TO NEW CODE
         EJECT
*ZAP START VER
         SPACE
         ORG   PATCH              VERIFY PATCH AREA
         DC    11XL4'00'          SHOULD BE ZEROS
*ZAP START REP
         ORG   PATCH
VATLTEST EQU   *        ENTRY TO NEW CODE
         TM    UCBSTAT,UCBONLI    IS DEVICE ONLINE
         BO    VATLONLI           YES, SET UP NEW ATTRIBUTES
         TM    UCBSTAT,UCBPRES    ZAPPED INSTRUCTION
         B     BACKIN             RETURN TO MAINLINE CODE
*
VATLONLI EQU   *
         TM    UCBSTAT,UCBPRES    IS DEVICE PERMANENTLY RESIDENT
         BO    VATLPRIV
         OI    UCBSTAT,UCBRESV    NO, FORCE RESERVED
VATLPRIV EQU   *
         NI    UCBSTAB,255-UCBBPUB-UCBBSTR  RESET PUB/STOR BITS
         OI    UCBSTAB,UCBBPRV    SET PRIVATE BIT
         B     @RF00343           RETURN TO MAINLINE CODE
         SPACE 5
*ZAP CARD  IDRDATA NVATL01
*ZAP STOP
         END
//*
//LIST1   EXEC PGM=IEBGENER
//SYSPRINT DD  DUMMY
//SYSIN    DD  DUMMY
//SYSUT1   DD  DSN=&&LIST,DISP=(OLD,PASS)
//SYSUT2   DD  SYSOUT=A
//*
//ZAPPER  EXEC PL1XCG,TEST=
//PL1.SYSIN DD DSN=NER.SP1IPO.CNTL(ASMTOZAP),DISP=SHR
//GO.IN    DD  DSN=&&LIST,DISP=(OLD,DELETE)
//OUT      DD  DSN=&&PTFIN,DISP=(NEW,PASS),
//             SPACE=(TRK,(1,1)),UNIT=SYSDA,
//             DCB=(RECFM=FB,LRECL=80,BLKSIZE=3120)
//*
//LIST2   EXEC PGM=IEBGENER
//SYSPRINT DD  DUMMY
//SYSIN    DD  DUMMY
//SYSUT1   DD  DSN=&&PTFIN,DISP=(OLD,PASS)
//SYSUT2   DD  SYSOUT=A
//*
//ZAP     EXEC SMP4APLY
//SMPCNTL  DD *
 RESTORE S(NVATL01) .
 RESETRC .
 REJECT  S(NVATL01) .
 RESETRC .
 RECEIVE .
 APPLY   S(NVATL01) DIS(NO) .
//SMPPTFIN DD  DSN=&&PTFIN,DISP=(OLD,DELETE)

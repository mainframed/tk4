TITLE1 GTF ANALYSIS;
MACRO GTF_TIME
*  THERE ARE 21914 DAYS BETWEEN JAN 1,1900 AND JAN 1,1960
*  THERE ARE 86400 SECONDS IN A DAY
*  THERE ARE 1E6 MICRO SECONDS IN A SECOND;
FORMAT DATE WEEKDATE27. TIME TIME16.6;
   CNVRT = 21914*86400; *SECONDS BETWEEN JAN 1, 1900 AND JAN 1,1960;
*    EIGHT BYTES DIVIDED BY 4096 FOR BIT 51 =1 MICROSECONDS;
*    AND DIVIDED BY 1E6 TO CONVERT TO SECONDS (SAS TIME ALSO);
   TIME=TOD/(4096*1E6);
   GTFTIME=TIME-CNVRT;
   DATE=DATEPART(GTFTIME);
   TIME=TIMEPART(GTFTIME);
%
PAGE;
 PROC FORMAT;
 VALUE SVCNO
    6='  6-LINK'
    7='  7-XCTL'
    8='  8-LOAD'
   18=' 18-BLDL/FIND'
   42=' 42-ATTACH';
RUN;
DATA SVCDATA (KEEP= TYPE PGMNAME JOBNAME DATE TIME SVCNO)
     REJECT  (KEEP= SVCNO DATE TIME ASCB CPUID JOBNAME SVCOPSW OLDTCB
            CDENAME REG15 REG00 REG01 LEN_DATA DATA TOD)
     GTFSVC  (KEEP= SVCNO DATE TIME ASCB CPUID JOBNAME SVCOPSW OLDTCB
            CDENAME REG15 REG00 REG01 LEN_DATA DATA TOD);
LENGTH DEFAULT=4;RETAIN COUNT  0;
FORMAT SVCOPSW $HEX16. OLDTCB REG15 REG00 REG01 ASCB $HEX8.;
FORMAT DATA $HEX64. TYPE $16. ;
INFILE GTFDATA COL=COL LENGTH = L_RECRD STOPOVER;
INPUT
    @1 FID      PIB1.
    @2 EID1      PIB1.    @;
  IF FID ^= 255 THEN DELETE;
  IF EID1 ^= 1   THEN DELETE;
INPUT
    @3 TOD      PIB8.
   @11 EID2     PIB2. @;
  IF EID2 ^= 4096 THEN DELETE;
INPUT
   @13 ASCB     $CHAR4.
   @17 CPUID    PIB2.
   @19 JOBNAME  $8.
   @27 SVCOPSW  $CHAR8.
   @29 SVCNO    PIB2.
   @35 OLDTCB   $CHAR4.
   @39 CDENAME  $8.
   @47 REG15    $CHAR4.
   @51 REG00    $CHAR4.
   @55 REG01    $CHAR4.
   @;
IF JOBNAME = : 'IMSP' THEN GOTO GOTIT;DELETE;
GOTIT:
GTF_TIME;
LEN_DATA = L_RECRD-58;
INPUT @59 DATA $VARYING32. LEN_DATA @;
OUTPUT GTFSVC;
IF SVCNO = 6 × SVCNO = 7 × SVCNO = 8 THEN GO TO SVC6_7_8;
IF SVCNO = 18                        THEN GO TO SVC18;
IF SVCNO = 42                        THEN GO TO SVC42;
DELETE;
SVC6_7_8:
  INPUT @ 59 PGMNAME $8. @;
  IF SVCNO = 6 × SVCNO = 7 THEN DO;
     INPUT @67 PLIST $CHAR8. @;
     TYPE='LINK';
     IF SVCNO = 7 THEN TYPE = 'XCTL';
     END;
  ELSE DO;
     TYPE='LOAD';
     PLIST = ' ';
     END;
  OUTPUT SVCDATA;
  DELETE;
  RETURN;
SVC42:
   IF L_RECRD < 95 THEN DO;
      OUTPUT REJECT;DELETE;
      END;
   TYPE = 'ATTACH';
   INPUT @59 LNGTH PIB1. @;
   INPUT @88  PGMNAME $8. @88 CHECK $1. @;
   IF CHECK < 'A' THEN DELETE;
   IF CHECK > 'Z' THEN DELETE;
   OUTPUT SVCDATA;
   DELETE;
   RETURN;
SVC18:
INPUT @55 REG01A PIB1. @;
IF REG01A ^= 0   THEN DO; * THIS IS A FIND REQUEST;
   IF L_RECRD < 66 THEN DO;
      OUTPUT REJECT;DELETE;
      END;
   INPUT @59 LGNTH PIB1. PGMNAME $8. @;
   TYPE = 'FIND';
   END;
ELSE DO; * THIS IS A BLDL REQUEST;
   IF L_RECRD < 70 THEN DO;
      OUTPUT REJECT;DELETE;
      END;
   TYPE = 'BLDL';
   INPUT @59 LNGTH PIB1. NOENTRY PIB2. @;
*     DO ENTRIES=1 TO NOENTRY;
      DO ENTRIES=62 TO L_RECRD BY 10;
         INPUT LL PIB2. PGMNAME $8. @;
         END;
   END;
OUTPUT SVCDATA;
RUN;
PAGE;
PROC MEANS DATA=GTFSVC NOPRINT MIN MAX;
VAR TOD;
OUTPUT OUT=DATES
       MIN=TOD1
       MAX=TOD2;
DATA DATES(KEEP=S_DATE E_DATE S_TIME E_TIME TIME1 TIME2);SET DATES;
FORMAT TIME1 TIME2 DATETIME17. ;
TOD=TOD1;GTF_TIME;S_DATE=DATE;S_TIME=TIME;
TOD=TOD2;GTF_TIME;E_DATE=DATE;E_TIME=TIME;
TIME1=DHMS(S_DATE,0,0,S_TIME);TIME2=DHMS(E_DATE,0,0,E_TIME);
DATA _NULL_;SET DATES;
FILE TITLE;PUT @1 'TITLE2 ' TIME1 '- ' TIME2 ';';
RUN;
SKIP 2;
%INCLUDE TITLE ;
SKIP 2;
RUN;
PROC FREQ DATA=GTFSVC;TABLES SVCNO;
FORMAT SVCNO SVCNO.;
TITLE3 SVC USAGE DISTRIBUTION;
RUN;
PROC FREQ DATA=GTFSVC;TABLES JOBNAME*SVCNO/NOPERCENT NOROW NOCOL;
FORMAT SVCNO SVCNO.;
TITLE3 SVC DISTRIBUTION BY JOBNAME;
RUN;
PROC FREQ DATA=SVCDATA;TABLES PGMNAME;
TITLE3 SVC USAGE;
RUN;
PAGE;
PROC SORT DATA=SVCDATA;BY JOBNAME;
RUN;
PROC FREQ DATA=GTFSVC;TABLES SVCNO;
FORMAT SVCNO SVCNO.;
TITLE3 SVC USAGE DISTRIBUTION;
RUN;
PROC FREQ DATA=GTFSVC;TABLES JOBNAME*SVCNO/NOPERCENT NOROW NOCOL;
FORMAT SVCNO SVCNO.;
TITLE3 SVC DISTRIBUTION BY JOBNAME;
RUN;
PROC FREQ DATA=SVCDATA;TABLES PGMNAME*TYPE/NOPERCENT NOROW NOCOL;
TITLE3 SVC USAGE;
RUN;
PAGE;
DATA SVCDATA1;
   SET SVCDATA;
   IF SUBSTR(JOBNAME,1,3) ^= 'IMS' THEN DELETE;
RUN;
PROC SORT DATA=SVCDATA1;BY JOBNAME TYPE;
RUN;
PROC FREQ DATA=SVCDATA1;BY JOBNAME;
    TABLES PGMNAME*TYPE/NOPERCENT NOROW NOCOL;
TITLE3 SVC USAGE FOR IMS TASKS;
RUN;
PROC FREQ DATA=SVCDATA1;BY JOBNAME TYPE;
 TABLES PGMNAME/NOPRINT OUT=SVCDATA2;
 RUN;
PROC SORT DATA=SVCDATA2;BY JOBNAME TYPE DESCENDING COUNT;
RUN;
DATA SVCDATA3;SET SVCDATA2;
BY JOBNAME TYPE ; RETAIN POSITION 0;
IF FIRST.TYPE THEN DO;
   POSITION = 0;
END;
ELSE DO;
   *NOTHING;
END;
POSITION + 1;
IF POSITION < 101 THEN OUTPUT;
RUN;
PROC PRINT;BY JOBNAME TYPE;ID POSITION;
RUN;

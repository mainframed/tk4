***********************************************************************
*
*        LOCATE IS A TSO COMMAND PROCESSOR USED TO LOCATE A NAMED
*        MODULE IN EITHER THE LINK PACK AREA OR VIA THE LINK LIST.
*        RELEVANT INFORMATION AND LOCATION IS DISPLAYED TO THE USER.
*
***********************************************************************
LOCATE   $PROLOG
         USING CPPL,R1        ADDRESSABILITY FOR CPPL
         MVC   CMDUPT,CPPLUPT COPY UPT ADDRESS
         MVC   CMDECT,CPPLECT COPY ECT ADDRESS
         MVC   CMDCBUF,CPPLCBUF COPY ADDRESS OF COMMAND BUF
         DROP  R1
         LA    R1,CMDUPT      PROVIDE LIST FOR PARSE
         LINK  EP=IKJPARS     PARSE COMMAND
         L     R2,CMDANSR     GET POINTER TO ANSWER AREA
         USING IKJPARMD,R2    PROVIDE ADDRESSABILITY
         L     R1,IKJOPT      GET POINTER TO OPERAND
         LH    R2,IKJOPT+4    GET SIZE OF OPERAND
         DROP  R2
         BCTR  R2,R0          DECREMENT FOR EXECUTE
         EX    R2,MOVENAME    MOVE TO LIST FOR LOAD
         MVC   BLDLNAME(8),NAME MOVE NAME TO BLDL LIST
         MVC   MSG2NAME(8),NAME MOVE NAME TO MSG2
         L     R3,16          GET CVT ADDR
         L     R15,188(R3)    ACTIVE LPA QUEUE ADDRESS
         L     R15,0(R15)     1ST CDE ON THE QUEUE
         LA    R15,0(R15)     CLEAR HIGH ORDER FOR ICM
         LTR   R15,R15        ANYTHING ON THE QUEUE?
CDELOOP  BZ    DIRSRCH        NO, SEARCH THE LPA DIRECTORY
         CLC   NAME,8(R15)    NAMES EQUAL?
         BE    CDECHK         YES, FOUND
         ICM   R15,7,1(R15)   GET NEXT CDE POINTER
         B     CDELOOP        CHECK IT
CDECHK   XC    RETCODE,RETCODE INDICATE MODULE FOUND
         USING LPDE,R15       INFORM THE ASSEMBLER
         TM    LPDEATTR,LPDEMIN MINOR CDE?
         BZ    CDEMAJ         NO, CONTINUE
         L     R15,LPDEXLP    YES, COPY TRUE NAME'S CDE ADDR
         MVC   TRUENM,LPDENAME COPY TRUE NAME
CDEMAJ   L     R4,LPDEXLP     GET CDE EXTENT LIST ADDR
         S     R4,=F'24'      MAKE EXTENT LIST ADDRESSABLE AS LPDE
         B     LPTRUE         GO TO COMMON MSG ROUTINE
         DROP  R15
DIRSRCH  LM    R0,R1,NAME     PICK UP THE NAME
         L     R6,352(R3)     LPA SEARCH ROUTINE ADDR
         DS    0Y(R8,R9)      ROUTINES USES THESE REGISTERS
SRCHLPA  BALR  R14,R6         SEARCH LPA DIRECTORY
         B     GOTIT          IT'S THERE
         B     NOTLPA         BRANCH IF NOT THERE
GOTIT    XC    RETCODE,RETCODE INDICATE MODULE FOUND
         LR    R4,R0          PUT LPDE ADDR WHERE IT CAN DO SOME GOOD
         USING LPDE,R4        INFORM THE ASSEMBLER
         TM    LPDEATTR,LPDEMIN  MINOR LPDE?
         BZ    LPTRUE         NO, PROCESS MAJOR
         MVC   TRUENM,LPDEMJNM YES, COPY TRUE NAME
         LM    R0,R1,LPDEMJNM PUT IT IN REGS
         B     SRCHLPA        GET MAJOR LPDE
LPTRUE   UNPK  LENGTH(7),LPDEXTLN+1(4) UNPACK LENGTH FOR PRINT
         TR    LENGTH(6),TRTABLE-240 MAKE PRINTABLE
         MVI   LENGTH+6,C' '  CLEAR GARBAGE FROM UNPACK
         UNPK  ADDRESS(7),LPDEXTAD+1(4) UNPACK ADDRESS FOR PRINT
         TR    ADDRESS(6),TRTABLE-240 MAKE PRINTABLE
         MVI   ADDRESS+6,C' ' CLEAR GARBAGE FROM UNPACK
         DROP  R4
LPAMSG   CLI   TRUENM,C' '    IS THIS AN ALIAS?
         BNE   TPUTA          YES, ISSUE ALIAS TPUT
         TPUT  MSG1,LMSG1     MESSAGE WITHOUT ALIAS NAME
         B     NOTLPA         SEE IF IN LNKLST ALSO
TPUTA    TPUT  MSG1,LMSG1A    MESSAGE WITH ALIAS NAME
NOTLPA   BLDL  0,LIST         LOCATE MODULE IN LINK/STEP LIB
         LTR   R15,R15        CHECK RETURN CODE
         BNZ   EXIT           NOT FOUND, EXIT
         XC    RETCODE,RETCODE INDICATE MODULE FOUND
         TM    BLDLC,X'80'    IS THIS AN ALIAS?
         BZ    NOTALIAS       NO, MAJOR NAME
         MVC   MODTYPE(5),=C'MINOR' INDICATE MODULE TYPE
NOTALIAS CLI   BLDLZ,X'00'    PRIVATE LIBRARY?
         BE    LIBDONE        YES, ALL SET
         MVC   LIBTYPE(12),=C'JOB/STEP LIB' MODIFY MESSAGE TEXT
         CLI   BLDLZ,X'01'    LINKLIB/LINK LIST LIBRARY?
         BH    LIBDONE        NO, ALL SET
         MVC   LIBTYPE(12),=C'LINKLIST LIB' MODIFY MESSAGE TEXT
         CLI   BLDLK,X'00'    WAS IT LINKLIB ITSELF?
         BNE   LIBDONE        NO, FILL IN CONCATINATION NUMBER
         MVC   LIBTYPE(15),=CL15'SYS1.LINKLIB' MODIFY MESSAGE TEXT
         B     AROUND         SKIP CONCATINATION NUMBER
LIBDONE  SR    R1,R1          CLEAR FOR IC
         IC    R1,BLDLK       PICK UP CONCATINATION NUMBER
         XC    DBLWD,DBLWD    CLEAR FOR CONVERT
         CVD   R1,DBLWD       CONVERT TO DECIMAL
         UNPK  CONCAT(2),DBLWD+6(2) UNPACK FOR PRINT
         OI    CONCAT+1,C'0'  MAKE PRINTABLE
         MVI   CONCAT+2,C')'  ADD TRAILING PAREN
AROUND   UNPK  TTR(7),BLDLTTR(4) UNPACK FOR PRINT
         MVI   TTR+6,C' '     CLEAR LAST UNPACKED
         TR    TTR(6),TRTABLE-240 MAKE PRINTABLE
         TPUT  MSG2,LMSG2     ISSUE MESSAGE
EXIT     OC    RETCODE,RETCODE ANY MESSAGE ISSUED (MODULE FOUND) ?
         BZ    RETURN         YES, ALL DONE
         TPUT  MSG0,LMSG0     INFORM USER
RETURN   IKJRLSA CMDANSR      RELEASE PARSE STORAGE
         L     R15,RETCODE    SET RETURN CODE
         $EPILOG
MOVENAME MVC   NAME(0),0(R1)  MOVE NAME FOR LOAD
*-------------------------------------------------------------------
LIST     DC    H'1',H'14'     BLDLLIST
BLDLNAME DC    CL8' '         BLDL NAME OF MODULE
BLDLTTR  DC    XL3'00'        TTR OF MODULE
BLDLK    DC    X'00'          CONCATINATION NUMBER
BLDLZ    DC    X'00'          LOCATION
BLDLC    DC    X'00'          ENTRY TYPE
*-------------------------------------------------------------------
MSG0     DS    0F
         DC    C'REQUESTED MODULE NOT FOUND IN EITHER LPA OR LNKLST'
LMSG0    EQU   *-MSG0                SIZE OF MESSAGE
*-------------------------------------------------------------------
MSG1     DS    0F
NAME     DC    CL8' '
         DC    C' IS: '
LENGTH   DC    CL6' '
         DC    C' BYTES AT '
ADDRESS  DC    CL6' '
LMSG1    EQU   *-MSG1                SIZE OF MESSAGE
         DC    C' (ALIAS OF '
TRUENM   DC    CL8' ',C')'         TRUE NAME IF GIVEN NAME IS AN ALIAS
LMSG1A   EQU   *-MSG1                SIZE OF MESSAGE
*-------------------------------------------------------------------
MSG2     EQU   *
MSG2NAME DC    CL8' '
         DC    C' FOUND AS A '
MODTYPE  DC    C'MAJOR NAME, AT TTR '
TTR      DC    CL6' ',C' IN '
LIBTYPE  DC    C'PRIVATE LIB ('
CONCAT   DC    C'#)                '
LMSG2    EQU   *-MSG2         SIZE OF MESSAGE
*-------------------------------------------------------------------
TRTABLE  DC    C'0123456789ABCDEF' TRANSLATE TABLE
BLANKS   DC    CL81' '        BLANKS
DBLWD    DC    D'0'           WORKAREA
ADDR     DC    F'0'           ADDRESS WORK AREA
ECB      DC    F'0'           DUMB ECB FOR PARSE
RETCODE  DC    F'4'           RETURN CODE (AND MSG SWITCH)
CMDANSR  DC    F'0'           PARSE ANSWER AREA POINTER
CMDUPT   DC    F'0'           USER PROFILE TABLE POINTER
CMDECT   DC    F'0'           ENVIRONMENT CONTROL TABLE
CMDECB   DC    A(ECB)         ECB POINTER
CMDPCL   DC    A(IKJPCL)      ADDRESS OF IKJPARM
CMDANS   DC    A(CMDANSR)     PLACE TO PUT ANSWER
CMDCBUF  DC    F'0'           POINTER TO COMMAND BUFFER
         LTORG
IKJPCL   IKJPARM
IKJOPT   IKJIDENT 'MODULE NAME',MAXLNTH=8,FIRST=ALPHA,                 X
               OTHER=ALPHANUM,PROMPT='NAME OF MODULE TO LOCATE'
         IKJENDP
         IKJCPPL
         IHALPDE
         END

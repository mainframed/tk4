 SETFLG: PROC(PARM) OPTIONS(MAIN);
         DCL PARM CHAR(100) VARYING;
         DCL TSTFLG ENTRY (CHAR(100) VARYING);
         DCL DDNAME CHAR(8) INIT('CONTROL');
         DCL 1 JFCB,
              2 JFCBDSNAM CHAR(44),
              2 JFCBPAD CHAR(132);
         DCL JFCBPTR PTR;
         JFCBPTR = ADDR(JFCB);
         CALL SYSJFCB(DDNAME,JFCBPTR);
         DCL QNAME CHAR(8) STATIC INIT('KCENQ');
         DCL RNAME CHAR(52);
         DCL RETURN CHAR(2);
         RNAME='CONTROL.'××JFCBDSNAM;
         CALL SYSENQ(QNAME,RNAME,'SYSTEM','E','WAIT',RETURN);
         IF RETURN = 'ER' THEN GO TO BADRET;
         DCL PLIRETC BUILTIN;
         DCL SWOUT CHAR(32),
              MASK BIT(256) DEF SWOUT;
         CTLREC = PARM;
         CALL TRIN(CTLREC,SWOUT);
         DCL CONTROL FILE SEQUENTIAL UPDATE;
         ON ENDFILE(CONTROL) GO TO BADRET;
         ON ENDFILE(SYSIN) GO TO SYSEOF;
         ON UNDEFINEDFILE(SYSIN) GO TO SYSEOF;
         DCL 1 CTL,
              2 CTLREC CHAR(64),
              2 PAD CHAR(16);
         DCL CTLOUT CHAR(32),
              SWITCHES BIT(256) DEF CTLOUT;
         READ FILE(CONTROL) INTO(CTL);
         CALL TRIN(CTLREC,CTLOUT);
         SWITCHES = SWITCHES × MASK;
         GO TO READSYS2;
 READSYS:
         CLOSE FILE(CONTROL);
         READ FILE(CONTROL) INTO(CTLLABREC);
 READSYS2:
         READ FILE(SYSIN) INTO(SYSLAB);
         SUBSTR(SYSLAB,73,8) = ' ';
         DCL NOTSW BIT(1);
         DCL SYSLAB CHAR(80);
         IF SYSLAB = 'CALL TSTFLG;'
              THEN GO TO SYSEOF;
         IF SUBSTR(SYSLAB,1,1) = '^' THEN DO;
              SYSLAB = SUBSTR(SYSLAB,2,79);
              NOTSW = '1'B;
              END;
         ELSE NOTSW = '0'B;
         LABCNT = 0;
         DCL CTLLABREC CHAR(80),
              LAB(80) CHAR(1) DEF CTLLABREC;
         DCL LABCNT FIXED INIT(0);
 NXTLABREC:
         READ FILE(CONTROL) INTO(CTLLABREC);
         J = 1;
 NXTLAB:
         DO I = J TO 72 WHILE(LAB(I) = ' ');
              END;
         IF I > 72 THEN GO TO NXTLABREC;
         LABCNT = LABCNT + 1;
         DO J = I TO 72 WHILE(LAB(J) ^= ' ');
              END;
         IF SYSLAB ^= SUBSTR(CTLLABREC,I,J-I) THEN GO TO NXTLAB;
         IF NOTSW
              THEN SUBSTR(SWITCHES,LABCNT,1) = '0'B;
              ELSE SUBSTR(SWITCHES,LABCNT,1) = '1'B;
         GO TO READSYS;
 SYSEOF:
         CLOSE FILE(CONTROL);
         READ FILE(CONTROL) INTO(CTL);
         CALL TROUT(CTLOUT,CTLREC);
         REWRITE FILE(CONTROL) FROM(CTL);
         CLOSE FILE(CONTROL);
         GO TO DEQ;
 BADRET:
         CALL PLIRETC(8);
 DEQ:
         IF SYSLAB = 'CALL TSTFLG;'
              THEN CALL TSTFLG(LOW(1));
         CALL SYSDEQ(QNAME,JFCBDSNAM,'SYSTEM',RETURN);
         END;

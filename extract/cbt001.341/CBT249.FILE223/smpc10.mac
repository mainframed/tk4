//SMPC10  JOB
//JOBCAT DD DSN=MSTRCATM,DISP=SHR
//*** PC10043 APPLIED TO B ONLY POST SU851. 8/6/78
//*
//*  THIS JOB APPLIES THE TSO MODIFICATIONS REQUIRED IN SUPPORT
//*  OF THE TSO PERFORMANCE MEASUREMENT SYSTEM.
//*
//STEP1 EXEC SMPMVS,CDS=SMPCDSP,PTS=SMPPTSP,LOG=SMPLOGP
//SMP.SMPPTFIN DD *
++PTF(PC10011).
++VER(Z037)
  /*  TSO MODIFICATION PC10011.  THIS MODIFICATION IS PART OF THE TSO
      PERFORMANCE MEASUREMENT SYSTEM.

   IGC0009C IS SVC 93 (TGET FOR OUR PURPOSES HERE). IT ISSUES
   TGET SATISFIED AND TERMINAL INPUT WAIT SYSEVENTS.
          -- MAKE THREE CHANGES TO IGC0009C --


   (1) ZAP IN CODE WHICH LINKS TO THE RECORDER TO END THE CURRENT
       TRANSACTION AT TERMINAL INPUT WAIT.  AT THE BRANCH TO THE PATCH,
       THE LOCAL LOCK IS HELD AND STATUS IS ABOUT TO BE BRANCH
       ENTERED TO PUT THIS TASK TO SLEEP.
       ALL REGS EXCEPT R3 AND R4 MAY BE DESTROYED BY THE RECORDER
       SINCE THE SVC SAVED ALL THE OTHER REGS IN THE TCB AND IS
       ABOUT TO ENTER STATUS TO MARK ITSELF NON-DISPATCHABLE.


   (2) ZAP IN CODE WHICH LINKS TO THE RECORDER TO END THE
       CURRENT TRANSACTION. AT THE BRANCH TO THE PATCH,
       BOTH THE LOCAL AND THE CMS LOCKS AREA HELD AND THE TGETTPUT
       SYSEVENT IS ABOUT TO BE ISSUED.  THE RECORDER DOES NOT
       AFFECT THE STATUS OF THE LOCKS FOR END TRANSACTION EVENTS.


   (3) ZAP IN CODE WHICH LINKS TO THE RECORDER TO
       START A NEW TRANSACTION WHEN A TGET IS SATISFIED.  AT
       THE BRANCH TO THE PATCH, THE LOCAL LOCK IS HELD BUT IS
       ABOUT TO BE RELEASED AND THE SVC IS ABOUT TO RETURN. THE
       RETURN BRANCH TO THE MAINLINE CODE AFTER CALLING THE
       RECORDER BYPASSES THE CODE WHICH RELEASES THE LOCAL LOCK
       SINCE THE RECORDER WILL DO THIS SO HE CAN POSSIBLY WRITE
       AN SMF RECORD.
       ALL REGS EXCEPT R5 MAY BE DESTROYED BY THE RECORDER
       SINCE THE SVC IS ABOUT TO RETURN AND ALL THE USER'S REGS
       WILL BE RESTORED FROM THE SVRB.

      S.F.REHLING
  */.
++ZAP(IGC0009C).
  EXPAND IGC0009C(140)
  NAME IGC0009C IGC0009C
 *
*  (1)
 *
  VER 028E 58E030C8  L RWRK,CVTABEND  (OVERLAID INST)
  REP 028E 47F0653A  B PATCH (TERMINAL INPUT WAIT) (AT +X'53C')
  VER 053C 00000000  VERIFY PATCH AREA
  REP 053C 58F00010  L 15,CVTPTR   15 => CVT
  REP 0540 58F0F0CC  L 15,CVTUSER(14)
  REP 0544 BFFFF004  ICM 15,15,4(15)  15 => RECORDER ENTRY POINT
  REP 0548 4780654E  BZ *+8  NO RECORDER, SKIP LINKAGE
  REP 054C 45E0F010  BAL 14,IGC009C3(15) ENTER THE RECORDER
  REP 0550 58E030C8  L RWRK,CVTABEND  (REPLACED INST)
  REP 0554 47F06290  B MAINLINE    RETURN
  REP 0558 FFFFFFFF  END OF PATCH MARKER
 *
*  (2)
 *
  VER 031C 41D0A024  LA RSAVE,TIOCSAVE  (OVERLAID INST)
  REP 031C 47F0655A  B PATCH (TGET SATISFIED - END) (AT +X'55C')
  REP 055C 58F00010  L 15,CVTPTR   15 => CVT
  REP 0560 58F0F0CC  L 15,CVTUSER(15)
  REP 0564 BFFFF004  ICM 15,15,4(15)   15 => RECORDER ENTRY POINT
  REP 0568 4780656E  BZ *+8   NO RECORDER, SKIP LINKAGE AND RETURN
*                              TO TGETTPUT SYSEVENT
  REP 056C 45E0F000  BAL 14,IGC009C1(15)  ENTER THE RECORDER
  REP 0570 41D0A024  LA RSAVE,TIOCSAVE  (REPLACED INST)
  REP 0574 47F0631E  B MAINLINE  PROCEED WITH TGETTPUT SYSEVENT
  REP 0578 FFFFFFFF  END OF PATCH MARKER
 *
*  (3)
 *
  VER 03AC 58D002FC  L 13,PSALITA-FLC(0,0)  (OVERLAID INST)
  REP 03AC 47F0657A  B PATCH (TGET SATISFIED - START) (AT +X'57C')
  REP 057C 58D002FC  L 13,PSALITA-FLC(0,0)  (RELACED INST)
  REP 0580 12FF      LTR RCODE,RCODE  IS TGET RC = 0?
  REP 0582 4780658C  BZ LBL1  YES, LINK TO RECORDER
  REP 0586 49F065AC  CH RCODE,=H'12'  IS TGET RC = 12?
  REP 058A 477063AE  BNE MAINLINE  NO, RETURN TO MAINLINE (TGET WAS
*                    NOT SATISFIED IF RC NOT = 0 OR 12)
*              LBL1  DS  0H   TGET WAS SATISFIED
  REP 058E 58F00010  L 15,CVTPTR    15 => CVT
  REP 0592 58F0F0CC  L 15,CVTUSER(15)
  REP 0596 BFFFF004  ICM 15,15,4(15)      15 => RECORDER ENTRY POINT
  REP 059A 478065AE  BZ LBL2  NO RECORDER, SKIP LINKAGE
  REP 059E 45E0F008  BAL 14,IGC009C2(15)  ENTER THE RECORDER
  REP 05A2 47F065AE  B LBL2   IF RETURN IS TO HERE, RECORDER COULD
*                          NOT GET TO RWA AND SO DID NOT RELEASE
*                          THE LOCAL LOCK.
  REP 05A6 58F0506C  L RCODE,XSAUBFRP  RESTORE TGET RC (SKIP REPLACING
*                    OVERLAID INST SINCE RETURN HERE INDICATES THE
*                    RECORDER RELEASED THE LOCAL LOCK).
  REP 05AA 47F063B4  B MAINLINE  RETURN PAST LOCAL LOCK RELEASE
  REP 05AE 000C      =H'12'
*              LBL2  DS 0H
  REP 05B0 58F0506C  L RCODE,XSAUBFRP  RESTORE TGET RC
  REP 05B4 58D002FC  L 13,PASLITA-FLC(0,0)  (REPLACED INST)
  REP 05B8 47F063AE  B MAINLINE  RETURN TO RELEASE LOCAL LOCK
  REP 05BC FFFFFFFF  END OF PATCH MARKER
++PTF(PC10021).
++VER(Z037)
  /*  TSO MODIFICATION PC10021.  THIS MODIFICATION IS PART OF THE TSO
      PERFORMANCE MEASUREMENT SYSTEM.

   IGG09301 IS A SECOND LOAD OF SVC 93 FOR TPUT.  IT ISSUES A TERMINAL
   OUTPUT WAIT SYSEVENT.
         -- MAKE TWO CHANGES TO IGG09301 --


   (1) LINK TO THE RECORDER WHEN THE USER ENTERS
       TERMINAL OUTPUT WAIT IN ORDER TO END THE CURRENT TRANSACTION.
       AT THE BRANCH TO THE PATCH, THE LOCAL LOCK IS HELD AND
       STATUS IS ABOUT TO BE BRANCH ENTERED TO PUT THIS TASK TO
       SLEEP.
       ALL REGS EXCEPT R3-R6 MAY BE DESTROYED BY THE RECORDER SINCE
       THE SVC SAVED ALL THE OTHER REGS IN THE TCB AND IS ABOUT TO
       ENTER STATUS TO MARK ITSELF NON-DISPATCHABLE.


   (2) LINK TO THE RECORDER WHEN THE USER EXITS
       TERMINAL OUTPUT WAIT IN ORDER TO START THE NEW TRANSACTION.
       AT THE BRANCH TO THE PATCH, THE LOCAL LOCK WAS JUST OBTAINED,
       AND NECESSARILY SO TO SERIALIZE USE OF THE RWA.
       HOWEVER, THE RECORDER MUST EVENTUALLY FREE THE LOCK SO THAT HE
       CAN POSSIBLY WRITE AN SMF RECORD.  THEREFORE, THE CODE BELOW
       REOBTAINS THE LOCK UPON RETURN FROM THE RECORDER.
       REGISTERS 10 THRU 15 MAY BE DESTROYED BY THE RECORDER SINCE
       THEY WILL BE RELOADED BY SVC 93 BEFORE THEY ARE REUSED.

      S.F.REHLING
  */.
++ZAP(IGG09301).
  EXPAND IGG09301(80)
  NAME IGC0009C IGG09301
 *
*  (1)
 *
  VER 01B8 41F061D4  LA RGOTO,TPT6500  OVERLAID INST
  REP 01B8 47F0649E  B PATCH#1  (ENTER TERM OUTPUT WAIT) (AT +X'4A0')
  VER 04A0 00000000  VERIFY PATCH AREA
  REP 04A0 58F00010  L 15,CVTPTR   15 => CVT
  REP 04A4 58F0F0CC  L 15,CVTUSER(15)
  REP 04A8 BFFFF004  ICM 15,15,4(15)    15 => RECORDER ENTRY POINT
  REP 04AC 478064B2  BZ *+8   NO RECORDER, SKIP LINKAGE
  REP 04B0 45E0F020  BAL 14,IGG93011(15)  ENTER RECORDER
  REP 04B4 41F061D4  LA RGOTO,TPT6500  (REPLACED INST)
  REP 04B8 47F061BA  B MAINLINE    RETURN
  REP 04BC FFFFFFFF  END OF PATCH MARKER
 *
*  (2)
 *
  VER 01E0 58D002FC  L 13,PSALIA-FLC(0,0)  (OVERLAID INST)
  REP 01E0 47F064BE  B PATCH#2  (EXIT TERM OUTPUT WAIT) (AT +X'4A0')
  REP 04C0 58F00010  L 15,CVTPTR   15 => CVT
  REP 04C4 58F0F0CC  L 15,CVTUSER(15)
  REP 04C8 BFFFF004  ICM 15,15,4(15)    15 => RECORDER ENTRY POINT
  REP 04CC 478064E0  BZ LBL1  NO RECORDER, SKIP LINKAGE + SETLOCK
  REP 04D0 45E0F028  BAL 14,IGG93012(15)  ENTER THE RECORDER
  REP 04D4 47F064E0  B LBL1  IF RETURN IS TO HERE, RECORDER COULD
*                           NOT GET TO THE RWA AND SO DID NOT
*                           RELEASE THE LOCAL LOCK.
*                    SETLOCK OBTAIN,TYPE=LOCAL,MODE=UNCOND
  REP 04D8 58D002FC  L 13,PSALITA-FLC(0,0)  ADDR OF LOCK INTERFACE TBL
  REP 04DC 58D0D248  L 13,584(13)   13 => LOCK ROUTINE
  REP 04E0 05ED      BALR 14,13  ENTER THE LOCK ROUTINE
*              LBL1  DS 0H
  REP 04E2 58D002FC  L 13,PSALITA-FLC(0,0)  (REPLACED INST)
  REP 04E6 47F061E2  B MAINLINE    RETURN
  REP 04EA FFFFFFFF  END OF PATCH MARKER
++PTF(PC10031).
++VER(Z037)
  /*  TSO MODIFICATION PC10031.  THIS MODIFICATION IS PART OF THE TSO
      PERFORMANCE MEASUREMENT SYSTEM.

   IGG09303 IS A SECOND LOAD OF SVC 93 FOR TGET WHICH ISSUES A TGET
   SATISFIED SYSEVENT.
            -- MAKE ONE CHANGES TO IGG09303 --


   (1) LINK TO THE RECORDER AFTER A TGET IS SATISFIED TO START A TRANS-
       ACTION. AT THE BRANCH TO THE PATCH, THE LOCAL LOCK IS HELD BUT
       IS ABOUT TO BE RELEASED AND THE SVC IS ABOUT TO RETURN.  THE
       RETURN TO THE MAINLINE CODE AFTER CALLING THE RECORDER
       BYPASSES RELEASING THE LOCAL LOCK SINCE THE RECORDER WILL
       DO THIS SO HE CAN POSSIBLY WRITE AN SMF RECORD.
       ALL REGS EXCEPT R5 MAY BE DESTROYED BY THE RECORDER
       SINCE THE SVC IS ABOUT TO RETURN AND ALL THE USER'S REGS
       WILL BE RESTORED FROM THE SVRB.

      S.F.REHLING
  */.
++ZAP(IGG09303).
  EXPAND IGG09303(68)
  NAME IGC0009C IGG09303
 *
*  (1)
 *
  VER 0148 58D002FC  L 13,PSALITA-FLC(0,0)  (OVERLAID INST)
  REP 0148 47F0618A  B PATCH ( TGET SATISFIED - START) (AT +X'18C')
  VER 018C 00000000  VERIFY PATCH AREA
  REP 018C 58F00010  L 15,CVTPTR   15 => CVT
  REP 0190 58F0F0CC  L 15 CVTUSER(15)
  REP 0194 BFFFF004  ICM 15,15,4(15)   15 => RECORDER ENTRY POINT
  REP 0198 478061AA  BZ LBL1  NO RECORDER, SKIP LINKAGE AND RETURN
*                             TO RELEASE THE LOCAL LOCK
  REP 019C 45E0F018  BAL 14,IGG93032(15)  ENTER THE RECORDER
  REP 01A0 47F061AA  B LBL1   IF RETURN IS TO HERE, RECORDER COULD
*                           NOT GET TO THE RWA AND SO DID NOT
*                           RELEASE THE LOCAL LOCK.
  REP 01A4 58F05064  L RCODE,XSAPRM1  RELOAD THE TGET RC (DO NOT
*                    REPLACE THE OVERLAID INST SINCE RETURN TO HERE
*                    INDICATES RECORDER RELEASED THE LOCAL LOCK).
  REP 01A8 47F06150  B MAINLINE  RETURN PAST THE LOCK RELEASE
*              LBL1  DS 0H
  REP 01AC 58D002FC  L 13,PSALITA-FLC(0,0)  (REPLACED INST)
  REP 01B0 58F05064  L RCODE,XSAPRM1  RELOAD TGET RC
  REP 01B4 47F0614A  B MAINLINE  RETURN TO RELEASE LOCAL LOCK
  REP 01B8 FFFFFFFF  END OF PATCH MARKER
++PTF(PC10043).
++VER(Z037)
  /* TSO MODIFICATION PC10040.  THIS MODIFICATION IS PART OF THE TSO
     PERFORMANCE MEASUREMENT SYSTEM.

   THE RECORDER IS THE DATA GATHERING MODULE OF THE TSO PERFORMANCE
   MEASUREMENT SYSTEM.  IT IS ADDED TO LPALIB VIA THIS PTF.

  SF REHLING */.
++MOD(RECORDER) LEPARM(RENT,REFR,REUS) LKLIB(PGLKLIB).
//SMP.SYSIN DD *
  RECEIVE S(PC10043).
  APPLY S(PC10043) FORCE.

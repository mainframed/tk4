 (CHECK(ERRCODE)):  SBMIT:  PROCEDURE REORDER;
0%INCLUDE DCLSTMT;
 %INCLUDE EXTRTN,EXTVAR,EXTVAR2,FILES,
1        DCLSBOPT,DCLPROPT;
1DECLARE
      (INDEX,LENGTH,PLIRETC,STRING,SUBSTR)BUILTIN,
      FIRST_TIME BIT(1)STATIC INITIAL(1B),
      I FIXED BINARY(31),
      LEN FIXED BINARY,
   01 OPTIONS_STMT STATIC,
      02 C1 CHAR(17)INITIAL('OPTIONS LINESIZE('),
      02 LINESIZE PICTURE'999',
      02 C2 CHAR(07)INITIAL('),SKIP('),
      02 SKIP PICTURE'99',
      02 C3 CHAR(08)INITIAL('),SPACE('),
      02 SPACE PICTURE'99',
      02 C4 CHAR(2)INITIAL(')/'),
   01 OPTIONS_STMT2 STATIC,
      02 C1 CHAR(17)INITIAL('OPTIONS PAGESIZE('),
      02 PAGESIZE PICTURE'99',
      02 C2 CHAR(09)INITIAL('),COLUMN('),
      02 COLUMN PICTURE'99',
      02 C3 CHAR(09)INITIAL('),SEARCH('),
      02 SEARCH PICTURE'9999',
      02 C4 CHAR(02)INITIAL(')/');
-/*   SBMIT WRITES THE STATEMENTS IN SBSTMTS FOR SUBMISSION TO
 /*      BATCH.  IT CAN ALSO BE USED TO CREATE A COPY OF THE
 /*      PROGRAM TEXT AS MODIFIED BY EDITING STATEMENTS.
 /*   ON THE FIRST CALL, THE SUBMIT FILE IS OPENED AND APPROPRIATE
 /*      JCL IS CONSTRUCTED USING THE OPTIONS IN SBOPT.  THE
 /*      RETURN CODE IS SET TO 4 USING PLIRETC.  THIS CODE CAN BE
 /*      EXAMINED IN THE NEXT STEP OF A CLIST TO DETERMINE WHETHER
 /*      A JOB NEEDS TO BE SUBMITTED.
 /*   AN OPTIONS STATEMENTS IS CONSTRUCTED TO EXPORT THE CURRENT
 /*      PRINT OPTIONS TO THE SUBMITTED JOB.
 /*   THE QUANDRY STATEMENTS ARE THEN WRITTEN TO FILE(SUBMIT). EACH
 /*      IS WRITTEN BEGINNING ON A NEW LINE.  IF A STATEMENT WILL
 /*      NOT FIT ON A SINGLE LINE, 71 CHARACTERS ARE WRITTEN PER LINE
 /*      AND A # CHARACTER IS INSERTED IN COLUMN 72 TO PREVENT
 /*      TRAILING BLANK ELIMINATION.
 /*   A CLOSING // IS GENERATED BY THE TSO SUBMIT COMMAND.
 /*   THE ENTRY POINT SBSAVE IS CALLED TO PLACE STATEMENTS IN THE
 /*      SUBMIT BUFFER (SBSTMTS). SBSTMTS IS USED FOR SUBMITTING,
 /*      EDITING, AND RETRANSLATING. IT IS CLEARED BY COMPILE
 /*      WHEN A NEW SEARCH BEGINS AND BY GETSTMT WHEN
 /*      RETRANSLATION BEGINS.  */
1     IF FIRST_TIME
         THEN DO;
              OPEN FILE(SUBMIT)OUTPUT;
              FIRST_TIME=0B;
              CALL PLIRETC(4);
              CALL CONSTRUCT_JCL;
         END;
0     OPTIONS_STMT=PROPT,BY NAME;
      OPTIONS_STMT2=PROPT,BY NAME;
      PUT FILE(SUBMIT)EDIT
         (STRING(OPTIONS_STMT),STRING(OPTIONS_STMT2))(SKIP,A);
0     DO I=1 REPEAT(I+LEN) WHILE(I<=LENGTH(SBSTMTS));
         LEN=INDEX(SUBSTR(SBSTMTS,I),'/');
         IF LEN<=72
              THEN PUT FILE(SUBMIT)SKIP EDIT
                   (SUBSTR(SBSTMTS,I,LEN))(A);
              ELSE DO;
                   LEN=71;
                   PUT FILE(SUBMIT)SKIP EDIT
                        (SUBSTR(SBSTMTS,I,71),'#')(A,A);
              END;
      END;
0     PUT FILE(SUBMIT)SKIP EDIT('GO/')(A);
0     PUT FILE(SYSPRINT)SKIP EDIT
         (JOBNAME,' WILL BE SUBMITTED')(A);
      RETURN;
-SBSAVE:  ENTRY(STTYPE,STMT);
      ON STRINGSIZE BEGIN;
           SBSTMTS='';
           ERRCODE=08014;
      END;
      (STRINGSIZE):  SBSTMTS=SBSTMTS××STMT;
      SUBSTR(SBSTMTS,LENGTH(SBSTMTS),1)='/'; /* CHANGE '#' */
      RETURN;
1CONSTRUCT_JCL:  PROCEDURE;
0DECLARE
      BIN CHAR(4)VARYING
         INITIAL(SUBSTR(SBOPT.BIN,1,INDEX(SBOPT.BIN××' ',' ')-1)),
      ACCT CHAR(16)VARYING
         INITIAL(SUBSTR(SBOPT.ACCT,1,INDEX(SBOPT.ACCT××' ',' ')-1));
      PUT FILE(SUBMIT)EDIT
         ('//'××JOBNAME××' JOB ('××
         ACCT××','××BIN××'),'''××
         USERID××''',NOTIFY='××USERID,
         '/*JOBPARM TIME='××TIME××',FORMS='××FORMS××',LINES='××LINES,
         '/*ROUTE  PRINT '××REMOTE,
         '// EXEC QUANDARY',
         '//SYSIN DD *')(COL(1),A);
0END CONSTRUCT_JCL;
0END SBMIT;

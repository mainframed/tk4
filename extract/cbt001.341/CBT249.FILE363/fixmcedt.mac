./ CHANGE      SEQFLD=736,NAME=MCNVTCAT                      /*FIXEDT*/
         EJECT  ,                                            /*FIXEDT*/
         MACRO                                               /*FIXEDT*/
&LABEL   SETAMODE &REG1,&REG2, NON-ZERO WORK REGISTERS       /*FIXEDT*/X
               &AMODE=,        SPECIFY ADDRESSING MODE       /*FIXEDT*/X
               &AMASK=,        ADDR OF FULLWORD X'80000000'  /*FIXEDT*/X
               &BALR=BALR,     SPECIFY OPCODE FOR BALR/BASR  /*FIXEDT*/X
               &ASMHV2=YES,    IF ASM H V2 IS BEING USED     /*FIXEDT*/X
               &CVTMAP=YES     IF MVS/XA CVT MAP IS IN PROGRAM*FIXEDT*/
.**************************************************************FIXEDT*/
.*                                                            *FIXEDT*/
.*             THIS MACRO IS A GENERAL-PURPOSE MACRO          *FIXEDT*/
.*       WRITTEN AT COMMERCIAL UNION TO FACILITATE            *FIXEDT*/
.*       SWITCHING BETWEEN 24-BIT AND 31-BIT ADDRESSING MODE  *FIXEDT*/
.*       IN MVS/XA.  THE CODE GENERATED BY THIS MACRO CAN     *FIXEDT*/
.*       BE EXECUTED ON BOTH MVS/370 AND MVS/XA SYSTEMS,      *FIXEDT*/
.*       BUT ASSEMBLER H VERSION 2 MUST BE USED FOR           *FIXEDT*/
.*       ASSEMBLY UNLESS ASMHV2=NO IS SPECIFIED, BECAUSE      *FIXEDT*/
.*       THE "BSM" INSTRUCTION WHICH IS NEW FOR MVS/XA        *FIXEDT*/
.*       IS USED.                                             *FIXEDT*/
.*                                                            *FIXEDT*/
.*       &REG1 AND &REG2 SPECIFY TWO WORK REGISTERS (NOT ZERO)*FIXEDT*/
.*       THAT ARE USED TO SET UP VALUES FOR THE BSM           *FIXEDT*/
.*       INSTRUCTION IN MVS/XA.  THE CURRENT AMODE VALUE IS   *FIXEDT*/
.*       SAVED BY THE BSM INSTRUCTION IN THE HIGH-ORDER BIT   *FIXEDT*/
.*       OF &REG1.  ON AN MVS/370 SYSTEM, A BALR INSTRUCTION  *FIXEDT*/
.*       IS EXECUTED INSTEAD OF BSM.  THIS CLEARS THE         *FIXEDT*/
.*       HIGH-ORDER BIT OF &REG1(AS IF AMODE 24 HAD BEEN      *FIXEDT*/
.*       IN EFFECT).                                          *FIXEDT*/
.*                                                            *FIXEDT*/
.*       THREE VALUES ARE SUPPORTED FOR &AMODE:               *FIXEDT*/
.*                                                            *FIXEDT*/
.*             -"24"      SETS AMODE 24, AND SAVES THE        *FIXEDT*/
.*                        CURRENT AMODE IN THE HIGH-ORDER     *FIXEDT*/
.*                        BIT OF &REG1;                       *FIXEDT*/
.*             -"31"      SETS AMODE 31, AND SAVES THE        *FIXEDT*/
.*                        CURRENT AMODE IN THE HIGH-ORDER     *FIXEDT*/
.*                        BIT OF &REG1;                       *FIXEDT*/
.*             -"RESET"   USES THE AMODE BIT THAT WAS SAVED   *FIXEDT*/
.*                        IN THE HIGH-ORDER BIT OF &REG1      *FIXEDT*/
.*                        TO SET THE AMODE; THE CURRENT AMODE *FIXEDT*/
.*                        IS SAVED IN THE HIGH-ORDER          *FIXEDT*/
.*                        BIT OF &REG1;                       *FIXEDT*/
.*                                                            *FIXEDT*/
.*                                                            *FIXEDT*/
.*       THE CODE GENERATED BY THIS MACRO CONTAINS AN INLINE  *FIXEDT*/
.*       FULLWORD OF X'80000000' USED IN EXTRACTING AND       *FIXEDT*/
.*       MANIPULATING THE AMODE BIT IN THE WORK REGISTERS.    *FIXEDT*/
.*       TO SAVE ON STORAGE, THE USER CAN SUPPLY THE ADDRESS  *FIXEDT*/
.*       OF SUCH A FULLWORD TO BE USED BY THE MACRO           *FIXEDT*/
.*       EXPANSION.  IF THE USER PROVIDES SUCH AN ADDRESS,    *FIXEDT*/
.*       USING THE AMASK= KEYWORD, THE INLINE FULLWORD IS     *FIXEDT*/
.*       NOT GENERATED, SAVING FOUR BYTES WITH EACH USE OF    *FIXEDT*/
.*       THIS MACRO.  THE ADDRESS SUPPLIED VIA AMASK= MUST    *FIXEDT*/
.*       BE THE ADDRESS OF A FULLWORD IN STORAGE, CONTAINING  *FIXEDT*/
.*       THE VALUE X'80000000'.                               *FIXEDT*/
.*                                                            *FIXEDT*/
.*                                                            *FIXEDT*/
.**************************************************************FIXEDT*/
.**************************************************************FIXEDT*/
.**                                                         ***FIXEDT*/
.**>>>>>>>>>>>>>>C U I C   D I S C L A I M E R<<<<<<<<<<<<<<***FIXEDT*/
.**                                                         ***FIXEDT*/
.**************************************************************FIXEDT*/
.**            THE INFORMATION OR MATERIAL BEING PROVIDED   ***FIXEDT*/
.**      BY COMMERCIAL UNION INSURANCE COMPANY (CUIC),      ***FIXEDT*/
.**      WHETHER IN HARD COPY OR MACHINE READABLE FORM,     ***FIXEDT*/
.**      HAS BEEN DEVELOPED BY CUIC FOR ITS OWN PURPOSE     ***FIXEDT*/
.**      AND FOR USE ON ITS OWN EQUIPMENT AND WITHIN ITS    ***FIXEDT*/
.**      OWN DATA PROCESSING SYSTEM.  CUIC MAKES NO         ***FIXEDT*/
.**      REPRESENTATIONS OR WARRANTIES WHATSOEVER WITH      ***FIXEDT*/
.**      RESPECT TO THE INFORMATION OR MATERIAL FURNISHED   ***FIXEDT*/
.**      HEREUNDER, EXPRESSED OR IMPLIED, INCLUDING BUT     ***FIXEDT*/
.**      NOT LIMITED TO ANY REPRESENTATION OR WARRANTY OF   ***FIXEDT*/
.**      MERCHANTABILITY OR FITNESS FOR ANY PARTICULAR USE  ***FIXEDT*/
.**      OR PURPOSE OR THAT THE USE OF THE INFORMATION OR   ***FIXEDT*/
.**      MATERIAL WILL NOT INFRINGE ANY PATENT, COPYRIGHT,  ***FIXEDT*/
.**      TRADEMARK, OR OTHER PROPRIETARY INTEREST.  YOU     ***FIXEDT*/
.**      ARE, THEREFORE, ACCEPTING THIS INFORMATION OR      ***FIXEDT*/
.**      MATERIAL ON AN "AS IS" BASIS AND WILL BE USING IT  ***FIXEDT*/
.**      AT YOUR OWN RISK.  NEITHER CUIC NOR ANY OF ITS     ***FIXEDT*/
.**      AFFILIATES SHALL BE LIABLE WITH RESPECT TO ANY     ***FIXEDT*/
.**      CLAIM, ACTION, OR DEMAND BY ANY USER OR OTHER      ***FIXEDT*/
.**      PARTY (INCLUDING ANY CLAIM, ACTION, OR DEMAND FOR  ***FIXEDT*/
.**      CONSEQUENTIAL DAMAGES EVEN IF CUIC HAS BEEN        ***FIXEDT*/
.**      ADVISED OF THE POSSIBILITY OF SUCH DAMAGES)        ***FIXEDT*/
.**      ARISING FROM THE USE OF THE INFORMATION OR THE     ***FIXEDT*/
.**      MATERIALS AND CONCEPTS RELATED THERETO.            ***FIXEDT*/
.**      FURTHERMORE, CUIC WILL NOT MAINTAIN, CORRECT, OR   ***FIXEDT*/
.**      UPDATE THIS INFORMATION OR MATERIAL IN THE         ***FIXEDT*/
.**      FUTURE.                                            ***FIXEDT*/
.**                                              01/26/83   ***FIXEDT*/
.**************************************************************FIXEDT*/
.*                                                            *FIXEDT*/
.*              DIRECT INQUIRIES TO THE                       *FIXEDT*/
.*       AUTHOR........                                       *FIXEDT*/
.*                                                            *FIXEDT*/
.*                   THOMAS J. AUBREY                         *FIXEDT*/
.*                   C.U. AUTOMATION SERVICES                 *FIXEDT*/
.*                   COMMERCIAL UNION INSURANCE COMPANIES     *FIXEDT*/
.*                   ONE BEACON STREET - THIRTEENTH FLOOR     *FIXEDT*/
.*                   BOSTON, MASSACHUSETTS  02108             *FIXEDT*/
.*                   TELEPHONE: (617) 725-6208                *FIXEDT*/
.*                                                            *FIXEDT*/
.**************************************************************FIXEDT*/
.*                                                           /*FIXEDT*/
.*                                                           /*FIXEDT*/
.*       DEFINE THE LOCAL SET SYMBOLS USED IN THIS MACRO     /*FIXEDT*/
.*       AND ASSIGN INITIAL VALUES TO THEM:                  /*FIXEDT*/
         LCLC  &IX             INDEX VALUE FOR LABELS        /*FIXEDT*/
         LCLC  &AMSKLBL        LABEL FOR FULLWORD X'80000000'/*FIXEDT*/
&IX      SETC  '&SYSNDX'       ASSIGN LABEL INDEX VALUE      /*FIXEDT*/
&AMSKLBL SETC  'IHB&IX.M'      ASSIGN DEFAULT LABEL FOR AMASK/*FIXEDT*/
         AIF  ('&AMASK(1)' EQ '').BYAMSK1  IF ADDR NOT SUPPL /*FIXEDT*/
&AMSKLBL SETC  '&AMASK(1)'     ASSIGN LABEL FOR AMASK        /*FIXEDT*/
.BYAMSK1 ANOP   ,                                            /*FIXEDT*/
.*                                                           /*FIXEDT*/
.*                                                           /*FIXEDT*/
&LABEL   N     &REG1,&AMSKLBL       CLEAR ADDR/SAVE AMODE BIT/*FIXEDT*/
         AIF   ('&CVTMAP(1)' EQ 'NO').CVTNO                  /*FIXEDT*/
.CVTYES  L     &REG2,CVTPTR                -> CVT            /*FIXEDT*/
         TM    CVTDCB-CVT(&REG2),CVTMVSE   IN MVS/XA SYSTEM ??*FIXEDT*/
         AGO   .CVTTST                                       /*FIXEDT*/
.CVTNO   L     &REG2,16                    -> CVT            /*FIXEDT*/
         TM    X'74'(&REG2),X'80'          IN MVS/XA SYSTEM ??*FIXEDT*/
         AGO   .CVTTST                                       /*FIXEDT*/
.CVTTST  BZ    *+L'*+4+2                   BRANCH IF NOT     /*FIXEDT*/
         LA    &REG2,IHB&IX.S-IHB&IX.B  OFFSET TO BSM INSTR  /*FIXEDT*/
         OR    &REG1,&REG2          PACK OFFSET WITH AMODE BIT*FIXEDT*/
.*                                                           /*FIXEDT*/
.*       &REG1 NOW CONTAINS THE SAME AMODE BIT VALUE         /*FIXEDT*/
.*       AS IT DID UPON ENTRY, AND AN INDEX VALUE IN THE     /*FIXEDT*/
.*       ADDRESS PORTION.  THE INDEX VALUE IS USED LATER     /*FIXEDT*/
.*       TO SELECT THE MODE CHANGE INSTRUCTION DYNAMICALLY.  /*FIXEDT*/
.*                                                           /*FIXEDT*/
         AIF   ('&AMODE(1)' EQ '24').AMODE24                 /*FIXEDT*/
         AIF   ('&AMODE(1)' EQ '31').AMODE31                 /*FIXEDT*/
         AIF   ('&AMODE(1)' EQ 'RESET').AMODERS              /*FIXEDT*/
         MNOTE 08,'AMODE SPECIFICATION ''&AMODE(1)'' INVALID, SUPPORTEDX
               VALUES ARE 24, 31, AND RESET'                 /*FIXEDT*/
         MNOTE *,'AMODE=31 HAS BEEN ASSUMED'                 /*FIXEDT*/
         AGO   .AMODE31                                      /*FIXEDT*/
.AMODE24 LA    &REG2,00             CLEAR BIT FOR AMODE 24   /*FIXEDT*/
         AGO   .GO                                           /*FIXEDT*/
.AMODE31 L     &REG2,&AMSKLBL       LOAD BIT FOR AMODE 31    /*FIXEDT*/
         AGO   .GO                                           /*FIXEDT*/
.AMODERS L     &REG2,&AMSKLBL       MASK TO CAPTURE AMODE BIT/*FIXEDT*/
         NR    &REG2,&REG1          COPY AMODE BIT FOR RESET /*FIXEDT*/
.GO      CNOP  0,4                  BOUNDARY ALIGNMENT       /*FIXEDT*/
         O     &REG2,IHB&IX.A       PACK BR ADDR W/ AMODE BIT/*FIXEDT*/
         B     IHB&IX.B(&REG1)      PROCEED WITH BALR OR BSM /*FIXEDT*/
         AIF  ('&AMASK(1)' NE '').BYAMSK2     IF ADDR SUPPLIED*FIXEDT*/
IHB&IX.M DC    A(X'80000000')       AMODE 31 BIT MASK        /*FIXEDT*/
.BYAMSK2 ANOP   ,                                            /*FIXEDT*/
IHB&IX.A DC    A(IHB&IX.N)          ADDRESS FOLLOWING BSM    /*FIXEDT*/
IHB&IX.B &BALR &REG1,&REG2          JUST CONTINUE IF MVS/370 /*FIXEDT*/
         AIF  ('&ASMHV2(1)' EQ 'NO').AHV2N1                  /*FIXEDT*/
.AHV2Y1  ANOP   ,                   ASM "H" V2 IS BEING USED /*FIXEDT*/
IHB&IX.S BSM   &REG1,&REG2          SAVE/CHANGE MODE IF MVS/XA*FIXEDT*/
         AGO   .AHV2E1                                       /*FIXEDT*/
.AHV2N1  ANOP   ,                   ASM "H" V2 ISN'T BEING USEDFIXEDT*/
IHB&IX.S DC   0Y(0)                 SAVE/CHANGE MODE IF MVS/XA*FIXEDT*/
         DC    X'0B',AL.4(&REG1,&REG2)       "BSM" INSTRUCTION*FIXEDT*/
.AHV2E1  ANOP   ,                   ASM "H" V2 IS BEING USED /*FIXEDT*/
IHB&IX.N N     &REG1,&AMSKLBL       CLEAR ADDR, SAVE AMODE BIT,FIXEDT*/X
                                    AND SET CC FOR INVOKER   /*FIXEDT*/
         MEND                                                /*FIXEDT*/
         EJECT  ,                                            /*FIXEDT*/
         LA    R12,00(,R15)    LOAD BASE REGISTER            /*FIXEDT*/
         LOAD  EPLOC=EDTNAME   LOAD ELIGIBLE DEVICES TABLE   /*FIXEDT*/
         ST    R0,EDTADDR      ...AND SAVE ITS ADDRESS/AMODE /*FIXEDT*/
         BAL   R9,EDTALL       VOLSER...BR TO CNVRT DVC TYPE /*FIXEDT*/
         MVC   OUT2+15(8),DEVTYPE   MOVE DVC TYPE TO OUTPUT  /*FIXEDT*/
         BAL   R9,EDTALL          BR TO CONVERT DEVICE TYPE  /*FIXEDT*/
***   USE SYSTEM ELIGIBLE DEVICES TABLE                      /*FIXEDT*/
EDTALL   L     R10,EDTADDR     AMODE + ADDRESS OF EDT        /*FIXEDT*/
         SETAMODE R10,R11,     SWITCH TO AMODE OF EDT        /*FIXEDT*/X
               AMODE=RESET,    RETURNED VIA  LOAD MACRO      /*FIXEDT*/X
               ASMHV2=NO,      ASMH V2 NOT BEING USED        /*FIXEDT*/X
               CVTMAP=NO       CVT MAPPING NOT AVAILABLE     /*FIXEDT*/
         ST    R10,EDTSMODE    SAVE CURRENT AMODE            /*FIXEDT*/
         L     R1,EDTADDR      AMODE + ADDRESS OF EDT        /*FIXEDT*/
         L     R1,00(,R1)      ADDRESS OF NAME LOOKUP SECTION/*FIXEDT*/X
                                          IN THE EDT         /*FIXEDT*/
         L     R10,0(R1)          NUMBER OF ENTRIES IN NLS   /*FIXEDT*/
         MVC   EDTNLSEZ,04(R1)    SIZE OF AN ENTRY  IN NLS   /*FIXEDT*/
         LA    R11,8(R1)          ADDRESS OF FIRST ENTRY     /*FIXEDT*/
         MVC   TEMP,DATA+51       MOVE DVC TYPE TO TEMP FIELD/*FIXEDT*/
         TR    TEMP,TRTAB         TR FROM CHAR->PSEUDO BINARY/*FIXEDT*/
         PACK  DWORD,TEMP         STRIP OF ZONE FIELD        /*FIXEDT*/
         LM    R0,R1,DWORD        LOAD IN REG FOR SHIFT      /*FIXEDT*/
         SRDL  R0,4         SHIFT OF SIGN DIGIT FROM PACK    /*FIXEDT*/
         ST    R1,SCANTAG         STORE IN SCAN ARGUMENT     /*FIXEDT*/
NLSLP    DS    0H                                            /*FIXEDT*/
         CLC   08(4,R11),SCANTAG  IS THIS THE DEVICE TYPE    /*FIXEDT*/
         BE    NLSFND             YES... BR TO DEVICE FOUND  /*FIXEDT*/
NLSLP@   A     R11,EDTNLSEZ       .. INCR TO NEXT TABLE ENTRY/*FIXEDT*/
         BCT   R10,NLSLP          LOOP UNTIL END OF TABLE    /*FIXEDT*/
         LA    R11,DATA+51        SET DVC TYPE TO LISTC DATA./*FIXEDT*/
*                           WILL SHOW ON OUTPUT AS CHARACTER /*FIXEDT*/
*                           REPRESENTATION OF HEX FROM UCB   /*FIXEDT*/
*                           INSTEAD OF UNITNAME SUCH AS 3330./*FIXEDT*/
*                                                            /*FIXEDT*/
NLSFND   MVC   DEVTYPE(8),0(R11)  SAVE DEVICE TYPE           /*FIXEDT*/
         L     R10,EDTSMODE       LOAD VALUE TO RESTORE AMODE/*FIXEDT*/
         SETAMODE R10,R11,        RETURN TO ORIGINAL         /*FIXEDT*/X
               AMODE=RESET,       AMODE OF MCNVTCAT          /*FIXEDT*/X
               ASMHV2=NO,      ASMH V2 NOT BEING USED        /*FIXEDT*/X
               CVTMAP=NO       CVT MAPPING NOT AVAILABLE     /*FIXEDT*/
         BR    R9                 RETURN TO MAINLINE CODE    /*FIXEDT*/
RETURN4  DELETE EPLOC=EDTNAME     DELETE IEFEDTTB            /*FIXEDT*/
         L    R15,LASTCC          LOAD RETURN CODE           /*FIXEDT*/
EDTADDR  DS    F                  ADDR OF ELIGIBLE DVC TABLE /*FIXEDT*/
EDTNAME  DC    CL8'IEFEDTTB'      ELIGIBLE DEVICES TABLE     /*FIXEDT*/
EDTNLSEZ DC    F'0'          NAME LOOKUP SECTION ENTRY SIZE  /*FIXEDT*/
EDTSMODE DC    A(0)               SAVE AMODE OF MCNVTCAT     /*FIXEDT*/

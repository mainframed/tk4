      SUBROUTINE ACTION
      COMMON/ARRAYS/NAMD(10),BASE(2),EFP(3),EFT(25,2),ETR(3),GHOST(13),
     1  IBL(10,10),IDMG(10),IGAL(10,10),IPQ(10,10),JGAL(10,10),LETR(13),
     1  IPROB1(10),RAD(9),STARS(9,2),TORPS(30,4),XKL(9,9),XROM(9,4)
      DOUBLE PRECISION NAMD
      COMMON/SCALAR/ACCE,DCHG,DDEG,DECR,DEFL,DELTA,DELV,DGIMP,DGKL,DGWP,
     1  DISTGT,DISTKR,DISTPE,DISTPK,DIV1,DIV2,DMXSPD,DSP,DSPKL,DVEL,
     1  DVIMP,DVWP,EEVMSP,EIMP,ENERGY,ERPRRT,ESDIST,ETVEL,EVENU,EVMSP,
     1  EWRP,FDATE,GHEMX,GHTMX,IBASE,ICE,IDOCK,IETOFT,IGH,IHERE,IHWARP,
     1  ISTART,ITFCTR,ITFIRE,ITORP,ITRUCE,IZZ,JCE,KLNGNS,XKTIME,
     1  LEFTK,LEFTR,MAXBQ,MAXK,MAXKQ,MAXR,MAXRQ,MAXSQ,MEN,MINK,MINR,
     1  MROM,MULTK1,MULTK2,NBASES,NKL,NMEN,NROM,NSTARS,NSTEPS,NTORPS,
     1  NTSTPS,NTRP,PCTCOL,PDEG,PNRGY,PRGH,PRKLN,PRREEN,PSP,PTRGH,
     1  RADEGC,REEN,RPRKL,RPRRM,RTIME,RTV,SDATE,SENRGY,
     1  SIM,TFACTR,THITR,TNRGY,TPMIN,TPOWR,VMXKL,VRKL,XDDEG,XDSP,XGHIT,
     1  XKFPE,XKFPST,XKLHIT,XRFTS,XRMHIT,XQE,XTIME,XTRTM,YQE,ZMIN,
     1  PRORAS,RADEK,RADEG,RADER,RADEB,RADET,RADKR,RADKG,RADKB,RADKT,
     1  RADKK,RADGB,RADGT,RAGGR,RADBT,RADTT,RADTR,RADES,RADSS
      COMMON/SUBCTL/ICNTL(20),RTBRG(5),KTO,LTO,KBRG,XWRP,
     1  ISTAT,IDAMRP,SDEF,IMSG,SKDLAY,SRDLY,GHVMX,MXCRGH,GHPHEN,
     1  DSPGH,DGGH,RPRGH,NHELP,NHELPS,XHELP
      COMMON/TBEAMS/IFGHTM,ITRMEN(20),JUP,JFROM,IBMEN,JDOWN,JTO,IBMENR,
     1  SBMNR,CREWR(9),SCREWR,CREWK,CODDS,DODDS,EODDS,FODDS
      COMMON/SHUTL/SHX,SHY,SHDEG,SHVX,ISTSH,ISHD,IFNDS(9),IDSES,VDSES,
     1  VSTRDS,VSTRM,PRXSH,VDSESM,ISHNUM
      COMMON/EXTRAS/SNOVAP,ZMAX,ICLOAK,PRCLDN,PHOLE,IHOLE,JHOLE,HOLRAD,
     1  SHLDF,NQUAD,PSTORM,ISTORM,JSTORM,STMRAD,LEVEL,ION,IYES,CMIN,
     1  CPOWR
C     ...LOOP ON NUMBER OF SECONDS(STEPS) SINCE LAST TIME.
      DO 1999 NS=1,NSTEPS   ,ITFCTR
C     ...SUBTRACT ENERGY FOR LIFE SUPPORT.
      ENERGY=ENERGY-DECR
      IF(ENERGY.LE.0.)CALL RATING(2)
C     ...CHANGE STARDATE.
      XTIME=XTIME-.01
      IF(XTIME.LE.0.)CALL RATING(3)
      SDATE=SDATE+.01
      NTSTPS=NTSTPS+1
C     ...ENEMY MOVES FROM QUAD TO QUAD ONCE PER STARDAY.
      IF(NTSTPS.EQ.NTSTPS/100*100.AND.LEVEL.NE.1)CALL QQMOVE
      IF(ISHD.EQ.0)GO TO 2025
      CALL TSHUTL
C     ...IF TRUCE, ONLY CERTAIN ACTIVITIES ALLOWED.
2025  IF(ITRUCE.EQ.1)GO TO 2150
      IS=0
C     ...ENTERPRISE MOVEMENT ROUTINE. ON RETURN:
C     .......IS=0 NORMAL RETURN
C     .......IS=1 TRAVELLING AT WARP SPEED
C     .......IS=2 EXCEEDED GALACTIC LIMITS
      IF(PSP.EQ.0..AND.DSP.EQ.0..AND.PDEG.EQ.DDEG)GO TO 2050
      CALL EPMOVE(IS)
2050  GO TO (2800,1999),IS
      IF(IDOCK.EQ.2)GO TO 2200
C     ...ENTERPRISE TORP FIRING ROUTINE
      IF(EFT(1,1).EQ.0..OR.EFT(1,1).GT.NTSTPS)GO TO 2100
      CALL EFTSUB
C     ...ENTERPRISE PHASER FIRING ROUTINE
2100  IF(EFP(1).EQ.0..OR.EFP(1).GT.NTSTPS)GO TO 2150
      CALL EFPHSR
C     ...ENTERPRISE PULSIVE BEAMS ROUTINE
2150  IF(ETR(1).EQ.0..OR.ETR(1).GT.NTSTPS.OR.ETR(2).NE.1..AND.ITRUCE.EQ.
     11)GO TO 2200
      CALL EPULSE
C     ...ENTERPRISE TRANSPORTER ROUTINE
2200  IF(ISTAT.EQ.0)GO TO 2250
      CALL BEAM
2250  IF(ITRUCE.EQ.1)GO TO 2600
      JJ=0
      DO 2260 K=2,19
      IF(ITRMEN(K).EQ.0)GO TO 2260
      IF(ICNTL(K).EQ.1)GO TO 2260
      JJ=1
2260  CONTINUE
      IF(JJ.EQ.0)GO TO 2300
C     ...ENTERPRISE TROOPS FIGHTING ROUTINE
      CALL FIGHT
2300  IF(IGH.EQ.0)GO TO 2350
C     ...GHOSTSHIP ACTIVITIES ROUTINE
      CALL GHACTV
2350  IF(NTORPS.EQ.0)GO TO 2400
C     ...TORP MOVEMENT ROUTINE
      CALL TRPMV
2400  IF(KLNGNS.EQ.0)GO TO 2450
C     ...KLINGON ACTIVITIES ROUTINE
      CALL KLNGN
2450  IF(NROM.EQ.0)GO TO 2500
C     ...ROMULAN ACTIVITIES ROUTINE
      CALL ROMLN
2500  IF(PSP.GE.1.)GO TO 2550
C     ...COLLISION DETERMINATION ROUTINE
2600  IF(IBL(ICE,JCE).GT.0)CALL BHOLE
      CALL COLLIS
      IF(ISTORM.EQ.0)GO TO 2550
      CALL STORM
2550  IF(IDOCK.EQ.1)GO TO 2900
C     ...DAMAGE REPAIR ROUTINE
2800  CALL REPAIR
      GO TO 1999
C     ...ENTERPRISE DOCKING ROUTINE
2900  CALL DOCK
1999  CONTINUE
      RETURN
      END
      SUBROUTINE BEAM
      COMMON/ARRAYS/NAMD(10),BASE(2),EFP(3),EFT(25,2),ETR(3),GHOST(13),
     1  IBL(10,10),IDMG(10),IGAL(10,10),IPQ(10,10),JGAL(10,10),LETR(13),
     1  IPROB1(10),RAD(9),STARS(9,2),TORPS(30,4),XKL(9,9),XROM(9,4)
      DOUBLE PRECISION NAMD
      COMMON/SCALAR/ACCE,DCHG,DDEG,DECR,DEFL,DELTA,DELV,DGIMP,DGKL,DGWP,
     1  DISTGT,DISTKR,DISTPE,DISTPK,DIV1,DIV2,DMXSPD,DSP,DSPKL,DVEL,
     1  DVIMP,DVWP,EEVMSP,EIMP,ENERGY,ERPRRT,ESDIST,ETVEL,EVENU,EVMSP,
     1  EWRP,FDATE,GHEMX,GHTMX,IBASE,ICE,IDOCK,IETOFT,IGH,IHERE,IHWARP,
     1  ISTART,ITFCTR,ITFIRE,ITORP,ITRUCE,IZZ,JCE,KLNGNS,XKTIME,
     1  LEFTK,LEFTR,MAXBQ,MAXK,MAXKQ,MAXR,MAXRQ,MAXSQ,MEN,MINK,MINR,
     1  MROM,MULTK1,MULTK2,NBASES,NKL,NMEN,NROM,NSTARS,NSTEPS,NTORPS,
     1  NTSTPS,NTRP,PCTCOL,PDEG,PNRGY,PRGH,PRKLN,PRREEN,PSP,PTRGH,
     1  RADEGC,REEN,RPRKL,RPRRM,RTIME,RTV,SDATE,SENRGY,
     1  SIM,TFACTR,THITR,TNRGY,TPMIN,TPOWR,VMXKL,VRKL,XDDEG,XDSP,XGHIT,
     1  XKFPE,XKFPST,XKLHIT,XRFTS,XRMHIT,XQE,XTIME,XTRTM,YQE,ZMIN,
     1  PRORAS,RADEK,RADEG,RADER,RADEB,RADET,RADKR,RADKG,RADKB,RADKT,
     1  RADKK,RADGB,RADGT,RAGGR,RADBT,RADTT,RADTR,RADES,RADSS
      COMMON/ATTACK/ITKL(18),JTKL(18)
      COMMON/TBEAMS/IFGHTM,ITRMEN(20),JUP,JFROM,IBMEN,JDOWN,JTO,IBMENR,
     1  SBMNR,CREWR(9),SCREWR,CREWK,CODDS,DODDS,EODDS,FODDS
      COMMON/SUBCTL/ICNTL(20),RTBRG(5),KTO,LTO,KBRG,XWRP,
     1  ISTAT,IDAMRP,SDEF,IMSG,SKDLAY,SRDLY,GHVMX,MXCRGH,GHPHEN,
     1  DSPGH,DGGH,RPRGH,NHELP,NHELPS,XHELP
      COMMON/LOCAL/ITBEAM,ISCAN,ITDK,JSCAN,JMSG,TRNRGY,IISTAT,JJSTAT,
     1  JJUP,JJFROM,JJTO,JJDOWN
      IF(IDMG(8).NE.0)GO TO 998
      IUP=JUP-2
      IDOWN=JDOWN-2
      KNDX=(JUP-3)*9+JFROM+1
      LNDX=(JDOWN-3)*9+JTO+1
C     ...THIS IS A FUDGE TO INDEX IBMENR VIA ITRMEN ARRAY
      IF(JUP.EQ.6)KNDX=26
      IF(JUP.EQ.2)KNDX=1
      IF(JDOWN.EQ.2)LNDX=1
      IF(ISTAT.EQ.9999)GO TO 998
C     ...CHECK IF FROM OBJ STILL THERE
99    GO TO (100,200,300,400),IUP
      X1=XQE
      Y1=YQE
      GO TO 500
100   IF(JFROM.GT.KLNGNS)GO TO 998
      IF(XKL(JFROM,1).EQ.0.)GO TO 998
      IF(ITRUCE.EQ.1.AND.ICNTL(JFROM+1).NE.1)GO TO 1000
      X1=XKL(JFROM,1)
      Y1=XKL(JFROM,2)
      GO TO 500
200   IF(JFROM.GT.NROM)GO TO 998
      IF(XROM(JFROM,1).EQ.0.)GO TO 998
      IF(ITRUCE.EQ.1.AND.ICNTL(JFROM+10).NE.1)GO TO 1000
      X1=XROM(JFROM,1)
      Y1=XROM(JFROM,2)
      GO TO 500
300   IF(IGH.EQ.0)GO TO 998
      KNDX=20
      X1=GHOST(1)
      Y1=GHOST(2)
      GO TO 500
400   IF(IBASE.EQ.0)GO TO 998
      X1=BASE(1)
      Y1=BASE(2)
C     ...CHECK IF TO OBJ STILL THERE
500   GO TO (110,210,310,998),IDOWN
      X2=XQE
      Y2=YQE
      GO TO 510
110   IF(JTO.GT.KLNGNS)GO TO 998
      IF(XKL(JTO,1).EQ.0.)GO TO 998
      IF(ITRUCE.EQ.1.AND.ICNTL(JTO+1).NE.1)GO TO 1000
      X2=XKL(JTO,1)
      Y2=XKL(JTO,2)
      GO TO 510
210   IF(JTO.GT.NROM)GO TO 998
      IF(XROM(JTO,1).EQ.0.)GO TO 998
      IF(ITRUCE.EQ.1.AND.ICNTL(JTO+10).NE.1)GO TO 1000
      X2=XROM(JTO,1)
      Y2=XROM(JTO,2)
      GO TO 510
310   IF(IGH.EQ.0)GO TO 998
      ICNTL(20)=1
      LNDX=20
      X2=GHOST(1)
      Y2=GHOST(2)
C     ...MAX OF IDAMRP MEN CAN TRANSPORT AT ONCE.
510   NBEAM=MIN0(IDAMRP,ISTAT,ITRMEN(KNDX))
      ITRMEN(KNDX)=ITRMEN(KNDX)-NBEAM
      ITRMEN(LNDX)=ITRMEN(LNDX)+NBEAM
525   ISTAT=ISTAT-NBEAM
C     ...CUMULATE TOTAL NO. OF MEN BEAMED
      ITBEAM=ITBEAM+NBEAM
      ENERGY=ENERGY-NBEAM*TRNRGY*RANGE(X1,X2,Y1,Y2)
      IF(ENERGY.LE.0.)CALL RATING(2)
      IF(ISTAT.NE.0.AND.ITRMEN(KNDX).NE.0)GO TO 1000
      WRITE(6,1)ITBEAM
1     FORMAT(' TRANSPORT COMPLETE ',I4,' MEN BEAMED OVER')
      IF(JJSTAT.LE.0)GO TO 540
530   CALL DLETE(JUP,JFROM)
      JJSTAT=0
540   ITBEAM=0
      ISTAT=0
      IF(JJSTAT.EQ.0)GO TO 1000
      WRITE(6,3)
3     FORMAT(' TRANSPORTERS REENERGIZED')
      KNDX=(JJUP-3)*9+JJFROM+1
      ISTAT=ITRMEN(KNDX)
      JUP=JJUP
      JFROM=JJFROM
      JTO=JJTO
      JDOWN=JJDOWN
      JJSTAT=1
      IF(ISTAT.EQ.0)GO TO 530
      GO TO 1000
C     ...TRANSPORT AUTOMATICALLY STOPPED IF TO OR FROM OBJ MISSING.
998   WRITE(6,2)ITBEAM
2     FORMAT(' TRANSPORTING STOPPED AFTER ',I4,' MEN')
      JJSTAT=0
      GO TO 540
1000  RETURN
      END
      SUBROUTINE BHOLE
C     ...GRAVITATIONAL EFFECTS OF BLACK HOLES. HGRAV
C     ...IS GRAVITATIONAL CONSTANT. ONLY E,K,G,T ARE EFFECTED.
      COMMON/ARRAYS/NAMD(10),BASE(2),EFP(3),EFT(25,2),ETR(3),GHOST(13),
     1  IBL(10,10),IDMG(10),IGAL(10,10),IPQ(10,10),JGAL(10,10),LETR(13),
     1  IPROB1(10),RAD(9),STARS(9,2),TORPS(30,4),XKL(9,9),XROM(9,4)
      DOUBLE PRECISION NAMD
      COMMON/SCALAR/ACCE,DCHG,DDEG,DECR,DEFL,DELTA,DELV,DGIMP,DGKL,DGWP,
     1  DISTGT,DISTKR,DISTPE,DISTPK,DIV1,DIV2,DMXSPD,DSP,DSPKL,DVEL,
     1  DVIMP,DVWP,EEVMSP,EIMP,ENERGY,ERPRRT,ESDIST,ETVEL,EVENU,EVMSP,
     1  EWRP,FDATE,GHEMX,GHTMX,IBASE,ICE,IDOCK,IETOFT,IGH,IHERE,IHWARP,
     1  ISTART,ITFCTR,ITFIRE,ITORP,ITRUCE,IZZ,JCE,KLNGNS,XKTIME,
     1  LEFTK,LEFTR,MAXBQ,MAXK,MAXKQ,MAXR,MAXRQ,MAXSQ,MEN,MINK,MINR,
     1  MROM,MULTK1,MULTK2,NBASES,NKL,NMEN,NROM,NSTARS,NSTEPS,NTORPS,
     1  NTSTPS,NTRP,PCTCOL,PDEG,PNRGY,PRGH,PRKLN,PRREEN,PSP,PTRGH,
     1  RADEGC,REEN,RPRKL,RPRRM,RTIME,RTV,SDATE,SENRGY,
     1  SIM,TFACTR,THITR,TNRGY,TPMIN,TPOWR,VMXKL,VRKL,XDDEG,XDSP,XGHIT,
     1  XKFPE,XKFPST,XKLHIT,XRFTS,XRMHIT,XQE,XTIME,XTRTM,YQE,ZMIN,
     1  PRORAS,RADEK,RADEG,RADER,RADEB,RADET,RADKR,RADKG,RADKB,RADKT,
     1  RADKK,RADGB,RADGT,RAGGR,RADBT,RADTT,RADTR,RADES,RADSS
      COMMON/EXTRAS/SNOVAP,ZMAX,ICLOAK,PRCLDN,PHOLE,IHOLE,JHOLE,HOLRAD,
     1  SHLDF,NQUAD,PSTORM,ISTORM,JSTORM,STMRAD,LEVEL,ION,IYES,CMIN,
     1  CPOWR
      DATA HGRAV/.6/
      X=IHOLE
      Y=JHOLE
      IF(IDOCK.EQ.2)GO TO 50
      CALL GETBRG(DELTA,XQE,X,YQE,Y,VPX,VPY)
      D=VPX*VPX+VPY*VPY
      DX=COSD(DELTA)*HGRAV/D
      DY=SIND(DELTA)*HGRAV/D
      XQE=XQE+DX
      YQE=YQE+DY
      DX=DX+COSD(PDEG)*PSP
      DY=DY+SIND(PDEG)*PSP
      PRSPD=PSP
      PRDEG=PDEG
      PSP=SQRT(DX*DX+DY*DY)
      CALL GETBRG(PDEG,0.,DX,0.,DY,VPX,VPY)
      IF(DSP.EQ.PRSPD)DSP=PSP
      IF(DDEG.EQ.PRDEG)DDEG=PDEG
50    IF(IGH.EQ.0)GO TO 100
      CALL GETBRG(DELTA,GHOST(1),X,GHOST(2),Y,VPX,VPY)
      D=VPX*VPX+VPY*VPY
      DX=COSD(DELTA)*HGRAV/D
      DY=SIND(DELTA)*HGRAV/D
      GHOST(1)=GHOST(1)+DX
      GHOST(2)=GHOST(2)+DY
      DX=DX+COSD(GHOST(5))*GHOST(4)
      DY=DY+SIND(GHOST(5))*GHOST(4)
      PRSPD=GHOST(4)
      PRDEG=GHOST(5)
      GHOST(4)=SQRT(DX*DX+DY*DY)
      CALL GETBRG(GHOST(5),0.,DX,0.,DY,VPX,VPY)
      IF(GHOST(6).EQ.PRSPD)GHOST(6)=GHOST(4)
      IF(GHOST(7).EQ.PRDEG)GHOST(7)=GHOST(5)
100   IF(KLNGNS.EQ.0)GO TO 200
      DO 150 J=1,KLNGNS
      IF(XKL(J,1).EQ.0.)GO TO 150
      CALL GETBRG(DELTA,XKL(J,1),X,XKL(J,2),Y,VPX,VPY)
      D=VPX*VPX+VPY*VPY
      DX=COSD(DELTA)*HGRAV/D
      DY=SIND(DELTA)*HGRAV/D
      XKL(J,1)=XKL(J,1)+DX
      XKL(J,2)=XKL(J,2)+DY
      DX=DX+COSD(XKL(J,4))*XKL(J,3)
      DY=DY+SIND(XKL(J,4))*XKL(J,3)
      PRSPD=XKL(J,3)
      PRDEG=XKL(J,4)
      XKL(J,3)=SQRT(DX*DX+DY*DY)
      CALL GETBRG(XKL(J,4),0.,DX,0.,DY,VPX,VPY)
      IF(XKL(J,5).EQ.PRSPD)XKL(J,5)=XKL(J,3)
      IF(XKL(J,6).EQ.PRDEG)XKL(J,6)=XKL(J,4)
150   CONTINUE
200   IF(NTORPS.EQ.0)GO TO 999
      DO 250 J=1,NTORPS
      IF(TORPS(J,1).EQ.0.)GO TO 250
      ZPLUS=0.
      IF(TORPS(J,4).LT.0.)ZPLUS=-360.
      IF(TORPS(J,4).GE.360.)ZPLUS=360.
      CALL GETBRG(DELTA,TORPS(J,1),X,TORPS(J,2),Y,VPX,VPY)
      D=VPX*VPX+VPY*VPY
      DX=COSD(DELTA)*HGRAV/D
      DY=SIND(DELTA)*HGRAV/D
      TORPS(J,1)=TORPS(J,1)+DX
      TORPS(J,2)=TORPS(J,2)+DY
      DX=DX+COSD(TORPS(J,4))*TORPS(J,3)
      DY=DY+SIND(TORPS(J,4))*TORPS(J,3)
      TORPS(J,3)=SQRT(DX*DX+DY*DY)
      CALL GETBRG(TORPS(J,4),0.,DX,0.,DY,VPX,VPY)
      IF(TORPS(J,4).LT.ZPLUS)TORPS(J,4)=TORPS(J,4)+360.
      IF(TORPS(J,4).GE.ZPLUS+360.)TORPS(J,4)=TORPS(J,4)-360.
250   CONTINUE
999   RETURN
      END
      BLOCK DATA
      COMMON/ARRAYS/NAMD(10),BASE(2),EFP(3),EFT(25,2),ETR(3),GHOST(13),
     1  IBL(10,10),IDMG(10),IGAL(10,10),IPQ(10,10),JGAL(10,10),LETR(13),
     1  IPROB1(10),RAD(9),STARS(9,2),TORPS(30,4),XKL(9,9),XROM(9,4)
      DOUBLE PRECISION NAMD
      COMMON/SCALAR/ACCE,DCHG,DDEG,DECR,DEFL,DELTA,DELV,DGIMP,DGKL,DGWP,
     1  DISTGT,DISTKR,DISTPE,DISTPK,DIV1,DIV2,DMXSPD,DSP,DSPKL,DVEL,
     1  DVIMP,DVWP,EEVMSP,EIMP,ENERGY,ERPRRT,ESDIST,ETVEL,EVENU,EVMSP,
     1  EWRP,FDATE,GHEMX,GHTMX,IBASE,ICE,IDOCK,IETOFT,IGH,IHERE,IHWARP,
     1  ISTART,ITFCTR,ITFIRE,ITORP,ITRUCE,IZZ,JCE,KLNGNS,XKTIME,
     1  LEFTK,LEFTR,MAXBQ,MAXK,MAXKQ,MAXR,MAXRQ,MAXSQ,MEN,MINK,MINR,
     1  MROM,MULTK1,MULTK2,NBASES,NKL,NMEN,NROM,NSTARS,NSTEPS,NTORPS,
     1  NTSTPS,NTRP,PCTCOL,PDEG,PNRGY,PRGH,PRKLN,PRREEN,PSP,PTRGH,
     1  RADEGC,REEN,RPRKL,RPRRM,RTIME,RTV,SDATE,SENRGY,
     1  SIM,TFACTR,THITR,TNRGY,TPMIN,TPOWR,VMXKL,VRKL,XDDEG,XDSP,XGHIT,
     1  XKFPE,XKFPST,XKLHIT,XRFTS,XRMHIT,XQE,XTIME,XTRTM,YQE,ZMIN,
     1  PRORAS,RADEK,RADEG,RADER,RADEB,RADET,RADKR,RADKG,RADKB,RADKT,
     1  RADKK,RADGB,RADGT,RAGGR,RADBT,RADTT,RADTR,RADES,RADSS
      COMMON/LOCAL/ITBEAM,ISCAN,ITDK,JSCAN,JMSG,TRNRGY,IISTAT,JJSTAT,
     1  JJUP,JJFROM,JJTO,JJDOWN
      COMMON/TRNSFR/ICM,IDIR,MTORPS,DTORP(30),IBTYP,IEVDR,ADDFL,ITRSTP,
     1  KFROM,MTO,LUP,LDOWN,IFROM,ITO,JSCHM,ISHSTR(10),JDAM,
     1  IPROB2(10),NGHTFP
      COMMON/ZEROS/DVWP0,EWRP0,DISTP0,IETOF0,DISTG0,CODDS0,
     1  EODDS0,IDAMR0,PJAM0,ETVEL0,SHLDF0,TRNRG0
      COMMON/EXTRAS/SNOVAP,ZMAX,ICLOAK,PRCLDN,PHOLE,IHOLE,JHOLE,HOLRAD,
     1  SHLDF,NQUAD,PSTORM,ISTORM,JSTORM,STMRAD,LEVEL,ION,IYES,CMIN,
     1  CPOWR
      DOUBLE PRECISION RANKS(2,14),MNAME,MPASS,MOLDNM,NOLDNM,
     1  ISTATS(2),IST
      COMMON/RANK/RANKS,MNAME,MPASS,POINTS,RANKPT(14),NRANKS,IRANK,NRW,
     1  MMKEY,NTIME,IOK,NHOLD,ICLKON,NSW,ISTATS
      COMMON/TBEAMS/IFGHTM,ITRMEN(20),JUP,JFROM,IBMEN,JDOWN,JTO,IBMENR,
     1  SBMNR,CREWR(9),SCREWR,CREWK,CODDS,DODDS,EODDS,FODDS
      COMMON/SUBCTL/ICNTL(20),RTBRG(5),KTO,LTO,KBRG,XWRP,
     1  ISTAT,IDAMRP,SDEF,IMSG,SKDLAY,SRDLY,GHVMX,MXCRGH,GHPHEN,
     1  DSPGH,DGGH,RPRGH,NHELP,NHELPS,XHELP
      COMMON/FORGOT/GHACCE,PJAM,PJMINC,ACTPJM,PPHASD,PTORPD,PDRVD,
     1  PDEFD,IGHPH,IGHTR,IGHDR,IGHDE
      COMMON/SHUTL/SHX,SHY,SHDEG,SHVX,ISTSH,ISHD,IFNDS(9),IDSES,VDSES,
     1  VSTRDS,VSTRM,PRXSH,VDSESM,ISHNUM
      COMMON/ATTACK/ITKL(18),JTKL(18)
      COMMON/SHUTL2/ALEDR,IALIC,IALJC,IALSS,NDRA,NTROPS,DRL,DRD
      DATA RANKPT/0.,1.,10.,20.,30.,40.,50.,60.,70.,80.,95.,110.,125.,
     1  140./
      DATA RANKS/'        ','INDUCTEE','        ',
     1  ' RECRUIT','        ','   CADET','      MI','DSHIPMAN',
     1  '        ','  ENSIGN',' LIEUTEN','ANT J.G.','      LI',
     1  'EUTENANT','   LT. C','OMMANDER','       C','OMMANDER',
     1  '        ',' CAPTAIN','    REAR',' ADMIRAL','    VICE',
     1  ' ADMIRAL','        ',' ADMIRAL','   FLEET',' ADMIRAL'/
      DATA ISTATS/'SAVED   ','ACTIVE  '/
      DATA NRW,NRANKS,IRANK/0,14,1/
      DATA PRORAS,RADEK,RADEG,RADER,RADEB,RADET,RADKR,RADKG,RADKB,RADKT,
     1  RADKK,RADGB,RADGT,RAGGR,RADBT,RADTT,RADTR,RADES,RADSS/
     1  .015,4*.7,.5,3*.7,.5,2*.7,.5,.7,.7,.5,.5,.7,.5/
      DATA NDRA,NTROPS,DRL,DRD/0,50,.15,1./
      DATA SHVX,VSTRM,VDSESM,PRXSH,IDSES,ISHNUM/.25,.08,1.,.19,0,2/
      DATA ITKL,JTKL/36*0/
      DATA VSTRDS/.12/
      DATA SNOVAP,ZMAX,ICLOAK,PRCLDN,PHOLE,IHOLE,HOLRAD,SHLDF/.00007,
     1  3000.,0,.22,.06,0,.5,1./
      DATA NQUAD,PSTORM,STMRAD/10,0.,.999/
      DATA XKTIME,RTIME,DECR,EIMP,EWRP,DGWP,DGIMP/.8,.7,1.,2000.,400.,
     1  45.,15./
      DATA DVWP,TPOWR,TPMIN,ETVEL,RADEGC,DISTPE,DISTGT,PTRGH/.25,175.,
     1  75.,.4,57.2957,5.,4.,100./
      DATA GHEMX,GHTMX,DISTKR,PRKLN,VRKL,RTV,VMXKL/3000.,10.,4.,150.,
     1  8.,.55,.5/
      DATA DGKL,DSPKL,XKLHIT,XRMHIT,XKFPST,DISTPK,ESDIST/30.,.2,300.,400
     1.,5.,4.,2.5/
      DATA XRFTS,TFACTR,RPRKL,RPRRM,PRGH,REEN,SIM/1.5,3.,5.,10.,.1,25.,
     1  .55/
      DATA IETOFT,XTRTM,EVENU,EVMSP,EEVMSP,THITR/2,10.,200.,.55,1.1,.8/
      DATA XGHIT,XKFPE,DMXSPD,MAXK,MINK,MAXR,MINR/100.,117.,.2,99,9,99,9
     1/
      DATA MAXSQ,MAXKQ,MAXRQ,MAXBQ,ITFCTR,NMEN,SENRGY/10,9,9,1,12,400,50
     100./
      DATA NTRP,DIV1,DIV2,ZMIN,DVIMP/15,200.,25.,750.,.1/
      DATA TNRGY,MULTK1,MULTK2,PCTCOL,ERPRRT,PRREEN/4.,30,20,.3,2.,.6/
      DATA LETR/'*','E','K','R','G','B','T','.',' ','F','P','S','C'/
      DATA ICLKON,IYES,NSW/'N','Y',0/
      DATA NAMD/'W DRIVE','IM DRIVE','PHASERS','TORPEDOS','PULSARS',
     1   'SR SCAN','LR SCAN','TRNSPORT','COMMUNIC','COMPUTER'/
      DATA NHELP,NHELPS,XHELP/'7777','7',7777.0/
      DATA IFGHTM,SBMNR,SCREWR,CREWK,CODDS,DODDS,EODDS,FODDS/400   ,100.
     1,175.,100.,.04,.16,.1,.085/
      DATA SKDLAY,SRDLY,GHVMX,MXCRGH,GHPHEN,DSPGH,DGGH,RPRGH/1.,1.5,
     1  .35,100,100.,.1,10.,5./
      DATA GHACCE/3000./,IDAMRP/40/,IETOFT/1/
      DATA PJAM,PJMINC,PPHASD,PTORPD,PDRVD,PDEFD/.25,.1,.4,.4,.3,.2/
      DATA TRNRGY/.1/
      DATA NHOLD/0/
      DATA CMIN,CPOWR/500.,1000./
      END
      SUBROUTINE CHEKDG(ICM,IR)
      COMMON/ARRAYS/NAMD(10),BASE(2),EFP(3),EFT(25,2),ETR(3),GHOST(13),
     1  IBL(10,10),IDMG(10),IGAL(10,10),IPQ(10,10),JGAL(10,10),LETR(13),
     1  IPROB1(10),RAD(9),STARS(9,2),TORPS(30,4),XKL(9,9),XROM(9,4)
      DOUBLE PRECISION NAMD
      COMMON/SCALAR/ACCE,DCHG,DDEG,DECR,DEFL,DELTA,DELV,DGIMP,DGKL,DGWP,
     1  DISTGT,DISTKR,DISTPE,DISTPK,DIV1,DIV2,DMXSPD,DSP,DSPKL,DVEL,
     1  DVIMP,DVWP,EEVMSP,EIMP,ENERGY,ERPRRT,ESDIST,ETVEL,EVENU,EVMSP,
     1  EWRP,FDATE,GHEMX,GHTMX,IBASE,ICE,IDOCK,IETOFT,IGH,IHERE,IHWARP,
     1  ISTART,ITFCTR,ITFIRE,ITORP,ITRUCE,IZZ,JCE,KLNGNS,XKTIME,
     1  LEFTK,LEFTR,MAXBQ,MAXK,MAXKQ,MAXR,MAXRQ,MAXSQ,MEN,MINK,MINR,
     1  MROM,MULTK1,MULTK2,NBASES,NKL,NMEN,NROM,NSTARS,NSTEPS,NTORPS,
     1  NTSTPS,NTRP,PCTCOL,PDEG,PNRGY,PRGH,PRKLN,PRREEN,PSP,PTRGH,
     1  RADEGC,REEN,RPRKL,RPRRM,RTIME,RTV,SDATE,SENRGY,
     1  SIM,TFACTR,THITR,TNRGY,TPMIN,TPOWR,VMXKL,VRKL,XDDEG,XDSP,XGHIT,
     1  XKFPE,XKFPST,XKLHIT,XRFTS,XRMHIT,XQE,XTIME,XTRTM,YQE,ZMIN,
     1  PRORAS,RADEK,RADEG,RADER,RADEB,RADET,RADKR,RADKG,RADKB,RADKT,
     1  RADKK,RADGB,RADGT,RAGGR,RADBT,RADTT,RADTR,RADES,RADSS
      COMMON/SHUTL2/ALEDR,IALIC,IALJC,IALSS,NDRA,NTROPS,DRL,DRD
C     ...THIS ROUTINE CHECKS IF FACILITY REQUESTED IN COMMAND IS DAMAGED
      DIMENSION IC(23)
      DATA IC/0,6,7,3,4,5,4*0,1,0,0,9,6,0,6,0,8,9,0,10,10/
      IR=0
      JC=IC(ICM)
      IF(JC.EQ.0)GO TO 998
      IF(ICM.EQ.17.AND.PSP.GE.1.)JC=7
      IF(IDMG(JC).EQ.0)GO TO 998
      IR=1
      WRITE(6,1)NAMD(JC)
1     FORMAT(1X,A10,' DAMAGED')
999   RETURN
998   IF(NDRA.NE.1)GO TO 999
      IF(ICM.EQ.1.OR.ICM.EQ.10.OR.ICM.EQ.11.OR.ICM.EQ.22.OR.ICM.EQ.23)GO
     1 TO 997
      GO TO 999
997   WRITE(6,2)
2     FORMAT(' IMPOSSIBLE- ENTERPRISE UNDER ALIEN CONTROL!!')
      IR=1
      GO TO 999
      END
      SUBROUTINE COLLIS
      COMMON/ARRAYS/NAMD(10),BASE(2),EFP(3),EFT(25,2),ETR(3),GHOST(13),
     1  IBL(10,10),IDMG(10),IGAL(10,10),IPQ(10,10),JGAL(10,10),LETR(13),
     1  IPROB1(10),RAD(9),STARS(9,2),TORPS(30,4),XKL(9,9),XROM(9,4)
      DOUBLE PRECISION NAMD
      COMMON/SCALAR/ACCE,DCHG,DDEG,DECR,DEFL,DELTA,DELV,DGIMP,DGKL,DGWP,
     1  DISTGT,DISTKR,DISTPE,DISTPK,DIV1,DIV2,DMXSPD,DSP,DSPKL,DVEL,
     1  DVIMP,DVWP,EEVMSP,EIMP,ENERGY,ERPRRT,ESDIST,ETVEL,EVENU,EVMSP,
     1  EWRP,FDATE,GHEMX,GHTMX,IBASE,ICE,IDOCK,IETOFT,IGH,IHERE,IHWARP,
     1  ISTART,ITFCTR,ITFIRE,ITORP,ITRUCE,IZZ,JCE,KLNGNS,XKTIME,
     1  LEFTK,LEFTR,MAXBQ,MAXK,MAXKQ,MAXR,MAXRQ,MAXSQ,MEN,MINK,MINR,
     1  MROM,MULTK1,MULTK2,NBASES,NKL,NMEN,NROM,NSTARS,NSTEPS,NTORPS,
     1  NTSTPS,NTRP,PCTCOL,PDEG,PNRGY,PRGH,PRKLN,PRREEN,PSP,PTRGH,
     1  RADEGC,REEN,RPRKL,RPRRM,RTIME,RTV,SDATE,SENRGY,
     1  SIM,TFACTR,THITR,TNRGY,TPMIN,TPOWR,VMXKL,VRKL,XDDEG,XDSP,XGHIT,
     1  XKFPE,XKFPST,XKLHIT,XRFTS,XRMHIT,XQE,XTIME,XTRTM,YQE,ZMIN,
     1  PRORAS,RADEK,RADEG,RADER,RADEB,RADET,RADKR,RADKG,RADKB,RADKT,
     1  RADKK,RADGB,RADGT,RAGGR,RADBT,RADTT,RADTR,RADES,RADSS
      COMMON/SHUTL/SHX,SHY,SHDEG,SHVX,ISTSH,ISHD,IFNDS(9),IDSES,VDSES,
     1  VSTRDS,VSTRM,PRXSH,VDSESM,ISHNUM
      COMMON/EXTRAS/SNOVAP,ZMAX,ICLOAK,PRCLDN,PHOLE,IHOLE,JHOLE,HOLRAD,
     1  SHLDF,NQUAD,PSTORM,ISTORM,JSTORM,STMRAD,LEVEL,ION,IYES,CMIN,
     1  CPOWR
      COMMON/TBEAMS/IFGHTM,ITRMEN(20),JUP,JFROM,IBMEN,JDOWN,JTO,IBMENR,
     1  SBMNR,CREWR(9),SCREWR,CREWK,CODDS,DODDS,EODDS,FODDS
      COMMON/SUBCTL/ICNTL(20),RTBRG(5),KTO,LTO,KBRG,XWRP,
     1  ISTAT,IDAMRP,SDEF,IMSG,SKDLAY,SRDLY,GHVMX,MXCRGH,GHPHEN,
     1  DSPGH,DGGH,RPRGH,NHELP,NHELPS,XHELP
C     ...SUBROUTINE TO DETERMINE ALL POSSIBLE COLLISIONS
C     ...E COLLISION WITH *
      IF(NSTARS.EQ.0)GO TO 115
      DO 100 I=1,NSTARS
      IF(STARS(I,1).EQ.0.)GO TO 100
      IF(RANGE(XQE,STARS(I,1),YQE,STARS(I,2)).GT.RAD(I))GO TO 100
      CALL RATING(1)
100   CONTINUE
C     ...SUPERNOVA?
110   IF(RAN(IZZ).GT.SNOVAP)GO TO 115
      NS=NSTARS*RAN(IZZ)+1.
      IF(STARS(NS,1).NE.0)GO TO 1101
      DO 11011 I=1,NSTARS
      IF(STARS(I,1).NE.0) GO TO 11012
11011 CONTINUE
11012 NS=I
1101  WRITE(6,111)NS
111   FORMAT(' STAR ',I1,' GOING SUPERNOVA!!')
      NTORPS=0
      IF(IGH.EQ.0)GO TO 1111
      CALL DLETE(5,1)
1111  DO 1112 I=1,NSTARS
      IF(STARS(I,1).EQ.0.)GO TO 1112
      CALL DLETE(1,I)
1112  CONTINUE
      IF(NROM.EQ.0)GO TO 1114
      DO 1113 I=1,NROM
      IF(XROM(I,1).EQ.0.)GO TO 1113
      CALL DLETE(4,I)
1113  CONTINUE
1114  IF(KLNGNS.EQ.0)GO TO 1117
      DO 1115 I=1,KLNGNS
      IF(XKL(I,1).EQ.0.)GO TO 1115
      CALL DLETE(3,I)
1115  CONTINUE
1117  X=DEFL
      IF(X.EQ.0.)GO TO 1118
      X=3.E6/X
      IF(X.GT.ZMAX)GO TO 1118
      GO TO 1119
1118  X=ZMAX
1119  CALL HITONE(-1,X,-1)
      IF(ISTSH.EQ.0)GO TO 115
      WRITE(6,1120)
1120  FORMAT(' SHUTTLECRAFT DESTROYED')
      DO 1121 I=1,9
1121  IFNDS(I)=0
      ISTSH=0
      ISHD=0
      ISHNUM=ISHNUM-1
C     ...E WITH K.
115   IF(IDOCK.EQ.2)GO TO 210
      IF(KLNGNS.EQ.0)GO TO 130
      DO 120    I=1,KLNGNS
      IF(XKL(I,1).EQ.0.)GO TO 120
      IF(RANGE(XQE,XKL(I,1),YQE,XKL(I,2)).GT.RADEK)GO TO 120
      WRITE(6,1)LETR(2),LETR(3),I
1     FORMAT(1X,A1,'-',A1,I1,' COLLISION')
      CALL DLETE(3,I)
      Y=AMAX1(CMIN+CMIN*PSP,(1.-X**2/RADEK**2)*(CPOWR+CPOWR*PSP))/SHLDF
      CALL HITONE(0,Y,3)
120   CONTINUE
C     ...E WITH R.
130   IF(NROM.EQ.0)GO TO 150
      DO 140    I=1,NROM
      IF(XROM(I,1).EQ.0.)GO TO 140
      IF(RANGE(XQE,XROM(I,1),YQE,XROM(I,2)).GT.RADER)GO TO 140
      WRITE(6,1)LETR(2),LETR(4),I
      CALL DLETE(4,I)
      Y=AMAX1(CMIN+CMIN*PSP,(1.-X**2/RADER**2)*(CPOWR+CPOWR*PSP))/SHLDF
      CALL HITONE(0,Y,4)
140   CONTINUE
C     ...E WITH G.
150   IF(IGH.EQ.0)GO TO 170
      IF(RANGE(XQE,GHOST(1),YQE,GHOST(2)).GT.RADEG)GO TO 170
      WRITE(6,7)LETR(2),LETR(5)
      CALL DLETE(5,1)
      Y=AMAX1(CMIN+CMIN*PSP,(1.-X**2/RADEG**2)*(CPOWR+CPOWR*PSP))/SHLDF
      CALL HITONE(0,Y,5)
C     ...E WITH B. MAY BE DOCKING.
170   IF(IBASE.EQ.0)GO TO 190
      IF(RANGE(XQE,BASE(1),YQE,BASE(2)).GT.RADEB)GO TO 190
      IF(PSP.LE.DMXSPD)GO TO 180
      WRITE(6,7)LETR(2),LETR(6)
      Y=AMAX1(CMIN+CMIN*PSP,(1.-X**2/RADEB**2)*(CPOWR+CPOWR*PSP))/SHLDF
      IDOCK=2
      CALL HITONE(0,Y,6)
      GO TO 190
180   IDOCK=1
      GO TO 210
C     ...E WITH T.
190   IF(NTORPS.EQ.0)GO TO 205
      DO 200    I=1,NTORPS
      IF(TORPS(I,1).EQ.0.)GO TO 200
      X=RANGE(XQE,TORPS(I,1),YQE,TORPS(I,2))
      IF(X.GT.RADET)GO TO 200
C     ...E FIRED TORPS CAN'T HURT E.
      IF(TORPS(I,4).LT.0.)GO TO 200
      Y=AMAX1(TPMIN,(1.-X**2/RADET**2)*TPOWR)/SHLDF
      WRITE(6,3)LETR(7),LETR(2)
3     FORMAT(1X,A1,' HIT ON ',A1)
      CALL HITONE(1,Y,-1)
      CALL DLETE(7,I)
200   CONTINUE
C     ...E WITH BLACK HOLE.
205   IF(IHOLE.EQ.0)GO TO 210
      IF(RANGE(XQE,FLOAT(IHOLE),YQE,FLOAT(JHOLE)).GT.HOLRAD)GO TO 210
      WRITE(6,206)LETR(2)
206   FORMAT(1X,A1,' CAPTURED BY BLACK HOLE GRAVITATION FIELD!')
      IS=-1
      CALL EPMOVE(IS)
      GO TO 999
C     ...K WITH *
210   IF(KLNGNS.EQ.0)GO TO 330
      IF(NSTARS.EQ.0)GO TO 230
      DO 220    I=1,KLNGNS
      IF(XKL(I,1).EQ.0.)GO TO 220
      DO 225    J=1,NSTARS
      IF(STARS(J,1).EQ.0.)GO TO 225
      IF(RANGE(XKL(I,1),STARS(J,1),XKL(I,2),STARS(J,2)).GT.RAD(I))GO TO
     1225
      WRITE(6,1)LETR(1),LETR(3),I
      IF(RAN(IZZ).GT.SNOVAP)GO TO 224
      NS=J
      GO TO 1101
224   CALL DLETE(3,I)
      CALL DLETE(1,J)
225   CONTINUE
220   CONTINUE
C     ...K WITH K.
230   IF(KLNGNS.LE.1)GO TO 250
      DO 240 I=1,KLNGNS
      IF(XKL(I,1).EQ.0.)GO TO 240
      DO 245    J=1,KLNGNS
      IF(XKL(J,1).EQ.0.)GO TO 245
      IF(J.EQ.I)GO TO 245
      IF(RANGE(XKL(I,1),XKL(J,1),XKL(I,2),XKL(J,2)).GT.RADKK)GO TO 245
      WRITE(6,5)LETR(3),I,LETR(3),J
5     FORMAT(1X,A1,I1,'-',A1,I1,' COLLISION')
      CALL DLETE(3,I)
      CALL DLETE(3,J)
245   CONTINUE
240   CONTINUE
C     ...K WITH R.
250   IF(KLNGNS.EQ.0)GO TO 330
      IF(NROM.EQ.0)GO TO 270
      DO 260 I=1,KLNGNS
      IF(XKL(I,1).EQ.0.)GO TO 260
      DO 265    J=1,NROM
      IF(XROM(J,1).EQ.0.)GO TO 265
      IF(RANGE(XKL(I,1),XROM(J,1),XKL(I,2),XROM(J,2)).GT.RADKR)GO TO 265
      WRITE(6,5)LETR(3),I,LETR(4),J
      CALL DLETE(3,I)
      CALL DLETE(4,J)
265   CONTINUE
260   CONTINUE
C     ...K WITH G.
270   IF(KLNGNS.EQ.0)GO TO 330
      DO 280    I=1,KLNGNS
      IF(XKL(I,1).EQ.0.)GO TO 280
      IF(IGH.EQ.0)GO TO 290
      IF(RANGE(XKL(I,1),GHOST(1),XKL(I,2),GHOST(2)).GT.RADKG)GO TO 280
      WRITE(6,1)LETR(5),LETR(3),I
      CALL DLETE(3,I)
      CALL DLETE(5,1)
280   CONTINUE
C     ...K WITH B.
290   IF(KLNGNS.EQ.0)GO TO 330
      IF(IBASE.EQ.0)GO TO 310
      DO 300    I=1,KLNGNS
      IF(XKL(I,1).EQ.0.)GO TO 300
      IF(RANGE(XKL(I,1),BASE(1),XKL(I,2),BASE(2)).GT.RADKB)GO TO 300
      WRITE(6,1)LETR(6),LETR(3),I
      CALL DLETE(3,I)
      IF(IDOCK.EQ.2)IDOCK=0
300   CONTINUE
C     ...K WITH T.
310   IF(KLNGNS.EQ.0)GO TO 330
      IF(NTORPS.EQ.0)GO TO 326
      DO 320    I=1,KLNGNS
      IF(XKL(I,1).EQ.0.)GO TO 320
      DO 325  J=1,NTORPS
      IF(TORPS(J,1).EQ.0.)GO TO 325
      IF(RANGE(XKL(I,1),TORPS(J,1),XKL(I,2),TORPS(J,2)).GT.RADKT)GO TO 3
     125
      IF(TORPS(J,4).LT.360..AND.TORPS(J,4).GE.0.)GO TO 325
      WRITE(6,6)LETR(7),LETR(3),I,XKL(I,1),XKL(I,2)
6     FORMAT(1X,A1,' HIT ON ',A1,I1,' AT ',F4.1,',',F4.1)
      CALL DLETE(3,I)
      CALL DLETE(7,J)
325   CONTINUE
320   CONTINUE
C     ...K WITH BLACK HOLE.
326   IF(IHOLE.EQ.0)GO TO 330
      DO 327 I=1,KLNGNS
      IF(XKL(I,1).EQ.0.)GO TO 327
      IF(RANGE(XKL(I,1),FLOAT(IHOLE),XKL(I,2),FLOAT(JHOLE)).GT.HOLRAD)GO
     1 TO 327
      KCE=IBL(ICE,JCE)/100
      LCE=IBL(ICE,JCE)-KCE*100
      M=JGAL(KCE,LCE)
      WRITE(6,3261)LETR(3),I
3261  FORMAT(1X,A1,I1,' CAPTURED BY BLACK HOLE')
      IF(M-M/1000*1000.LT.900)GO TO 3263
      CALL DLETE(3,I)
      GO TO 3265
3263  WRITE(6,3262)KCE,LCE
3262  FORMAT(' ESCAPED TO QUADRANT ',I2,',',I2)
      JGAL(ICE,JCE)=JGAL(ICE,JCE)-100
      IF(IDMG(6).EQ.0.OR.IDMG(7).EQ.0)IGAL(ICE,JCE)=JGAL(ICE,JCE)
      JGAL(KCE,LCE)=M+100
3265  J J=I
      IF(ITRMEN(JJ+1).EQ.0)GO TO 97531
      IF(XKL(I,1).EQ.0.)GO TO 97532
      WRITE(6,97530)ITRMEN(JJ+1)
97530 FORMAT(I4,' TROOPS CAPTURED BY ENEMY')
      GO TO 97533
97532 WRITE(6,97534)ITRMEN(JJ+1)
97534 FORMAT(I4,' TROOPS ON BOARD LOST')
97533 ITRMEN(JJ+1)=0
      IF(ISTAT.EQ.0)GO TO 97531
C     ...STOP BEAMING.
      IF(JUP.EQ.3.AND.JFROM.EQ.JJ.OR.JDOWN.EQ.3.AND.JTO.EQ.JJ)ISTAT=9999
97531 ICNTL(JJ+1)=0
      XKL(JJ,1)=0.
327   CONTINUE
C     ...T WITH *.
330   IF(NTORPS.EQ.0)GO TO 440
      IF(NSTARS.EQ.0)GO TO 350
      DO 340    I=1,NTORPS
      IF(TORPS(I,1).EQ.0.)GO TO 340
      DO 345  J=1,NSTARS
      IF(STARS(J,1).EQ.0.)GO TO 345
      IF(RANGE(TORPS(I,1),STARS(J,1),TORPS(I,2),STARS(J,2)).GT.       RA
     1D(I))GO TO 345
      IF(RAN(IZZ).GT.SNOVAP)GO TO 344
      NS=J
      GO TO 1101
344   CALL DLETE(7,I)
      CALL DLETE(1,J)
      IF(NROM.EQ.0)GO TO 345
      IF(TORPS(I,4).GE.360..OR.TORPS(I,4).LT.0.)GO TO 345
      IF(RAN(IZZ).GT.PRORAS)GO TO 345
      WRITE(6,341)
341   FORMAT(' OUTRAGED ALIENS DESTROY EVERY ROMULAN IN QUADRANT'/
     1' IN RETALIATION FOR DESTRUCTION OF THEIR STAR SYSTEM!')
      DO 342 K=1,NROM
      IF(XROM(K,1).EQ.0.)GO TO 342
      CALL DLETE(4,K)
342   CONTINUE
345   CONTINUE
340   CONTINUE
C     ...T WITH R.
350   IF(NTORPS.EQ.0)GO TO 440
      IF(NROM.EQ.0)GO TO 370
      DO 360    I=1,NTORPS
      IF(TORPS(I,1).EQ.0.)GO TO 360
      DO 355 J=1,NROM
      IF(XROM(J,1).EQ.0.)GO TO 355
      IF(RANGE(TORPS(I,1),XROM(J,1),TORPS(I,2),XROM(J,2)).GT.RADTR)
     1  GO TO 355
      IF(TORPS(I,4).LT.360.AND.TORPS(I,4).GE.0.)GO TO 355
      IF(ICNTL(J+10).EQ.1.AND.TORPS(I,4).LT.0.)GO TO 355
      WRITE(6,6)LETR(7),LETR(4),J,XROM(J,1),XROM(J,2)
      CALL DLETE(4,J)
      CALL DLETE(7,I)
355   CONTINUE
360   CONTINUE
C     ...T WITH G.
370   IF(NTORPS.EQ.0)GO TO 440
      IF(IGH.EQ.0)GO TO 390
      DO 380    I=1,NTORPS
      IF(TORPS(I,1).EQ.0.)GO TO 380
      X=RANGE(TORPS(I,1),GHOST(1),TORPS(I,2),GHOST(2)   )
      IF(X.GT.RADGT)GO TO 380
C     ...G FIRED T CAN'T HURT G.
      IF(TORPS(I,4).GE.360.)GO TO 380
      WRITE(6,3)LETR(7),LETR(5)
      CALL DLETE(7,I)
      Y=AMAX1(TPMIN,(1.-X**2/RADGT**2)*TPOWR)
      GHOST(13)=GHOST(13)-Y
      IF(GHOST(13).GE.0.)GO TO 380
      Y=GHOST(13)
      GHOST(13)=0.
      GHOST(3)=GHOST(3)-Y
      IF(GHOST(3).LT.XGHIT)GO TO 380
      CALL DLETE(5,1)
      GO TO 390
380   CONTINUE
C     ...T WITH B.
390   IF(NTORPS.EQ.0)GO TO 440
      IF(IBASE.EQ.0)GO TO 410
      DO 400    I=1,NTORPS
      IF(TORPS(I,1).EQ.0.)GO TO 400
      X=RANGE(TORPS(I,1),BASE(1),TORPS(I,2),BASE(2)   )
      IF(X.GT.RADBT)GO TO 400
      CALL DLETE(7,I)
400   CONTINUE
C     ...T WITH T.
410   IF(NTORPS.EQ.0)GO TO 440
      DO 420    I=1,NTORPS
      IF(TORPS(I,1).EQ.0.)GO TO 420
      DO 425    J=1,NTORPS
      IF(TORPS(J,1).EQ.0.)GO TO 425
      IF(J.EQ.I)GO TO 425
      IF(RANGE(TORPS(I,1),TORPS(J,1),TORPS(I,2),TORPS(J,2)).GT.RADTT
     1   )GO TO 425
      IF(RAN(IZZ).GT.PCTCOL)GO TO 425
      IF(TORPS(I,4).LT.0..AND.TORPS(J,4).LT.0.)GO TO 425
      WRITE(6,7)LETR(7),LETR(7)
7     FORMAT(1X,A1,'-',A1,' COLLISION')
      CALL DLETE(7,I)
      CALL DLETE(7,J)
425   CONTINUE
420   CONTINUE
C     ...T WITH HOLE.
      IF(NTORPS.EQ.0)GO TO 440
      IF(IHOLE.EQ.0)GO TO 440
      DO 430 I=1,NTORPS
      IF(TORPS(I,1).EQ.0.)GO TO 430
      IF(RANGE(TORPS(I,1),FLOAT(IHOLE),TORPS(I,2),FLOAT(JHOLE)).GT.HOLRA
     1D)GO TO 430
      CALL DLETE(7,I)
430   CONTINUE
C     ...G WITH *.
440   IF(IGH.EQ.0)GO TO 999
      IF(NSTARS.EQ.0)GO TO 460
      DO 450 I=1,NSTARS
      IF(STARS(I,1).EQ.0.)GO TO 450
      IF(RANGE(STARS(I,1),GHOST(1),STARS(I,2),GHOST(2)).GT.RAD(I))
     1GO TO 450
      WRITE(6,1)LETR(5),LETR(1),I
      IF(RAN(IZZ).GT.SNOVAP)GO TO 445
      NS=I
      GO TO 1101
445   CALL DLETE(1,I)
      CALL DLETE(5,1)
      GO TO 999
450   CONTINUE
C     ...G WITH R.
460   IF(NROM.EQ.0)GO TO 480
      DO 470    I=1,NROM
      IF(XROM(I,1).EQ.0.)GO TO 470
      IF(RANGE(XROM(I,1),GHOST(1),XROM(I,2),GHOST(2)).GT.RADGR)      GO
     1TO 470
      WRITE(6,1)LETR(5),LETR(4),I
      CALL DLETE(4,I)
      CALL DLETE(5,1)
      GO TO 999
470   CONTINUE
C     ...G WITH B.
480   IF(IBASE.EQ.0)GO TO 490
      IF(RANGE(GHOST(1),BASE(1),GHOST(2),BASE(2)).GT.RADGB)      GO TO 9
     199
      WRITE(6,7)LETR(5),LETR(6)
      CALL DLETE(5,1)
      IF(IDOCK.EQ.2)IDOCK=0
C     ...G WITH HOLE.
490   IF(IHOLE.EQ.0)GO TO 999
      IF(RANGE(GHOST(1),FLOAT(IHOLE),GHOST(2),FLOAT(JHOLE)).GT.HOLRAD)GO
     1 TO 999
      CALL DLETE(5,1)
999   RETURN
      END
      FUNCTION COSD(X)
      Y=X*1.745E-2
      COSD=COS(Y)
      RETURN
      END
      SUBROUTINE DAMAGE(NX,SUM,IWHAT)
      COMMON/ARRAYS/NAMD(10),BASE(2),EFP(3),EFT(25,2),ETR(3),GHOST(13),
     1  IBL(10,10),IDMG(10),IGAL(10,10),IPQ(10,10),JGAL(10,10),LETR(13),
     1  IPROB1(10),RAD(9),STARS(9,2),TORPS(30,4),XKL(9,9),XROM(9,4)
      DOUBLE PRECISION NAMD
      COMMON/SCALAR/ACCE,DCHG,DDEG,DECR,DEFL,DELTA,DELV,DGIMP,DGKL,DGWP,
     1  DISTGT,DISTKR,DISTPE,DISTPK,DIV1,DIV2,DMXSPD,DSP,DSPKL,DVEL,
     1  DVIMP,DVWP,EEVMSP,EIMP,ENERGY,ERPRRT,ESDIST,ETVEL,EVENU,EVMSP,
     1  EWRP,FDATE,GHEMX,GHTMX,IBASE,ICE,IDOCK,IETOFT,IGH,IHERE,IHWARP,
     1  ISTART,ITFCTR,ITFIRE,ITORP,ITRUCE,IZZ,JCE,KLNGNS,XKTIME,
     1  LEFTK,LEFTR,MAXBQ,MAXK,MAXKQ,MAXR,MAXRQ,MAXSQ,MEN,MINK,MINR,
     1  MROM,MULTK1,MULTK2,NBASES,NKL,NMEN,NROM,NSTARS,NSTEPS,NTORPS,
     1  NTSTPS,NTRP,PCTCOL,PDEG,PNRGY,PRGH,PRKLN,PRREEN,PSP,PTRGH,
     1  RADEGC,REEN,RPRKL,RPRRM,RTIME,RTV,SDATE,SENRGY,
     1  SIM,TFACTR,THITR,TNRGY,TPMIN,TPOWR,VMXKL,VRKL,XDDEG,XDSP,XGHIT,
     1  XKFPE,XKFPST,XKLHIT,XRFTS,XRMHIT,XQE,XTIME,XTRTM,YQE,ZMIN,
     1  PRORAS,RADEK,RADEG,RADER,RADEB,RADET,RADKR,RADKG,RADKB,RADKT,
     1  RADKK,RADGB,RADGT,RAGGR,RADBT,RADTT,RADTR,RADES,RADSS
      COMMON/TBEAMS/IFGHTM,ITRMEN(20),JUP,JFROM,IBMEN,JDOWN,JTO,IBMENR,
     1  SBMNR,CREWR(9),SCREWR,CREWK,CODDS,DODDS,EODDS,FODDS
      COMMON/SUBCTL/ICNTL(20),RTBRG(5),KTO,LTO,KBRG,XWRP,
     1  ISTAT,IDAMRP,SDEF,IMSG,SKDLAY,SRDLY,GHVMX,MXCRGH,GHPHEN,
     1  DSPGH,DGGH,RPRGH,NHELP,NHELPS,XHELP
C     ...NX=1 FOR P OR T HIT
C     ...NX=0 FOR COLLISIN
      IF(NX)5,5,100
C     ...MINIMUM SET AT 1000.
5     IF(SUM.LT.ZMIN)SUM=ZMIN
C     ...TWO ITEMS DAMAGED IN COLLISION
      DO 10    I=1,2
      IF(NX.GE.0)GO TO 15
      J=I+5
      GO TO 30
15    X=RAN(IZZ)
      DO 20    J=1,10
      IF(X.LE.J/10.)GO TO 30
20    CONTINUE
30    SDAYS=RAN(IZZ)*SUM/DIV1
      WRITE(6,1)NAMD(J)
1     FORMAT(1X,A10,' DAMAGED')
      IF(J.EQ.10)GO TO 32
      IF(J.NE.1)GO TO 35
      IHWARP=IHWARP+1
C     ...END OF GAME IF MORE THAN 2 HITS ON W DRIVE BEFORE REPAIRED.
      IF(IHWARP.GT.2)CALL RATING(6)
32    IF(NDRA.EQ.0)GO TO 35
      NDRA=0
      WRITE(6,4)
4     FORMAT(' ENERGY FORMS DISTROYED DURING DAMAGE')
35    IDMG(J)=IDMG(J)+SDAYS*100.
10    CONTINUE
      KLED=(RAN(IZZ)*SUM/DIV1)*MULTK1
      IF(IWHAT.EQ.6) GO TO 60
      DSP=0.
      PSP=0.
      SUM=0.
      DEFL=0.
      DDEG=PDEG
      GO TO 45
60    DEFL=0.
      SUM=0.
      DDEG=PDEG
      DSP=PSP
C     ...DISTRIBUTE KLED AMONGST CREW+TROOPS RANDOMLY.
45    KKLED=RAN(IZZ)*KLED
      LKLED=MIN0(KLED-KKLED,MEN)
      KKLED=MIN0(KLED-LKLED,ITRMEN(1))
      KLED=LKLED+KKLED
      MEN=MEN-LKLED
      ITRMEN(1)=ITRMEN(1)-KKLED
      IF(ITRMEN(1).LT.0)ITRMEN(1)=0
      IF(MEN.GT.6)GO TO 50
      CALL RATING(5)
50    WRITE(6,2)KLED,MEN, ITRMEN(1)
2     FORMAT(' MEN KILLED: ',I4,' CREW LEFT: ',I4,' TROOPS LEFT: ',I4)
      RETURN
C     ...P OR T HIT WITH SHIELDS DOWN.
100   X=RAN(IZZ)
      DO 110    J=1,10
      IF(X.LE.J/10.)GO TO 130
110   CONTINUE
130   SDAYS=RAN(IZZ)*SUM/DIV2
      WRITE(6,1)NAMD(J)
      IF(J.EQ.10)GO TO 42
      IF(J.NE.1)GO TO 44
      IHWARP=IHWARP+1
      IF(IHWARP.GT.2)CALL RATING(6)
42    IF(NDRA.EQ.0)GO TO 44
      NDRA=0
      WRITE(6,4)
44    IDMG(J)=IDMG(J)+SDAYS*100.
      KLED=RAN(IZZ)*SUM/DIV2*MULTK2
      GO TO 45
      END
      SUBROUTINE DLETE(NTYP,NUM)
      COMMON/ARRAYS/NAMD(10),BASE(2),EFP(3),EFT(25,2),ETR(3),GHOST(13),
     1  IBL(10,10),IDMG(10),IGAL(10,10),IPQ(10,10),JGAL(10,10),LETR(13),
     1  IPROB1(10),RAD(9),STARS(9,2),TORPS(30,4),XKL(9,9),XROM(9,4)
      DOUBLE PRECISION NAMD
      COMMON/SCALAR/ACCE,DCHG,DDEG,DECR,DEFL,DELTA,DELV,DGIMP,DGKL,DGWP,
     1  DISTGT,DISTKR,DISTPE,DISTPK,DIV1,DIV2,DMXSPD,DSP,DSPKL,DVEL,
     1  DVIMP,DVWP,EEVMSP,EIMP,ENERGY,ERPRRT,ESDIST,ETVEL,EVENU,EVMSP,
     1  EWRP,FDATE,GHEMX,GHTMX,IBASE,ICE,IDOCK,IETOFT,IGH,IHERE,IHWARP,
     1  ISTART,ITFCTR,ITFIRE,ITORP,ITRUCE,IZZ,JCE,KLNGNS,XKTIME,
     1  LEFTK,LEFTR,MAXBQ,MAXK,MAXKQ,MAXR,MAXRQ,MAXSQ,MEN,MINK,MINR,
     1  MROM,MULTK1,MULTK2,NBASES,NKL,NMEN,NROM,NSTARS,NSTEPS,NTORPS,
     1  NTSTPS,NTRP,PCTCOL,PDEG,PNRGY,PRGH,PRKLN,PRREEN,PSP,PTRGH,
     1  RADEGC,REEN,RPRKL,RPRRM,RTIME,RTV,SDATE,SENRGY,
     1  SIM,TFACTR,THITR,TNRGY,TPMIN,TPOWR,VMXKL,VRKL,XDDEG,XDSP,XGHIT,
     1  XKFPE,XKFPST,XKLHIT,XRFTS,XRMHIT,XQE,XTIME,XTRTM,YQE,ZMIN,
     1  PRORAS,RADEK,RADEG,RADER,RADEB,RADET,RADKR,RADKG,RADKB,RADKT,
     1  RADKK,RADGB,RADGT,RAGGR,RADBT,RADTT,RADTR,RADES,RADSS
      COMMON/TRNSFR/ICM,IDIR,MTORPS,DTORP(30),IBTYP,IEVDR,ADDFL,ITRSTP,
     1  KFROM,MTO,LUP,LDOWN,IFROM,ITO,JSCHM,ISHSTR(10),JDAM,
     1  IPROB2(10),NGHTFP
      COMMON/TBEAMS/IFGHTM,ITRMEN(20),JUP,JFROM,IBMEN,JDOWN,JTO,IBMENR,
     1  SBMNR,CREWR(9),SCREWR,CREWK,CODDS,DODDS,EODDS,FODDS
      COMMON/SUBCTL/ICNTL(20),RTBRG(5),KTO,LTO,KBRG,XWRP,
     1  ISTAT,IDAMRP,SDEF,IMSG,SKDLAY,SRDLY,GHVMX,MXCRGH,GHPHEN,
     1  DSPGH,DGGH,RPRGH,NHELP,NHELPS,XHELP
      COMMON/SHUTL/SHX,SHY,SHDEG,SHVX,ISTSH,ISHD,IFNDS(9),IDSES,VDSES,
     1  VSTRDS,VSTRM,PRXSH,VDSESM,ISHNUM
      COMMON/EXTRAS/SNOVAP,ZMAX,ICLOAK,PRCLDN,PHOLE,IHOLE,JHOLE,HOLRAD,
     1  SHLDF,NQUAD,PSTORM,ISTORM,JSTORM,STMRAD,LEVEL,ION,IYES,CMIN,
     1  CPOWR
      GO TO (100,999,300,400,500,600,700),NTYP
999   RETURN
C     ...DELETE *.
100   JGAL(ICE,JCE)=JGAL(ICE,JCE)-1
      IF(IDMG(6).EQ.0.OR.IDMG(7).EQ.0)      IGAL(ICE,JCE)=JGAL(ICE,JCE)
      X=STARS(NUM,1)
      Y=STARS(NUM,2)
      STARS(NUM,1)=0.
      JJ=1
      DO 110 J=1,NSTARS
      IF(STARS(J,1).EQ.0.)GO TO 110
      JJ=0
      GO TO 120
110   CONTINUE
      NSTARS=0
C     ...SHUTTLECRAFT DESTROYED - FINDINGS LOST.
120   IF(ISTSH.NE.NUM.OR.ISHD.EQ.99)GO TO 200
      WRITE(6,11)
11    FORMAT(' SHUTTLECRAFT DESTROYED')
      ISTSH=0
      ISHD=0
      DO 150    J=1,9
      IF(IFNDS(J).EQ.-1)GO TO 150
      IFNDS(J)=0
150   CONTINUE
      DO 151 J=1,10
151   ISHSTR(J)=0
      ISHNUM=ISHNUM-1
      GO TO 888
200   IF(ISTSH.NE.99.OR.ISHD.NE.NUM)GO TO 888
      WRITE(6,12)
12    FORMAT(' SHUTTLECRAFT OBJECTIVE DESTROYED')
C     ...FIND NEW OBJECTIVE (NEAREST UNEXPLORED STAR) IF POSSIBLE.
      IF(NSTARS.EQ.0)GO TO 290
      JJ=ISHSTR(2)
      IF(JJ.LE.0.OR.STARS(JJ,1).EQ.0.)GO TO 290
      DO 225 J=2,10
225   ISHSTR(J-1)=ISHSTR(J)
      DIST=RANGE(SHX,STARS(JJ,1),SHY,STARS(JJ,2))
      IF(JJ.EQ.0)GO TO 290
      DX=DIST/SHVX/100.
      WRITE(6,230)JJ,DX
230   FORMAT(' GOING ON TO STAR SYSTEM ',I1,' ARRIVAL IN ',F4.2,' STARDA
     1YS')
      ISHD=JJ
      GO TO 888
290   WRITE(6,295)
295   FORMAT(' TURNING BACK')
      ISHD=99
      DO 296 I=1,10
296   ISHSTR(I)=0
      GO TO 888
C     ...DELETE K.
300   LEFTK=LEFTK-1
      JGAL(ICE,JCE)=JGAL(ICE,JCE)-100
      IF(IDMG(6).EQ.0.OR.IDMG(7).EQ.0)      IGAL(ICE,JCE)=JGAL(ICE,JCE)
      X=XKL(NUM,1)
      Y=XKL(NUM,2)
      XKL(NUM,1)=0.
      JJ=1
      DO 310 J=1,KLNGNS
      IF(XKL(J,1).EQ.0.)GO TO 310
      JJ=0
      GO TO 320
310   CONTINUE
      KLNGNS=0
320   IF(ITRMEN(NUM+1).EQ.0)GO TO 330
      WRITE(6,301)ITRMEN(NUM+1)
301   FORMAT(I4,' TROOPS ON BOARDS LOST')
      ITRMEN(NUM+1)=0
      IF(ISTAT.EQ.0)GO TO 330
C     ...SET ISTAT TO STOP BEAMING
      IF(JUP.EQ.3.AND.JFROM.EQ.NUM.OR.JDOWN.EQ.3.AND.JTO.EQ.NUM)ISTAT=99
     199
330   ICNTL(NUM+1)=0
      GO TO 888
C     ...DELETE ROMULAN.
400   LEFTR=LEFTR-1
      JGAL(ICE,JCE)=JGAL(ICE,JCE)-1000
      IF(IDMG(6).EQ.0.OR.IDMG(7).EQ.0)      IGAL(ICE,JCE)=JGAL(ICE,JCE)
      X=XROM(NUM,1)
      Y=XROM(NUM,2)
      XROM(NUM,1)=0.
      IF(ICLOAK.EQ.2.AND.NUM.EQ.1)ICLOAK=1
      JJ=1
      DO 410 J=1,NROM
      IF(XROM(J,1).EQ.0.)GO TO 410
      JJ=0
      GO TO 420
410   CONTINUE
      NROM=0
420   IF(ITRMEN(NUM+10).EQ.0)GO TO 430
      WRITE(6,301)ITRMEN(NUM+10)
      ITRMEN(NUM+10)=0
      IF(ISTAT.EQ.0)GO TO 430
C     ...SET ISTAT TO STOP BEAMING
      IF(JUP.EQ.4.AND.JFROM.EQ.NUM.OR.JDOWN.EQ.4.AND.JTO.EQ.NUM)ISTAT=99
     199
430   ICNTL(NUM+10)=0
      GO TO 888
C     ...DELETE G.
500   IGH=0
      X=GHOST(1)
      IF(ITRMEN(20).EQ.0)GO TO 530
      WRITE(6,301)ITRMEN(20)
      ITRMEN(20)=0
      IF(ISTAT.EQ.0)GO TO 530
C     ...SET ISTAT TO STOP BEAMING
      IF(JUP.EQ.5.OR.JDOWN.EQ.5)ISTAT=9999
530   ICNTL(20)=0
      Y=GHOST(2)
      GO TO 888
C     ...DELETE B.
600   IBASE=0
      X=BASE(1)
      Y=BASE(2)
      IBMENR=0
      JGAL(ICE,JCE)=JGAL(ICE,JCE)-10
      IF(IDMG(6).EQ.0.OR.IDMG(7).EQ.0)      IGAL(ICE,JCE)=JGAL(ICE,JCE)
      GO TO 888
C     ...DELETE T.
700   TORPS(NUM,1)=0.
      JJ=1
      DO 710 J=1,NTORPS
      IF(TORPS(J,1).EQ.0.)GO TO 710
      JJ=0
      GO TO 999
710   CONTINUE
      NTORPS=0
      GO TO 999
C     ...PRINT MESSAGE
888   WRITE(6,1)LETR(NTYP),NUM,X,Y
1     FORMAT(1X,A1,I1,' AT ',F4.1,',',F4.1,' DESTROYED')
      IF(LEFTR.EQ.0.AND.LEFTK.EQ.0)CALL RATING(4)
      GO TO 999
      END
      SUBROUTINE DOCK
      COMMON/ARRAYS/NAMD(10),BASE(2),EFP(3),EFT(25,2),ETR(3),GHOST(13),
     1  IBL(10,10),IDMG(10),IGAL(10,10),IPQ(10,10),JGAL(10,10),LETR(13),
     1  IPROB1(10),RAD(9),STARS(9,2),TORPS(30,4),XKL(9,9),XROM(9,4)
      DOUBLE PRECISION NAMD
      COMMON/SCALAR/ACCE,DCHG,DDEG,DECR,DEFL,DELTA,DELV,DGIMP,DGKL,DGWP,
     1  DISTGT,DISTKR,DISTPE,DISTPK,DIV1,DIV2,DMXSPD,DSP,DSPKL,DVEL,
     1  DVIMP,DVWP,EEVMSP,EIMP,ENERGY,ERPRRT,ESDIST,ETVEL,EVENU,EVMSP,
     1  EWRP,FDATE,GHEMX,GHTMX,IBASE,ICE,IDOCK,IETOFT,IGH,IHERE,IHWARP,
     1  ISTART,ITFCTR,ITFIRE,ITORP,ITRUCE,IZZ,JCE,KLNGNS,XKTIME,
     1  LEFTK,LEFTR,MAXBQ,MAXK,MAXKQ,MAXR,MAXRQ,MAXSQ,MEN,MINK,MINR,
     1  MROM,MULTK1,MULTK2,NBASES,NKL,NMEN,NROM,NSTARS,NSTEPS,NTORPS,
     1  NTSTPS,NTRP,PCTCOL,PDEG,PNRGY,PRGH,PRKLN,PRREEN,PSP,PTRGH,
     1  RADEGC,REEN,RPRKL,RPRRM,RTIME,RTV,SDATE,SENRGY,
     1  SIM,TFACTR,THITR,TNRGY,TPMIN,TPOWR,VMXKL,VRKL,XDDEG,XDSP,XGHIT,
     1  XKFPE,XKFPST,XKLHIT,XRFTS,XRMHIT,XQE,XTIME,XTRTM,YQE,ZMIN,
     1  PRORAS,RADEK,RADEG,RADER,RADEB,RADET,RADKR,RADKG,RADKB,RADKT,
     1  RADKK,RADGB,RADGT,RAGGR,RADBT,RADTT,RADTR,RADES,RADSS
      COMMON/TBEAMS/IFGHTM,ITRMEN(20),JUP,JFROM,IBMEN,JDOWN,JTO,IBMENR,
     1  SBMNR,CREWR(9),SCREWR,CREWK,CODDS,DODDS,EODDS,FODDS
      COMMON/SHUTL/SHX,SHY,SHDEG,SHVX,ISTSH,ISHD,IFNDS(9),IDSES,VDSES,
     1  VSTRDS,VSTRM,PRXSH,VDSESM,ISHNUM
      DOUBLE PRECISION RANKS(2,14),MNAME,MPASS,MOLDNM,NOLDNM,
     1  ISTATS(2),IST
      COMMON/RANK/RANKS,MNAME,MPASS,POINTS,RANKPT(14),NRANKS,IRANK,NRW,
     1  MMKEY,NTIME,IOK,NHOLD,ICLKON,NSW,ISTATS
      COMMON/EXTRAS/SNOVAP,ZMAX,ICLOAK,PRCLDN,PHOLE,IHOLE,JHOLE,HOLRAD,
     1  SHLDF,NQUAD,PSTORM,ISTORM,JSTORM,STMRAD,LEVEL,ION,IYES,CMIN,
     1  CPOWR
      COMMON/GRAPH/IGRAPH,NOLINE
C     ...DOCKING PROCEDURE.
      WRITE(6,2901)
2901  FORMAT(' DOCKED!!'/' TEMPORARY MAINTENANCE CREW BOARDED')
C     ...REENFORCEMENTS?.
      WRITE(6,2902)IBMENR
2902  FORMAT(1X,I4,' TROOP REINFORCEMENTS')
      IF(MEN.EQ.NMEN)GO TO 2910
      MCREW=0
      IF(RAN(IZZ).GT.PRREEN)GO TO 2905
      IF(MAXRQ.EQ.1)GO TO 2905
      RMEN=MEN
      REUP=SBMNR*((400.-RMEN)/400.)
      REINF=AMAX1(REEN,REUP)
      MCREW=RAN(IZZ)*REINF+1.
      IF(MEN+MCREW.GT.NMEN)MCREW=NMEN-MEN
2905  MEN=MEN+MCREW
      WRITE(6,2903)MCREW
2903  FORMAT(1X,I4,' CREW REPLACEMENTS')
2910  ITRMEN(1)=ITRMEN(1)+IBMENR
      IBMENR=0
C     ...REFUEL AND DROP DEFLECTORS
2915  ENERGY=ENERGY+DEFL
      MAXRQ=1
      ENERGY=AMAX1(ENERGY,SENRGY)
      ITORP=MAX0(ITORP,NTRP)
      DEFL=0.
C     ...SHUTTLECRAFT REPLACEMENT?
      IF(ISHNUM.EQ.2)GO TO 2925
      IF(RAN(IZZ).GT.PRXSH)GO TO 2925
      ISHNUM=ISHNUM+1
      WRITE(6,2921)
2921  FORMAT(' SHUTTLECRAFT REPLACED')
C     ...REPAIRS ALL DAMAGE QUICKLY.
2925  JJ=0
      TOTAL=0.
30091 FORMAT(' DAMAGE REPORT')
      DO 2940 J=1,10
      IPROB1(J)=0
      IF(IDMG(J).EQ.0)GO TO 2940
      SDAYS=IDMG(J)/100./ERPRRT
      IF(JJ.EQ.0)CALL BPAGE(NOLINE)
      IF(JJ.EQ.0)WRITE(6,30091)
      JJ=1
      WRITE(6,30093)J,NAMD(J),SDAYS
30093 FORMAT(1X,I2,1X,A8,2X,'-',F5.2,' STARDAYS')
2940  CONTINUE
      IF(JJ.EQ.0)GO TO 2941
3009  WRITE(6,77701)
77701 FORMAT(' WHICH ITEMS TO REPAIR? ')
      READ(5,*,ERR=3000,END=4000)IPROB1
      IF(IPROB1(1).EQ.XHELP)GO TO 3000
      JJ=0
2941  DO 2942 J=1,10
      IF(IPROB1(J).LE.0)GO TO 2942
      IF(IPROB1(J).GT.10)GO TO 2942
      IF(IDMG(IPROB1(J)).EQ.0)GO TO 2942
      TOTAL=TOTAL+IDMG(IPROB1(J))/100.
      IDMG(IPROB1(J))=0
      JJ=1
2942  IPROB1(J)=10
      IF(JJ.EQ.0)GO TO 2950
      TOTAL=TOTAL/ ((TFACTR*ERPRRT)**(1.+RAN(IZZ)))
      NHOLD=NHOLD+TOTAL*100*ITFCTR
      XTIME=XTIME-TOTAL
      ICLOAK=ICLOAK+TOTAL*100
      WRITE(6,2945) TOTAL
2945  FORMAT(' ALL DAMAGE REPAIRED IN ',F5.2,' STARDAYS')
2950  PSP=0.
      WRITE(6,3010)
3010  FORMAT(' DAMAGE CONTROL PRIORITIES RESET TO ALL 10''S')
      IF(DDEG.LT.0.)DDEG=DDEG+360.
      PDEG=DDEG
      DSP=0.
C     ...CHECK TO SEE IF OK TO SAVE GAME
      JJ=0
      DO 52000 J=1,10
      IF(IDMG(J).EQ.0)GO TO 52000
      JJ=1
52000 CONTINUE
      IF(NRW.EQ.1.AND.JJ.EQ.0.AND.KLNGNS.EQ.0.AND.NROM.EQ.0.AND.
     1  ISTSH.EQ.0)GO TO 52004
      GO TO 52001
52004 WRITE(6,52002)
52002 FORMAT(' WOULD YOU LIKE TO SAVE THE GAME (Y OR N)?')
      READ(5,52003)ISAVE
52003 FORMAT(A1)
      IF(ISAVE.NE.IYES)GO TO 52001
      CALL RSTART(2)
C     ...SET IDOCK TO INDICATE DOCKING MANEUVERS COMPLETED
52001 IF(NRW.EQ.1)CALL RSTART(3)
      IDOCK=2
2000  RETURN
3000  CALL HELP(36)
      GO TO 3009
4000  STOP
      END
      SUBROUTINE EFPHSR
      COMMON/ARRAYS/NAMD(10),BASE(2),EFP(3),EFT(25,2),ETR(3),GHOST(13),
     1  IBL(10,10),IDMG(10),IGAL(10,10),IPQ(10,10),JGAL(10,10),LETR(13),
     1  IPROB1(10),RAD(9),STARS(9,2),TORPS(30,4),XKL(9,9),XROM(9,4)
      DOUBLE PRECISION NAMD
      COMMON/SCALAR/ACCE,DCHG,DDEG,DECR,DEFL,DELTA,DELV,DGIMP,DGKL,DGWP,
     1  DISTGT,DISTKR,DISTPE,DISTPK,DIV1,DIV2,DMXSPD,DSP,DSPKL,DVEL,
     1  DVIMP,DVWP,EEVMSP,EIMP,ENERGY,ERPRRT,ESDIST,ETVEL,EVENU,EVMSP,
     1  EWRP,FDATE,GHEMX,GHTMX,IBASE,ICE,IDOCK,IETOFT,IGH,IHERE,IHWARP,
     1  ISTART,ITFCTR,ITFIRE,ITORP,ITRUCE,IZZ,JCE,KLNGNS,XKTIME,
     1  LEFTK,LEFTR,MAXBQ,MAXK,MAXKQ,MAXR,MAXRQ,MAXSQ,MEN,MINK,MINR,
     1  MROM,MULTK1,MULTK2,NBASES,NKL,NMEN,NROM,NSTARS,NSTEPS,NTORPS,
     1  NTSTPS,NTRP,PCTCOL,PDEG,PNRGY,PRGH,PRKLN,PRREEN,PSP,PTRGH,
     1  RADEGC,REEN,RPRKL,RPRRM,RTIME,RTV,SDATE,SENRGY,
     1  SIM,TFACTR,THITR,TNRGY,TPMIN,TPOWR,VMXKL,VRKL,XDDEG,XDSP,XGHIT,
     1  XKFPE,XKFPST,XKLHIT,XRFTS,XRMHIT,XQE,XTIME,XTRTM,YQE,ZMIN,
     1  PRORAS,RADEK,RADEG,RADER,RADEB,RADET,RADKR,RADKG,RADKB,RADKT,
     1  RADKK,RADGB,RADGT,RAGGR,RADBT,RADTT,RADTR,RADES,RADSS
      COMMON/SUBCTL/ICNTL(20),RTBRG(5),KTO,LTO,KBRG,XWRP,
     1  ISTAT,IDAMRP,SDEF,IMSG,SKDLAY,SRDLY,GHVMX,MXCRGH,GHPHEN,
     1  DSPGH,DGGH,RPRGH,NHELP,NHELPS,XHELP
      COMMON/EXTRAS/SNOVAP,ZMAX,ICLOAK,PRCLDN,PHOLE,IHOLE,JHOLE,HOLRAD,
     1  SHLDF,NQUAD,PSTORM,ISTORM,JSTORM,STMRAD,LEVEL,ION,IYES,CMIN,
     1  CPOWR
C     ...E FIRES P. HITS INSTANTANEOUS. AFFECTS ONLY R,K.
      CALL CHEKDG(4,IR)
      IF(IR.EQ.1)GO TO 2350
      EFP(1)=0.
C     ...STRENGTH DEPENDENT ON ANGLE AND DIST**2.
      IF(KLNGNS.EQ.0)GO TO 2320
C     ...HIT ON KLINGONS
      DO 2310 J=1,KLNGNS
      IF(XKL(J,1).EQ.0.)GO TO 2310
      IF(J.GT.KLNGNS)GO TO 2320
      IF(ICNTL(J+1).EQ.1)GO TO 2310
      CALL EPHIT(XKL(J,1),XKL(J,2),XKL(J,7),XKLHIT,3,J)
2310  CONTINUE
2320  IF(NROM.EQ.0)GO TO 2340
C     ...HIT ON ROMULANS
      DO 2330 J=1,NROM
      IF(XROM(J,1).EQ.0.)GO TO 2330
      IF(ICNTL(J+10).EQ.1)GO TO 2330
      CALL EPHIT(XROM(J,1),XROM(J,2),XROM(J,3),XRMHIT,4,J)
2330  CONTINUE
      GO TO 2340
C     ...DAMAGE CONTROL FOR P. DELETE REQUESTED FIRING.
2350  EFP(1)=0.
      PNRGY=0.
      GO TO 2400
2340  ENERGY=ENERGY-EFP(3)
      PNRGY=0.
      IF(ENERGY.LE.0.)CALL RATING(2)
2400  RETURN
      END
      SUBROUTINE EFTSUB
      COMMON/ARRAYS/NAMD(10),BASE(2),EFP(3),EFT(25,2),ETR(3),GHOST(13),
     1  IBL(10,10),IDMG(10),IGAL(10,10),IPQ(10,10),JGAL(10,10),LETR(13),
     1  IPROB1(10),RAD(9),STARS(9,2),TORPS(30,4),XKL(9,9),XROM(9,4)
      DOUBLE PRECISION NAMD
      COMMON/SCALAR/ACCE,DCHG,DDEG,DECR,DEFL,DELTA,DELV,DGIMP,DGKL,DGWP,
     1  DISTGT,DISTKR,DISTPE,DISTPK,DIV1,DIV2,DMXSPD,DSP,DSPKL,DVEL,
     1  DVIMP,DVWP,EEVMSP,EIMP,ENERGY,ERPRRT,ESDIST,ETVEL,EVENU,EVMSP,
     1  EWRP,FDATE,GHEMX,GHTMX,IBASE,ICE,IDOCK,IETOFT,IGH,IHERE,IHWARP,
     1  ISTART,ITFCTR,ITFIRE,ITORP,ITRUCE,IZZ,JCE,KLNGNS,XKTIME,
     1  LEFTK,LEFTR,MAXBQ,MAXK,MAXKQ,MAXR,MAXRQ,MAXSQ,MEN,MINK,MINR,
     1  MROM,MULTK1,MULTK2,NBASES,NKL,NMEN,NROM,NSTARS,NSTEPS,NTORPS,
     1  NTSTPS,NTRP,PCTCOL,PDEG,PNRGY,PRGH,PRKLN,PRREEN,PSP,PTRGH,
     1  RADEGC,REEN,RPRKL,RPRRM,RTIME,RTV,SDATE,SENRGY,
     1  SIM,TFACTR,THITR,TNRGY,TPMIN,TPOWR,VMXKL,VRKL,XDDEG,XDSP,XGHIT,
     1  XKFPE,XKFPST,XKLHIT,XRFTS,XRMHIT,XQE,XTIME,XTRTM,YQE,ZMIN,
     1  PRORAS,RADEK,RADEG,RADER,RADEB,RADET,RADKR,RADKG,RADKB,RADKT,
     1  RADKK,RADGB,RADGT,RAGGR,RADBT,RADTT,RADTR,RADES,RADSS
      CALL CHEKDG(5,IR)
      IF(IR.EQ.1.)GO TO 2250
C     ...LOOP ON NO. THAT CAN BE FIRED PER STARMINUTE.
      DO 2400 JJJ=1,IETOFT
      IF(EFT(1,1).EQ.0..OR.EFT(1,1).GT.NTSTPS)GO TO 2300
C     ...LOOK FOR PLACE IN TORPS ARRAY.
      IF(NTORPS.NE.0)GO TO 2202
      NTORPS=30
      NT=1
      GO TO 2203
2202  DO 2201 K=1,NTORPS
      IF(TORPS(K,1).EQ.0.)GO TO 2208
2201  CONTINUE
      GO TO 2300
2208  NT=K
2203  VPX=COSD(PDEG)*PSP+COSD(EFT(1,2))*ETVEL
      EFT(1,1)=0.
      VPY=SIND(PDEG)*PSP+SIND(EFT(1,2))*ETVEL
      MINR=MINR+1
      WRITE(6,2206)MINR
2206  FORMAT(' TORPEDO DECK: TORPEDO ',I2,' LAUNCHED')
      TORPS(NT,3)=SQRT(VPX*VPX+VPY*VPY)
C     ...CHECK IF TORP MOVING AT WARP SPEED.
      IF(TORPS(NT,3).LT.1.)GOTO 22060
      IF(IDMG(10).EQ.0)GOTO 2205
      WRITE(6,2204)
2204  FORMAT(' COMPUTER DAMAGED - TORPEDO ENTERING HYPERSPACE..DELETED'
     1)
      GOTO 2220
2205  TORPS(NT,3)=.999
22060 TORPS(NT,1)=XQE+VPX
      TORPS(NT,2)=YQE+VPY
      VSX=0.
      VSY=0.
      CALL GETBRG(DELTA,VSX,VPX,VSY,VPY,X,Y)
C     ...PUT BEARING IN -360 TO 0 RANGE.
      TORPS(NT,4)=DELTA -360.
2220  ITFIRE=ITFIRE-1
      IF(ITFIRE.EQ.0)GO TO 2300
C     ...MOVE TORPS TO BE FIRED ARRAY DOWN IN CORE.
      DO 2225    J=1,ITFIRE
      EFT(J,1)=EFT(J+1,1)
      EFT(J,2)=EFT(J+1,2)
2225  CONTINUE
2400  CONTINUE
      GO TO 2300
C     ...DAMAGE CONTROL INHIBITION. DELETE ALL QUEUED FIRINGS.
2250  DO 2260    J=1,ITFIRE
2260  EFT(J,1)=0.
      ITORP=ITORP+ITFIRE
      ITFIRE=0
2300  RETURN
      END
      SUBROUTINE EPHIT(A1,A2,A3,TMXH,ITYPE,NUM)
      COMMON/ARRAYS/NAMD(10),BASE(2),EFP(3),EFT(25,2),ETR(3),GHOST(13),
     1  IBL(10,10),IDMG(10),IGAL(10,10),IPQ(10,10),JGAL(10,10),LETR(13),
     1  IPROB1(10),RAD(9),STARS(9,2),TORPS(30,4),XKL(9,9),XROM(9,4)
      DOUBLE PRECISION NAMD
      COMMON/SCALAR/ACCE,DCHG,DDEG,DECR,DEFL,DELTA,DELV,DGIMP,DGKL,DGWP,
     1  DISTGT,DISTKR,DISTPE,DISTPK,DIV1,DIV2,DMXSPD,DSP,DSPKL,DVEL,
     1  DVIMP,DVWP,EEVMSP,EIMP,ENERGY,ERPRRT,ESDIST,ETVEL,EVENU,EVMSP,
     1  EWRP,FDATE,GHEMX,GHTMX,IBASE,ICE,IDOCK,IETOFT,IGH,IHERE,IHWARP,
     1  ISTART,ITFCTR,ITFIRE,ITORP,ITRUCE,IZZ,JCE,KLNGNS,XKTIME,
     1  LEFTK,LEFTR,MAXBQ,MAXK,MAXKQ,MAXR,MAXRQ,MAXSQ,MEN,MINK,MINR,
     1  MROM,MULTK1,MULTK2,NBASES,NKL,NMEN,NROM,NSTARS,NSTEPS,NTORPS,
     1  NTSTPS,NTRP,PCTCOL,PDEG,PNRGY,PRGH,PRKLN,PRREEN,PSP,PTRGH,
     1  RADEGC,REEN,RPRKL,RPRRM,RTIME,RTV,SDATE,SENRGY,
     1  SIM,TFACTR,THITR,TNRGY,TPMIN,TPOWR,VMXKL,VRKL,XDDEG,XDSP,XGHIT,
     1  XKFPE,XKFPST,XKLHIT,XRFTS,XRMHIT,XQE,XTIME,XTRTM,YQE,ZMIN,
     1  PRORAS,RADEK,RADEG,RADER,RADEB,RADET,RADKR,RADKG,RADKB,RADKT,
     1  RADKK,RADGB,RADGT,RAGGR,RADBT,RADTT,RADTR,RADES,RADSS
      COMMON/TBEAMS/IFGHTM,ITRMEN(20),JUP,JFROM,IBMEN,JDOWN,JTO,IBMENR,
     1  SBMNR,CREWR(9),SCREWR,CREWK,CODDS,DODDS,EODDS,FODDS
      COMMON/SUBCTL/ICNTL(20),RTBRG(5),KTO,LTO,KBRG,XWRP,
     1  ISTAT,IDAMRP,SDEF,IMSG,SKDLAY,SRDLY,GHVMX,MXCRGH,GHPHEN,
     1  DSPGH,DGGH,RPRGH,NHELP,NHELPS,XHELP
      DATA GETHRU/.8/
      COMMON/ATTACK/ITKL(18),JTKL(18)
      COMMON/EXTRAS/SNOVAP,ZMAX,ICLOAK,PRCLDN,PHOLE,IHOLE,JHOLE,HOLRAD,
     1  SHLDF,NQUAD,PSTORM,ISTORM,JSTORM,STMRAD,LEVEL,ION,IYES,CMIN,
     1  CPOWR
C     ...PHASER FIRING ROUTINE FOR E AND G.
      NDX=(ITYPE-3)*9+NUM+1
      IF(ICNTL(NDX).EQ.1)GO TO 99
      CALL GETBRG(DELV,XQE,A1,YQE,A2,VPX,VPY)
      DELTA=360.
      IF(EFP(2).EQ.3.)DELTA=180.
      DELV=DELTA-PDEG+DELV
      IF(DELV.GE.360.)DELV=DELV-360.
      IF(DELV.LT.0.)DELV=DELV+360.
      IF(DELV.GT.90..AND.DELV.LE.270.)DELV=90.
      IF(DELV.GT.270.)DELV=360.-DELV
      IF(DELV.GE.90.)GO TO 99
C     ...CALCULATE STRENGTH OF HIT DEPENDING ON BEARING
C     ...TO TARGET AND DISTANCE.
      DELV=COSD(DELV)*COSD(DELV)*DISTPE*EFP(3)/(VPX*VPX+VPY*VPY)
C     ...MASKING EFFECTS. 80 PERCENT GETS THROUGH ANYWAY
      IF(LEVEL.EQ.1)GO TO 2310
      CALL MASKEF(A1,A2,XQE,YQE,VPY)
      DELV=DELV-VPY*DELV*GETHRU
2310  IF( ITYPE.EQ.4.AND.ICLOAK.EQ.2.AND.NUM.EQ.1)GO TO 2311
      WRITE(6,2314)DELV,LETR(ITYPE),NUM,A1,A2
2314  FORMAT(1X,F7.1,' UNIT HIT ON ',A1,I1,' AT ',F4.1,',',F4.1)
      GO TO 2315
2311  WRITE(6,2312)DELV,LETR(ITYPE),NUM
2312  FORMAT(1X,F7.1,' UNIT HIT ON ',A1,I1)
2315  A3=A3+DELV
C     ...CHECK IF TOTAL HITS=DESTRUCTION.
      IF(A3.LT.TMXH)GO TO 100
50    CALL DLETE(ITYPE,NUM)
      IF(ITYPE.EQ.3)A1=XKL(NUM,1)
      IF(ITYPE.EQ.4)A1=XROM(NUM,1)
99    RETURN
C     ...HITS AFFECT CREW AND ANY TROOPS ON BOARD ALSO.
100   IF(ITRMEN(NDX).EQ.0)GO TO 60
      IX=RAN(IZZ)*SQRT(DELV)*2.5
      IF(IX.GT.ITRMEN(NDX))IX=ITRMEN(NDX)
      ITRMEN(NDX)=ITRMEN(NDX)-IX
      ITKL(NDX-1)=ITKL(NDX-1)+IX
60    IF(ITYPE.EQ.4)GO TO 200
      IX=RAN(IZZ)*2.5*SQRT(DELV)
      XKL(NUM,9)=XKL(NUM,9)-IX
      IF(XKL(NUM,9).LE.0.)GO TO 50
      JTKL(NUM)=JTKL(NUM)+IX
      GO TO 99
200   IX=RAN(IZZ)*2.5*SQRT(DELV)
      CREWR(NUM)=CREWR(NUM)-IX
      IF(CREWR(NUM).LE.0.)GO TO 50
      JTKL(NUM+9)=JTKL(NUM+9)+IX
      GO TO 99
      END
      SUBROUTINE EPMOVE(IS)
      COMMON/ARRAYS/NAMD(10),BASE(2),EFP(3),EFT(25,2),ETR(3),GHOST(13),
     1  IBL(10,10),IDMG(10),IGAL(10,10),IPQ(10,10),JGAL(10,10),LETR(13),
     1  IPROB1(10),RAD(9),STARS(9,2),TORPS(30,4),XKL(9,9),XROM(9,4)
      DOUBLE PRECISION NAMD
      COMMON/SCALAR/ACCE,DCHG,DDEG,DECR,DEFL,DELTA,DELV,DGIMP,DGKL,DGWP,
     1  DISTGT,DISTKR,DISTPE,DISTPK,DIV1,DIV2,DMXSPD,DSP,DSPKL,DVEL,
     1  DVIMP,DVWP,EEVMSP,EIMP,ENERGY,ERPRRT,ESDIST,ETVEL,EVENU,EVMSP,
     1  EWRP,FDATE,GHEMX,GHTMX,IBASE,ICE,IDOCK,IETOFT,IGH,IHERE,IHWARP,
     1  ISTART,ITFCTR,ITFIRE,ITORP,ITRUCE,IZZ,JCE,KLNGNS,XKTIME,
     1  LEFTK,LEFTR,MAXBQ,MAXK,MAXKQ,MAXR,MAXRQ,MAXSQ,MEN,MINK,MINR,
     1  MROM,MULTK1,MULTK2,NBASES,NKL,NMEN,NROM,NSTARS,NSTEPS,NTORPS,
     1  NTSTPS,NTRP,PCTCOL,PDEG,PNRGY,PRGH,PRKLN,PRREEN,PSP,PTRGH,
     1  RADEGC,REEN,RPRKL,RPRRM,RTIME,RTV,SDATE,SENRGY,
     1  SIM,TFACTR,THITR,TNRGY,TPMIN,TPOWR,VMXKL,VRKL,XDDEG,XDSP,XGHIT,
     1  XKFPE,XKFPST,XKLHIT,XRFTS,XRMHIT,XQE,XTIME,XTRTM,YQE,ZMIN,
     1  PRORAS,RADEK,RADEG,RADER,RADEB,RADET,RADKR,RADKG,RADKB,RADKT,
     1  RADKK,RADGB,RADGT,RAGGR,RADBT,RADTT,RADTR,RADES,RADSS
      COMMON/TBEAMS/IFGHTM,ITRMEN(20),JUP,JFROM,IBMEN,JDOWN,JTO,IBMENR,
     1  SBMNR,CREWR(9),SCREWR,CREWK,CODDS,DODDS,EODDS,FODDS
      COMMON/SUBCTL/ICNTL(20),RTBRG(5),KTO,LTO,KBRG,XWRP,
     1  ISTAT,IDAMRP,SDEF,IMSG,SKDLAY,SRDLY,GHVMX,MXCRGH,GHPHEN,
     1  DSPGH,DGGH,RPRGH,NHELP,NHELPS,XHELP
      COMMON/SHUTL/SHX,SHY,SHDEG,SHVX,ISTSH,ISHD,IFNDS(9),IDSES,VDSES,
     1  VSTRDS,VSTRM,PRXSH,VDSESM,ISHNUM
      COMMON/SHUTL2/ALEDR,IALIC,IALJC,IALSS,NDRA,NTROPS,DRL,DRD
      COMMON/EXTRAS/SNOVAP,ZMAX,ICLOAK,PRCLDN,PHOLE,IHOLE,JHOLE,HOLRAD,
     1  SHLDF,NQUAD,PSTORM,ISTORM,JSTORM,STMRAD,LEVEL,ION,IYES,CMIN,
     1  CPOWR
      COMMON/GRAPH/IGRAPH,NOLINE
      IF(IS.LT.0)GO TO 8001
      IS=0
      PRSPD=PSP
C     ...DETERMINE WHICH DRIVE TO USE DEPENDING ON DAMAGE IF ANY
      ACCE=EWRP
      DCHG=DGWP
      DVEL=DVWP
C     ...IF UNDER ALIEN CONTROL, USE W DRIVE EVEN IF DAMAGED.
      IF(NDRA.EQ.1)GO TO 2005
      IF(NBASES.EQ.99)DVEL=DVWP*2.
      IF(IDMG(1).EQ.0)GO TO 2005
      DSP=AMIN1(DSP,AMAX1(PSP,SIM))
      NBASES=0
      ACCE=EIMP
      DCHG=DGIMP
      DVEL=DVIMP
C     ...IF BOTH DAMAGED, COME TO DEAD STOP.
      IF(IDMG(2).NE.0)DSP=PSP
C     ...E MOVEMENT. CHECK WHETHER ACCELERATING OR NOT.
2005  IF(PSP.EQ.DSP.AND.PDEG.EQ.DDEG)GO TO 2090
C     ...ACCELERATION. DCHG IS DEGREES CHANGE PER STEP; DVEL-VEL. CHG.
      DELTA=0.
      IF(DDEG.EQ.PDEG)GO TO 2010
      DELTA=DDEG-PDEG
      IF(ABS(DELTA).GT.180.)DELTA=DELTA-SIGN(360.,DELTA)
      IF(ABS(DELTA).GT.DCHG)DELTA=SIGN(DCHG,DELTA)
      PDEG=PDEG+DELTA
      IF(PDEG.GE.360.)PDEG=PDEG-360.
      IF(PDEG.LT.0.)PDEG=PDEG+360.
      IF(PDEG.NE.DDEG)GO TO 2010
      WRITE(6,2009)PDEG
2009  FORMAT(' A DESIRED BEARING OF ',F4.0,' HAS BEEN ATTAINED')
2010  DELV=0.
      IF(PSP.EQ.DSP)GO TO 2020
      DELV=SIGN(DVEL,DSP-PSP)
      IF(ABS(DSP-PSP).LT.ABS(DELV))DELV=DSP-PSP
      PSP=PSP+DELV
      IF(PSP.NE.DSP)GO TO 2020
      WRITE(6,2019)PSP
2019  FORMAT(' A DESIRED SPEED OF ',F5.3,' HAS BEEN ATTAINED')
2020  IF(PRSPD.GE.1..OR.PSP.LT.1.)GO TO 2017
      WRITE(6,2018)
2018  FORMAT(' ENTERING HYPERSPACE')
C     ...DELETE SCHEDULED ACTIVITIES IF ENTERING HYPERSPACE
      ETR(1)=0.
      EFP(1)=0.
      EFT(1,1)=0.
      IHERE=0
      ITORP=ITORP+ITFIRE
      ITFIRE=0
C     ...CALCULATE ENERGY USAGE. PROP TO CHG IN VEL SQRD.
2017  ENERGY=ENERGY-((((PSP-DELV)/2.)**2)*(2.-2.*COSD(ABS(DELTA)))+DELV*
     1DELV)*ACCE
      IF(ENERGY.LE.0.)CALL RATING(2)
C     ...CALCULATE POSITION CHANGE
      DX=COSD(PDEG-DELTA/2.)*(PSP-DELV/2.)
      DY=SIND(PDEG-DELTA/2.)*(PSP-DELV/2.)
C     ...E UNDER ALIEN CONTROL. RANDOM COURSE AND SPEED
C     ...CHANGES AT WARP SPEEDS.
      IF(NDRA.NE.1)GO TO 20231
20237 IF(RAN(IZZ).GE..3)GO TO 20232
      DDEG=RAN(IZZ)*360.
      DSP=1.+RAN(IZZ)
20232 IF(RAN(IZZ).GE.DRL)GO TO 20231
      SDAYS=RAN(IZZ)*DRD+.5
      IDMG(1)=IDMG(1)+SDAYS*100.
      WRITE(6,2998)NAMD(1),PSP
2998  FORMAT(' CHIEF SURGEON DESTROYS ENERGY FORMS WITH ANTIMATTER VIRUS
     1'/      ' BUT ',A10,' DAMAGED. DRIFTING...PRESENT SPEED: ',F5.3)
      DSP=PSP
      NDRA=0
      GO TO 2021
20231 IF(NBASES.NE.99)GO TO 2021
      IF(PSP.NE.1.1)GO TO 2021
      NBASES=0
C     ...CHECK IF DAMAGED IN EMERG. EVSV. MANEUVERS.
      IF(RAN(IZZ).GT.XKTIME)GO TO 2021
      SDAYS=RAN(IZZ)*XKTIME*5.
      IDMG(1)=IDMG(1)+SDAYS*100.
      WRITE(6,2999)NAMD(1)
2999  FORMAT(1X,A10,' DAMAGED DURING EMERGENCY EVASIVE MANEUVERS.')
C     ...MOVE E.
2021  XQE=XQE+DX
      YQE=YQE+DY
      IF(IDOCK.NE.2)GO TO 2022
      IS=1
      IF(RANGE(XQE,BASE(1),YQE,BASE(2)).GT.RADEB)IDOCK=0
C     ...CHECK IF LEAVING QUADRANT OR GALAXY
2022  IF(XQE.LT.10.5)GO TO 2030
      L=ICE
      ICE=ICE+1
      IF(ICE.GT.NQUAD)GO TO 8001
      CALL BPAGE(NOLINE)
      WRITE(6,2029)L,JCE,ICE,JCE
2029  FORMAT(' LEAVING QUADRANT  ',I2,',',I2/' ENTERING QUADRANT ',
     1      I2,',',I2)
C     ...CORRECT POSITION IN NEW QUADRANT. SET SCAN POINTER TO GENERATE
C     RS.
      XQE=XQE-10.
      ISCAN=1
      IHERE=0
      GO TO 2040
2030  IF(XQE.GE..5)GO TO 2040
      L=ICE
      ICE=ICE-1
      IF(ICE.EQ.0)GO TO 8001
      CALL BPAGE(NOLINE)
      WRITE(6,2029)L,JCE,ICE,JCE
      XQE=XQE+10.
      ISCAN=1
      IHERE=0
2040  IF(YQE.LT.10.5)GO TO 2050
      L=JCE
      JCE=JCE+1
      IF(JCE.GT.NQUAD)GO TO 8001
      CALL BPAGE(NOLINE)
      WRITE(6,2029)ICE,L,ICE,JCE
      YQE=YQE-10.
      ISCAN=1
      IHERE=0
      GO TO 2100
2050  IF(YQE.GE..5)GO TO 2100
      L=JCE
      JCE=JCE-1
      IF(JCE.EQ.0)GO TO 8001
      CALL BPAGE(NOLINE)
      WRITE(6,2029)ICE,L,ICE,JCE
      YQE=YQE+10.
      ISCAN=1
      IHERE=0
      GO TO 2100
C     ...MOVEMENT WITHOUT ACCELERATION.
2090  DX=COSD(PDEG)*PSP
      DY=SIND(PDEG)*PSP
      IF(NDRA.EQ.1)GO TO 20237
      GO TO 2021
C     ...END OF E MOVEMENT. IF WARP 1 OR HIGHER, NO ACT. EXC. E DMG RPR.
C     ..BE SURE TO SET SCAN POINTER IF REMATERIALIZING IN SAME QUAD.
2100  IF(PSP.GE.1..OR.PRSPD.LT.1.)GO TO 2105
      IF(ISCAN.EQ.1)GO TO 2110
      IHERE=1
      GO TO 2110
2105  IF(PSP.GE.1.)GO TO 2800
C     ...GENERATE SCAN IF NECESSARY.
      IF(ISCAN.EQ.0)GO TO 2150
2110  ISCAN=0
      CALL SCAN
      CALL QTIME(JTIME)
      ISTART=JTIME
2800  IS=1
2150  RETURN
8001  WRITE(6,8002)
8002  FORMAT(' GALACTIC LIMITS EXCEEDED! SPACE-TIME WARP!!')
      X=PSP*ZMIN
      CALL HITONE(0,X,-1)
C     ...YOU MAY GAIN OR LOSE TIME.
      Y=RAN(IZZ)*3.
      IF(RAN(IZZ).LE.XKTIME)Y=-Y
      XTIME=XTIME-Y
      IF(XTIME.LE.0.)CALL RATING(3)
      SDATE=SDATE+Y
      IF(IS.GE.0)GO TO 8003
      KCE=IBL(ICE,JCE)/100
      LCE=IBL(ICE,JCE)-(KCE*100)
      GO TO 8035
8003  KCE=RAN(IZZ)*NQUAD+1.
      LCE=RAN(IZZ)*NQUAD+1.
      IF(ICE.EQ.KCE.AND.LCE.EQ.JCE)GO TO 8003
8035  ICE=KCE
      JCE=LCE
      WRITE(6,8004)ICE,JCE
8004  FORMAT(' NOW IN QUADRANT ',I2,',',I2)
      IHERE=0
      EFT(1,1)=0.
      ETR(1)=0.
      EFP(1)=0.
      PNRGY=0.
      ITORP=ITORP+ITFIRE
      ITFIRE=0
      IX=AMIN1(RAN(IZZ)*10.+1.,10.)
      IY=AMIN1(RAN(IZZ)*10.+1.,10.)
      XQE=IX
      YQE=IY
      CALL SCAN
      IF(NDRA.EQ.1)DSP=1.+RAN(IZZ)
      IS=2
      GO TO 2150
      END
      SUBROUTINE EPULSE
      COMMON/ARRAYS/NAMD(10),BASE(2),EFP(3),EFT(25,2),ETR(3),GHOST(13),
     1  IBL(10,10),IDMG(10),IGAL(10,10),IPQ(10,10),JGAL(10,10),LETR(13),
     1  IPROB1(10),RAD(9),STARS(9,2),TORPS(30,4),XKL(9,9),XROM(9,4)
      DOUBLE PRECISION NAMD
      COMMON/SCALAR/ACCE,DCHG,DDEG,DECR,DEFL,DELTA,DELV,DGIMP,DGKL,DGWP,
     1  DISTGT,DISTKR,DISTPE,DISTPK,DIV1,DIV2,DMXSPD,DSP,DSPKL,DVEL,
     1  DVIMP,DVWP,EEVMSP,EIMP,ENERGY,ERPRRT,ESDIST,ETVEL,EVENU,EVMSP,
     1  EWRP,FDATE,GHEMX,GHTMX,IBASE,ICE,IDOCK,IETOFT,IGH,IHERE,IHWARP,
     1  ISTART,ITFCTR,ITFIRE,ITORP,ITRUCE,IZZ,JCE,KLNGNS,XKTIME,
     1  LEFTK,LEFTR,MAXBQ,MAXK,MAXKQ,MAXR,MAXRQ,MAXSQ,MEN,MINK,MINR,
     1  MROM,MULTK1,MULTK2,NBASES,NKL,NMEN,NROM,NSTARS,NSTEPS,NTORPS,
     1  NTSTPS,NTRP,PCTCOL,PDEG,PNRGY,PRGH,PRKLN,PRREEN,PSP,PTRGH,
     1  RADEGC,REEN,RPRKL,RPRRM,RTIME,RTV,SDATE,SENRGY,
     1  SIM,TFACTR,THITR,TNRGY,TPMIN,TPOWR,VMXKL,VRKL,XDDEG,XDSP,XGHIT,
     1  XKFPE,XKFPST,XKLHIT,XRFTS,XRMHIT,XQE,XTIME,XTRTM,YQE,ZMIN,
     1  PRORAS,RADEK,RADEG,RADER,RADEB,RADET,RADKR,RADKG,RADKB,RADKT,
     1  RADKK,RADGB,RADGT,RAGGR,RADBT,RADTT,RADTR,RADES,RADSS
      COMMON/TBEAMS/IFGHTM,ITRMEN(20),JUP,JFROM,IBMEN,JDOWN,JTO,IBMENR,
     1  SBMNR,CREWR(9),SCREWR,CREWK,CODDS,DODDS,EODDS,FODDS
      COMMON/SUBCTL/ICNTL(20),RTBRG(5),KTO,LTO,KBRG,XWRP,
     1  ISTAT,IDAMRP,SDEF,IMSG,SKDLAY,SRDLY,GHVMX,MXCRGH,GHPHEN,
     1  DSPGH,DGGH,RPRGH,NHELP,NHELPS,XHELP
C     ...PULSIVE BEAMS.
2400  EFP(1)=0.
      CALL CHEKDG(6,IR)
      IF(IR.EQ.1)GO TO 2490
      IF(ETR(2).NE.1.)GO TO 2450
C     ...COMPUTER CALCULATES STRENGTH TO PULL IN G.
      IF(IGH.NE.0)GO TO 2402
      WRITE(6,2401)LETR(5)
2401  FORMAT(' NO ',A1,' IN QUADRANT')
      PNRGY=0.
      WRITE(6,2403)
2403  FORMAT(' PULSIVE BEAMS TURNED OFF')
      GO TO 2500
2402  DELV=(GHOST(1)-XQE)**2+(GHOST(2)-YQE)**2
      DELV=DELV/DISTGT*PTRGH
      ENERGY=ENERGY-DELV
      WRITE(6,2407)LETR(5),IGH,GHOST(1),GHOST(2)
2407  FORMAT(' PULSIVE BEAMS LOCKED ON ',A1,I1, ' AT ',F4.1,',',F4.1)
      IF(ENERGY.LE.0.)CALL RATING(2)
      IF(DEFL.NE.0.)GO TO 2410
      WRITE(6,2404)
2404  FORMAT(' DOCKED WITH GHOSTSHIP!')
C     ...PART OF ENERGY MAY BE LOST DUE TO PHASER HITS.
      ENERGY=ENERGY+GHOST(11)+GHOST(13)-GHOST(3)
      ITORP=ITORP+GHOST(12)
      ITRMEN(1)=ITRMEN(1)+ITRMEN(20)
      ITRMEN(20)=0
      WRITE(6,2405)ENERGY,ITORP
2405  FORMAT(' ENERGY = ',F8.2,' TORPEDOS - ',I2)
      IGH=0
      GO TO 2500
C     ...SHELDS NOT DOWN IMPLIES COLLISION.
2410  WRITE(6,2153)LETR(2),LETR(5)
2153  FORMAT(1X,A1,' COLLISION WITH ',A1)
      WRITE(6,2154)
2154  FORMAT(' SHIELDS DESTROYED')
      CALL DLETE(5,0)
      Y=(CPOWR+CPOWR*PSP)/SHLDF
      CALL HITONE(0,Y,5)
      GO TO 2500
C     ...LOCK ON NEAREST K FOR R BEAMS.
2450  ETR(1)=0.
      IF(KLNGNS.NE.0)GO TO 2460
2455  WRITE(6,2401)LETR(3)
      WRITE(6,2403)
      PNRGY=0.
      ETR(1)=0.
      GO TO 2500
2460  PNRGY=0.
      JJ=-ETR(2)
      IF(XKL(JJ,1).EQ.0.)GO TO 2455
      DELV=(XQE-XKL(JJ,1))**2+(YQE-XKL(JJ,2))**2
      WRITE(6,2407)LETR(3),JJ,XKL(JJ,1),XKL(JJ,2)
      ENERGY=ENERGY-ETR(3)
      IF(ENERGY.LE.0.)CALL RATING(2)
      DELV=DISTKR/DELV*ETR(3)/PRKLN
C     ...MOVE K. REDUCE SPEED ACCORDINGLY.
      CALL GETBRG(DELTA,XQE,XKL(JJ,1),YQE,XKL(JJ,2),VPX,VPY)
      VPX=COSD(DELTA)*DELV
      VPY=SIND(DELTA)*DELV
      DELTA=ABS(DELV)/VRKL
      XKL(JJ,1)=XKL(JJ,1)+VPX
      XKL(JJ,2)=XKL(JJ,2)+VPY
      XKL(JJ,3)=XKL(JJ,3)-DELTA
      IF(XKL(JJ,3).LT.0.)XKL(JJ,3)=0.
C     ...CHECK IF FORCED OUT OF QUADRANT.
      CALL KLQ(JJ,IR)
      IF(IR.GE.1)GO TO 2500
C     ...PRINT APPROPRIATE MESSAGE.
      WRITE(6,2471)LETR(3),JJ,(XKL(JJ,KK),KK=1,4)
2471  FORMAT(1X,A1,I1,' MOVED TO ',F4.1,',',F4.1,' SPEED: ',F5.3,
     1             ' BEARING: ',F4.0)
      GO TO 2500
C     ...UBIQUITOUS DAMAGE CONTROL.
2490  PNRGY=0.
2500  ETR(1)=0.
      RETURN
      END
      SUBROUTINE FIGHT
      COMMON/ARRAYS/NAMD(10),BASE(2),EFP(3),EFT(25,2),ETR(3),GHOST(13),
     1  IBL(10,10),IDMG(10),IGAL(10,10),IPQ(10,10),JGAL(10,10),LETR(13),
     1  IPROB1(10),RAD(9),STARS(9,2),TORPS(30,4),XKL(9,9),XROM(9,4)
      DOUBLE PRECISION NAMD
      COMMON/SCALAR/ACCE,DCHG,DDEG,DECR,DEFL,DELTA,DELV,DGIMP,DGKL,DGWP,
     1  DISTGT,DISTKR,DISTPE,DISTPK,DIV1,DIV2,DMXSPD,DSP,DSPKL,DVEL,
     1  DVIMP,DVWP,EEVMSP,EIMP,ENERGY,ERPRRT,ESDIST,ETVEL,EVENU,EVMSP,
     1  EWRP,FDATE,GHEMX,GHTMX,IBASE,ICE,IDOCK,IETOFT,IGH,IHERE,IHWARP,
     1  ISTART,ITFCTR,ITFIRE,ITORP,ITRUCE,IZZ,JCE,KLNGNS,XKTIME,
     1  LEFTK,LEFTR,MAXBQ,MAXK,MAXKQ,MAXR,MAXRQ,MAXSQ,MEN,MINK,MINR,
     1  MROM,MULTK1,MULTK2,NBASES,NKL,NMEN,NROM,NSTARS,NSTEPS,NTORPS,
     1  NTSTPS,NTRP,PCTCOL,PDEG,PNRGY,PRGH,PRKLN,PRREEN,PSP,PTRGH,
     1  RADEGC,REEN,RPRKL,RPRRM,RTIME,RTV,SDATE,SENRGY,
     1  SIM,TFACTR,THITR,TNRGY,TPMIN,TPOWR,VMXKL,VRKL,XDDEG,XDSP,XGHIT,
     1  XKFPE,XKFPST,XKLHIT,XRFTS,XRMHIT,XQE,XTIME,XTRTM,YQE,ZMIN,
     1  PRORAS,RADEK,RADEG,RADER,RADEB,RADET,RADKR,RADKG,RADKB,RADKT,
     1  RADKK,RADGB,RADGT,RAGGR,RADBT,RADTT,RADTR,RADES,RADSS
      COMMON/TBEAMS/IFGHTM,ITRMEN(20),JUP,JFROM,IBMEN,JDOWN,JTO,IBMENR,
     1  SBMNR,CREWR(9),SCREWR,CREWK,CODDS,DODDS,EODDS,FODDS
      COMMON/SUBCTL/ICNTL(20),RTBRG(5),KTO,LTO,KBRG,XWRP,
     1  ISTAT,IDAMRP,SDEF,IMSG,SKDLAY,SRDLY,GHVMX,MXCRGH,GHPHEN,
     1  DSPGH,DGGH,RPRGH,NHELP,NHELPS,XHELP
      COMMON/ATTACK/ITKL(18),JTKL(18)
      COMMON/EXTRAS/SNOVAP,ZMAX,ICLOAK,PRCLDN,PHOLE,IHOLE,JHOLE,HOLRAD,
     1  SHLDF,NQUAD,PSTORM,ISTORM,JSTORM,STMRAD,LEVEL,ION,IYES,CMIN,
     1  CPOWR
C     ...COMBAT ON BOARD K OR R.
      DO 100    I=2,18
      IF(ITRMEN(I).EQ.0)GO TO 100
      IF(I.GT.10)GO TO 50
C     ...KLINGON.
      J=I-1
      IF(J.GT.KLNGNS)GO TO 90
      IF(XKL(J,1).EQ.0.)GO TO 100
      IF(ICNTL(I).EQ.1)GO TO 100
      IF(XKL(J,9).LE.0.)STOP
      ODDS=SQRT(ITRMEN(I)/XKL(J,9))
      KILLK=ODDS*CODDS*ITRMEN(I)
      KILLK=KILLK+SIGN(RAN(IZZ)*SQRT(FLOAT(KILLK)),.5-RAN(IZZ))
      IF(KILLK.LE.0)KILLK=1
      KILLE=1./ODDS*DODDS*XKL(J,9)
      KILLE=KILLE+SIGN(RAN(IZZ)*SQRT(FLOAT(KILLE)),.5-RAN(IZZ))
      IF(KILLE.LE.0)KILLE=1
      IF(KILLE.GT.ITRMEN(I))KILLE=ITRMEN(I)
      IF(KILLK.GT.XKL(J,9))KILLK=XKL(J,9)
      WRITE(6,1)LETR(3),J,XKL(J,1),XKL(J,2),KILLK,KILLE
1     FORMAT(' FIGHTING ON ',A1,I1,' AT ',F4.1,',',F4.1/' ENEMY LOSSES:
     1',I4,      ' ENTERPRISE LOSSES: ',I4)
      ITRMEN(I)=ITRMEN(I)-KILLE
      ITKL(I-1)=ITKL(I-1)+KILLE
      JTKL(I-1)=JTKL(I-1)+KILLK
      XKL(J,9)=XKL(J,9)-KILLK
      IF(XKL(J,9).GT.0.)GO TO 100
      WRITE(6,2)LETR(3),J
2     FORMAT(1X,A1,I1,' CAPTURED!')
      ICNTL(I)=1
      WRITE(6,3)ITKL(I-1),JTKL(I-1)
3     FORMAT(' TROOPS KILLED: ',I3,' ENEMY KILLED: ',I3)
      ITKL(I-1)=0
      JTKL(I-1)=0
      XKL(J,5)=0.
      XKL(J,8)=0.
      GO TO 100
C     ...ROMULAN.
50    J=I-10
      IF(J.GT.NROM)GO TO 90
      IF(XROM(J,1).EQ.0.)GO TO 100
      IF(ICNTL(I).EQ.1)GO TO 100
      IF(CREWR(J).LE.0.)STOP
      ODDS=SQRT(ITRMEN(I)/CREWR(J))
      KILLR=ODDS*EODDS*ITRMEN(I)
      KILLR=KILLR+SIGN(RAN(IZZ)*SQRT(FLOAT(KILLR)),.5-RAN(IZZ))
      IF(KILLR.LE.0)KILLR=0
      KILLE=1./ODDS*FODDS*CREWR(J)
      KILLE=KILLE+SIGN(RAN(IZZ)*SQRT(FLOAT(KILLE)),.5-RAN(IZZ))
      IF(KILLE.LE.0)KILLE=1
      IF(KILLE.GT.ITRMEN(I))KILLE=ITRMEN(I)
      IF(KILLR.GT.CREWR(J))KILLR=CREWR(J)
      WRITE(6,1)LETR(4),J,XROM(J,1),XROM(J,2),KILLR,KILLE
      ITKL(I-1)=ITKL(I-1)+KILLE
      JTKL(I-1)=JTKL(I-1)+KILLR
      ITRMEN(I)=ITRMEN(I)-KILLE
      CREWR(J)=CREWR(J)-KILLR
      IF(CREWR(J).GT.0.)GO TO 100
      WRITE(6,2)LETR(4),J
      ICNTL(I)=1
      WRITE(6,3)ITKL(I-1),JTKL(I-1)
      ITKL(I-1)=0
      JTKL(I-1)=0
      XROM(J,4)=0.
      IF(J.NE.1.OR.ICLOAK.NE.2)GO TO 100
      SDAYS=RAN(IZZ)*XTIME*.1
      SDAYS=SDAYS+SIGN(RAN(IZZ)*SDAYS*.3,.5-RAN(IZZ))
      WRITE(6,4)SDAYS
4     FORMAT(' CLOAKING DEVICE CAPTURED!'/' YOU MAY USE IT FOR ',      F
     15.2,' STARDAYS BEFORE THE ENEMY CATCHES ON.')
      ICLOAK=-SDAYS*100.
      GO TO 100
C     ...VESSEL NO LONGER EXISTS.
90    ITRMEN(I)=0
100   CONTINUE
      RETURN
      END
      SUBROUTINE GETBRG(ANGLE,X1,X2,Y1,Y2,DX,DY)
C     ...CALCULATE BEARING FROM OBJECT A TO OBJECT B
      DX=X2-X1
      DY=Y2-Y1
      ANGLE=ATAN2(DY,DX)*57.2957
      IF(ANGLE.LT.0.)ANGLE=ANGLE+360.
      RETURN
      END
      SUBROUTINE GHACTV
      COMMON/ARRAYS/NAMD(10),BASE(2),EFP(3),EFT(25,2),ETR(3),GHOST(13),
     1  IBL(10,10),IDMG(10),IGAL(10,10),IPQ(10,10),JGAL(10,10),LETR(13),
     1  IPROB1(10),RAD(9),STARS(9,2),TORPS(30,4),XKL(9,9),XROM(9,4)
      DOUBLE PRECISION NAMD
      COMMON/SCALAR/ACCE,DCHG,DDEG,DECR,DEFL,DELTA,DELV,DGIMP,DGKL,DGWP,
     1  DISTGT,DISTKR,DISTPE,DISTPK,DIV1,DIV2,DMXSPD,DSP,DSPKL,DVEL,
     1  DVIMP,DVWP,EEVMSP,EIMP,ENERGY,ERPRRT,ESDIST,ETVEL,EVENU,EVMSP,
     1  EWRP,FDATE,GHEMX,GHTMX,IBASE,ICE,IDOCK,IETOFT,IGH,IHERE,IHWARP,
     1  ISTART,ITFCTR,ITFIRE,ITORP,ITRUCE,IZZ,JCE,KLNGNS,XKTIME,
     1  LEFTK,LEFTR,MAXBQ,MAXK,MAXKQ,MAXR,MAXRQ,MAXSQ,MEN,MINK,MINR,
     1  MROM,MULTK1,MULTK2,NBASES,NKL,NMEN,NROM,NSTARS,NSTEPS,NTORPS,
     1  NTSTPS,NTRP,PCTCOL,PDEG,PNRGY,PRGH,PRKLN,PRREEN,PSP,PTRGH,
     1  RADEGC,REEN,RPRKL,RPRRM,RTIME,RTV,SDATE,SENRGY,
     1  SIM,TFACTR,THITR,TNRGY,TPMIN,TPOWR,VMXKL,VRKL,XDDEG,XDSP,XGHIT,
     1  XKFPE,XKFPST,XKLHIT,XRFTS,XRMHIT,XQE,XTIME,XTRTM,YQE,ZMIN,
     1  PRORAS,RADEK,RADEG,RADER,RADEB,RADET,RADKR,RADKG,RADKB,RADKT,
     1  RADKK,RADGB,RADGT,RAGGR,RADBT,RADTT,RADTR,RADES,RADSS
      COMMON/TBEAMS/IFGHTM,ITRMEN(20),JUP,JFROM,IBMEN,JDOWN,JTO,IBMENR,
     1  SBMNR,CREWR(9),SCREWR,CREWK,CODDS,DODDS,EODDS,FODDS
      COMMON/SUBCTL/ICNTL(20),RTBRG(5),KTO,LTO,KBRG,XWRP,
     1  ISTAT,IDAMRP,SDEF,IMSG,SKDLAY,SRDLY,GHVMX,MXCRGH,GHPHEN,
     1  DSPGH,DGGH,RPRGH,NHELP,NHELPS,XHELP
      COMMON/FORGOT/GHACCE,PJAM,PJMINC,ACTPJM,PPHASD,PTORPD,PDRVD,
     1  PDEFD,IGHPH,IGHTR,IGHDR,IGHDE
      COMMON/EXTRAS/SNOVAP,ZMAX,ICLOAK,PRCLDN,PHOLE,IHOLE,JHOLE,HOLRAD,
     1  SHLDF,NQUAD,PSTORM,ISTORM,JSTORM,STMRAD,LEVEL,ION,IYES,CMIN,
     1  CPOWR
      DIMENSION SAVE(6)
C     ...GHOSTSHIP ACTIVITIES.
      I3=3
      I4=4
C     ...MOVEMENT.    USES ENERGY.
      J1=0
      J2=0
      IF(GHOST(5).NE.GHOST(7))J2=1
      IF(GHOST(4).EQ.0..AND.GHOST(6).EQ.0.)GO TO 100
      IF(GHOST(4).NE.GHOST(6))J1=1
      VSX=GHOST(4)-AMIN1(ABS(GHOST(6)-GHOST(4)),DSPGH)/2.
      VSX=VSX*VSX
      VSY=COSD(AMIN1(ABS(GHOST(7)-GHOST(5)),DGGH))
      GHOST(11)=GHOST(11)-(VSX*(2.-2.*VSY)+(AMIN1(ABS(GHOST(6)-GHOST(4))
     1,DSPGH)**2))*GHACCE
      IF(GHOST(11).LE.0.)GO TO 900
100   CALL OMOVE(GHOST(1),GHOST(2),GHOST(4),GHOST(5),GHOST(6),GHOST(7),
     1     DSPGH,DGGH)
      IF(J1.EQ.1.AND.GHOST(4).EQ.GHOST(6))WRITE(6,1)GHOST(4)
1     FORMAT(' G DESIRED SPEED OF ',F5.3,' ATTAINED')
      IF(J2.EQ.1.AND.GHOST(5).EQ.GHOST(7))WRITE(6,2)GHOST(5)
2     FORMAT(' G DESIRED BEARING OF ',F4.0,' ATTAINED')
C     ...CHECK IF LEAVING QUAD.
      IF(GHOST(1).LT..5.OR.GHOST(1).GE.10.5)GO TO 900
      IF(GHOST(2).LT..5.OR.GHOST(2).GE.10.5)GO TO 900
C     ...IF UNDER E CONTROL, DO OTHER ACTIVITIES.
      IF(GHOST(8).EQ.0..OR.GHOST(8).GT.NTSTPS)GO TO 500
C     ...FIRES T.
      IF(GHOST(12).LE.0.)GO TO 500
      IF(RTBRG(1).LT.0.)GO TO 500
      IF(NTORPS.NE.0)GO TO 200
      K=1
      NTORPS=30
      GO TO 275
200   DO 250 K=1,NTORPS
      IF(TORPS(K,1).EQ.0.)GO TO 275
250   CONTINUE
      GO TO 500
275   NT=K
      GHOST(12)=GHOST(12)-1.
      VPX=COSD(GHOST(5))*GHOST(4)+COSD(RTBRG(1))*.4
      VPY=SIND(GHOST(5))*GHOST(4)+SIND(RTBRG(1))*.4
      TORPS(NT,3)=SQRT(VPX*VPX+VPY*VPY)
      TORPS(NT,1)=GHOST(1)+VPX
      TORPS(NT,2)=GHOST(2)+VPY
      RTBRG(1)=-1.
      VSX=0.
      VSY=0.
      CALL GETBRG(DELTA,VSX,VPX,VSY,VPY,X,Y)
C     ...RESET TORP BEARING TO 360-720 RANGE.
      TORPS(NT,4)=DELTA+360.
      GHOST(8)=0.
      IF(RTBRG(2).LT.0.)GO TO 271
      GHOST(8)=NTSTPS+1+FLOAT(MIN0(MXCRGH,ITRMEN(20)))/FLOAT(ITRMEN(20))
      DO 270 K=1,4
270   RTBRG(K)=RTBRG(K+1)
      RTBRG(5)=-1.
271   WRITE(6,3)
3     FORMAT(' G TORPEDO LAUNCHED')
C     ...FIRES PHASERS.
500   IF(GHOST(10).EQ.0..OR.GHOST(10).GT.NTSTPS)GO TO 1000
      IF(GHOST(11).LE.0.)GO TO 2350
C     ...USES EPHIT, SO MUST MAY G LOOK LIKE E TO IT.
      WRITE(6,4)
4     FORMAT(' G FIRING PHASERS')
      SAVE(1)=XQE
      SAVE(2)=YQE
      SAVE(3)=PDEG
      SAVE(4)=EFP(3)
      SAVE(5)=EFP(2)
      SAVE(6)=DISTPE
      XQE=GHOST(1)
      YQE=GHOST(2)
      PDEG=GHOST(5)
      EFP(3)=AMIN1(GHPHEN,GHOST(11))
      GHOST(11)=GHOST(11)-EFP(3)
      EFP(2)=1.
      DISTPE=TNRGY
      IF(KLNGNS.EQ.0)GO TO 2320
      DO 2310 J=1,KLNGNS
      IF(XKL(J,1).EQ.0.)GO TO 2310
      IF(ICNTL(J+1).EQ.1)GO TO 2310
      CALL EPHIT(XKL(J,1),XKL(J,2),XKL(J,7),XKLHIT,I3,J)
2310  CONTINUE
2320  IF(NROM.EQ.0)GO TO 2340
C     ...HIT ON ROMULANS
      DO 2330 J=1,NROM
      IF(XROM(J,1).EQ.0.)GO TO 2330
      IF(ICNTL(J+10).EQ.1)GO TO 2330
      CALL EPHIT(XROM(J,1),XROM(J,2),XROM(J,3),XRMHIT,I4,J)
2330  CONTINUE
C     ...RESTORE VALUES.
2340  XQE=SAVE(1)
      YQE=SAVE(2)
      PDEG=SAVE(3)
      EFP(3)=SAVE(4)
      EFP(2)=SAVE(5)
      DISTPE=SAVE(6)
      GHOST(10)=0.
2350  N GHTFP=NGHTFP-1
      IF(NGHTFP.EQ.0)GO TO 1000
      GHOST(10)=NTSTPS+1+FLOAT(MIN0(MXCRGH,ITRMEN(20)))/      FLOAT(ITRM
     1EN(20))
      GO TO 1000
C     ...G OUT OF QUAD.
900   CALL DLETE(5,1)
1000  RETURN
      END
      SUBROUTINE HELP(ILVL)
      DIMENSION NLINE(59),LINEC(59)
      COMMON/FILVAR/IV
      DIMENSION INFO(18)
      DATA NCMDS/58/
C     ***INSERT DATA STATEMENTS FOR POINTERS TO HELP2 HERE.
      DATA NLINE/3,49,72,85,95,113,124,131,137,146,146,156,164,173,184,1
     193,203,212,218,228,236,248,256,260,264,274,286,294,307,324,339,345
     1,353,361,366,386,393,403,411,417,425,435,443,451,459,486,492,500,5
     108,515,521,525,541,556,563,601,606,614/
      DATA LINEC/43,20,10,7,15,8,4,3,6,7,7,5,6,8,6,7,6,3,7,5,9,5,1,1,7,9
     1,5,10,14,12,3,5,5,2,17,4,7,5,3,5,7,5,5,5,24,3,5,5,4,3,1,13,12,4,35
     1,2,5,87/
      DEFINE FILE 2(1000,72,L,IV)
C     ***
      IF(ILVL.NE.7777)GO TO 500
      WRITE(6,1)
1     FORMAT(' WHICH COMMAND WOULD YOU LIKE INFORMATION ABOUT?')
      READ(5,*,ERR=9,END=99)JCM
      IF(JCM.GT.0.AND.JCM.LE.NCMDS)GO TO 1000
9     RETURN
500   NPOS=NLINE(ILVL)
      NREADS=LINEC(ILVL)
      GO TO 4000
1000  NPOS=NLINE(JCM)
      NREADS=LINEC(JCM)
      CALL CPAGE
C     ...OUTPUT AREA.
4000  DO 5000 I=1,NREADS
      READ(2'NPOS,2,ERR=9)INFO
      WRITE(6,3)INFO
3     FORMAT(1X,18A4)
2     FORMAT(18A4)
      NPOS=NPOS+1
5000  CONTINUE
      GO TO 9
99    STOP
      END
      SUBROUTINE HITONE(ITYPE,HIT,IWHAT)
      COMMON/ARRAYS/NAMD(10),BASE(2),EFP(3),EFT(25,2),ETR(3),GHOST(13),
     1  IBL(10,10),IDMG(10),IGAL(10,10),IPQ(10,10),JGAL(10,10),LETR(13),
     1  IPROB1(10),RAD(9),STARS(9,2),TORPS(30,4),XKL(9,9),XROM(9,4)
      DOUBLE PRECISION NAMD
      COMMON/SCALAR/ACCE,DCHG,DDEG,DECR,DEFL,DELTA,DELV,DGIMP,DGKL,DGWP,
     1  DISTGT,DISTKR,DISTPE,DISTPK,DIV1,DIV2,DMXSPD,DSP,DSPKL,DVEL,
     1  DVIMP,DVWP,EEVMSP,EIMP,ENERGY,ERPRRT,ESDIST,ETVEL,EVENU,EVMSP,
     1  EWRP,FDATE,GHEMX,GHTMX,IBASE,ICE,IDOCK,IETOFT,IGH,IHERE,IHWARP,
     1  ISTART,ITFCTR,ITFIRE,ITORP,ITRUCE,IZZ,JCE,KLNGNS,XKTIME,
     1  LEFTK,LEFTR,MAXBQ,MAXK,MAXKQ,MAXR,MAXRQ,MAXSQ,MEN,MINK,MINR,
     1  MROM,MULTK1,MULTK2,NBASES,NKL,NMEN,NROM,NSTARS,NSTEPS,NTORPS,
     1  NTSTPS,NTRP,PCTCOL,PDEG,PNRGY,PRGH,PRKLN,PRREEN,PSP,PTRGH,
     1  RADEGC,REEN,RPRKL,RPRRM,RTIME,RTV,SDATE,SENRGY,
     1  SIM,TFACTR,THITR,TNRGY,TPMIN,TPOWR,VMXKL,VRKL,XDDEG,XDSP,XGHIT,
     1  XKFPE,XKFPST,XKLHIT,XRFTS,XRMHIT,XQE,XTIME,XTRTM,YQE,ZMIN,
     1  PRORAS,RADEK,RADEG,RADER,RADEB,RADET,RADKR,RADKG,RADKB,RADKT,
     1  RADKK,RADGB,RADGT,RAGGR,RADBT,RADTT,RADTR,RADES,RADSS
      X=DEFL
      DEFL=DEFL-HIT
      Y=HIT-X
      IF(DEFL.LT.0.)GO TO 15
      WRITE(6,1)HIT
1     FORMAT(' SHIELDS KNOCKED DOWN BY: ',F7.2)
      GO TO 10
15    IF(X.LE.0.)GO TO 25
      WRITE(6,2)
2     FORMAT(' SHIELDS DESTROYED')
25    CALL DAMAGE(ITYPE,Y,IWHAT)
      DEFL=0.
      GO TO 99
10    IF(DEFL.GT.100.)GO TO 20
      WRITE(6,3)
3     FORMAT(' SHIELDS CRITICAL!')
      GO TO 99
20    IF(DEFL.GT.250.)GO TO 99
      WRITE(6,4)
4     FORMAT(' SHIELDS CRUMBLING')
99    RETURN
      END
      SUBROUTINE KLNGN
      COMMON/ARRAYS/NAMD(10),BASE(2),EFP(3),EFT(25,2),ETR(3),GHOST(13),
     1  IBL(10,10),IDMG(10),IGAL(10,10),IPQ(10,10),JGAL(10,10),LETR(13),
     1  IPROB1(10),RAD(9),STARS(9,2),TORPS(30,4),XKL(9,9),XROM(9,4)
      DOUBLE PRECISION NAMD
      COMMON/SCALAR/ACCE,DCHG,DDEG,DECR,DEFL,DELTA,DELV,DGIMP,DGKL,DGWP,
     1  DISTGT,DISTKR,DISTPE,DISTPK,DIV1,DIV2,DMXSPD,DSP,DSPKL,DVEL,
     1  DVIMP,DVWP,EEVMSP,EIMP,ENERGY,ERPRRT,ESDIST,ETVEL,EVENU,EVMSP,
     1  EWRP,FDATE,GHEMX,GHTMX,IBASE,ICE,IDOCK,IETOFT,IGH,IHERE,IHWARP,
     1  ISTART,ITFCTR,ITFIRE,ITORP,ITRUCE,IZZ,JCE,KLNGNS,XKTIME,
     1  LEFTK,LEFTR,MAXBQ,MAXK,MAXKQ,MAXR,MAXRQ,MAXSQ,MEN,MINK,MINR,
     1  MROM,MULTK1,MULTK2,NBASES,NKL,NMEN,NROM,NSTARS,NSTEPS,NTORPS,
     1  NTSTPS,NTRP,PCTCOL,PDEG,PNRGY,PRGH,PRKLN,PRREEN,PSP,PTRGH,
     1  RADEGC,REEN,RPRKL,RPRRM,RTIME,RTV,SDATE,SENRGY,
     1  SIM,TFACTR,THITR,TNRGY,TPMIN,TPOWR,VMXKL,VRKL,XDDEG,XDSP,XGHIT,
     1  XKFPE,XKFPST,XKLHIT,XRFTS,XRMHIT,XQE,XTIME,XTRTM,YQE,ZMIN,
     1  PRORAS,RADEK,RADEG,RADER,RADEB,RADET,RADKR,RADKG,RADKB,RADKT,
     1  RADKK,RADGB,RADGT,RAGGR,RADBT,RADTT,RADTR,RADES,RADSS
      COMMON/TBEAMS/IFGHTM,ITRMEN(20),JUP,JFROM,IBMEN,JDOWN,JTO,IBMENR,
     1  SBMNR,CREWR(9),SCREWR,CREWK,CODDS,DODDS,EODDS,FODDS
      COMMON/SUBCTL/ICNTL(20),RTBRG(5),KTO,LTO,KBRG,XWRP,
     1  ISTAT,IDAMRP,SDEF,IMSG,SKDLAY,SRDLY,GHVMX,MXCRGH,GHPHEN,
     1  DSPGH,DGGH,RPRGH,NHELP,NHELPS,XHELP
      COMMON/ATTACK/ITKL(18),JTKL(18)
      COMMON/EXTRAS/SNOVAP,ZMAX,ICLOAK,PRCLDN,PHOLE,IHOLE,JHOLE,HOLRAD,
     1  SHLDF,NQUAD,PSTORM,ISTORM,JSTORM,STMRAD,LEVEL,ION,IYES,CMIN,
     1  CPOWR
      DATA GETHRU/.8/,SKFCTR/1./
      DATA WFR,WFRF,WST,WGH,WB,WNE,WDE,WT/5.,4.,4.,3.,2.,7.,8.,4./
      DATA POWER/4./
2600  IF(KLNGNS.EQ.0)GO TO 2700
C     ...LOOP ON KLINGON ACTIVITIES.
      DO 2680 J=1,KLNGNS
      IF(XKL(J,1).EQ.0.)GO TO 2680
C     ...CHECK IF UNDER E CONTROL
      J1=0
      J2=0
      IF(ICNTL(J+1).NE.1)GO TO 26100
      IF(XKL(J,3).NE.XKL(J,5))J1=1
      IF(XKL(J,4).NE.XKL(J,6))J2=1
      GO TO 2610
C     ...KLINGON MOVEMENT DETERMINATION ROUTINE.
C     ...XVEC WILL BE X COMPONENT OF NEW BEARING
C     ...YVEC WILL BE Y COMPONENT OF NEW BEARING
C     ...ZVEC WILL BE AMOUNT OF VELOCITY REDUCTION FROM MAX (VMXKL)
26100 XK=XKL(J,1)
      YK=XKL(J,2)
      XVEC=0.
      YVEC=0.
      ZVEC=0.
C     ...AVOID OTHER KLINGONS.
      IF(KLNGNS.LE.1)GO TO 4050
      DO 4000 K=1,KLNGNS
      IF(K.EQ.J)GO TO 4000
      IF(XKL(K,1).EQ.0.)GO TO 4000
      VPX=XK-XKL(K,1)
      VPY=YK-XKL(K,2)
      DIST=ABS(VPX)**POWER+ABS(VPY)**POWER
      DIST=ABS(DIST)
      W=WFR
C     ...BETTER TO COLLIDE WITH CAPTURED ONES IF NECESSARY.
      IF(ITRMEN(K+1).NE.0)W=WFRF
      XVEC=XVEC+VPX/DIST*W
      YVEC=YVEC+VPY/DIST*W
      ZVEC=ZVEC+SKFCTR/DIST
4000  CONTINUE
C     ...AVOID ROMULANS.
4050  IF(NROM.EQ.0)GO TO 4150
      DO 4100 K=1,NROM
      IF(XROM(K,1).EQ.0.)GO TO 4100
      VPX=XK-XROM(K,1)
      VPY=YK-XROM(K,2)
      DIST=ABS(VPX)**POWER+ABS(VPY)**POWER
      DIST=ABS(DIST)
      W=WFR
      IF(ITRMEN(K+10).NE.0)W=WFRF
      XVEC=XVEC+VPX/DIST*W
      YVEC=YVEC+VPY/DIST*W
      ZVEC=ZVEC+SKFCTR/DIST
4100  CONTINUE
C     ...AVOID STARS.
4150  IF(NSTARS.EQ.0)GO TO 4250
      DO 4200 K=1,NSTARS
      IF(STARS(K,1).EQ.0.)GO TO 4200
      VPX=XK-STARS(K,1)
      VPY=YK-STARS(K,2)
      DIST=ABS(VPX)**POWER+ABS(VPY)**POWER
      DIST=ABS(DIST)
      W=WST
      XVEC=XVEC+VPX/DIST*W
      YVEC=YVEC+VPY/DIST*W
      ZVEC=ZVEC+SKFCTR/DIST
4200  CONTINUE
C     ...AVOID GHOSTSHIPS.
4250  IF(IGH.EQ.0)GO TO 4300
      VPX=XK-GHOST(1)
      VPY=YK-GHOST(2)
      DIST=ABS(VPX)**POWER+ABS(VPY)**POWER
      DIST=ABS(DIST)
      W=WGH
      XVEC=XVEC+VPX/DIST*W
      YVEC=YVEC+VPY/DIST*W
      ZVEC=ZVEC+SKFCTR/DIST
C     ...AVOID STARBASES.
4300  IF(IBASE.EQ.0)GO TO 4350
      VPX=XK-BASE(1)
      VPY=YK-BASE(2)
      DIST=ABS(VPX)**POWER+ABS(VPY)**POWER
      DIST=ABS(DIST)
      W=WB
      XVEC=XVEC+VPX/DIST*W
      YVEC=YVEC+VPY/DIST*W
      ZVEC=ZVEC+SKFCTR/DIST
C     ...STAY CLEAR OF EDGES UNLESS ESCAPING.
4350  W=WNE
      IF(XKL(J,7).GE.THITR*XKLHIT.OR.NKL/LEFTK.GE.7)W=-WDE
      VPX=SIGN(AMIN1(10.5-XK,XK-.5),5.5-XK)
      VPY=SIGN(AMIN1(10.5-YK,YK-.5),5.5-YK)
      DIST=ABS(VPX)**POWER
      DIST=ABS(DIST)
      IF(DIST.LE..1)DIST=.1
      XVEC=XVEC+VPX/DIST*W
      DIST=ABS(VPY)**POWER
      IF(DIST.LT..1)DIST=.1
      YVEC=YVEC+VPY/DIST*W
C     ...SLOW DOWN FOR EDGES UNLESS ESCAPING.
      IF(XKL(J,7).LT.THITR)ZVEC=ZVEC+SKFCTR/DIST
C     ...NEW SPEED REDUCTION DEPENDENT ON HOW MANY NEARBY OBJECTS TO AVO
C     D.
      XKL(J,5)=AMAX1(.05,VMXKL-ZVEC)
C     ...AVOID TORPEDOS.
      IF(NTORPS.EQ.0.OR.LEVEL.EQ.1)GO TO 4550
      DO 4500 K=1,NTORPS
C     ...SELECT ONLY ENEMY TORPS TO AVOID.
      IF(TORPS(K,1).EQ.0..OR.TORPS(K,4).GE.0..AND.TORPS(K,4).LT.360.)GO
     1TO 4500
      CALL GETBRG(DELTA,XK,TORPS(K,1),YK,TORPS(K,2),VPX,VPY)
      DELV=TORPS(K,4)
      IF(DELV.LT.0.)DELV=DELV+360.
      IF(DELV.GE.360.)DELV=DELV-360.
      VPX=DELTA+90.
      IF(VPX.GE.360.)VPX=VPX-360.
      VPY=DELTA-90.
      IF(VPY.LT.0.)VPY=VPY+360.
C     ...SELECT ONLY THOSE ENEMY TORPS HEADED THIS WAY.
      IF(DELV.LE.VPX.OR.DELV.GE.VPY)GO TO 4500
      VPX=COSD(DELV)
      VPY=SIND(DELV)
C     ...CALCULATE PERPENDICULAR DISTANCE TO TORPEDO PATH.
      S=9.E17
      IF(VPY.LT.0.)S=-9.E17
      IF(ABS(VPY).GT.1./9.E17)S=VPX/VPY
      IF(S.LT.0.)GO TO 4510
      IF(S.LT.1./9.E17)S=1./9.E17
      GO TO 4520
4510  IF(S.GT.-1./9.E17)S=-1./9.E17
4520  C1=TORPS(K,2)-S*TORPS(K,1)
      C2=YK+XK/S
      VPX=(C2-C1)/(S+1./S)
      VPY=S*VPX+C1
      VPX=XK-VPX
      VPY=YK-VPY
C     ...MOVEMENT WILL BE AT RIGHT ANGLES AWAY FROM TORP PATH.
      DIST=ABS(VPX)**POWER+ABS(VPY)**POWER
      XVEC=XVEC+VPX/DIST*WT
      YVEC=YVEC+VPY/DIST*WT
4500  CONTINUE
4550  VPY=0.
C     ...THIS WILL BE THE OPTIMUM BEARING TO AVOID MISHAP.
      CALL GETBRG(XKL(J,6),VPY,XVEC,VPY,YVEC,XADD,YADD)
      IF(ABS(XKL(J,6)-XKL(J,4)).LE.DGKL.OR.ABS(360.-ABS(XKL(J,6)-      X
     1KL(J,4))).LE.DGKL)XKL(J,5)=AMIN1(VMXKL,XKL(J,5)*2.)
2610  CALL OMOVE(XKL(J,1),XKL(J,2),XKL(J,3),XKL(J,4),XKL(J,5),XKL(J,6)
     1  ,DSPKL,DGKL)
      IF(J1.EQ.1.AND.XKL(J,3).EQ.XKL(J,5))WRITE(6,26101)J,XKL(J,3)
26101 FORMAT(' K',I1,' DESIRED SPEED OF ',F5.3,' ATTAINED')
      IF(J2.EQ.1.AND.XKL(J,4).EQ.XKL(J,6))WRITE(6,26102)J,XKL(J,4)
26102 FORMAT(' K',I1,' DESIRED BEARING OF ',F4.0,' ATTAINED')
C     ...CHECK IF LEAVING QUADRANT
      CALL KLQ(J,IR)
      IF(IR.GE.1)GO TO 2680
C     ...K FIRING AREA.
      IF(XKL(J,8).GT.NTSTPS.OR.XKL(J,8).EQ.0.)GO TO 2680
C     ...CHECK IF UNDER E CONTROL.
      IF(ICNTL(J+1).EQ.1)GO TO 2800
      IF(ICLOAK.LT.0.AND.ION.EQ.1)GO TO 2680
C     ...CALCULATE HIT ON E
2620  IF(IDOCK.EQ.2)GO TO 2680
      CALL GETBRG(VSX,XKL(J,1),XQE,XKL(J,2),YQE,VPX,VPY)
      X=VPX*VPX+VPY*VPY
      VSX=AMAX1(ABS(COSD(VSX)),ABS(SIND(VSX)))**2
      VSY=VSX*SQRT(X)
      VSY=VSY*(XKLHIT-XKL(J,7))/XKLHIT
      VSY=VSY*XKFPE*DISTPK/X/SHLDF
      IF(LEVEL.EQ.1)GO TO 2630
C     ...MASKED?
      CALL MASKEF(XQE,YQE,XKL(J,1),XKL(J,2),VPY)
      VSY=VSY-VPY*VSY*GETHRU
C     ...CALCULATE EFFECT AND RESET FIRING
2630  XKL(J,8)=NTSTPS+1.+RAN(IZZ)*XKFPST
      WRITE(6,2173)LETR(11),LETR(2),LETR(3),J,XKL(J,1),XKL(J,2)
2173  FORMAT(1X,A1,' HIT ON ',A1,' FROM ',A1,I1,' AT ',F4.1,',',F4.1)
      CALL HITONE(1,VSY,-1)
      GO TO 2680
C     ...K UNDER E CONTROL FIRING PHASERS.
2800  XKL(J,8)=0.
      WRITE(6,26103)J
26103 FORMAT(' K',I1,' FIRING PHASERS')
      IF(LEVEL.EQ.1)GO TO 2811
2811  IF(KLNGNS.LE.1)GO TO 2320
C     ...CALCULTE HITS ON OTHER KLINGONS.
      DO 2310 K=1,KLNGNS
      IF(XKL(K,1).EQ.0.)GO TO 2310
      IF(K.EQ.J)GO TO 2310
      IF(ICNTL(K+1).EQ.1)GO TO 2310
      CALL GETBRG(VSX,XKL(J,1),XKL(K,1),XKL(J,2),XKL(K,2),VPX,VPY)
      X=VPX*VPX+VPY*VPY
      VSX=AMAX1(ABS(COSD(VSX)),ABS(SIND(VSX)))**2
      VSY=VSX*SQRT(X)
      VSY=VSY*(XKLHIT-XKL(J,7))/XKLHIT
      VSY=VSY*XKFPE*DISTPK/X
      IF(LEVEL.EQ.1)GO TO 2170
      CALL MASKEF(XKL(K,1),XKL(K,2),XKL(J,1),XKL(J,2),VPY)
      VSY=VSY-VPY*VSY*GETHRU
2170  WRITE(6,2174)VSY,LETR(3),K,XKL(K,1),XKL(K,2)
2174  FORMAT(1X,F8.2,' UNIT HIT ON ',A1,I1,' AT ',F4.1,',',F4.1)
      XKL(K,7)=XKL(K,7)+VSY
      IF(XKL(K,7).LT.XKLHIT)GO TO 2305
2366  CALL DLETE(3,K)
      GO TO 2310
2305  CONTINUE
C     ...TROOP AND/OR CREW REDUCTIONS DUE TO P HIT.
      IF(ITRMEN(K+1).EQ.0)GO TO 2356
      IX=RAN(IZZ)*2.5*SQRT(VSY)
      IF(IX.GT.ITRMEN(K+1))IX=ITRMEN(K+1)
      ITKL(K)=ITKL(K)+IX
      ITRMEN(K+1)=ITRMEN(K+1)-IX
2356  IX=RAN(IZZ)*SQRT(VSY)*2.5
      XKL(K,9)=XKL(K,9)-IX
      IF(XKL(K,9).GT.0.)GO TO 2309
      IF(ITRMEN(K+1).LE.0)GO TO 2366
2309  JTKL(K)=JTKL(K)+IX
2310  CONTINUE
2320  IF(NROM.EQ.0)GO TO 2340
C     ...CALCULATE HIT ON ROMULANS.
      DO 2330 K=1,NROM
      IF(XROM(K,1).EQ.0.)GO TO 2330
      IF(ICNTL(K+10).EQ.1)GO TO 2330
      CALL GETBRG(VSX,XKL(J,1),XROM(K,1),XKL(J,2),XROM(K,2),VPX,VPY)
      X=VPX*VPX+VPY*VPY
      VSX=AMAX1(ABS(COSD(VSX)),ABS(SIND(VSX)))**2
      VSY=VSX*SQRT(X)
      VSY=VSY*(XKLHIT-XKL(J,7))/XKLHIT
      VSY=VSY*XKFPE*DISTPK/X
      IF(LEVEL.EQ.1)GO TO 23705
      CALL MASKEF(XROM(K,1),XROM(K,2),XKL(J,1),XKL(J,2),VPY)
      VSY=VSY-VPY*VSY*GETHRU
23705 WRITE(6,2174)VSY,LETR(4),K,XROM(K,1),XROM(K,2)
      XROM(K,3)=XROM(K,3)+VSY
      IF(XROM(K,3).LT.XRMHIT)GO TO 2315
2376  CALL DLETE(4,K)
      GO TO 2330
C     ...ROMULAN CREW AND TROOP ON BOARD REDUCTIONS.
2315  IF(ITRMEN(K+10).EQ.0)GO TO 2386
      IX=RAN(IZZ)*SQRT(VSY)*2.5
      IF(IX.GT.ITRMEN(K+10))IX=ITRMEN(K+10)
      ITKL(K+9)=ITKL(K+9)+IX
      ITRMEN(K+10)=ITRMEN(K+10)-IX
2386  IX=RAN(IZZ)*SQRT(VSY)*2.5
      CREWR(K)=CREWR(K)-IX
      IF(CREWR(K).GT.0.)GO TO 2329
      IF(ITRMEN(K+1).LE.0)GO TO 2376
2329  JTKL(K+9)=JTKL(K+9)+IX
2330  CONTINUE
2340  XKL(J,8)=NTSTPS+1+(CREWK/ITRMEN(J+1)*SKDLAY+RAN      (IZZ)*XKFPST)
2680  CONTINUE
2700  RETURN
      END
      SUBROUTINE KLQ(JJ,IR)
      COMMON/ARRAYS/NAMD(10),BASE(2),EFP(3),EFT(25,2),ETR(3),GHOST(13),
     1  IBL(10,10),IDMG(10),IGAL(10,10),IPQ(10,10),JGAL(10,10),LETR(13),
     1  IPROB1(10),RAD(9),STARS(9,2),TORPS(30,4),XKL(9,9),XROM(9,4)
      DOUBLE PRECISION NAMD
      COMMON/SCALAR/ACCE,DCHG,DDEG,DECR,DEFL,DELTA,DELV,DGIMP,DGKL,DGWP,
     1  DISTGT,DISTKR,DISTPE,DISTPK,DIV1,DIV2,DMXSPD,DSP,DSPKL,DVEL,
     1  DVIMP,DVWP,EEVMSP,EIMP,ENERGY,ERPRRT,ESDIST,ETVEL,EVENU,EVMSP,
     1  EWRP,FDATE,GHEMX,GHTMX,IBASE,ICE,IDOCK,IETOFT,IGH,IHERE,IHWARP,
     1  ISTART,ITFCTR,ITFIRE,ITORP,ITRUCE,IZZ,JCE,KLNGNS,XKTIME,
     1  LEFTK,LEFTR,MAXBQ,MAXK,MAXKQ,MAXR,MAXRQ,MAXSQ,MEN,MINK,MINR,
     1  MROM,MULTK1,MULTK2,NBASES,NKL,NMEN,NROM,NSTARS,NSTEPS,NTORPS,
     1  NTSTPS,NTRP,PCTCOL,PDEG,PNRGY,PRGH,PRKLN,PRREEN,PSP,PTRGH,
     1  RADEGC,REEN,RPRKL,RPRRM,RTIME,RTV,SDATE,SENRGY,
     1  SIM,TFACTR,THITR,TNRGY,TPMIN,TPOWR,VMXKL,VRKL,XDDEG,XDSP,XGHIT,
     1  XKFPE,XKFPST,XKLHIT,XRFTS,XRMHIT,XQE,XTIME,XTRTM,YQE,ZMIN,
     1  PRORAS,RADEK,RADEG,RADER,RADEB,RADET,RADKR,RADKG,RADKB,RADKT,
     1  RADKK,RADGB,RADGT,RAGGR,RADBT,RADTT,RADTR,RADES,RADSS
      COMMON/TBEAMS/IFGHTM,ITRMEN(20),JUP,JFROM,IBMEN,JDOWN,JTO,IBMENR,
     1  SBMNR,CREWR(9),SCREWR,CREWK,CODDS,DODDS,EODDS,FODDS
      COMMON/SUBCTL/ICNTL(20),RTBRG(5),KTO,LTO,KBRG,XWRP,
     1  ISTAT,IDAMRP,SDEF,IMSG,SKDLAY,SRDLY,GHVMX,MXCRGH,GHPHEN,
     1  DSPGH,DGGH,RPRGH,NHELP,NHELPS,XHELP
      COMMON/EXTRAS/SNOVAP,ZMAX,ICLOAK,PRCLDN,PHOLE,IHOLE,JHOLE,HOLRAD,
     1  SHLDF,NQUAD,PSTORM,ISTORM,JSTORM,STMRAD,LEVEL,ION,IYES,CMIN,
     1  CPOWR
      IN=0
      JN=0
C     ...CHECK WHICH WAY K LEFT QUAD.
      IF(XKL(JJ,1).LT..5)IN=-1
      IF(XKL(JJ,2).LT..5)JN=-1
      IF(XKL(JJ,1).GE.10.5)IN=1
      IF(XKL(JJ,2).GE.10.5)JN=1
      IR=0
      IF(IN.EQ.0.AND.JN.EQ.0)RETURN
      IR=1
      IN=IN+ICE
      JN=JN+JCE
      IKG=(JGAL(IN,JN))
      IF(IKG-IKG/1000*1000.GE.900)GO TO 2471
C     ...CHECK IF LEAVING GALAXY.
      IF(IN.LT.1.OR.JN.LT.1.OR.IN.GT.NQUAD.OR.JN.GT.NQUAD)GO TO 2468
      WRITE(6,2467)LETR(3),JJ,IN,JN
2467  FORMAT(1X,A1,I1,' ESCAPED TO QUADRANT ',I2,',',I2)
      JGAL(ICE,JCE)=JGAL(ICE,JCE)-100
      IF(IDMG(6).NE.0.OR.IDMG(7).NE.0)     IGAL(ICE,JCE)=JGAL(ICE,JCE)
      IF(ITRMEN(JJ+1).EQ.0)GO TO 100
      WRITE(6,101)ITRMEN(JJ+1)
101   FORMAT(I4,' TROOPS CAPTURED BY ENEMY')
      ITRMEN(JJ+1)=0
      IF(ISTAT.EQ.0)GO TO 100
C     ...STOP BEAMING.
      IF(JUP.EQ.3.AND.JFROM.EQ.JJ.OR.JDOWN.EQ.3.AND.JTO.EQ.JJ)ISTAT=9999
100   ICNTL(JJ+1)=0
      JGAL(IN,JN)=JGAL(IN,JN)+100
      XKL(JJ,1)=0.
      RETURN
2468  WRITE(6,2469)LETR(3),JJ
2469  FORMAT(1X,A1,I1,' EXCEEDED GALACTIC LIMITS')
      IN=3
      CALL DLETE(IN,JJ)
      IR=2
      RETURN
2471  IF(XKL(JJ,1).LT..5)XKL(JJ,1)=.6
      IF(XKL(JJ,2).LT..5)XKL(JJ,2)=.6
      IF(XKL(JJ,1).GT.10.5)XKL(JJ,1)=10.4
      IF(XKL(JJ,2).GT.10.5)XKL(JJ,2)=10.4
      RETURN
      END
      COMMON/LOCAL/ITBEAM,ISCAN,ITDK,JSCAN,JMSG,TRNRGY,IISTAT,JJSTAT,
     1  JJUP,JJFROM,JJTO,JJDOWN
      COMMON/GRAPH/IGRAPH,NOLINE
      DOUBLE PRECISION SYMSET
      DIMENSION MYDEV(10),IFLT1(5),MENU(10,22)
      DATA IFLT1/-1,1,7,65,0/
      DATA SYMSET/'SUPRTREK'/
C     ID=FIELD-ID,RW=ROW,CL=COLUMN,DP=DEPTH,WI=WIDTH,TP=TYPE
C     IN=INTENSITY,CO=COLOR,PS=PRIMARY SYMBOL SET,HI=HIGHLIGHT
C          ID RW CL DP WI TP IN CO PS HI ID RW CL DP WI TP IN CO PS HI
      DATA MENU/                          1, 1, 5, 1, 1, 2, 1,-1,65, 0,
     1                                    2, 1,10, 1,20, 2, 1, 5, 0, 0,
     1      3, 2, 5, 1, 1, 2, 1,-1,65, 0, 4, 2,10, 1,20, 2, 1, 3, 0, 0,
     1      5, 3, 5, 1, 1, 2, 1,-1,65, 0, 6, 3,10, 1,20, 2, 1, 2, 0, 0,
     1      7, 4, 5, 1, 1, 2, 1,-1,65, 0, 8, 4,10, 1,20, 2, 1, 4, 0, 0,
     1      9, 5, 5, 1, 1, 2, 1,-1,65, 0,10, 5,10, 1,20, 2, 1, 6, 0, 0,
     1     11, 6, 5, 1, 1, 2, 1,-1,65, 0,12, 6,10, 1,20, 2, 1, 6, 0, 0,
     1     13, 7, 5, 1, 1, 2, 1,-1,65, 0,14, 7,10, 1,20, 2, 1, 1, 0, 0,
     1     15, 8, 5, 1, 1, 2, 1,-1,65, 0,16, 8,10, 1,20, 2, 1, 7, 0, 0,
     1     17, 9, 5, 1, 1, 2, 1,-1,65, 0,18, 9,10, 1,20, 2, 1, 7, 0, 0,
     1     19,10, 5, 1, 1, 2, 1,-1,65, 0,20,10,10, 1,20, 2, 1, 7, 0, 0,
     1     21,10,75, 1, 1, 2, 1, 5, 0, 0,22,11, 1,22,80 ,0 ,1 ,5 ,0, 0/
      CALL ERRSET(201,256,-1,1,1,204)
      CALL ERRSET(206,256,-1,1,1,229)
      CALL ERRSET(231,256,-1,1,1,239)
      CALL ERRSET(241,256,-1,1,1,301)
      CALL FSINN
      CALL FSQDEV(10,MYDEV)
      NOLINE=MYDEV(3)
      IF(MYDEV(10).EQ.0)GO TO 2
      IF(NOLINE.NE.32)GO TO 2
      IGRAPH=1
      CALL FSPCRT(1,32,80,2)
      CALL FSPSEL(1)
      CALL PSLSS(7,SYMSET,65)
      CALL CPAGE
      CALL ASDFLT(5,IFLT1)
      CALL ASDFMT(22,10,MENU)
      CALL ASCPUT(1,1,'A')
      CALL ASCPUT(2,20,'ENTERPRISE          ')
      CALL ASCPUT(3,1,'O')
      CALL ASCPUT(4,20,'SHUTTLECRAFT        ')
      CALL ASCPUT(5,1,'E')
      CALL ASCPUT(6,20,'KLINGON             ')
      CALL ASCPUT(7,1,'I')
      CALL ASCPUT(8,20,'ROMULAN             ')
      CALL ASCPUT(9,1,'0')
      CALL ASCPUT(10,20,'GHOSTSHIP           ')
      CALL ASCPUT(11,1,'N')
      CALL ASCPUT(12,20,'BASE                ')
      CALL ASCPUT(13,1,'T')
      CALL ASCPUT(14,20,'TORPEDO             ')
      CALL ASCPUT(15,1,'S')
      CALL ASCPUT(16,20,'STAR                ')
      CALL ASCPUT(17,1,' ')
      CALL ASCPUT(18,20,'BLACK HOLE          ')
      CALL ASCPUT(19,1,'M')
      CALL ASCPUT(20,20,'OPEN SPACE          ')
      CALL ASFCUR(0,11,1)
      CALL FSFRCE
      CALL BPAGE(11)
      WRITE(6,4)
4     FORMAT(' HIT ENTER TO CONTINUE')
      READ(5,3)IIII
3     FORMAT(A8)
      GO TO 1
2     IGRAPH=0
1     CALL STAR81
      CALL TRY1
      STOP 1
      END
      SUBROUTINE MASKEF(X,Y,XQ,YQ,PHCRD)
      COMMON/ARRAYS/NAMD(10),BASE(2),EFP(3),EFT(25,2),ETR(3),GHOST(13),
     1  IBL(10,10),IDMG(10),IGAL(10,10),IPQ(10,10),JGAL(10,10),LETR(13),
     1  IPROB1(10),RAD(9),STARS(9,2),TORPS(30,4),XKL(9,9),XROM(9,4)
      DOUBLE PRECISION NAMD
      COMMON/SCALAR/ACCE,DCHG,DDEG,DECR,DEFL,DELTA,DELV,DGIMP,DGKL,DGWP,
     1  DISTGT,DISTKR,DISTPE,DISTPK,DIV1,DIV2,DMXSPD,DSP,DSPKL,DVEL,
     1  DVIMP,DVWP,EEVMSP,EIMP,ENERGY,ERPRRT,ESDIST,ETVEL,EVENU,EVMSP,
     1  EWRP,FDATE,GHEMX,GHTMX,IBASE,ICE,IDOCK,IETOFT,IGH,IHERE,IHWARP,
     1  ISTART,ITFCTR,ITFIRE,ITORP,ITRUCE,IZZ,JCE,KLNGNS,XKTIME,
     1  LEFTK,LEFTR,MAXBQ,MAXK,MAXKQ,MAXR,MAXRQ,MAXSQ,MEN,MINK,MINR,
     1  MROM,MULTK1,MULTK2,NBASES,NKL,NMEN,NROM,NSTARS,NSTEPS,NTORPS,
     1  NTSTPS,NTRP,PCTCOL,PDEG,PNRGY,PRGH,PRKLN,PRREEN,PSP,PTRGH,
     1  RADEGC,REEN,RPRKL,RPRRM,RTIME,RTV,SDATE,SENRGY,
     1  SIM,TFACTR,THITR,TNRGY,TPMIN,TPOWR,VMXKL,VRKL,XDDEG,XDSP,XGHIT,
     1  XKFPE,XKFPST,XKLHIT,XRFTS,XRMHIT,XQE,XTIME,XTRTM,YQE,ZMIN,
     1  PRORAS,RADEK,RADEG,RADER,RADEB,RADET,RADKR,RADKG,RADKB,RADKT,
     1  RADKK,RADGB,RADGT,RAGGR,RADBT,RADTT,RADTR,RADES,RADSS
      COMMON/EXTRAS/SNOVAP,ZMAX,ICLOAK,PRCLDN,PHOLE,IHOLE,JHOLE,HOLRAD,
     1  SHLDF,NQUAD,PSTORM,ISTORM,JSTORM,STMRAD,LEVEL,ION,IYES,CMIN,
     1  CPOWR
      DIMENSION ATENF(5)
      DATA ATENF/100.,30.,25.,50.,500./
C     ...OBJECT AT XQ,YQ IS PHASING OBJECT AT X,Y.
C     ...PHCRD WILL BE % REDUCTION DUE TO MASKING.
C     ...INTERVENING OBJECTS AND THEIR RELATIVE MASKING EFFECTS:
C     ...  *   100
C     ...  K,R  30
C     ...  G    25
C     ...  HOLE500
      PHCRD=0.
      LNDX=1
      SUMAX=0.
      SUMACT=0.
      IF(NSTARS.EQ.0)GO TO 100
      DO 50 I=1,NSTARS
      IF(STARS(I,1).EQ.0)GO TO 50
      CALL GETBRG(A1,XQ,STARS(I,1),YQ,STARS(I,2),VPX,VPY)
      CALL GETBRG(A2,STARS(I,1),X,STARS(I,2),Y,VPX,VPY)
      D1=VPX*VPX+VPY*VPY
      D2=0.
      IF(A1.NE.0.)D2=360.-A1
      A2=A2+D2
      IF(A2.GE.360.)A2=A2-360.
      IF(A2.GE.45..AND.A2.LE.315.)GO TO 50
      SUMAX=SUMAX+ATENF(LNDX)
      D2=SIND(A2)
      D2=1.-D2*D2
      D2=D2/2.+RAD(I)/(D1+D1)
      IF(D2.GT.1.)D2=1.
      SUMACT=SUMACT+D2*ATENF(LNDX)
50    CONTINUE
100   IF(KLNGNS.EQ.0)GO TO 200
      LNDX=2
      DO 150 I=1,KLNGNS
      IF(XKL(I,1).EQ.0)GO TO 150
      IF(XKL(I,1).EQ.X.AND.XKL(I,2).EQ.Y)GO TO 150
      IF(XKL(I,1).EQ.XQ.AND.XKL(I,2).EQ.YQ)GO TO 150
      CALL GETBRG(A1,XQ,XKL(I,1),YQ,XKL(I,2),VPX,VPY)
      CALL GETBRG(A2,XKL(I,1),X,XKL(I,2),Y,VPX,VPY)
      D1=VPX*VPX+VPY*VPY
      D2=0.
      IF(A1.NE.0.)D2=360.-A1
      A2=A2+D2
      IF(A2.GE.360.)A2=A2-360.
      IF(A2.GE.45..AND.A2.LE.315.)GO TO 150
      SUMAX=SUMAX+ATENF(LNDX)
      D2=SIND(A2)
      D2=1.-D2*D2
      D2=D2/2.+RADKK/(D1+D1)
      IF(D2.GT.1.)D2=1.
      SUMACT=SUMACT+D2*ATENF(LNDX)
150   CONTINUE
200   IF(NROM.EQ.0)GO TO 300
      LNDX=2
      DO 250 I=1,NROM
      IF(XROM(I,1).EQ.0)GO TO 250
      IF(XROM(I,1).EQ.X.AND.XROM(I,2).EQ.Y)GO TO 250
      CALL GETBRG(A1,XQ,XROM(I,1),YQ,XROM(I,2),VPX,VPY)
      CALL GETBRG(A2,XROM(I,1),X,XROM(I,2),Y,VPX,VPY)
      D1=VPX*VPX+VPY*VPY
      D2=0.
      IF(A1.NE.0.)D2=360.-A1
      A2=A2+D2
      IF(A2.GE.360.)A2=A2-360.
      IF(A2.GE.45..AND.A2.LE.315.)GO TO 250
      SUMAX=SUMAX+ATENF(LNDX)
      D2=SIND(A2)
      D2=1.-D2*D2
      D2=D2/2.+RADKK/(D1+D1)
      IF(D2.GT.1.)D2=1.
      SUMACT=SUMACT+D2*ATENF(LNDX)
250   CONTINUE
300   IF(IGH.EQ.0)GO TO 400
      IF(GHOST(1).EQ.XQ.AND.GHOST(2).EQ.YQ)GO TO 400
      LNDX=3
      CALL GETBRG(A1,XQ,GHOST(1),YQ,GHOST(2),VPX,VPY)
      CALL GETBRG(A2,GHOST(1),X,GHOST(2),Y,VPX,VPY)
      D1=VPX*VPX+VPY*VPY
      D2=0.
      IF(A1.NE.0.)D2=360.-A1
      A2=A2+D2
      IF(A2.GE.360.)A2=A2-360.
      IF(A2.GE.45..AND.A2.LE.315.)GO TO 400
      SUMAX=SUMAX+ATENF(LNDX)
      D2=SIND(A2)
      D2=1.-D2*D2
      D2=D2/2.+RADEG/(D1+D1)
      IF(D2.GT.1.)D2=1.
      SUMACT=SUMACT+D2*ATENF(LNDX)
400   IF (IBASE.EQ.0)GO TO 500
      LNDX=4
      CALL GETBRG(A1,XQ,BASE(1),YQ,BASE(2),VPX,VPY)
      CALL GETBRG(A2,BASE(1),X,BASE(2),Y,VPX,VPY)
      D1=VPX*VPX+VPY*VPY
      D2=0.
      IF(A1.NE.0.)D2=360.-A1
      A2=A2+D2
      IF(A2.GE.360.)A2=A2-360.
      IF(A2.GE.45..AND.A2.LE.315.)GO TO 500
      SUMAX=SUMAX+ATENF(LNDX)
      D2=SIND(A2)
      D2=1.-D2*D2
      D2=D2/2.+RADEB/(D1+D1)
      IF(D2.GT.1.)D2=1.
      SUMACT=SUMACT+D2*ATENF(LNDX)
500   IF(IHOLE.EQ.0)GO TO 999
      LNDX=5
      XX=IHOLE
      YY=JHOLE
      CALL GETBRG(A1,XQ,XX,YQ,YY,VPX,VPY)
      CALL GETBRG(A2,XX,X,YY,Y,VPX,VPY)
      D1=VPX*VPX+VPY*VPY
      D2=0.
      IF(A1.NE.0.)D2=360.-A1
      A2=A2+D2
      IF(A2.GE.360.)A2=A2-360.
      IF(A2.GE.45..AND.A2.LE.315.)GO TO 999
      SUMAX=SUMAX+ATENF(LNDX)
      D2=SIND(A2)
      D2=1.-D2*D2
      D2=D2/2.+HOLRAD/(D1)
      IF(D2.GT.1.)D2=1.
      SUMACT=SUMACT+D2*ATENF(LNDX)
999   IF(SUMAX.EQ.0.)GO TO 1000
      PHCRD=SUMACT/SUMAX
1000  RETURN
      END
      SUBROUTINE OMOVE(X,Y,V,D,WV,WD,DV,DD)
C     ...MOVEMENT SUBROUTINE FOR KLINGONS AND GHOSTSHIPS.
      DELV=AMIN1(DV,ABS(WV-V))
      DELTA=WD-D
      IF(WV.LT.V)DELV=-DELV
      IF(ABS(DELTA).GT.180.)DELTA=DELTA-SIGN(360.,DELTA)
      IF(ABS(DELTA).GT.DD)DELTA=SIGN(DD,DELTA)
      VX=COSD(D+DELTA/2.)*(V+DELV/2.)
      VY=SIND(D+DELTA/2.)*(V+DELV/2.)
      V=V+DELV
      D=D+DELTA
      IF(D.GE.360.)D=D-360.
      IF(D.LT.0.)D=D+360.
      X=X+VX
      Y=Y+VY
      RETURN
      END
      SUBROUTINE PLIN(NUM,MAX,IN)
C     ...PUT THINGS IN GALAXY.
      COMMON/ARRAYS/NAMD(10),BASE(2),EFP(3),EFT(25,2),ETR(3),GHOST(13),
     1  IBL(10,10),IDMG(10),IGAL(10,10),IPQ(10,10),JGAL(10,10),LETR(13),
     1  IPROB1(10),RAD(9),STARS(9,2),TORPS(30,4),XKL(9,9),XROM(9,4)
      DOUBLE PRECISION NAMD
      COMMON/SCALAR/ACCE,DCHG,DDEG,DECR,DEFL,DELTA,DELV,DGIMP,DGKL,DGWP,
     1  DISTGT,DISTKR,DISTPE,DISTPK,DIV1,DIV2,DMXSPD,DSP,DSPKL,DVEL,
     1  DVIMP,DVWP,EEVMSP,EIMP,ENERGY,ERPRRT,ESDIST,ETVEL,EVENU,EVMSP,
     1  EWRP,FDATE,GHEMX,GHTMX,IBASE,ICE,IDOCK,IETOFT,IGH,IHERE,IHWARP,
     1  ISTART,ITFCTR,ITFIRE,ITORP,ITRUCE,IZZ,JCE,KLNGNS,XKTIME,
     1  LEFTK,LEFTR,MAXBQ,MAXK,MAXKQ,MAXR,MAXRQ,MAXSQ,MEN,MINK,MINR,
     1  MROM,MULTK1,MULTK2,NBASES,NKL,NMEN,NROM,NSTARS,NSTEPS,NTORPS,
     1  NTSTPS,NTRP,PCTCOL,PDEG,PNRGY,PRGH,PRKLN,PRREEN,PSP,PTRGH,
     1  RADEGC,REEN,RPRKL,RPRRM,RTIME,RTV,SDATE,SENRGY,
     1  SIM,TFACTR,THITR,TNRGY,TPMIN,TPOWR,VMXKL,VRKL,XDDEG,XDSP,XGHIT,
     1  XKFPE,XKFPST,XKLHIT,XRFTS,XRMHIT,XQE,XTIME,XTRTM,YQE,ZMIN,
     1  PRORAS,RADEK,RADEG,RADER,RADEB,RADET,RADKR,RADKG,RADKB,RADKT,
     1  RADKK,RADGB,RADGT,RAGGR,RADBT,RADTT,RADTR,RADES,RADSS
      COMMON/EXTRAS/SNOVAP,ZMAX,ICLOAK,PRCLDN,PHOLE,IHOLE,JHOLE,HOLRAD,
     1  SHLDF,NQUAD,PSTORM,ISTORM,JSTORM,STMRAD,LEVEL,ION,IYES,CMIN,
     1  CPOWR
      DO 100    I=1,NUM
200   IX=AMIN1(RAN(IZZ)*NQUAD+1.,FLOAT(NQUAD))
      IY=AMIN1(RAN(IZZ)*NQUAD+1.,FLOAT(NQUAD))
      IF(JGAL(IX,IY).GE.MAX)GO TO 200
      IF(IBL(IX,IY).NE.0.AND.IN.EQ.10)GO TO 200
      JGAL(IX,IY)=JGAL(IX,IY)+IN
100   CONTINUE
      RETURN
      END
      SUBROUTINE PROCM
      COMMON/ARRAYS/NAMD(10),BASE(2),EFP(3),EFT(25,2),ETR(3),GHOST(13),
     1  IBL(10,10),IDMG(10),IGAL(10,10),IPQ(10,10),JGAL(10,10),LETR(13),
     1  IPROB1(10),RAD(9),STARS(9,2),TORPS(30,4),XKL(9,9),XROM(9,4)
      DOUBLE PRECISION NAMD
      DOUBLE PRECISION DEFLEC,NPASS,NBLANK,NHELPL
      DOUBLE PRECISION RANKS(2,14),MNAME,MPASS,MOLDNM,NOLDNM,
     1  ISTATS(2),IST
      COMMON/SCALAR/ACCE,DCHG,DDEG,DECR,DEFL,DELTA,DELV,DGIMP,DGKL,DGWP,
     1  DISTGT,DISTKR,DISTPE,DISTPK,DIV1,DIV2,DMXSPD,DSP,DSPKL,DVEL,
     1  DVIMP,DVWP,EEVMSP,EIMP,ENERGY,ERPRRT,ESDIST,ETVEL,EVENU,EVMSP,
     1  EWRP,FDATE,GHEMX,GHTMX,IBASE,ICE,IDOCK,IETOFT,IGH,IHERE,IHWARP,
     1  ISTART,ITFCTR,ITFIRE,ITORP,ITRUCE,IZZ,JCE,KLNGNS,XKTIME,
     1  LEFTK,LEFTR,MAXBQ,MAXK,MAXKQ,MAXR,MAXRQ,MAXSQ,MEN,MINK,MINR,
     1  MROM,MULTK1,MULTK2,NBASES,NKL,NMEN,NROM,NSTARS,NSTEPS,NTORPS,
     1  NTSTPS,NTRP,PCTCOL,PDEG,PNRGY,PRGH,PRKLN,PRREEN,PSP,PTRGH,
     1  RADEGC,REEN,RPRKL,RPRRM,RTIME,RTV,SDATE,SENRGY,
     1  SIM,TFACTR,THITR,TNRGY,TPMIN,TPOWR,VMXKL,VRKL,XDDEG,XDSP,XGHIT,
     1  XKFPE,XKFPST,XKLHIT,XRFTS,XRMHIT,XQE,XTIME,XTRTM,YQE,ZMIN,
     1  PRORAS,RADEK,RADEG,RADER,RADEB,RADET,RADKR,RADKG,RADKB,RADKT,
     1  RADKK,RADGB,RADGT,RAGGR,RADBT,RADTT,RADTR,RADES,RADSS
      COMMON/TBEAMS/IFGHTM,ITRMEN(20),JUP,JFROM,IBMEN,JDOWN,JTO,IBMENR,
     1  SBMNR,CREWR(9),SCREWR,CREWK,CODDS,DODDS,EODDS,FODDS
      COMMON/SUBCTL/ICNTL(20),RTBRG(5),KTO,LTO,KBRG,XWRP,
     1  ISTAT,IDAMRP,SDEF,IMSG,SKDLAY,SRDLY,GHVMX,MXCRGH,GHPHEN,
     1  DSPGH,DGGH,RPRGH,NHELP,NHELPS,XHELP
      COMMON/TRNSFR/ICM,IDIR,MTORPS,DTORP(30),IBTYP,IEVDR,ADDFL,ITRSTP,
     1  KFROM,MTO,LUP,LDOWN,IFROM,ITO,JSCHM,ISHSTR(10),JDAM,
     1  IPROB2(10),NGHTFP
      COMMON/FORGOT/GHACCE,PJAM,PJMINC,ACTPJM,PPHASD,PTORPD,PDRVD,
     1  PDEFD,IGHPH,IGHTR,IGHDR,IGHDE
      COMMON/SHUTL/SHX,SHY,SHDEG,SHVX,ISTSH,ISHD,IFNDS(9),IDSES,VDSES,
     1  VSTRDS,VSTRM,PRXSH,VDSESM,ISHNUM
      COMMON/ZEROS/DVWP0,EWRP0,DISTP0,IETOF0,DISTG0,CODDS0,
     1  EODDS0,IDAMR0,PJAM0,ETVEL0,SHLDF0,TRNRG0
      COMMON/EXTRAS/SNOVAP,ZMAX,ICLOAK,PRCLDN,PHOLE,IHOLE,JHOLE,HOLRAD,
     1  SHLDF,NQUAD,PSTORM,ISTORM,JSTORM,STMRAD,LEVEL,ION,IYES,CMIN,
     1  CPOWR
      COMMON/LOCAL/ITBEAM,ISCAN,ITDK,JSCAN,JMSG,TRNRGY,IISTAT,JJSTAT,
     1  JJUP,JJFROM,JJTO,JJDOWN
      DATA DEFLEC/'DFLECTRS'/
      COMMON/RANK/RANKS,MNAME,MPASS,POINTS,RANKPT(14),NRANKS,IRANK,NRW,
     1  MMKEY,NTIME,IOK,NHOLD,ICLKON,NSW,ISTATS
C     ...PROCESS ACTIVITIES PREVIOUSLY SCHEDULED AND QUEUE THEM FOR
C     ...ACTION.
      PCT(A,B)=(B-A)/A*100.
1     IF(ICM.EQ.99)GO TO 5000
      IF(ICM.LE.0)GO TO 5000
      CALL CHEKDG(ICM,IR)
      IF(IR.EQ.1)GO TO 998
      GO TO (3001,3002,3003,3004,3005,3006,4000,3008,3009,3010,3011,3012
     1       ,3013,3014,3015,3016,3017,3018,3019,3020,3031,3033),ICM
      GO TO 5000
C     ...MUST CHECK DAMAGE INDIVDUALLY HERE AS TWO TYPES OF MOTION
C     ...INVOLVED.
3001  IF(IDMG(1).EQ.0)GO TO 30013
      IF(XDSP.LE.PSP.OR.XDSP.LE.SIM)GO TO 30011
      WRITE(6,30019)NAMD(1)
30019 FORMAT(1X,A10, ' DAMAGED')
      WRITE(6,30119)PSP
30119 FORMAT(' DESIRED SPEED SET TO ',F5.3)
      DSP=PSP
      DDEG=XDDEG
C     ...CHECK DAMAGE TO IMPULSE DRIVE.
30011 IF(IDMG(2).EQ.0)GO TO 30013
      WRITE(6,30019)NAMD(2)
      DDEG=PDEG
      DSP=PSP
      WRITE(6,30119)DSP
      GO TO 998
30013 DDEG=XDDEG
      DSP=XDSP
      IF(ITRUCE.EQ.0)GO TO 4000
      WRITE(6,33333)
33333 FORMAT(' TRUCE BROKEN...NORMAL ACTIVITIES RESUME')
      ITRUCE=0
      GO TO 4000
C     ...SHORT RANGE SCAN. STOP TIMER FOR PRINT TIME.
3002  IF(PSP.GE.1.)GO TO 994
      IHERE=1
      CALL SCAN
      CALL QTIME(JTIME)
      ISTART=JTIME
      GO TO 4000
C     ...LONG RANGE SCAN. STOP TIMER FOR PRINTING.
3003  I=ICE-1
      J=ICE+1
      K=JCE-1
      L=JCE+1
      IF(I.LT.1)I=1
      IF(J.GT.NQUAD)J=NQUAD
      IF(K.LT.1)K=1
      IF(L.GT.NQUAD)L=NQUAD
      DO 30032  M=I,J
      DO 30032 N=K,L
      IGAL(M,N)=JGAL(M,N)
30032 CONTINUE
C     CALL CPAGE
      WRITE(6,30033)ICE,JCE
30033 FORMAT(' LONG RANGE SENSOR SCAN AROUND QUADRANT ',I2,',',I2)
      WRITE(6,30034)
30034 FORMAT(' ---------------------------')
      N=L+1
30035 N=N-1
      IF(N.LT.K)GO TO 30037
      WRITE(6,30036)(JGAL(M,N),M=I,J)
30036 FORMAT(3(2X,I4,' :',2X))
      WRITE(6,30034)
      GO TO 30035
30037 CALL QTIME(JTIME)
      ISTART=JTIME
      GO TO 4000
C     ...PHASER FIRING SETUP.
3004  IF(PSP.GE.1.)GO TO 994
      EFP(1)=NTSTPS+NMEN/MEN
      EFP(2)=IDIR
      EFP(3)=PNRGY
      IF(ITRUCE.EQ.0)GO TO 4000
      WRITE(6,33333)
      ITRUCE=0
      GO TO 4000
C     ...TORPS SETUP FIRING AREA.
3005  IF(PSP.GE.1.)GO TO 994
      M=ITFIRE+1
      ITFIRE=ITFIRE+MTORPS
      ITORP=ITORP-MTORPS
      NC=1
      NF=1
      DO 30052 J=M,ITFIRE
C     ...SLOWDOWN DUE TO CREW REDUCTION BELOW 50% NORMAL.
      EFT(J,1)=NTSTPS+NF+NMEN/MEN-1
      EFT(J,2)=DTORP(J-M+1)
      NC=NC+1
      IF(NC.LE.IETOFT)GO TO 30052
      NC=1
      NF=NF+1
30052 CONTINUE
      IF(ITRUCE.EQ.0)GO TO 4000
      ITRUCE=0
      WRITE(6,33333)
      GO TO 4000
C     ...PULSIVE BEAMS.
3006  IF(PSP.GE.1.)GO TO 994
      ETR(1)=NTSTPS+NMEN/MEN
      ETR(2)=IBTYP
      IF(IBTYP.EQ.1)GO TO 4000
      ETR(3)=PNRGY
      IF(ITRUCE.EQ.0)GO TO 4000
      ITRUCE=0
      WRITE(6,33333)
      GO TO 4000
C     ...STATUS REPORT.
3008  XNRGY=ENERGY-PNRGY
      WRITE(6,30081)XTIME,XNRGY,ITORP,PSP,PDEG,DEFL,ISHNUM
30081 FORMAT(' STATUS REPORT'/' DAYS LEFT: ',F6.2,6X,'ENERGY: ',F8.2,6X,
     1       'TORPS: ',I3/' SPEED: ',F6.3,6X,'BEARING: ',F4.0,'  SHIELDS
     1: ',F7.1,'  SHUTTLECRAFT ON BOARD: ',I1)
C     ...ALSO PRINT TECHNOLOGICAL IMPROVEMENTS.
      IF(DVWP.EQ.DVWP0)GO TO 2
      IXRAT=PCT(DVWP0,DVWP)
      WRITE(6,702)NAMD(1),IXRAT
702   FORMAT(' ',A10,' ACCELERATION INCREASED ',I3,'%')
2     IF(EWRP.EQ.EWRP0)GO TO 3
      IXRAT=-PCT(EWRP0,EWRP)
      WRITE(6,703)NAMD(1),IXRAT
703   FORMAT(1X,A10,' EFFICIENCY INCREASED BY ',I3,'%')
3     IF(DISTPE.EQ.DISTP0)GO TO 4
      IXRAT=PCT(DISTP0,DISTPE)
      WRITE(6,704)NAMD(3),IXRAT
704   FORMAT(1X,A10,' EFFECTIVENESS INCREASED BY ',I3,'%')
4     IF(ETVEL.EQ.ETVEL0)GO TO 5
      WRITE(6,705)NAMD(4),ETVEL
705   FORMAT(1X,A10,' VELOCITY INCREASED TO ',F5.3)
5     IF(IETOFT.EQ.IETOF0)GO TO 6
      WRITE(6,706)NAMD(4),IETOFT
706   FORMAT(1X,A10,' RATE NOW ',I2,' PER STAR-MINUTE')
6     IF(DISTGT.EQ.DISTG0)GO TO 7
      IXRAT=PCT(DISTG0,DISTGT)
      WRITE(6,704)NAMD(5),IXRAT
7     IF(CODDS.EQ.CODDS0)GO TO 8
      IXRAT=PCT(CODDS0,CODDS)
      WRITE(6,708)IXRAT
708   FORMAT(' TROOP FIGHTING EFFECTIVENESS VS KLINGONS INCREASED BY ',I
     13,'%')
8     IF(EODDS.EQ.EODDS0)GO TO 9
      IXRAT=PCT(EODDS0,EODDS)
      WRITE(6,709)IXRAT
709   FORMAT(' TROOP FIGHTING EFFECTIVENESS VS ROMULANS INCREASED BY ',I
     13,'%')
9     IF(IDAMRP.EQ.IDAMR0)GO TO 14
      IXRAT=PCT(FLOAT(IDAMR0),FLOAT(IDAMRP))
      WRITE(6,706) NAMD(8),IDAMRP
14    IF(TRNRG0.EQ.TRNRGY)GO TO 10
      IXRAT=-PCT(TRNRG0,TRNRGY)
      WRITE(6,703)NAMD(8),IXRAT
10    IF(PJAM.EQ.PJAM0)GO TO 11
      IXRAT=-PCT(PJAM0,PJAM)
      WRITE(6,710)NAMD(9),IXRAT
710   FORMAT(1X,A10,' INTERCEPTION PROBABILITY REDUCED BY ',I3,'%')
11    IF(SHLDF.EQ.SHLDF0)GO TO 12
      IXRAT=PCT(SHLDF0,SHLDF)
      WRITE(6,6112)IXRAT
6112  FORMAT(' SHIELDS IMPROVED BY ',I3,'%')
12    IF(ICLOAK.GE.0)GO TO 13
      SDAYS=-ICLOAK/100.
      WRITE(6,7101)SDAYS
7101  FORMAT(' CLOAKING DEVICE AVAILABLE FOR ',F5.2,' STARDAYS')
13    CALL QTIME(ISTART)
      GO TO 4000
C     ...DAMAGE REPORT.
3009  IF(JDAM.NE.2)GO TO 30999
      WRITE(6,30991)
30991 FORMAT(' REPAIR CREWS REASSIGNED')
30999 TOTAL=0.
      N=0
      DO 30992 J=1,10
      IF(JDAM.EQ.2)IPROB1(J)=IPROB2(J)
      IF(IDMG(J).EQ.0)GO TO 30992
      TOTAL=TOTAL+IPROB1(J)
      N=N+1
30992 IPROB2(J)=0
      IF(JDAM.EQ.2)GO TO 4000
      WRITE(6,30091)
30091 FORMAT(' DAMAGE REPORT')
      JJ=0
      IF(N.EQ.0)GO TO 37379
      DO 30092 J=1,10
      IF(IDMG(J).EQ.0)GO TO 30092
      JJ=1
      SDAYS=IDMG(J)/100. *FLOAT(NMEN)/FLOAT(MEN)
      ASSN=((100.-TOTAL)/N+IPROB1(J))/100.
      JSSN=ASSN*100.
      DAYS=1.E7
      IF(ASSN.LE.0.)GO TO 39899
      DAYS=SDAYS/ASSN/ERPRRT
39899 WRITE(6,30093)NAMD(J),DAYS,JSSN
30093 FORMAT(1X,A8,2X,'-',F5.2,' STARDAYS',' (',I3,'%)')
30092 CONTINUE
37379 IF(JJ.EQ.1)GO TO 30094
      WRITE(6,30095)
30095 FORMAT(' NO DAMAGE')
C     ...CHECK MEN KILLED.
30094 IF(MEN.EQ.NMEN)GO TO 30099
      KMEN=NMEN-MEN
      WRITE(6,30096)KMEN,MEN
30096 FORMAT(1X,I4,' CREW KILLED - ',I4,' LEFT')
30099 ITM=0
      DO 30098 J=1,20
30098 ITM=ITM+ITRMEN(J)
      IF(ITM.EQ.IFGHTM)GO TO 4000
      KMEN=IFGHTM-ITM
      IF(KMEN.LT.0)KMEN=0
      WRITE(6,30097)KMEN,ITM
30097 FORMAT(1X,I4,' TROOPS KILLED - ',I4,' LEFT')
      GO TO 4000
C     ...EVASIVE MANEUVERS.
3010  IF(PSP.GE.1.0)GO TO 994
      DSP=EVMSP
      IF(IDMG(1).EQ.0.OR.IDMG(2).EQ.0)GO TO 30111
      IF(IDMG(1).EQ.0)GO TO 30104
      WRITE(6,30019)NAMD(1)
      IF(IDMG(2).EQ.0)GO TO 998
30104 WRITE(6,30019)NAMD(2)
      WRITE(6,30119)SIM
      NBASES=0
      GO TO 998
30111 IF(IEVDR.EQ.1)GO TO 30101
      IF(IEVDR.EQ.3)GO TO 30103
      PDEG=PDEG-90.
      IF(PDEG.LT.0.)PDEG=PDEG+360.
      X=EVENU
      IF(IDMG(1).NE.0)X=X*2.5
      GO TO 30102
30101 PDEG=PDEG+90.
      X=EVENU
      IF(IDMG(1).NE.0)X=X*2.5
30105 IF(PDEG.GE.360.)PDEG=PDEG-360.
      GO TO 30102
30103 PDEG=PDEG+180.
      X=EVENU*1.5
      IF(IDMG(1).NE.0)X=X*2.5
      GO TO 30105
30102 ENERGY=ENERGY-X
      IF(ENERGY.LE.0.)CALL RATING(2)
      DDEG=PDEG
      IF(ITRUCE.EQ.0)GO TO 4000
      ITRUCE=0
      WRITE(6,33333)
      GO TO 4000
C     ...EMERGENCY EVASIVE MANEUVERS.MUST USE WARP DRIVE.
3011  IF(PSP.GE.1.)GO TO 994
      DSP=EEVMSP
      NBASES=99
      IF(IDMG(1).EQ.0)GO TO 30111
      GO TO 30104
C     ...RAISE DEFLECTORS.
3012  IF(ADDFL.LT.-DEFL)GO TO 3013
      DEFL=DEFL+ADDFL
      ENERGY=ENERGY-ADDFL
      IF(ENERGY.LE.0.)CALL RATING(2)
      GO TO 4000
C     ...DROP DEFLECTORS.
3013  ENERGY=ENERGY+DEFL
      WRITE(6,30131)
30131 FORMAT(' DROP DEFLECTORS')
      DEFL=0.
      GO TO 4000
C     ...PROPOSE TRUCE.
3014  IF(PSP.GE.1.)GO TO 994
      WRITE(6,30141)
30141 FORMAT(' TRUCE PROPOSED')
      X=0.
      Y=0.
      JJ=0
      IF(KLNGNS.EQ.0)GO TO 30143
      DO 30142 J=1,KLNGNS
      IF(XKL(J,1).EQ.0.)GO TO 30142
      IF(ICNTL(J+1).EQ.1)GO TO 30142
      IF(ITRMEN(J+1).NE.0)GO TO 30146
      JJ=1
      X=X+XKL(J,7)
      Y=Y+XKLHIT
30142 CONTINUE
30143 IF(NROM.EQ.0)GO TO 30145
      DO 30144 J=1,NROM
      IF(XROM(J,1).EQ.0.)GO TO 30144
      IF(ICNTL(J+10).EQ.1)GO TO 30144
      IF(ITRMEN(J+10).NE.0)GO TO 30146
      JJ=1
      X=X+XROM(J,3)
      Y=Y+XRMHIT
30144 CONTINUE
30145 IF(JJ.EQ.0)GO TO 30146
C     ...ACCEPTED ONLY IF ALL ENEMY AT LEAST 75% DAMAGED.
      IF(RAN(IZZ).GT.(X/Y)/THITR)GO TO 30146
      WRITE(6,30147)
30147 FORMAT(' TRUCE ACCEPTED')
      ITRUCE=1
      GO TO 4000
30146 WRITE(6,30148)
30148 FORMAT(' TRUCE OFFER DECLINED')
      GO TO 4000
C     ...SHORT RANGE TRACK.
3015  IF(PSP.GE.1.)GO TO 994
      WRITE(6,30151)
30151 FORMAT(' SHORT RANGE TRACK')
      IF(KLNGNS.EQ.0)GO TO 30154
      DO 30152 J=1,KLNGNS
      IF(XKL(J,1).EQ.0.)GO TO 30152
      WRITE(6,30157)LETR(3),J,(XKL(J,K),K=1,4)
30157 FORMAT(1X,A1,I1,' AT ',F4.1,',',F4.1,' SPEED: ',F6.3,' BEARING: ',
     1F5.0)
30153 FORMAT(1X,A1,1X,' AT ',F4.1,',',F4.1,' SPEED: ',F6.3,' BEARING: ',
     1F5.0)
30152 CONTINUE
30154 IF(NTORPS.EQ.0)GO TO 30156
      DO 30155 J=1,NTORPS
      IF(TORPS(J,1).EQ.0.)GO TO 30155
      WRITE(6,30153)LETR(7),(TORPS(J,K),K=1,4)
30155 CONTINUE
30156 WRITE(6,30153)LETR(2),XQE,YQE,PSP,PDEG
      IF(ISTSH.NE.99)GO TO 30174
      WRITE(6,30153)LETR(12),SHX,SHY,SHVX,SHDEG
30174 IF(IGH.EQ.0)GO TO 30159
      WRITE(6,30153)LETR(5),(GHOST(K),K=1,2),(GHOST(L),L=4,5)
30159 CALL QTIME(ISTART)
      GO TO 4000
C     ...GALACTIC MAP DISPLAY.
C 3016  CALL CPAGE
3016  WRITE(6,30163)
30163 FORMAT(' GALACTIC UPDATE')
      I=NQUAD+1
30161 I=I-1
      IF(I.LT.1)GO TO 30166
      DO 30164 J=1,NQUAD
      IF(I.EQ.JCE.AND.J.EQ.ICE)GO TO 30165
      IPQ(J,I)=LETR(9)
      GO TO 30164
30165 IPQ(J,I)=LETR(2)
30164 CONTINUE
      WRITE(6,30162)(IGAL(J,I),IPQ(J,I),J=1,NQUAD)
30162 FORMAT(1X,10(I4,A1,2X))
      GO TO 30161
30166 CALL QTIME(ISTART)
      GO TO 4000
C     ....PLOT BEARING.
3017  WRITE(6,30171)
30171 FORMAT(' PLOT BEARING')
      IF(PSP.GE.1.)GO TO 30176
      IF(NSTARS.EQ.0)GO TO 30175
      DO 30172 J=1,NSTARS
      IF(STARS(J,1).EQ.0.)GO TO 30172
      CALL GETBRG(DELTA,XQE,STARS(J,1),YQE,STARS(J,2),VPX,VPY)
      VSX=SQRT(VPX*VPX+VPY*VPY)
      WRITE(6,30173)LETR(1),J,STARS(J,1),STARS(J,2),DELTA,VSX ,RAD(J)
30173 FORMAT(1X,A1,I1,' AT ',F4.1,',',F4.1,' BEARING: ',F4.0,' DISTANCE:
     1 ',F4.1,' RADIUS: ',F3.2)
30172 CONTINUE
30175 IF(IBASE.EQ.0)GO TO 4000
      CALL GETBRG(DELTA,XQE,BASE(1),YQE,BASE(2),VPX,VPY)
      VSX=SQRT(VPX*VPX+VPY*VPY)
      WRITE(6,30180)LETR(6),BASE(1),BASE(2),DELTA,VSX   ,RADEB
30180 FORMAT(1X,A1,'  AT ',F4.1,',',F4.1,' BEARING: ',F4.0,' DISTANCE:
     1 ',F4.1,' RADIUS: ',F3.2)
      GO TO 4000
C     ...IF WARP 1 OR HIGHER, GIVE QUADRANTS OF STARBASES.
30176 DO 30177  I=1,NQUAD
      DO 30177  J=1,NQUAD
      IF((JGAL(I,J)-JGAL(I,J)/100*100)/10.EQ.0) GO TO 30177
      WRITE(6,30178)I,J
30178 FORMAT(' STARBASE IN QUADRANT ',I2,',',I2)
30177 CONTINUE
      DO 38179 I=1,NQUAD
      DO 38179 J=1,NQUAD
      IF(IGAL(I,J).LT.0.OR.IBL(I,J).LE.0)GO TO 38179
      WRITE(6,38174)I,J
38174 FORMAT(' BLACK HOLE IN QUADRANT ',I2,',',I2)
38179 CONTINUE
      GO TO 4000
C     ...SELF DESTRUCT
3018  CALL RATING(7)
      GO TO 4000
C     ...TRANSPORTERS.
3019  IF(PSP.GE.1.)GO TO 994
      IF(IFROM.EQ.LETR(3))GO TO 1391
      IF(IFROM.EQ.LETR(4))GO TO 1392
      IF(IFROM.EQ.LETR(5))GO TO 1393
      IF(IFROM.EQ.LETR(6))GO TO 1394
      IF(IFROM.NE.LETR(2))GO TO 998
      LUP=2
      GO TO 1395
1394  LUP=6
      GO TO 1395
1391  LUP=3
      IF(KFROM.LT.1.OR.KFROM.GT.KLNGNS)GO TO 998
      GO TO 1395
1392  LUP=4
      IF(KFROM.LT.1.OR.KFROM.GT.NROM)GO TO 998
      GO TO 1395
1393  LUP=5
1395  CONTINUE
      IF(ITO.EQ.LETR(3))GO TO 13901
      IF(ITO.EQ.LETR(4))GO TO 13902
      IF(ITO.EQ.LETR(5))GO TO 13903
      IF(ITO.NE.LETR(2))GO TO 998
      LDOWN=2
      GO TO 13905
13901 LDOWN=3
      IF(MTO.LT.1.OR.MTO.GT.KLNGNS)GO TO 998
      IF(ITRUCE.EQ.0.OR.ICNTL(MTO+1).EQ.1)GO TO 13905
      ITRUCE=0
      WRITE(6,33333)
      GO TO 13905
13902 LDOWN=4
      IF(MTO.LT.1.OR.MTO.GT.NROM)GO TO 998
      IF(ITRUCE.EQ.0.OR.ICNTL(MTO+10).EQ.1)GO TO 13905
      ITRUCE=0
      WRITE(6,33333)
      GO TO 13905
13903 LDOWN=5
C     ...COMMAND OK NOW.
13905 ISTAT=IBMEN
      JTO=MTO
      JFROM=KFROM
      JDOWN=LDOWN
      JUP=LUP
      GO TO 4000
C     ...OTHER SHIP ACTIVITIES UNDER E CONTROL.
3020  IF(PSP.GE.1.)GO TO 994
      GO TO (30201,992,992,30204,30205,30206,992,30208,30209,992   ,992,
     130212,992,992,992,992,30217),IMSG
C     ...K COURSE CHANGE.
30201 IF(LTO.EQ.5)GO TO 30240
      IF(ICNTL(KTO+1).NE.1)GO TO 992
      IF(ITRMEN(KTO+1).LE.0)GO TO 992
      XKL(KTO,6)=KBRG
      XKL(KTO,5)=AMIN1(ABS(XWRP),VMXKL)
      GO TO 4000
C     ...K FIRE PHASER.
30204 IF(LTO.EQ.5)GO TO 30250
      IF(ICNTL(KTO+1).NE.1)GO TO 992
      IF(ITRMEN(KTO+1).LE.0)GO TO 992
      XKL(KTO,8)=NTSTPS+1+(CREWK/ITRMEN(KTO+1)*SKDLAY+RAN      (IZZ)*XKF
     1PST)
      GO TO 4000
C     ...R FIRE TORPEDO.
30205 IF(LTO.EQ.5)GO TO 30260
      IF(ICNTL(KTO+10).NE.1)GO TO 992
      IF(ITRMEN(KTO+10).LE.0)GO TO 992
      XROM(KTO,4)=NTSTPS+1+(SCREWR/ITRMEN(KTO+10)*SRDLY+RAN      (IZZ)*X
     1RFTS)*XRMHIT/(XRMHIT-XROM(KTO,3))
      GO TO 4000
C     ...SCUTTLE SHIP
C     ...JJSTAT=0 NORMAL
C     ...JJSTAT < 0 TRANSPORTERS QUEUED FOR USE BY AUTO-DESTRUCT.
C     ...JJSTAT > 0 TRANSPORTERS CURRENTLY IN USE FOR AUTO-DESTRUCT.
30206 L=LTO-2
      IF(ITRMEN(26).EQ.0.AND.LTO.EQ.6)GO TO 36000
      IF(LTO.EQ.5)KTO=1
      M=(L-1)*9+KTO+1
      IF(ICNTL(M).NE.1)GO TO 992
      IF(ITRMEN(M).EQ.0)GO TO 992
      IF(JJSTAT.NE.0)GO TO 39299
      SDAYS=0.
      IF(ISTAT.EQ.0)GO TO 39200
C     ...TRANSPORTERS IN USE. SET UP JJSTAT TO INDICATE WE ARE WAITNG.
      JJSTAT=-ISTAT/(IDAMRP+1)-1
      GO TO 39202
39200 ISTAT=ITRMEN(M)
      JJSTAT=1
      JFROM=KTO
      JUP=LTO
      JDOWN=2
      JTO=1
      SDAYS=(ISTAT/(IDAMRP+1)+1)/100.
      GO TO 39204
39202 SDAYS=SDAYS-JJSTAT/100.
      JJFROM=KTO
      JJUP=LTO
      JJDOWN=2
      JJTO=1
      SDAYS=SDAYS+(ITRMEN(M)/(IDAMRP+1)+1)/100.
      IISTAT=ITRMEN(M)
39204 WRITE(6,39203)SDAYS
39203 FORMAT(' DESTRUCT IN ',F5.2,' STARDAYS')
      GO TO 4000
39299 WRITE(6,39298)LETR(JUP),JFROM
39298 FORMAT(' RETYPE COMMAND WHEN ',A1,I1,' DESTRUCT SEQUENCE COMPLETED
     1')
      GO TO 998
C     ...DESTRUCT BASE
36000 IF(IBASE.EQ.0)GO TO 992
      WRITE(6,36001)
36001 FORMAT(' DESTRUCT SEQUENCE ENTERED!!!!!!'/
     1' THE BASE WILL DESTRUCT IN 10 SECONDS'/
     1' 10'/
     1'   9'/
     1'    8'/
     1'     7'/
     1'      6'/
     1' SELF DESTRUCT IN 5 SECONDS! FAIL-SAFE MECHANISM ENGAGED'/
     1' ONLY THE COMMANDER CAN OVERRIDE WITH HIS PASSWORD'/
     1' ENTER PASSWORD TO DESTROY BASE:')
      READ(5,36002,END=4000)NPASS
36002 FORMAT(A8)
      IF(NPASS.NE.MPASS)GO TO 4000
      WRITE(6,36003)
36003 FORMAT('       5'/
     1'        4'/
     1'         3'/
     1'          2'/
     1'           1')
      CALL DLETE(6,1)
      GO TO 4000
C     ...STATUS REPORT
30208 IF(LTO.EQ.6)GO TO 30299
      LTO=LTO-2
      GO TO (30281,30285,30288),LTO
C     ...KLINGON STATUS
30281 IF(ICNTL(KTO+1).NE.1)GO TO 992
      WRITE(6,30282)LETR(3),KTO,(XKL(KTO,J),J=1,4),ITRMEN(KTO+1)
30282 FORMAT(' STATUS REPORT FOR ',A1,I1,' AT ',F4.1,',',F4.1/      ' SP
     1EED: ',F5.3,' BEARING: ',F4.0,' MEN ON BOARD: ',I5)
      GO TO 4000
C     ...ROMULAN STATUS
30285 IF(ICNTL(KTO+10).NE.1)GO TO 992
      WRITE(6,30283)LETR(4),KTO,XROM(KTO,1),XROM(KTO,2),ITRMEN(KTO+10)
30283 FORMAT(' STATUS REPORT FOR ',A1,I1,' AT ',F4.1,',',F4.1/      ' ME
     1N ON BOARD: ',I5)
      GO TO 4000
C     ...GHOSTSHIP STATUS
30288 IF(IGH.EQ.0)GO TO 992
      IF(ICNTL(20).NE.1)GO TO 992
      WRITE(6,30284)LETR(5),GHOST(1),GHOST(2),GHOST(4),GHOST(5),      (G
     1HOST(K),K=11,13),ITRMEN(20)
30284 FORMAT(' STATUS REPORT FOR ',A1,' AT ',F4.1,',',F4.1/      ' SPEED
     1: ',F5.3,' BEARING: ',F4.0,' ENERGY: ',F7.1,      ' TORPS: ',F3.0/
     1' SHIELD STRENGTH: ',F6.1,' MEN ON BOARD: ',I5)
      GO TO 4000
C     ...DAMAGE REPORT
30209 LTO=LTO-2
      GO TO (30291,30295,30298),LTO
C     ...KLINGON DAMAGE
30291 IF(ICNTL(KTO+1).NE.1)GO TO 992
      WRITE(6,30292)LETR(3),KTO,XKL(KTO,7)
30292 FORMAT(' DAMAGE REPORT FOR ',A1,I1,' HITS: ',F5.1)
      GO TO 4000
C     ...ROMULAN DAMAGE
30295 IF(ICNTL(KTO+10).NE.1)GO TO 992
      WRITE(6,30292)LETR(4),KTO,XROM(KTO,3)
      GO TO 4000
C     ...GHOSTSHIP DAMAGE
30298 IF(IGH.EQ.0)GO TO 992
      IF(ICNTL(20).NE.1)GO TO 992
      WRITE(6,30292)LETR(5),IGH,GHOST(3)
3991  IF(IGHPH.EQ.0)WRITE(6,30293)NAMD(3)
30293 FORMAT(1X,A10,' DEAD')
3992  IF(IGHTR.EQ.0)WRITE(6,30293)NAMD(4)
3993  IF(IGHDR.EQ.0)WRITE(6,30293)NAMD(2)
3994  IF(IGHDE.EQ.0)WRITE(6,30293)DEFLEC
      GO TO 4000
C     ...G RAISE DEFLECTORS.
30212 IF(ICNTL(20).NE.1)GO TO 992
      IF(IGHDE.EQ.0)GO TO 3994
      IF(SDEF)30213,992,30214
C     ...DROP
30213 SDEF=AMAX1(SDEF,-GHOST(13))
30215 GHOST(13)=GHOST(13)+SDEF
      GHOST(11)=GHOST(11)-SDEF
      GO TO 4000
C     ...RAISE
30214 SDEF=AMIN1(SDEF,GHOST(11))
      GO TO 30215
C     ...CHANGE COURSE
30240 IF(ICNTL(20).NE.1)GO TO 992
      IF(ITRMEN(20).LE.0)GO TO 992
      IF(IGHDR.EQ.0)GO TO 3993
      GHOST(6)=AMIN1(XWRP,GHVMX)
      GHOST(7)=KBRG
      GO TO 4000
C     ...G FIRE P.
30250 IF(ICNTL(20).NE.1)GO TO 992
      IF(ITRMEN(20).LE.0)GO TO 992
      IF(IGHPH.EQ.0)GO TO 3991
      GHOST(10)=NTSTPS+1+FLOAT(MIN0(MXCRGH,ITRMEN(20)))/      FLOAT(ITRM
     1EN(20))
      GO TO 4000
C     ...G FIRE T.
30260 IF(ICNTL(20).NE.1)GO TO 992
      IF(ITRMEN(20).LE.0)GO TO 992
      IF(IGHTR.EQ.0)GO TO 3992
      GHOST(8)=NTSTPS+1+FLOAT(MIN0(MXCRGH,ITRMEN(20)))/      FLOAT(ITRME
     1N(20))
      GO TO 4000
C     ...COMMUNICATION WITH B.
30299 IF(IBASE.EQ.0)GO TO 992
      WRITE(6,30294)IBMENR
30294 FORMAT(' STARBASE TROOPS AVAILABLE: ',I4)
      GO TO 4000
C     ...PLOT BEARING FROM BASE.
30217 IF(IBASE.EQ.0)GO TO 992
      WRITE(6,30171)
      IF(NSTARS.EQ.0)GO TO 30218
      DO 30219 J=1,NSTARS
      IF(STARS(J,1).EQ.0.)GO TO 30219
      CALL GETBRG(DELTA,BASE(1),STARS(J,1),BASE(2),STARS(J,2),VPX,VPY)
      VSX=SQRT(VPX*VPX+VPY*VPY)
      WRITE(6,30173)LETR(1),J,STARS(J,1),STARS(J,2),DELTA,VSX ,RAD(J)
30219 CONTINUE
30218 CALL GETBRG(DELTA,BASE(1),XQE,BASE(2),YQE,VPX,VPY)
      VSX=SQRT(VPX*VPX+VPY*VPY)
      WRITE(6,30180)LETR(2),XQE,YQE,DELTA,VSX,RADEB
      GO TO 4000
C     ...SHUTTLECRAFT ACTIVITIES.
3031  IF(PSP.GE.1.)GO TO 994
      IF(ISHNUM.LE.0)GO TO 30314
      GO TO (30310,30315),JSCHM
C     ...EXPLORE.
30310 IF(ISHSTR(1).GT.NSTARS.OR.ISHSTR(1).LE.0)GO TO 998
      IF(STARS(ISHSTR(1),1).EQ.0.)GO TO 998
      ISHD=ISHSTR(1)
      IF(ISTSH.NE.99)GO TO 4000
      SDAYS=RANGE(SHX,STARS(ISHSTR(1),1),SHY,STARS(ISHSTR(1),2))/SHVX/10
     10.
      WRITE(6,30313)SDAYS
30313 FORMAT(' ARRIVAL IN ',F4.2,' STARDAYS')
      GO TO 4000
C     ...RETURN
30314 WRITE(6,30311)
30311 FORMAT(' NO SHUTTLECRAFT ON BOARD')
      GO TO 998
30315 IF(ISTSH.EQ.0)GO TO 998
      ISHD=99
      IF(ISTSH.NE.99)GO TO 4000
      SDAYS=RANGE(SHX,XQE,SHY,YQE)/100./SHVX
      WRITE(6,30313)SDAYS
      GO TO 4000
C     ...COMPUTER REQUESTS.
3033  IF(PSP.GE.1.)GO TO 994
      GO TO (30331,30334,30338,30340,30370,30360),JSCHM
      GO TO 998
C     ...ENERGY FOR G.
30331 IF(IGH.EQ.0)GO TO 992
      X=(GHOST(1)-XQE)**2+(GHOST(2)-YQE)**2
      X=X/DISTGT*PTRGH
      WRITE(6,30332)X
30332 FORMAT(F8.0,' UNITS ENERGY REQUIRED')
      GO TO 4000
C     ...WHERE HOLE WILL TAKE YOU.
30334 IF(IHOLE.EQ.0)GO TO 992
      I=IBL(ICE,JCE)/100
      J=IBL(ICE,JCE)-I*100
      WRITE(6,30335)I,J
30335 FORMAT(' HOLE GOES TO QUADRANT ',I2,',',I2)
      GO TO 4000
C     ...SHUTTLECRAFT ROUND TRIP TIME.
30338 IF(ISTSH.EQ.99)GO TO 30350
      DO 30351 I=1,9
      IF (ISTSH.EQ.I)GO TO 30350
30351 CONTINUE
      IF(ISHSTR(1).LE.0.OR.NSTARS.EQ.0)GO TO 992
30350 JTIME=0
      Y=SHX
      Z=SHY
      IF(ISHD.EQ.99)GO TO 30333
      DO 30339 I=1,10
      J=ISHSTR(I)
      IF(J.LE.0)GO TO 30333
      IF(STARS(J,1).EQ.0.)GO TO 30333
      X=RANGE(Y,STARS(J,1),Z,STARS(J,2))
      Y=STARS(J,1)
      Z=STARS(J,2)
      JTIME=JTIME+X/SHVX
      GO TO 30339
30333 X=RANGE(Y,XQE,Z,YQE)
      JTIME=JTIME+X/SHVX
      GO TO 30336
30339 CONTINUE
      GO TO 992
30336 WRITE(6,30337)JTIME
30337 FORMAT(' ROUND TRIP TIME = ',I4,' STARMINUTES')
      GO TO 4000
30340 CALL CPAGE
      IIKK=0
      WRITE(6,30341)
30341 FORMAT(' COMMUNIQUE FROM STARFLEET COMMAND! '/'  THE CURRENT RANKS
     1 HAVE BEEN OBTAINED BY THE FOLLOWING OFFICERS:')
30342 IRNK=14
      IIKK=IIKK+1
      READ(3'IIKK,ERR=30347)MNAME,POINTS,MPASS,X6,X7,IRST
      IF(MNAME.EQ.MOLDNM)GO TO 30347
      MOLDNM=MNAME
30344 IF(POINTS.GE.RANKPT(IRNK))GO TO 30345
      IRNK=IRNK-1
      GO TO 30344
30345 IF(IRST.EQ.0)GO TO 30348
      IF(IRST.EQ.1)IST=ISTATS(1)
      IF(IRST.EQ.2)IST=ISTATS(2)
      WRITE(6,30346)RANKS(1,IRNK),RANKS(2,IRNK),MNAME,POINTS,IST
30346 FORMAT(2A8,' ',A8,' CURRENTLY HAS POINTS = ',F6.2,' GAME ',A8)
      GO TO 30342
30348 WRITE(6,30349)RANKS(1,IRNK),RANKS(2,IRNK),MNAME,POINTS
30349 FORMAT(2A8,' ',A8,' CURRENTLY HAS POINTS = ',F6.2)
      GO TO 30342
30347 READ(3'MMKEY,ERR=4000)MNAME,POINTS,MPASS,X6,X7,IRST
      GO TO 4000
30370 ION=0
      IF(ICLKON.EQ.IYES)ION=1
      GO TO 4000
30360 CALL QTIME(ITC)
      ITM1=ITC/3600
      ITC=ITC-ITM1*3600
      ITM2=ITC/60
      ITM3=ITC-ITM2*60
      WRITE(6,30361)ITM1,ITM2,ITM3
30361 FORMAT(' CURRENT TIME FROM COMPUTER BANKS: ',I2,':',I2,':',I2)
      GO TO 4000
C     ...CANCELLED COMMAND DUE TO ILLEGAL REQUEST VALUE OR CHANGE IN
C     ...SYSTEM STATUS.
998   WRITE(6,996)
      IF(ICM.EQ.6)ETR(1)=0.
      IF(ICM.EQ.5)EFT(1,1)=0.
      IF(ICM.EQ.4)EFP(1)=0.
      PNRGY=0.
996   FORMAT(' ***CANCELLED***')
      GO TO 4000
C     ...ILLEGAL COMMAND AREA.
994   WRITE(6,993)
      IF(ICM.GE.4.AND.ICM.LE.6)GO TO 998
993   FORMAT(' IMPOSSIBLE - HYPERSPACE!')
      GO TO 4000
C     ...NEW ONE HERE.
992   WRITE(6,991)
991   FORMAT(' NOT UNDER E CONTROL OR OTHERWISE IMPOSSIBLE')
C     ...FINISH UP.
4000  CALL QTIME(JTIME)
      NSTEPS=(JTIME-ISTART)+ITRSTP*ITFCTR
      ISTART=JTIME
      ITRSTP=0
      IF(NSTEPS.LE.0)NSTEPS=1
5000  RETURN
      END
      SUBROUTINE PUTIN(IX,IY,NBAD,IBAD,IALPH)
C     ...PUT THINGS IN A QUADRANT.
      COMMON/ARRAYS/NAMD(10),BASE(2),EFP(3),EFT(25,2),ETR(3),GHOST(13),
     1  IBL(10,10),IDMG(10),IGAL(10,10),IPQ(10,10),JGAL(10,10),LETR(13),
     1  IPROB1(10),RAD(9),STARS(9,2),TORPS(30,4),XKL(9,9),XROM(9,4)
      DOUBLE PRECISION NAMD
      COMMON/SCALAR/ACCE,DCHG,DDEG,DECR,DEFL,DELTA,DELV,DGIMP,DGKL,DGWP,
     1  DISTGT,DISTKR,DISTPE,DISTPK,DIV1,DIV2,DMXSPD,DSP,DSPKL,DVEL,
     1  DVIMP,DVWP,EEVMSP,EIMP,ENERGY,ERPRRT,ESDIST,ETVEL,EVENU,EVMSP,
     1  EWRP,FDATE,GHEMX,GHTMX,IBASE,ICE,IDOCK,IETOFT,IGH,IHERE,IHWARP,
     1  ISTART,ITFCTR,ITFIRE,ITORP,ITRUCE,IZZ,JCE,KLNGNS,XKTIME,
     1  LEFTK,LEFTR,MAXBQ,MAXK,MAXKQ,MAXR,MAXRQ,MAXSQ,MEN,MINK,MINR,
     1  MROM,MULTK1,MULTK2,NBASES,NKL,NMEN,NROM,NSTARS,NSTEPS,NTORPS,
     1  NTSTPS,NTRP,PCTCOL,PDEG,PNRGY,PRGH,PRKLN,PRREEN,PSP,PTRGH,
     1  RADEGC,REEN,RPRKL,RPRRM,RTIME,RTV,SDATE,SENRGY,
     1  SIM,TFACTR,THITR,TNRGY,TPMIN,TPOWR,VMXKL,VRKL,XDDEG,XDSP,XGHIT,
     1  XKFPE,XKFPST,XKLHIT,XRFTS,XRMHIT,XQE,XTIME,XTRTM,YQE,ZMIN,
     1  PRORAS,RADEK,RADEG,RADER,RADEB,RADET,RADKR,RADKG,RADKB,RADKT,
     1  RADKK,RADGB,RADGT,RAGGR,RADBT,RADTT,RADTR,RADES,RADSS
      DIMENSION IBAD(100,2)
100   IX=RAN(IZZ)*10.+1.
      IY=RAN(IZZ)*10.+1.
      DO 200   I=1,NBAD
      IF(IX.EQ.IBAD(I,1).AND.IY.EQ.IBAD(I,2))GO TO 100
200   CONTINUE
      NBAD=NBAD+1
      IBAD(NBAD,1)=IX
      IBAD(NBAD,2)=IY
      IPQ(IX,IY)=IALPH
      RETURN
      END
      SUBROUTINE QQMOVE
      COMMON/ARRAYS/NAMD(10),BASE(2),EFP(3),EFT(25,2),ETR(3),GHOST(13),
     1  IBL(10,10),IDMG(10),IGAL(10,10),IPQ(10,10),JGAL(10,10),LETR(13),
     1  IPROB1(10),RAD(9),STARS(9,2),TORPS(30,4),XKL(9,9),XROM(9,4)
      DOUBLE PRECISION NAMD
      COMMON/SCALAR/ACCE,DCHG,DDEG,DECR,DEFL,DELTA,DELV,DGIMP,DGKL,DGWP,
     1  DISTGT,DISTKR,DISTPE,DISTPK,DIV1,DIV2,DMXSPD,DSP,DSPKL,DVEL,
     1  DVIMP,DVWP,EEVMSP,EIMP,ENERGY,ERPRRT,ESDIST,ETVEL,EVENU,EVMSP,
     1  EWRP,FDATE,GHEMX,GHTMX,IBASE,ICE,IDOCK,IETOFT,IGH,IHERE,IHWARP,
     1  ISTART,ITFCTR,ITFIRE,ITORP,ITRUCE,IZZ,JCE,KLNGNS,XKTIME,
     1  LEFTK,LEFTR,MAXBQ,MAXK,MAXKQ,MAXR,MAXRQ,MAXSQ,MEN,MINK,MINR,
     1  MROM,MULTK1,MULTK2,NBASES,NKL,NMEN,NROM,NSTARS,NSTEPS,NTORPS,
     1  NTSTPS,NTRP,PCTCOL,PDEG,PNRGY,PRGH,PRKLN,PRREEN,PSP,PTRGH,
     1  RADEGC,REEN,RPRKL,RPRRM,RTIME,RTV,SDATE,SENRGY,
     1  SIM,TFACTR,THITR,TNRGY,TPMIN,TPOWR,VMXKL,VRKL,XDDEG,XDSP,XGHIT,
     1  XKFPE,XKFPST,XKLHIT,XRFTS,XRMHIT,XQE,XTIME,XTRTM,YQE,ZMIN,
     1  PRORAS,RADEK,RADEG,RADER,RADEB,RADET,RADKR,RADKG,RADKB,RADKT,
     1  RADKK,RADGB,RADGT,RAGGR,RADBT,RADTT,RADTR,RADES,RADSS
      COMMON/EXTRAS/SNOVAP,ZMAX,ICLOAK,PRCLDN,PHOLE,IHOLE,JHOLE,HOLRAD,
     1  SHLDF,NQUAD,PSTORM,ISTORM,JSTORM,STMRAD,LEVEL,ION,IYES,CMIN,
     1  CPOWR
C     ...ROMULANS AND KLINGONS MOVE FROM QUADRANT TO QUADRANT TOWARDS
C     ...BASES.
      XTOT=NKL+MROM
      YTOT=LEFTK+LEFTR
      PRQMV=SQRT(1.-YTOT/XTOT)
C     ...PRQMV IS PROBABILITY THAT ENEMY WILL MOVE OUT OF A QUADRANT.
C     ...DON'T SELECT QUADRANTS WITH BASES IN THEM OR E IN.
      DO 1000 I=1,NQUAD
      DO 1000 J=1,NQUAD
      IF(I.EQ.ICE.AND.J.EQ.JCE)GO TO 1000
      IK=JGAL(I,J)
      IF(IK.LE.99)GO TO 1000
      IF(IK-IK/100*100.GT.9)GO TO 1000
      IF(RAN(IZZ).GT.PRQMV)GO TO 1000
C     ...MOVE MAX OF 1K + 1R.
      X=I
      Y=J
      M=99
      N=99
C     ...FIND NEAREST QUAD WITH BASE.
      DIST=1.E9
      DO 100 K=1,NQUAD
      DO 100 L=1,NQUAD
      IF(JGAL(K,L)-JGAL(K,L)/100*100.LE.9)GO TO 100
      U=K
      V=L
      Z=RANGE(X,U,Y,V)
      IF(Z.GE.DIST)GO TO 100
      DIST=Z
      M=K
      N=L
100   CONTINUE
      IF(M.EQ.99)GO TO 9999
      M=M-I
      N=N-J
      IM=1
      JM=1
      K=ISIGN(1,M)+I
      IF(M.EQ.0)K=I
      L=ISIGN(1,N)+J
      IF(N.EQ.0)L=J
      IF(K.EQ.ICE.AND.L.EQ.JCE)GO TO 1000
      JK=JGAL(K,L)
C     ...ROMULANS FIRST, THEN KLINGONS. NOTE THAT IGAL IS NOT UPDATED!
C     ...NO MORE THAN 99XX IN A QUADRANT.
      IF(IK.LT.1000)GO TO 200
      IF(JK.GE.9000)GO TO 200
      JGAL(I,J)=JGAL(I,J)-1000
      JGAL(K,L)=JGAL(K,L)+1000
200   IF(IK-IK/1000*1000.LT.100)GO TO 1000
      IF(JK-JK/1000*1000.GE.900)GO TO 1000
      JGAL(I,J)=JGAL(I,J)-100
      JGAL(K,L)=JGAL(K,L)+100
1000  CONTINUE
9999  RETURN
      END
      FUNCTION RAN(X)
      DIMENSION IDOL(2)
      DATA IDOL/'$','@'/
C     ...CALLS RAND. NO. SUBROUTINE FROM IBM 360 SSP
C     ...X - ANY VALUE <= 9 DIGITS ON FIRST CALL.
C     ...AFTERWARDS, X = RANDOM NUMBER (1<X>0).
      Y=X
C     ...INITILIZATION?
      IF(IDOL(2).EQ.IDOL(1))GOTO 1
      IDOL(2)=IDOL(1)
      CALL QTIME(IX,Y)
      Y=Y/2.
      IIY=IX/2
C     ...BUMP IY IF EXISTING NUMBER IS EVEN
      IF(MOD(IX,2).EQ.0)IX=IX + 1
 1    IY=IX*65539
      IF(IY)5,6,6
 5    IY=IY+2147483647+1
 6    YFL=IY
      YFL=YFL*.4656613E-9
      IX=IY
      RAN=YFL
      X=YFL
      RETURN
      END
      FUNCTION RANGE(W,X,Y,Z)
C     ...GET RANGE FROM OBJECT A TO OBJECT B.
      RANGE=SQRT((W-X)**2+(Y-Z)**2)
      RETURN
      END
      SUBROUTINE RATING(IR)
C     ...END OF GAME ROUTINE.
      COMMON/ARRAYS/NAMD(10),BASE(2),EFP(3),EFT(25,2),ETR(3),GHOST(13),
     1  IBL(10,10),IDMG(10),IGAL(10,10),IPQ(10,10),JGAL(10,10),LETR(13),
     1  IPROB1(10),RAD(9),STARS(9,2),TORPS(30,4),XKL(9,9),XROM(9,4)
      DOUBLE PRECISION NAMD
      COMMON/SCALAR/ACCE,DCHG,DDEG,DECR,DEFL,DELTA,DELV,DGIMP,DGKL,DGWP,
     1  DISTGT,DISTKR,DISTPE,DISTPK,DIV1,DIV2,DMXSPD,DSP,DSPKL,DVEL,
     1  DVIMP,DVWP,EEVMSP,EIMP,ENERGY,ERPRRT,ESDIST,ETVEL,EVENU,EVMSP,
     1  EWRP,FDATE,GHEMX,GHTMX,IBASE,ICE,IDOCK,IETOFT,IGH,IHERE,IHWARP,
     1  ISTART,ITFCTR,ITFIRE,ITORP,ITRUCE,IZZ,JCE,KLNGNS,XKTIME,
     1  LEFTK,LEFTR,MAXBQ,MAXK,MAXKQ,MAXR,MAXRQ,MAXSQ,MEN,MINK,MINR,
     1  MROM,MULTK1,MULTK2,NBASES,NKL,NMEN,NROM,NSTARS,NSTEPS,NTORPS,
     1  NTSTPS,NTRP,PCTCOL,PDEG,PNRGY,PRGH,PRKLN,PRREEN,PSP,PTRGH,
     1  RADEGC,REEN,RPRKL,RPRRM,RTIME,RTV,SDATE,SENRGY,
     1  SIM,TFACTR,THITR,TNRGY,TPMIN,TPOWR,VMXKL,VRKL,XDDEG,XDSP,XGHIT,
     1  XKFPE,XKFPST,XKLHIT,XRFTS,XRMHIT,XQE,XTIME,XTRTM,YQE,ZMIN,
     1  PRORAS,RADEK,RADEG,RADER,RADEB,RADET,RADKR,RADKG,RADKB,RADKT,
     1  RADKK,RADGB,RADGT,RAGGR,RADBT,RADTT,RADTR,RADES,RADSS
      DOUBLE PRECISION RANKS(2,14),MNAME,MPASS,MOLDNM,NOLDNM,
     1  ISTATS(2),IST
      COMMON/RANK/RANKS,MNAME,MPASS,POINTS,RANKPT(14),NRANKS,IRANK,NRW,
     1  MMKEY,NTIME,IOK,NHOLD,ICLKON,NSW,ISTATS
      DIMENSION PWIN(3,4),PLOSE(3,4)
      COMMON/FILVAR/IV
      COMMON/EXTRAS/SNOVAP,ZMAX,ICLOAK,PRCLDN,PHOLE,IHOLE,JHOLE,HOLRAD,
     1  SHLDF,NQUAD,PSTORM,ISTORM,JSTORM,STMRAD,LEVEL,ION,IYES,CMIN,
     1  CPOWR
      DATA PWIN/1.,2.,3.,2.,4.,6.,3.,6.,9.,5.,10.,15./
      DATA PLOSE/3*1.,3*2.,3*3.,3*5./
      DATA ILOSE/0/
      GO TO (10,20,30,40,50,60,60),IR
10    WRITE(6,1)
1     FORMAT(' COLLISION WITH STAR!  SHIP DESTROYED')
      GO TO 100
20    ENERGY=ENERGY+DEFL
      DEFL=0.
      IF(ENERGY.LE.0.)GO TO 20888
      WRITE(6,20889)
20889 FORMAT(' DEFECTORS AUTOMATICALLY DROPPED TO OBTAIN ENERGY')
      RETURN
20888 WRITE(6,2)
2     FORMAT(' OUT OF ENERGY')
      GO TO 100
30    WRITE(6,3)
3     FORMAT(' TIME''S UP!')
      GO TO 100
40    WRITE(6,4)
4     FORMAT(' CONGRATULATIONS!!')
      GO TO 100
50    WRITE(6,5)
5     FORMAT(' CREW WIPED OUT!')
      GO TO 100
60    WRITE(6,6)
6     FORMAT(' WARP DRIVE EXPLOSION!...EVERYTHING IN QUADRANT DESTROYED!
     1!')
      IF(PSP.GE.1.)GO TO 100
      IF(KLNGNS.EQ.0)GO TO 90
      DO 80 J=1,KLNGNS
      IF(XKL(J,1).EQ.0.)GO TO 80
      LEFTK=LEFTK-1
80    CONTINUE
90    IF(NROM.EQ.0)GO TO 100
      DO 70    J=1,NROM
      IF(XROM(J,1).EQ.0.)GO TO 70
      LEFTR=LEFTR-1
70    CONTINUE
100   R=LEFTK+LEFTR
      S=NKL+MROM
      R=(S-R)/S
      KR=R*1000.
      IF(KR.GE.1000)GO TO 999
      IF(KR.GE.900)GO TO 998
      IF(KR.GE.750)GO TO 997
      IF(KR.GE.500)GO TO 996
      IF(KR.GE.250)GO TO 995
      WRITE(6,94)
94    FORMAT(' YOU REALLY BLEW IT. THE INCUMBENT WILL LOSE BY'/      ' A
     1 LANDSLIDE AND DON''T BE SURPRISED IF THEY RENAME THE VULCAN BOWL'
     1/      ' THE KLINGON BOWL!')
      GO TO 994
995   WRITE(6,95)
95    FORMAT(' STARFLEET COMMAND HANGS YOU IN EFFIGY.'/      ' AT LEAST
     1YOU WON''T BE CALLED UPON TO TESTIFY AT THE STARGATE HEARINGS!')
      GO TO 994
996   WRITE(6,96)
96    FORMAT(' YOU SEEM TO BE GETTING THE HANG OF IT.'/      ' THE PRESI
     1DENT MAY BE ABLE TO PULL THE ELECTION OUT BY REFERRING TO'/      '
     1 YOUR EFFORTS AS A "TACTICAL REDEPLOYMENT IN CERTAIN NON-'/      '
     1 CRITICAL SECTORS OF THE GALAXY."')
      GO TO 994
997   WRITE(6,97)
97    FORMAT(' A MOST VALIANT EFFORT. YOUR NAME WILL LONG BE REMEMBERED
     1WITH FEAR'/      ' BY THE PITIFUL REMNANTS OF THE ONCE MIGHTY KLIN
     1GON-ROMULAN EMPIRE'/      ' THE PRESIDENT WOULD HAVE APPOINTED YOU
     1 ATTORNEY GENERAL AT LEAST..')
      GO TO 994
998   WRITE(6,98)
98    FORMAT(' CONGRATULATIONS!! YOU HAVE OVERCOME INCREDIBLE ODDS'/
     1  ' TO COME WITHIN A HAIR OF VICTORY. YOUR CHILDREN WILL BE WELL'/
     1      ' PROVIDED FOR.')
      GO TO 994
999   IF(IR.EQ.7)GO TO 993
      WRITE(6,99)
99    FORMAT(' VICTORY, TOTAL AND COMPLETE, IS YOURS!!!'/      ' YOUR FA
     1ME WILL SPREAD THROUGHOUT THE ENTIRE  UNIVERSE! UNFORTUNATELY,'/
     1    '  THE PRESIDENT DOESN''T LIKE BEING KNOCKED OFF THE FRONT PAG
     1E'/      ' SO HE HAS APPOINTED YOU AS PERMANENT AMBASSADOR TO THE
     1OUTER STOTINKI'/      ' COLONIES.')
      GO TO 994
993   WRITE(6,92)
92    FORMAT(' YOUR PLACE IN VALHALLA IS ASSURED. YOU HAVE ELIMINATED TH
     1E LAST'/      ' MAJOR THREAT TO THE FEDERATION IN THIS ERA. YOU MA
     1Y EVEN INSPIRE'/      ' A NEW TELEVISION SERIES!?!?')
994   WRITE(6,93)
93    FORMAT(///)
      WRITE(6,7)KR
7     FORMAT(' RATING = ',I5)
C     ...DETERMINE POINT GAIN OR LOSS FACTOR.
      IF(NRW.EQ.0)GO TO 661
      IWIN=1
      IF(KR.LT.750)IWIN=-1
      IF(KR.LT.900.AND.IRANK.GE.10)IWIN=-1
C     ...DETERMINE INDICES FOR PWIN OR PLOSE. S IS TOTAL ENEMY AT START.
      IL=4
      IF(S.LT.100.)IL=3
      IF(S.LT.50.)IL=2
      IF(S.LT.25)IL=1
      IF(IRANK.EQ.NRANKS)GO TO 3005
      IF(LEVEL.EQ.1.AND.IRANK.GE.7.AND.IWIN.GT.0)WRITE(6,66601)
66601 FORMAT(' IF YOU WANT TO GAIN RANK YOU''LL HAVE TO PLAY AT A HIGHER
     1 LEVEL')
      IF(LEVEL.EQ.1.AND.IRANK.GE.7.AND.IWIN.GT.0)IWIN=0
      IF(IL.EQ.1.AND.IRANK.GE.9.AND.IWIN.GT.0)WRITE(6,66602)
66602 FORMAT(' SIR IF YOU WANT TO GAIN RANK YOU''LL HAVE TO PLAY AGAINST
     1 MORE ENEMIES')
      IF(IL.EQ.1.AND.IRANK.GE.9.AND.IWIN.GT.0)IWIN=0
      IF(IRANK.GE.11.AND.IL.LT.3.AND.IWIN.GT.0)WRITE(6,66602)
      IF(IRANK.GE.11.AND.IL.LT.3.AND.IWIN.GT.0)IWIN=0
      IF(IRANK.EQ.NRANKS-1.AND.(S.LT.198.OR.LEVEL.LT.3.OR.KR.NE.1000.OR.
     1  ITFCTR.GT.10).AND.IWIN.GT.0)WRITE(6,66603)
66603 FORMAT(' ADMIRAL SIR: IF YOU WANT TO BECOME A FLEET ADMIRAL YOU''L
     1L HAVE'/' TO PLAY A LEVEL 3 GAME WITH 198 ENEMIES AND A TIMING FAC
     1TOR OF 10 OR LESS.')
      IF(IRANK.EQ.NRANKS-1.AND.(S.LT.198.OR.LEVEL.LT.3.OR.KR.NE.1000.OR.
     1  ITFCTR.GT.10).AND.IWIN.GT.0)IWIN=0
3005  IF(IRANK.EQ.NRANKS.AND.IWIN.LT.0)GO TO 1999
      IF(IWIN)1000,1999,3000
C     ...LOSS. DEMOTION.
1000  XPTS=-IWIN*PLOSE(LEVEL,IL)
      XPTS=XPTS-XPTS*R
      XPTS=AMIN1(XPTS,POINTS)
      IF(XPTS.EQ.0.)GO TO 1999
      WRITE(6,1001)XPTS
1001  FORMAT(' WELL, YOU BLEW',F5.2,' POINTS ON THAT ONE, MEATHEAD.')
      IF(POINTS.GE.1.)POINTS=AMAX1(1.,POINTS-XPTS)
      IF(POINTS.GE.1.)GO TO 1002
      POINTS=AMAX1(0.,POINTS-XPTS)
1002  IF(POINTS.GE.RANKPT(IRANK))GO TO 1003
      IRANK=IRANK-1
      GO TO 1002
1003  WRITE(6,1004)RANKS(1,IRANK),RANKS(2,IRANK),POINTS
1004  FORMAT(' YOUR PRESENT RANK IS ',2A8,'. # POINTS = ',F6.2)
      GO TO 2000
C     ...WIN. PROMOTION.
3000  XPTS=IWIN*PWIN(LEVEL,IL)
      XPTS=XPTS*R
      IF(IR.EQ.7)XPTS=XPTS/2.
      WRITE(6,3001)XPTS
3001  FORMAT(' YOU GAINED ',F5.2,' POINTS ON THAT ONE.')
      POINTS=POINTS+XPTS
      IF(IRANK.EQ.NRANKS)GO TO 1003
      IF(POINTS.LT.RANKPT(IRANK+1))GO TO 1003
      IRANK=IRANK+1
      IF(IRANK.EQ.NRANKS)GO TO 1003
      POINTS=AMIN1(POINTS,RANKPT(IRANK+1)-1.)
      GO TO 1003
1999  WRITE(6,1998)
1998  FORMAT(' NO CHANGE IN STATUS THIS TIME.')
      GO TO 661
2000  READ(3'MMKEY)MNAME,X,MPASS,X6,X7,IRST
      IRST=0
      WRITE(3'MMKEY)MNAME,POINTS,MPASS,X6,X7,IRST
      WRITE(9'1)MNAME,POINTS,MPASS,ILOSE,ILOSE
      GO TO 2001
661   READ(3'MMKEY)MNAME,POINTS,MPASS,X6,X7,IRST
      IRST=0
      WRITE(3'MMKEY)MNAME,POINTS,MPASS,X6,X7,IRST
      WRITE(9'1)MNAME,POINTS,MPASS,ILOSE,ILOSE
2001  STOP
      END
      SUBROUTINE REPAIR
      COMMON/ARRAYS/NAMD(10),BASE(2),EFP(3),EFT(25,2),ETR(3),GHOST(13),
     1  IBL(10,10),IDMG(10),IGAL(10,10),IPQ(10,10),JGAL(10,10),LETR(13),
     1  IPROB1(10),RAD(9),STARS(9,2),TORPS(30,4),XKL(9,9),XROM(9,4)
      DOUBLE PRECISION NAMD
      COMMON/SCALAR/ACCE,DCHG,DDEG,DECR,DEFL,DELTA,DELV,DGIMP,DGKL,DGWP,
     1  DISTGT,DISTKR,DISTPE,DISTPK,DIV1,DIV2,DMXSPD,DSP,DSPKL,DVEL,
     1  DVIMP,DVWP,EEVMSP,EIMP,ENERGY,ERPRRT,ESDIST,ETVEL,EVENU,EVMSP,
     1  EWRP,FDATE,GHEMX,GHTMX,IBASE,ICE,IDOCK,IETOFT,IGH,IHERE,IHWARP,
     1  ISTART,ITFCTR,ITFIRE,ITORP,ITRUCE,IZZ,JCE,KLNGNS,XKTIME,
     1  LEFTK,LEFTR,MAXBQ,MAXK,MAXKQ,MAXR,MAXRQ,MAXSQ,MEN,MINK,MINR,
     1  MROM,MULTK1,MULTK2,NBASES,NKL,NMEN,NROM,NSTARS,NSTEPS,NTORPS,
     1  NTSTPS,NTRP,PCTCOL,PDEG,PNRGY,PRGH,PRKLN,PRREEN,PSP,PTRGH,
     1  RADEGC,REEN,RPRKL,RPRRM,RTIME,RTV,SDATE,SENRGY,
     1  SIM,TFACTR,THITR,TNRGY,TPMIN,TPOWR,VMXKL,VRKL,XDDEG,XDSP,XGHIT,
     1  XKFPE,XKFPST,XKLHIT,XRFTS,XRMHIT,XQE,XTIME,XTRTM,YQE,ZMIN,
     1  PRORAS,RADEK,RADEG,RADER,RADEB,RADET,RADKR,RADKG,RADKB,RADKT,
     1  RADKK,RADGB,RADGT,RAGGR,RADBT,RADTT,RADTR,RADES,RADSS
      COMMON/TBEAMS/IFGHTM,ITRMEN(20),JUP,JFROM,IBMEN,JDOWN,JTO,IBMENR,
     1  SBMNR,CREWR(9),SCREWR,CREWK,CODDS,DODDS,EODDS,FODDS
      COMMON/SUBCTL/ICNTL(20),RTBRG(5),KTO,LTO,KBRG,XWRP,
     1  ISTAT,IDAMRP,SDEF,IMSG,SKDLAY,SRDLY,GHVMX,MXCRGH,GHPHEN,
     1  DSPGH,DGGH,RPRGH,NHELP,NHELPS,XHELP
      DOUBLE PRECISION DEFLEC
      COMMON/FORGOT/GHACCE,PJAM,PJMINC,ACTPJM,PPHASD,PTORPD,PDRVD,
     1  PDEFD,IGHPH,IGHTR,IGHDR,IGHDE
      COMMON/SHUTL/SHX,SHY,SHDEG,SHVX,ISTSH,ISHD,IFNDS(9),IDSES,VDSES,
     1  VSTRDS,VSTRM,PRXSH,VDSESM,ISHNUM
      COMMON/SHUTL2/ALEDR,IALIC,IALJC,IALSS
      COMMON/EXTRAS/SNOVAP,ZMAX,ICLOAK,PRCLDN,PHOLE,IHOLE,JHOLE,HOLRAD,
     1  SHLDF,NQUAD,PSTORM,ISTORM,JSTORM,STMRAD,LEVEL,ION,IYES,CMIN,
     1  CPOWR
      DATA DEFLEC/'DFLECTRS'/
      DATA TRKL,TRRM/1.7,2.1/
      DATA ITDK/0/
C     ...DAMAGE REPAIR SECTION
2800  FACTR=1.
      IF(ITRUCE.EQ.1)FACTR=TFACTR
      IF(PSP.GE.1.)GO TO 2840
C     ...KLINGON REPAIR.
      IF(KLNGNS.EQ.0)GO TO 2820
      DO 2810    J=1,KLNGNS
      IF(XKL(J,1).EQ.0.)GO TO 2810
      IF(ICNTL(J+1).EQ.1)GO TO 2805
      XKL(J,7)=XKL(J,7)-RPRKL*FACTR *XKL(J,9)/CREWK
      GO TO 2806
C     ...SLOWER IF UNDER E CONTROL.
2805  XKL(J,7)=XKL(J,7)-RPRKL*FACTR*ITRMEN(J+1)/CREWK/TRKL
2806  IF(XKL(J,7).LT.0.)XKL(J,7)=0.
2810  CONTINUE
2820  IF(NROM.EQ.0)GO TO 2840
C     ...ROMULAN REPAIR.
      DO 2830    J=1,NROM
      IF(XROM(J,1).EQ.0.)GO TO 2830
      IF(ICNTL(J+10).EQ.1)GO TO 2835
      XROM(J,3)=XROM(J,3)-RPRRM*FACTR   *CREWR(J)/SCREWR
      GO TO 2836
C     ...SLOWER IF UNDER E CONTROL.
2835  XROM(J,3)=XROM(J,3)-RPRRM*FACTR*ITRMEN(J+10)/SCREWR/TRRM
2836  IF(XROM(J,3).LT.0.)XROM(J,3)=0.
2830  CONTINUE
C     ...E DAMAGE REPAIR BY CREW.
2840  XTRP=0.
      JTRP=0
      DO 2850 J=1,10
      IF(IDMG(J).EQ.0)GO TO 2850
      XTRP=XTRP+IPROB1(J)
      JTRP=JTRP+1
2850  CONTINUE
      IF(JTRP.EQ.0)GO TO 2860
      XTRP=(100.-XTRP)/JTRP
      DO 2855 K=1,10
      IF(IDMG(K).EQ.0)GO TO 2855
      IF(RAN(IZZ).GT.FLOAT(MEN)/FLOAT(NMEN)*(IPROB1(K)+XTRP)/100.)
     1  GO TO 28
     155
      IDMG(K)=IDMG(K)-FACTR*ERPRRT
      IF(IDMG(K).GT.0)GO TO 2855
      IDMG(K)=0
      IF(K.EQ.1)IHWARP=0
      WRITE(6,2856)NAMD(K)
2856  FORMAT(1X,A10,' REPAIRED!')
2855  CONTINUE
C     ...G DAMAGE REPAIR BY E TROOPS.
2860  IF(IGH.EQ.0.OR.ICNTL(20).NE.1)GO TO 2900
      FIXR=FLOAT(ITRMEN(20))/FLOAT(MXCRGH)*TFACTR
      GHOST(3)=GHOST(3)-RPRGH*FACTR*FIXR
      IF(GHOST(3).LT.0.)GHOST(3)=0.
      IF(IGHPH.EQ.1)GO TO 2881
      IF(RAN(IZZ).GT.FIXR*PPHASD*PPHASD)GO TO 2881
      WRITE(6,2885)LETR(5),NAMD(3)
2885  FORMAT(1X,A1,1X,A10,' REPAIRED')
      IGHPH=1
      GO TO 2900
2881  IF(RAN(IZZ).GT.FIXR*PTORPD*PTORPD)GO TO 2882
      IF(IGHTR.EQ.1)GO TO 2882
      WRITE(6,2885)LETR(5),NAMD(4)
      IGHTR=1
      GO TO 2900
2882  IF(RAN(IZZ).GT.FIXR*PDRVD*PDRVD)GO TO 2883
      IF(IGHDR.EQ.1)GO TO 2883
      WRITE(6,2885)LETR(5),NAMD(2)
      IGHDR=1
      GO TO 2900
2883  IF(RAN(IZZ).GT.FIXR*PDEFD*PDEFD)GO TO 2900
      IF(IGHDE.EQ.1)GO TO 2900
      WRITE(6,2885)LETR(5),DEFLEC
      IGHDE=1
C     ...DISEASE ACTIVE AREA.
2900  IF(IDSES.EQ.0)GO TO 2929
45    KLED=MULTK1*VDSES*RAN(IZZ)*FLOAT(MEN+ITRMEN(1))/FLOAT(NMEN+IFGHTM)
      KKLED=RAN(IZZ)*KLED
      LKLED=MIN0(KLED-KKLED,MEN)
      KKLED=MIN0(KLED-LKLED,ITRMEN(1))
      KLED=LKLED+KKLED
      MEN=MEN-LKLED
      ITRMEN(1)=ITRMEN(1)-KKLED
      IF(ITRMEN(1).LT.0)ITRMEN(1)=0
      IF(KLED.EQ.0)GO TO 55
      WRITE(6,2901)
2901  FORMAT(' DISEASE LOSSES -')
      IF(MEN.GT.6)GO TO 50
      CALL RATING(5)
50    WRITE(6,2)KLED,MEN, ITRMEN(1)
      ITDK=ITDK+KLED
2     FORMAT(' MEN KILLED: ',I4,' CREW LEFT: ',I4,' TROOPS LEFT: ',I4)
55    IF(RAN(IZZ).GT.VSTRDS)GO TO 2929
      IDSES=0
      WRITE(6,2802)ITDK
2802  FORMAT(' DISEASE CURE FOUND AFTER ',I3,' FATALITIES ')
      ITDK=0
C     ...ALIEN BEINGS DRAINING E ENERGY BANKS.
2929  IF(IALSS.EQ.0)GO TO 3000
      IF(IALIC.NE.ICE.OR.IALJC.NE.JCE)GO TO 2950
      IF(NSTARS.EQ.0.OR.STARS(IALSS,1).EQ.0.)GO TO 2950
      ENERGY=ENERGY-ALEDR
      IF(ENERGY.LE.0.)CALL RATING(2)
      GO TO 3000
2950  IALSS=0
C     ...USING UP CLOAKING DEVICE FREE TIME.
3000  IF(ICLOAK.GE.0)GO TO 3100
      ICLOAK=ICLOAK+1
3100  RETURN
      END
      SUBROUTINE ROMLN
      COMMON/ARRAYS/NAMD(10),BASE(2),EFP(3),EFT(25,2),ETR(3),GHOST(13),
     1  IBL(10,10),IDMG(10),IGAL(10,10),IPQ(10,10),JGAL(10,10),LETR(13),
     1  IPROB1(10),RAD(9),STARS(9,2),TORPS(30,4),XKL(9,9),XROM(9,4)
      DOUBLE PRECISION NAMD
      COMMON/SCALAR/ACCE,DCHG,DDEG,DECR,DEFL,DELTA,DELV,DGIMP,DGKL,DGWP,
     1  DISTGT,DISTKR,DISTPE,DISTPK,DIV1,DIV2,DMXSPD,DSP,DSPKL,DVEL,
     1  DVIMP,DVWP,EEVMSP,EIMP,ENERGY,ERPRRT,ESDIST,ETVEL,EVENU,EVMSP,
     1  EWRP,FDATE,GHEMX,GHTMX,IBASE,ICE,IDOCK,IETOFT,IGH,IHERE,IHWARP,
     1  ISTART,ITFCTR,ITFIRE,ITORP,ITRUCE,IZZ,JCE,KLNGNS,XKTIME,
     1  LEFTK,LEFTR,MAXBQ,MAXK,MAXKQ,MAXR,MAXRQ,MAXSQ,MEN,MINK,MINR,
     1  MROM,MULTK1,MULTK2,NBASES,NKL,NMEN,NROM,NSTARS,NSTEPS,NTORPS,
     1  NTSTPS,NTRP,PCTCOL,PDEG,PNRGY,PRGH,PRKLN,PRREEN,PSP,PTRGH,
     1  RADEGC,REEN,RPRKL,RPRRM,RTIME,RTV,SDATE,SENRGY,
     1  SIM,TFACTR,THITR,TNRGY,TPMIN,TPOWR,VMXKL,VRKL,XDDEG,XDSP,XGHIT,
     1  XKFPE,XKFPST,XKLHIT,XRFTS,XRMHIT,XQE,XTIME,XTRTM,YQE,ZMIN,
     1  PRORAS,RADEK,RADEG,RADER,RADEB,RADET,RADKR,RADKG,RADKB,RADKT,
     1  RADKK,RADGB,RADGT,RAGGR,RADBT,RADTT,RADTR,RADES,RADSS
      COMMON/TRNSFR/ICM,IDIR,MTORPS,DTORP(30),IBTYP,IEVDR,ADDFL,ITRSTP,
     1  KFROM,MTO,LUP,LDOWN,IFROM,ITO,JSCHM,ISHSTR(10),JDAM,
     1  IPROB2(10),NGHTFP
      COMMON/TBEAMS/IFGHTM,ITRMEN(20),JUP,JFROM,IBMEN,JDOWN,JTO,IBMENR,
     1  SBMNR,CREWR(9),SCREWR,CREWK,CODDS,DODDS,EODDS,FODDS
      COMMON/SUBCTL/ICNTL(20),RTBRG(5),KTO,LTO,KBRG,XWRP,
     1  ISTAT,IDAMRP,SDEF,IMSG,SKDLAY,SRDLY,GHVMX,MXCRGH,GHPHEN,
     1  DSPGH,DGGH,RPRGH,NHELP,NHELPS,XHELP
      COMMON/EXTRAS/SNOVAP,ZMAX,ICLOAK,PRCLDN,PHOLE,IHOLE,JHOLE,HOLRAD,
     1  SHLDF,NQUAD,PSTORM,ISTORM,JSTORM,STMRAD,LEVEL,ION,IYES,CMIN,
     1  CPOWR
      DIMENSION RMOVES(3,3)
      DATA PRRMV/.111/
      DATA WNDESC,WEDGEM,WT,WGH,WK,WKO/-20.,10.,8.,15.,10.,10./
      DATA WSAMSQ/5./
C     ...JSCAN WILL BE USED TO ASSURE THAT WE DON'T CALL SCAN
C     ...MORE THAN ONCE.
      DO 2750  J=1,NROM
      IF(XROM(J,1).EQ.0.)GO TO 2750
C     ...R MOVES (JUMPS) IN INCREMENTS OF 1 PARSEC IN ANY OF 8
C     ...DIRECTIONS.
2710  IF(ICNTL(J+10).EQ.1)GO TO 2725
C     ...ROMULAN MOVEMENT. MOVES TO 1 OF 8 ADJACENT POINTS IN QUAD.
      IF(RAN(IZZ).GT.PRRMV.OR.LEVEL.EQ.1)GO TO 2725
      IF(JSCAN.EQ.1)GO TO 27101
      IHERE=2
C     ...SET UP IPQ SO WE CAN TELL WHICH POINTS ARE OCCUPIED.
      CALL SCAN
27101 IX=XROM(J,1)
      IY=XROM(J,2)
C     ...RMOVES USED TO SELECTIVELY WEIGHT EACH OF THE 9 POINTS.
      IDIR=-2
      DO 1000 K=1,3
      IDIR=IDIR+1
      JDIR=-2
      DO 990 L=1,3
      JDIR=JDIR+1
      RMOVES(K,L)=0.
      MM=IX+IDIR
      NN=IY+JDIR
      XK=MM
      YK=NN
      IF(MM.GE.1.AND.MM.LE.10)GO TO 980
C     ...DO NOT LEAVE QUAD UNLESS DAMAGED OR TO AVOID TORPS.
985   RMOVES(K,L)=WNDESC
      IF(XROM(J,3).LT.THITR*XRMHIT.AND.MROM/LEFTR.LT.7)GO TO 990
      KCE=2*MM/11-1+ICE
      IF(KCE.GE.1.AND.KCE.LE.NQUAD)GO TO 987
C     ...BIG PENALTY FOR LEAVING GALAXY.
988   RMOVES(K,L)=-1000.
      GO TO 990
986   RMOVES(K,L)=WNDESC
      IF(XROM(J,3).LT.THITR*XRMHIT.AND.MROM/LEFTR.LT.7)GO TO 990
      KCE=2*NN/11-1+JCE
      IF(KCE.LT.1.OR.KCE.GT.NQUAD)GO TO 988
987   RMOVES(K,L)=1000.
      GO TO 990
980   IF(NN.LT.1.OR.NN.GT.10)GO TO 986
C     ...DON'T GO THERE IF OCCUPIED UNLESS BY SELF.
      IF(IPQ(MM,NN).EQ.LETR(8).AND.(ICLOAK.NE.2.OR.(MM.NE.XROM(1,1).AND.
     1NN.NE.XROM(1,2))))GO TO 970
      IF(IDIR.EQ.0.AND.JDIR.EQ.0)GO TO 975
      RMOVES(K,L)=-1.E13
      GO TO 990
C     ...TENDS NOT TO SIT STILL IF NO OTHER CONSIDERATIONS.
975   RMOVES(K,L)=WSAMSQ
C     ...AVOID KLINGONS.
970   IF(KLNGNS.EQ.0)GO TO 950
      DO 960 M=1,KLNGNS
      IF(XKL(M,1).EQ.0.)GO TO 960
      W=WK
C     ...BETTER TO HIT THEM IF CAPTURED OR ABOUT TO BE.
      IF(ITRMEN(K+1).GE.50)W=WKO
      RMOVES(K,L)=RMOVES(K,L)-W/RANGE(XK,XKL(M,1),YK,XKL(M,2))
960   CONTINUE
C     ...AVOID TORPS BY CALCULATING EACH SQUARE'S DISTANCE FROM
C     ...ALL ENEMY TORPEDO PATHS HEADED THIS WAY.
950   IF(NTORPS.EQ.0)GO TO 930
      DO 940 M=1,NTORPS
      IF(TORPS(M,1).EQ.0..OR.TORPS(M,4).GE.0..AND.TORPS(M,4).LT.360.)GO
     1TO 940
      CALL GETBRG(DELTA,XK,TORPS(M,1),YK,TORPS(M,2),VPX,VPY)
      DELV=TORPS(M,4)
      IF(DELV.LT.0.)DELV=DELV+360.
      IF(DELV.GE.360.)DELV=DELV-360.
      VPX=DELTA+90.
      IF(VPX.GE.360.)VPX=VPX-360.
      VPY=DELTA-90.
      IF(VPY.LT.0.)VPY=VPY+360.
      IF(DELV.LE.VPX.OR.DELV.GE.VPY)GO TO 940
      VPX=COSD(DELV)
      VPY=SIND(DELV)
      S=9.E17
      IF(VPY.LT.0.)S=-9.E17
      IF(ABS(VPY).GT.1./9.E17)S=VPX/VPY
      IF(S.LT.0.)GO TO 4510
      IF(S.LT.1./9.E17)S=1./9.E17
      GO TO 4520
4510  IF(S.GT.-1./9.E17)S=-1./9.E17
4520  C1=TORPS(M,2)-S*TORPS(M,1)
      C2=YK+XK/S
      VPX=(C2-C1)/(S+1./S)
      VPY=S*VPX+C1
      RMOVES(K,L)=RMOVES(K,L)-WT/RANGE(XK,VPX,YK,VPY)
940   CONTINUE
C     ...AVOID GHOSTSHIPS.
930   IF(IGH.EQ.0)GO TO 920
      RMOVES(K,L)=RMOVES(K,L)-WGH/RANGE(XK,GHOST(1),YK,GHOST(2))
C     ...BONUS FOR MOVING TOWARDS EDGE IF DAMAGED.
920   IF(XROM(J,3).LT.THITR*XRMHIT/3.)GO TO 990
      IF(IX.GT.5.AND.MM.LE.IX.OR.IX.LE.5.AND.MM.GE.IX)GO TO 910
915   R  MOVES(K,L)=RMOVES(K,L)+WEDGEM
      GO TO 990
910   IF(IY.GT.5.AND.NN.LE.IY.OR.IY.LE.5.AND.NN.GE.IY)GO TO 990
      GO TO 915
990   CONTINUE
1000  CONTINUE
C     ...BEST SQ. TO MOVE TO WILL BE ONE WITH HIGHEST TOTAL WEIGHT.
      WMAX=-1.E13
      JJ=2
      KK=2
      DO 800 K=1,3
      DO 800 L=1,3
      IF(RMOVES(K,L).LT.WMAX)GO TO 800
      WMAX=RMOVES(K,L)
      JJ=K
      KK=L
800   CONTINUE
      K=IX
      L=IY
      IX=IX+JJ-2
      IY=IY+KK-2
      XROM(J,1)=IX
      XROM(J,2)=IY
      IF(IX.GE.1.AND.IX.LE.10.AND.IY.GE.1.AND.IY.LE.10)GO TO 27248
C     ...LEAVING QUADRANT AND/OR GALAXY.
2720  JX=0
      IF(IX.LT.1)JX=-1
      IF(IX.GT.10)JX=1
      JY=0
      IF(IY.LT.1)JY=-1
      IF(IY.GT.10)JY=1
      KCE=ICE+JX
      LCE=JCE+JY
      IRG=(JGAL(KCE,LCE))
      IF(IRG.GE.9000)GO TO 27260
      IF(IPQ(K,L).EQ.LETR(4))IPQ(K,L)=LETR(8)
      JSCAN=1
      IF(KCE.LE.NQUAD.AND.KCE.GE.1.AND.LCE.LE.NQUAD.AND.LCE.GE.1)GO TO 2
     1722
      WRITE(6,2721)LETR(4),J
2721  FORMAT(1X,A1,I1,' LEAVING GALAXY')
      CALL DLETE(4,J)
      GO TO 2750
2722  WRITE(6,2723)LETR(4),J,KCE,LCE
2723  FORMAT(1X,A1,I1,' ESCAPED TO QUADRANT ',I2,',',I2)
27245 JGAL(ICE,JCE)=JGAL(ICE,JCE)-1000
      IF(IGAL(ICE,JCE).NE.-1.AND.(IDMG(6).NE.0.OR.IDMG(7).NE.0))IGAL(ICE
     1,JCE)=JGAL(ICE,JCE)
      JGAL(KCE,LCE)=JGAL(KCE,LCE)+1000
      ICNTL(J+10)=0
      IF(ITRMEN(J+10).EQ.0)GO TO 27232
      IF(XROM(J,1).EQ.0.)GO TO 27244
      WRITE(6,101)ITRMEN(J+10)
101   FORMAT(I4,' TROOPS CAPTURED BY ENEMY')
      GO TO 27243
27244 WRITE(6,29242)ITRMEN(J+10)
29242 FORMAT(I4,' TROOPS ON BOARD LOST')
27243 ITRMEN(J+10)=0
27232 XROM(J,1)=0.
      IF(ISTAT.EQ.0)GO TO 2750
      IF(JUP.EQ.4.AND.JFROM.EQ.J.OR.JDOWN.EQ.4.AND.JTO.EQ.J)ISTAT=9999
      IF(NROM.GT.1)GO TO 2750
      GO TO 2999
27260 IF(XROM(J,1).LT.1)XROM(J,1)=1
      IF(XROM(J,2).LT.1)XROM(J,2)=1
      IF(XROM(J,1).GT.10)XROM(J,1)=10
      IF(XROM(J,2).GT.10)XROM(J,2)=10
C     ...ENTERING HOLE?
27248 IF(LEVEL.NE.3.OR.IHOLE.EQ.0)GO TO 27242
      IF(IX.NE.IHOLE.OR.IY.NE.JHOLE)GO TO 27242
27249 KCE=IBL(ICE,JCE)/100
      LCE=IBL(ICE,JCE)-KCE*100
      IF(JGAL(KCE,LCE).GE.9000)GO TO 27247
      GO TO 2722
27247 WRITE(6,27246)LETR(4),J
27246 FORMAT(1X,A1,I1,' CAPTURED BY BLACK HOLE')
      CALL DLETE(4,J)
      GO TO 2750
27242 GO TO 2724
C     ...CHANGE IPQ ARRAY IF MOVED TO SAVE CALL TO SCAN.
2724  JSCAN=1
      IF(K.EQ.IX.AND.L.EQ.IY)GO TO 2725
27252 IF(IPQ(K,L).EQ.LETR(4))IPQ(K,L)=LETR(8)
27255 IF(IPQ(IX,IY).EQ.LETR(8))IPQ(IX,IY)=LETR(4)
C     ...R FIRES T.
2725  IF(XROM(J,4).GT.NTSTPS.OR.XROM(J,4).EQ.0.)GO TO 2750
      IF(ICLOAK.LT.0.AND.ION.EQ.1)GO TO 2750
      IF(ICNTL(J+10).NE.1)GO TO 2760
C     ...R UNDER E CONTROL FIRES T.
      WRITE(6,38644)J
38644 FORMAT(' R',I1,' LAUNCHED TORPEDO')
      DELTA=RTBRG(1)-360.
      RTBRG(1)=-1.
      XROM(J,4)=0.
      IF(RTBRG(2).LT.0.)GO TO 2730
      XROM(J,4)=NTSTPS+1+(SCREWR/ITRMEN(J+10)*SRDLY+RAN      (IZZ)*XRFTS
     1)*XRMHIT/(XRMHIT-XROM(J,3))
      DO 2758 K=1,4
2758  RTBRG(K)=RTBRG(K+1)
      RTBRG(5)=-1.
      GO TO 2730
2760  CALL GETBRG(DELTA,XROM(J,1),XQE,XROM(J,2),YQE,VPX,VPY)
      IF(PSP.EQ.0.)GO TO 2730
C     ...CALCULATE ANGLE FOR FIRING TO REACH E IF IT IS MOVING.
      DX=SIND(PDEG-DELTA)*PSP/RTV
      IF(DX*DX.GT.1.)GO TO 2740
      DY=SQRT(1.-DX*DX)
      DX=ATAN2(DX,DY)*RADEGC
      DELTA=DX+DELTA
      IF(DELTA.LT.0.)DELTA=DELTA+360.
      IF(DELTA.GE.360.)DELTA=DELTA-360.
C     ...FIND SPOT IN TORPS ARRAY TO PUT THE NEW ONE.
2730  IF(NTORPS.NE.0)GO TO 2732
      NT=1
      NTORPS=30
      GO TO 2735
2732  DO 2733 K=1,NTORPS
      IF(TORPS(K,1).EQ.0.)GO TO 2734
2733  CONTINUE
      GO TO 2750
2734  NT=K
2735  TORPS(NT,3)=RTV
      TORPS(NT,4)=DELTA
      VSX=COSD(DELTA)*RTV+XROM(J,1)
      VSY=SIND(DELTA)*RTV+XROM(J,2)
2739  TORPS(NT,1)= VSX
      TORPS(NT,2)= VSY
      IF(ICNTL(J+10).EQ.1)GO TO 2750
C     ...RESET FIRING
2740  XROM(J,4)=NTSTPS+RAN(IZZ)*XRFTS*XRMHIT/(XRMHIT-XROM(J,3))+1.
2750  CONTINUE
2800  RETURN
2999  NROM=0
      GO TO 2800
      END
      SUBROUTINE RSTART(NN)
      COMMON/ARRAYS/NAMD(10),BASE(2),EFP(3),EFT(25,2),ETR(3),GHOST(13),
     1  IBL(10,10),IDMG(10),IGAL(10,10),IPQ(10,10),JGAL(10,10),LETR(13),
     1  IPROB1(10),RAD(9),STARS(9,2),TORPS(30,4),XKL(9,9),XROM(9,4)
      DOUBLE PRECISION NAMD
      COMMON/SCALAR/ACCE,DCHG,DDEG,DECR,DEFL,DELTA,DELV,DGIMP,DGKL,DGWP,
     1  DISTGT,DISTKR,DISTPE,DISTPK,DIV1,DIV2,DMXSPD,DSP,DSPKL,DVEL,
     1  DVIMP,DVWP,EEVMSP,EIMP,ENERGY,ERPRRT,ESDIST,ETVEL,EVENU,EVMSP,
     1  EWRP,FDATE,GHEMX,GHTMX,IBASE,ICE,IDOCK,IETOFT,IGH,IHERE,IHWARP,
     1  ISTART,ITFCTR,ITFIRE,ITORP,ITRUCE,IZZ,JCE,KLNGNS,XKTIME,
     1  LEFTK,LEFTR,MAXBQ,MAXK,MAXKQ,MAXR,MAXRQ,MAXSQ,MEN,MINK,MINR,
     1  MROM,MULTK1,MULTK2,NBASES,NKL,NMEN,NROM,NSTARS,NSTEPS,NTORPS,
     1  NTSTPS,NTRP,PCTCOL,PDEG,PNRGY,PRGH,PRKLN,PRREEN,PSP,PTRGH,
     1  RADEGC,REEN,RPRKL,RPRRM,RTIME,RTV,SDATE,SENRGY,
     1  SIM,TFACTR,THITR,TNRGY,TPMIN,TPOWR,VMXKL,VRKL,XDDEG,XDSP,XGHIT,
     1  XKFPE,XKFPST,XKLHIT,XRFTS,XRMHIT,XQE,XTIME,XTRTM,YQE,ZMIN,
     1  PRORAS,RADEK,RADEG,RADER,RADEB,RADET,RADKR,RADKG,RADKB,RADKT,
     1  RADKK,RADGB,RADGT,RAGGR,RADBT,RADTT,RADTR,RADES,RADSS
      COMMON/SUBCTL/ICNTL(20),RTBRG(5),KTO,LTO,KBRG,XWRP,
     1  ISTAT,IDAMRP,SDEF,IMSG,SKDLAY,SRDLY,GHVMX,MXCRGH,GHPHEN,
     1  DSPGH,DGGH,RPRGH,NHELP,NHELPS,XHELP
      COMMON/TBEAMS/IFGHTM,ITRMEN(20),JUP,JFROM,IBMEN,JDOWN,JTO,IBMENR,
     1  SBMNR,CREWR(9),SCREWR,CREWK,CODDS,DODDS,EODDS,FODDS
      COMMON/SHUTL/SHX,SHY,SHDEG,SHVX,ISTSH,ISHD,IFNDS(9),IDSES,VDSES,
     1  VSTRDS,VSTRM,PRXSH,VDSESM,ISHNUM
      COMMON/EXTRAS/SNOVAP,ZMAX,ICLOAK,PRCLDN,PHOLE,IHOLE,JHOLE,HOLRAD,
     1  SHLDF,NQUAD,PSTORM,ISTORM,JSTORM,STMRAD,LEVEL,ION,IYES,CMIN,
     1  CPOWR
      COMMON/LOCAL/ITBEAM,ISCAN,ITDK,JSCAN,JMSG,TRNRGY,IISTAT,JJSTAT,
     1  JJUP,JJFROM,JJTO,JJDOWN
      COMMON/TRNSFR/ICM,IDIR,MTORPS,DTORP(30),IBTYP,IEVDR,ADDFL,ITRSTP,
     1  KFROM,MTO,LUP,LDOWN,IFROM,ITO,JSCHM,ISHSTR(10),JDAM,
     1  IPROB2(10),NGHTFP
      COMMON/FORGOT/GHACCE,PJAM,PJMINC,ACTPJM,PPHASD,PTORPD,PDRVD,
     1  PDEFD,IGHPH,IGHTR,IGHDR,IGHDE
      COMMON/ZEROS/DVWP0,EWRP0,DISTP0,IETOF0,DISTG0,CODDS0,
     1  EODDS0,IDAMR0,PJAM0,ETVEL0,SHLDF0,TRNRG0
      DOUBLE PRECISION RANKS(2,14),MNAME,MPASS,MOLDNM,NOLDNM,
     1  ISTATS(2),IST
      COMMON/RANK/RANKS,MNAME,MPASS,POINTS,RANKPT(14),NRANKS,IRANK,NRW,
     1  MMKEY,NTIME,IOK,NHOLD,ICLKON,NSW,ISTATS
      COMMON/FILVAR/IV
      COMMON/GRAPH/IGRAPH,NOLINE
      DATA MZERO/0/
C     ...RESTART GAME IF NOT PRIME TIME.
      GO TO(62001,62002,64003),NN
62001 IOK=0
      READ(3'MMKEY)MNAME,POINTS,MPASS,X1,X2,X3,((JGAL(I,J),
     1  IGAL(I,J),IBL(I,J),I=1,10),J=1,10),LEFTK,LEFTR
      IF(LEFTK.EQ.0.AND.LEFTR.EQ.0)GO TO 62012
      CALL QTIME(NTIME)
      CALL QDATE(NDATE)
      IYR=NDATE/1000
      IDAY=NDATE-IYR*1000
      ISTYR=77
      IDIFF=IYR-ISTYR
      ISEVEN=7
      ITOT=IDIFF/4
      ITOT=ITOT+IDIFF+IDAY-1
      ITOT=MOD(ITOT,ISEVEN)
      ITOT=ITOT+1
      IF(ITOT.EQ.1.OR.ITOT.EQ.2)GO TO 62007
      IF(ITOT.EQ.7.AND.NTIME.GE.54000)GO TO 62007
      READ(3'1,ERR=62010)X1,X2,X3,X4,X5,NHOL1,NHOL2
      IF(NDATE.EQ.NHOL1.OR.NDATE.EQ.NHOL2)GO TO 62007
      IF(NTIME.GE.28800.AND.NTIME.LT.42300)GO TO 62008
      IF(NTIME.GE.46800.AND.NTIME.LT.61200)GO TO 62008
      GO TO 62011
62007 IOK=1
62011 CALL BPAGE(NOLINE)
      WRITE(6,62003)
62003 FORMAT(' RESTART FROM SAVED GAME.')
      READ(3'MMKEY)MNAME,POINTS,MPASS,X1,X2,MAXBQ,((JGAL(I,J),
     1  IGAL(I,J),IBL(I,J),I=1,10),J=1,10),LEFTK,LEFTR,NKL,MROM,XTIME,
     1  TRATE,RTIME,SDATE,ENERGY,ITORP,MEN,ITRMEN(1),DVWP,EWRP,DISTPE,
     1  ETVEL,IETOFT,DISTGT,CODDS,EODDS,IDAMRP,TRNRGY,PJAM,SHLDF,ICLOAK,
     1  ISHNUM,LEVEL,NQUAD,ITFCTR,NTSTPS,DVWP0,EWRP0,DISTP0,ETVEL0,
     1  IETOF0,DISTG0,CODDS0,EODDS0,IDAMR0,SHLDF0,TRNRG0,PJAM0,JCE,ICE,
     1  IRANK
      IRST=2
      WRITE(3'MMKEY)MNAME,POINTS,MPASS,X1,X2,IRST,((JGAL(I,J),
     1  IGAL(I,J),IBL(I,J),I=1,10),J=1,10),LEFTK,LEFTR,NKL,MROM,XTIME,
     1  TRATE,RTIME,SDATE,ENERGY,ITORP,MEN,ITRMEN(1),DVWP,EWRP,DISTPE,
     1  ETVEL,IETOFT,DISTGT,CODDS,EODDS,IDAMRP,TRNRGY,PJAM,SHLDF,ICLOAK,
     1  ISHNUM,LEVEL,NQUAD,ITFCTR,NTSTPS,DVWP0,EWRP0,DISTP0,ETVEL0,
     1  IETOF0,DISTG0,CODDS0,EODDS0,IDAMR0,SHLDF0,TRNRG0,PJAM0,JCE,ICE,
     1  IRANK
      WRITE(9'1)MNAME,POINTS,MPASS,MMKEY,IOK
      IF(LEVEL-2)63001,63002,63003
63001 MAXKQ=3
      MAXRQ=3
      MINK=3
      MINR=3
      ICLOAK=0
      PHOLE=0.
      SNOVAP=0.
      GO TO 63003
63002 ICLOAK=0
      PHOLE=0.
      SNOVAP=0.
63003 DO 62005 I=2,20
      ITRMEN(I)=0
      ICNTL(I)=0
62005 CONTINUE
      ISTSH=0
      ISHD=0
C     ...ZERO DAMAGE ARRAY
      DO 62006  I=1,10
      IF(I.EQ.10)GO TO 62006
      IFNDS(I)=0
62006 IDMG(I)=0
      IX=RAN(IZZ)*10.+1.
      IY=RAN(IZZ)*10.+1.
      XQE=IX
      YQE=IY
      DEFL=0.
C     ...START WITH SHORT RANGE SCAN
      IDOCK=3
      PNRGY=0.
      IHWARP=0
      DDEG=0.
      PDEG=0.
      DSP=0.
      PSP=0.
      ITRUCE=0
      ITRSTP=0
      ITFIRE=0
      IHERE=0
      KLNGNS=0
      NROM=0
      NRW=1
      CALL SCAN
      RETURN
62008 WRITE(6,62009)
62009 FORMAT(' CANNOT RESTART GAME DURING PRIME TIME.')
62010 STOP
62012 IRST=0
      WRITE(3'MMKEY)MNAME,POINTS,MPASS,X1,X2,IRST
      RETURN
C     ...SAVE GAME - CAN'T PLAY ANOTHER UNTIL THIS ONE FINISHED
62002 WRITE(6,62004)
62004 FORMAT(' GAME WILL BE AUTOMATICALLY RESTARTED AT NEXT PLAYING.')
      READ(3'MMKEY)MNAME,POINTS,MPASS,X1,X2
      WRITE(3'MMKEY)MNAME,POINTS,MPASS,X1,X2,MAXBQ,((JGAL(I,J),
     1  IGAL(I,J),IBL(I,J),I=1,10),J=1,10),LEFTK,LEFTR,NKL,MROM,XTIME,
     1  TRATE,RTIME,SDATE,ENERGY,ITORP,MEN,ITRMEN(1),DVWP,EWRP,DISTPE,
     1  ETVEL,IETOFT,DISTGT,CODDS,EODDS,IDAMRP,TRNRGY,PJAM,SHLDF,ICLOAK,
     1  ISHNUM,LEVEL,NQUAD,ITFCTR,NTSTPS,DVWP0,EWRP0,DISTP0,ETVEL0,
     1  IETOF0,DISTG0,CODDS0,EODDS0,IDAMR0,SHLDF0,TRNRG0,PJAM0,JCE,ICE,
     1  IRANK
      WRITE(9'1)MNAME,POINTS,MPASS,MZERO,MZERO
      STOP
64003 READ(3'MMKEY)MNAME,POINTS,MPASS,X1,X2,X3
      WRITE(3'MMKEY)MNAME,POINTS,MPASS,X1,X2,X3,((JGAL(I,J),
     1  IGAL(I,J),IBL(I,J),I=1,10),J=1,10),LEFTK,LEFTR,NKL,MROM,XTIME,
     1  TRATE,RTIME,SDATE,ENERGY,ITORP,MEN,ITRMEN(1),DVWP,EWRP,DISTPE,
     1  ETVEL,IETOFT,DISTGT,CODDS,EODDS,IDAMRP,TRNRGY,PJAM,SHLDF,ICLOAK,
     1  ISHNUM,LEVEL,NQUAD,ITFCTR,NTSTPS,DVWP0,EWRP0,DISTP0,ETVEL0,
     1  IETOF0,DISTG0,CODDS0,EODDS0,IDAMR0,SHLDF0,TRNRG0,PJAM0,JCE,ICE,
     1  IRANK
      RETURN
      END
      SUBROUTINE SCAN
      COMMON/ARRAYS/NAMD(10),BASE(2),EFP(3),EFT(25,2),ETR(3),GHOST(13),
     1  IBL(10,10),IDMG(10),IGAL(10,10),IPQ(10,10),JGAL(10,10),LETR(13),
     1  IPROB1(10),RAD(9),STARS(9,2),TORPS(30,4),XKL(9,9),XROM(9,4)
      DOUBLE PRECISION NAMD
      COMMON/SCALAR/ACCE,DCHG,DDEG,DECR,DEFL,DELTA,DELV,DGIMP,DGKL,DGWP,
     1  DISTGT,DISTKR,DISTPE,DISTPK,DIV1,DIV2,DMXSPD,DSP,DSPKL,DVEL,
     1  DVIMP,DVWP,EEVMSP,EIMP,ENERGY,ERPRRT,ESDIST,ETVEL,EVENU,EVMSP,
     1  EWRP,FDATE,GHEMX,GHTMX,IBASE,ICE,IDOCK,IETOFT,IGH,IHERE,IHWARP,
     1  ISTART,ITFCTR,ITFIRE,ITORP,ITRUCE,IZZ,JCE,KLNGNS,XKTIME,
     1  LEFTK,LEFTR,MAXBQ,MAXK,MAXKQ,MAXR,MAXRQ,MAXSQ,MEN,MINK,MINR,
     1  MROM,MULTK1,MULTK2,NBASES,NKL,NMEN,NROM,NSTARS,NSTEPS,NTORPS,
     1  NTSTPS,NTRP,PCTCOL,PDEG,PNRGY,PRGH,PRKLN,PRREEN,PSP,PTRGH,
     1  RADEGC,REEN,RPRKL,RPRRM,RTIME,RTV,SDATE,SENRGY,
     1  SIM,TFACTR,THITR,TNRGY,TPMIN,TPOWR,VMXKL,VRKL,XDDEG,XDSP,XGHIT,
     1  XKFPE,XKFPST,XKLHIT,XRFTS,XRMHIT,XQE,XTIME,XTRTM,YQE,ZMIN,
     1  PRORAS,RADEK,RADEG,RADER,RADEB,RADET,RADKR,RADKG,RADKB,RADKT,
     1  RADKK,RADGB,RADGT,RAGGR,RADBT,RADTT,RADTR,RADES,RADSS
      COMMON/TBEAMS/IFGHTM,ITRMEN(20),JUP,JFROM,IBMEN,JDOWN,JTO,IBMENR,
     1  SBMNR,CREWR(9),SCREWR,CREWK,CODDS,DODDS,EODDS,FODDS
      COMMON/SUBCTL/ICNTL(20),RTBRG(5),KTO,LTO,KBRG,XWRP,
     1  ISTAT,IDAMRP,SDEF,IMSG,SKDLAY,SRDLY,GHVMX,MXCRGH,GHPHEN,
     1  DSPGH,DGGH,RPRGH,NHELP,NHELPS,XHELP
      COMMON/FORGOT/GHACCE,PJAM,PJMINC,ACTPJM,PPHASD,PTORPD,PDRVD,
     1  PDEFD,IGHPH,IGHTR,IGHDR,IGHDE
      COMMON/SHUTL/SHX,SHY,SHDEG,SHVX,ISTSH,ISHD,IFNDS(9),IDSES,VDSES,
     1  VSTRDS,VSTRM,PRXSH,VDSESM,ISHNUM
      COMMON/EXTRAS/SNOVAP,ZMAX,ICLOAK,PRCLDN,PHOLE,IHOLE,JHOLE,HOLRAD,
     1  SHLDF,NQUAD,PSTORM,ISTORM,JSTORM,STMRAD,LEVEL,ION,IYES,CMIN,
     1  CPOWR
      COMMON/ATTACK/ITKL(18),JTKL(18)
      COMMON/TRNSFR/ICM,IDIR,MTORPS,DTORP(30),IBTYP,IEVDR,ADDFL,ITRSTP,
     1  KFROM,MTO,LUP,LDOWN,IFROM,ITO,JSCHM,ISHSTR(10),JDAM,
     1  IPROB2(10),NGHTFP
      DOUBLE PRECISION JCOND(4)
      DIMENSION IBAD(100,2),NUMS(9),JPQ(10,10) ,ILET(2)
      DATA JCOND/'GREEN','YELLOW','ORANGE',' RED'/
      DATA NUMS/'1','2','3','4','5','6','7','8','9'/
      DATA ILET/'+','-'/
      DO 100   I=1,10
      DO 100    J=1,10
      JPQ(I,J)=LETR(9)
100   IPQ(I,J)=LETR(8)
      IF(IHERE.EQ.2)GO TO 1001
      IF(IDMG(6).GT.0)GO TO 105
C     CALL CPAGE
      WRITE(6,1)ICE,JCE
1     FORMAT(' SHORT RANGE SENSOR SCAN FOR QUADRANT ',I2,',',I2 )
C     ...CALCULATE CURRENT RATING AND TIME RATIO.
      R=LEFTK+LEFTR
      S=NKL+MROM
      IR=(S-R)/S*1000.
      TRATE=XTIME/R
      KP=1
      IPLUSM=(TRATE-RTIME)/RTIME*100.
      IF(IPLUSM.LT.0)KP=2
      IPLUSM=IABS(IPLUSM)
      WRITE(6,21)
105   IF(IHERE.GE.1)GO TO 1000
C     ...RESET ARRAYS TO LOSE THINGS LEFT BEHIND.
9876  ETR(1)=0.
      EFP(1)=0.
      EFT(1,1)=0.
      ITORP=ITORP+ITFIRE
      ITFIRE=0
      DO 2017 J=1,18
      ITKL(J)=0
2017  JTKL(J)=0
      ACTPJM=PJAM
      IF(ISTSH.EQ.0)GO TO 9873
      ISTSH=0
      ISHD=0
      ISHNUM=ISHNUM-1
9873  DO 9872 J=1,9
9872  IFNDS(J)=0
      DO 9889 J=1,10
9889  ISHSTR(J)=0
      DO 9875 J=2,20
      ICNTL(J)=0
9875  ITRMEN(J)=0
      IF(ISTAT.NE.0)ISTAT=9999
      DO 9874 J=1,30
9874  TORPS(J,1)=0.
      IF(ICLOAK.LT.0.AND.ION.EQ.1)GO TO 4646
      IX=XQE+.5
      IY=YQE+.5
      IPQ(IX,IY)=LETR(2)
4646  IF(IDMG(6).EQ.0.OR.IDMG(7).EQ.0) IGAL(ICE,JCE)=JGAL(ICE,JCE)
C     ...GET CONTENTS FROM JGAL
      ICNTNT=JGAL(ICE,JCE)
      NROM=ICNTNT/1000
      KLNGNS=ICNTNT/100-NROM*10
      IBASE=(ICNTNT-ICNTNT/100*100)/10
      NSTARS=ICNTNT-ICNTNT/10*10
      NTORPS=0
      IGH=0
      IF(RAN(IZZ).LE.PRGH)IGH=1
      IF(ICLOAK.EQ.2)ICLOAK=1
      NBAD=0
C     ...EVERYTHING STARTS ON INTEGRAL COORDINATES
C     ...FLAG THOSE POINTS TOO NEAR TO E TO PUT OBJECTS.
      DO 200    I=1,10
      DO 200    J=1,10
      DIST=(I-XQE)**2+(J-YQE)**2
      IF(SQRT(DIST).GT.ESDIST)GO TO 200
      NBAD=NBAD+1
      IBAD(NBAD,1)=I
      IBAD(NBAD,2)=J
200   CONTINUE
      IHOLE=0
      IF(IBL(ICE,JCE).EQ.0)GO TO 9877
      CALL PUTIN(IHOLE,JHOLE,NBAD,IBAD,LETR(9))
9877  ISTORM=0
      IF(LEVEL.NE.3)GO TO 9879
      PSTORM=(NSTARS**3)/1000.
      IF(RAN(IZZ).GT.PSTORM)GO TO 9879
      CALL PUTIN(ISTORM,JSTORM,NBAD,IBAD,LETR(8))
6534  FORMAT(' WARNING - NUCLEONIC DISTURBANCES SIGHTED IN QUADRANT.')
C     ...PUT THINGS IN. NO TWO OBJECTS IN SAME PLACE.
9879  IF(KLNGNS.EQ.0)GO TO 300
      DO 110    I=1,KLNGNS
      CALL PUTIN(IX,IY,NBAD,IBAD,LETR(3))
      JPQ(IX,IY)=NUMS(I)
      XKL(I,1)=IX
      XKL(I,2)=IY
      XKL(I,3)=0.
      XKL(I,4)=0.
      XKL(I,5)=0.
      XKL(I,6)=0.
      IX=RAN(IZZ)*XKFPST+NTSTPS+1
      XKL(I,8)=IX
      XKL(I,7)=0.
C     ...RANDOM K CREW STRENGTH AROUND MEAN.
      IX=CREWK   +SIGN(RAN(IZZ)*25.,.5-RAN(IZZ))
      XKL(I,9)=IX
110   CONTINUE
300   IF(NROM.EQ.0)GO TO 150
      JUMP=1
      IF(ICLOAK.EQ.1.AND.RAN(IZZ).LE.PRCLDN)JUMP=2
      DO 310    I=1,NROM
      CALL PUTIN(IX,IY,NBAD,IBAD,LETR(4))
      IF(I.NE.1)GO TO 33305
      IF(JUMP.EQ.2)GO TO 33307
33305 SCR=SCREWR
      JPQ(IX,IY)=NUMS(I)
      GO TO 33308
33307 SCR=SCREWR*1.33
      IPQ(IX,IY)=LETR(8)
      ICLOAK=2
33308 XROM(I,1)=IX
      XROM(I,2)=IY
      XROM(I,3)=0.
C     ...RANDOM R CREW STRENGTH AROUND MEAN.
      IX=SCR+SIGN(RAN(IZZ)*35.,.5-RAN(IZZ))
      CREWR(I)=IX
      IX=RAN(IZZ)*XRFTS+NTSTPS
      XROM(I,4)=IX
310   CONTINUE
150   IF(NSTARS.EQ.0)GO TO 170
      DO 160 I=1,NSTARS
      CALL PUTIN(IX,IY,NBAD,IBAD,LETR(1))
      JPQ(IX,IY)=NUMS(I)
      STARS(I,1)=IX
      STARS(I,2)=IY
      RAD(I)=RAN(IZZ)*.75+.25
160   CONTINUE
170   IF(IGH.EQ.0)GO TO 180
      CALL PUTIN(IX,IY,NBAD,IBAD,LETR(5))
      GHOST(1)=IX
      GHOST(2)=IY
      GHOST(3)=0.
      GHOST(4)=RAN(IZZ)*GHVMX
      GHOST(6)=GHOST(4)
      GHOST(5)=RAN(IZZ)*360.
      GHOST(7)=GHOST(5)
      GHOST(8)=0.
      GHOST(9)=0.
      GHOST(10)=0.
      GHOST(11)=RAN(IZZ)*GHEMX
      IX=RAN(IZZ)*GHTMX+1.
      GHOST(12)=IX
      GHOST(13)=0.
      IGHPH=1
      IF(RAN(IZZ).LE.PPHASD)IGHPH=0
      IGHTR=1
      IF(RAN(IZZ).LE.PTORPD)IGHTR=0
      IGHDR=1
      IF(RAN(IZZ).LE.PDRVD)IGHDR=0
      IGHDE=1
      IF(RAN(IZZ).LE.PDEFD)IGHDE=0
180   IF(IBASE.EQ.0)GO TO 1900
      IF(IDOCK.EQ.3)GO TO 1800
      CALL PUTIN(IX,IY,NBAD,IBAD,LETR(6))
      BASE(1)=IX
      BASE(2)=IY
      MAXRQ=0
      IBMENR=RAN(IZZ)*SBMNR
      GO TO 1900
1800  BASE(1)=XQE
      BASE(2)=YQE
      IPQ(XQE,YQE)=LETR(6)
      MAXRQ=0
      IBMENR=0
      IDOCK=2
      GO TO 1900
1000  IF(IDMG(6).GT.0)RETURN
C     ...ALREADY HERE. PUT THINGS IN THEIR PLACE ACCORDING TO PROPER
C     ...HIERARCHY.
1001  IF(ISTSH.NE.99)GO TO 1010
      IX=SHX+.5
      IY=SHY+.5
      IPQ(IX,IY)=LETR(12)
C     ...TO SET UP IPQ FOR PRINTING QUAD IF ALREADY GENERATED.
1010  IF(NTORPS.EQ.0)GO TO 1100
      DO 1050      I=1,NTORPS
      IF(TORPS(I,1).EQ.0.)GO TO 1050
      IX=TORPS(I,1)+.5
      IY=TORPS(I,2)+.5
      IPQ(IX,IY)=LETR(7)
1050  CONTINUE
      GO TO 1100
1300  IF(IBASE.EQ.0)GOTO 1200
      IX=BASE(1)
      IY=BASE(2)
      IPQ(IX,IY)=LETR(6)
1200  IF(IGH.EQ.0)GO TO 1550
      IX=GHOST(1)   +.5
      IY=GHOST(2)   +.5
      IPQ(IX,IY)=LETR(5)
      GO TO 1550
1500  IF(NROM.EQ.0)GOTO 1400
      DO 1350    I=1,NROM
      IF(XROM(I,1).EQ.0.)GO TO 1350
      IF(ICLOAK.EQ.2.AND.IHERE.NE.2.AND.I.EQ.1)GO TO 1350
      IX=XROM(I,1)
      IY=XROM(I,2)
      IPQ(IX,IY)=LETR(4)
      JPQ(IX,IY)=NUMS(I)
1350  CONTINUE
1400  IF(KLNGNS.EQ.0)GO TO 1900
      DO 1450  I=1,KLNGNS
      IF(XKL(I,1).EQ.0.)GO TO 1450
      IX=XKL(I,1)+.5
      IY=XKL(I,2)+.5
      IPQ(IX,IY)=LETR(3)
      JPQ(IX,IY)=NUMS(I)
1450  CONTINUE
      GO TO 1900
1100  IX=XQE+.5
      IY=YQE+.5
      IF(ICLOAK.LT.0.AND.ION.EQ.1)GO TO 1300
      IPQ(IX,IY)=LETR(2)
      GO TO 1300
1550  IF(NSTARS.EQ.0)GO TO 1500
      DO 1600 I=1,NSTARS
      IF(STARS(I,1).EQ.0.)GO TO 1600
      IX=STARS(I,1)
      IY=STARS(I,2)
      IPQ(IX,IY)=LETR(1)
      JPQ(IX,IY)=NUMS(I)
1600  CONTINUE
      GO TO 1500
C     ...PRINTOUT AREA.
1900  ICOND=1
      IF(IDMG(6).GT.0)RETURN
      IF(IHERE.EQ.2)RETURN
      IGAL(ICE,JCE)=JGAL(ICE,JCE)
      IF(ENERGY.LE.500.)ICOND=2
      IF(NROM+KLNGNS.EQ.0)GO TO 1950
      IF(KLNGNS.EQ.0)GO TO 1920
      DO 1910 J=1,KLNGNS
      IF(XKL(J,1).EQ.0..OR.ICNTL(J+1).EQ.1)GO TO 1910
      ICOND=3
      GO TO 1950
1910  CONTINUE
1920  IF(NROM.EQ.0)GO TO 1950
      DO 1930 J=1,NROM
      IF(XROM(J,1).EQ.0..OR.ICNTL(J+10).EQ.1)GO TO 1930
      ICOND=3
      GO TO 1950
1930  CONTINUE
1950  IF(IHOLE.EQ.0)GO TO 1975
      IPQ(IHOLE,JHOLE)=LETR(9)
1975  IF(ICOND.EQ.3.AND.DEFL.EQ.0.)ICOND=4
      WRITE(6,11)(IPQ(I,10),JPQ(I,10),I=1,10),SDATE,XTIME
      WRITE(6,12)(IPQ(I,9),JPQ(I,9),I=1,10),JCOND(ICOND)
      WRITE(6,13)(IPQ(I,8),JPQ(I,8),I=1,10),XQE,YQE
      WRITE(6,14)(IPQ(I,7),JPQ(I,7),I=1,10),ENERGY
      WRITE(6,15)(IPQ(I,6),JPQ(I,6),I=1,10) ,ITORP
      WRITE(6,16)(IPQ(I,5),JPQ(I,5),I=1,10),LEFTK   ,LEFTR
      WRITE(6,17)(IPQ(I,4),JPQ(I,4),I=1,10),MEN,ITRMEN(1)
      WRITE(6,18)(IPQ(I,3),JPQ(I,3),I=1,10),DEFL
      WRITE(6,19)(IPQ(I,2),JPQ(I,2),I=1,10),PDEG,PSP
      WRITE(6,20)(IPQ(I,1),JPQ(I,1),I=1,10),IR,TRATE,ILET(KP),IPLUSM
11    FORMAT(1X,20A1,5X,'STARDATE: ',F7.2,'  LEFT: ',F6.2)
12    FORMAT(1X,20A1,5X,'CONDITION: ',A10)
13    FORMAT(1X,20A1,5X,'SHIP POSITION: ',F4.1,',',F4.1)
14    FORMAT(1X,20A1,5X,'ENERGY: ',F8.2)
15    FORMAT(1X,20A1,5X,'TORPEDOS: ',I2)
16    FORMAT(1X,20A1,5X,'ENEMY LEFT(K,R): ',I3,',',I3)
17    FORMAT(1X,20A1,5X,'CREW: ',I4,' TROOPS: ',I4)
18    FORMAT(1X,20A1,5X,'DEFLECTOR POWER: ',F8.2)
19    FORMAT(1X,20A1,5X,'BEARING: ',F4.0,' SPEED: ',F5.3)
20    FORMAT(1X,20A1,5X,'RATING: ',I3,' TIME RATIO: ',F4.2,'(',A1,I3,'%)
     1')
      WRITE(6,21)
21    FORMAT(' ------------------------------')
      IF(KLNGNS+NROM.LT.9.OR.IHERE.NE.0)GO TO 99998
      WRITE(6,65310)
65310 FORMAT(' WELCOME TO THE CONVENTION! HEH, HEH, HEH...')
99998 IF(ISTORM.EQ.0.OR.IHERE.NE.0)GO TO 99999
      WRITE(6,6534)
99999 IF(IHERE.EQ.0)IHERE=1
      RETURN
      END
      FUNCTION SIND(X)
      Y=X*1.745E-2
      SIND=SIN(Y)
      RETURN
      END
      SUBROUTINE STAR81
      COMMON/ARRAYS/NAMD(10),BASE(2),EFP(3),EFT(25,2),ETR(3),GHOST(13),
     1  IBL(10,10),IDMG(10),IGAL(10,10),IPQ(10,10),JGAL(10,10),LETR(13),
     1  IPROB1(10),RAD(9),STARS(9,2),TORPS(30,4),XKL(9,9),XROM(9,4)
      DOUBLE PRECISION NAMD
      COMMON/SCALAR/ACCE,DCHG,DDEG,DECR,DEFL,DELTA,DELV,DGIMP,DGKL,DGWP,
     1  DISTGT,DISTKR,DISTPE,DISTPK,DIV1,DIV2,DMXSPD,DSP,DSPKL,DVEL,
     1  DVIMP,DVWP,EEVMSP,EIMP,ENERGY,ERPRRT,ESDIST,ETVEL,EVENU,EVMSP,
     1  EWRP,FDATE,GHEMX,GHTMX,IBASE,ICE,IDOCK,IETOFT,IGH,IHERE,IHWARP,
     1  ISTART,ITFCTR,ITFIRE,ITORP,ITRUCE,IZZ,JCE,KLNGNS,XKTIME,
     1  LEFTK,LEFTR,MAXBQ,MAXK,MAXKQ,MAXR,MAXRQ,MAXSQ,MEN,MINK,MINR,
     1  MROM,MULTK1,MULTK2,NBASES,NKL,NMEN,NROM,NSTARS,NSTEPS,NTORPS,
     1  NTSTPS,NTRP,PCTCOL,PDEG,PNRGY,PRGH,PRKLN,PRREEN,PSP,PTRGH,
     1  RADEGC,REEN,RPRKL,RPRRM,RTIME,RTV,SDATE,SENRGY,
     1  SIM,TFACTR,THITR,TNRGY,TPMIN,TPOWR,VMXKL,VRKL,XDDEG,XDSP,XGHIT,
     1  XKFPE,XKFPST,XKLHIT,XRFTS,XRMHIT,XQE,XTIME,XTRTM,YQE,ZMIN,
     1  PRORAS,RADEK,RADEG,RADER,RADEB,RADET,RADKR,RADKG,RADKB,RADKT,
     1  RADKK,RADGB,RADGT,RAGGR,RADBT,RADTT,RADTR,RADES,RADSS
      COMMON/TBEAMS/IFGHTM,ITRMEN(20),JUP,JFROM,IBMEN,JDOWN,JTO,IBMENR,
     1  SBMNR,CREWR(9),SCREWR,CREWK,CODDS,DODDS,EODDS,FODDS
      COMMON/SUBCTL/ICNTL(20),RTBRG(5),KTO,LTO,KBRG,XWRP,
     1  ISTAT,IDAMRP,SDEF,IMSG,SKDLAY,SRDLY,GHVMX,MXCRGH,GHPHEN,
     1  DSPGH,DGGH,RPRGH,NHELP,NHELPS,XHELP
      COMMON/TRNSFR/ICM,IDIR,MTORPS,DTORP(30),IBTYP,IEVDR,ADDFL,ITRSTP,
     1  KFROM,MTO,LUP,LDOWN,IFROM,ITO,JSCHM,ISHSTR(10),JDAM,
     1  IPROB2(10),NGHTFP
      COMMON/FORGOT/GHACCE,PJAM,PJMINC,ACTPJM,PPHASD,PTORPD,PDRVD,
     1  PDEFD,IGHPH,IGHTR,IGHDR,IGHDE
      COMMON/SHUTL/SHX,SHY,SHDEG,SHVX,ISTSH,ISHD,IFNDS(9),IDSES,VDSES,
     1  VSTRDS,VSTRM,PRXSH,VDSESM,ISHNUM
      COMMON/LOCAL/ITBEAM,ISCAN,ITDK,JSCAN,JMSG,TRNRGY,IISTAT,JJSTAT,
     1  JJUP,JJFROM,JJTO,JJDOWN
      COMMON/EXTRAS/SNOVAP,ZMAX,ICLOAK,PRCLDN,PHOLE,IHOLE,JHOLE,HOLRAD,
     1  SHLDF,NQUAD,PSTORM,ISTORM,JSTORM,STMRAD,LEVEL,ION,IYES,CMIN,
     1  CPOWR
      COMMON/ZEROS/DVWP0,EWRP0,DISTP0,IETOF0,DISTG0,CODDS0,
     1  EODDS0,IDAMR0,PJAM0,ETVEL0,SHLDF0,TRNRG0
      DOUBLE PRECISION RANKS(2,14),MNAME,MPASS,MOLDNM,NOLDNM,
     1  ISTATS(2),IST
      COMMON/RANK/RANKS,MNAME,MPASS,POINTS,RANKPT(14),NRANKS,IRANK,NRW,
     1  MMKEY,NTIME,IOK,NHOLD,ICLKON,NSW,ISTATS
      DOUBLE PRECISION NAMEX,PASSX,IDEMO
      COMMON/FILVAR/IV
      COMMON/GRAPH/IGRAPH,NOLINE
      DATA IDEMO,POINT/'DEMO    ',0./
      DEFINE FILE 3(50,2400,L,IV)
      DEFINE FILE 9(1,30,L,IV)
      IIIIII=RAN(IZZ)
C     ...SET USER LIMITS
5666  CALL CPAGE
      WRITE(6,1)
1     FORMAT(/      ' AT ANY POINT IN THE GAME WHERE INFORMATION IS REQU
     1IRED,'/' YOU MAY REQUEST A SHORT EXPLANATION BY TYPING "7777".'/'
     1GOOD LUCK!      YOU''LL NEED IT.')
5655  WRITE(6,77702)
77702 FORMAT(' ENTER YOUR LAST NAME:')
      READ(5,676,END=9680)NAMEX
      WRITE(6,77703)
77703 FORMAT(' ENTER YOUR PASSWORD:')
      READ(5,676,END=9680)PASSX
      IIKK=0
      MOLDNM=IYES
81818 IIKK=IIKK+1
      IIKKK=IIKK
      READ(3'IIKK,ERR=5666)MNAME,POINTS,MPASS,X6,X7,IRST
      IF(NAMEX.EQ.MNAME.AND.PASSX.EQ.MPASS)GO TO 71717
      IF(MOLDNM.EQ.MNAME)GO TO 9776
      MOLDNM=MNAME
      GO TO 81818
71717 MMKEY=IIKK
      IF(IRST.EQ.1)CALL RSTART(1)
      IF(IRST.EQ.1)RETURN
      IF(IRST.EQ.2)CALL RSTART(1)
      IF(IRST.EQ.2)READ(3'MMKEY,ERR=5666)MNAME,POINTS,MPASS,X6,X7,IRST
      IF(IRST.EQ.2)RETURN
      WRITE(6,77777)
77777 FORMAT(' DO YOU WANT TO CHANGE YOUR PASSWORD (Y OR N)?')
      READ(5,6,ERR=5666,END=9680)IIIII
      IF(IIIII.NE.IYES)GO TO 5654
      WRITE(6,77888)
77888 FORMAT(' ENTER NEW PASSWORD:')
      READ(5,676,END=9680)PASSX
      IF(PASSX.EQ.IDEMO.AND.MNAME.EQ.IDEMO)GO TO 77779
      IF(MNAME.EQ.IDEMO)GO TO 5654
      MPASS=PASSX
5654  IRST=2
      WRITE(3'MMKEY)MNAME,POINTS,MPASS,X6,X7,IRST
      GO TO 77714
77779 IRST=2
      WRITE(3'MMKEY)MNAME,POINTS,MPASS,X6,X7,IRST
65656 WRITE(6,77780)
77780 FORMAT(' DO YOU WANT TO ADD A NAME TO THE FILE (Y OR N)?')
      READ(5,6,ERR=5666,END=9680)IIIII
      IF(IIIII.NE.IYES)GO TO 77789
      WRITE(6,77781)
77781 FORMAT(' ENTER THE LAST NAME:')
      READ(5,676,END=9680)NAMEX
676   FORMAT(A8)
      WRITE(6,77783)
77783 FORMAT(' ENTER THE PASSWORD:')
      READ(5,676,END=9680)PASSX
      IIKK=0
      MOLDNM=IYES
77784 IIKK=IIKK+1
      READ(3'IIKK,ERR=5666)MNAME,POINTS,MPASS,X6,X7
      IF(MNAME.EQ.MOLDNM)GO TO 77785
      MOLDNM=MNAME
      GO TO 77784
77785 WRITE(3'IIKK)NAMEX,POINT,PASSX,X6,X7
      WRITE(6,77786)NAMEX,PASSX
77786 FORMAT(' INDUCTEE ',A8,' HAS BEEN ADDED.  PASSWORD = ',A8)
      IIKK=IIKK+1
      WRITE(3'IIKK)NAMEX,POINT,MPASS,X6,X7
      GO TO 65656
77789 WRITE(6,77790)
77790 FORMAT(' DO YOU WANT TO DISPLAY A NAME ON THE FILE (Y OR N)?')
      READ(5,6,ERR=5666,END=9680)IIIII
      IF(IIIII.NE.IYES)GO TO 88889
      WRITE(6,77791)
77791 FORMAT(' ENTER THE LAST NAME:')
      READ(5,676,END=9680)NAMEX
      IIKK=0
      MOLDNM=IYES
      NOLDNM=NAMEX
77794 IIKK=IIKK+1
      READ(3'IIKK,ERR=5666)NAMEX,X,PASSX,X6,X7,IRST
      IF(NAMEX.EQ.NOLDNM)GO TO 77795
      IF(NAMEX.EQ.MOLDNM)GO TO 77798
      MOLDNM=NAMEX
      GO TO 77794
77795 WRITE(3'IIKK)NAMEX,X,PASSX,X6,X7,IRST
      IF(IRST.EQ.0)GO TO 55596
      IF(IRST.EQ.1)IST=ISTATS(1)
      IF(IRST.EQ.2)IST=ISTATS(2)
      WRITE(6,77796)NAMEX,PASSX,IST
77796 FORMAT(1X,A8,' IS ON THE FILE.  PASSWORD = ',A8,' GAME ',A8)
      GO TO 77789
55596 WRITE(6,55597)NAMEX,PASSX
55597 FORMAT(1X,A8,' IS ON THE FILE.  PASSWORD = ',A8)
      GO TO 77789
77798 WRITE(6,77797)NOLDNM
77797 FORMAT(1X,A8,' IS NOT ON THE FILE.')
      GO TO 77789
88889 WRITE(6,77740)
77740 FORMAT(' DO YOU WANT TO ADD A HOLIDAY (Y OR N)?')
      READ(5,6,ERR=5666,END=9680)IIIII
      IF(IIIII.NE.IYES)GO TO 77714
      WRITE(6,77741)
77741 FORMAT(' ENTER THE NEXT TWO HOLIDAYS:')
      READ(5,*,END=9680)NHOL1,NHOL2
      READ(3'1,ERR=5666)X1,X2,X3,X4,X5,X6,X7,X8
      WRITE(3'1)X1,X2,X3,X4,X5,NHOL1,NHOL2,X8
77714 READ(3'MMKEY,ERR=5666)MNAME,POINTS,MPASS,X6,X7,IRST
      WRITE(3'MMKEY)MNAME,POINTS,MPASS,X6,X7,IRST
      IOK=0
      CALL QTIME(NTIME)
      CALL QDATE(NDATE)
      IYR=NDATE/1000
      IDAY=NDATE-IYR*1000
      ISTYR=77
      IDIFF=IYR-ISTYR
      ISEVEN=7
      ITOT=IDIFF/4
      ITOT=ITOT+IDIFF+IDAY-1
      ITOT=MOD(ITOT,ISEVEN)
      ITOT=ITOT+1
      IF(ITOT.EQ.1.OR.ITOT.EQ.2)GO TO 44400
      IF(ITOT.EQ.7.AND.NTIME.GE.54000)GO TO 44400
      READ(3'1,ERR=5666)X1,X2,X3,X4,X5,NHOL1,NHOL2
      IF(NDATE.EQ.NHOL1.OR.NDATE.EQ.NHOL2)GO TO 44400
      IF(NTIME.GE.28800.AND.NTIME.LT.42300)GO TO 5678
      IF(NTIME.GE.46800.AND.NTIME.LT.61200)GO TO 5678
      GO TO 44401
44400 IOK=1
44401 WRITE(6,677)
677   FORMAT(' DO YOU WANT THIS GAME RATED (Y OR N)?')
      READ(5,6,END=9680)IDUP
6     FORMAT(A1)
      IF(IDUP.NE.NHELPS)GO TO 779
      CALL HELP(58)
      GO TO 5654
779   IF(IDUP.NE.IYES)GO TO 5678
      NRW=1
      WRITE(9'1)MNAME,POINTS,MPASS,MMKEY,IRST,NRW
      IF(POINTS.NE.0.)GO TO 778
      IRANK=1
      GO TO 769
C     ...PRINT CURRENT STATUS OF PLAYER.
778   DO 772 I=1,NRANKS
      IF(RANKPT(I)-POINTS)772,771,773
771   IRANK=I
      GO TO 769
773   IRANK=I-1
      GO TO 769
772   CONTINUE
      IRANK=NRANKS
769   XNEED=RANKPT(IRANK+1)-POINTS
768   WRITE(6,668)RANKS(1,IRANK),RANKS(2,IRANK),MNAME
668   FORMAT(' WELCOME ON BOARD THE ENTERPRISE, ',2A8,2X,A8/      ' YOU
     1HAVE THE CON!')
      IF(IRANK.EQ.NRANKS)GO TO 5678
      WRITE(6,675)XNEED,RANKS(1,IRANK+1),RANKS(2,IRANK+1)
675   FORMAT(' YOU NEED ',F5.2,' POINTS TO REACH THE RANK OF ',2A8)
5678  IF(NRW.EQ.0)WRITE(9'1)MNAME,POINTS,MPASS,MMKEY,NRW
      WRITE(6,5656)
5656  FORMAT(' ENTER GAME LEVEL DESIRED.')
      READ(5,*,ERR=800,END=9680)LEVEL
      IF(LEVEL.EQ.XHELP)GO TO 800
      IF(LEVEL.LE.0.OR.LEVEL.GT.3)GO TO 800
11111 WRITE(6,5657)
5657  FORMAT(' ENTER GALACTIC DIMENSIONS.')
      READ(5,*,ERR=801,END=9680)NQUAD
      IF(NQUAD.EQ.XHELP)GO TO 801
      IF(NQUAD.LT.2.OR.NQUAD.GT.10)GO TO 801
      MMAX=NQUAD*NQUAD*2-2
      NMAX=400/(NQUAD*NQUAD)
      IF(LEVEL-2)200,300,400
200   MAXKQ=3
      MAXRQ=3
      MINK=3
      MINR=3
      ICLOAK=0
      PHOLE=0.
      SNOVAP=0.
      GO TO 500
300   ICLOAK=0
      PHOLE=0.
      SNOVAP=0.
      GO TO 500
400   ICLOAK=1
500   WRITE(6,77704)
77704 FORMAT(' MIMIMUM ENEMY VESSELS? ')
      READ(5,*,ERR=50,END=9680)MTOT
      IF(MTOT.EQ.XHELP)GO TO 50
      IF(MTOT.GT.MMAX)MTOT=MMAX
      NTOT=MIN0(MTOT,MMAX)
      NTOT=MAX0(NTOT,MINK+MINR)
      NTOT=NTOT+SIGN(.15*RAN(IZZ)*NTOT,.5-RAN(IZZ))
      NTOT=MIN0(NTOT,MMAX)
      NTOT=MAX0(NTOT,MINK+MINR)
      IF(NTOT.LT.MTOT)NTOT=MTOT
      NKL=NTOT*RAN(IZZ)
      IF(NKL.LE.0)NKL=1
      IF(NKL.GT.MAXK)NKL=MAXK
      IF(MROM.LE.MAXR)GO TO 82829
      MROM=MAXR
      NKL=NTOT-MROM
82829 MROM=NTOT-NKL
      NDIFF=MROM-NKL
      IF(NDIFF.LT.0)GO TO 82828
      IF(NDIFF.LE.25)GO TO 55
      NDIFF=NDIFF/2
      NKL=NKL+NDIFF
      MROM=MROM-NDIFF
      GO TO 82829
82828 NDIFF=NKL-MROM
      IF(NDIFF.LE.25)GO TO 55
      NDIFF=NDIFF/2
      NKL=NKL-NDIFF
      MROM=MROM+NDIFF
      GO TO 82829
55    WRITE(6,5)
5     FORMAT(' ENTER GAME SPEED 1 (FAST) TO 50 (SLOW)')
      READ(5,*,END=9680)ITFCTR
      IF(ITFCTR.LE.0)ITFCTR=1
      IF(ITFCTR.GT.50)ITFCTR=50
      WRITE(6,7)ITFCTR
7     FORMAT(' TIMING FACTOR = ',I3)
      NS=RAN(IZZ)*99.+1.
C     ...DETERMINE SETUP FOR THIS GAME
      SDATE=RAN(IZZ)*5000.+500.
      XTIME=NKL*XKTIME+MROM*RTIME
      XTIME=XTIME+SQRT(XTIME)*RAN(IZZ)
C     ...REUSE XKTIME AND RTIME.
      XKTIME=.2
      RTIME=XTIME/NTOT
      FDATE=SDATE+XTIME
      NBASES= SQRT(2.*FLOAT(NTOT))/NMAX+1.
      LEFTK=NKL
      LEFTR=MROM
C     ...OUTPUT STARTING CONDITIONS
      CALL CPAGE
      WRITE(6,3)SDATE,NS,NKL,MROM,NTOT,XTIME,FDATE
3     FORMAT(' SPACE, THE FINAL FRONTIER.'/      ' THIS IS A VOYAGE OF T
     1HE STARSHIP "ENTERPRISE".'/      ' ITS FIVE YEAR MISSION, TO EXPLO
     1RE STRANGE NEW WORLDS,'/      ' TO SEEK OUT NEW LIFE AND NEW CIVIL
     1IZATIONS,'/      ' TO BOLDLY GO WHERE NO MAN HAS GONE BEFORE! '
     1//      '                    S T A R   T R E K'/       '
     1             JULY  1981                      '/       '-----------
     1-------------------------------------------------'/        ' ORDER
     1S: STARDATE ',F7.2,'   STARFLEET COMMAND (TOP SECRET)'//      ' CO
     1MMUNICATIONS WITH SECTOR ',I2,' OF THE GALAXY WERE SUDDENLY'/
     1 ' CUT OFF A FEW STARDAYS AGO. THE LAST REPORT FROM THAT AREA'/
     1   ' WAS THAT A FLEET OF ',I3,' KLINGONS AND ' ,I3,' ROMULANS HAD'
     1/      ' INVADED AND DESTROYED EVERY FEDERATION SHIP IN THE AREA.'
     1/      ' YOUR MISSION, AS THE PRIDE OF THE FEDERATION STARFLEET,'/
     1      ' IS TO DESTROY THE ENTIRE ENEMY FORCE (',I3,' VESSELS).'/
     1    ' YOU HAVE ONLY ',F6.2,' STARDAYS TO ACCOMPLISH YOUR TASK, AS
     1THE'/      ' FEDERATION PRESIDENT''S REELECTION CAMPAIGN BEGINS ON
     1 STARDATE'/      F8.2,' AND, AS YOU WELL KNOW, HIS OPPONENT PROPOS
     1ES APPROPRIATIONS'/      ' CUTBACKS FOR THE SPACE ACADEMY AND ELIM
     1INATION OF THE '/      ' TRADITIONAL VULCAN BOWL GAME.'//)
      CALL BPAGE(NOLINE)
C     ...SET UP GALACTIC MAP(JGAL).
C     ...IGAL SET INITIALLY TO ALL -1S
99    DO 100    J=1,NQUAD
      DO 100    I=1,NQUAD
      IGAL(I,J)=-1
      JGAL(I,J)=RAN(IZZ)*MAXSQ
C     ...PUT IN BLACK HOLES AND WHERE THEY GO TO.
      IBL(I,J)=0
      IF(RAN(IZZ).GT.PHOLE)GO TO 100
95    ICE=RAN(IZZ)*NQUAD+1.
      JCE=RAN(IZZ)*NQUAD+1.
      IF(ICE.EQ.I.AND.JCE.EQ.J)GO TO 95
      IBL(I,J)=ICE*100+JCE
100   CONTINUE
C     ...PUT THINGS IN QUADRANTS
      CALL PLIN(NBASES,MAXBQ*10,10)
      CALL PLIN(NKL,MAXKQ*100,100)
      CALL PLIN(MROM,MAXRQ*1000,1000)
C     ...ENTERPRISE IN UNOCCUPIED QUADRANT
      MMAX=9999
      DO 110 I=1,NQUAD
      DO 110 J=1,NQUAD
      IF(JGAL(I,J).GE.MMAX)GO TO 110
      MMAX=JGAL(I,J)
      ICE=I
      JCE=J
      IF(MMAX.LE.99)GO TO 111
110   CONTINUE
      GO TO 99
111   CONTINUE
      JCPS=0
C     ...SETUP E
      ENERGY=SENRGY
      DO 9944 I=2,20
      ITRMEN(I)=0
      ICNTL(I)=0
9944  CONTINUE
      ITRMEN(1)=IFGHTM
      MEN=NMEN
      ITORP=NTRP
      ISTSH=0
      ISHD=0
C     ...ZERO DAMAGE ARRAY
      DO 995    I=1,10
      IF(I.EQ.10)GO TO 995
      IFNDS(I)=0
995   IDMG(I)=0
      IX=RAN(IZZ)*10.+1.
      IY=RAN(IZZ)*10.+1.
      XQE=IX
      YQE=IY
      DEFL=0.
C     ...START WITH SHORT RANGE SCAN
      IDOCK=0
      PNRGY=0.
      IHWARP=0
      DDEG=0.
      PDEG=0.
      DSP=0.
      PSP=0.
      ITRUCE=0
      ITRSTP=0
      ITFIRE=0
      IHERE=0
      ISCAN=0
      CALL SCAN
C     ...START TIMER. NTSTPS=TOTAL NO OF STEPS TO DATE
      NTSTPS=0
      DVWP0=DVWP
      EWRP0=EWRP
      DISTP0=DISTPE
      ETVEL0=ETVEL
      IETOF0=IETOFT
      DISTG0=DISTGT
      CODDS0=CODDS
      EODDS0=EODDS
      IDAMR0=IDAMRP
      SHLDF0=SHLDF
      TRNRG0=TRNRGY
      PJAM0=PJAM
      RETURN
800   CALL HELP(55)
      GO TO 5678
801   CALL HELP(56)
      GO TO 11111
50    CALL HELP(57)
      GO TO 500
9776  WRITE(6,9777)
9777  FORMAT(' SORRY, BUT YOU ARE NOT AUTHORIZED TO USE THIS PROGRAM.')
9680  STOP
      END
      SUBROUTINE STORM
      COMMON/ARRAYS/NAMD(10),BASE(2),EFP(3),EFT(25,2),ETR(3),GHOST(13),
     1  IBL(10,10),IDMG(10),IGAL(10,10),IPQ(10,10),JGAL(10,10),LETR(13),
     1  IPROB1(10),RAD(9),STARS(9,2),TORPS(30,4),XKL(9,9),XROM(9,4)
      DOUBLE PRECISION NAMD
      COMMON/SCALAR/ACCE,DCHG,DDEG,DECR,DEFL,DELTA,DELV,DGIMP,DGKL,DGWP,
     1  DISTGT,DISTKR,DISTPE,DISTPK,DIV1,DIV2,DMXSPD,DSP,DSPKL,DVEL,
     1  DVIMP,DVWP,EEVMSP,EIMP,ENERGY,ERPRRT,ESDIST,ETVEL,EVENU,EVMSP,
     1  EWRP,FDATE,GHEMX,GHTMX,IBASE,ICE,IDOCK,IETOFT,IGH,IHERE,IHWARP,
     1  ISTART,ITFCTR,ITFIRE,ITORP,ITRUCE,IZZ,JCE,KLNGNS,XKTIME,
     1  LEFTK,LEFTR,MAXBQ,MAXK,MAXKQ,MAXR,MAXRQ,MAXSQ,MEN,MINK,MINR,
     1  MROM,MULTK1,MULTK2,NBASES,NKL,NMEN,NROM,NSTARS,NSTEPS,NTORPS,
     1  NTSTPS,NTRP,PCTCOL,PDEG,PNRGY,PRGH,PRKLN,PRREEN,PSP,PTRGH,
     1  RADEGC,REEN,RPRKL,RPRRM,RTIME,RTV,SDATE,SENRGY,
     1  SIM,TFACTR,THITR,TNRGY,TPMIN,TPOWR,VMXKL,VRKL,XDDEG,XDSP,XGHIT,
     1  XKFPE,XKFPST,XKLHIT,XRFTS,XRMHIT,XQE,XTIME,XTRTM,YQE,ZMIN,
     1  PRORAS,RADEK,RADEG,RADER,RADEB,RADET,RADKR,RADKG,RADKB,RADKT,
     1  RADKK,RADGB,RADGT,RAGGR,RADBT,RADTT,RADTR,RADES,RADSS
      COMMON/SUBCTL/ICNTL(20),RTBRG(5),KTO,LTO,KBRG,XWRP,
     1  ISTAT,IDAMRP,SDEF,IMSG,SKDLAY,SRDLY,GHVMX,MXCRGH,GHPHEN,
     1  DSPGH,DGGH,RPRGH,NHELP,NHELPS,XHELP
      COMMON/EXTRAS/SNOVAP,ZMAX,ICLOAK,PRCLDN,PHOLE,IHOLE,JHOLE,HOLRAD,
     1  SHLDF,NQUAD,PSTORM,ISTORM,JSTORM,STMRAD,LEVEL,ION,IYES,CMIN,
     1  CPOWR
      COMMON/SHUTL/SHX,SHY,SHDEG,SHVX,ISTSH,ISHD,IFNDS(9),IDSES,VDSES,
     1  VSTRDS,VSTRM,PRXSH,VDSESM,ISHNUM
      X=ISTORM
      Y=JSTORM
C     ...E WITH STORM. BE SURE IT DOESN'T REAPPEAR NEAR STAR OR B.
      IF(RANGE(XQE,X,YQE,Y).GT.STMRAD)GO TO 200
50    XX=RAN(IZZ)*10.+.5
      YY=RAN(IZZ)*10.+.5
      IF(NSTARS.EQ.0)GO TO 150
      DO 100 J=1,NSTARS
      IF(STARS(J,1).EQ.0.)GO TO 100
      IF(RANGE(XX,STARS(J,1),YY,STARS(J,2)).LE.ESDIST)GO TO 50
100   CONTINUE
150   IF(IBASE.EQ.0)GO TO 175
      IF(RANGE(XX,BASE(1),YY,BASE(2)).LE.ESDIST)GO TO 50
175   P  SP=RAN(IZZ)
      PDEG=RAN(IZZ)*360.
      DSP=PSP
      DDEG=PDEG
      WRITE(6,1)LETR(2),XX,YY,PSP,PDEG
1     FORMAT(1X,A1,' CAUGHT IN STORM. MOVED TO: ',F4.1,',',F4.1/' SPEED:
     1 ',F5.3,'BEARING: ',F4.0)
      XQE=XX
      YQE=YY
C     ...K WITH STORM
200   IF(KLNGNS.EQ.0)GO TO 300
      DO 250 J=1,KLNGNS
      IF(XKL(J,1).EQ.0.)GO TO 250
      IF(RANGE(XKL(J,1),X,XKL(J,2),Y).GT.STMRAD)GO TO 250
      XKL(J,1)=RAN(IZZ)*10.+.5
      XKL(J,2)=RAN(IZZ)*10.+.5
      XKL(J,3)=RAN(IZZ)*VMXKL
      XKL(J,4)=RAN(IZZ)*360.
      XKL(J,5)=XKL(J,3)
      XKL(J,6)=XKL(J,4)
      IF(ICNTL(J+1).NE.1)GO TO 250
      WRITE(6,2)LETR(3),J,(XKL(J,K),K=1,4)
2     FORMAT(1X,A1,I1,' CAUGHT IN STORM. MOVED TO: ',F4.1,',',F4.1/' SPE
     1ED: ',F5.3,'BEARING: ',F4.0)
250   CONTINUE
C     ...G WITH STORM.
300   IF(IGH.EQ.0)GO TO 400
      IF(RANGE(GHOST(1),X,GHOST(2),Y).GT.STMRAD)GO TO 400
      GHOST(1)=RAN(IZZ)*10.+.5
      GHOST(2)=RAN(IZZ)*10.+.5
      GHOST(4)=RAN(IZZ)*GHVMX
      GHOST(5)=RAN(IZZ)*360.
      GHOST(6)=GHOST(4)
      GHOST(7)=GHOST(5)
      IF(ICNTL(20).NE.1)GO TO 400
      WRITE(6,1)LETR(5),GHOST(1),GHOST(2),GHOST(4),GHOST(5)
C     ...R WITH STORM.
400   IF(NROM.EQ.0)GO TO 500
      DO 450 J=1,NROM
      IF(XROM(J,1).EQ.0.)GO TO 450
      IF(XROM(J,1).NE.X.OR.XROM(J,2).NE.Y)GO TO 450
455   I  X=RAN(IZZ)*10.+1.
      IY=RAN(IZZ)*10.+1.
C     ...R CAN'T COME OUT ON *,B, OR OTHER R
      IF(NSTARS.EQ.0)GO TO 465
      DO 460 K=1,NSTARS
      IF(STARS(K,1).EQ.0.)GO TO 460
      IF(IX.EQ.STARS(K,1).AND.IY.EQ.STARS(K,2))GO TO 455
460   CONTINUE
465   IF(IBASE.EQ.0)GO TO 470
      IF(IX.EQ.BASE(1).AND.IY.EQ.BASE(2))GO TO 455
470   IF(NROM.LE.1)GO TO 490
      DO 480 K=1,NROM
      IF(J.EQ.K)GO TO 480
      IF(XROM(K,1).EQ.0.)GO TO 480
      IF(IX.EQ.XROM(K,1).AND.IY.EQ.XROM(K,2))GO TO 455
480   CONTINUE
490   X  ROM(J,1)=IX
      XROM(J,2)=IY
      IF(ICNTL(J+10).NE.1)GO TO 450
      WRITE(6,3)LETR(4),J,XROM(J,1),XROM(J,2)
3     FORMAT(1X,A1,I1,' CAUGHT IN STORM. MOVED TO: ',F4.1,',',F4.1/)
450   CONTINUE
C     ...S WITH STORM.
500   IF(ISTSH.NE.99)GO TO 600
      IF(RANGE(SHX,X,SHY,Y).GT.STMRAD)GO TO 600
      SHX=RAN(IZZ)*10.+.5
      SHY=RAN(IZZ)*10.+.5
      SHDEG=RAN(IZZ)*360.
      WRITE(6,1)LETR(12),SHX,SHY,SHVX,SHDEG
      ISHD=99
C     ...T WITH STORM.
600   IF(NTORPS.EQ.0)GO TO 999
      DO 750 J=1,NTORPS
      IF(TORPS(J,1).EQ.0.)GO TO 750
      IF(RANGE(TORPS(J,1),X,TORPS(J,2),Y).GT.STMRAD)GO TO 750
      ZPLUS=0.
      IF(TORPS(J,4).LT.0.)ZPLUS=-360.
      IF(TORPS(J,4).GE.360.)ZPLUS=360.
      TORPS(J,1)=RAN(IZZ)*10.+.5
      TORPS(J,2)=RAN(IZZ)*10.+.5
      TORPS(J,3)=RAN(IZZ)
      TORPS(J,4)=RAN(IZZ)*360.+ZPLUS
750   CONTINUE
999   RETURN
      END
      SUBROUTINE TRPMV
      COMMON/ARRAYS/NAMD(10),BASE(2),EFP(3),EFT(25,2),ETR(3),GHOST(13),
     1  IBL(10,10),IDMG(10),IGAL(10,10),IPQ(10,10),JGAL(10,10),LETR(13),
     1  IPROB1(10),RAD(9),STARS(9,2),TORPS(30,4),XKL(9,9),XROM(9,4)
      DOUBLE PRECISION NAMD
      COMMON/SCALAR/ACCE,DCHG,DDEG,DECR,DEFL,DELTA,DELV,DGIMP,DGKL,DGWP,
     1  DISTGT,DISTKR,DISTPE,DISTPK,DIV1,DIV2,DMXSPD,DSP,DSPKL,DVEL,
     1  DVIMP,DVWP,EEVMSP,EIMP,ENERGY,ERPRRT,ESDIST,ETVEL,EVENU,EVMSP,
     1  EWRP,FDATE,GHEMX,GHTMX,IBASE,ICE,IDOCK,IETOFT,IGH,IHERE,IHWARP,
     1  ISTART,ITFCTR,ITFIRE,ITORP,ITRUCE,IZZ,JCE,KLNGNS,XKTIME,
     1  LEFTK,LEFTR,MAXBQ,MAXK,MAXKQ,MAXR,MAXRQ,MAXSQ,MEN,MINK,MINR,
     1  MROM,MULTK1,MULTK2,NBASES,NKL,NMEN,NROM,NSTARS,NSTEPS,NTORPS,
     1  NTSTPS,NTRP,PCTCOL,PDEG,PNRGY,PRGH,PRKLN,PRREEN,PSP,PTRGH,
     1  RADEGC,REEN,RPRKL,RPRRM,RTIME,RTV,SDATE,SENRGY,
     1  SIM,TFACTR,THITR,TNRGY,TPMIN,TPOWR,VMXKL,VRKL,XDDEG,XDSP,XGHIT,
     1  XKFPE,XKFPST,XKLHIT,XRFTS,XRMHIT,XQE,XTIME,XTRTM,YQE,ZMIN,
     1  PRORAS,RADEK,RADEG,RADER,RADEB,RADET,RADKR,RADKG,RADKB,RADKT,
     1  RADKK,RADGB,RADGT,RAGGR,RADBT,RADTT,RADTR,RADES,RADSS
C     ...TORP MOVEMENT.
      DO 2580 J=1,NTORPS
      IF(TORPS(J,1).EQ.0.)GO TO 2580
      DX=COSD(TORPS(J,4))*TORPS(J,3)
      DY=SIND(TORPS(J,4))*TORPS(J,3)
      TORPS(J,1)=TORPS(J,1)+DX
      TORPS(J,2)=TORPS(J,2)+DY
C     ...TORPS LEAVING QUADRANT ARE DESTROYED.
      IF(TORPS(J,1).LT..5.OR.TORPS(J,1).GE.10.5.OR.TORPS(J,2).LT..5.OR.T
     1ORPS(J,2).GE.10.5)CALL DLETE(7,J)
2580  CONTINUE
2600  RETURN
      END
      SUBROUTINE TRY1
      COMMON/ARRAYS/NAMD(10),BASE(2),EFP(3),EFT(25,2),ETR(3),GHOST(13),
     1  IBL(10,10),IDMG(10),IGAL(10,10),IPQ(10,10),JGAL(10,10),LETR(13),
     1  IPROB1(10),RAD(9),STARS(9,2),TORPS(30,4),XKL(9,9),XROM(9,4)
      DOUBLE PRECISION NAMD
      COMMON/SCALAR/ACCE,DCHG,DDEG,DECR,DEFL,DELTA,DELV,DGIMP,DGKL,DGWP,
     1  DISTGT,DISTKR,DISTPE,DISTPK,DIV1,DIV2,DMXSPD,DSP,DSPKL,DVEL,
     1  DVIMP,DVWP,EEVMSP,EIMP,ENERGY,ERPRRT,ESDIST,ETVEL,EVENU,EVMSP,
     1  EWRP,FDATE,GHEMX,GHTMX,IBASE,ICE,IDOCK,IETOFT,IGH,IHERE,IHWARP,
     1  ISTART,ITFCTR,ITFIRE,ITORP,ITRUCE,IZZ,JCE,KLNGNS,XKTIME,
     1  LEFTK,LEFTR,MAXBQ,MAXK,MAXKQ,MAXR,MAXRQ,MAXSQ,MEN,MINK,MINR,
     1  MROM,MULTK1,MULTK2,NBASES,NKL,NMEN,NROM,NSTARS,NSTEPS,NTORPS,
     1  NTSTPS,NTRP,PCTCOL,PDEG,PNRGY,PRGH,PRKLN,PRREEN,PSP,PTRGH,
     1  RADEGC,REEN,RPRKL,RPRRM,RTIME,RTV,SDATE,SENRGY,
     1  SIM,TFACTR,THITR,TNRGY,TPMIN,TPOWR,VMXKL,VRKL,XDDEG,XDSP,XGHIT,
     1  XKFPE,XKFPST,XKLHIT,XRFTS,XRMHIT,XQE,XTIME,XTRTM,YQE,ZMIN,
     1  PRORAS,RADEK,RADEG,RADER,RADEB,RADET,RADKR,RADKG,RADKB,RADKT,
     1  RADKK,RADGB,RADGT,RAGGR,RADBT,RADTT,RADTR,RADES,RADSS
      COMMON/TBEAMS/IFGHTM,ITRMEN(20),JUP,JFROM,IBMEN,JDOWN,JTO,IBMENR,
     1  SBMNR,CREWR(9),SCREWR,CREWK,CODDS,DODDS,EODDS,FODDS
      COMMON/SUBCTL/ICNTL(20),RTBRG(5),KTO,LTO,KBRG,XWRP,
     1  ISTAT,IDAMRP,SDEF,IMSG,SKDLAY,SRDLY,GHVMX,MXCRGH,GHPHEN,
     1  DSPGH,DGGH,RPRGH,NHELP,NHELPS,XHELP
      COMMON/TRNSFR/ICM,IDIR,MTORPS,DTORP(30),IBTYP,IEVDR,ADDFL,ITRSTP,
     1  KFROM,MTO,LUP,LDOWN,IFROM,ITO,JSCHM,ISHSTR(10),JDAM,
     1  IPROB2(10),NGHTFP
      COMMON/FORGOT/GHACCE,PJAM,PJMINC,ACTPJM,PPHASD,PTORPD,PDRVD,
     1  PDEFD,IGHPH,IGHTR,IGHDR,IGHDE
      COMMON/SHUTL/SHX,SHY,SHDEG,SHVX,ISTSH,ISHD,IFNDS(9),IDSES,VDSES,
     1  VSTRDS,VSTRM,PRXSH,VDSESM,ISHNUM
      COMMON/EXTRAS/SNOVAP,ZMAX,ICLOAK,PRCLDN,PHOLE,IHOLE,JHOLE,HOLRAD,
     1  SHLDF,NQUAD,PSTORM,ISTORM,JSTORM,STMRAD,LEVEL,ION,IYES,CMIN,
     1  CPOWR
      COMMON/LOCAL/ITBEAM,ISCAN,ITDK,JSCAN,JMSG,TRNRGY,IISTAT,JJSTAT,
     1  JJUP,JJFROM,JJTO,JJDOWN
      DOUBLE PRECISION RANKS(2,14),MNAME,MPASS,MOLDNM,NOLDNM,
     1  ISTATS(2),IST
      DOUBLE PRECISION NPASS,NBLANK,NHELPL
      COMMON/RANK/RANKS,MNAME,MPASS,POINTS,RANKPT(14),NRANKS,IRANK,NRW,
     1  MMKEY,NTIME,IOK,NHOLD,ICLKON,NSW,ISTATS
      DATA NHELPL/'7777    '/
120   CALL QTIME(ISTART)
      IF(IOK.EQ.1)GO TO 66666
      IF(NRW.EQ.1.AND.NTIME.LT.29700.AND.ISTART.GE.28800.AND.NSW.EQ.0)
     1  GO TO 55500
      IF(NRW.EQ.1.AND.NTIME.GE.42300.AND.ISTART.GE.46800.
     1  AND.ISTART.LT.61200.AND.NSW.EQ.0)GO TO 55500
      IF(NRW.EQ.1.AND.ISTART.GE.29700.AND.ISTART.LT.42300)
     1  CALL RATING(3)
      IF(NRW.EQ.1.AND.ISTART.GE.47700.AND.ISTART.LT.61200)
     1  CALL RATING(3)
      GO TO 66666
55500 WRITE(6,55501)
55501 FORMAT(' YOU HAVE 15 MINUTES TO FINISH THE GAME OR SAVE IT!')
      NSW=1
C     ...ASK FOR COMMAND
66666 WRITE(6,99)
99    FORMAT(' COMMAND?   ')
      READ(5,*,ERR=899,END=4321)ICM
      IF(ICM.EQ.XHELP)GO TO 899
      IF(ICM.EQ.0.OR.ICM.LT.-1.OR.ICM.GT.22)GO TO 66666
      IF(ICM.NE.-1)GO TO 140
C     ...PRINT COMMANDS
      CALL CPAGE
      WRITE(6,801)
801   FORMAT('  1 - SET COURSE/SPEED               2 - SHORT SCAN'/
     1'  3 - LONG SCAN                      4 - PHASERS'/
     1'  5 - TORPEDOS                       6 - PULSIVE BEAMS'/
     1'  7 - TRAVEL/WAIT                    8 - STATUS REPORT'/
     1'  9 - DAMAGE CONTROL                10 - EVASIVE MANEUVERS'/
     1' 11 - EMERGENCY EVASIVE MANEUVERS   12 - RAISE DEFLECTORS'/
     1' 13 - DROP DEFLECTORS               14 - PROPOSE TRUCE'/
     1' 15 - SHORT RANGE TRACK             16 - GALACTIC UPDATE'/
     1' 17 - PLOT BEARING                  18 - SELF DESTRUCT'/
     1' 19 - TRANSPORTERS                  20 - COMMUNICATIONS'/
     1' 21 - SHUTTLECRAFT                  22 - SHIP''S COMPUTER'/
     1' 23 - AUTOPILOT                     24 - SEND MESSAGE'/)
C     ...NO ADD'L INFO REQUIRED
      GO TO 120
140   IF(ICM.EQ.2.OR.ICM.EQ.3.OR.ICM.EQ.9.OR.ICM.EQ.16)CALL CPAGE
      IF(ICM.EQ.17.OR.ICM.EQ.18)CALL CPAGE
      GO TO (121,150,150,124,125,126,127,150,129,130,131,132,150,150,
     1  150,150,150,138,139,141,142,143),ICM
C     ...1 COMMAND. REQUEST COURSE AND SPEED. MAKE NECESARY CORRECTIONS.
121   WRITE(6,97)PDEG
97    FORMAT(' NEW BEARING(',F4.0,')  ')
      READ(5,*,ERR=898,END=4321)X
      IF(X.EQ.XHELP)GO TO 898
1210  IF(X.LT.360.)GO TO 1211
      NNN=360
      NN=X
      XX=X-NN
      X=MOD(NN,NNN)
      X=X+XX
      GO TO 1212
1211  IF(X.GE.0.)GO TO 1212
      X=-X
      NNN=360
      NN=X
      XX=X-NN
      X=MOD(NN,NNN)
      X=360-X-XX
1212  XDDEG=X
1213  WRITE(6,96)PSP
96    FORMAT(' WARP FACTOR(',F5.3,')  ')
      READ(5,*,ERR=897,END=4321)X
      IF(X.EQ.XHELP)GO TO 897
      IF(X.LT.0.)GO TO 998
      XDSP=X
      GO TO 150
C     ...4 COMMAND. GET STRENGTH AND WHETHER FWD OR REAR.
124   WRITE(6,95)
95    FORMAT(' ENERGIZE PHASERS'/' FORWARD OR REAR  ')
      READ(5,94,END=4321)IDIR
94    FORMAT(A1)
      IF(IDIR.EQ.LETR(10))GO TO 1241
      IF(IDIR.NE.LETR(4))GO TO 896
      IDIR=3
      GO TO 1242
1241  IDIR=1
C     ...SUBTRAVT ENERGY THAT IS QUEUED TO BE USED IN PREV. CMNDS.
1242  XNRGY=ENERGY-PNRGY
      IF(EFP(1).NE.0.)XNRGY=ENERGY
1243  WRITE(6,91)XNRGY
91    FORMAT(' ENERGY (AVAILABLE=',F8.1,') ')
      READ(5,*,ERR=895,END=4321)PNRGY
      IF(PNRGY.EQ.XHELP)GO TO 895
      IF(PNRGY.LT.XNRGY)GO TO 1244
      WRITE(6,1245)
1245  FORMAT(' NOT ENOUGH ENERGY AVAILABLE')
      GO TO 1243
1244  IF(PNRGY.GT.0.)GO TO 150
      PNRGY=0.
      GO TO 998
125   IF(ITORP.NE.0)GO TO 12551
      WRITE(6,12552)
12552 FORMAT(' PHOTON TORPEDOS EXPENDED')
      GO TO 998
12551 DO 12554 J=1,30
      DTORP(J)=999.
12554 CONTINUE
1252  WRITE(6,93)ITORP
93    FORMAT(' ',I2,' PHOTON TORPEDOS ON BOARD'/
     1' ENTER BEARINGS FOR TORPEDOS')
      READ(5,*,ERR=893,END=4321)DTORP
      IF(DTORP(1).EQ.XHELP)GO TO 893
      IF(DTORP(1).EQ.999.)GO TO 12555
C     ... DTORP IS BRNG ARRAY.
      DO 1251    J=1,ITORP
      IF(DTORP(J).EQ.999.)GO TO 12553
C     ...NOTE THAT CANCELLATION OF ONE CAUSES ALL TO BE CANCELLED.
      IF(DTORP(J).LT.0.OR.DTORP(J).GE.360.)GO TO 12555
1251  CONTINUE
      MTORPS=J
      IF(ITFIRE.EQ.0)MINR=0
      GO TO 150
12553 MTORPS=J-1
      IF(ITFIRE.EQ.0)MINR=0
      GO TO 150
12555 DO 12556 J=1,30
      DTORP(J)=0.
      MTORPS=0
12556 CONTINUE
      GO TO 998
C     ...TRACTOR BEAMS. COMPUTER CALCULATES STRENGTH NECESSARY.
126   WRITE (6,87)
87    FORMAT(' PULSIVE BEAMS'/' TRACTOR OR REPULSOR  ')
      READ(5,94,END=4321)IBTYPE
      IBTYP=1
      IF(IBTYPE.EQ.LETR(7))GO TO 150
      IF(IBTYPE.NE.LETR(4))GO TO 892
      IBTYP=2
      XNRGY=ENERGY-PNRGY
      IF(ETR(1).NE.0.)XNRGY=ENERGY
1261  WRITE(6,91)XNRGY
      READ(5,*,ERR=891,END=4321)PNRGY
      IF(PNRGY.EQ.XHELP)GO TO 891
      IF(PNRGY.LT.XNRGY)GO TO 1262
      WRITE(6,1245)
      GO TO 1261
1262  IF(PNRGY.GT.0.)GO TO 1263
      PNRGY=0.
      GO TO 998
1263  IF(KLNGNS.LE.1)GO TO 1264
      WRITE(6,9112)
9112  FORMAT(' WHICH KLINGON?')
      READ(5,*,ERR=871,END=4321)IBTYPE
      IF(IBTYPE.EQ.XHELP)GO TO 871
      IF(IBTYPE.LE.0.OR.IBTYPE.GT.KLNGNS)GO TO 998
      IBTYP=-IBTYPE
      GO TO 150
1264  IBTYP=-1
      GO TO 150
C     ...TRAVEL. GET NO. OF STARMINUTES.
127   WRITE(6,77707)
77707 FORMAT(' TRAVEL HOW MANY STAR MINUTES? ')
      READ(5,*,ERR=890,END=4321)ITRSTP
      IF(ITRSTP.EQ.XHELP)GO TO 890
      IF(ITRSTP.GT.0)GO TO 1271
      ITRSTP=0
      GO TO 998
1271  ITRSTP=MAX0(0,ITRSTP-2)
      GO TO 150
C     ...DAMAGE CONTROL. NOW POSSIBLE TO REASSIGN REPAIR CREWS.
129   WRITE(6,77708)
77708 FORMAT(' DAMAGE CONTROL REQUEST? ')
      READ(5,94,END=4321)IDAM
      JDAM=1
      IF(IDAM.EQ.LETR(4))GO TO 150
      IF(IDAM.EQ.LETR(11))GO TO 1297
      IF(IDAM.NE.NHELPS)GO TO 998
      GO TO 875
1297  JDAM=2
C     CALL CPAGE
      WRITE(6,1291)IPROB1
1291  FORMAT(' CURRENT PRIORITIES ARE:',10I4)
      J=1
      K=2
      DO 77720 I=1,5
      WRITE(6,77721)J,NAMD(J),K,NAMD(K)
77721 FORMAT(1X,I2,' - ',A8,5X,I2,' - ',A8)
      J=J+2
      K=K+2
77720 CONTINUE
1293  WRITE(6,77709)
77709 FORMAT(' REASSIGNMENT? ')
      READ(5,*,END=4321,ERR=874)IPROB2
      IF(IPROB2(1).EQ.XHELP)GO TO 874
C     ...CHECK IF SUM <=100.
      IS=0
      DO 1295 J=1,10
      IF(IPROB2(J).LT.0)GO TO 998
1295  IS=IS+IPROB2(J)
      IF(IS.LE.100)GO TO 150
      WRITE(6,1292)IPROB2
1292  FORMAT(' ILLEGAL REASSIGNMENT:',10I4)
      GO TO 1293
130   WRITE(6,183)
183   FORMAT(' EVASIVE MANEUVERS')
      GO TO 1305
131   WRITE(6,88885)
88885 FORMAT(' EMERGENCY EVASIVE MANEUVERS')
1305  WRITE(6,77710)
77710 FORMAT(' PORT,STARBOARD, OR REVERSE ')
      READ(5,94,ERR=889,END=4321)IEVAS
      IEVDR=1
      IF(IEVAS.EQ.LETR(11))GO TO 150
      IF(IEVAS.EQ.LETR(4))GO TO 1306
      IF(IEVAS.EQ.NHELPS)GO TO 889
      IF(IEVAS.NE.LETR(12))GO TO 998
      IEVDR=2
      GO TO 150
1306  IEVDR=3
      GO TO 150
C     ...RAISE DEFLECTORS. NEGATIVE NUMBERS ACCEPTED.
132   XNRGY=ENERGY-PNRGY
1322  WRITE(6,81)XNRGY,DEFL
81    FORMAT(' RAISE DEFLECTORS'/' ENERGY = ',F7.0,' SHIELDS = ',F8.1)
      WRITE(6,77711)
77711 FORMAT(' POWER TO SHIELDS? ')
      READ(5,*,ERR=888,END=4321)ADDFL
      IF(ADDFL.EQ.XHELP)GO TO 888
      IF(ADDFL.LT.XNRGY)GO TO 150
      WRITE(6,1245)
      GO TO 1322
C     ...SELF DESTRUCT
C 138   CALL CPAGE
138   WRITE(6,1381)
1381  FORMAT(' DESTRUCT SEQUENCE ENTERED!!!!!!'/
     1' THE ENTERPRISE WILL SELF DESTRUCT IN 10 SECONDS'/
     1' 10'/
     1'   9'/
     1'    8'/
     1'     7'/
     1'      6'/
     1' SELF DESTRUCT IN 5 SECONDS! FAIL-SAFE MECHANISM ENGAGED'/
     1' ONLY THE COMMANDER CAN OVERRIDE WITH HIS PASSWORD'/
     1' ENTER PASSWORD TO CONTINUE:')
1384  READ(5,1382,END=4321)NPASS
1382  FORMAT(A8)
      IF(NPASS.NE.MPASS)GO TO 887
      WRITE(6,1383)
1383  FORMAT('       5'/
     1'        4'/
     1'         3'/
     1'          2'/
     1'           1')
      GO TO 150
C     ...TRANSPORTERS.
139   IF(JJSTAT.GT.0)GO TO 994
      IF(ISTAT.EQ.0.OR.ISTAT.EQ.9999)GO TO 1397
      WRITE(6,941)
941   FORMAT(' TRANSPORTERS ALREADY IN USE. RETYPE COMMAND WHEN PREVIOUS
     1 ORDER IS COMPLETE.')
      GO TO 998
1397  WRITE(6,601)
601   FORMAT(' ENERGIZE TRANSPORTERS'/' FROM?')
      READ(5,940,ERR=886,END=4321)IFROM,KFROM
940   FORMAT(A1,I1)
      IF(IFROM.EQ.LETR(3))GO TO 1395
      IF(IFROM.EQ.LETR(4))GO TO 1395
      IF(IFROM.EQ.LETR(5))GO TO 1395
      IF(IFROM.EQ.LETR(6))GO TO 1395
      IF(IFROM.NE.LETR(2))GO TO 886
1395  WRITE(6,1399)
1399  FORMAT(' HOW MANY MEN?')
      READ(5,*,ERR=885,END=4321)IBMEN
      IF(IBMEN.EQ.XHELP)GO TO 885
      IF(IBMEN.LE.0)GO TO 998
13961 WRITE(6,1396)
1396  FORMAT(' TO?')
      READ(5,940,ERR=884,END=4321)ITO,MTO
      IF(ITO.EQ.LETR(3))GO TO 150
      IF(ITO.EQ.LETR(4))GO TO 13905
      IF(ITO.EQ.LETR(5))GO TO 150
      IF(ITO.NE.LETR(2))GO TO 884
      GO TO 150
13905 IF(ICLOAK.NE.2.OR.MTO.NE.1)GO TO 150
13907 WRITE(6,13906)
13906 FORMAT(' TYPE GUESS COORDINATES')
      READ(5,*,ERR=8835,END=4321)IGUESS,JGUESS
      IF(IGUESS.EQ.XHELP)GO TO 8835
      IF(IGUESS.EQ.XROM(1,1).AND.JGUESS.EQ.XROM(1,2))GO TO 150
      WRITE(6,13908)
13908 FORMAT(' WRONG GUESS')
      GO TO 998
C     ...INTERSHIP COMMUNICATIONS
141   WRITE(6,1401)
1401  FORMAT(' INTERSHIP COMMUNICATIONS')
      GO TO 1405
14051 WRITE(6,1406)
1406  FORMAT(' COMMUNICATIONS INTERCEPTED AND JAMMED!')
      ACTPJM=ACTPJM+PJMINC
      GO TO 998
1405  WRITE(6,1396)
      READ(5,940,ERR=883,END=4321)ITO,KTO
C     ...ENEMY INTERCEPT MESSAGE?.
      IF(KLNGNS.EQ.0)GO TO 14097
      DO 14098 J=1,KLNGNS
      IF(ICNTL(J+1).NE.1.AND.XKL(J,1).NE.0.)GO TO 14095
14098 CONTINUE
14097 IF(NROM.EQ.0)GO TO 14099
      DO 14096 J=1,NROM
      IF(ICNTL(J+10).NE.1.AND.XROM(J,1).NE.0.)GO TO 14093
14096 CONTINUE
      GO TO 14099
14095 IF(RAN(IZZ).GT.ACTPJM)GO TO 14097
      GO TO 14051
14093 IF(RAN(IZZ).LE.ACTPJM)GO TO 14051
14099 LTO=3
      IF(ITO.EQ.LETR(4))GO TO 1407
      IF(ITO.EQ.LETR(5))GO TO 1408
      IF(ITO.EQ.LETR(6))GO TO 1411
      IF(ITO.NE.LETR(3))GO TO 883
      GO TO 1410
1407  LTO=4
      GO TO 1410
1408  LTO=5
      GO TO 1410
1411  LTO=6
1410  WRITE(6,1409)
1409  FORMAT(' MESSAGE?'/
     1'  1 - CHANGE COURSE          4 - FIRE PHASERS'/
     1'  5 - FIRE TORPEDOS          6 - SELF DESTRUCT'/
     1'  8 - STATUS REPORT          9 - DAMAGE REPORT'/
     1' 12 - RAISE DEFLECTORS      17 - PLOT BEARING')
      READ(5,*,ERR=882,END=4321)IMSG
      IF(IMSG.EQ.XHELP)GO TO 882
      GO TO(14001,998,998,14004,14005,150,998,150,150,998,998,14012,998,
     1  998,998,998,14017),IMSG
      GO TO 998
C     ...CHANGE COURSE. ILLEGAL IF ROMULAN OR BASE
14001 IF(LTO.EQ.4)GO TO 998
      IF(LTO.EQ.6)GO TO 998
      WRITE(6,14020)
14020 FORMAT(' NEW BEARING?')
      READ(5,*,ERR=881,END=4321)KBRG
      IF(KBRG.EQ.XHELP)GO TO 881
14002 IF(KBRG.GE.0)GO TO 14003
      KBRG=KBRG+360
      GO TO 14002
14003 IF(KBRG.LT.360)GO TO 14021
      KBRG=KBRG-360
      GO TO 14003
14021 WRITE(6,14022)
14022 FORMAT(' WARP FACTOR?')
      READ(5,*,ERR=880,END=4321)XWRP
      IF(XWRP.EQ.XHELP)GO TO 880
      IF(XWRP.LT.0.)GO TO 998
      GO TO 150
C     ...FIRE PHASERS. ILLEGAL IF ROMULAN OR BASE.
14004 IF(LTO.EQ.4)GO TO 998
      IF(LTO.EQ.6)GO TO 998
      IF(LTO.NE.5)GO TO 150
      WRITE(6,77712)
77712 FORMAT(' # TIMES TO FIRE? ')
      READ(5,*,END=4321,ERR=873)NGHTFP
      IF(NGHTFP.EQ.XHELP)GO TO 873
      IF(NGHTFP.LE.0)GO TO 998
      GO TO 150
C     ...FIRE TORPEDO. ILLEGAL IF KLINGON OR BASE.
14005 IF(LTO.EQ.3)GO TO 998
      IF(LTO.EQ.6)GO TO 998
      WRITE(6,14025)
14025 FORMAT(' BEARING(S) FOR TORPEDO(S)?')
      DO 14024 J=1,5
14024 RTBRG(J)=-1.
      READ(5,*,ERR=879,END=4321)RTBRG
      IF(TRBRG.EQ.XHELP)GO TO 879
      IF(RTBRG(1).LT.0.)GO TO 998
      GO TO 150
C     ...DEFLECTORS. GHOSTSHIP ONLY. NEG NOW OKAY FOR LOWERING.
14012 IF(LTO.NE.5)GO TO 998
      WRITE(6,14027)
14027 FORMAT(' POWER TO DEFLECTORS?')
      READ(5,*,ERR=878,END=4321)SDEF
      IF(SDEF.EQ.XHELP)GO TO 878
      GO TO 150
C     ...PLOT BEARING. LEGAL FOR BASE ONLY.
14017 IF(LTO.NE.6)GO TO 998
      GO TO 150
C     ...SHUTTLECRAFT.
142   WRITE(6,1421)
1421  FORMAT(' SHUTTLECRAFT COMMAND?')
      READ(5,94,END=4321)ILET
      JSCHM=1
      IF(ILET.EQ.LETR(4))GO TO 1425
      IF(ILET.NE.LETR(2))GO TO 877
14211 WRITE(6,1422)
1422  FORMAT(' WHICH STAR SYSTEMS')
      READ(5,*,ERR=876,END=4321)ISHSTR
      IF(ISHSTR(1).EQ.XHELP)GO TO 876
      IF(ISHSTR(1).LE.0)GO TO 998
      GO TO 150
1425  JSCHM=2
      GO TO 150
C     ...COMPUTER REQUESTS.
143   WRITE(6,77713)
77713 FORMAT(' COMPUTER REQUEST? ')
      READ(5,94,END=4321,ERR=872)ILET
      IF(ILET.EQ.LETR(5))GO TO 1431
      IF(ILET.EQ.LETR(6))GO TO 1432
      IF(ILET.EQ.LETR(12))GO TO 1433
      IF(ILET.EQ.LETR(4))GO TO 1434
      IF(ILET.EQ.LETR(13).AND.ICLOAK.LT.0)GO TO 1435
      IF(ILET.EQ.LETR(7))GO TO 1436
      IF(ILET.NE.NHELPS)GO TO 998
      GO TO 872
1431  JSCHM=1
      GO TO 150
1432  JSCHM=2
      GO TO 150
1433  JSCHM=3
      GO TO 150
1434  JSCHM=4
      GO TO 150
1435  JSCHM=5
      WRITE(6,77716)
77716 FORMAT(' TURN CLOAKING DEVICE ON (Y OR N)?')
      READ(5,94,ERR=4321)ICLKON
      IF(ICLKON.EQ.IHELPS)GO TO 870
      GO TO 150
1436  JSCHM=6
      GO TO 150
C     ...END OF COMMAND INPUT. DO THINGS WHICH OCCURRED IN THE INTERIM.
150   CALL QTIME(ITIME)
      NSTEPS=(ITIME-ISTART)
      IF(NSTEPS.LE.0)NSTEPS=1
155   ISTART=ITIME
      NHOLD=NHOLD+NSTEPS
      IF(NHOLD.GE.ITFCTR)GO TO 88888
      GO TO 3000
88888 NSTEPS=ITFCTR
      NHOLD=NHOLD-ITFCTR
88890 IF(NHOLD.LT.ITFCTR)GO TO 88889
      NSTEPS=NSTEPS+ITFCTR
      NHOLD=NHOLD-ITFCTR
      GO TO 88890
88889 CALL ACTION
3000  CALL PROCM
      NHOLD=NHOLD+NSTEPS
      IF(NHOLD.GE.ITFCTR)GO TO 88891
      GO TO 88899
88891 NSTEPS=ITFCTR
      NHOLD=NHOLD-ITFCTR
88898 IF(NHOLD.LT.ITFCTR)GO TO 88899
      NSTEPS=NSTEPS+ITFCTR
      NHOLD=NHOLD-ITFCTR
      GO TO 88898
88899 CALL ACTION
      IF(NHOLD.GE.ITFCTR)GO TO 88891
      GO TO 120
998   WRITE(6,996)
      PNRGY=0.
996   FORMAT(' +++CANCELLED+++')
      ICM=99
      GO TO 150
994   WRITE(6,993)LETR(JUP),JFROM
993   FORMAT(' TRANSPORTERS ALREADY ENERGIZED FOR ',A1,I1,' DESTRUCT')
      GO TO 998
4321  STOP
899   CALL HELP(7777)
      CALL QTIME(ISTART)
      GO TO 120
898   CALL HELP(25)
      CALL QTIME(ISTART)
      GO TO 121
897   CALL HELP(26)
      CALL QTIME(ISTART)
      GO TO 1213
896   CALL HELP(27)
      CALL QTIME(ISTART)
      GO TO 124
895   CALL HELP(28)
      CALL QTIME(ISTART)
      GO TO 1243
893   CALL HELP(29)
      CALL QTIME(ISTART)
      GO TO 1252
892   CALL HELP(30)
      CALL QTIME(ISTART)
      GO TO 126
891   CALL HELP(31)
      CALL QTIME(ISTART)
      GO TO 1261
890   CALL HELP(33)
      CALL QTIME(ISTART)
      GO TO 127
889   CALL HELP(37)
      CALL QTIME(ISTART)
      GO TO 1305
888   CALL HELP(38)
      CALL QTIME(ISTART)
      GO TO 1322
887   IF(NPASS.NE.NHELPL)GO TO 998
      CALL HELP(39)
      CALL QTIME(ISTART)
      GO TO 1384
886   IF (IFROM.NE.NHELPS)GO TO 998
      CALL HELP(40)
      CALL QTIME(ISTART)
      GO TO 139
885   CALL HELP(41)
      CALL QTIME(ISTART)
      GO TO 1395
884   CALL HELP(42)
      CALL QTIME(ISTART)
      GO TO 13961
8835  CALL HELP(43)
      CALL QTIME(ISTART)
      GO TO 13907
883   CALL HELP(44)
      CALL QTIME(ISTART)
      GO TO 1405
882   CALL HELP(45)
      CALL QTIME(ISTART)
      GO TO 1410
881   CALL HELP(46)
      CALL QTIME(ISTART)
      GO TO 14001
880   CALL HELP(47)
      CALL QTIME(ISTART)
      GO TO 14021
879   CALL HELP(48)
      CALL QTIME(ISTART)
      GO TO 14005
878   CALL HELP(49)
      CALL QTIME(ISTART)
      GO TO 14012
877   CALL HELP(51)
      CALL QTIME(ISTART)
      GO TO 142
876   CALL HELP(52)
      CALL QTIME(ISTART)
      GO TO 14211
875   CALL HELP(34)
      CALL QTIME(ISTART)
      GO TO 129
874   CALL HELP(35)
      CALL QTIME(ISTART)
      GO TO 1293
873   CALL HELP(50)
      CALL QTIME(ISTART)
      GO TO 14004
872   CALL HELP(53)
      CALL QTIME(ISTART)
      GO TO 143
871   CALL HELP(32)
      CALL QTIME(ISTART)
      GO TO 1263
870   CALL HELP(54)
      CALL QTIME(ISTART)
      GO TO 1435
      END
      SUBROUTINE TSHUTL
      COMMON/ARRAYS/NAMD(10),BASE(2),EFP(3),EFT(25,2),ETR(3),GHOST(13),
     1  IBL(10,10),IDMG(10),IGAL(10,10),IPQ(10,10),JGAL(10,10),LETR(13),
     1  IPROB1(10),RAD(9),STARS(9,2),TORPS(30,4),XKL(9,9),XROM(9,4)
      DOUBLE PRECISION NAMD
      COMMON/SCALAR/ACCE,DCHG,DDEG,DECR,DEFL,DELTA,DELV,DGIMP,DGKL,DGWP,
     1  DISTGT,DISTKR,DISTPE,DISTPK,DIV1,DIV2,DMXSPD,DSP,DSPKL,DVEL,
     1  DVIMP,DVWP,EEVMSP,EIMP,ENERGY,ERPRRT,ESDIST,ETVEL,EVENU,EVMSP,
     1  EWRP,FDATE,GHEMX,GHTMX,IBASE,ICE,IDOCK,IETOFT,IGH,IHERE,IHWARP,
     1  ISTART,ITFCTR,ITFIRE,ITORP,ITRUCE,IZZ,JCE,KLNGNS,XKTIME,
     1  LEFTK,LEFTR,MAXBQ,MAXK,MAXKQ,MAXR,MAXRQ,MAXSQ,MEN,MINK,MINR,
     1  MROM,MULTK1,MULTK2,NBASES,NKL,NMEN,NROM,NSTARS,NSTEPS,NTORPS,
     1  NTSTPS,NTRP,PCTCOL,PDEG,PNRGY,PRGH,PRKLN,PRREEN,PSP,PTRGH,
     1  RADEGC,REEN,RPRKL,RPRRM,RTIME,RTV,SDATE,SENRGY,
     1  SIM,TFACTR,THITR,TNRGY,TPMIN,TPOWR,VMXKL,VRKL,XDDEG,XDSP,XGHIT,
     1  XKFPE,XKFPST,XKLHIT,XRFTS,XRMHIT,XQE,XTIME,XTRTM,YQE,ZMIN,
     1  PRORAS,RADEK,RADEG,RADER,RADEB,RADET,RADKR,RADKG,RADKB,RADKT,
     1  RADKK,RADGB,RADGT,RAGGR,RADBT,RADTT,RADTR,RADES,RADSS
      COMMON/LOCAL/ITBEAM,ISCAN,ITDK,JSCAN,JMSG,TRNRGY,IISTAT,JJSTAT,
     1  JJUP,JJFROM,JJTO,JJDOWN
      COMMON/TBEAMS/IFGHTM,ITRMEN(20),JUP,JFROM,IBMEN,JDOWN,JTO,IBMENR,
     1  SBMNR,CREWR(9),SCREWR,CREWK,CODDS,DODDS,EODDS,FODDS
      COMMON/SUBCTL/ICNTL(20),RTBRG(5),KTO,LTO,KBRG,XWRP,
     1  ISTAT,IDAMRP,SDEF,IMSG,SKDLAY,SRDLY,GHVMX,MXCRGH,GHPHEN,
     1  DSPGH,DGGH,RPRGH,NHELP,NHELPS,XHELP
      COMMON/FORGOT/GHACCE,PJAM,PJMINC,ACTPJM,PPHASD,PTORPD,PDRVD,
     1  PDEFD,IGHPH,IGHTR,IGHDR,IGHDE
      COMMON/SHUTL/SHX,SHY,SHDEG,SHVX,ISTSH,ISHD,IFNDS(9),IDSES,VDSES,
     1  VSTRDS,VSTRM,PRXSH,VDSESM,ISHNUM
      COMMON/ATTACK/ITKL(18),JTKL(18)
      COMMON/ZEROS/DVWP0,EWRP0,DISTP0,IETOF0,DISTG0,CODDS0,
     1  EODDS0,IDAMR0,PJAM0,ETVEL0,SHLDF0,TRNRG0
      COMMON/SHUTL2/ALEDR,IALIC,IALJC,IALSS,NDRA,NTROPS,DRL,DRD
      COMMON/EXTRAS/SNOVAP,ZMAX,ICLOAK,PRCLDN,PHOLE,IHOLE,JHOLE,HOLRAD,
     1  SHLDF,NQUAD,PSTORM,ISTORM,JSTORM,STMRAD,LEVEL,ION,IYES,CMIN,
     1  CPOWR
      COMMON/TRNSFR/ICM,IDIR,MTORPS,DTORP(30),IBTYP,IEVDR,ADDFL,ITRSTP,
     1  KFROM,MTO,LUP,LDOWN,IFROM,ITO,JSCHM,ISHSTR(10),JDAM,
     1  IPROB2(10),NGHTFP
      EQUIVALENCE(ISHST,ISTSH)
      DATA PRSHXD,ZFIND,NTTF/.01,.4,18/
      PCT(A,B)=(A-B)/B*100.
C     ...ISDH SHOWS WANTS. ISTSH SHOWS STATUS.
C     ...ISHD=1-9. EXPLORE STAR SYSTEM 1-9.
C     ...ISHD=99. RETURN TO E.
C     ...ISHD=0. DO NOTHING.
C     ...ISTSH=1-9. ON STAR SYSTEM 1-9.
C     ...ISTCC=98. SHUTTLECRAFT CAN'T CATCH THE ENTERPRISE.
C     ...ISTSH=99. IN SPACE.
C     ...ISTSH=0. ON E.
      IF(ISHD.EQ.99)GO TO 500
C     ...EXPLORE NEW STAR SYSTEM.
      IF(ISHST.EQ.ISHD)GO TO 999
      IF(ISTSH.NE.0)GO TO 100
      WRITE(6,1)
1     FORMAT(' SHUTTLECRAFT LAUNCHED')
      SHX=XQE
      SHY=YQE
C     ...MOVE IT.
100   CALL GETBRG(SHDEG,SHX,STARS(ISHD,1),SHY,STARS(ISHD,2),VPX,VPY)
      IF(ISTSH.EQ.99)GO TO 110
      VPX=SQRT(VPX*VPX+VPY*VPY)/SHVX/100.-.01
      WRITE(6,101)VPX
101   FORMAT(' ARRIVAL IN ',F4.2,' STARDAYS')
110   ISTSH=99
      SHX=SHX+COSD(SHDEG)*SHVX
      SHY=SHY+SIND(SHDEG)*SHVX
C     ...CHECK IF ENTERING STAR SYSTEM.
      IF(RANGE(SHX,STARS(ISHD,1),SHY,STARS(ISHD,2)).GT.RADSS)GO TO 999
      ISHST=ISHD
      WRITE(6,2)ISHD
2     FORMAT(' STAR SYSTEM ',I2,' ENTERED AND EXPLORED')
C     ...FINDS. DO NOT TELL UNTIL RETURN UNLESS DESTROYED.
      IF(IFNDS(ISHD).NE.0)GO TO 300
      IF(RAN(IZZ).GE.PRSHXD)GO TO 200
155   WRITE(6,3)
3     FORMAT(' SHUTTLECRAFT LOST OR DESTROYED')
      ISHD=0
      ISHST=0
      JMSG=0
      DO 156 J=1,9
      IF(IFNDS(J).EQ.-1)GO TO 156
      IFNDS(J)=0
      ISHSTR(J)=0
156   CONTINUE
      ISHNUM=ISHNUM-1
      GO TO 999
200   X=RAN(IZZ)
      DO 210 J=1,NTTF
      IF(X.LE.ZFIND+(J-1)*((1.-ZFIND)/NTTF))GO TO 220
210   CONTINUE
220   IFNDS(ISHD)=J
230   ISHST=ISHD
      ISHD=ISHSTR(2)
      IF(ISHD.LE.0.OR.STARS(ISHD,1).EQ.0.)ISHD=99
      DO 240 J=2,10
240   ISHSTR(J-1)=ISHSTR(J)
      GO TO 999
300   WRITE(6,301)
301   FORMAT(' WE''VE BEEN HERE BEFORE, YOU DUMMY!')
      GO TO 230
C     ...RETURN TO E.
500   IF(ISHST.EQ.0)GO TO 996
      IF(JMSG.NE.0)GO TO 502
      JMSG=1
      DO 501 J=1,NSTARS
      IF(IFNDS(J).EQ.15)GO TO 503
501   CONTINUE
      GO TO 502
503   WRITE(6,504)
504   FORMAT(' SHUTTLECRAFT TAKEN OVER BY DANGEROUS ALIENS. TYPE "1" TO
     1DESTROY IT.')
      READ(5,506,ERR=503,END=4321)K
506   FORMAT(I1)
      IF(K.EQ.1)GO TO 155
502   DO 50201 I=1,10
50201 ISHSTR(I)=0
      CALL GETBRG(SHDEG,SHX,XQE,SHY,YQE,VPX,VPY)
      IF (PSP.EQ.0)GO TO 50202
      DX=SIND(PDEG-SHDEG)*PSP/SHVX
      IF(DX*DX.GT.1)GO TO 50203
      DY=SQRT(1.-DX*DX)
      DX=ATAN2(DX,DY)*RADEGC
      SHDEG=DX+SHDEG
      IF(SHDEG.LT.0)SHDEG=SHDEG+360
      IF(SHDEG.GE.360)SHDEG=SHDEG-360
      GO TO 50202
50203 IF(ISTCC.EQ.98)GO TO 50205
      WRITE(6,50204)
50204 FORMAT(' SHUTTLECRAFT CANNOT CATCH THE ENTERPRISE AT ITS CURRENT S
     1PEED AND COURSE.')
      ISTCC=98
50205 SHX=SHX+COSD(SHDEG)*SHVX
      SHY=SHY+SIND(SHDEG)*SHVX
      GO TO 999
50202 SHX=SHX+COSD(SHDEG)*SHVX
C     ...CHECK FOR RETURN. PRINT FINDINGS.
      IF(ISHST.EQ.99)GO TO 505
      VPX=SQRT(VPX*VPX+VPY*VPY)/SHVX/100.
      WRITE(6,101)VPX
      ISTSH=99
505   SHY=SHY+SIND(SHDEG)*SHVX
      IF(RANGE(SHX,XQE,SHY,YQE).GE.RADES)GO TO 999
      WRITE(6,4)
4     FORMAT(' SHUTTLECRAFT RETURNED')
      JJ=0
      DO 550 J=1,NSTARS
      IF(IFNDS(J).LE.1)GO TO 550
      K=IFNDS(J)-1
      IFNDS(J)=-1
      GO TO (601,602,603,604,605,606,607,608,609,610,611,6115,612,613,61
     14,615,616),K
C     ...DISEASE.
601   IF(IDSES.EQ.1)GO TO 550
      WRITE(6,701)
701   FORMAT(' VIRULENT DISEASE RAMPAGING ON ENTERPRISE!')
      IDSES=1
      VDSES=RAN(IZZ)*VDSESM
      VSTRDS=RAN(IZZ)*.15+VSTRM
      GO TO 555
C     ...WARP DRIVE ACCELERATION INCREASE.
602   IF(DVWP.GE.1.)GO TO 6025
      XINC=DVWP+2.*DVWP*DVWP*RAN(IZZ)
      GO TO 6016
6025  XINC=DVWP+.3*DVWP*RAN(IZZ)
6016  IXRAT=PCT(XINC,DVWP)
      IF(IXRAT.EQ.0)GO TO 550
      WRITE(6,702)NAMD(1),IXRAT
702   FORMAT(' ',A10,' ACCELERATION INCREASED ',I3,'%')
C     ...REVISE ENERGY USAGE TO COMPENSATE FOR INCREASED ACCELERATION.
      VPY=IXRAT/100.
      VPX=EWRP
      EWRP=DVWP*DVWP*EWRP/(XINC*XINC)
      DVWP=XINC
      IXRAT=-PCT(VPX,EWRP0)
      EWRP0=EWRP/(1.-FLOAT(IXRAT)/100.)
C     ...ALSO INCREMENT DEG CHANGE/SM, ALTHOUGH NOT BY SO MUCH.
      DGWP=DGWP+RAN(IZZ)*DGWP/3.
      IF(DGWP.GT.90.)DGWP=90.
      GO TO 555
C     ...WAPR DRIVE EFFICIENCY.
603   XINC=EWRP-1.7*SQRT(EWRP)*RAN(IZZ)
      IXRAT=-PCT(XINC,EWRP)
      IF(IXRAT.EQ.0)GO TO 550
      WRITE(6,703)NAMD(1),IXRAT
703   FORMAT(1X,A10,' EFFICIENCY INCREASED BY ',I3,'%')
      EWRP=XINC
      EVENU=EVENU-IXRAT/100.*EVENU
      GO TO 555
C     ...PHASER IMPROVEMENT.
604   XINC=DISTPE+.5*SQRT(DISTPE)*RAN(IZZ)
      IXRAT=PCT(XINC,DISTPE)
      IF(IXRAT.EQ.0)GO TO 550
      WRITE(6,704)NAMD(3),IXRAT
704   FORMAT(1X,A10,' EFFECTIVENESS INCREASED BY ',I3,'%')
      DISTPE=XINC
      GO TO 555
C     ...TORP V INCREASE.
605   ETVEL=ETVEL+(.9-ETVEL)/5.
      WRITE(6,705)NAMD(4),ETVEL
705   FORMAT(1X,A10,' VELOCITY INCREASED TO ',F5.3)
      GO TO 555
C     ...TORP RATE OF FIRE.
606   IETOFT=IETOFT+1
      WRITE(6,706)NAMD(4),IETOFT
706   FORMAT(1X,A10,' RATE NOW ',I2,' PER STAR-MINUTE')
      GO TO 555
607   XINC=DISTGT+.5*SQRT(DISTGT)*RAN(IZZ)
      IXRAT=PCT(XINC,DISTGT)
      IF(IXRAT.EQ.0)GO TO 550
      WRITE(6,704)NAMD(5),IXRAT
      DISTGT=XINC
      DISTKR=DISTKR+IXRAT/100.*DISTKR
      GO TO 555
608   XINC=CODDS+CODDS*CODDS*5.*RAN(IZZ)
      IXRAT=PCT(XINC,CODDS)
      IF(IXRAT.EQ.0)GO TO 550
      WRITE(6,708)IXRAT
708   FORMAT(' TROOP FIGHTING EFFECTIVENESS VS KLINGONS INCREASED BY ',I
     13,'%')
      CODDS=XINC
      GO TO 555
609   XINC=EODDS+EODDS*EODDS*2.5*RAN(IZZ)
      IXRAT=PCT(XINC,EODDS)
      IF(IXRAT.EQ.0)GO TO 550
      WRITE(6,709)IXRAT
709   FORMAT(' TROOP FIGHTING EFFECTIVENESS VS ROMULANS INCREASED BY ',I
     13,'%')
      EODDS=XINC
      GO TO 555
C     ...TRANSPORTERS.
610   JDAMRP =FLOAT(IDAMRP)+2.*SQRT(FLOAT(IDAMRP))*RAN(IZZ)
      IF(JDAMRP.EQ.IDAMRP)GO TO 550
      IDAMRP=JDAMRP
      WRITE(6,706) NAMD(8),IDAMRP
      GO TO 555
C     ...COMMUNICATIONS.
611   XINC=PJAM-2.*PJAM*(PJAM)*RAN(IZZ)
      IXRAT=PCT(-XINC,-PJAM)
      IXRAT=-IXRAT
      IF(IXRAT.EQ.0)GO TO 550
      WRITE(6,710)NAMD(9),IXRAT
710   FORMAT(1X,A10,' INTERCEPTION PROBABILITY REDUCED BY ',I3,'%')
      PJAM=XINC
      GO TO 555
C     ...SHIELDS IMPROVEMENT.
6115  XINC=SHLDF+RAN(IZZ)*.2*SHLDF
      IXRAT=PCT(XINC,SHLDF)
      IF(IXRAT.EQ.0)GO TO 550
      WRITE(6,6112)IXRAT
6112  FORMAT(' SHIELDS IMPROVED BY ',I3 ,'%')
      SHLDF=XINC
      GO TO 555
C     ...ALIEN FORCE-HOSTILE
612   IF (IALSS.NE.0)GO TO 550
      IXRAT=RAN(IZZ)*40.+10.
      XINC=ENERGY/IXRAT/100.
      WRITE(6,712)J,IXRAT,XINC
712   FORMAT(' ALIEN BEINGS FROM STAR SYSTEM ',I1,' DRAINING'/      ' EN
     1TERPRISE ENERGY BANKS AT THE RATE OF ',I3,' UNITS/STARMINUTE'/
     1  ' ZERO ENERGY LEVEL IN ',F6.2,' STARDAYS!!')
      ALEDR=IXRAT
      IALIC=ICE
      IALJC=JCE
      IALSS=J
      GO TO 555
C     ...ENERGY FORMS
613   IF(NDRA.EQ.1)GO TO 550
      IF(IDMG(1).NE.0)GO TO 550
      WRITE(6,713)
713   FORMAT(' SEMI-SENTIENT ENERGY FORMS INVADING ENTERPRISE COMPUTER B
     1ANKS!'/      ' ENTERPRISE WARP DRIVE ENGINES UNDER ALIEN CONTROL!!
     1')
      NDRA=1
      DSP=RAN(IZZ)+1.
      JMSG=0
      DDEG=RAN(IZZ)*360.
      GO TO 555
C     ...TROOP REINFORCEMENTS.
614   IXRAT=RAN(IZZ)*NTROPS+1.
      WRITE(6,714)IXRAT,J
714   FORMAT(1X,I4,' ANDROID TROOP REINFORCEMENTS FROM FRIENDLY CIVILIZA
     1TION'/      ' ON STAR SYSTEM ',I1)
      ITRMEN(1)=ITRMEN(1)+IXRAT
      GO TO 555
C     ...IMPROVED TRANSPORTER ENERGY USAGE.
615   XINC=TRNRGY-RAN(IZZ)*TRNRGY*TRNRGY*.5
      IXRAT=-PCT(XINC,TRNRGY)
      IF(IXRAT.LE.0)GO TO 500
      WRITE(6,703)NAMD(8),IXRAT
      TRNRGY=XINC
      GO TO 555
C     ...MICROTRIBBLES.
616   SDAYS=RAN(IZZ)+1.
      WRITE(6,716)
716   FORMAT(' MICRO-TRIBBLES MULTIPLYING OUT OF CONTROL IN COMPUTER BAN
     1KS!!')
      IDMG(10)=IDMG(10)+SDAYS*100.
      GO TO 555
555   JJ=1
550   CONTINUE
      IF(JJ.EQ.1)GO TO 800
      WRITE(6,575)
575   FORMAT(' NOTHING OF VALUE FOUND THIS EXPLORATION')
800   ISTSH=0
      ISHD=0
999   RETURN
4321  STOP
C     ...RETURN NOT POSSIBLE.
996   WRITE(6,995)
995   FORMAT(' RETURN NOT POSSIBLE')
      GO TO 999
      END

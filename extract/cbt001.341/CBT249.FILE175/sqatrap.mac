//LL51289O JOB (LLSPS-X0569-9,00910),'DONALD J LOURIE',MSGCLASS=H,
//         NOTIFY=LL51289
//         EXEC PGM=IEFBR14
//DD1      DD  DISP=(OLD,DELETE),DSN=LLSPS.NUCLEUS
//S1       EXEC PGM=IEBCOPY,REGION=256K
//SYSPRINT DD  SYSOUT=*
//SYSUT3   DD  UNIT=REALD,SPACE=(CYL,(1))
//SYSUT4   DD  UNIT=REALD,SPACE=(CYL,(1))
//NUCLEUSI DD  DISP=SHR,DSN=SYS1.NUCLEUS
//NUCLEUSO DD  DISP=(,CATLG),DSN=LLSPS.NUCLEUS,UNIT=REALD,
//             SPACE=(CYL,(10,1,10)),DCB=(RECFM=U,BLKSIZE=19069)
//SYSIN    DD  *
 C I=NUCLEUSI,O=NUCLEUSO
 S M=((IEANUC01,IEANUC02))
//S2        EXEC ZAP,DSN='LLSPS.NUCLEUS',COND=(0,LT,S1)
************************************************************************
* NOTE:  ALTHOUGH THIS ZAP IS WRITTEN WITH SMP CONTROL                 *
*        STATEMENTS, IT IS RECOMMENDED THAT THE CONTROL                *
*        STATEMENTS BE REMOVED AND THE ZAP BE APPLIED                  *
*        TO AN ALTERNATE NUCLEUS VIA SUPERZAP.  NOTE ALSO              *
*        THAT THE NAME STATEMENTS SPECIFYING IEANUC01 WILL             *
*        HAVE TO BE CHANGED TO THE NAME OF THE ALTERNATE               *
*        NUCLEUS YOU HAVE BUILT                                        *
************************************************************************
*                                                                      *
*                                                                      *
* THIS ZAP WILL BUILD A FOUR WORD TRAILER BLOCK AT THE END OF EACH     *
* GETMAIN AREA IN SUBPOOLS 245, 227, 228, AND 239.                     *
*                                                                      *
*                                                                      *
*  TWO EXCEPTIONS:                                                     *
*  - IF AN AREA GETMAINED IN ONE BLOCK IS LATER FREEMAINED IN PARTS,   *
*    THE TRAILER WILL DISAPPEAR WHEN THE LAST PART OF THE BLOCK IS     *
*    IS FREEMAINED.  THEREFORE, THE TRAILER CAN DISAPPEAR PREMATURELY  *
*                                                                      *
*  - IF THE REQUEST IS FOR A MULTIPLE OF A PAGE, (I.E. 1000, 2000,     *
*    3000 BYTES, ETC), THE TRACE WILL NOT ADD ON X'10' BYTES BUT       *
*    BUILDS THE TRAILER IN THE LAST X'10' BYTES OF THE REQUESTED       *
*    GETMAINED AREA.  SO IF THE REQUESTOR DOES NOT USE THE LAST        *
*    X'10' BYTES OF THE GETMAINED AREA YOU WILL FIND THE TRAILER.      *
*    BUT IF HE ZEROES OR USE THE LAST X'10' BYTES OF THE GETMAINED     *
*    AREA, THE TRAILER WILL BE MISSING.                                *
*                                                                      *
* THE TRAILER CONSISTS OF THE FOLLOWING INFORMATION:                   *
*  +0  X'FE' AS AN EYECATCHER (TESTED BY FREEMAIN HOOK)                *
*  +1  RETURN ADDRESS IF BRANCH REQUEST AND SVC ADDR. IF SVC REQUEST   *
*  +4  FIRST FOUR BYTES OF JOBNAME/INITNAME OF REQUESTOR               *
*  +8  LENGTH OF REQUEST (INCLUDING THE TRAILER)                       *
*  +C  EYE CATCHER "EYE"                                               *
************************************************************************
*                                                                      *
* CHANGE ACTIVITY                                                      *
* 80/03/20 TESTED                                                      *
* 80/04/10 MODIFIED VERS AND REPS TO IEAVGM00 AND MODIFIED THE VERS    *
*        AND REPS FROM 08C4 THRU 08F8.  ALSO MODIFIED REPS AT 08B0     *
*        AND 0822.  THE CHANGES WERE MADE SINCE A REQUEST FOR EXACTLY  *
*        X'1000' BYTES IN SQA WILL GET THE STORAGE ON A PAGE BOUNDARY  *
*        SINCE THIS TRACE ADDED X'10' BYTES, THE STORAGE WAS NOT BEING *
*        RETURNED ON A PAGE BOUNDARY.                                  *
* 80/07/17 MODIFIED REP AT 08C4, 08D4, 08D8, 0886, 088A AND ADDED      *
*        NEW CODE AT X'8FC' THRU X'92C' SO THAT THIS TRACE COULD BE    *
*        USED TO BUILD TRAILERS FOR SUBPOOLS 245, 227, 228, AND 239    *
*        ALSO.                                                         *
* 80/11/18 MODFIED REPS AT 0822, 0886,08B0,08C4, AND 08CC THRU 0928    *
*        DUE TO A PROBLEM IN THAT AN AQE FOR AN EXACT PAGE WAS NOT     *
*        BEING ADDED TO THE GETMAIN REQUEST.                           *
* 81/01/23 ADDED VERS AND REPS FOR PTF LEVEL UZ34680.                  *
* 81/06/23 ADDED SUPPORT FOR UZ35461.
* 81/09/17 ADDED SUPPORT FOR UZ36943.
************************************************************************
NAME IEANUC02 IEAVGM00
VER 0B48 9140,4011            AQE REQUESTED?
VER 0B4C 0789                 NO RETURN
VER 0B52 4770,847E            BRANCH IF NOT 4K REQUEST
VER 0E50 91C0,41FA            LIST REQUESTED?
VER 10D4 4590,8462            GO TO ROUND ROUTINE
REP 0B48 9141,4011            AQE AND SQA REQUESTED?
REP 0B52 47F0,08C4          * SPECIAL 4K CASE GO TO PATCH3
REP 0E50 47F0,0800          * END OF GETMAIN GO TO PATCH1
REP 10D4 4590,0870          * GO TO PATCH2 FOR FREEMAIN
IDRDATA *SQAV3
*
NAME IEANUC02 IEAVFX00
* PATCH1
REP 0800 9101,4011            SQA REQUEST ?
REP 0804 4770,0810          * YES BYPASS RETURN
REP 0808 91C0,41FA            RESTORE OVERLAYED INSTRUCTION
REP 080C 47F0,8778            RETURN TO IEAVGM00
REP 0810 12E2                 ANY AREA ?
REP 0812 4780,0808          * IF 0 RETURN
REP 0816 1EEA                 ADD LENGTH
REP 0818 41F0,0010            SET X'10' IN REG F
REP 081C 1FEF                 SUBTRACE X'10' TO BUILD TRAILER
REP 081E 92FE,E000            MOVE IN EYE CATCHER
REP 0822 D203,E00C,0938     * MOVE IN "EYE" CATCHER
REP 0828 58F0,0224            GET PSAAOLD
REP 082C 9500,F0AD            IS THERE AN ADDRESS POINTING TO JOBNAME?
REP 0830 41F0,F0AC            INITIALIZE REG F TO POINT TO ASCB + AC
REP 0834 4770,083C          * YES, THEN BRANCH AROUND
REP 0838 41F0,F004            NO, GET ASCB + B0 FOR STC NAME
REP 083C 58F0,F000            LOAD ADDRESS
REP 0840 D203,E004,F000       MOVE 4 CHARS JOBNAME
REP 0846 50A0,E008            SAVE LENGTH
REP 084A 9101,4010            IS IT BRANCH ENTRY ?
REP 084E 4710,0864          * YES BRANCH
REP 0852 58F0,021C            GET TCB OLD ADDR.
REP 0856 58F0,F000            GET RB ADDRESS
REP 085A D202,E001,F015       COPY PSW ADDRESS
REP 0860 47F0,0808          * RETURN
REP 0864 D202,E001,4245       GET RETURN ADD
REP 086A 47F0,0808          * RETURN
* PATCH2
REP 0870 4160,0007            GET 7
REP 0874 1AA6                 LENGTH + 7
REP 0876 16A6                 OR TO FORCE '7'
REP 0878 17A6                 EXCLUSIVE OR TO ROUND
REP 087A 9101,4011            SQA REQUEST ?
REP 087E 4780,08A6          * NO BYPASS FAKING
REP 0882 186B                 GET START OF AREA
REP 0884 1E6A                 ADD LENGTH
REP 0886 47F0,0910            CHECK TO MAKE SURE PAGE IS VALID
REP 088A 4770,08A6          * NO, BYPASS
REP 088E 41A0,A010            YES, ADD X'10' TO FREE TRAILER
REP 0892 59A0,6008            ARE LENGTHS EQUAL?
REP 0896 4770,08A0          * NO, BRANCH
REP 089A D70F,6000,6000       CLEAR OUT TRAILER
REP 08A0 D703,600C,600C       CLEAR ONLY "EYE" CATCHER
REP 08A6 4160,0007            GET 7 FOR RETURN
REP 08AA 9140,4011            AQE REQUEST ?
REP 08AE 0789                 NO RETURN
REP 08B0 59A0,0930          * COMPARE WITH 4K VALUE
REP 08B4 4770,08BC          * NOT SAME BRANCH
REP 08B8 9680,4011            SET 4K REQUEST
REP 08BC 41AA,0008            +1 FOR AQE
REP 08C0 07F9                 RETURN
* PATCH3
REP 08C4 4770,08D2          * IF REQUEST NOT ONE PAGE, BRANCH
REP 08C8 9140,4011            AQE REQUEST?
REP 08CC 4710,847A            YES, BRANCH TO ADD AQE LENGTH
REP 08D0 07F9                 NO, RETURN
REP 08D2 5860,0934          * GET "ANDING" VALUE
REP 08D6 146A                 TURN OFF LOWER BYTES AND HALF
REP 08D8 156A                 WAS THE REQUEST A PAGE MULTIPLE?
REP 08DA 4770,08EA          * NO, CONTINUE ON
REP 08DE 9140,4011            WAS AN AQE REQUESTED?
REP 08E2 0789                 NO, RETURN WITHOUT ADDING X'10' BYTES
REP 08E4 41AA,0008            YES, ADD X'8' BYTES FOR AQE
REP 08E8 07F9                 RETURN TO CALLER
REP 08EA 9140,4011            IS AN AQE NEEDED?
REP 08EE 4710,08F8          * YES, BRANCH TO ADD X'18' BYTES
REP 08F2 41A0,A010            NO, ADD X'10' BYTES TO REQUESTED SIZE
REP 08F6 07F9                 RETURN TO CALLER
REP 08F8 9101,4011            IS THIS A SQA REQUEST?
REP 08FC 4780,847E            NO RETURN TO IEAVGM00
REP 0900 41A0,A018            YES, ADD X'18' BYTES TO REQUESTED SIZE
REP 0904 07F9                 RETURN TO CALLER
* PATCH 4
REP 0910 B100,6000            IS THE SEGMENT/PAGE VALID?
REP 0914 4770,08A6          * NO, DO NOT ADD X'10' BYTES
REP 0918 95FE,6000            IS THIS MY TRAILER ID?
REP 091C 4770,08A6          * NO, DO NOT ADD X'10' BYTES
REP 0920 47F0,088E            RETURN TO MAILINE CODE
* CONTANTS
REP 0930 0000,1000            4K CONSTANT
REP 0934 FFFF,F000            "ANDING" MASK
REP 0938 C5E8,C5D0            "EYE" CATCHER CONSTANT
IDRDATA *SQAV3
*
* *** THE ASTERISKS PRECEEDING A COMMENT INDICATES AN INSTRUCTION TO
//SPF      EXEC PGM=IEBCOPY,REGION=256K,COND=(0,LT)
//SYSPRINT DD  SYSOUT=*
//SYSUT3   DD  UNIT=REALD,SPACE=(CYL,(1))
//SYSUT4   DD  UNIT=REALD,SPACE=(CYL,(1))
//NUCLEUSI DD  DISP=SHR,DSN=SYS1.NUCLEUS
//NUCLEUSO DD  DISP=SHR,DSN=LLSPS.NUCLEUS
//SYSIN    DD  *
 C I=NUCLEUSO,O=NUCLEUSI
 S M=(IEANUC02)

      SUBROUTINE ANLT (NAME, DATE, WORK, SIZE)
C
C   ROUTINE ANALYSES TRACE TABLE ENTRIES
C     VERSION AS OF 13 AUG 1981
C
      COMMON /OPTION/ ISTRM, GRAPH, LIST
      INTEGER*4 SIZE, SVCNO, TIME, TOD
      INTEGER*4 WORK(SIZE)
      INTEGER*4 TYPE(9)/'SIO ','EXT ','SVC ','PGM ','ISD ','I/O ',
     *'SSR ','DSP ','ALL '/
      REAL*8 DATE, ACTIVE
      LOGICAL*4 GRAPH, LIST, LSVCS
      INTEGER SVCS(256), BEGIN, NOW, GAP/Z00004000/
      REAL SAMPLE
      LOGICAL*1 NOMAP, FIRST, LTIME(4), LTTIME(4)
      INTEGER*4 NAME, IDATA(8), LENGTH/8/
      INTEGER*2 IDAT(16)
      EQUIVALENCE (IDATA(1),TIME), (TIME,LTIME(1)), (TOD,LTTIME(1)),
     * (IDAT(1),IDATA(1))
      REAL*8 PNAME  /'ANLT    '/
      REAL*8 KLSVCS /'LISTSVCS'/
      REAL*8 KSTART /'START=  '/
      REAL*8 KSTOP  /'STOP=   '/
      REAL*8 KWIND  /'WINDOW= '/
      INTEGER START, STOP, WINDOW
      WRITE (8,6100) DATE
 6100 FORMAT ('0TRACE TABLE AVERAGES ON ',A8,/,1X)
      WRITE (6,6110) DATE
 6110 FORMAT ('1TRACE TABLE ANALYSIS ON ',A8)
C   FOR EACH ASID, NEED JOB NAME AND EVENT COUNTS
      NEED = 11
C
C   GET PARAMETERS FOR TRACE TABLE ANALYSIS
C
      LSVCS = .FALSE.
      NOMAP = .TRUE.
      CALL INPUT (PNAME, WORK, J)
      CALL ENDPDS
      IF (J .NE. 0) GO TO 1120
      CALL FNDPRS (80, WORK, 8, KLSVCS, LSVCS)
      IF (LSVCS) NEED = NEED + 256
      CALL FNDHEX (80, WORK, 6, KSTART, I, START)
      CALL FNDHEX (80, WORK, 5, KSTOP, J, STOP)
      CALL FNDHEX (80, WORK, 7, KWIND, K, WINDOW)
      WRITE (6,9999) START, STOP, WINDOW
 9999 FORMAT ('0TRACE TABLE ANALYSIS PARAMETERS ',3I12)
      IF ((STOP .LE. START) .OR. (WINDOW .LE. 0)) GO TO 1120
      NBUCKS = (STOP - START - 1)/WINDOW + 1
      IF ((NEED + NBUCKS) .GT. SIZE) GO TO 1120
      NOMAP = .FALSE.
      IBUCK1 = NEED
      LOCCNT = 0
      NEED = NEED + NBUCKS
 1120 IASID = -1
      LASID = -1
C        THIS MEANS START WITH TOTAL SYSTEM ANALYSIS
C        THEN PROCEED WITH ADDRESS SPACES IN ASCENDING ASID ORDER
      DO 1130 I = 1, 256
 1130 SVCS(I) = 0
      MAXASI = 0
      NASP = SIZE / NEED
      ACTIVE=0.
      GO TO 1150
 1140 CONTINUE
      IASID = LASID + 1
      IF (IASID .GT. MAXASI) GOTO 1500
      LASID = MIN0 (MAXASI, IASID + NASP - 1)
 1150 M = (LASID - IASID + 1) * NEED
      DO 1160 I = 1, M
      WORK(I) = 0
 1160 CONTINUE
C
C   REWIND DATA SET
C
      IFLAG = -1
      CALL MONRD (NAME, LENGTH, IDATA, IFLAG)
      IF (IFLAG .GT. 0) GO TO 1600
      FIRST = .TRUE.
 1200 CONTINUE
      IFLAG = 0
      CALL MONRD (NAME, LENGTH, IDATA, IFLAG)
      IF (IFLAG .GT. 0) GO TO 1300
      K = IDAT(4)
      IF (IASID .NE. -1) GO TO 1210
      IF (K .GT. MAXASI) MAXASI = K
      INDEX = 1
      IF (.NOT. FIRST) GO TO 1220
      FIRST = .FALSE.
      JBUCK = INDEX + IBUCK1
      GO TO 1230
 1210 CONTINUE
      IF (K .LT. IASID) GO TO 1200
      IF (K .GT. LASID) GO TO 1200
      INDEX = NEED * (K - IASID) + 1
      JBUCK = INDEX + IBUCK1
      IF (WORK(INDEX) .NE. 0) GO TO 1220
      WORK(INDEX) = IDATA(4)
      WORK(INDEX+1) = IDATA(5)
      GOTO 1230
 1220 CONTINUE
C     IF (WORK(INDEX) .NE. IDATA(4)
C     IF (WORK(INDEX+1) .NE. IDATA(5)
      IF (TOD .EQ. TIME) GO TO 1240
      IF (IDAT(3) .LT. GAP) GO TO 1235
      IDAT(3) = IDAT(3) - GAP
      IF (IASID .NE. -1) GO TO 1230
C       BIT 51 OF THE TIME OF DAY CLOCK = 1 MICROSECOND
C       BITS 24-55 OF TOD CLOCK ARE STORED IN TRACE TABLE
C       HENCE THE LOW BIT = 1/16 MICROSECOND
      ACTIVE = ACTIVE + (NOW - BEGIN) / 16E6
C       CHECK FOR TIMER WRAPAROUND IN TRACE TABLE
C       IF SO, FIXED POINT OVERFLOW WILL OCCUR BUT IS MASKED OFF
C       SO THE RESULT OF THE PRECEDING STATEMENT WILL BE CORRECT
C       AND THE FOLLOWING STATEMENT IS NOT NEEDED
C     IF (NOW .LT. BEGIN) ACTIVE = ACTIVE + 268.435456
 1230 CONTINUE
      BEGIN = IDATA(3)
 1235 TOD = TIME
      IF (.NOT. LIST) GO TO 1240
      WRITE (6,6120) LTTIME, DATE
 6120 FORMAT ('0TRACE TABLE ANALYSIS AT ',3(Z2,'.'),Z2,' ON ',A8)
      WRITE (6,6130)
 6130 FORMAT ('0TYPE  ASID    TIME    JOBNAME          PSW',
     *'           CSW',/,1X)
 1240 CONTINUE
      IF (IDAT(3) .NE. 2) GO TO 1260
      SVCNO = IDAT(12) - 8191
      IF (SVCNO .LE. 0 .OR. SVCNO .GT. 256) GO TO 1260
      IF (IASID .NE. -1) GO TO 1250
      SVCS(SVCNO) = SVCS(SVCNO) + 1
      GO TO 1260
 1250 IF (.NOT. LSVCS) GO TO 1260
      I = INDEX + 10 + SVCNO
      WORK(I) = WORK(I) + 1
 1260 CONTINUE
      NOW = IDATA(3)
      I = INDEX + IDAT(3) + 2
      WORK(I) = WORK(I) + 1
      WORK(INDEX+10) = WORK(INDEX+10) + 1
      IF (NOMAP) GO TO 1280
      IF (IDAT(3) .NE. 5) GO TO 1280
      I = MOD (IDATA(7), 16777216)
      IF (I .LT. START) GO TO 1275
      J = (I - START) / WINDOW
      IF (J .LE. NBUCKS) WORK (JBUCK + J) = WORK (JBUCK + J) + 1
 1275 IF (IASID .EQ. -1) LOCCNT = LOCCNT + 1
 1280 IF (.NOT. LIST) GO TO 1200
      WRITE (6,6210) TYPE(IDAT(3)+1), K, (IDATA(I),I=3,7)
 6210 FORMAT (1X,A4,2X,I3,3X,Z8,2X,2A4,2X,Z8,1X,Z8)
      IF(IDAT(3).NE.7.AND.(IDAT(3).GT.3.OR.IDAT(3).LT.1))
     * WRITE (6,6220) IDATA(8)
 6220 FORMAT ('+',51X,Z8)
      GO TO 1200
 1300 CONTINUE
      IF (IASID .NE. -1) GO TO 1310
C       THE FOLLOWING CODE IS EXPLAINED ABOVE
      ACTIVE = ACTIVE + (NOW - BEGIN) / 16E6
C       AS IS THE DELETION OF THE FOLLOWING
C     IF (NOW .LT. BEGIN) ACTIVE = ACTIVE + 268.435456
 1310 CONTINUE
      DO 1380 K = IASID, LASID
      INDEX = NEED * (K - IASID) + 1
      WRITE (6,6300)
 6300 FORMAT ('0FREQUENCY OF EVENTS')
      IF (IASID .NE. -1) WRITE (6,6301) K, WORK(INDEX), WORK(INDEX+1)
 6301 FORMAT ('+',20X,'FOR ASID = ',I3,8X,2A4)
      WRITE (6,6302)
 6302 FORMAT (1X)
      DO 1320 I = 1,9
      J = INDEX + I + 1
      IF (WORK(J) .EQ. 0) GO TO 1320
      TEMP = WORK(J) / ACTIVE
      IF (IASID .EQ. -1) WRITE (8,6303) TYPE(I), TEMP, WORK(J)
      WRITE (6,6303) TYPE(I), TEMP, WORK(J)
 6303 FORMAT (4X,A4,4X,F6.1,2X,' PER SECOND (SAMPLE SIZE = ',I8,')')
 1320 CONTINUE
      IF ((.NOT. LSVCS) .OR. IASID .EQ. -1) GO TO 1340
      WRITE (6,6302)
      DO 1330 I = 1,256
      L = WORK (INDEX + 10 + I)
      IF (L .EQ. 0) GO TO 1330
      J = I - 1
      TEMP = (100.0 * L) / SVCS(I)
      WRITE (6,6350) J, L, TEMP
 6350 FORMAT (' SVC',I4,'   COUNT =',I7,3X,F6.2,' PER CENT')
 1330 CONTINUE
 1340 IF (NOMAP) GO TO 1380
      SAMPLE = LOCCNT
      JBUCK = INDEX + IBUCK1
      WRITE (6,6400)
 6400 FORMAT ('0   START     STOP     COUNT   PERCENT')
      L = START
      M = START + WINDOW - 1
      DO 1360 I = 1,NBUCKS
      J = WORK (JBUCK + I - 1)
      IF (J .EQ. 0) GO TO 1355
      TEMP = (J * 100) / SAMPLE
      WRITE (6,6410) L, M, J, TEMP
 6410 FORMAT (2Z10,I8,F10.4)
 1355 L = L + WINDOW
      M = M + WINDOW
 1360 CONTINUE
 1380 CONTINUE
      GO TO 1140
 1500 CONTINUE
      WRITE (6,6500) DATE
 6500 FORMAT ('1SVC COUNTS ON ',A8,/,1X)
      DO 1520 I=1,256
      IF (SVCS(I) .EQ. 0) GO TO 1520
      J = I - 1
      WRITE (6,6510) J,SVCS(I)
 6510 FORMAT (' SVC',I4,'   COUNT = ',I6)
 1520 CONTINUE
      WRITE (6,6900)
 6900 FORMAT ('0END OF TRACE TABLE ANALYSIS')
      WRITE (8,6900)
 1600 CONTINUE
      RETURN
      END

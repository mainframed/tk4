      SUBROUTINE ANLP (NAME, DATE, WORK, SIZE, MODULE)
      COMMON /OPTION/ ISTRM, GRAPH, LIST
      DIMENSION IDATA(7)
      REAL*8 VIO /'*VIO    '/
      REAL*8 DATE
      REAL*8 MODL(10)
      REAL*8 MODT
      REAL*8 MODULE(2500), NULL /'        '/
      INTEGER IT4, LIMSKS(7), SIZE
      INTEGER ISTEP /4/
      INTEGER VBMAX, VBMIN, VBSTEP
      INTEGER TYPE, ASID
      INTEGER*2 IG2, NG2, ANAX(11), IFLGS(2)
      INTEGER*2 WORK(SIZE)
      INTEGER*2 IT2(2), NT2(2), IDAT(14), VBN, FIX, IFLG1, IFLG2
      REAL*8 JOBNAM, IJOB
      REAL TOTALS(7)
      INTEGER ICNTS(7)
      LOGICAL LFLAGS /Z8000FF00/
      LOGICAL GRAPH, LIST
      LOGICAL PMSK, LMSKS(7)
      LOGICAL PLOT/.TRUE./,ILG,MSKS(4),ANY,FIRST/.TRUE./,PAGE/.FALSE./
      LOGICAL*1 INDIC(2500), BLNK /' '/, AST /'*'/, LINE(100)
      LOGICAL*1 MINUS /'-'/
      LOGICAL*1 LTIME(4), LTTIME(4)
      LOGICAL*1 PLINE(110), NOS(16)
      LOGICAL*1 IG1(2), NG1(2)
      DATA NOS /'F','E','D','C','B','A','9','8','7','6','5','4','3',
     * '2','1',' '/
      EQUIVALENCE (LTIME(1),TIME), (LTTIME(1),TTIME)
      EQUIVALENCE (ITMP,ILG), (NT2(1),NT4), (IT2(1),IT4)
      EQUIVALENCE (IDATA(1),IDAT(1)), (IDATA(1),TIME), (IDATA(2),TYPE),
     * (IDATA(3),JOBNAM), (IDATA(5),ASID), (IDAT(11),VBN),
     * (IDAT(12),FIX), (IDAT(13),IFLG1), (IDAT(14),IFLG2)
      EQUIVALENCE (PMSK,IFLGS(1)), (LIMSKS(1),LMSKS(1))
      EQUIVALENCE (IG2,IG1(1)), (NG2,NG1(1))
      DATA ITOP /Z00008800/
      DATA MSKS /Z0000F000,Z00000F00,Z000000F0,Z0000000F/
      DATA LMSKS /Z0000FF00,Z00008400,Z00008000,Z00000C00,
     * Z00000800,Z00000400,Z80000000/
      DATA LENGTH /7/
C
C   ROUTINE WRITES OUT RECORDS WRITTEN BY MONP
C
C  INDEX IN  INDEX IN   FIELD IN    SOURCE     OUTPUT
C   IDATA      IDAT     MONP LOG     FIELD    IDENTIFICATION
C
C       1               TIME
C       2               TYPE
C     3,4               JOBNAME
C       5               ASID
C                11     VBN
C                12     FIX
C       7               FLAGS
C
C   FIRST PASS OVER THE LOG TAPE DOES THE FOLLOWING:
C
C    1. WRITE OUT TYPE 0 RECORDS - JOBNAME NOT FOUND
C    2. FIND HIGHEST ASID PRESENT - STORE IN MAXASI
C    3. FOR EACH ASID FROM -1 TO MAXASI, FIND
C      3A. MINIMUM AND MAXIMUM VBN'S (VIRTUAL BLOCK NUMBERS)
C      3B. THE MAXIMUM NUMBER OF PAGE FRAMES BELONGING TO THE
C           ADDRESS SPACE IN ANY SINGLE SNAPSHOT
C    4. CARVE UP WORK AS FOLLOWS:
C      4A. 4 HALFWORD VARIABLES FOR EACH ASID FROM -1 TO MAXASI:
C           MINIMUM VBN
C           MAXIMUM VBN
C           PAGE FRAME COUNTER
C           INDEX INTO WORK FOR STORING DATA ABOUT EACH PFTE
C      4B. ALLOW 4 HALFWORDS FOR EACH VBN IN THE LARGEST SNAPSHOT
C           FOR A PARTICULAR ADDRESS SPACE, USED FOR
C           VBN
C           FIX COUNT
C           4 BYTES OF FLAGS
C      4C. USE THE REMAINDER OF WORK FOR COUNTS
C
      MAXASI = -2
      ISIZE = SIZE * 2
C
C   ***********************************
C
C   REWIND THE LOG TAPE TO BEGIN
C
C   ***********************************
      IFLAG = -1
      CALL MONRD (NAME, LENGTH, IDATA, IFLAG)
      IF (IFLAG .GT. 0) GOTO 5678
      WRITE (6,6100)
 6100 FORMAT ('1MVS PAGING ANALYSIS')
      WRITE (6,6101)
 6101 FORMAT (' --- ------ --------',/,1X)
      IFLAG = 0
  111 CONTINUE
C   ***********************************
C
C   READ LOG RECORDS FOR FIRST PASS
C
C   ***********************************
      CALL MONRD (NAME, LENGTH, IDATA, IFLAG)
      IF (IFLAG .GT. 0) GOTO 150
      IF (TYPE .EQ. 1) GOTO 123
      IF (TYPE .NE. 0) GOTO 111
      WRITE (6,6300) LTIME, JOBNAM
 6300 FORMAT (3X,3(Z2,'.'),Z2,'   PROGRAM ',A8,' WAS NOT FOUND')
      GOTO 111
  123 INDEX = ISTEP * (ASID + 1) + 1
      IF (ASID .LE. MAXASI) GOTO 129
      IST = ISTEP * (MAXASI + 2) + 1
      IEND = INDEX + ISTEP - 1
      DO 126 I = IST, INDEX, 4
      WORK(I+1) = 0
      WORK(I+2) = 0
      WORK(I+3) = 0
  126 WORK(I) = 32767
      MAXASI = ASID
  129 IF (.NOT. FIRST) GOTO 132
      TTIME = TIME
      FIRST = .FALSE.
  132 IF (TIME .NE. TTIME) GOTO 150
  135 WORK(INDEX+2) = WORK(INDEX+2) + 1
      IF (VBN .LT. WORK(INDEX)) WORK(INDEX) = VBN
  139 IF (VBN .GT. WORK(INDEX+1)) WORK(INDEX+1) = VBN
      GOTO 111
  150 CONTINUE
      IEND = MAXASI + 2
      INDEX = 1
      DO 159 I = 1,IEND
      IF (WORK(INDEX+2).GT.WORK(INDEX+3)) WORK(INDEX+3)=WORK(INDEX+2)
      WORK(INDEX+2) = 0
  159 INDEX = INDEX + ISTEP
      IF (IFLAG .EQ. 0) GOTO 135
C
C   ***********************************
C
C   WRITE OUT TYPE 1 RECORDS - PFTE'S
C
C   ***********************************
C
      IST = ISTEP * (MAXASI + 2) - 3
      IASID = -1
  200 CONTINUE
      IF (IASID .GT. MAXASI) GOTO 4000
      INDEX = ISTEP * (IASID + 1) + 1
      IF (WORK(INDEX+3) .GT. 0) GOTO 217
  214 IASID = IASID + 1
      GOTO 200
  217 CONTINUE
C
C   REWIND LOG TAPE TO PROCESS IASID
C
      PLOT = .TRUE.
      ANY = .FALSE.
      FIRST = .TRUE.
      IFLAG = -1
      CALL MONRD (NAME, LENGTH, IDATA, IFLAG)
      IF (IFLAG .GT. 0) GOTO 5678
      IFLAG = 0
C
C   SET COUNTERS TO ZREO
C
      IPGCT = 0
      NCALLS = 0
      DO 271 I = 1,7
      TOTALS(I) = 0
      ICNTS(I) = 0
  271 CONTINUE
      TOTPGC = 0.
      VBMIN = (WORK(INDEX) / 16) * 16
      VBMAX = (WORK(INDEX+1) / 16) * 16 + 15
      ICNTF = IST + 4 * WORK(INDEX+3) + 3
      MAXVB = MIN0((ISIZE - ICNTF), (VBMAX - VBMIN + 1))
      DO 294 I = 1, MAXVB
  294 WORK(ICNTF+I) = 0
C
C   SET MODULE NAMES TO BLANKS
C
      IF (IASID .NE. -1) GOTO 336
      DO 322 I = 1,2500
      MODULE(I) = NULL
      INDIC(I) = BLNK
  322 CONTINUE
      CALL MAPLPA (MODULE, INDIC, VBMIN)
  336 CONTINUE
      IF (.NOT. LIST) WRITE (6,6102)
      FIRST = .TRUE.
C
C   WRITE OUT PFTE AT ANY ONE TIME
C
 1000 CONTINUE
      CALL MONRD (NAME, LENGTH, IDATA, IFLAG)
      IF (IFLAG .GT. 0) GOTO 1366
      IF (TYPE .NE. 1) GOTO 1000
      IF (IASID .EQ. 0 .AND. JOBNAM .EQ. VIO) GOTO 1099
      IF (ASID .NE. IASID) GOTO 1000
 1099 CONTINUE
      IF (.NOT. FIRST) GOTO 1188
C
C   SET UP FOR FIRST PFTE
C
      IJOB = JOBNAM
      TTIME = TIME
      FIRST = .FALSE.
 1188 CONTINUE
      IF (TTIME .NE. TIME) GOTO 1366
 1277 CONTINUE
      IPGCT = IPGCT + 1
      I = IST + IPGCT * 4
      WORK(I) = VBN
      WORK(I+1) = FIX
      WORK(I+2) = IFLG1
      WORK(I+3) = IFLG2
      GOTO 1000
 1366 CONTINUE
      NCALLS = NCALLS + 1
C
C   NEW TIME - SORT AND WRITE/PLOT
C   NO REAL NEED TO SORT EXCEPT FOR PLPA
C   IN WHICH CASE, USE A SHELL SORT ALGORITHM
C
C     IF (IASID .NE. -1 .OR. IPGCT .LE. 1) GO TO 1500
      IF (IPGCT .LE. 1) GO TO 1500
      IEND = IST + 4 * IPGCT
      II = IPGCT / 2
      LCT = 6737
 1455 IF (LCT .LE. II) GO TO 1461
      LCT = (3 * LCT) / 7
      GO TO 1455
 1461 LCT = 4 * LCT
 1464    CONTINUE
      DO 1492 I = 4,LCT,4
      JJ = IST + I
      GO TO 1480
 1466 IF (WORK(II) .LE. WORK(JJ)) GOTO 1480
      ANAX(1) = WORK(JJ)
      ANAX(2) = WORK(JJ+1)
      ANAX(3) = WORK(JJ+2)
      ANAX(4) = WORK(JJ+3)
 1469 WORK(II+LCT) = WORK(II)
      WORK(II+LCT+1) = WORK(II+1)
      WORK(II+LCT+2) = WORK(II+2)
      WORK(II+LCT+3) = WORK(II+3)
      II = II - LCT
      IF (II .LE. IST) GOTO 1477
      IF (WORK(II) .GT. ANAX(1)) GOTO 1469
 1477 WORK(II+LCT) = ANAX(1)
      WORK(II+LCT+1) = ANAX(2)
      WORK(II+LCT+2) = ANAX(3)
      WORK(II+LCT+3) = ANAX(4)
 1480 II = JJ
      JJ = II + LCT
      IF (JJ .LE. IEND) GOTO 1466
 1492 CONTINUE
      LCT = ((3 * LCT) / 28) * 4
      IF (LCT .GE. 4) GOTO 1464
 1500 CONTINUE
C
C   INCREMENT COUNT FOR HISTOGRAM
C
      II = IST
      IPCT = 1
      PAGE = .TRUE.
      DO 2000 I = 1,IPGCT
      II = II + 4
      IMOD = WORK(II) - VBMIN + 1
      IF (IMOD .GT. MAXVB) GOTO 1600
      WORK(ICNTF+IMOD) = WORK(ICNTF+IMOD) + 1
 1600 CONTINUE
      IF (.NOT. LIST) GOTO 1800
      IF (.NOT. PAGE) GOTO 1755
C
C   WRITE OUT FULL LIST OF PFTE'S
C
      WRITE (6,6102)
 6102 FORMAT (1H1)
      WRITE (6,6105) IPCT
 6105 FORMAT ('  TYPE     TIME      JOBNAME  ASID  VBN  FIX   FLAGS',
     * 45X,'PAGE ',I3)
      WRITE (6,6106)
 6106 FORMAT ('  ----     ----      -------  ----  ---  ---   -----',
     * 45X,'--------',/,1X)
      IPCT = IPCT + 1
      PAGE = .FALSE.
 1755 CONTINUE
      WRITE (6,6000) TYPE, LTTIME, IJOB, IASID, WORK(II), WORK(II+1),
     * WORK(II+2), WORK(II+3)
 6000 FORMAT (3X,I2,3X,3(Z2,'.'),Z2,2X,A8,2X,I2,2X,Z4,2X,I2,3X,2Z4)
 1800 CONTINUE
C
C   CHECK FOR TYPE OF PFTE
C
      IFLGS(1) = WORK(II+2)
      IFLGS(2) = WORK(II+3)
      ILG = PMSK .AND. LFLAGS
      DO 1888 J = 1,7
      IF (ITMP .NE. LIMSKS(J)) GOTO 1888
      ICNTS(J) = ICNTS(J) + 1
      IF (.NOT. LIST) GOTO 1888
      GOTO (1821,1822,1823,1824,1825,1826,1827),J
 1821 IF (J .EQ. 1) WRITE (6,6501)
 6501 FORMAT ('+',65X,'NOT QUEUED')
      GOTO 1888
 1822 IF (J .EQ. 2) WRITE (6,6502)
 6502 FORMAT ('+',65X,'LSQA')
      GOTO 1888
 1823 IF (J .EQ. 3) WRITE (6,6503)
 6503 FORMAT ('+',65X,'LOCAL')
      GOTO 1888
 1824 IF (J .EQ. 4) WRITE (6,6504)
 6504 FORMAT ('+',65X,'SQA')
      GOTO 1888
 1825 IF (J .EQ. 5) WRITE (6,6505)
 6505 FORMAT ('+',65X,'COMMON')
      GOTO 1888
 1826 IF (J .EQ. 6) WRITE (6,6506)
 6506 FORMAT ('+',65X,'SQA RESERVED')
      GOTO 1888
 1827 IF (J .EQ. 7) WRITE (6,6507)
 6507 FORMAT ('+',65X,'AVAILABLE')
 1888 CONTINUE
      IF (MOD(I,50) .EQ. 0) PAGE = .TRUE.
      IF (IASID .NE. - 1) GOTO 2000
      IF (.NOT. LIST) GOTO 2000
      IMOD = WORK(II) - VBMIN + 1
      IF (IMOD .GT. 2500) GOTO 2000
      WRITE (6,6022) MODULE(IMOD)
 6022 FORMAT ('+',55X,A8)
 2000 CONTINUE
C
C   WRITE OUT SUMMARY
C
      WRITE (6,6020) LTTIME, IJOB, IASID
 6020 FORMAT (1X,/,3X,3(Z2,'.'),Z2,3X,A8,'   ASID=',I3)
      WRITE (6,6021) ICNTS,IPGCT
 6021 FORMAT (' BAD PAGES',10X,I4,7X,'LSQA PAGES',9X,I4,7X,
     * 'LOCAL PAGES',8X,I4,7X,'SQA PAGES',10X,I4,/,' COMMON PAGES',
     * 7X,I4,7X,'SQA RESERVED',7X,I4,7X,'AVAILABLE PAGES',4X,I4,7X,
     * 'TOTAL PAGES',8X,I4)
      IF (IASID .NE. - 1) GOTO 2199
      MODT = NULL
      WRITE (6,6023)
 6023 FORMAT (' MODULES PRESENT -')
      LCT = 1
      II = IST
      DO 2133 I = 1,IPGCT
      II = II + 4
      IMOD = WORK(II) - VBMIN + 1
      IF (IMOD .GT. 2500 .OR. IMOD .LE. 0) GOTO 2133
      IF (MODULE(IMOD) .EQ. MODT .OR. MODULE(IMOD) .EQ. NULL) GOTO 2133
      MODT = MODULE(IMOD)
      MODL(LCT) = MODT
      LCT = LCT + 1
      IF (LCT .LE. 10) GOTO 2133
      WRITE (6,6024) MODL
 6024 FORMAT (1X,10(A8,','))
      LCT = 1
 2133 CONTINUE
      LCT = LCT - 1
      IF (LCT .EQ. 0) GOTO 2199
      WRITE (6,6024) (MODL(I),I=1,LCT)
 2199 CONTINUE
C
C   INCREMENT COUNTERS
C
      DO 2255 I = 1,7
      TOTALS(I) = TOTALS(I) + ICNTS(I)
 2255 CONTINUE
      TOTPGC = TOTPGC + IPGCT
      IF (.NOT. GRAPH) GOTO 2822
      IF (.NOT. PLOT) GOTO 2522
      PLOT = .FALSE.
C
C   DRAW AXIS
C
      WRITE (7,9002) DATE, IJOB, IASID
 9002 FORMAT ('1PAGE FRAMES ON ',A8,5X,A8,3X,'ASID = ',I3)
      IVBMAX = VBMIN + 109
      IF ((VBMAX - VBMIN) .LT. 109) GOTO 2344
      IVBMAX = ((VBMAX - VBMIN + 1) / 110 + 1) * 110 + VBMIN - 1
 2344 CONTINUE
      INCR = (IVBMAX - VBMIN + 1) / 10
      NT4 = VBMIN
      DO 2433 J = 1,11
      ANAX(J) = NT2(2)
      NT4 = NT4 + INCR
 2433 CONTINUE
      WRITE (7,9000) ANAX
 9000 FORMAT ('0    TIME    ',Z3,10(8X,Z3))
      WRITE (7,9001)
 9001 FORMAT (1X,13('-'),'+',10(10('-'),'+'))
      LNCNT = 4
 2522 CONTINUE
C
C   INITIALIZE PLINE WITH .
C
      DO 2611 I = 1,110
      PLINE(I) = NOS(16)
 2611 CONTINUE
      II = IST
      RTEMP = IVBMAX - VBMIN
      DO 2744 I = 1,IPGCT
      II = II + 4
      NT4 = ((WORK(II) - VBMIN) / RTEMP) * 109. + 1.
      IF (NT4 .GT. 110 .OR. NT4 .LE. 0) GOTO 2744
      DO 2700 J =2,16
      IG2 = 0
      NG2 = 0
      IG1(2) = PLINE(NT4)
      NG1(2) = NOS(J)
      IF (IG2 .NE. NG2) GOTO 2700
      PLINE(NT4) = NOS(J-1)
      GOTO 2744
 2700 CONTINUE
 2744 CONTINUE
      WRITE (7,9003) LTTIME, PLINE
 9003 FORMAT (1X,3(Z2,'.'),Z2,' ×',110A1)
      LNCNT = LNCNT + 1
      IF (LNCNT .GE. 43) PLOT = .TRUE.
 2822 CONTINUE
      IF (IFLAG .GT. 0) GOTO 3000
      TTIME = TIME
      IPGCT = 0
      DO 2900 I = 1,7
      ICNTS(I) = 0
 2900 CONTINUE
      GOTO 1277
C
C   END OF DATA FOR ASID - WRITE OUT AVERAGES
C
 3000 CONTINUE
      WRITE (6,6400) IJOB, IASID
 6400 FORMAT ('1 AVERAGE PAGES FOR ',A8,'   ASID=',I3)
      TOTPGC = TOTPGC / NCALLS
      DO 3100 I = 1,7
      TOTALS(I) = TOTALS(I) / NCALLS
 3100 CONTINUE
      WRITE (6,6401) TOTALS, TOTPGC
 6401 FORMAT (' BAD PAGES',11X,F5.1,5X,'LSQA PAGES',10X,F5.1,5X,
     * 'LOCAL PAGES',8X,F6.1,5X,'SQA PAGES',11X,F5.1,/,' COMMON PAGES',
     * 7X,F6.1,5X,'SQA RESERVED',8X,F5.1,5X,'AVAILABLE PAGES',4X,
     * F6.1,5X,'TOTAL PAGES',8X,F6.1)
      WRITE (8,8000) IJOB, IASID
 8000 FORMAT ('0AVERAGE PAGES FOR ',A8,'    ASID=',I3)
      WRITE (8,6401) TOTALS, TOTPGC
      IF (.NOT. GRAPH) GOTO 3788
C
C   PLOT HISTOGRAM
C
      IPCT = 1
      PAGE = .TRUE.
      NCT = 1
      IMAX = VBMAX - VBMIN + 1
      IF (IMAX .GT. 2500) IMAX = 2500
 3366 CONTINUE
      IF (.NOT. PAGE) GOTO 3600
      IF (NCT .GT. IMAX) GOTO 3788
      IEND = NCT + 47
      IF (IEND .GT. IMAX) IEND = IMAX
      DO 3422 I = NCT,IEND
      IF (WORK(ICNTF+I) .NE. 0.) GOTO 3511
 3422 CONTINUE
      ISTRT = NCT + VBMIN - 1
      IEND = IEND + VBMIN - 1
      WRITE (7,6415) IJOB, IASID, ISTRT, IEND
 6415 FORMAT ('0',A8,'   ASID=',I3,' - VBN ',Z3,' TO ',Z3,
     * ' WERE NOT REFERENCED')
      NCT = NCT + 48
      IF(NCT .GT. IMAX) GOTO 3788
      IPCT = IPCT + 1
      GOTO 3366
 3511 CONTINUE
C
C   WRITE HEADINGS
C
      WRITE (7,6410) IJOB, IASID, IPCT
 6410 FORMAT ('1',A8,'   ASID=',I3,45X,'PAGE ',I3)
      WRITE (7,6420)
 6420 FORMAT (' MODULE   CONT  PERCENT  BLOCK 0',8X,'10',8X,'20',8X,
     * '30',8X,'40',8X,'50',8X,'60',8X,'70',8X,'80',8X,'90',8X,'100')
      WRITE (7,6430) (MINUS,I=1,132)
 6430 FORMAT (1X,132A1)
      IPCT = IPCT + 1
      PAGE = .FALSE.
      LCT = 0
 3600 CONTINUE
      IMOD = VBMIN + NCT - 1
      RCOUNT = (WORK(ICNTF+NCT) * 100.) / NCALLS
      DO 3699 I = 1,100
      LINE(I) = BLNK
      X = I
      IF (X .LE. RCOUNT) LINE(I) = AST
 3699 CONTINUE
      WRITE (7,6440) MODULE(NCT), INDIC(NCT), RCOUNT, IMOD, LINE
 6440 FORMAT (1X,A8,3X,A1,3X,F7.3,3X,Z3,2X,'×',100A1)
      NCT = NCT + 1
      IF (NCT .GT. IMAX) GOTO 3788
      LCT = LCT + 1
      IF (LCT .GT. 47) PAGE = .TRUE.
      GOTO 3366
 3788 CONTINUE
      IF (IASID .NE. -1) GOTO 214
      DO 3795 I = 1, 2500
 3795 MODULE(I) = NULL
      GOTO 214
 4000 CONTINUE
C
C   ***********************************
C
C   WRITE OUT TYPE 2 RECORDS - JOBNAME/ASID
C
C   ***********************************
      IFLAG = -1
      CALL MONRD (NAME, LENGTH, IDATA, IFLAG)
      IF (IFLAG .GT. 0) GOTO 5678
      IFLAG = 0
      FIRST = .TRUE.
 4100 CONTINUE
      CALL MONRD (NAME, LENGTH, IDATA, IFLAG)
      IF (IFLAG .GT. 0) GOTO 5432
      IF (TYPE .NE. 2) GOTO 4100
      IF (.NOT. FIRST .AND. TIME .EQ. TTIME) GOTO 4200
      IF (FIRST) WRITE (6,6102)
      TTIME = TIME
      FIRST = .FALSE.
      WRITE (6,6200) LTTIME
 6200 FORMAT (//,3X,3(Z2,'.'),Z2,'   JOBNAME  ASID')
      WRITE (6,6210)
 6210 FORMAT ('   -----------   -------  ----',/,1X)
 4200 CONTINUE
      WRITE (6,6220) JOBNAM, ASID
 6220 FORMAT (17X,A8,2X,I3)
      GOTO 4100
 5432 CONTINUE
      WRITE (6,6030)
 6030 FORMAT (1X,/,' END OF PAGING ANALYSIS')
      WRITE (8,6030)
 5678 RETURN
      END

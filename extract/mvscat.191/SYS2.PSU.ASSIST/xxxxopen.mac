         TITLE 'XOPENBLK DSECT, EQUS FOR XXXXOPEN ROUTINE'
         EQUREGS
**--> DSECT: XOPENBLK   USED TO CONTROL XXXXOPEN MODULE . . . . . . . .
*.             CALLING XIO MODULE PASSES @ IN R1 TO XXXXOPEN TO DO THE.
*.       GENERALIZED OPEN ROUTINE WITH MULTIPLE DDNAMES, ETC.         .
*.       GENERATION: 1 CALL TO XOPENBLK MACRO INSTRUCTION.            .
*.       NAMES: XOP-----                                              .
*.. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
XOPENBLK DSECT
XOPABEND EQU   B'00000001'         (XOPFLAG1) - ABEND IF CAN'T OPEN
XOPWARN  EQU   B'00000010'         (XOPFLAG1) - WARN IF 1ST DD NO GO
         SPACE 1
XOPDCBAD DS    X,AL3               OPEN/CLOSE ELEMENT (BYTE,ADDR DCB)
*              NEXT FOUR ITEMS ARE USED BY DCB EXIT TO FILL DCB, IF
*        IT HAS NOT ALREADY BEEN DONE DURING OPEN PROCESS.
XOPLRECL DS    H                   LRECL DEFAULT
XOPBLKSI DS    H                   BLKSIZE DEFAULT
XOPBUFNO DS    H                   BUFNO DEFAULT
XOPRECFM DS    B                   RECFM DEFAULT (F,FA,FB,FBA ALLOWED)
         SPACE 1
XOPFLAG1 DS    B                   FLAGS FOR CONTROL
XOPXNAME DS    CL8                 NAME OF ROUTINE CALLING, FOR MSGS
XOPDDLIM DS    H                   8 * (# DDNAMES - 1) :: BXLE LIMIT
XOPDDNAM DS    CL8                 BEGINNING OF DDNAME LIST ALLOWED
         SPACE 2
*              ADDITIONAL LOCAL REGISTER EQUATES.
RXOP     EQU   R5                  @ XOPENBLK - OPEN CONTROL BLOCK
RDCB     EQU   R6                  @ DCB TO BE OPENED (FROM XOPENBLK)
RDD1     EQU   R7                  @ 1ST DDNAME ENTRY IN TIOT
RBASE    EQU   R8                  BASE REGISTER
         TITLE 'XXXXOPEN - SPECIAL OPEN ROUTINE FOR XXXX IO SUPPORT'
**--> CSECT: XXXXOPEN   CALLED TO DO SPECIAL OPEN BY XIO MODULES  . . .
*.             THIS IS CALLED BY ROUTINES LIKE XXXXPRNT, XXXXSNAP, ETC.
*.       TO PERFROM THEIR OPEN'S FOR THEM.  ALL INPUT INFOMRATION IS  .
*.       CONTAINED IN THE XOPENBLK  AREA WHICH IS PASSED TO XXXXOPEN. .
*.             THE ROUTINE PERFORMS THE FOLLOWING ACTIONS:            .
*.       1. ATTEMPTS AN OPEN FOR EACH DDNAME (IN XOPENBLK) WHICH IT   .
*.       CAN FIND IN THE TIOT, UNTIL A SUCCESSFUL OPEN IS DONE. IT    .
*.       NEVER USES A DDNAME UNLESS IT IS IN THE TIOT.                .
*.       2. DURING A SUCCESSFUL OPEN, THE DCB EXIT IS TAKEN, AND SOME .
*.       PARTS OF THE DCB CAN BE FILLED IN THEN (LRECL, BLKSIZE,      .
*.       RECFM, BUFNO).  THIS ALLOWS VALUES TO BE FILLED IN FROM JCL. .
*.       3. IF NO OPEN COULD BE DONE, IT ISSUES A MESSAGE AND ALSO    .
*.       MAY  ABEND IF DESIRED.                                       .
*.       4. IF DESIRED, A WARNING MAY BE ISSUED IF THE FIRST CHOICE   .
*.       DDNAME COULD NOT BE USED.                                    .
*.       ENTRY CONDITIONS                                             .
*.  R13,R14,R15 : NORMAL OS/360 CONVENTIONS.                          .
*.  R1 = ADDRESS OF XOPENBLK, WITH ALL VALUES FILLED IN.              .
*.       EXIT CONDITIONS                                              .
*.       NO REGISTERS ARE CHANGED, OPEN HAS BEEN PERFORMED IF POSSIBLE.
*.       NAMES: XXOP----                                              .
*.       USES DSECTS: IHADCB,XOPENBLK                                 .
*.       USES MACROS: ABEND,DCBD,EQUREGS,OPEN,WTO                     .
*.. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .
XXXXOPEN CSECT
         USING *,R15               NOTE ENTRY POINT USING
         STM   R14,RBASE,XXOPSAVE  SAVE ALL REGS USED
         BALR  RBASE,0             SET UP OWN VASE REG, 15 NOT SAFE
         USING *,RBASE             NOTE THE USING
*              1-TIME HOUSEKEEPING INITIALIZATION CODE.
         LR    RXOP,R1             MOVE XOPENBLK PTR  WHERE SAFE
         USING XOPENBLK,RXOP       NOTE THE PTR
         L     RDCB,XOPDCBAD       GET @ DCB ITSELF
         USING IHADCB,RDCB         NOTE THE POINTER THERE
         SPACE 1
*              SAVE ORIGINAL VALUES FROM DCB.
         MVC   XXOPLREC,DCBLRECL   LOGICAL RECORD LENGTH
         MVC   XXOPBLKS,DCBBLKSI   BLOCK SIZE
         MVC   XXOPBUFN,DCBBUFNO   BUFFER NUMBER
         MVC   XXOPRECF,DCBRECFM   RECORD FORMAT
         SPACE 1
         MVC   DCBEXLST+1,=AL3(XXODEXLS)  @ OF OUR EXIT LIST TO USE
         SPACE 1
*              CHASE POINTERS TO @ OF 1ST DDNAME IN TIOT.
         L     R1,16               @ CVT
         L     R1,0(,R1)           @ TCB PTR
         L     R1,0(,R1)           @ TCB
         L     R1,12(,R1)          @ TIOT
         LA    RDD1,24(,R1)        8 1ST DD ENTRY IN THE TIOT
         SPACE 1
*              INIT FOR LOOP TO SEARCH TIOT FOR EACH DDNAME ALLOWED,
*              THEN ATTEMPT OPEN ON EACH FOUND UNTIL OPEN WORKS.
         LA    R2,8                BXLE INCREMENT = LENGTH OF DDNAME
         LA    R3,XOPDDNAM         @ 1ST DDNAME IN XOPENBLK LIST
         LR    R4,R3               MOVE OVER, R4 WILL BE INDEX REG
         AH    R3,XOPDDLIM         ADD OFFSET = LIMIT FOR COMING BXLE
         SPACE 1
*              OUTER LOOP: CHECK EACH DDNAME IN XOPENBLK IN ORDER.
XXOPZERO SR    R0,R0               CLEAR FOR INSERTIONS
         LR    R1,RDD1             INIT TO @ OF 1ST ONE IN TABLE
         SPACE 1
*              INNER LOOP: LOOK FOR DDNAME IN TIOT, THEN TRY OPEN.
XXOPDDSR IC    R0,0(,R1)           GET LENGTH/CODE BYTE
         LTR   R0,R0               WAS LENGTH = 0 (NO MORE DD ENTRIES)
         BZ    XXOPBXLE            YES, SO GO FOR NEXT DD IN XOPENBLK
         CLC   4(8,R1),0(R4)       WAS DDNAME IN TIOT = ONE IN XOPENBLK
         BE    *+8                 YES, SKIP OUT OF TIOT SEARCH
         BXH   R1,R0,XXOPDDSR      NO, INCREMENT TIOT PTR, BRNCH ALWAYS
         SPACE 1
*              DDNAME FOUND IN TIOT - MAKE SURE VALUES IN DCB ARE
*              CORRECT, ATTEMPT OPEN, FILL IN VALUES NEEDED.
         MVC   DCBDDNAM,0(R4)      MOVE IN DDNAME WE'VE FOUND
         MVC   DCBLRECL,XXOPLREC   MAKE SURE LRECL OK
         MVC   DCBBLKSI,XXOPBLKS   MAKE SURE BLKSIZE OK
         MVC   DCBBUFNO,XXOPBUFN   MAKE SURE BUFNO OK
         MVC   DCBRECFM,XXOPRECF   MAKE SURE RECFM OK
         SPACE 1
         OPEN  MF=(E,XOPDCBAD)     DO REMOTE OPEN
         TM    DCBOFLGS,X'10'      DID OPEN GO
         BO    XXOPNOKA            YES, WE'RE DONE - QUIT
XXOPBXLE BXLE  R4,R2,XXOPZERO      DIDN'T GO TRY AGAIN
         SPACE 1
*              NO GOOD DDNAME WAS FOUND AND OPENED - MESSAGE, ABEND.
         MVC   XXOP300B(8),XOPXNAME         MOVE IN NAME OF CALLING RT
         WTO   MF=(E,XXOP300A)     DO WRITE TO PROGRAMMER
         SPACE 1
         TM    XOPFLAG1,XOPABEND   DOES HE REALLY WANT ABEND
         BZ    XXOPRETN            NO, DONT DO IT
         ABEND 300,DUMP            YES, QUIT NOW
         SPACE 2
XXOPNOKA DS    0H                  COME HERE IF OPEN WORKED
         TM    XOPFLAG1,XOPWARN    DID HE WANT WARNING IF NOT 1ST COIC
         BZ    XXOPRETN            NO, SO DON'T BOTHER CHECKING
         CLC   XOPDDNAM,0(R4)      WAS THE FIRST DDNAME USED
         BE    XXOPRETN            YES, QUIT
         SPACE 1
*              CALLER DESIRED WARNING IF 1ST DDNAME NOT USED - GIVE IT.
         MVC   XXOP400B(8),XOPXNAME         MOVE IN ROUTINE NAME
         MVC   XXOP400C(8),0(R4)   MOVE IN ACTUAL DDNAME USED
         MVC   XXOP400D(8),XOPDDNAM    MOVE IN FIRST CHOICE DDNAME
         WTO   MF=(E,XXOP400A)     WRITE TO PROGRAMMER
         SPACE 1
XXOPRETN EQU   *                   EXIT TO CALLER
         LM    R14,RBASE,XXOPSAVE  RESTORE ALL REGS
         BR    R14                 RETURN
         SPACE 2
**--> EXIT :   DCB EXIT - WHEN EXIT IS CALLED BY SUPERVISOR, THIS CODE*
*        FILLS IN ANY FIELDS WHICH HAVE NOT BEEN FILLED IN ALREADY,   *
*        I.E., FROM ORIGINAL DCB, DD CARD, OR DATASET LABEL.          *
*        NOTE: THIS CODE DEPENDS ON REGS 2-12 BEING UNCHANGED         *
* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
XXOPEXIT EQU   *                   EXIT ENTRY POINT
         DROP  RDCB
         USING IHADCB,R1
         USING *,R15               NOTE LOCAL USING
         SR    R2,R2               USE FOR COMPARISON
         CH    R2,DCBLRECL         LRECL FOUND YET
         BNE   *+10                YES, SKIP
         MVC   DCBLRECL,XOPLRECL   NO, MOVE DEFAULT ONE IN
         SPACE 1
         CH    R2,DCBBLKSI         BLKSIZE FILLED IN YET
         BNE   *+10                YES, SKIP
         MVC   DCBBLKSI,XOPBLKSI   NO, MOVE DEFAULT IN
         SPACE 1
         CH    R2,DCBBUFNO         BUFNO FILLED IN YET
         BNE   *+10                YES, SKIP
         MVC   DCBBUFNO,XOPBUFNO   NO, MOVE DEFAULT IN
         SPACE 1
         CLI   DCBRECFM,B'00000000'         RECFM SPECIFIED YET
         BNE   *+10                YES, SKIP
         MVC   DCBRECFM,XOPRECFM   NO, MOVE DEFAULT VALUE IN
         BR    R14                 RETURN TO SUPERVISOR
         DROP  R15                 ZAP TEMPORARY USING
         SPACE 2
*              CONSTANTS AND WORKAREAS
XXODEXLS DC    0F'0',X'85',AL3(XXOPEXIT)     EXIT LIST FOR DCB EXIT
         SPACE 1
XXOP300A WTO   ' XXXXXXXX ABEND 300 - COULD NOT OPEN FOR ANY DDNAME:   #
               DD CARD MISSING OR MISSPELLED',MF=L,ROUTCDE=11 (WTP)
XXOP300B EQU   XXOP300A+5          OFFSET TO XXXXXXXX (XMODULE NAME)
         SPACE 1
XXOP400A WTO   ' XXXXXXXX WARNING 400 - DDNAME: YYYYYYYY USED, RATHER  #
               THAN PREFERRED: ZZZZZZZZ',MF=L,ROUTCDE=11
XXOP400B EQU   XXOP400A+5          OFFSET TO XXXXXXXX (XMODULE NAME)
XXOP400C EQU   XXOP400A+36         OFFSET TO YYYYYYYY (DDNAME USED)
XXOP400D EQU   XXOP400A+75         OFFSET TO ZZZZZZZZ (DDNAME PREFERED)
XXOPSAVE DS    (RBASE+3)F         RESERVE SPACE FOR R14,R15,R0,R1-RBASE
         SPACE 1
*              NEXT 4 AREAS USED TO SAVE ORIGINAL VALUES IN DCB SO
*              THAT EVERY OPEN BEGINS WITH SAME ONES, IF ANY FAIL.
XXOPLREC DS    H                   LRECL
XXOPBLKS DS    H                   BLKSIZE
XXOPBUFN DS    H                   BUFNO
XXOPRECF DS    B                   RECFM
         LTORG
         DROP  RXOP,RBASE          ZAP ALL USINGS
         EJECT
         DCBD  DSORG=QS            GENERATE DSECT IHADCB
         END
